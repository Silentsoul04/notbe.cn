<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>MongoDB 分片集群技术 « NotBeCN</title>
  <meta name="description" content="                　　在了解分片集群之前，务必要先了解复制集技术！       &nbsp;1.1 MongoDB复制集简介    　　一组Mongodb复制集，就是一组mongod进程，这些进程维护同一个数据集合。复制集提供了数据冗余和高等级的可靠性，这是生产部署的基础。    1.1.1 复制集...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2018/01/18/weixin_34259159_90123928.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">MongoDB 分片集群技术</h1>
    <p class="post-meta">Jan 18, 2018</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <hr>
   <p>　　<span>在了解分片集群之前，务必要先了解复制集技术！</span></p> 
   <hr>
   <h2>&nbsp;1.1 MongoDB复制集简介</h2> 
   <p>　　一组Mongodb复制集，就是一组mongod进程，这些进程维护同一个数据集合。复制集提供了数据冗余和高等级的可靠性，这是生产部署的基础。</p> 
   <h3>1.1.1 复制集的目的</h3> 
   <p>　　保证数据在生产部署时的冗余和可靠性，通过在不同的机器上保存副本来保证数据的不会因为单点损坏而丢失。能够随时应对数据丢失、机器损坏带来的风险。</p> 
   <p>　　换一句话来说，还能提高读取能力，用户的读取服务器和写入服务器在不同的地方，而且，由不同的服务器为不同的用户提供服务，提高整个系统的负载。</p> 
   <h3>1.1.2 简单介绍</h3> 
   <p>　　一组复制集就是一组mongod实例掌管同一个数据集，实例可以在不同的机器上面。实例中包含一个主导，接受客户端所有的写入操作，其他都是副本实例，从主服务器上获得数据并保持同步。</p> 
   <p>　　主服务器很重要，包含了所有的改变操作（写）的日志。但是副本服务器集群包含有所有的主服务器数据，因此当主服务器挂掉了，就会在副本服务器上重新选取一个成为主服务器。</p> 
   <p>　　每个复制集还有一个仲裁者，仲裁者不存储数据，只是负责通过心跳包来确认集群中集合的数量，并在主服务器选举的时候作为仲裁决定结果。</p> 
   <h2>1.2 复制的基本架构</h2> 
   <p>　　基本的架构由3台服务器组成，一个三成员的复制集，由三个有数据，或者两个有数据，一个作为仲裁者。</p> 
   <h3>1.2.1 三个存储数据的复制集</h3> 
   <p>具有三个存储数据的成员的复制集有：</p> 
   <div> 
    <blockquote> 
     <p>一个主库；</p> 
     <p>两个从库组成，主库宕机时，这两个从库都可以被选为主库。</p> 
    </blockquote> 
   </div> 
   <p align="center">&nbsp;<img src="http://images2017.cnblogs.com/blog/1190037/201801/1190037-20180106145148128-1854811460.png" alt=""></p> 
   <p>&nbsp;&nbsp; &nbsp;&nbsp; 当主库宕机后,两个从库都会进行竞选，其中一个变为主库，当原主库恢复后，作为从库加入当前的复制集群即可。</p> 
   <p align="center"><img src="http://images2017.cnblogs.com/blog/1190037/201801/1190037-20180106145154284-397901575.png" alt="">&nbsp;</p> 
   <h3>1.2.2 当存在arbiter节点</h3> 
   <p>在三个成员的复制集中，有两个正常的主从，及一台arbiter节点：</p> 
   <div> 
    <blockquote> 
     <p>&nbsp; &nbsp; 一个主库</p> 
     <p>&nbsp;&nbsp;&nbsp; 一个从库，可以在选举中成为主库</p> 
     <p>&nbsp;&nbsp;&nbsp; 一个aribiter节点，在选举中，只进行投票，不能成为主库</p> 
    </blockquote> 
   </div> 
   <p align="center"><img src="http://images2017.cnblogs.com/blog/1190037/201801/1190037-20180106145207237-1647029849.png" alt="">&nbsp;</p> 
   <p>说明：</p> 
   <div> 
    <blockquote> 
     <p>　　由于arbiter节点没有复制数据，因此这个架构中仅提供一个完整的数据副本。arbiter节点只需要更少的资源，代价是更有限的冗余和容错。</p> 
    </blockquote> 
   </div> 
   <p>&nbsp;&nbsp; 当主库宕机时，将会选择从库成为主，主库修复后，将其加入到现有的复制集群中即可。</p> 
   <p align="center"><img src="http://images2017.cnblogs.com/blog/1190037/201801/1190037-20180106145221393-1674631191.png" alt="">&nbsp;</p> 
   <h3>1.2.3 Primary选举</h3> 
   <p>　　复制集通过replSetInitiate命令（或mongo shell的rs.initiate()）进行初始化，初始化后各个成员间开始发送心跳消息，并发起Priamry选举操作，获得『大多数』成员投票支持的节点，会成为Primary，其余节点成为Secondary。</p> 
   <p><span><strong>『大多数』的定义</strong></span></p> 
   <p>　　假设复制集内投票成员（后续介绍）数量为N，则大多数为 N/2 + 1，当复制集内存活成员数量不足大多数时，整个复制集将无法选举出Primary，复制集将无法提供写服务，处于只读状态。</p> 
   <table class="MsoTable15Grid2" style="border-style:none;" border="1">
    <tbody>
     <tr>
      <td style="border-top:none;border-right:none;border-left:none;border-bottom-width:1.5pt;border-bottom-color:#666666;" valign="top"> <p style="text-align:center;" align="center"><strong><span style="font-family:'微软雅黑', sans-serif;">投票成员数</span></strong></p> </td> 
      <td style="border-top:none;border-right:none;border-left:none;border-bottom-width:1.5pt;border-bottom-color:#666666;" valign="top"> <p style="text-align:center;" align="center"><strong><span style="font-family:'微软雅黑', sans-serif;">大多数</span></strong></p> </td> 
      <td style="border-top:none;border-right:none;border-left:none;border-bottom-width:1.5pt;border-bottom-color:#666666;" valign="top"> <p style="text-align:center;" align="center"><strong><span style="font-family:'微软雅黑', sans-serif;">容忍失效数</span></strong></p> </td> 
     </tr>
     <tr>
      <td style="border-top:none;border-left:none;border-bottom-width:1pt;border-bottom-color:#666666;border-right-width:1pt;border-right-color:#666666;background:#cccccc;" valign="top"> <p style="text-align:center;" align="center"><strong><span>1</span></strong></p> </td> 
      <td style="border-top:none;border-left:none;border-bottom-width:1pt;border-bottom-color:#666666;border-right-width:1pt;border-right-color:#666666;background:#cccccc;" valign="top"> <p style="text-align:center;" align="center"><span>1</span></p> </td> 
      <td style="border-top:none;border-right:none;border-left:none;border-bottom-width:1pt;border-bottom-color:#666666;background:#cccccc;" valign="top"> <p style="text-align:center;" align="center"><span>0</span></p> </td> 
     </tr>
     <tr>
      <td style="border-top:none;border-left:none;border-bottom-width:1pt;border-bottom-color:#666666;border-right-width:1pt;border-right-color:#666666;" valign="top"> <p style="text-align:center;" align="center"><strong><span>2</span></strong></p> </td> 
      <td style="border-top:none;border-left:none;border-bottom-width:1pt;border-bottom-color:#666666;border-right-width:1pt;border-right-color:#666666;" valign="top"> <p style="text-align:center;" align="center"><span>2</span></p> </td> 
      <td style="border-top:none;border-right:none;border-left:none;border-bottom-width:1pt;border-bottom-color:#666666;" valign="top"> <p style="text-align:center;" align="center"><span>0</span></p> </td> 
     </tr>
     <tr>
      <td style="border-top:none;border-left:none;border-bottom-width:1pt;border-bottom-color:#666666;border-right-width:1pt;border-right-color:#666666;background:#cccccc;" valign="top"> <p style="text-align:center;" align="center"><strong><span>3</span></strong></p> </td> 
      <td style="border-top:none;border-left:none;border-bottom-width:1pt;border-bottom-color:#666666;border-right-width:1pt;border-right-color:#666666;background:#cccccc;" valign="top"> <p style="text-align:center;" align="center"><span>2</span></p> </td> 
      <td style="border-top:none;border-right:none;border-left:none;border-bottom-width:1pt;border-bottom-color:#666666;background:#cccccc;" valign="top"> <p style="text-align:center;" align="center"><span>1</span></p> </td> 
     </tr>
     <tr>
      <td style="border-top:none;border-left:none;border-bottom-width:1pt;border-bottom-color:#666666;border-right-width:1pt;border-right-color:#666666;" valign="top"> <p style="text-align:center;" align="center"><strong><span>4</span></strong></p> </td> 
      <td style="border-top:none;border-left:none;border-bottom-width:1pt;border-bottom-color:#666666;border-right-width:1pt;border-right-color:#666666;" valign="top"> <p style="text-align:center;" align="center"><span>3</span></p> </td> 
      <td style="border-top:none;border-right:none;border-left:none;border-bottom-width:1pt;border-bottom-color:#666666;" valign="top"> <p style="text-align:center;" align="center"><span>1</span></p> </td> 
     </tr>
     <tr>
      <td style="border-top:none;border-left:none;border-bottom-width:1pt;border-bottom-color:#666666;border-right-width:1pt;border-right-color:#666666;background:#cccccc;" valign="top"> <p style="text-align:center;" align="center"><strong><span>5</span></strong></p> </td> 
      <td style="border-top:none;border-left:none;border-bottom-width:1pt;border-bottom-color:#666666;border-right-width:1pt;border-right-color:#666666;background:#cccccc;" valign="top"> <p style="text-align:center;" align="center"><span>3</span></p> </td> 
      <td style="border-top:none;border-right:none;border-left:none;border-bottom-width:1pt;border-bottom-color:#666666;background:#cccccc;" valign="top"> <p style="text-align:center;" align="center"><span>2</span></p> </td> 
     </tr>
     <tr>
      <td style="border-top:none;border-left:none;border-bottom-width:1pt;border-bottom-color:#666666;border-right-width:1pt;border-right-color:#666666;" valign="top"> <p style="text-align:center;" align="center"><strong><span>6</span></strong></p> </td> 
      <td style="border-top:none;border-left:none;border-bottom-width:1pt;border-bottom-color:#666666;border-right-width:1pt;border-right-color:#666666;" valign="top"> <p style="text-align:center;" align="center"><span>4</span></p> </td> 
      <td style="border-top:none;border-right:none;border-left:none;border-bottom-width:1pt;border-bottom-color:#666666;" valign="top"> <p style="text-align:center;" align="center"><span>2</span></p> </td> 
     </tr>
     <tr>
      <td style="border-top:none;border-left:none;border-bottom-width:1pt;border-bottom-color:#666666;border-right-width:1pt;border-right-color:#666666;background:#cccccc;" valign="top"> <p style="text-align:center;" align="center"><strong><span>7</span></strong></p> </td> 
      <td style="border-top:none;border-left:none;border-bottom-width:1pt;border-bottom-color:#666666;border-right-width:1pt;border-right-color:#666666;background:#cccccc;" valign="top"> <p style="text-align:center;" align="center"><span>4</span></p> </td> 
      <td style="border-top:none;border-right:none;border-left:none;border-bottom-width:1pt;border-bottom-color:#666666;background:#cccccc;" valign="top"> <p style="text-align:center;" align="center"><span>3</span></p> </td> 
     </tr>
    </tbody>
   </table>
   <p>　　通常建议将复制集成员数量设置为奇数，从上表可以看出3个节点和4个节点的复制集都只能容忍1个节点失效，从『服务可用性』的角度看，其效果是一样的。（但无疑4个节点能提供更可靠的数据存储）</p> 
   <h2><span style="font-size:1.5em;">1.3 复制集中成员说明</span></h2> 
   <h3>1.3.1 所有成员说明&nbsp;</h3> 
   <table class="MsoTable15List6Colorful" style="border-style:none;" border="1">
    <tbody>
     <tr>
      <td style="border-top-width:1pt;border-top-color:#000000;border-left:none;border-bottom-width:1pt;border-right-width:1pt;"> <p style="text-align:center;" align="center"><strong><span style="font-family:'微软雅黑', sans-serif;">成员</span></strong></p> </td> 
      <td style="border-top-width:1pt;border-top-color:#000000;border-left:none;border-bottom-width:1pt;border-right:none;" valign="top"> <p style="text-align:center;" align="center"><strong><span style="font-family:'微软雅黑', sans-serif;">说明</span></strong></p> </td> 
     </tr>
     <tr>
      <td style="border-top:none;border-left:none;border-bottom-width:1pt;border-right-width:1pt;background:#cccccc;"> <p style="text-align:center;" align="center"><strong><span>Secondary</span></strong></p> </td> 
      <td style="border-top:none;border-right:none;border-left:none;border-bottom-width:1pt;background:#cccccc;" valign="top"> <p style="text-align:justify;text-indent:24pt;"><span style="font-family:'微软雅黑', sans-serif;">正常情况下，复制集的</span><span>Seconary</span><span style="font-family:'微软雅黑', sans-serif;">会参与</span><span>Primary</span><span style="font-family:'微软雅黑', sans-serif;">选举（自身也可能会被选为</span><span>Primary</span><span style="font-family:'微软雅黑', sans-serif;">），并从</span><span>Primary</span><span style="font-family:'微软雅黑', sans-serif;">同步最新写入的数据，以保证与</span><span>Primary</span><span style="font-family:'微软雅黑', sans-serif;">存储相同的数据。</span></p> <p style="text-align:justify;text-indent:24pt;"><span>Secondary</span><span style="font-family:'微软雅黑', sans-serif;">可以提供读服务，增加</span><span>Secondary</span><span style="font-family:'微软雅黑', sans-serif;">节点可以提供复制集的读服务能力，同时提升复制集的可用性。另外，</span><span>Mongodb</span><span style="font-family:'微软雅黑', sans-serif;">支持对复制集的</span><span>Secondary</span><span style="font-family:'微软雅黑', sans-serif;">节点进行灵活的配置，以适应多种场景的需求。</span></p> </td> 
     </tr>
     <tr>
      <td style="border-top:none;border-left:none;border-bottom-width:1pt;border-right-width:1pt;"> <p style="text-align:center;" align="center"><strong><span>Arbiter</span></strong></p> </td> 
      <td style="border-top:none;border-right:none;border-left:none;border-bottom-width:1pt;" valign="top"> <p style="text-align:justify;text-indent:24pt;"><span>Arbiter</span><span style="font-family:'微软雅黑', sans-serif;">节点只参与投票，不能被选为</span><span>Primary</span><span style="font-family:'微软雅黑', sans-serif;">，并且不从</span><span>Primary</span><span style="font-family:'微软雅黑', sans-serif;">同步数据。</span></p> <p style="text-align:justify;text-indent:24pt;"><span style="font-family:'微软雅黑', sans-serif;">比如你部署了一个</span><span>2</span><span style="font-family:'微软雅黑', sans-serif;">个节点的复制集，</span><span>1</span><span style="font-family:'微软雅黑', sans-serif;">个</span><span>Primary</span><span style="font-family:'微软雅黑', sans-serif;">，</span><span>1</span><span style="font-family:'微软雅黑', sans-serif;">个</span><span>Secondary</span><span style="font-family:'微软雅黑', sans-serif;">，任意节点宕机，复制集将不能提供服务了（无法选出</span><span>Primary</span><span style="font-family:'微软雅黑', sans-serif;">），这时可以给复制集添加一个</span><span>Arbiter</span><span style="font-family:'微软雅黑', sans-serif;">节点，即使有节点宕机，仍能选出</span><span>Primary</span><span style="font-family:'微软雅黑', sans-serif;">。</span></p> <p style="text-align:justify;text-indent:24pt;"><span>Arbiter</span><span style="font-family:'微软雅黑', sans-serif;">本身不存储数据，是非常轻量级的服务，当复制集成员为偶数时，最好加入一个</span><span>Arbiter</span><span style="font-family:'微软雅黑', sans-serif;">节点，以提升复制集可用性。</span></p> </td> 
     </tr>
     <tr>
      <td style="border-top:none;border-left:none;border-bottom-width:1pt;border-right-width:1pt;background:#cccccc;"> <p style="text-align:center;" align="center"><strong><span>Priority0</span></strong></p> </td> 
      <td style="border-top:none;border-right:none;border-left:none;border-bottom-width:1pt;background:#cccccc;" valign="top"> <p style="text-align:justify;text-indent:24pt;"><span>Priority0</span><span style="font-family:'微软雅黑', sans-serif;">节点的选举优先级为</span><span>0</span><span style="font-family:'微软雅黑', sans-serif;">，不会被选举为</span><span>Primary</span></p> <p style="text-align:justify;text-indent:24pt;"><span style="font-family:'微软雅黑', sans-serif;">比如你跨机房</span><span>A</span><span style="font-family:'微软雅黑', sans-serif;">、</span><span>B</span><span style="font-family:'微软雅黑', sans-serif;">部署了一个复制集，并且想指定</span><span>Primary</span><span style="font-family:'微软雅黑', sans-serif;">必须在</span><span>A</span><span style="font-family:'微软雅黑', sans-serif;">机房，这时可以将</span><span>B</span><span style="font-family:'微软雅黑', sans-serif;">机房的复制集成员</span><span>Priority</span><span style="font-family:'微软雅黑', sans-serif;">设置为</span><span>0</span><span style="font-family:'微软雅黑', sans-serif;">，这样</span><span>Primary</span><span style="font-family:'微软雅黑', sans-serif;">就一定会是</span><span>A</span><span style="font-family:'微软雅黑', sans-serif;">机房的成员。</span></p> <p style="text-align:justify;"><span style="font-family:'微软雅黑', sans-serif;">（注意：如果这样部署，最好将『大多数』节点部署在</span><span>A</span><span style="font-family:'微软雅黑', sans-serif;">机房，否则网络分区时可能无法选出</span><span>Primary</span><span style="font-family:'微软雅黑', sans-serif;">）</span></p> </td> 
     </tr>
     <tr>
      <td style="border-top:none;border-left:none;border-bottom-width:1pt;border-right-width:1pt;"> <p style="text-align:center;" align="center"><strong><span>Vote0</span></strong></p> </td> 
      <td style="border-top:none;border-right:none;border-left:none;border-bottom-width:1pt;" valign="top"> <p style="text-align:justify;text-indent:24pt;"><span>Mongodb 3.0</span><span style="font-family:'微软雅黑', sans-serif;">里，复制集成员最多</span><span>50</span><span style="font-family:'微软雅黑', sans-serif;">个，参与</span><span>Primary</span><span style="font-family:'微软雅黑', sans-serif;">选举投票的成员最多</span><span>7</span><span style="font-family:'微软雅黑', sans-serif;">个，其他成员（</span><span>Vote0</span><span style="font-family:'微软雅黑', sans-serif;">）的</span><span>vote</span><span style="font-family:'微软雅黑', sans-serif;">属性必须设置为</span><span>0</span><span style="font-family:'微软雅黑', sans-serif;">，即不参与投票。</span></p> </td> 
     </tr>
     <tr>
      <td style="border-top:none;border-left:none;border-bottom-width:1pt;border-right-width:1pt;background:#cccccc;"> <p style="text-align:center;" align="center"><strong><span>Hidden</span></strong></p> </td> 
      <td style="border-top:none;border-right:none;border-left:none;border-bottom-width:1pt;background:#cccccc;" valign="top"> <p style="text-align:justify;text-indent:24pt;"><span>Hidden</span><span style="font-family:'微软雅黑', sans-serif;">节点不能被选为主（</span><span>Priority</span><span style="font-family:'微软雅黑', sans-serif;">为</span><span>0</span><span style="font-family:'微软雅黑', sans-serif;">），并且对</span><span>Driver</span><span style="font-family:'微软雅黑', sans-serif;">不可见。因</span><span>Hidden</span><span style="font-family:'微软雅黑', sans-serif;">节点不会接受</span><span>Driver</span><span style="font-family:'微软雅黑', sans-serif;">的请求，可使用</span><span>Hidden</span><span style="font-family:'微软雅黑', sans-serif;">节点做一些数据备份、离线计算的任务，不会影响复制集的服务。</span></p> </td> 
     </tr>
     <tr>
      <td style="border-top:none;border-left:none;border-bottom-width:1pt;border-bottom-color:#000000;border-right-width:1pt;"> <p style="text-align:center;" align="center"><strong><span>Delayed</span></strong></p> </td> 
      <td style="border-top:none;border-right:none;border-left:none;border-bottom-width:1pt;border-bottom-color:#000000;" valign="top"> <p style="text-align:justify;text-indent:24pt;"><span>Delayed</span><span style="font-family:'微软雅黑', sans-serif;">节点必须是</span><span>Hidden</span><span style="font-family:'微软雅黑', sans-serif;">节点，并且其数据落后与</span><span>Primary</span><span style="font-family:'微软雅黑', sans-serif;">一段时间（可配置，比如</span><span>1</span><span style="font-family:'微软雅黑', sans-serif;">个小时）。</span></p> <p style="text-align:justify;text-indent:24pt;"><span style="font-family:'微软雅黑', sans-serif;">因</span><span>Delayed</span><span style="font-family:'微软雅黑', sans-serif;">节点的数据比</span><span>Primary</span><span style="font-family:'微软雅黑', sans-serif;">落后一段时间，当错误或者无效的数据写入</span><span>Primary</span><span style="font-family:'微软雅黑', sans-serif;">时，可通过</span><span>Delayed</span><span style="font-family:'微软雅黑', sans-serif;">节点的数据来恢复到之前的时间点。</span></p> </td> 
     </tr>
    </tbody>
   </table>
   <h3>1.3.2 Priority 0节点</h3> 
   <p><span style="font-size:14px;">　　作为一个辅助可以作为一个备用。在一些复制集中，可能无法在合理的时间内添加新成员的时候。备用成员保持数据的当前最新数据能够替换不可用的成员。</span></p> 
   <p align="center">&nbsp;<img src="http://images2017.cnblogs.com/blog/1190037/201801/1190037-20180106145417862-997356969.png" alt=""></p> 
   <h3>1.3.3 Hidden 节点（隐藏节点）</h3> 
   <p>　　客户端将不会把读请求分发到隐藏节点上，即使我们设定了 复制集读选项 。</p> 
   <p>　　这些隐藏节点将不会收到来自应用程序的请求。我们可以将隐藏节点专用于报表节点或是备份节点。 延时节点也应该是一个隐藏节点。</p> 
   <p align="center">&nbsp;<img src="http://images2017.cnblogs.com/blog/1190037/201801/1190037-20180106145428909-502320189.png" alt=""></p> 
   <h3>1.3.4 Delayed 节点（延时节点）</h3> 
   <p>　　延时节点的数据集是延时的，因此它可以帮助我们在人为误操作或是其他意外情况下恢复数据。</p> 
   <p>　　举个例子，当应用升级失败，或是误操作删除了表和数据库时，我们可以通过延时节点进行数据恢复。</p> 
   <p align="center">&nbsp;<img src="http://images2017.cnblogs.com/blog/1190037/201801/1190037-20180106145445471-876081667.png" alt=""></p> 
   <h2>1.4 配置MongoDB复制集</h2> 
   <h3>1.4.1 环境说明</h3> 
   <p><em><span style="text-decoration:underline;">系统环境说明：</span></em></p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>[root@MongoDB ~]# <span style="color:#0000ff;">cat</span> /etc/redhat-<span style="color:#000000;">release 
CentOS release </span><span style="color:#800080;">6.9</span><span style="color:#000000;"> (Final)
[root@MongoDB </span>~]# <span style="color:#0000ff;">uname</span> -<span style="color:#000000;">r
</span><span style="color:#800080;">2.6</span>.<span style="color:#800080;">32</span>-<span style="color:#800080;">696</span><span style="color:#000000;">.el6.x86_64
[root@MongoDB </span>~]# /etc/init.d/<span style="color:#000000;">iptables status
iptables: Firewall is not running.
[root@MongoDB </span>~<span style="color:#000000;">]# getenforce 
Disabled
[root@MongoDB </span>~]# <span style="color:#0000ff;">hostname</span> -<span style="color:#000000;">I
</span><span style="color:#800080;">10.0</span>.<span style="color:#800080;">0.152</span> <span style="color:#800080;">172.16</span>.<span style="color:#800080;">1.152</span></pre> 
    </div> 
   </div> 
   <p><strong><em><span style="text-decoration:underline;">软件版本说明</span></em></strong></p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>　　本次使用的mongodb版本为：mongodb-linux-x86_64-<span style="color:#800080;">3.2</span>.<span style="color:#800080;">8</span>.tgz</pre> 
    </div> 
   </div> 
   <h3>1.4.2 前期准备，在root用户下操作</h3> 
   <p>　　本次复制集复制采用Mongodb多实例进行</p> 
   <p>　　所有的操作都基于安装完成的mongodb服务，详情参照：<a href="http://www.cnblogs.com/clsn/p/8214194.html#_label3" rel="nofollow">http://www.cnblogs.com/clsn/p/8214194.html#_label3</a><a href="http://blog.nmtui.com/" rel="nofollow"><br></a></p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#008000;">#</span><span style="color:#008000;">创建mongod用户</span>
    useradd -<span style="color:#000000;">u800 mongod
    echo </span>123456|passwd --<span style="color:#000000;">stdin mongod 
</span><span style="color:#008000;">#</span><span style="color:#008000;"> 安装mongodb</span>
    mkdir -p /mongodb/<span style="color:#000000;">bin
 　　cd  </span>/<span style="color:#000000;">mongodb
　　 wget http:</span>//downloads.mongodb.org/linux/mongodb-linux-x86_64-rhel62-3.2.8<span style="color:#000000;">.tgz
    tar xf  mongodb</span>-linux-x86_64-3.2.8<span style="color:#000000;">.tgz
    cd mongodb</span>-linux-x86_64-3.2.8/bin/ &amp;&amp;<span style="color:#000000;">\
    cp </span>* /mongodb/<span style="color:#000000;">bin
    chown </span>-R mongod.mongod /<span style="color:#000000;">mongodb
</span><span style="color:#008000;">#</span><span style="color:#008000;"> 切换到mongod用户进行后续操作</span>
    su - mongod</pre> 
    </div> 
   </div> 
   <h3>1.4.3 创建所需目录</h3> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#0000ff;">for</span>  i <span style="color:#0000ff;">in</span> <span style="color:#800080;">28017</span> <span style="color:#800080;">28018</span> <span style="color:#800080;">28019</span> <span style="color:#800080;">28020</span>
    <span style="color:#0000ff;">do</span> 
      <span style="color:#0000ff;">mkdir</span> -p /mongodb/$i/<span style="color:#000000;">conf  
      </span><span style="color:#0000ff;">mkdir</span> -p /mongodb/$i/<span style="color:#000000;">data  
      </span><span style="color:#0000ff;">mkdir</span> -p /mongodb/$i/<span style="color:#000000;">log
</span><span style="color:#0000ff;">done</span> </pre> 
    </div> 
   </div> 
   <h3>1.4.4 配置多实例环境</h3> 
   <p>编辑第一个实例配置文件</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#0000ff;">cat</span> &gt;&gt;/mongodb/<span style="color:#800080;">28017</span>/conf/mongod.conf&lt;&lt;<span style="color:#800000;">'</span><span style="color:#800000;">EOF</span><span style="color:#800000;">'</span><span style="color:#000000;">
systemLog:
  destination: </span><span style="color:#0000ff;">file</span><span style="color:#000000;">
  path: </span>/mongodb/<span style="color:#800080;">28017</span>/log/<span style="color:#000000;">mongodb.log
  logAppend: </span><span style="color:#0000ff;">true</span><span style="color:#000000;">
storage:
  journal:
    enabled: </span><span style="color:#0000ff;">true</span><span style="color:#000000;">
  dbPath: </span>/mongodb/<span style="color:#800080;">28017</span>/<span style="color:#000000;">data
  directoryPerDB: </span><span style="color:#0000ff;">true</span><span style="color:#000000;">
  #engine: wiredTiger
  wiredTiger:
    engineConfig:
      # cacheSizeGB: </span><span style="color:#800080;">1</span><span style="color:#000000;">
      directoryForIndexes: </span><span style="color:#0000ff;">true</span><span style="color:#000000;">
    collectionConfig:
      blockCompressor: zlib
    indexConfig:
      prefixCompression: </span><span style="color:#0000ff;">true</span><span style="color:#000000;">
processManagement:
  fork: </span><span style="color:#0000ff;">true</span><span style="color:#000000;">
net:
  port: </span><span style="color:#800080;">28017</span><span style="color:#000000;">
replication:
  oplogSizeMB: </span><span style="color:#800080;">2048</span><span style="color:#000000;">
  replSetName: my_repl
EOF</span></pre> 
    </div> 
   </div> 
   <p>复制配置文件</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#0000ff;">for</span> i <span style="color:#0000ff;">in</span> <span style="color:#800080;">28018</span> <span style="color:#800080;">28019</span> <span style="color:#800080;">28020</span>
  <span style="color:#0000ff;">do</span><span style="color:#000000;">  
   \</span><span style="color:#0000ff;">cp</span>  /mongodb/<span style="color:#800080;">28017</span>/conf/mongod.conf  /mongodb/$i/conf/
<span style="color:#0000ff;">done</span></pre> 
    </div> 
   </div> 
   <p>修改配置文件</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#0000ff;">for</span> i <span style="color:#0000ff;">in</span> <span style="color:#800080;">28018</span> <span style="color:#800080;">28019</span> <span style="color:#800080;">28020</span>
  <span style="color:#0000ff;">do</span> 
    <span style="color:#0000ff;">sed</span>  -i  <span style="color:#800000;">"</span><span style="color:#800000;">s#28017#$i#g</span><span style="color:#800000;">"</span> /mongodb/$i/conf/<span style="color:#000000;">mongod.conf
</span><span style="color:#0000ff;">done</span></pre> 
    </div> 
   </div> 
   <p>启动服务</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#0000ff;">for</span> i <span style="color:#0000ff;">in</span> <span style="color:#800080;">28017</span> <span style="color:#800080;">28018</span> <span style="color:#800080;">28019</span> <span style="color:#800080;">28020</span>
  <span style="color:#0000ff;">do</span><span style="color:#000000;">  
    mongod </span>-f /mongodb/$i/conf/<span style="color:#000000;">mongod.conf 
</span><span style="color:#0000ff;">done</span></pre> 
    </div> 
   </div> 
   <p># 关闭服务的方法</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#0000ff;">for</span> i <span style="color:#0000ff;">in</span> <span style="color:#800080;">28017</span> <span style="color:#800080;">28018</span> <span style="color:#800080;">28019</span> <span style="color:#800080;">28020</span>
   <span style="color:#0000ff;">do</span><span style="color:#000000;">  
     mongod </span>--shutdown  -f /mongodb/$i/conf/<span style="color:#000000;">mongod.conf 
</span><span style="color:#0000ff;">done</span></pre> 
    </div> 
   </div> 
   <h3>1.4.5 配置复制集</h3> 
   <p>登陆数据库，配置mongodb复制</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>shell&gt; mongo --port 28017<span style="color:#000000;">

config </span>= {_id: <span style="color:#800000;">'</span><span style="color:#800000;">my_repl</span><span style="color:#800000;">'</span><span style="color:#000000;">, members: [
                          {_id: 0, host: </span><span style="color:#800000;">'</span><span style="color:#800000;">10.0.0.152:28017</span><span style="color:#800000;">'</span><span style="color:#000000;">},
                          {_id: </span>1, host: <span style="color:#800000;">'</span><span style="color:#800000;">10.0.0.152:28018</span><span style="color:#800000;">'</span><span style="color:#000000;">},
                          {_id: </span>2, host: <span style="color:#800000;">'</span><span style="color:#800000;">10.0.0.152:28019</span><span style="color:#800000;">'</span><span style="color:#000000;">}]
          }</span></pre> 
    </div> 
   </div> 
   <p>初始化这个配置</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#808080;">&gt;</span> rs.initiate(config)</pre> 
    </div> 
    <p>　　<span style="color:#ff0000;"><strong>&nbsp; &nbsp;</strong><strong>到此复制集配置完成</strong></span></p> 
   </div> 
   <h3>1.4.6 测试主从复制</h3> 
   <p>在主节点插入数据</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>my_repl:<span style="color:#0000ff;">PRIMARY</span><span style="color:#808080;">&gt;</span> db.movies.<span style="color:#0000ff;">insert</span>(<span style="color:#ff0000;">[</span><span style="color:#ff0000;"> { "title" : "Jaws", "year" : 1975, "imdb_rating" : 8.1 },
   { "title" : "Batman", "year" : 1989, "imdb_rating" : 7.6 },
  </span><span style="color:#ff0000;">]</span> );</pre> 
    </div> 
   </div> 
   <p>在主节点查看数据</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>my_repl:<span style="color:#0000ff;">PRIMARY</span><span style="color:#808080;">&gt;</span><span style="color:#000000;"> db.movies.find().pretty()
{
    "_id" : ObjectId("5a4d9ec184b9b2076686b0ac"),
    "title" : "Jaws",
    "</span><span style="color:#ff00ff;">year</span>" : <span style="color:#800000;font-weight:bold;">1975</span><span style="color:#000000;">,
    "imdb_rating" : </span><span style="color:#800000;font-weight:bold;">8.1</span><span style="color:#000000;">
}
{
    "_id" : ObjectId("5a4d9ec184b9b2076686b0ad"),
    "title" : "Batman",
    "</span><span style="color:#ff00ff;">year</span>" : <span style="color:#800000;font-weight:bold;">1989</span><span style="color:#000000;">,
    "imdb_rating" : </span><span style="color:#800000;font-weight:bold;">7.6</span><span style="color:#000000;">
}</span></pre> 
    </div> 
    <p>　　注：在mongodb复制集当中，默认从库不允许读写。</p> 
   </div> 
   <p>在从库打开配置（危险）</p> 
   <p>&nbsp;&nbsp; 　<span style="color:#ff0000;">　　<strong>注意：严禁在从库做任何修改操作</strong></span></p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>my_repl:SECONDARY<span style="color:#808080;">&gt;</span><span style="color:#000000;"> rs.slaveOk()
my_repl:SECONDARY</span><span style="color:#808080;">&gt;</span><span style="color:#000000;"> show tables;
movies
my_repl:SECONDARY</span><span style="color:#808080;">&gt;</span><span style="color:#000000;"> db.movies.find().pretty()
{
    "_id" : ObjectId("5a4d9ec184b9b2076686b0ac"),
    "title" : "Jaws",
    "</span><span style="color:#ff00ff;">year</span>" : <span style="color:#800000;font-weight:bold;">1975</span><span style="color:#000000;">,
    "imdb_rating" : </span><span style="color:#800000;font-weight:bold;">8.1</span><span style="color:#000000;">
}
{
    "_id" : ObjectId("5a4d9ec184b9b2076686b0ad"),
    "title" : "Batman",
    "</span><span style="color:#ff00ff;">year</span>" : <span style="color:#800000;font-weight:bold;">1989</span><span style="color:#000000;">,
    "imdb_rating" : </span><span style="color:#800000;font-weight:bold;">7.6</span><span style="color:#000000;">
}</span></pre> 
    </div> 
    <p>　　在从库查看完成在登陆到主库</p> 
   </div> 
   <h3>1.4.7 复制集管理操作</h3> 
   <p>（1）查看复制集状态：</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#000000;">rs.status();     # 查看整体复制集状态
rs.isMaster();   #  查看当前是否是主节点</span></pre> 
    </div> 
   </div> 
   <p>（2）添加删除节点</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>rs.<span style="color:#0000ff;">add</span><span style="color:#000000;">("ip:port");     #  新增从节点
rs.addArb("ip:port"); #  新增仲裁节点
rs.remove("ip:port"); #  删除一个节点</span></pre> 
    </div> 
   </div> 
   <p>注：</p> 
   <blockquote> 
    <p>添加特殊节点时，</p> 
    <p>　　1&gt;可以在搭建过程中设置特殊节点</p> 
    <p>　　2&gt;可以通过修改配置的方式将普通从节点设置为特殊节点</p> 
    <p>　　/*找到需要改为延迟性同步的数组号*/;</p> 
   </blockquote> 
   <p><span><strong>（3</strong><strong>）配置延时节点（一般延时节点也配置成hidden</strong><strong>）</strong></span></p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>cfg<span style="color:#808080;">=</span><span style="color:#000000;">rs.conf() 
cfg.members</span><span style="color:#ff0000;">[</span><span style="color:#ff0000;">2</span><span style="color:#ff0000;">]</span>.priority<span style="color:#808080;">=</span><span style="color:#800000;font-weight:bold;">0</span><span style="color:#000000;">
cfg.members</span><span style="color:#ff0000;">[</span><span style="color:#ff0000;">2</span><span style="color:#ff0000;">]</span>.slaveDelay<span style="color:#808080;">=</span><span style="color:#800000;font-weight:bold;">120</span><span style="color:#000000;">
cfg.members</span><span style="color:#ff0000;">[</span><span style="color:#ff0000;">2</span><span style="color:#ff0000;">]</span>.hidden<span style="color:#808080;">=</span>true</pre> 
    </div> 
    <p>　　&nbsp; &nbsp;注：这里的2是rs.conf()显示的顺序（<em>除主库之外</em>），非ID</p> 
   </div> 
   <p>重写复制集配置</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>rs.reconfig(cfg)   </pre> 
    </div> 
   </div> 
   <p>&nbsp;&nbsp; 也可将延时节点配置为arbiter节点</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>cfg.members<span style="color:#ff0000;">[</span><span style="color:#ff0000;">2</span><span style="color:#ff0000;">]</span>.arbiterOnly<span style="color:#808080;">=</span>true</pre> 
    </div> 
   </div> 
   <p>配置成功后，通过以下命令查询配置后的属性</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>rs.conf();</pre> 
    </div> 
   </div> 
   <h3>1.4.8 副本集其他操作命令</h3> 
   <p>查看副本集的配置信息</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>my_repl:<span style="color:#0000ff;">PRIMARY</span><span style="color:#808080;">&gt;</span> rs.config()</pre> 
    </div> 
   </div> 
   <p>查看副本集各成员的状态</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>my_repl:<span style="color:#0000ff;">PRIMARY</span><span style="color:#808080;">&gt;</span> rs.status()</pre> 
    </div> 
   </div> 
   <h4> <strong>1.4.8.1&nbsp; </strong><strong>副本集角色切换（不要人为随便操作）</strong> </h4> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#000000;">rs.stepDown()
rs.freeze(</span><span style="color:#800000;font-weight:bold;">300</span><span style="color:#000000;">)  # 锁定从，使其不会转变成主库，freeze()和stepDown单位都是秒。
rs.slaveOk()    # 设置副本节点可读：在副本节点执行</span></pre> 
    </div> 
   </div> 
   <p>&nbsp;&nbsp; 插入数据</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#808080;">&gt;</span> <span style="color:#0000ff;">use</span><span style="color:#000000;"> app
switched </span><span style="color:#0000ff;">to</span><span style="color:#000000;"> db app
app</span><span style="color:#808080;">&gt;</span> db.createCollection(<span style="color:#ff0000;">'</span><span style="color:#ff0000;">a</span><span style="color:#ff0000;">'</span><span style="color:#000000;">)
{ "ok" : </span><span style="color:#800000;font-weight:bold;">0</span>, "errmsg" : "<span style="color:#808080;">not</span> master", "code" : <span style="color:#800000;font-weight:bold;">10107</span> }</pre> 
    </div> 
   </div> 
   <p>查看副本节点</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#808080;">&gt;</span><span style="color:#000000;"> rs.printSlaveReplicationInfo()
source: </span><span style="color:#800000;font-weight:bold;">192.168</span>.<span style="color:#800000;font-weight:bold;">1.22</span>:<span style="color:#800000;font-weight:bold;">27017</span><span style="color:#000000;">
    syncedTo: Thu May </span><span style="color:#800000;font-weight:bold;">26</span> <span style="color:#800000;font-weight:bold;">2016</span> <span style="color:#800000;font-weight:bold;">10</span>:<span style="color:#800000;font-weight:bold;">28</span>:<span style="color:#800000;font-weight:bold;">56</span> GMT<span style="color:#808080;">+</span><span style="color:#800000;font-weight:bold;">0800</span><span style="color:#000000;"> (CST)
    </span><span style="color:#800000;font-weight:bold;">0</span> secs (<span style="color:#800000;font-weight:bold;">0</span> hrs) behind the <span style="color:#0000ff;">primary</span></pre> 
    </div> 
   </div> 
   <h1>MongoDB分片（Sharding）技术</h1> 
   <p>　　分片（sharding）是MongoDB用来将大型集合分割到不同服务器（或者说一个集群）上所采用的方法。尽管分片起源于关系型数据库分区，但MongoDB分片完全又是另一回事。</p> 
   <p>　　和MySQL分区方案相比，MongoDB的最大区别在于它几乎能自动完成所有事情，只要告诉MongoDB要分配数据，它就能自动维护数据在不同服务器之间的均衡。</p> 
   <h2>2.1 MongoDB分片介绍</h2> 
   <h3>2.1.1 分片的目的</h3> 
   <p>　　高数据量和吞吐量的数据库应用会对单机的性能造成较大压力,大的查询量会将单机的CPU耗尽,大的数据量对单机的存储压力较大,最终会耗尽系统的内存而将压力转移到磁盘IO上。</p> 
   <p>　　为了解决这些问题,有两个基本的方法: 垂直扩展和水平扩展。</p> 
   <p>　　　　<span>垂直扩展：</span>增加更多的CPU和存储资源来扩展容量。</p> 
   <p>　　　　<span>水平扩展：</span>将数据集分布在多个服务器上。水平扩展即分片。</p> 
   <h3>2.1.2 分片设计思想</h3> 
   <p>　　分片为应对高吞吐量与大数据量提供了方法。使用分片减少了每个分片需要处理的请求数，因此，通过水平扩展，集群可以提高自己的存储容量和吞吐量。举例来说，当插入一条数据时，应用只需要访问存储这条数据的分片.</p> 
   <p>　　使用分片减少了每个分片存储的数据。</p> 
   <p>　　例如，如果数据库1tb的数据集，并有4个分片，然后每个分片可能仅持有256 GB的数据。如果有40个分片，那么每个切分可能只有25GB的数据。</p> 
   <p align="center"><img src="http://images2017.cnblogs.com/blog/1190037/201801/1190037-20180106150209471-1233466151.png" alt=""></p> 
   <h3>2.1.3 分片机制提供了如下三种优势</h3> 
   <p><strong>1.</strong><strong>对集群进行抽象，让集群“不可见”</strong></p> 
   <p>　　MongoDB自带了一个叫做mongos的专有路由进程。mongos就是掌握统一路口的路由器，其会将客户端发来的请求准确无误的路由到集群中的一个或者一组服务器上，同时会把接收到的响应拼装起来发回到客户端。</p> 
   <p><strong>2.</strong><strong>保证集群总是可读写</strong></p> 
   <p>　　MongoDB通过多种途径来确保集群的可用性和可靠性。将MongoDB的分片和复制功能结合使用，在确保数据分片到多台服务器的同时，也确保了每分数据都有相应的备份，这样就可以确保有服务器换掉时，其他的从库可以立即接替坏掉的部分继续工作。</p> 
   <p><strong>3.</strong><strong>使集群易于扩展</strong></p> 
   <p>　　当系统需要更多的空间和资源的时候，MongoDB使我们可以按需方便的扩充系统容量。</p> 
   <h3>2.1.4 分片集群架构</h3> 
   <table border="1">
    <tbody>
     <tr>
      <td valign="top"> <p style="text-align:center;"><strong>组件</strong></p> </td> 
      <td valign="top"> <p style="text-align:center;"><strong>说明</strong></p> </td> 
     </tr>
     <tr>
      <td valign="top"> <p style="text-align:center;"><strong>Config Server</strong></p> </td> 
      <td valign="top"> <p>存储集群所有节点、分片数据路由信息。默认需要配置3个Config Server节点。</p> </td> 
     </tr>
     <tr>
      <td valign="top"> <p style="text-align:center;"><strong>Mongos</strong></p> </td> 
      <td valign="top"> <p>提供对外应用访问，所有操作均通过mongos执行。一般有多个mongos节点。数据迁移和数据自动平衡。</p> </td> 
     </tr>
     <tr>
      <td valign="top"> <p style="text-align:center;"><strong>Mongod</strong></p> </td> 
      <td valign="top"> <p>存储应用数据记录。一般有多个Mongod节点，达到数据分片目的。</p> </td> 
     </tr>
    </tbody>
   </table>
   <p align="center">&nbsp;<img src="http://images2017.cnblogs.com/blog/1190037/201801/1190037-20180106150523846-1535223046.png" alt=""></p> 
   <p><span><strong>分片集群的构造</strong></span></p> 
   <blockquote> 
    <p>&nbsp;（1）mongos ：数据路由，和客户端打交道的模块。mongos本身没有任何数据，他也不知道该怎么处理这数据，去找config server</p> 
    <p>（2）config server：所有存、取数据的方式，所有shard节点的信息，分片功能的一些配置信息。可以理解为真实数据的元数据。</p> 
    <p>&nbsp;（3）shard：真正的数据存储位置，以chunk为单位存数据。</p> 
   </blockquote> 
   <p>　　Mongos本身并不持久化数据，Sharded cluster所有的元数据都会存储到Config Server，而用户的数据会议分散存储到各个shard。Mongos启动后，会从配置服务器加载元数据，开始提供服务，将用户的请求正确路由到对应的碎片。</p> 
   <p><strong>Mongos</strong><strong>的路由功能</strong></p> 
   <p>　　当数据写入时，MongoDB Cluster根据分片键设计写入数据。</p> 
   <p>　　当外部语句发起数据查询时，MongoDB根据数据分布自动路由至指定节点返回数据。</p> 
   <h2>2.2 集群中数据分布</h2> 
   <h3>2.2.1 Chunk是什么</h3> 
   <p>　　在一个shard server内部，MongoDB还是会把数据分为chunks，每个chunk代表这个shard server内部一部分数据。chunk的产生，会有以下两个用途：</p> 
   <p><strong>　　<span>Splitting</span></strong><span><strong>：</strong></span>当一个chunk的大小超过配置中的chunk size时，MongoDB的后台进程会把这个chunk切分成更小的chunk，从而避免chunk过大的情况</p> 
   <p><strong>　　<span>Balancing</span></strong><span><strong>：</strong></span>在MongoDB中，balancer是一个后台进程，负责chunk的迁移，从而均衡各个shard server的负载，系统初始1个chunk，chunk size默认值64M,生产库上选择适合业务的chunk size是最好的。ongoDB会自动拆分和迁移chunks。</p> 
   <p><strong>分片集群的数据分布（shard</strong><strong>节点）</strong></p> 
   <div> 
    <blockquote> 
     <p>（1）使用chunk来存储数据</p> 
     <p>（2）进群搭建完成之后，默认开启一个chunk，大小是64M，</p> 
     <p>（3）存储需求超过64M，chunk会进行分裂，如果单位时间存储需求很大，设置更大的chunk</p> 
     <p>（4）chunk会被自动均衡迁移。</p> 
    </blockquote> 
   </div> 
   <h3>2.2.2 chunksize的选择</h3> 
   <p>　　适合业务的chunksize是最好的。</p> 
   <p>　　chunk的分裂和迁移非常消耗IO资源；chunk分裂的时机：在插入和更新，读数据不会分裂。</p> 
   <p><strong>　　<span>chunksize</span></strong><span><strong>的选择：</strong></span></p> 
   <p>　　小的chunksize：数据均衡是迁移速度快，数据分布更均匀。数据分裂频繁，路由节点消耗更多资源。大的chunksize：数据分裂少。数据块移动集中消耗IO资源。通常100-200M</p> 
   <h3>2.2.3 chunk分裂及迁移</h3> 
   <p>　　随着数据的增长，其中的数据大小超过了配置的chunk size，默认是64M，则这个chunk就会分裂成两个。数据的增长会让chunk分裂得越来越多。</p> 
   <p align="center">&nbsp;<img src="http://images2017.cnblogs.com/blog/1190037/201801/1190037-20180106150630018-1017846225.png" alt=""></p> 
   <p>　　这时候，各个shard 上的chunk数量就会不平衡。这时候，mongos中的一个组件balancer&nbsp; 就会执行自动平衡。把chunk从chunk数量最多的shard节点挪动到数量最少的节点。</p> 
   <p align="center"><img src="http://images2017.cnblogs.com/blog/1190037/201801/1190037-20180106150636096-1641567859.png" alt="">&nbsp;</p> 
   <p><span><strong>chunkSize </strong><strong>对分裂及迁移的影响</strong></span></p> 
   <p>　　MongoDB 默认的 chunkSize 为64MB，如无特殊需求，建议保持默认值；chunkSize 会直接影响到 chunk 分裂、迁移的行为。</p> 
   <p>　　chunkSize 越小，chunk 分裂及迁移越多，数据分布越均衡；反之，chunkSize 越大，chunk 分裂及迁移会更少，但可能导致数据分布不均。</p> 
   <p>　　chunkSize 太小，容易出现 jumbo chunk（即shardKey 的某个取值出现频率很高，这些文档只能放到一个 chunk 里，无法再分裂）而无法迁移；chunkSize 越大，则可能出现 chunk 内文档数太多（chunk 内文档数不能超过 250000 ）而无法迁移。</p> 
   <p>　　chunk 自动分裂只会在数据写入时触发，所以如果将 chunkSize 改小，系统需要一定的时间来将 chunk 分裂到指定的大小。</p> 
   <p>　　chunk 只会分裂，不会合并，所以即使将 chunkSize 改大，现有的 chunk 数量不会减少，但 chunk 大小会随着写入不断增长，直到达到目标大小。</p> 
   <h2>2.3 数据区分</h2> 
   <h3>2.3.1 分片键shard key</h3> 
   <p>　　MongoDB中数据的分片是、以集合为基本单位的，集合中的数据通过片键（Shard key）被分成多部分。其实片键就是在集合中选一个键，用该键的值作为数据拆分的依据。</p> 
   <p>　　所以一个好的片键对分片至关重要。片键必须是一个索引，通过sh.shardCollection加会自动创建索引（前提是此集合不存在的情况下）。一个自增的片键对写入和数据均匀分布就不是很好，因为自增的片键总会在一个分片上写入，后续达到某个阀值可能会写到别的分片。但是按照片键查询会非常高效。</p> 
   <p>　　随机片键对数据的均匀分布效果很好。注意尽量避免在多个分片上进行查询。在所有分片上查询，mongos会对结果进行归并排序。</p> 
   <p>　　对集合进行分片时，你需要选择一个片键，片键是每条记录都必须包含的，且建立了索引的单个字段或复合字段，MongoDB按照片键将数据划分到不同的数据块中，并将数据块均衡地分布到所有分片中。</p> 
   <p>　　为了按照片键划分数据块，MongoDB使用基于范围的分片方式或者 基于哈希的分片方式。</p> 
   <p><strong>注意：</strong></p> 
   <div> 
    <blockquote> 
     <p>分片键是不可变。</p> 
     <p>分片键必须有索引。</p> 
     <p>分片键大小限制512bytes。</p> 
     <p>分片键用于路由查询。</p> 
     <p>MongoDB不接受已进行collection级分片的collection上插入无分片</p> 
     <p>键的文档（也不支持空值插入）</p> 
    </blockquote> 
   </div> 
   <h3>2.3.2 以范围为基础的分片Sharded Cluster</h3> 
   <p>　　Sharded Cluster支持将单个集合的数据分散存储在多shard上，用户可以指定根据集合内文档的某个字段即shard key来进行范围分片（range sharding）。</p> 
   <p align="center">&nbsp;<img src="http://images2017.cnblogs.com/blog/1190037/201801/1190037-20180106150717440-244129239.png" alt=""></p> 
   <p>　　对于基于范围的分片，MongoDB按照片键的范围把数据分成不同部分。</p> 
   <p>　　假设有一个数字的片键:想象一个从负无穷到正无穷的直线，每一个片键的值都在直线上画了一个点。MongoDB把这条直线划分为更短的不重叠的片段，并称之为数据块，每个数据块包含了片键在一定范围内的数据。在使用片键做范围划分的系统中，拥有”相近”片键的文档很可能存储在同一个数据块中，因此也会存储在同一个分片中。</p> 
   <h3>2.3.3 基于哈希的分片</h3> 
   <p>　　分片过程中利用哈希索引作为分片的单个键，且哈希分片的片键只能使用一个字段，而基于哈希片键最大的好处就是保证数据在各个节点分布基本均匀。</p> 
   <p align="center">&nbsp;<img src="http://images2017.cnblogs.com/blog/1190037/201801/1190037-20180106150727893-1156186779.png" alt=""></p> 
   <p>　　对于基于哈希的分片，MongoDB计算一个字段的哈希值，并用这个哈希值来创建数据块。在使用基于哈希分片的系统中，拥有”相近”片键的文档很可能不会存储在同一个数据块中，因此数据的分离性更好一些。</p> 
   <p>　　Hash分片与范围分片互补，能将文档随机的分散到各个chunk，充分的扩展写能力，弥补了范围分片的不足，但不能高效的服务范围查询，所有的范围查询要分发到后端所有的Shard才能找出满足条件的文档。</p> 
   <h3>2.3.4 分片键选择建议</h3> 
   <p><strong>1</strong><strong>、递增的sharding key</strong></p> 
   <div> 
    <blockquote> 
     <p>数据文件挪动小。（优势）</p> 
     <p>因为数据文件递增，所以会把insert的写IO永久放在最后一片上，造成最后一片的写热点。同时，随着最后一片的数据量增大，将不断的发生迁移至之前的片上。</p> 
    </blockquote> 
   </div> 
   <p><strong>2</strong><strong>、随机的sharding key</strong></p> 
   <div> 
    <blockquote> 
     <p>数据分布均匀，insert的写IO均匀分布在多个片上。（优势）</p> 
     <p>大量的随机IO，磁盘不堪重荷。</p> 
    </blockquote> 
   </div> 
   <p><strong>3</strong><strong>、混合型key</strong></p> 
   <div> 
    <blockquote> 
     <div> 
      <p>大方向随机递增，小范围随机分布。</p> 
     </div> 
     <p>为了防止出现大量的chunk均衡迁移，可能造成的IO压力。我们需要设置合理分片使用策略（片键的选择、分片算法（range、hash））</p> 
    </blockquote> 
   </div> 
   <p><span style="color:#ff0000;"><strong>分片注意：</strong></span></p> 
   <p>&nbsp;&nbsp; 分片键是不可变、分片键必须有索引、分片键大小限制512bytes、分片键用于路由查询。</p> 
   <p>&nbsp;&nbsp; MongoDB不接受已进行collection级分片的collection上插入无分片键的文档（也不支持空值插入）</p> 
   <h2>2.4 部署分片集群</h2> 
   <p>　　<span style="color:#ff0000;">本集群的部署基于1.1的复制集搭建完成</span>。</p> 
   <h3>2.4.1 环境准备</h3> 
   <p>创建程序所需的目录</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#0000ff;">for</span>  i <span style="color:#808080;">in</span> <span style="color:#800000;font-weight:bold;">17</span> <span style="color:#800000;font-weight:bold;">18</span> <span style="color:#800000;font-weight:bold;">19</span> <span style="color:#800000;font-weight:bold;">20</span> <span style="color:#800000;font-weight:bold;">21</span> <span style="color:#800000;font-weight:bold;">22</span> <span style="color:#800000;font-weight:bold;">23</span> <span style="color:#800000;font-weight:bold;">24</span> <span style="color:#800000;font-weight:bold;">25</span> <span style="color:#800000;font-weight:bold;">26</span><span style="color:#000000;"> 
  do 
  mkdir </span><span style="color:#808080;">-</span>p <span style="color:#808080;">/</span>mongodb<span style="color:#808080;">/</span><span style="color:#800000;font-weight:bold;">280</span>$i<span style="color:#808080;">/</span><span style="color:#000000;">conf  
  mkdir </span><span style="color:#808080;">-</span>p <span style="color:#808080;">/</span>mongodb<span style="color:#808080;">/</span><span style="color:#800000;font-weight:bold;">280</span>$i<span style="color:#808080;">/</span><span style="color:#000000;">data  
  mkdir </span><span style="color:#808080;">-</span>p <span style="color:#808080;">/</span>mongodb<span style="color:#808080;">/</span><span style="color:#800000;font-weight:bold;">280</span>$i<span style="color:#808080;">/</span><span style="color:#ff00ff;">log</span><span style="color:#000000;">
done</span></pre> 
    </div> 
   </div> 
   <h3>2.4.2 shard集群配置</h3> 
   <p>编辑shard集群配置文件</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>cat <span style="color:#808080;">&gt;</span> <span style="color:#808080;">/</span>mongodb<span style="color:#808080;">/</span><span style="color:#800000;font-weight:bold;">28021</span><span style="color:#808080;">/</span>conf<span style="color:#808080;">/</span>mongod.conf <span style="color:#808080;">&lt;&lt;</span><span style="color:#ff0000;">'</span><span style="color:#ff0000;">EOF</span><span style="color:#ff0000;">'</span><span style="color:#000000;">
systemLog:
  destination: </span><span style="color:#0000ff;">file</span><span style="color:#000000;">
  path: </span><span style="color:#808080;">/</span>mongodb<span style="color:#808080;">/</span><span style="color:#800000;font-weight:bold;">28021</span><span style="color:#808080;">/</span><span style="color:#ff00ff;">log</span><span style="color:#808080;">/</span>mongodb.<span style="color:#ff00ff;">log</span><span style="color:#000000;">   
  logAppend: true
storage:
  journal:
    enabled: true
  dbPath: </span><span style="color:#808080;">/</span>mongodb<span style="color:#808080;">/</span><span style="color:#800000;font-weight:bold;">28021</span><span style="color:#808080;">/</span><span style="color:#000000;">data
  directoryPerDB: true
  #engine: wiredTiger
  wiredTiger:
    engineConfig:
      cacheSizeGB: </span><span style="color:#800000;font-weight:bold;">1</span><span style="color:#000000;">
      directoryForIndexes: true
    collectionConfig:
      blockCompressor: zlib
    indexConfig:
      prefixCompression: true
net:
  bindIp: </span><span style="color:#800000;font-weight:bold;">10.0</span>.<span style="color:#800000;font-weight:bold;">0.152</span><span style="color:#000000;">
  port: </span><span style="color:#800000;font-weight:bold;">28021</span>
<span style="color:#0000ff;">replication</span><span style="color:#000000;">:
  oplogSizeMB: </span><span style="color:#800000;font-weight:bold;">2048</span><span style="color:#000000;">
  replSetName: sh1
sharding:
  clusterRole: shardsvr
processManagement: 
  fork: true
EOF</span></pre> 
    </div> 
   </div> 
   <p>复制shard集群配置文件</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#0000ff;">for</span>  i <span style="color:#808080;">in</span>  <span style="color:#800000;font-weight:bold;">22</span> <span style="color:#800000;font-weight:bold;">23</span> <span style="color:#800000;font-weight:bold;">24</span> <span style="color:#800000;font-weight:bold;">25</span> <span style="color:#800000;font-weight:bold;">26</span><span style="color:#000000;">  
  do  
   \cp  </span><span style="color:#808080;">/</span>mongodb<span style="color:#808080;">/</span><span style="color:#800000;font-weight:bold;">28021</span><span style="color:#808080;">/</span>conf<span style="color:#808080;">/</span>mongod.conf  <span style="color:#808080;">/</span>mongodb<span style="color:#808080;">/</span><span style="color:#800000;font-weight:bold;">280</span>$i<span style="color:#808080;">/</span>conf<span style="color:#808080;">/</span><span style="color:#000000;">
done</span></pre> 
    </div> 
   </div> 
   <p>修改配置文件端口</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#0000ff;">for</span>  i <span style="color:#808080;">in</span>   <span style="color:#800000;font-weight:bold;">22</span> <span style="color:#800000;font-weight:bold;">23</span> <span style="color:#800000;font-weight:bold;">24</span> <span style="color:#800000;font-weight:bold;">25</span> <span style="color:#800000;font-weight:bold;">26</span><span style="color:#000000;">  
  do 
    sed  </span><span style="color:#808080;">-</span>i  "s#<span style="color:#800000;font-weight:bold;">28021</span>#<span style="color:#800000;font-weight:bold;">280</span>$i#g" <span style="color:#808080;">/</span>mongodb<span style="color:#808080;">/</span><span style="color:#800000;font-weight:bold;">280</span>$i<span style="color:#808080;">/</span>conf<span style="color:#808080;">/</span><span style="color:#000000;">mongod.conf
done</span></pre> 
    </div> 
   </div> 
   <p>&nbsp;&nbsp; 修改配置文件复制集名称（replSetName）</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#0000ff;">for</span>  i <span style="color:#808080;">in</span>    <span style="color:#800000;font-weight:bold;">24</span> <span style="color:#800000;font-weight:bold;">25</span> <span style="color:#800000;font-weight:bold;">26</span><span style="color:#000000;">  
  do 
    sed  </span><span style="color:#808080;">-</span>i  "s#sh1#sh2#g" <span style="color:#808080;">/</span>mongodb<span style="color:#808080;">/</span><span style="color:#800000;font-weight:bold;">280</span>$i<span style="color:#808080;">/</span>conf<span style="color:#808080;">/</span><span style="color:#000000;">mongod.conf
done</span></pre> 
    </div> 
   </div> 
   <p>启动shard集群</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#0000ff;">for</span>  i <span style="color:#808080;">in</span>  <span style="color:#800000;font-weight:bold;">21</span> <span style="color:#800000;font-weight:bold;">22</span> <span style="color:#800000;font-weight:bold;">23</span> <span style="color:#800000;font-weight:bold;">24</span> <span style="color:#800000;font-weight:bold;">25</span> <span style="color:#800000;font-weight:bold;">26</span><span style="color:#000000;">
  do  
    mongod </span><span style="color:#808080;">-</span>f <span style="color:#808080;">/</span>mongodb<span style="color:#808080;">/</span><span style="color:#800000;font-weight:bold;">280</span>$i<span style="color:#808080;">/</span>conf<span style="color:#808080;">/</span><span style="color:#000000;">mongod.conf 
done</span></pre> 
    </div> 
   </div> 
   <p>配置复制集1</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>mongo <span style="color:#008080;">--</span><span style="color:#008080;">host 10.0.0.152 --port 28021  admin</span></pre> 
    </div> 
    <p>　　# 配置复制集</p> 
    <div class="cnblogs_code"> 
     <pre>config <span style="color:#808080;">=</span> {_id: <span style="color:#ff0000;">'</span><span style="color:#ff0000;">sh1</span><span style="color:#ff0000;">'</span>, members: <span style="color:#ff0000;">[</span><span style="color:#ff0000;">
                          {_id: 0, host: '10.0.0.152:28021'},
                          {_id: 1, host: '10.0.0.152:28022'},
                          {_id: 2, host: '10.0.0.152:28023',"arbiterOnly":true}</span><span style="color:#ff0000;">]</span><span style="color:#000000;">
           }  
 # 初始化配置
rs.initiate(config)  </span></pre> 
    </div> 
   </div> 
   <p>&nbsp;配置复制集2</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>mongo <span style="color:#008080;">--</span><span style="color:#008080;">host 10.0.0.152 --port 28024  admin</span></pre> 
    </div> 
    <p>　　# 配置复制集</p> 
    <div class="cnblogs_code"> 
     <pre>config <span style="color:#808080;">=</span> {_id: <span style="color:#ff0000;">'</span><span style="color:#ff0000;">sh2</span><span style="color:#ff0000;">'</span>, members: <span style="color:#ff0000;">[</span><span style="color:#ff0000;">
                          {_id: 0, host: '10.0.0.152:28024'},
                          {_id: 1, host: '10.0.0.152:28025'},
                          {_id: 2, host: '10.0.0.152:28026',"arbiterOnly":true}</span><span style="color:#ff0000;">]</span><span style="color:#000000;">
           }
# 初始化配置
rs.initiate(config)</span></pre> 
    </div> 
   </div> 
   <h3>2.4.3 config集群配置</h3> 
   <p>创建主节点配置文件</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>cat <span style="color:#808080;">&gt;</span> <span style="color:#808080;">/</span>mongodb<span style="color:#808080;">/</span><span style="color:#800000;font-weight:bold;">28018</span><span style="color:#808080;">/</span>conf<span style="color:#808080;">/</span>mongod.conf <span style="color:#808080;">&lt;&lt;</span><span style="color:#ff0000;">'</span><span style="color:#ff0000;">EOF</span><span style="color:#ff0000;">'</span><span style="color:#000000;">
systemLog:
  destination: </span><span style="color:#0000ff;">file</span><span style="color:#000000;">
  path: </span><span style="color:#808080;">/</span>mongodb<span style="color:#808080;">/</span><span style="color:#800000;font-weight:bold;">28018</span><span style="color:#808080;">/</span><span style="color:#ff00ff;">log</span><span style="color:#808080;">/</span><span style="color:#000000;">mongodb.conf
  logAppend: true
storage:
  journal:
    enabled: true
  dbPath: </span><span style="color:#808080;">/</span>mongodb<span style="color:#808080;">/</span><span style="color:#800000;font-weight:bold;">28018</span><span style="color:#808080;">/</span><span style="color:#000000;">data
  directoryPerDB: true
  #engine: wiredTiger
  wiredTiger:
    engineConfig:
      cacheSizeGB: </span><span style="color:#800000;font-weight:bold;">1</span><span style="color:#000000;">
      directoryForIndexes: true
    collectionConfig:
      blockCompressor: zlib
    indexConfig:
      prefixCompression: true
net:
  bindIp: </span><span style="color:#800000;font-weight:bold;">10.0</span>.<span style="color:#800000;font-weight:bold;">0.152</span><span style="color:#000000;">
  port: </span><span style="color:#800000;font-weight:bold;">28018</span>
<span style="color:#0000ff;">replication</span><span style="color:#000000;">:
  oplogSizeMB: </span><span style="color:#800000;font-weight:bold;">2048</span><span style="color:#000000;">
  replSetName: configReplSet
sharding:
  clusterRole: configsvr
processManagement: 
  fork: true
EOF</span></pre> 
    </div> 
   </div> 
   <p>将配置文件分发到从节点</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#0000ff;">for</span>  i <span style="color:#808080;">in</span> <span style="color:#800000;font-weight:bold;">19</span> <span style="color:#800000;font-weight:bold;">20</span><span style="color:#000000;"> 
  do  
   \cp  </span><span style="color:#808080;">/</span>mongodb<span style="color:#808080;">/</span><span style="color:#800000;font-weight:bold;">28018</span><span style="color:#808080;">/</span>conf<span style="color:#808080;">/</span>mongod.conf  <span style="color:#808080;">/</span>mongodb<span style="color:#808080;">/</span><span style="color:#800000;font-weight:bold;">280</span>$i<span style="color:#808080;">/</span>conf<span style="color:#808080;">/</span><span style="color:#000000;">
done</span></pre> 
    </div> 
   </div> 
   <p>修改配置文件端口信息</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#0000ff;">for</span>  i <span style="color:#808080;">in</span> <span style="color:#800000;font-weight:bold;">19</span> <span style="color:#800000;font-weight:bold;">20</span><span style="color:#000000;">  
  do 
    sed  </span><span style="color:#808080;">-</span>i  "s#<span style="color:#800000;font-weight:bold;">28018</span>#<span style="color:#800000;font-weight:bold;">280</span>$i#g" <span style="color:#808080;">/</span>mongodb<span style="color:#808080;">/</span><span style="color:#800000;font-weight:bold;">280</span>$i<span style="color:#808080;">/</span>conf<span style="color:#808080;">/</span><span style="color:#000000;">mongod.conf
done</span></pre> 
    </div> 
   </div> 
   <p>启动config server集群</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#0000ff;">for</span>  i <span style="color:#808080;">in</span>  <span style="color:#800000;font-weight:bold;">18</span> <span style="color:#800000;font-weight:bold;">19</span> <span style="color:#800000;font-weight:bold;">20</span><span style="color:#000000;"> 
  do  
    mongod </span><span style="color:#808080;">-</span>f <span style="color:#808080;">/</span>mongodb<span style="color:#808080;">/</span><span style="color:#800000;font-weight:bold;">280</span>$i<span style="color:#808080;">/</span>conf<span style="color:#808080;">/</span><span style="color:#000000;">mongod.conf 
done</span></pre> 
    </div> 
   </div> 
   <p>配置config server复制集</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>mongo <span style="color:#008080;">--</span><span style="color:#008080;">host 10.0.0.152 --port 28018  admin</span></pre> 
    </div> 
    <p># 配置复制集信息</p> 
    <div class="cnblogs_code"> 
     <pre>config <span style="color:#808080;">=</span> {_id: <span style="color:#ff0000;">'</span><span style="color:#ff0000;">configReplSet</span><span style="color:#ff0000;">'</span>, members: <span style="color:#ff0000;">[</span><span style="color:#ff0000;">
                          {_id: 0, host: '10.0.0.152:28018'},
                          {_id: 1, host: '10.0.0.152:28019'},
                          {_id: 2, host: '10.0.0.152:28020'}</span><span style="color:#ff0000;">]</span><span style="color:#000000;">
           }
# 初始化配置
rs.initiate(config)    </span></pre> 
    </div> 
    <p>　　注：config server 使用复制集不用有arbiter节点。3.4版本以后config必须为复制集</p> 
   </div> 
   <h3>2.4.4 mongos节点配置</h3> 
   <p>修改配置文件</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>cat <span style="color:#808080;">&gt;</span> <span style="color:#808080;">/</span>mongodb<span style="color:#808080;">/</span><span style="color:#800000;font-weight:bold;">28017</span><span style="color:#808080;">/</span>conf<span style="color:#808080;">/</span>mongos.conf <span style="color:#808080;">&lt;&lt;</span><span style="color:#ff0000;">'</span><span style="color:#ff0000;">EOF</span><span style="color:#ff0000;">'</span><span style="color:#000000;">
systemLog:
  destination: </span><span style="color:#0000ff;">file</span><span style="color:#000000;">
  path: </span><span style="color:#808080;">/</span>mongodb<span style="color:#808080;">/</span><span style="color:#800000;font-weight:bold;">28017</span><span style="color:#808080;">/</span><span style="color:#ff00ff;">log</span><span style="color:#808080;">/</span>mongos.<span style="color:#ff00ff;">log</span><span style="color:#000000;">
  logAppend: true
net:
  bindIp: </span><span style="color:#800000;font-weight:bold;">10.0</span>.<span style="color:#800000;font-weight:bold;">0.152</span><span style="color:#000000;">
  port: </span><span style="color:#800000;font-weight:bold;">28017</span><span style="color:#000000;">
sharding:
  configDB: configReplSet</span><span style="color:#808080;">/</span><span style="color:#800000;font-weight:bold;">10.0</span>.<span style="color:#800000;font-weight:bold;">0.152</span>:<span style="color:#800000;font-weight:bold;">28108</span>,<span style="color:#800000;font-weight:bold;">10.0</span>.<span style="color:#800000;font-weight:bold;">0.152</span>:<span style="color:#800000;font-weight:bold;">28019</span>,<span style="color:#800000;font-weight:bold;">10.0</span>.<span style="color:#800000;font-weight:bold;">0.152</span>:<span style="color:#800000;font-weight:bold;">28020</span><span style="color:#000000;">
processManagement: 
  fork: true
EOF</span></pre> 
    </div> 
   </div> 
   <p>启动mongos</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>mongos <span style="color:#808080;">-</span>f <span style="color:#808080;">/</span>mongodb<span style="color:#808080;">/</span><span style="color:#800000;font-weight:bold;">28017</span><span style="color:#808080;">/</span>conf<span style="color:#808080;">/</span>mongos.conf</pre> 
    </div> 
   </div> 
   <p>登陆到mongos</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>mongo <span style="color:#800000;font-weight:bold;">10.0</span>.<span style="color:#800000;font-weight:bold;">0.152</span>:<span style="color:#800000;font-weight:bold;">28017</span><span style="color:#808080;">/</span>admin</pre> 
    </div> 
   </div> 
   <p>添加分片节点</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>db.runCommand( { addshard : "sh1<span style="color:#808080;">/</span><span style="color:#800000;font-weight:bold;">10.0</span>.<span style="color:#800000;font-weight:bold;">0.152</span>:<span style="color:#800000;font-weight:bold;">28021</span>,<span style="color:#800000;font-weight:bold;">10.0</span>.<span style="color:#800000;font-weight:bold;">0.152</span>:<span style="color:#800000;font-weight:bold;">28022</span>,<span style="color:#800000;font-weight:bold;">10.0</span>.<span style="color:#800000;font-weight:bold;">0.152</span>:<span style="color:#800000;font-weight:bold;">28023</span><span style="color:#000000;">",name:"shard1"} )
db.runCommand( { addshard : "sh2</span><span style="color:#808080;">/</span><span style="color:#800000;font-weight:bold;">10.0</span>.<span style="color:#800000;font-weight:bold;">0.152</span>:<span style="color:#800000;font-weight:bold;">28024</span>,<span style="color:#800000;font-weight:bold;">10.0</span>.<span style="color:#800000;font-weight:bold;">0.152</span>:<span style="color:#800000;font-weight:bold;">28025</span>,<span style="color:#800000;font-weight:bold;">10.0</span>.<span style="color:#800000;font-weight:bold;">0.152</span>:<span style="color:#800000;font-weight:bold;">28026</span>",name:"shard2"} )</pre> 
    </div> 
   </div> 
   <p>列出分片</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>mongos<span style="color:#808080;">&gt;</span> db.runCommand( { listshards : <span style="color:#800000;font-weight:bold;">1</span><span style="color:#000000;"> } )
{
    "shards" : </span><span style="color:#ff0000;">[</span><span style="color:#ff0000;">
        {
            "_id" : "shard2",
            "host" : "sh2/10.0.0.152:28024,10.0.0.152:28025"
        },
        {
            "_id" : "shard1",
            "host" : "sh1/10.0.0.152:28021,10.0.0.152:28022"
        }
    </span><span style="color:#ff0000;">]</span><span style="color:#000000;">,
    "ok" : </span><span style="color:#800000;font-weight:bold;">1</span><span style="color:#000000;">
}</span></pre> 
    </div> 
   </div> 
   <p>整体状态查看</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>mongos<span style="color:#808080;">&gt;</span> sh.status();</pre> 
    </div> 
   </div> 
   <p>&nbsp;&nbsp;<span style="color:#ff0000;"> <strong>至此MongoDB</strong><strong>的分片集群就搭建完成。</strong></span></p> 
   <h3>2.4.5 数据库分片配置</h3> 
   <p>激活数据库分片功能</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#000000;">语法：( { enablesharding : "数据库名称" } )

mongos</span><span style="color:#808080;">&gt;</span> db.runCommand( { enablesharding : "test" } )</pre> 
    </div> 
   </div> 
   <p>指定分片建对集合分片，范围片键--创建索引</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>mongos<span style="color:#808080;">&gt;</span> <span style="color:#0000ff;">use</span><span style="color:#000000;"> test 
mongos</span><span style="color:#808080;">&gt;</span> db.vast.ensureIndex( { id: <span style="color:#800000;font-weight:bold;">1</span><span style="color:#000000;"> } )
mongos</span><span style="color:#808080;">&gt;</span> <span style="color:#0000ff;">use</span><span style="color:#000000;"> admin
mongos</span><span style="color:#808080;">&gt;</span> db.runCommand( { shardcollection : "test.vast",<span style="color:#0000ff;">key</span> : {id: <span style="color:#800000;font-weight:bold;">1</span>} } )</pre> 
    </div> 
   </div> 
   <p>集合分片验证</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>mongos<span style="color:#808080;">&gt;</span> <span style="color:#0000ff;">use</span><span style="color:#000000;"> test
mongos</span><span style="color:#808080;">&gt;</span> <span style="color:#0000ff;">for</span>(i<span style="color:#808080;">=</span><span style="color:#800000;font-weight:bold;">0</span>;i<span style="color:#808080;">&lt;</span><span style="color:#800000;font-weight:bold;">20000</span>;i<span style="color:#808080;">++</span>){ db.vast1.<span style="color:#0000ff;">insert</span>({"id":i,"name":"clsn","age":<span style="color:#800000;font-weight:bold;">70</span><span style="color:#000000;">,"date":new Date()}); }
mongos</span><span style="color:#808080;">&gt;</span> db.vast.stats()</pre> 
    </div> 
    <p>　　&nbsp; 插入数据的条数尽量大些，能够看出更好的效果。</p> 
   </div> 
   <h2>2.5 分片集群的操作</h2> 
   <h3>2.5.1 不同分片键的配置</h3> 
   <p><strong>范围片键</strong></p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>admin<span style="color:#808080;">&gt;</span> sh.shardCollection("数据库名称.集合名称",<span style="color:#0000ff;">key</span> : {分片键: <span style="color:#800000;font-weight:bold;">1</span><span style="color:#000000;">}  )
或
admin</span><span style="color:#808080;">&gt;</span> db.runCommand( { shardcollection : "数据库名称.集合名称",<span style="color:#0000ff;">key</span> : {分片键: <span style="color:#800000;font-weight:bold;">1</span>} } )</pre> 
    </div> 
   </div> 
   <div> 
    <p>eg：</p> 
    <div class="cnblogs_code"> 
     <pre>admin <span style="color:#808080;">&gt;</span> sh.shardCollection("test.vast",<span style="color:#0000ff;">key</span> : {id: <span style="color:#800000;font-weight:bold;">1</span><span style="color:#000000;">}  )
或
admin</span><span style="color:#808080;">&gt;</span> db.runCommand( { shardcollection : "test.vast",<span style="color:#0000ff;">key</span> : {id: <span style="color:#800000;font-weight:bold;">1</span>} } )</pre> 
    </div> 
   </div> 
   <p><strong>哈希片键</strong></p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>admin <span style="color:#808080;">&gt;</span> sh.shardCollection( "数据库名.集合名", { 片键: "hashed" } )</pre> 
    </div> 
   </div> 
   <p><strong>创建哈希索引</strong></p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>admin<span style="color:#808080;">&gt;</span><span style="color:#000000;"> db.vast.ensureIndex( { a: "hashed" } )
admin </span><span style="color:#808080;">&gt;</span> sh.shardCollection( "test.vast", { a: "hashed" } )</pre> 
    </div> 
   </div> 
   <h3>2.5.2 分片集群的操作</h3> 
   <p>判断是否Shard集群</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>admin<span style="color:#808080;">&gt;</span> db.runCommand({ isdbgrid : <span style="color:#800000;font-weight:bold;">1</span>})</pre> 
    </div> 
   </div> 
   <p>列出所有分片信息</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>admin<span style="color:#808080;">&gt;</span> db.runCommand({ listshards : <span style="color:#800000;font-weight:bold;">1</span>})</pre> 
    </div> 
   </div> 
   <p>列出开启分片的数据库</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>admin<span style="color:#808080;">&gt;</span> <span style="color:#0000ff;">use</span><span style="color:#000000;"> config
config</span><span style="color:#808080;">&gt;</span><span style="color:#000000;"> db.databases.find( { "partitioned": true } )
config</span><span style="color:#808080;">&gt;</span> db.databases.find() <span style="color:#808080;">//</span>列出所有数据库分片情况</pre> 
    </div> 
   </div> 
   <p>查看分片的片键</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>config<span style="color:#808080;">&gt;</span><span style="color:#000000;"> db.collections.find()
{
    "_id" : "test.vast",
    "lastmodEpoch" : ObjectId("58a599f19c898bbfb818b63c"),
    "lastmod" : ISODate("</span><span style="color:#800000;font-weight:bold;">1970</span><span style="color:#808080;">-</span><span style="color:#800000;font-weight:bold;">02</span><span style="color:#808080;">-</span>19T17:<span style="color:#800000;font-weight:bold;">02</span>:<span style="color:#800000;font-weight:bold;">47</span><span style="color:#000000;">.296Z"),
    "dropped" : false,
    "</span><span style="color:#0000ff;">key</span><span style="color:#000000;">" : {
        "id" : </span><span style="color:#800000;font-weight:bold;">1</span><span style="color:#000000;">
    },
    "</span><span style="color:#0000ff;">unique</span><span style="color:#000000;">" : false
}</span></pre> 
    </div> 
   </div> 
   <p>查看分片的详细信息</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>admin<span style="color:#808080;">&gt;</span><span style="color:#000000;"> db.printShardingStatus()
或
admin</span><span style="color:#808080;">&gt;</span> sh.status()</pre> 
    </div> 
   </div> 
   <p>删除分片节点</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#000000;">sh.getBalancerState()
mongos</span><span style="color:#808080;">&gt;</span> db.runCommand( { removeShard: "shard2" } )</pre> 
    </div> 
   </div> 
   <h2>2.6 balance操作</h2> 
   <p>　　查看mongo集群是否开启了 balance 状态</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>mongos<span style="color:#808080;">&gt;</span><span style="color:#000000;"> sh.getBalancerState()
true</span></pre> 
    </div> 
    <p>　　当然你也可以通过在路由节点mongos上执行sh.status() 查看balance状态。</p> 
   </div> 
   <p>　　如果balance开启，查看是否正在有数据的迁移</p> 
   <p>连接mongo集群的路由节点</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>mongos<span style="color:#808080;">&gt;</span><span style="color:#000000;"> sh.isBalancerRunning()
false</span></pre> 
    </div> 
   </div> 
   <h3>2.6.1 设置balance 窗口</h3> 
   <p>（1）连接mongo集群的路由节点</p> 
   <p>（2）切换到配置节点</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>     <span style="color:#0000ff;">use</span> config</pre> 
    </div> 
   </div> 
   <p>（3）确定balance 开启中</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>     sh.getBalancerState()</pre> 
    </div> 
   </div> 
   <p>&nbsp;&nbsp; 如果未开启，执行命令</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>   sh.setBalancerState( true )</pre> 
    </div> 
   </div> 
   <p>（4）修改balance 窗口的时间</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>db.settings.<span style="color:#0000ff;">update</span><span style="color:#000000;">(
   { _id: "balancer" },
   { $</span><span style="color:#0000ff;">set</span>: { activeWindow : { start : "<span style="color:#808080;">&lt;</span>start<span style="color:#808080;">-</span>time<span style="color:#808080;">&gt;</span>", stop : "<span style="color:#808080;">&lt;</span>stop<span style="color:#808080;">-</span>time<span style="color:#808080;">&gt;</span><span style="color:#000000;">" } } },
   { upsert: true }
)</span></pre> 
    </div> 
   </div> 
   <p>eg：</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>db.settings.<span style="color:#0000ff;">update</span>({ _id : "balancer" }, { $<span style="color:#0000ff;">set</span> : { activeWindow : { start : "<span style="color:#800000;font-weight:bold;">00</span>:<span style="color:#800000;font-weight:bold;">00</span>", stop : "<span style="color:#800000;font-weight:bold;">5</span>:<span style="color:#800000;font-weight:bold;">00</span>" } } }, true )</pre> 
    </div> 
    <p>　　当你设置了activeWindow，就不能用sh.startBalancer() 启动balance</p> 
   </div> 
   <div> 
    <blockquote> 
     <p><span style="color:#ff0000;">NOTE</span></p> 
     <p>The balancer window must be sufficient to complete the migration of all data inserted during the day.</p> 
     <p>As data insert rates can change based on activity and usage patterns, it is important to ensure that the balancing window you select will be sufficient to support the needs of your deployment.</p> 
    </blockquote> 
   </div> 
   <p>（5）删除balance 窗口</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#0000ff;">use</span><span style="color:#000000;"> config
db.settings.</span><span style="color:#0000ff;">update</span>({ _id : "balancer" }, { $unset : { activeWindow : true } })</pre> 
    </div> 
   </div> 
   <h3>2.6.2 关闭balance</h3> 
   <p>　　默认balance 的运行可以在任何时间，只迁移需要迁移的chunk，如果要关闭balance运行，停止一段时间可以用下列方法：</p> 
   <p>（1） 连接到路由mongos节点</p> 
   <p>（2） 停止balance</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>      sh.stopBalancer()</pre> 
    </div> 
   </div> 
   <p>（3） 查看balance状态</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>  sh.getBalancerState()</pre> 
    </div> 
   </div> 
   <p>（4）停止balance 后，没有迁移进程正在迁移，可以执行下列命令</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#0000ff;">use</span><span style="color:#000000;"> config
</span><span style="color:#0000ff;">while</span><span style="color:#000000;">( sh.isBalancerRunning() ) {
          </span><span style="color:#0000ff;">print</span><span style="color:#000000;">("waiting...");
          sleep(</span><span style="color:#800000;font-weight:bold;">1000</span><span style="color:#000000;">);
}</span></pre> 
    </div> 
   </div> 
   <h3>2.6.3 重新打开balance</h3> 
   <p>如果你关闭了balance，准备重新打开balance</p> 
   <p>（1） 连接到路由mongos节点</p> 
   <p>（2） 打开balance</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>        sh.setBalancerState(true)</pre> 
    </div> 
   </div> 
   <p>如果驱动没有命令&nbsp; sh.startBalancer()，可以用下列命令</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#0000ff;">use</span><span style="color:#000000;"> config
db.settings.</span><span style="color:#0000ff;">update</span>( { _id: "balancer" }, { $<span style="color:#0000ff;">set</span> : { stopped: false } } , { upsert: true } )</pre> 
    </div> 
   </div> 
   <h3>2.6.4 关于集合的balance</h3> 
   <p>关闭某个集合的balance</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>sh.disableBalancing("students.grades")</pre> 
    </div> 
   </div> 
   <p>打开某个集合的balance</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>sh.enableBalancing("students.grades")</pre> 
    </div> 
   </div> 
   <p>确定某个集合的balance是开启或者关闭</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre>db.getSiblingDB("config").collections.findOne({_id : "students.grades"}).noBalance;</pre> 
    </div> 
   </div> 
   <h3>2.6.5 问题解决</h3> 
   <p>mongodb在做自动分片平衡的时候，或引起数据库响应的缓慢，可以通过禁用自动平衡以及设置自动平衡进行的时间来解决这一问题。</p> 
   <p>（1）禁用分片的自动平衡</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#808080;">//</span> connect <span style="color:#0000ff;">to</span><span style="color:#000000;"> mongos
</span><span style="color:#808080;">&gt;</span> <span style="color:#0000ff;">use</span><span style="color:#000000;"> config
</span><span style="color:#808080;">&gt;</span> db.settings.<span style="color:#0000ff;">update</span>( { _id: "balancer" }, { $<span style="color:#0000ff;">set</span> : { stopped: true } } , true );</pre> 
    </div> 
   </div> 
   <p>（2）自定义 自动平衡进行的时间段</p> 
   <div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#808080;">//</span> connect <span style="color:#0000ff;">to</span><span style="color:#000000;"> mongos
</span><span style="color:#808080;">&gt;</span> <span style="color:#0000ff;">use</span><span style="color:#000000;"> config
</span><span style="color:#808080;">&gt;</span> db.settings.<span style="color:#0000ff;">update</span>({ _id : "balancer" }, { $<span style="color:#0000ff;">set</span> : { activeWindow : { start : "<span style="color:#800000;font-weight:bold;">21</span>:<span style="color:#800000;font-weight:bold;">00</span>", stop : "<span style="color:#800000;font-weight:bold;">9</span>:<span style="color:#800000;font-weight:bold;">00</span>" } } }, true )</pre> 
    </div> 
   </div> 
   <h2>2.7 参考文献</h2> 
   <div> 
    <blockquote> 
     <p>[1]&nbsp;&nbsp;<a href="https://www.jianshu.com/p/ddcc3643aec9" rel="nofollow">https://www.jianshu.com/p/ddcc3643aec9</a></p> 
     <p>[2]&nbsp;&nbsp;<a href="https://docs.mongodb.com/manual/replication/" rel="nofollow">https://docs.mongodb.com/manual/replication/</a></p> 
     <p>[3]&nbsp;&nbsp;<a href="https://docs.mongodb.com/manual/core/replica-set-architecture-three-members/" rel="nofollow">https://docs.mongodb.com/manual/core/replica-set-architecture-three-members/</a></p> 
     <p>[4]&nbsp;&nbsp;<a href="http://www.mongoing.com/archives/2155" rel="nofollow">http://www.mongoing.com/archives/2155</a></p> 
     <p>[5]&nbsp;&nbsp;<a href="https://docs.mongodb.com/manual/sharding/" rel="nofollow">https://docs.mongodb.com/manual/sharding/</a></p> 
     <p>[6]&nbsp;&nbsp;<a href="http://www.ywnds.com/?p=3476" rel="nofollow">http://www.ywnds.com/?p=3476</a></p> 
     <p>[7]&nbsp;&nbsp;<a href="https://yq.aliyun.com/articles/32434" rel="nofollow">https://yq.aliyun.com/articles/32434</a></p> 
    </blockquote> 
   </div> 
   <p>&nbsp;</p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
