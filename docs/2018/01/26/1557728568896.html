<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>面向对象高级编程：使用元类 « NotBeCN</title>
  <meta name="description" content="             type()    动态语言和静态语言最大的不同，就是函数和类的定义，不是编译时定义的，而是运行时动态创建的。    比方说我们要定义一个Hello的class，就写一个hello.py模块：    class Hello(object):    def hello(self, name...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2018/01/26/1557728568896.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">面向对象高级编程：使用元类</h1>
    <p class="post-meta">Jan 26, 2018</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <h3 style="font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68,68,68);font-size:18px;line-height:24px;">type()</h3> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">动态语言和静态语言最大的不同，就是函数和类的定义，不是编译时定义的，而是运行时动态创建的。</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">比方说我们要定义一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">Hello</code>的class，就写一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">hello.py</code>模块：</p> 
   <pre><code class="python"><span class="class" style="color:rgb(68,85,136);font-weight:bold;"><span class="keyword" style="color:rgb(51,51,51);">class</span> <span class="title">Hello</span><span class="params">(object)</span>:</span>
    <span class="function"><span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">def</span> <span class="title" style="color:rgb(153,0,0);font-weight:bold;">hello</span><span class="params">(self, name=<span class="string" style="color:rgb(221,17,68);">'world'</span>)</span>:</span>
        print(<span class="string" style="color:rgb(221,17,68);">'Hello, %s.'</span> % name)
</code></pre> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">当Python解释器载入<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">hello</code>模块时，就会依次执行该模块的所有语句，执行结果就是动态创建出一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">Hello</code>的class对象，测试如下：</p> 
   <pre><code class="java">&gt;&gt;&gt; from hello <span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">import</span> Hello
&gt;&gt;&gt; h = Hello()
&gt;&gt;&gt; h.hello()
Hello, world.
&gt;&gt;&gt; print(type(Hello))
&lt;<span class="class" style="color:rgb(68,85,136);font-weight:bold;"><span class="keyword" style="color:rgb(51,51,51);">class</span> '<span class="title">type</span>'&gt; &gt;&gt;&gt; <span class="title">print</span>(<span class="title">type</span>(<span class="title">h</span>)) &lt;<span class="title">class</span> '<span class="title">hello</span>.<span class="title">Hello</span>'&gt; </span></code></pre> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;"><code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">type()</code>函数可以查看一个类型或变量的类型，<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">Hello</code>是一个class，它的类型就是<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">type</code>，而<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">h</code>是一个实例，它的类型就是class <code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">Hello</code>。</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">我们说class的定义是运行时动态创建的，而创建class的方法就是使用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">type()</code>函数。</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;"><code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">type()</code>函数既可以返回一个对象的类型，又可以创建出新的类型，比如，我们可以通过<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">type()</code>函数创建出<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">Hello</code>类，而无需通过<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">class Hello(object)...</code>的定义：</p> 
   <pre><code class="java">&gt;&gt;&gt; def fn(self, name=<span class="string" style="color:rgb(221,17,68);">'world'</span>): # 先定义函数
...     print(<span class="string" style="color:rgb(221,17,68);">'Hello, %s.'</span> % name)
...
&gt;&gt;&gt; Hello = type(<span class="string" style="color:rgb(221,17,68);">'Hello'</span>, (object,), dict(hello=fn)) # 创建Hello <span class="class" style="color:rgb(68,85,136);font-weight:bold;"><span class="keyword" style="color:rgb(51,51,51);">class</span> &gt;&gt;&gt; <span class="title">h</span> = <span class="title">Hello</span>() &gt;&gt;&gt; <span class="title">h</span>.<span class="title">hello</span>() <span class="title">Hello</span>, <span class="title">world</span>. &gt;&gt;&gt; <span class="title">print</span>(<span class="title">type</span>(<span class="title">Hello</span>)) &lt;<span class="title">class</span> '<span class="title">type</span>'&gt; &gt;&gt;&gt; <span class="title">print</span>(<span class="title">type</span>(<span class="title">h</span>)) &lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">Hello</span>'&gt; </span></code></pre> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">要创建一个class对象，<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">type()</code>函数依次传入3个参数：</p> 
   <ol style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">
    <li>class的名称；</li> 
    <li>继承的父类集合，注意Python支持多重继承，如果只有一个父类，别忘了tuple的单元素写法；</li> 
    <li>class的方法名称与函数绑定，这里我们把函数<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">fn</code>绑定到方法名<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">hello</code>上。</li> 
   </ol>
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">通过<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">type()</code>函数创建的类和直接写class是完全一样的，因为Python解释器遇到class定义时，仅仅是扫描一下class定义的语法，然后调用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">type()</code>函数创建出class。</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">正常情况下，我们都用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">class Xxx...</code>来定义类，但是，<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">type()</code>函数也允许我们动态创建出类来，也就是说，动态语言本身支持运行期动态创建类，这和静态语言有非常大的不同，要在静态语言运行期创建类，必须构造源代码字符串再调用编译器，或者借助一些工具生成字节码实现，本质上都是动态编译，会非常复杂。</p> 
   <h3 style="font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68,68,68);font-size:18px;line-height:24px;"> <a name="#metaclass" style="color:rgb(5,147,211);background:transparent;"></a>metaclass</h3> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">除了使用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">type()</code>动态创建类以外，要控制类的创建行为，还可以使用metaclass。</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">metaclass，直译为元类，简单的解释就是：</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">当我们定义了类以后，就可以根据这个类创建出实例，所以：先定义类，然后创建实例。</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">但是如果我们想创建出类呢？那就必须根据metaclass创建出类，所以：先定义metaclass，然后创建类。</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">连接起来就是：先定义metaclass，就可以创建类，最后创建实例。</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">所以，metaclass允许你创建类或者修改类。换句话说，你可以把类看成是metaclass创建出来的“实例”。</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">metaclass是Python面向对象里最难理解，也是最难使用的魔术代码。正常情况下，你不会碰到需要使用metaclass的情况，所以，以下内容看不懂也没关系，因为基本上你不会用到。</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">我们先看一个简单的例子，这个metaclass可以给我们自定义的MyList增加一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">add</code>方法：</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">定义<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">ListMetaclass</code>，按照默认习惯，metaclass的类名总是以Metaclass结尾，以便清楚地表示这是一个metaclass：</p> 
   <pre><code class="python"><span class="comment" style="color:rgb(153,153,136);font-style:italic;"># metaclass是类的模板，所以必须从`type`类型派生：</span>
<span class="class" style="color:rgb(68,85,136);font-weight:bold;"><span class="keyword" style="color:rgb(51,51,51);">class</span> <span class="title">ListMetaclass</span><span class="params">(type)</span>:</span>
    <span class="function"><span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">def</span> <span class="title" style="color:rgb(153,0,0);font-weight:bold;">__new__</span><span class="params">(cls, name, bases, attrs)</span>:</span>
        attrs[<span class="string" style="color:rgb(221,17,68);">'add'</span>] = <span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">lambda</span> self, value: self.append(value)
        <span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">return</span> type.__new__(cls, name, bases, attrs)
</code></pre> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">有了ListMetaclass，我们在定义类的时候还要指示使用ListMetaclass来定制类，传入关键字参数<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">metaclass</code>：</p> 
   <pre><code class="python"><span class="class" style="color:rgb(68,85,136);font-weight:bold;"><span class="keyword" style="color:rgb(51,51,51);">class</span> <span class="title">MyList</span><span class="params">(list, metaclass=ListMetaclass)</span>:</span>
    <span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">pass</span>
</code></pre> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">当我们传入关键字参数<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">metaclass</code>时，魔术就生效了，它指示Python解释器在创建<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">MyList</code>时，要通过<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">ListMetaclass.__new__()</code>来创建，在此，我们可以修改类的定义，比如，加上新的方法，然后，返回修改后的定义。</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;"><code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">__new__()</code>方法接收到的参数依次是：</p> 
   <ol style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">
    <li> <p>当前准备创建的类的对象；</p> </li> 
    <li> <p>类的名字；</p> </li> 
    <li> <p>类继承的父类集合；</p> </li> 
    <li> <p>类的方法集合。</p> </li> 
   </ol>
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">测试一下<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">MyList</code>是否可以调用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">add()</code>方法：</p> 
   <pre><code class="python"><span class="prompt" style="color:rgb(153,0,115);">&gt;&gt;&gt; </span>L = MyList()
<span class="prompt" style="color:rgb(153,0,115);">&gt;&gt;&gt; </span>L.add(<span class="number" style="color:rgb(0,153,153);">1</span>)
&gt;&gt; L
[<span class="number" style="color:rgb(0,153,153);">1</span>]
</code></pre> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">而普通的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">list</code>没有<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">add()</code>方法：</p> 
   <pre><code class="xml">&gt;&gt;&gt; L2 = list()
&gt;&gt;&gt; L2.add(1)
Traceback (most recent call last):
  File "<span class="tag" style="color:rgb(0,0,128);">&lt;<span class="title">stdin</span>&gt;</span>", line 1, in <span class="tag" style="color:rgb(0,0,128);">&lt;<span class="title">module</span>&gt;</span>
AttributeError: 'list' object has no attribute 'add'
</code></pre> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">动态修改有什么意义？直接在<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">MyList</code>定义中写上<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">add()</code>方法不是更简单吗？正常情况下，确实应该直接写，通过metaclass修改纯属变态。</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">但是，总会遇到需要通过metaclass修改类定义的。ORM就是一个典型的例子。</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">ORM全称“Object Relational Mapping”，即对象-关系映射，就是把关系数据库的一行映射为一个对象，也就是一个类对应一个表，这样，写代码更简单，不用直接操作SQL语句。</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">要编写一个ORM框架，所有的类都只能动态定义，因为只有使用者才能根据表的结构定义出对应的类来。</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">让我们来尝试编写一个ORM框架。</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">编写底层模块的第一步，就是先把调用接口写出来。比如，使用者如果使用这个ORM框架，想定义一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">User</code>类来操作对应的数据库表<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">User</code>，我们期待他写出这样的代码：</p> 
   <pre><code class="python"><span class="class" style="color:rgb(68,85,136);font-weight:bold;"><span class="keyword" style="color:rgb(51,51,51);">class</span> <span class="title">User</span><span class="params">(Model)</span>:</span>
    <span class="comment" style="color:rgb(153,153,136);font-style:italic;"># 定义类的属性到列的映射：</span>
    id = IntegerField(<span class="string" style="color:rgb(221,17,68);">'id'</span>)
    name = StringField(<span class="string" style="color:rgb(221,17,68);">'username'</span>)
    email = StringField(<span class="string" style="color:rgb(221,17,68);">'email'</span>)
    password = StringField(<span class="string" style="color:rgb(221,17,68);">'password'</span>)

<span class="comment" style="color:rgb(153,153,136);font-style:italic;"># 创建一个实例：</span>
u = User(id=<span class="number" style="color:rgb(0,153,153);">12345</span>, name=<span class="string" style="color:rgb(221,17,68);">'Michael'</span>, email=<span class="string" style="color:rgb(221,17,68);">'test@orm.org'</span>, password=<span class="string" style="color:rgb(221,17,68);">'my-pwd'</span>)
<span class="comment" style="color:rgb(153,153,136);font-style:italic;"># 保存到数据库：</span>
u.save()
</code></pre> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">其中，父类<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">Model</code>和属性类型<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">StringField</code>、<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">IntegerField</code>是由ORM框架提供的，剩下的魔术方法比如<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">save()</code>全部由metaclass自动完成。虽然metaclass的编写会比较复杂，但ORM的使用者用起来却异常简单。</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">现在，我们就按上面的接口来实现该ORM。</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">首先来定义<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">Field</code>类，它负责保存数据库表的字段名和字段类型：</p> 
   <pre><code class="python"><span class="class" style="color:rgb(68,85,136);font-weight:bold;"><span class="keyword" style="color:rgb(51,51,51);">class</span> <span class="title">Field</span><span class="params">(object)</span>:</span>

    <span class="function"><span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">def</span> <span class="title" style="color:rgb(153,0,0);font-weight:bold;">__init__</span><span class="params">(self, name, column_type)</span>:</span>
        self.name = name
        self.column_type = column_type

    <span class="function"><span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">def</span> <span class="title" style="color:rgb(153,0,0);font-weight:bold;">__str__</span><span class="params">(self)</span>:</span>
        <span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">return</span> <span class="string" style="color:rgb(221,17,68);">'&lt;%s:%s&gt;'</span> % (self.__class__.__name__, self.name)
</code></pre> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">在<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">Field</code>的基础上，进一步定义各种类型的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">Field</code>，比如<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">StringField</code>，<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">IntegerField</code>等等：</p> 
   <pre><code class="python"><span class="class" style="color:rgb(68,85,136);font-weight:bold;"><span class="keyword" style="color:rgb(51,51,51);">class</span> <span class="title">StringField</span><span class="params">(Field)</span>:</span>

    <span class="function"><span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">def</span> <span class="title" style="color:rgb(153,0,0);font-weight:bold;">__init__</span><span class="params">(self, name)</span>:</span>
        super(StringField, self).__init__(name, <span class="string" style="color:rgb(221,17,68);">'varchar(100)'</span>)

<span class="class" style="color:rgb(68,85,136);font-weight:bold;"><span class="keyword" style="color:rgb(51,51,51);">class</span> <span class="title">IntegerField</span><span class="params">(Field)</span>:</span>

    <span class="function"><span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">def</span> <span class="title" style="color:rgb(153,0,0);font-weight:bold;">__init__</span><span class="params">(self, name)</span>:</span>
        super(IntegerField, self).__init__(name, <span class="string" style="color:rgb(221,17,68);">'bigint'</span>)
</code></pre> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">下一步，就是编写最复杂的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">ModelMetaclass</code>了：</p> 
   <pre><code class="python"><span class="class" style="color:rgb(68,85,136);font-weight:bold;"><span class="keyword" style="color:rgb(51,51,51);">class</span> <span class="title">ModelMetaclass</span><span class="params">(type)</span>:</span>

    <span class="function"><span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">def</span> <span class="title" style="color:rgb(153,0,0);font-weight:bold;">__new__</span><span class="params">(cls, name, bases, attrs)</span>:</span>
        <span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">if</span> name==<span class="string" style="color:rgb(221,17,68);">'Model'</span>:
            <span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">return</span> type.__new__(cls, name, bases, attrs)
        print(<span class="string" style="color:rgb(221,17,68);">'Found model: %s'</span> % name)
        mappings = dict()
        <span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">for</span> k, v <span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">in</span> attrs.items():
            <span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">if</span> isinstance(v, Field):
                print(<span class="string" style="color:rgb(221,17,68);">'Found mapping: %s ==&gt; %s'</span> % (k, v))
                mappings[k] = v
        <span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">for</span> k <span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">in</span> mappings.keys():
            attrs.pop(k)
        attrs[<span class="string" style="color:rgb(221,17,68);">'__mappings__'</span>] = mappings <span class="comment" style="color:rgb(153,153,136);font-style:italic;"># 保存属性和列的映射关系</span>
        attrs[<span class="string" style="color:rgb(221,17,68);">'__table__'</span>] = name <span class="comment" style="color:rgb(153,153,136);font-style:italic;"># 假设表名和类名一致</span>
        <span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">return</span> type.__new__(cls, name, bases, attrs)
</code></pre> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">以及基类<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">Model</code>：</p> 
   <pre><code class="python"><span class="class" style="color:rgb(68,85,136);font-weight:bold;"><span class="keyword" style="color:rgb(51,51,51);">class</span> <span class="title">Model</span><span class="params">(dict, metaclass=ModelMetaclass)</span>:</span>

    <span class="function"><span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">def</span> <span class="title" style="color:rgb(153,0,0);font-weight:bold;">__init__</span><span class="params">(self, **kw)</span>:</span>
        super(Model, self).__init__(**kw)

    <span class="function"><span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">def</span> <span class="title" style="color:rgb(153,0,0);font-weight:bold;">__getattr__</span><span class="params">(self, key)</span>:</span>
        <span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">try</span>:
            <span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">return</span> self[key]
        <span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">except</span> KeyError:
            <span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">raise</span> AttributeError(<span class="string" style="color:rgb(221,17,68);">r"'Model' object has no attribute '%s'"</span> % key)

    <span class="function"><span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">def</span> <span class="title" style="color:rgb(153,0,0);font-weight:bold;">__setattr__</span><span class="params">(self, key, value)</span>:</span>
        self[key] = value

    <span class="function"><span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">def</span> <span class="title" style="color:rgb(153,0,0);font-weight:bold;">save</span><span class="params">(self)</span>:</span>
        fields = []
        params = []
        args = []
        <span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">for</span> k, v <span class="keyword" style="color:rgb(51,51,51);font-weight:bold;">in</span> self.__mappings__.items():
            fields.append(v.name)
            params.append(<span class="string" style="color:rgb(221,17,68);">'?'</span>)
            args.append(getattr(self, k, <span class="built_in" style="color:rgb(0,134,179);">None</span>))
        sql = <span class="string" style="color:rgb(221,17,68);">'insert into %s (%s) values (%s)'</span> % (self.__table__, <span class="string" style="color:rgb(221,17,68);">','</span>.join(fields), <span class="string" style="color:rgb(221,17,68);">','</span>.join(params))
        print(<span class="string" style="color:rgb(221,17,68);">'SQL: %s'</span> % sql)
        print(<span class="string" style="color:rgb(221,17,68);">'ARGS: %s'</span> % str(args))
</code></pre> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">当用户定义一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">class User(Model)</code>时，Python解释器首先在当前类<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">User</code>的定义中查找<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">metaclass</code>，如果没有找到，就继续在父类<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">Model</code>中查找<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">metaclass</code>，找到了，就使用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">Model</code>中定义的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">metaclass</code>的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">ModelMetaclass</code>来创建<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">User</code>类，也就是说，metaclass可以隐式地继承到子类，但子类自己却感觉不到。</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">在<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">ModelMetaclass</code>中，一共做了几件事情：</p> 
   <ol style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">
    <li> <p>排除掉对<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">Model</code>类的修改；</p> </li> 
    <li> <p>在当前类（比如<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">User</code>）中查找定义的类的所有属性，如果找到一个Field属性，就把它保存到一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">__mappings__</code>的dict中，同时从类属性中删除该Field属性，否则，容易造成运行时错误（实例的属性会遮盖类的同名属性）；</p> </li> 
    <li> <p>把表名保存到<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">__table__</code>中，这里简化为表名默认为类名。</p> </li> 
   </ol>
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">在<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">Model</code>类中，就可以定义各种操作数据库的方法，比如<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">save()</code>，<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">delete()</code>，<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">find()</code>，<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">update</code>等等。</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">我们实现了<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">save()</code>方法，把一个实例保存到数据库中。因为有表名，属性到字段的映射和属性值的集合，就可以构造出<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">INSERT</code>语句。</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">编写代码试试：</p> 
   <pre><code class="undefined">u = User(id=12345, name='Michael', email='test@orm.org', password='my-pwd')
u.save()
</code></pre> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">输出如下：</p> 
   <pre><code class="javascript">Found model: User
Found mapping: email ==&gt; <span class="xml"><span class="tag" style="color:rgb(0,0,128);">&lt;<span class="title">StringField:email</span>&gt;</span> Found mapping: password ==&gt; <span class="tag" style="color:rgb(0,0,128);">&lt;<span class="title">StringField:password</span>&gt;</span> Found mapping: id ==&gt; <span class="tag" style="color:rgb(0,0,128);">&lt;<span class="title">IntegerField:uid</span>&gt;</span> Found mapping: name ==&gt; <span class="tag" style="color:rgb(0,0,128);">&lt;<span class="title">StringField:username</span>&gt;</span> SQL: insert into User (password,email,username,id) values (?,?,?,?) ARGS: ['my-pwd', 'test@orm.org', 'Michael', 12345] </span></code></pre> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">可以看到，<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221,0,85);border:1px solid rgb(221,221,221);background:rgb(250,250,250);">save()</code>方法已经打印出了可执行的SQL语句，以及参数列表，只需要真正连接到数据库，执行该SQL语句，就可以完成真正的功能。</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">不到100行代码，我们就通过metaclass实现了一个精简的ORM框架，是不是非常简单？</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;"><img src="https://cdn.liaoxuefeng.com/cdn/files/attachments/001510832347710ca6c27e2ab8b4885b52bd1914a80e366000/l" alt="真叫人头大" style="vertical-align:middle;border:0px;"></p> 
   <h3 style="font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68,68,68);font-size:18px;line-height:24px;"> <a name="#-E5-B0-8F-E7-BB-93" style="color:rgb(5,147,211);background:transparent;"></a>小结</h3> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">metaclass是Python中非常具有魔术性的对象，它可以改变类创建时的行为。这种强大的功能使用起来务必小心。</p> 
   <p style="color:rgb(102,102,102);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;">转载。原文：https://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/0014319106919344c4ef8b1e04c48778bb45796e0335839000</p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
