<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>linux下C语言实现的内存池【转】 « NotBeCN</title>
  <meta name="description" content="             转自：http://blog.chinaunix.net/uid-28458801-id-4254501.html    操作系统：ubuntu10.04前言： &nbsp; &nbsp; 在通信过程中，无法知道将会接收到的数据的长度，因此开一个固定大小的缓冲区并不合适，开大了，很可能大...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2018/01/11/weixin_34056162_90122122.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">linux下C语言实现的内存池【转】</h1>
    <p class="post-meta">Jan 11, 2018</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p>转自：<a href="http://blog.chinaunix.net/uid-28458801-id-4254501.html" rel="nofollow">http://blog.chinaunix.net/uid-28458801-id-4254501.html</a></p> 
   <p><strong><span style="color:#e53333;font-size:24px;">操作系统：ubuntu10.04</span></strong><br><br><strong><span style="color:#e53333;font-size:24px;">前言：</span></strong><br> &nbsp; &nbsp; 在通信过程中，无法知道将会接收到的数据的长度，因此开一个固定大小的缓冲区并不合适，开大了，很可能大多数通信都只是几十个自己而已；开小了，又无法处理大数据。因此最好的方法就是创建内存池，根据实际情况，分配合适大小的内存空间。<br><br><strong><span style="color:#e53333;font-size:24px;">一，思路</span></strong><br><img src="https://yqfile.alicdn.com/img_080e354bfd007bd9e375dac4f85eaeaa.jpg" alt="" width="394" height="348"><br><br> &nbsp; &nbsp; 通过双向链表，管理所有的内存池。<br><br><br><strong><span style="color:#e53333;font-size:24px;">二，实现</span></strong><br> &nbsp; &nbsp; 1，内存池的相关信息结构体</p> 
   <div> 
    <div class="codeheads"> 
     <p> 点击(<span style="color:#FF0000;">此处)折叠或打开 </span></p> 
    </div> 
    <div class="codeText">
     <ol>
      <li> <span style="color:#000000;">struct pool_head <span style="color:#0000cc;">{<br></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;void &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">*<span style="color:#0000cc;">*free_list<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;<br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;struct list_head &nbsp;&nbsp;&nbsp;&nbsp;list<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">* list of all known pools <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;used<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">* how many chunks are currently <span style="color:#0000ff;">in use <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allocated<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">* how many chunks have been allocated <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;limit<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">* hard limit <span style="color:#0000ff;">on the number of chunks <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;minavail<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">* how many chunks are expected <span style="color:#0000ff;">to be used <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">* chunk size <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flags<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">* MEM_F_<span style="color:#0000cc;">* <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;users<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">* number of pools sharing this zone <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;int8_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name<span style="color:#0000cc;">[12<span style="color:#0000cc;">]<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">* name of the pool <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span></span></span></span> </li> 
      <li> <span style="color:#0000cc;">}<span style="color:#0000cc;">; </span></span> </li> 
     </ol>
    </div> 
   </div> 
   <p> <br> &nbsp; &nbsp; 2，具体实现<br> &nbsp; &nbsp;&nbsp;&nbsp; &nbsp; a，头文件（pools.h）</p> 
   <div> 
    <div class="codeheads"> 
     <p> 点击(<span style="color:#FF0000;">此处)折叠或打开 </span></p> 
    </div> 
    <div class="codeText">
     <ol>
      <li> <span style="color:#000000;">#ifndef __POOLS_H__<br></span> </li> 
      <li> #define __POOLS_H__<br></li> 
      <li> <br></li> 
      <li> #ifdef __cplusplus<br></li> 
      <li> extern <span style="color:#ff00ff;">"C" <span style="color:#0000cc;">{<br></span></span> </li> 
      <li> #endif<br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* Define <span style="color:#0000ff;">to prevent recursive inclusion <br></span></span></span> </li> 
      <li> <span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> #include <span style="color:#ff00ff;">"types.h"<br></span> </li> 
      <li> #include <span style="color:#ff00ff;">"list.h"<br></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> #define MEM_F_SHARED&nbsp;&nbsp;&nbsp;&nbsp;0x1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">* 标示对应的池允许共用 <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* 每个池的相关信息 <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span> </li> 
      <li> struct pool_head <span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;void &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">*<span style="color:#0000cc;">*free_list<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;<br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;struct list_head &nbsp;&nbsp;&nbsp;&nbsp;list<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">* list of all known pools <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;used<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">* how many chunks are currently <span style="color:#0000ff;">in use <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allocated<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">* how many chunks have been allocated <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;limit<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">* hard limit <span style="color:#0000ff;">on the number of chunks <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;minavail<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">* how many chunks are expected <span style="color:#0000ff;">to be used <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">* chunk size <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flags<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">* MEM_F_<span style="color:#0000cc;">* <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;users<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">* number of pools sharing this zone <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;int8_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name<span style="color:#0000cc;">[12<span style="color:#0000cc;">]<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">* name of the pool <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span></span></span></span> </li> 
      <li> <span style="color:#0000cc;">}<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* 池创建 <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span> </li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* Try <span style="color:#0000ff;">to find an existing shared pool with the same characteristics <span style="color:#0000ff;">and<br></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* returns it<span style="color:#0000cc;">, otherwise creates this one<span style="color:#0000cc;">. <span style="color:#0000ff;">NULL <span style="color:#0000ff;">is returned <span style="color:#0000ff;">if no memory<br></span></span></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* <span style="color:#0000ff;">is available <span style="color:#0000ff;">for a new creation<span style="color:#0000cc;">.<br></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span> </li> 
      <li> extern &nbsp;&nbsp;&nbsp;&nbsp;struct pool_head <span style="color:#0000cc;">*&nbsp;&nbsp;&nbsp;&nbsp;pool_create<span style="color:#0000cc;">(char <span style="color:#0000cc;">*name<span style="color:#0000cc;">, uint32_t size<span style="color:#0000cc;">, uint32_t flags<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span></span></span></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* 池销毁 <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span> </li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">*<br></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* This <span style="color:#0000ff;">function destroys a pool by freeing it completely<span style="color:#0000cc;">, unless it<span style="color:#0000cc;">'s still<br></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* <span style="color:#0000ff;">in use<span style="color:#0000cc;">. This should be called only under extreme circumstances<span style="color:#0000cc;">. It always<br></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* returns <span style="color:#0000ff;">NULL <span style="color:#0000ff;">if the resulting pool <span style="color:#0000ff;">is <span style="color:#0000ff;">empty<span style="color:#0000cc;">, easing the clearing of the old<br></span></span></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* pointer<span style="color:#0000cc;">, otherwise it returns the pool<span style="color:#0000cc;">.<br></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* <span style="color:#0000cc;">.<br></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span> </li> 
      <li> extern&nbsp;&nbsp;&nbsp;&nbsp;void<span style="color:#0000cc;">*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pool_destroy<span style="color:#0000cc;">(struct pool_head <span style="color:#0000cc;">*pool<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* 把池中的空闲的元素都给释放掉 <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span> </li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">*<br></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* This <span style="color:#0000ff;">function frees whatever can be freed <span style="color:#0000ff;">in pool <span style="color:#0000cc;">&lt;pool<span style="color:#0000cc;">&gt;<span style="color:#0000cc;">.<br></span></span></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span> </li> 
      <li> extern &nbsp;&nbsp;&nbsp;&nbsp;void &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pool_clear<span style="color:#0000cc;">(struct pool_head <span style="color:#0000cc;">*pool<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* 把池中非必要的元素给释放掉 <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span> </li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">*<br></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* This <span style="color:#0000ff;">function frees whatever can be freed <span style="color:#0000ff;">in all pools<span style="color:#0000cc;">, but respecting<br></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* the minimum thresholds imposed by owners<span style="color:#0000cc;">. It takes care of avoiding<br></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* recursion because it may be called from a signal handler<span style="color:#0000cc;">.<br></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span> </li> 
      <li> extern&nbsp;&nbsp;&nbsp;&nbsp;void &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pool_flush_nonessential<span style="color:#0000cc;">(void<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* 动态分配一个 pool 元素大小的内存空间 <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span> </li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* Allocate a new entry <span style="color:#0000ff;">for pool <span style="color:#0000cc;">&lt;pool<span style="color:#0000cc;">&gt;<span style="color:#0000cc;">, <span style="color:#0000ff;">and return it <span style="color:#0000ff;">for immediate use<span style="color:#0000cc;">.<br></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* <span style="color:#0000ff;">NULL <span style="color:#0000ff;">is returned <span style="color:#0000ff;">if no memory <span style="color:#0000ff;">is available <span style="color:#0000ff;">for a new creation<span style="color:#0000cc;">.<br></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span> </li> 
      <li> extern&nbsp;&nbsp;&nbsp;&nbsp;void <span style="color:#0000cc;">*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pool_refill_alloc<span style="color:#0000cc;">(struct pool_head <span style="color:#0000cc;">*pool<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">*<br></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* Returns a pointer <span style="color:#0000ff;">to type <span style="color:#0000cc;">&lt;type<span style="color:#0000cc;">&gt; taken from the<br></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* pool <span style="color:#0000cc;">&lt;pool_type<span style="color:#0000cc;">&gt; <span style="color:#0000ff;">or dynamically allocated<span style="color:#0000cc;">. <span style="color:#0000ff;">In the<br></span></span></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* first <span style="color:#0000ff;">case<span style="color:#0000cc;">, <span style="color:#0000cc;">&lt;pool_type<span style="color:#0000cc;">&gt; <span style="color:#0000ff;">is updated <span style="color:#0000ff;">to point <span style="color:#0000ff;">to the<br></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* <span style="color:#0000ff;">next <span style="color:#ff0000;">element <span style="color:#0000ff;">in the list<span style="color:#0000cc;">.<br></span></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span> </li> 
      <li> #define pool_alloc<span style="color:#0000cc;">(pool<span style="color:#0000cc;">) <span style="color:#0000cc;">\<br></span></span></span> </li> 
      <li> <span style="color:#0000cc;">(<span style="color:#0000cc;">{ <span style="color:#0000cc;">\<br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void <span style="color:#0000cc;">*__p<span style="color:#0000cc;">; <span style="color:#0000cc;">\<br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if <span style="color:#0000cc;">(<span style="color:#0000cc;">(__p <span style="color:#0000cc;">= <span style="color:#0000cc;">(pool<span style="color:#0000cc;">)<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;free_list<span style="color:#0000cc;">) <span style="color:#0000cc;">=<span style="color:#0000cc;">= <span style="color:#0000ff;">NULL<span style="color:#0000cc;">)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">\<br></span></span></span></span></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__p <span style="color:#0000cc;">= pool_refill_alloc<span style="color:#0000cc;">(pool<span style="color:#0000cc;">)<span style="color:#0000cc;">; <span style="color:#0000cc;">\<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">else <span style="color:#0000cc;">{ <span style="color:#0000cc;">\<br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">(pool<span style="color:#0000cc;">)<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;free_list <span style="color:#0000cc;">= <span style="color:#0000cc;">*<span style="color:#0000cc;">(void <span style="color:#0000cc;">*<span style="color:#0000cc;">*<span style="color:#0000cc;">)<span style="color:#0000cc;">(pool<span style="color:#0000cc;">)<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;free_list<span style="color:#0000cc;">;<span style="color:#0000cc;">\<br></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">(pool<span style="color:#0000cc;">)<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;used<span style="color:#0000cc;">+<span style="color:#0000cc;">+<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">\<br></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">} <span style="color:#0000cc;">\<br></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__p<span style="color:#0000cc;">; <span style="color:#0000cc;">\<br></span></span> </li> 
      <li> <span style="color:#0000cc;">}<span style="color:#0000cc;">)<br></span></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">*<br></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* Puts a memory area back <span style="color:#0000ff;">to the corresponding pool<span style="color:#0000cc;">.<br></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* Items are chained directly through a pointer that<br></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* <span style="color:#0000ff;">is written <span style="color:#0000ff;">in the beginning of the memory area<span style="color:#0000cc;">, so<br></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* there<span style="color:#0000cc;">'s no need <span style="color:#0000ff;">for any carrier cell<span style="color:#0000cc;">. This implies<br></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* that <span style="color:#0000ff;">each memory area <span style="color:#0000ff;">is at least as big as one<br></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* pointer<span style="color:#0000cc;">. Just like with the libc<span style="color:#0000cc;">'s free<span style="color:#0000cc;">(<span style="color:#0000cc;">)<span style="color:#0000cc;">, <span style="color:#0000ff;">nothing<br></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* <span style="color:#0000ff;">is done <span style="color:#0000ff;">if <span style="color:#0000cc;">&lt;ptr<span style="color:#0000cc;">&gt; <span style="color:#0000ff;">is <span style="color:#0000ff;">NULL<span style="color:#0000cc;">.<br></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span> </li> 
      <li> #define pool_free<span style="color:#0000cc;">(pool<span style="color:#0000cc;">, ptr<span style="color:#0000cc;">) <span style="color:#0000cc;">\<br></span></span></span></span> </li> 
      <li> <span style="color:#0000cc;">(<span style="color:#0000cc;">{ <span style="color:#0000cc;">\<br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if <span style="color:#0000cc;">(<span style="color:#0000cc;">(ptr<span style="color:#0000cc;">) <span style="color:#0000cc;">!<span style="color:#0000cc;">= <span style="color:#0000ff;">NULL<span style="color:#0000cc;">) <span style="color:#0000cc;">{ <span style="color:#0000cc;">\<br></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">*<span style="color:#0000cc;">(void <span style="color:#0000cc;">*<span style="color:#0000cc;">*<span style="color:#0000cc;">)<span style="color:#0000cc;">(ptr<span style="color:#0000cc;">) <span style="color:#0000cc;">= <span style="color:#0000cc;">(void <span style="color:#0000cc;">*<span style="color:#0000cc;">)<span style="color:#0000cc;">(pool<span style="color:#0000cc;">)<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;free_list<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">\<br></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">(pool<span style="color:#0000cc;">)<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;free_list <span style="color:#0000cc;">= <span style="color:#0000cc;">(void <span style="color:#0000cc;">*<span style="color:#0000cc;">)<span style="color:#0000cc;">(ptr<span style="color:#0000cc;">)<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">\<br></span></span></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">(pool<span style="color:#0000cc;">)<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;used<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">\<br></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">} <span style="color:#0000cc;">\<br></span></span> </li> 
      <li> <span style="color:#0000cc;">}<span style="color:#0000cc;">)<br></span></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> #ifdef __cplusplus<br></li> 
      <li> <span style="color:#0000cc;">}<br></span> </li> 
      <li> #endif<br></li> 
      <li> <br></li> 
      <li> #endif </li> 
     </ol>
    </div> 
   </div> 
   <p> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; b，c文件<span><span>（pools.c<span>）<br></span></span></span></p> 
   <div> 
    <div class="codeheads"> 
     <p> 点击(<span style="color:#FF0000;">此处)折叠或打开 </span></p> 
    </div> 
    <div class="codeText">
     <ol>
      <li> <span style="color:#000000;">#include <span style="color:#ff00ff;">"pools.h"<br></span></span> </li> 
      <li> #include <span style="color:#ff00ff;">"standard.h"<br></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* 管理所有池的链表头 <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span> </li> 
      <li> static struct list_head&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pools <span style="color:#0000cc;">= LIST_HEAD_INIT<span style="color:#0000cc;">(pools<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* 池创建 <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span> </li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* Try <span style="color:#0000ff;">to find an existing shared pool with the same characteristics <span style="color:#0000ff;">and<br></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* returns it<span style="color:#0000cc;">, otherwise creates this one<span style="color:#0000cc;">. <span style="color:#0000ff;">NULL <span style="color:#0000ff;">is returned <span style="color:#0000ff;">if no memory<br></span></span></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* <span style="color:#0000ff;">is available <span style="color:#0000ff;">for a new creation<span style="color:#0000cc;">.<br></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span> </li> 
      <li> struct pool_head <span style="color:#0000cc;">*&nbsp;&nbsp;&nbsp;&nbsp;pool_create<span style="color:#0000cc;">(char <span style="color:#0000cc;">*name<span style="color:#0000cc;">, uint32_t size<span style="color:#0000cc;">, uint32_t flags<span style="color:#0000cc;">)<br></span></span></span></span></span></span> </li> 
      <li> <span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;struct pool_head <span style="color:#0000cc;">*pool<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;struct pool_head <span style="color:#0000cc;">*entry<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;struct list_head <span style="color:#0000cc;">*start<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;uint32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; align<span style="color:#0000cc;">;<br></span> </li> 
      <li> <br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">* We need <span style="color:#0000ff;">to store at least a <span style="color:#0000cc;">(void <span style="color:#0000cc;">*<span style="color:#0000cc;">) <span style="color:#0000ff;">in the chunks<span style="color:#0000cc;">. Since we know<br></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000cc;">* that the malloc<span style="color:#0000cc;">(<span style="color:#0000cc;">) <span style="color:#0000ff;">function will never return such a small size<span style="color:#0000cc;">,<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000cc;">* <span style="color:#0000ff;">let<span style="color:#0000cc;">'s <span style="color:#ff0000;">round the size up <span style="color:#0000ff;">to something slightly bigger<span style="color:#0000cc;">, <span style="color:#0000ff;">in order <span style="color:#0000ff;">to<br></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000cc;">* ease merging of entries<span style="color:#0000cc;">. Note that the rounding <span style="color:#0000ff;">is a power of two<span style="color:#0000cc;">.<br></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span> </li> 
      <li> <br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;align <span style="color:#0000cc;">= 16<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;size <span style="color:#0000cc;">= <span style="color:#0000cc;">(size <span style="color:#0000cc;">+ align <span style="color:#0000cc;">- 1<span style="color:#0000cc;">) <span style="color:#0000cc;">&amp; <span style="color:#0000cc;">-align<span style="color:#0000cc;">;<br></span></span></span></span></span></span></span></span> </li> 
      <li> <br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;start <span style="color:#0000cc;">= <span style="color:#0000cc;">&amp;pools<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;pool <span style="color:#0000cc;">= <span style="color:#0000ff;">NULL<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> <br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;list_for_each_entry<span style="color:#0000cc;">(entry<span style="color:#0000cc;">, <span style="color:#0000cc;">&amp;pools<span style="color:#0000cc;">, list<span style="color:#0000cc;">) <span style="color:#0000cc;">{<br></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if <span style="color:#0000cc;">(entry<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;size <span style="color:#0000cc;">=<span style="color:#0000cc;">= size<span style="color:#0000cc;">) <span style="color:#0000cc;">{<br></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">* either we can share this place <span style="color:#0000ff;">and we take it<span style="color:#0000cc;">, <span style="color:#0000ff;">or<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000cc;">* we look <span style="color:#0000ff;">for a sharable one <span style="color:#0000ff;">or <span style="color:#0000ff;">for the <span style="color:#0000ff;">next position<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000cc;">* before which we will insert a new one<span style="color:#0000cc;">.<br></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if <span style="color:#0000cc;">(flags <span style="color:#0000cc;">&amp; entry<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;flags <span style="color:#0000cc;">&amp; MEM_F_SHARED<span style="color:#0000cc;">) <span style="color:#0000cc;">{<br></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">* we can share this one <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pool <span style="color:#0000cc;">= entry<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color:#0000cc;">;<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">else <span style="color:#0000ff;">if <span style="color:#0000cc;">(entry<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;size <span style="color:#0000cc;">&gt; size<span style="color:#0000cc;">) <span style="color:#0000cc;">{<br></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">* insert before this one <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start <span style="color:#0000cc;">= <span style="color:#0000cc;">&amp;entry<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;list<span style="color:#0000cc;">;<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color:#0000cc;">;<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> <br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if <span style="color:#0000cc;">(<span style="color:#0000cc;">!pool<span style="color:#0000cc;">) <span style="color:#0000cc;">{<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pool <span style="color:#0000cc;">= calloc<span style="color:#0000cc;">(1<span style="color:#0000cc;">, sizeof<span style="color:#0000cc;">(<span style="color:#0000cc;">*pool<span style="color:#0000cc;">)<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if <span style="color:#0000cc;">(<span style="color:#0000cc;">!pool<span style="color:#0000cc;">)<br></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color:#0000ff;">NULL<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if <span style="color:#0000cc;">(name<span style="color:#0000cc;">)<br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strlcpy<span style="color:#0000cc;">(pool<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;name<span style="color:#0000cc;">, <span style="color:#0000cc;">(int8_t<span style="color:#0000cc;">*<span style="color:#0000cc;">)name<span style="color:#0000cc;">, sizeof<span style="color:#0000cc;">(pool<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;name<span style="color:#0000cc;">)<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pool<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;size <span style="color:#0000cc;">= size<span style="color:#0000cc;">;<br></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pool<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;flags <span style="color:#0000cc;">= flags<span style="color:#0000cc;">;<br></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_add_tail<span style="color:#0000cc;">(<span style="color:#0000cc;">&amp;pool<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;list<span style="color:#0000cc;">,start<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;pool<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;users<span style="color:#0000cc;">+<span style="color:#0000cc;">+<span style="color:#0000cc;">;<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;return pool<span style="color:#0000cc;">;<br></span> </li> 
      <li> <span style="color:#0000cc;">}<br></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* 池销毁 <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span> </li> 
      <li> void<span style="color:#0000cc;">*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pool_destroy<span style="color:#0000cc;">(struct pool_head <span style="color:#0000cc;">*pool<span style="color:#0000cc;">)<br></span></span></span></span> </li> 
      <li> <span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if <span style="color:#0000cc;">(pool<span style="color:#0000cc;">) <br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pool_clear<span style="color:#0000cc;">(pool<span style="color:#0000cc;">)<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">/ 请看池中的空闲的元素<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if <span style="color:#0000cc;">(pool<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;used<span style="color:#0000cc;">)<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return pool<span style="color:#0000cc;">;<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pool<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;users<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">;<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if <span style="color:#0000cc;">(<span style="color:#0000cc;">!pool<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;users<span style="color:#0000cc;">) <br></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_del<span style="color:#0000cc;">(<span style="color:#0000cc;">&amp;pool<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;list<span style="color:#0000cc;">)<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">/ 从 pools 链表中删除<br></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free<span style="color:#0000cc;">(pool<span style="color:#0000cc;">)<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">/ 把 pool 结构体占用的内存给释放了<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;return <span style="color:#0000ff;">NULL<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> <span style="color:#0000cc;">}<br></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* 把池中的空闲的元素都给释放掉 <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span> </li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">*<br></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* This <span style="color:#0000ff;">function frees whatever can be freed <span style="color:#0000ff;">in pool <span style="color:#0000cc;">&lt;pool<span style="color:#0000cc;">&gt;<span style="color:#0000cc;">.<br></span></span></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span> </li> 
      <li> void &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pool_clear<span style="color:#0000cc;">(struct pool_head <span style="color:#0000cc;">*pool<span style="color:#0000cc;">)<br></span></span></span> </li> 
      <li> <span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;void <span style="color:#0000cc;">*temp<span style="color:#0000cc;">, <span style="color:#0000cc;">*<span style="color:#0000ff;">next<span style="color:#0000cc;">;<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if <span style="color:#0000cc;">(<span style="color:#0000cc;">!pool<span style="color:#0000cc;">)<br></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<span style="color:#0000cc;">;<br></span> </li> 
      <li> <br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">next <span style="color:#0000cc;">= pool<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;free_list<span style="color:#0000cc;">;<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">while <span style="color:#0000cc;">(<span style="color:#0000ff;">next<span style="color:#0000cc;">) <span style="color:#0000cc;">{<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;temp <span style="color:#0000cc;">= <span style="color:#0000ff;">next<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">next <span style="color:#0000cc;">= <span style="color:#0000cc;">*<span style="color:#0000cc;">(void <span style="color:#0000cc;">*<span style="color:#0000cc;">*<span style="color:#0000cc;">)temp<span style="color:#0000cc;">;<br></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pool<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;allocated<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">;<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free<span style="color:#0000cc;">(temp<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;pool<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;free_list <span style="color:#0000cc;">= <span style="color:#0000ff;">next<span style="color:#0000cc;">;<br></span></span></span></span></span> </li> 
      <li> <br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">* here<span style="color:#0000cc;">, we should have pool<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;allocate <span style="color:#0000cc;">=<span style="color:#0000cc;">= pool<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;used <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> <span style="color:#0000cc;">}<br></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* 把池中非必要的元素给释放掉 <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span> </li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">*<br></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* This <span style="color:#0000ff;">function frees whatever can be freed <span style="color:#0000ff;">in all pools<span style="color:#0000cc;">, but respecting<br></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* the minimum thresholds imposed by owners<span style="color:#0000cc;">. It takes care of avoiding<br></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* recursion because it may be called from a signal handler<span style="color:#0000cc;">.<br></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span> </li> 
      <li> void &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pool_flush_nonessential<span style="color:#0000cc;">(void<span style="color:#0000cc;">)<br></span></span> </li> 
      <li> <span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;static <span style="color:#ff0000;">int recurse<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;struct pool_head <span style="color:#0000cc;">*entry<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> <br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if <span style="color:#0000cc;">(recurse<span style="color:#0000cc;">+<span style="color:#0000cc;">+<span style="color:#0000cc;">)<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto out<span style="color:#0000cc;">;<br></span> </li> 
      <li> <br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;list_for_each_entry<span style="color:#0000cc;">(entry<span style="color:#0000cc;">, <span style="color:#0000cc;">&amp;pools<span style="color:#0000cc;">, list<span style="color:#0000cc;">) <span style="color:#0000cc;">{<br></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void <span style="color:#0000cc;">*temp<span style="color:#0000cc;">, <span style="color:#0000cc;">*<span style="color:#0000ff;">next<span style="color:#0000cc;">;<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">/qfprintf<span style="color:#0000cc;">(stderr<span style="color:#0000cc;">, <span style="color:#ff00ff;">"Flushing pool %s\n"<span style="color:#0000cc;">, entry<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;name<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">next <span style="color:#0000cc;">= entry<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;free_list<span style="color:#0000cc;">;<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">while <span style="color:#0000cc;">(<span style="color:#0000ff;">next <span style="color:#0000cc;">&amp;<span style="color:#0000cc;">&amp;<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; entry<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;allocated <span style="color:#0000cc;">&gt; entry<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;minavail <span style="color:#0000cc;">&amp;<span style="color:#0000cc;">&amp;<br></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; entry<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;allocated <span style="color:#0000cc;">&gt; entry<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;used<span style="color:#0000cc;">) <span style="color:#0000cc;">{<br></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;temp <span style="color:#0000cc;">= <span style="color:#0000ff;">next<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">next <span style="color:#0000cc;">= <span style="color:#0000cc;">*<span style="color:#0000cc;">(void <span style="color:#0000cc;">*<span style="color:#0000cc;">*<span style="color:#0000cc;">)temp<span style="color:#0000cc;">;<br></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;allocated<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">;<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free<span style="color:#0000cc;">(temp<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;free_list <span style="color:#0000cc;">= <span style="color:#0000ff;">next<span style="color:#0000cc;">;<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> &nbsp;out<span style="color:#0000cc;">:<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;recurse<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> <span style="color:#0000cc;">}<br></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* 动态分配一个 pool 元素大小的内存空间 <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span> </li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* Allocate a new entry <span style="color:#0000ff;">for pool <span style="color:#0000cc;">&lt;pool<span style="color:#0000cc;">&gt;<span style="color:#0000cc;">, <span style="color:#0000ff;">and return it <span style="color:#0000ff;">for immediate use<span style="color:#0000cc;">.<br></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* <span style="color:#0000ff;">NULL <span style="color:#0000ff;">is returned <span style="color:#0000ff;">if no memory <span style="color:#0000ff;">is available <span style="color:#0000ff;">for a new creation<span style="color:#0000cc;">. A <span style="color:#0000ff;">call<br></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* <span style="color:#0000ff;">to the garbage collector <span style="color:#0000ff;">is performed before returning <span style="color:#0000ff;">NULL<span style="color:#0000cc;">.<br></span></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span> </li> 
      <li> void <span style="color:#0000cc;">*pool_refill_alloc<span style="color:#0000cc;">(struct pool_head <span style="color:#0000cc;">*pool<span style="color:#0000cc;">)<br></span></span></span></span> </li> 
      <li> <span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;void <span style="color:#0000cc;">*ret<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> <br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if <span style="color:#0000cc;">(pool<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;limit <span style="color:#0000cc;">&amp;<span style="color:#0000cc;">&amp; <span style="color:#0000cc;">(pool<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;allocated <span style="color:#0000cc;">&gt;<span style="color:#0000cc;">= pool<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;limit<span style="color:#0000cc;">)<span style="color:#0000cc;">)<br></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color:#0000ff;">NULL<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color:#0000cc;">= calloc<span style="color:#0000cc;">(1<span style="color:#0000cc;">, pool<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;size<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if <span style="color:#0000cc;">(<span style="color:#0000cc;">!ret<span style="color:#0000cc;">) <span style="color:#0000cc;">{<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pool_flush_nonessential<span style="color:#0000cc;">(<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color:#0000cc;">= calloc<span style="color:#0000cc;">(1<span style="color:#0000cc;">, pool<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;size<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if <span style="color:#0000cc;">(<span style="color:#0000cc;">!ret<span style="color:#0000cc;">)<br></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color:#0000ff;">NULL<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> <br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;pool<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;allocated<span style="color:#0000cc;">+<span style="color:#0000cc;">+<span style="color:#0000cc;">;<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;pool<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;used<span style="color:#0000cc;">+<span style="color:#0000cc;">+<span style="color:#0000cc;">;<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;return ret<span style="color:#0000cc;">;<br></span> </li> 
      <li> <span style="color:#0000cc;">}<br></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* 销毁所有的池 <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span> </li> 
      <li> int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dump_pools<span style="color:#0000cc;">(void<span style="color:#0000cc;">)<br></span></span> </li> 
      <li> <span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color:#0000cc;">= OPER_OK<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> <br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;return ret<span style="color:#0000cc;">;<br></span> </li> 
      <li> <span style="color:#0000cc;">} </span> </li> 
     </ol>
    </div> 
   </div> 
   <p> <span><span><span> <br><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c，辅助文件<span>（standard.c<span>）<span><br></span></span></span></span></span></span></span></p> 
   <div> 
    <div class="codeheads"> 
     <p> 点击(<span style="color:#FF0000;">此处)折叠或打开 </span></p> 
    </div> 
    <div class="codeText">
     <ol>
      <li> <span style="color:#000000;"><span style="color:#0000cc;">/<span style="color:#0000cc;">*<br></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* copies at most <span style="color:#0000cc;">&lt;size<span style="color:#0000cc;">-1<span style="color:#0000cc;">&gt; chars from <span style="color:#0000cc;">&lt;src<span style="color:#0000cc;">&gt; <span style="color:#0000ff;">to <span style="color:#0000cc;">&lt;dst<span style="color:#0000cc;">&gt;<span style="color:#0000cc;">. Last char <span style="color:#0000ff;">is always<br></span></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* <span style="color:#0000ff;">set <span style="color:#0000ff;">to 0<span style="color:#0000cc;">, unless <span style="color:#0000cc;">&lt;size<span style="color:#0000cc;">&gt; <span style="color:#0000ff;">is 0<span style="color:#0000cc;">. The number of chars copied <span style="color:#0000ff;">is returned<br></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* <span style="color:#0000cc;">(excluding the terminating zero<span style="color:#0000cc;">)<span style="color:#0000cc;">.<br></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* This code has been optimized <span style="color:#0000ff;">for size <span style="color:#0000ff;">and speed <span style="color:#0000cc;">: <span style="color:#0000ff;">on x86<span style="color:#0000cc;">, it<span style="color:#0000cc;">'s 45 bytes<br></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* long<span style="color:#0000cc;">, uses only registers<span style="color:#0000cc;">, <span style="color:#0000ff;">and consumes only 4 cycles per char<span style="color:#0000cc;">.<br></span></span></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span> </li> 
      <li> int32_t&nbsp;&nbsp;&nbsp;&nbsp;strlcpy<span style="color:#0000cc;">(int8_t<span style="color:#0000cc;">*dst<span style="color:#0000cc;">, <span style="color:#0000ff;">const int8_t<span style="color:#0000cc;">*src<span style="color:#0000cc;">, int32_t size<span style="color:#0000cc;">)<br></span></span></span></span></span></span></span> </li> 
      <li> <span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;int8_t <span style="color:#0000cc;">*orig <span style="color:#0000cc;">= dst<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if <span style="color:#0000cc;">(size<span style="color:#0000cc;">) <br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">while <span style="color:#0000cc;">(<span style="color:#0000cc;">-<span style="color:#0000cc;">-size <span style="color:#0000cc;">&amp;<span style="color:#0000cc;">&amp; <span style="color:#0000cc;">(<span style="color:#0000cc;">*dst <span style="color:#0000cc;">= <span style="color:#0000cc;">*src<span style="color:#0000cc;">)<span style="color:#0000cc;">) <br></span></span></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;src<span style="color:#0000cc;">+<span style="color:#0000cc;">+<span style="color:#0000cc;">; dst<span style="color:#0000cc;">+<span style="color:#0000cc;">+<span style="color:#0000cc;">;<br></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">*dst <span style="color:#0000cc;">= 0<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;return dst <span style="color:#0000cc;">- orig<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> <span style="color:#0000cc;">} </span> </li> 
     </ol>
    </div> 
   </div> 
   <p> <span><span><span><span><span><span><span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; d，辅助文件（types.h）<br></span></span></span></span></span></span></span></p> 
   <div> 
    <div class="codeheads"> 
     <p> 点击(<span style="color:#FF0000;">此处)折叠或打开 </span></p> 
    </div> 
    <div class="codeText">
     <ol>
      <li> <span style="color:#000000;">#ifndef __TYPES_H__<br></span> </li> 
      <li> #define __TYPES_H__<br></li> 
      <li> <br></li> 
      <li> #ifdef __cplusplus<br></li> 
      <li> extern <span style="color:#ff00ff;">"C" <span style="color:#0000cc;">{<br></span></span> </li> 
      <li> #endif<br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* Define <span style="color:#0000ff;">to prevent recursive inclusion <br></span></span></span> </li> 
      <li> <span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> #include <span style="color:#0000cc;">&lt;stdio<span style="color:#0000cc;">.h<span style="color:#0000cc;">&gt; &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">/ 标准输入输出定义<br></span></span></span></span></span> </li> 
      <li> #include <span style="color:#0000cc;">&lt;stdlib<span style="color:#0000cc;">.h<span style="color:#0000cc;">&gt; &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">/ 标准函数库定义<br></span></span></span></span></span> </li> 
      <li> #include <span style="color:#0000cc;">&lt;<span style="color:#ff0000;">string<span style="color:#0000cc;">.h<span style="color:#0000cc;">&gt;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">/ memset<br></span></span></span></span></span></span> </li> 
      <li> #include <span style="color:#0000cc;">&lt;unistd<span style="color:#0000cc;">.h<span style="color:#0000cc;">&gt; &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">/ Unix标准函数定义，read<span style="color:#0000cc;">,write<span style="color:#0000cc;">.<span style="color:#0000cc;">.<span style="color:#0000cc;">.<br></span></span></span></span></span></span></span></span></span> </li> 
      <li> #include <span style="color:#0000cc;">&lt;sys<span style="color:#0000cc;">/types<span style="color:#0000cc;">.h<span style="color:#0000cc;">&gt;<br></span></span></span></span> </li> 
      <li> #include <span style="color:#0000cc;">&lt;sys<span style="color:#0000cc;">/stat<span style="color:#0000cc;">.h<span style="color:#0000cc;">&gt;<br></span></span></span></span> </li> 
      <li> #include <span style="color:#0000cc;">&lt;fcntl<span style="color:#0000cc;">.h<span style="color:#0000cc;">&gt; <span style="color:#0000cc;">/<span style="color:#0000cc;">/ 文件控制定义<br></span></span></span></span></span> </li> 
      <li> #include <span style="color:#0000cc;">&lt;termios<span style="color:#0000cc;">.h<span style="color:#0000cc;">&gt; &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">/ POSIX中断控制定义<br></span></span></span></span></span> </li> 
      <li> #include <span style="color:#0000cc;">&lt;errno<span style="color:#0000cc;">.h<span style="color:#0000cc;">&gt; &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">/ 错误号定义<br></span></span></span></span></span> </li> 
      <li> #include <span style="color:#0000cc;">&lt;pthread<span style="color:#0000cc;">.h<span style="color:#0000cc;">&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">/<span style="color:#0000cc;">/ pthread_t<span style="color:#0000cc;">,pthread_create<span style="color:#0000cc;">.<span style="color:#0000cc;">.<span style="color:#0000cc;">.<br></span></span></span></span></span></span></span></span></span> </li> 
      <li> #include <span style="color:#ff00ff;">"error.h"<br></span> </li> 
      <li> #include <span style="color:#ff00ff;">"debug.h"<br></span> </li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* 类型定义 <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span> </li> 
      <li> typedef signed&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int8_t<span style="color:#0000cc;">;<br></span> </li> 
      <li> typedef unsigned &nbsp;&nbsp;&nbsp;&nbsp;char &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint8_t<span style="color:#0000cc;">;<br></span> </li> 
      <li> <br></li> 
      <li> typedef signed&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;short &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int16_t<span style="color:#0000cc;">;<br></span> </li> 
      <li> typedef unsigned &nbsp;&nbsp;&nbsp;&nbsp;short &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint16_t<span style="color:#0000cc;">;<br></span> </li> 
      <li> <br></li> 
      <li> typedef signed&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff0000;">int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int32_t<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> typedef unsigned &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff0000;">int &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint32_t<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> <br></li> 
      <li> typedef signed&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;long long &nbsp;&nbsp;&nbsp;&nbsp;int64_t<span style="color:#0000cc;">;<br></span> </li> 
      <li> typedef unsigned long long &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint64_t<span style="color:#0000cc;">;<br></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> #define&nbsp;&nbsp;&nbsp;&nbsp;BUFFER_SIZE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;256<br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* 1，COM，串口相关<span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span> </li> 
      <li> #define&nbsp;&nbsp;&nbsp;&nbsp;COM_TYPE_UPPER_DEVICE&nbsp;&nbsp;&nbsp;&nbsp;1<br></li> 
      <li> #define&nbsp;&nbsp;&nbsp;&nbsp;COM_TYPE_LOWER_DEVICE&nbsp;&nbsp;&nbsp;&nbsp;2<br></li> 
      <li> <br></li> 
      <li> #define&nbsp;&nbsp;&nbsp;&nbsp;COM_BUFFER_SIZE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">(BUFFER_SIZE<span style="color:#0000cc;">)<br></span></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* 2，pools，池相关 <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* 3，命令相关<span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span> </li> 
      <li> #define&nbsp;&nbsp;&nbsp;&nbsp;CMD_DATA_LEN_MAX&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">(BUFFER_SIZE<span style="color:#0000cc;">)<br></span></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> #ifdef __cplusplus<br></li> 
      <li> <span style="color:#0000cc;">}<br></span> </li> 
      <li> #endif<br></li> 
      <li> <br></li> 
      <li> #endif </li> 
     </ol>
    </div> 
   </div> 
   <p> <span><span><span><span><span><span><span> <br><br><br><strong><span style="color:#e53333;font-size:24px;">三，实例</span></strong><br> &nbsp; &nbsp; 1，头文件（command.h）<br></span></span></span></span></span></span></span></p> 
   <div> 
    <div class="codeheads"> 
     <p> 点击(<span style="color:#FF0000;">此处)折叠或打开 </span></p> 
    </div> 
    <div class="codeText">
     <ol>
      <li> <span style="color:#000000;">#ifndef __COMMAND_H__<br></span> </li> 
      <li> #define __COMMAND_H__<br></li> 
      <li> <br></li> 
      <li> #ifdef __cplusplus<br></li> 
      <li> extern <span style="color:#ff00ff;">"C" <span style="color:#0000cc;">{<br></span></span> </li> 
      <li> #endif<br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* Define <span style="color:#0000ff;">to prevent recursive inclusion <br></span></span></span> </li> 
      <li> <span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">-<span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> #include <span style="color:#ff00ff;">"types.h"<br></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* 接收到的命令的来源等 <span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span></span></span> </li> 
      <li> typedef&nbsp;&nbsp;&nbsp;&nbsp;struct _cmd<br></li> 
      <li> <span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fd<span style="color:#0000cc;">;<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;pthread_t&nbsp;&nbsp;&nbsp;&nbsp;id<span style="color:#0000cc;">;<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;void<span style="color:#0000cc;">*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> <span style="color:#0000cc;">}cmd_t<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">/ 创建内存池<br></span></span> </li> 
      <li> extern&nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd_pool_create<span style="color:#0000cc;">(void<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">/ 释放内存池<br></span></span> </li> 
      <li> extern&nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd_pool_destroy<span style="color:#0000cc;">(void<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">/ 申请命令内存块，用以保存命令数据<br></span></span> </li> 
      <li> extern&nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd_alloc<span style="color:#0000cc;">(cmd_t&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">*<span style="color:#0000cc;">*param<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span></span> </li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">/ 释放命令内存块<br></span></span> </li> 
      <li> extern&nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd_free<span style="color:#0000cc;">(cmd_t&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">*param<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span> </li> 
      <li> <br></li> 
      <li> #ifdef DEBUG_POOL<br></li> 
      <li> extern&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd_pool_info<span style="color:#0000cc;">(void<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> #endif<br></li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> #ifdef __cplusplus<br></li> 
      <li> <span style="color:#0000cc;">}<br></span> </li> 
      <li> #endif<br></li> 
      <li> <br></li> 
      <li> #endif </li> 
     </ol>
    </div> 
   </div> 
   <p> <span><span><span><span><span><span><span> <br> &nbsp; &nbsp; 2，c文件（command.c）<br></span></span></span></span></span></span></span></p> 
   <div> 
    <div class="codeheads"> 
     <p> 点击(<span style="color:#FF0000;">此处)折叠或打开 </span></p> 
    </div> 
    <div class="codeText">
     <ol>
      <li> <span style="color:#000000;">#include <span style="color:#ff00ff;">"command.h"<br></span></span> </li> 
      <li> #include <span style="color:#ff00ff;">"pools.h"<br></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> static&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;&nbsp;&nbsp;&nbsp;pool_head&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">*cmd_head_pool <span style="color:#0000cc;">= <span style="color:#0000ff;">NULL<span style="color:#0000cc;">;<br></span></span></span></span> </li> 
      <li> static&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;&nbsp;&nbsp;&nbsp;pool_head&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">*cmd_data_pool <span style="color:#0000cc;">= <span style="color:#0000ff;">NULL<span style="color:#0000cc;">;<br></span></span></span></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">/ 创建内存池<br></span></span> </li> 
      <li> int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd_pool_create<span style="color:#0000cc;">(void<span style="color:#0000cc;">)<br></span></span> </li> 
      <li> <span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color:#0000cc;">= OPER_OK<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if <span style="color:#0000cc;">(cmd_head_pool <span style="color:#0000cc;">=<span style="color:#0000cc;">= <span style="color:#0000ff;">NULL<span style="color:#0000cc;">)<br></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if<span style="color:#0000cc;">(<span style="color:#0000cc;">(cmd_head_pool <span style="color:#0000cc;">= pool_create<span style="color:#0000cc;">(<span style="color:#ff00ff;">"cmd_head"<span style="color:#0000cc;">, sizeof<span style="color:#0000cc;">(cmd_t<span style="color:#0000cc;">)<span style="color:#0000cc;">, MEM_F_SHARED<span style="color:#0000cc;">)<span style="color:#0000cc;">) <span style="color:#0000cc;">=<span style="color:#0000cc;">= <span style="color:#0000ff;">NULL<span style="color:#0000cc;">)<br></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color:#0000cc;">= <span style="color:#0000cc;">-POOL_CREATE_ERROR<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">else<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if <span style="color:#0000cc;">(cmd_data_pool <span style="color:#0000cc;">=<span style="color:#0000cc;">= <span style="color:#0000ff;">NULL<span style="color:#0000cc;">)<br></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if<span style="color:#0000cc;">(<span style="color:#0000cc;">(cmd_data_pool <span style="color:#0000cc;">= pool_create<span style="color:#0000cc;">(<span style="color:#ff00ff;">"cmd_data"<span style="color:#0000cc;">, CMD_DATA_LEN_MAX<span style="color:#0000cc;">, MEM_F_SHARED<span style="color:#0000cc;">)<span style="color:#0000cc;">) <span style="color:#0000cc;">=<span style="color:#0000cc;">= <span style="color:#0000ff;">NULL<span style="color:#0000cc;">)<br></span></span></span></span></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd_pool_destroy<span style="color:#0000cc;">(<span style="color:#0000cc;">)<span style="color:#0000cc;">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color:#0000cc;">= <span style="color:#0000cc;">-POOL_CREATE_ERROR<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> <br></li> 
      <li> #ifdef DEBUG_POOL<br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;cmd_pool_info<span style="color:#0000cc;">(<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> #endif<br></li> 
      <li> <br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;return ret<span style="color:#0000cc;">;<br></span> </li> 
      <li> <span style="color:#0000cc;">}<br></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> #ifdef DEBUG_POOL<br></li> 
      <li> void&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd_pool_info<span style="color:#0000cc;">(void<span style="color:#0000cc;">)<br></span></span> </li> 
      <li> <span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;&nbsp;&nbsp;&nbsp;pool_head&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">*entry <span style="color:#0000cc;">= cmd_head_pool<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;printf<span style="color:#0000cc;">(<span style="color:#ff00ff;">"pool %s (%d bytes) : %d allocated (%u bytes), %d used\n"<span style="color:#0000cc;">,entry<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;name<span style="color:#0000cc;">, entry<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;size<span style="color:#0000cc;">, entry<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;allocated<span style="color:#0000cc;">,entry<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;size <span style="color:#0000cc;">* entry<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;allocated<span style="color:#0000cc;">, entry<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;used<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> <br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;entry <span style="color:#0000cc;">= cmd_data_pool<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;printf<span style="color:#0000cc;">(<span style="color:#ff00ff;">"pool %s (%d bytes) : %d allocated (%u bytes), %d used\n"<span style="color:#0000cc;">,entry<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;name<span style="color:#0000cc;">, entry<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;size<span style="color:#0000cc;">, entry<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;allocated<span style="color:#0000cc;">,entry<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;size <span style="color:#0000cc;">* entry<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;allocated<span style="color:#0000cc;">, entry<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;used<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> <span style="color:#0000cc;">}<br></span> </li> 
      <li> #endif<br></li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">/ 释放内存池<br></span></span> </li> 
      <li> int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd_pool_destroy<span style="color:#0000cc;">(void<span style="color:#0000cc;">)<br></span></span> </li> 
      <li> <span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color:#0000cc;">= OPER_OK<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> <br></li> 
      <li> #ifdef DEBUG_POOL<br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;cmd_pool_info<span style="color:#0000cc;">(<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> #endif<br></li> 
      <li> <br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if<span style="color:#0000cc;">(cmd_head_pool <span style="color:#0000cc;">!<span style="color:#0000cc;">= <span style="color:#0000ff;">NULL<span style="color:#0000cc;">)<br></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if<span style="color:#0000cc;">(<span style="color:#0000ff;">NULL <span style="color:#0000cc;">!<span style="color:#0000cc;">= pool_destroy<span style="color:#0000cc;">(cmd_head_pool<span style="color:#0000cc;">)<span style="color:#0000cc;">)<br></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color:#0000cc;">= <span style="color:#0000cc;">-POOL_DESTROY_ERROR<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">else<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if<span style="color:#0000cc;">(cmd_data_pool <span style="color:#0000cc;">!<span style="color:#0000cc;">= <span style="color:#0000ff;">NULL<span style="color:#0000cc;">)<br></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if<span style="color:#0000cc;">(<span style="color:#0000ff;">NULL <span style="color:#0000cc;">!<span style="color:#0000cc;">= pool_destroy<span style="color:#0000cc;">(cmd_data_pool<span style="color:#0000cc;">)<span style="color:#0000cc;">)<br></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color:#0000cc;">= <span style="color:#0000cc;">-POOL_DESTROY_ERROR<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> <br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;return ret<span style="color:#0000cc;">;<br></span> </li> 
      <li> <span style="color:#0000cc;">}<br></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">/ 申请命令内存块，用以保存命令数据<br></span></span> </li> 
      <li> int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd_alloc<span style="color:#0000cc;">(cmd_t&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">*<span style="color:#0000cc;">*param<span style="color:#0000cc;">)<br></span></span></span></span> </li> 
      <li> <span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color:#0000cc;">= OPER_OK<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> <br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if<span style="color:#0000cc;">(<span style="color:#0000cc;">(<span style="color:#0000cc;">*param <span style="color:#0000cc;">= <span style="color:#0000cc;">(cmd_t<span style="color:#0000cc;">*<span style="color:#0000cc;">)pool_alloc<span style="color:#0000cc;">(cmd_head_pool<span style="color:#0000cc;">)<span style="color:#0000cc;">) <span style="color:#0000cc;">=<span style="color:#0000cc;">= <span style="color:#0000ff;">NULL<span style="color:#0000cc;">)<br></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color:#0000cc;">= <span style="color:#0000cc;">-CMD_POOL_ALLOC_ERROR<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">else<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memset<span style="color:#0000cc;">(<span style="color:#0000cc;">*param<span style="color:#0000cc;">,0<span style="color:#0000cc;">,sizeof<span style="color:#0000cc;">(cmd_t<span style="color:#0000cc;">)<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if<span style="color:#0000cc;">(<span style="color:#0000cc;">(<span style="color:#0000cc;">(<span style="color:#0000cc;">*param<span style="color:#0000cc;">)<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;data <span style="color:#0000cc;">= pool_alloc<span style="color:#0000cc;">(cmd_data_pool<span style="color:#0000cc;">)<span style="color:#0000cc;">) <span style="color:#0000cc;">=<span style="color:#0000cc;">= <span style="color:#0000ff;">NULL<span style="color:#0000cc;">)<br></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd_free<span style="color:#0000cc;">(<span style="color:#0000cc;">*param<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color:#0000cc;">= <span style="color:#0000cc;">-CMD_POOL_ALLOC_ERROR<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> <br></li> 
      <li> #ifdef DEBUG_POOL<br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;cmd_pool_info<span style="color:#0000cc;">(<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> #endif<br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;return ret<span style="color:#0000cc;">;<br></span> </li> 
      <li> <span style="color:#0000cc;">}<br></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">/ 释放命令内存块<br></span></span> </li> 
      <li> int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd_free<span style="color:#0000cc;">(cmd_t&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">*param<span style="color:#0000cc;">)<br></span></span></span> </li> 
      <li> <span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if<span style="color:#0000cc;">(param<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;data <span style="color:#0000cc;">!<span style="color:#0000cc;">= <span style="color:#0000ff;">NULL<span style="color:#0000cc;">)<br></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pool_free<span style="color:#0000cc;">(cmd_data_pool<span style="color:#0000cc;">,param<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;data<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;param<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;data <span style="color:#0000cc;">= <span style="color:#0000ff;">NULL<span style="color:#0000cc;">;<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if<span style="color:#0000cc;">(param <span style="color:#0000cc;">!<span style="color:#0000cc;">= <span style="color:#0000ff;">NULL<span style="color:#0000cc;">)<br></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pool_free<span style="color:#0000cc;">(cmd_head_pool<span style="color:#0000cc;">,param<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;param <span style="color:#0000cc;">= <span style="color:#0000ff;">NULL<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> <span style="color:#0000cc;">&nbsp;&nbsp;&nbsp;&nbsp;<br></span> </li> 
      <li> <span style="color:#0000cc;">#ifdef DEBUG_POOL </span> </li> 
      <li> <span style="color:#0000cc;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#5c5c5c;font-family:Consolas, monospace;font-size:12px;letter-spacing:.10000000149011612px;line-height:15.600000381469727px;"><span style="color:#5c5c5c;font-family:Consolas, monospace;font-size:12px;letter-spacing:.10000000149011612px;line-height:15.600000381469727px;">cmd_po<span style="color:#5c5c5c;font-family:Consolas, monospace;font-size:12px;letter-spacing:.10000000149011612px;line-height:15.600000381469727px;">o<span style="color:#5c5c5c;font-family:Consolas, monospace;font-size:12px;letter-spacing:.10000000149011612px;line-height:15.600000381469727px;">l_info();<br></span></span></span></span></span> </li> 
      <li> #endif </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;return OPER_OK<span style="color:#0000cc;">;<br></span> </li> 
      <li> <span style="color:#0000cc;">} </span> </li> 
     </ol>
    </div> 
   </div> 
   <p> <span><span><span><span><span><span><span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; c，辅助文件（test.c）<br></span></span></span></span></span></span></span></p> 
   <div> 
    <div class="codeheads"> 
     <p> 点击(<span style="color:#FF0000;">此处)折叠或打开 </span></p> 
    </div> 
    <div class="codeText">
     <ol>
      <li> <span style="color:#000000;"><span style="color:#0000cc;">/<span style="color:#0000cc;">* <br></span></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* cmd pool begin<br></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">*<span style="color:#0000cc;">/<br></span></span> </li> 
      <li> static&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;&nbsp;&nbsp;&nbsp;cmd_pool_oper<span style="color:#0000cc;">(void<span style="color:#0000cc;">)<br></span></span> </li> 
      <li> <span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color:#0000cc;">= OPER_OK<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> <br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;printf<span style="color:#0000cc;">(<span style="color:#ff00ff;">"command pool test!\n"<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span> </li> 
      <li> <br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if<span style="color:#0000cc;">(<span style="color:#0000cc;">(ret <span style="color:#0000cc;">= cmd_pool_create<span style="color:#0000cc;">(<span style="color:#0000cc;">)<span style="color:#0000cc;">) <span style="color:#0000cc;">!<span style="color:#0000cc;">= OPER_OK<span style="color:#0000cc;">)<br></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf<span style="color:#0000cc;">(<span style="color:#ff00ff;">"Create command pool fail!\n"<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">else<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd_t<span style="color:#0000cc;">*&nbsp;&nbsp;&nbsp;&nbsp;cmd_buf<span style="color:#0000cc;">[5<span style="color:#0000cc;">]<span style="color:#0000cc;">;<br></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;i <span style="color:#0000cc;">= 0<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int32_t&nbsp;&nbsp;&nbsp;&nbsp;count <span style="color:#0000cc;">= 0<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf<span style="color:#0000cc;">(<span style="color:#ff00ff;">"Create command pool success!!!\n"<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span> </li> 
      <li> <br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memset<span style="color:#0000cc;">(cmd_buf<span style="color:#0000cc;">,0<span style="color:#0000cc;">,sizeof<span style="color:#0000cc;">(cmd_buf<span style="color:#0000cc;">)<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span></span></span></span> </li> 
      <li> <br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">for<span style="color:#0000cc;">(i <span style="color:#0000cc;">= 0<span style="color:#0000cc;">; i <span style="color:#0000cc;">&lt; 5<span style="color:#0000cc;">; i<span style="color:#0000cc;">+<span style="color:#0000cc;">+<span style="color:#0000cc;">)<br></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf<span style="color:#0000cc;">(<span style="color:#ff00ff;">"&nbsp;&nbsp;&nbsp;&nbsp;alloc \n"<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if<span style="color:#0000cc;">(cmd_alloc<span style="color:#0000cc;">(<span style="color:#0000cc;">&amp;cmd_buf<span style="color:#0000cc;">[i<span style="color:#0000cc;">]<span style="color:#0000cc;">) <span style="color:#0000cc;">!<span style="color:#0000cc;">= OPER_OK<span style="color:#0000cc;">)<br></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf<span style="color:#0000cc;">(<span style="color:#ff00ff;">"Alloc buffer fail : %d\n"<span style="color:#0000cc;">,i<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count <span style="color:#0000cc;">= i<span style="color:#0000cc;">;<br></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color:#0000cc;">;<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd_buf<span style="color:#0000cc;">[i<span style="color:#0000cc;">]<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;fd&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">= i<span style="color:#0000cc;">+1<span style="color:#0000cc;">;<br></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strcpy<span style="color:#0000cc;">(<span style="color:#0000cc;">(char<span style="color:#0000cc;">*<span style="color:#0000cc;">)cmd_buf<span style="color:#0000cc;">[i<span style="color:#0000cc;">]<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;data<span style="color:#0000cc;">,<span style="color:#ff00ff;">"hello"<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> <br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf<span style="color:#0000cc;">(<span style="color:#ff00ff;">"Alloc complete success!\n"<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span> </li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">/&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if<span style="color:#0000cc;">(i <span style="color:#0000cc;">&gt;<span style="color:#0000cc;">= 5<span style="color:#0000cc;">)&nbsp;&nbsp;&nbsp;&nbsp;count <span style="color:#0000cc;">= i<span style="color:#0000cc;">;<br></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">for<span style="color:#0000cc;">(i <span style="color:#0000cc;">= 0 <span style="color:#0000cc;">; i <span style="color:#0000cc;">&lt; 5<span style="color:#0000cc;">; i<span style="color:#0000cc;">+<span style="color:#0000cc;">+<span style="color:#0000cc;">)<br></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf<span style="color:#0000cc;">(<span style="color:#ff00ff;">"command %d fd : %d,data : %s\n"<span style="color:#0000cc;">,<span style="color:#0000cc;">(i<span style="color:#0000cc;">+1<span style="color:#0000cc;">)<span style="color:#0000cc;">,cmd_buf<span style="color:#0000cc;">[i<span style="color:#0000cc;">]<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;fd<span style="color:#0000cc;">,<span style="color:#0000cc;">(char<span style="color:#0000cc;">*<span style="color:#0000cc;">)cmd_buf<span style="color:#0000cc;">[i<span style="color:#0000cc;">]<span style="color:#0000cc;">-<span style="color:#0000cc;">&gt;data<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd_free<span style="color:#0000cc;">(cmd_buf<span style="color:#0000cc;">[i<span style="color:#0000cc;">]<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> <br></li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">if<span style="color:#0000cc;">(<span style="color:#0000cc;">(ret <span style="color:#0000cc;">= cmd_pool_destroy<span style="color:#0000cc;">(<span style="color:#0000cc;">)<span style="color:#0000cc;">) <span style="color:#0000cc;">!<span style="color:#0000cc;">= OPER_OK<span style="color:#0000cc;">)<br></span></span></span></span></span></span></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf<span style="color:#0000cc;">(<span style="color:#ff00ff;">"command pool destroy fail, still in use\n"<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;">else<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf<span style="color:#0000cc;">(<span style="color:#ff00ff;">"command pool destroy success!\n"<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000cc;">}<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;<br></li> 
      <li> <span style="color:#0000cc;">}<br></span> </li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> <br></li> 
      <li> void&nbsp;&nbsp;&nbsp;&nbsp;test_cmd_pool<span style="color:#0000cc;">(<span style="color:#0000cc;">)<br></span></span> </li> 
      <li> <span style="color:#0000cc;">{<br></span> </li> 
      <li> &nbsp;&nbsp;&nbsp;&nbsp;cmd_pool_oper<span style="color:#0000cc;">(<span style="color:#0000cc;">)<span style="color:#0000cc;">;<br></span></span></span> </li> 
      <li> <span style="color:#0000cc;">}<br></span> </li> 
      <li> <br></li> 
      <li> <span style="color:#0000cc;">/<span style="color:#0000cc;">* <br></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">* cmd pool <span style="color:#0000ff;">end <br></span></span> </li> 
      <li> &nbsp;<span style="color:#0000cc;">*<span style="color:#0000cc;">/ </span></span> </li> 
     </ol>
    </div> 
   </div> 
   <p> <span><span><span><span><span><span> <br> &nbsp; &nbsp;&nbsp;&nbsp; &nbsp; d，测试结果<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src="https://yqfile.alicdn.com/img_e87aab769af22671b3cb7e94452554c3.jpg" alt="" width="559" height="587"><br><br><br><strong><span style="color:#e53333;font-size:24px;">四，参考文件</span></strong><br> 1，《haproxy-1.5》源码<br> 2，<a href="http://blog.chinaunix.net/uid-28458801-id-4250240.html" rel="nofollow"><span style="color:#19599b;font-family:'黑体';"><span style="font-size:20px;">linux下双向链表的实现</span></span></a><br></span></span></span></span></span></span></p> 
   <div> 
    <div>
     【作者】
     <a href="http://www.cnblogs.com/sky-heaven/" rel="nofollow">张昺华</a> 
    </div> 
    <div>
     【出处】
     <a href="http://www.cnblogs.com/sky-heaven/" rel="nofollow">http://www.cnblogs.com/sky-heaven/</a> 
    </div> 
    <div>
     【博客园】 
     <a href="http://www.cnblogs.com/sky-heaven/" rel="nofollow">http://www.cnblogs.com/sky-heaven/</a> 
    </div> 
    <div>
     【新浪博客】 
     <a href="http://blog.sina.com.cn/u/2049150530" rel="nofollow">http://blog.sina.com.cn/u/2049150530</a> 
    </div> 
    <div>
     【知乎】 
     <a href="http://www.zhihu.com/people/zhang-bing-hua" rel="nofollow">http://www.zhihu.com/people/zhang-bing-hua</a> 
    </div> 
    <div>
     【我的作品---旋转倒立摆】 
     <a href="http://v.youku.com/v_show/id_XODM5NDAzNjQw.html?spm=a2hzp.8253869.0.0&amp;from=y1.7-2" rel="nofollow">http://v.youku.com/v_show/id_XODM5NDAzNjQw.html?spm=a2hzp.8253869.0.0&amp;from=y1.7-2</a> 
    </div> 
    <div>
     【我的作品---自平衡自动循迹车】 
     <a href="http://v.youku.com/v_show/id_XODM5MzYyNTIw.html?spm=a2hzp.8253869.0.0&amp;from=y1.7-2" rel="nofollow">http://v.youku.com/v_show/id_XODM5MzYyNTIw.html?spm=a2hzp.8253869.0.0&amp;from=y1.7-2</a> 
    </div> 
    <div>
     【新浪微博】 张昺华--sky
    </div> 
    <div>
     【twitter】 @sky2030_
    </div> 
    <div>
     【facebook】 张昺华 zhangbinghua
    </div> 
    <div>
     本文版权归作者和博客园共有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利.
    </div> 
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
