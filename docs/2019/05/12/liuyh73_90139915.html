<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>微服务架构 | GoKit-CLI使用 « NotBeCN</title>
  <meta name="description" content="                  当我们构建go-kit微服务时，会发现不同的微服务之间会有大量的冗余代码，Endpoint和Transport以及其他组件代码基本一致，书写这部分代码会浪费大量的时间，并且容易出现问题。当然，我们可以提取共用部分减少代码的冗余，但并不是一件容易的事情，十分考验我们的代码能力。那...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2019/05/12/liuyh73_90139915.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">微服务架构 | GoKit-CLI使用</h1>
    <p class="post-meta">May 12, 2019</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div id="content_views" class="markdown_views prism-github-gist"> 
  <!-- flowchart 箭头图标 勿删 --> 
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
   <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
  </svg> 
  <p>当我们构建go-kit微服务时，会发现不同的微服务之间会有大量的冗余代码，Endpoint和Transport以及其他组件代码基本一致，书写这部分代码会浪费大量的时间，并且容易出现问题。当然，我们可以提取共用部分减少代码的冗余，但并不是一件容易的事情，十分考验我们的代码能力。那么，有没有一个工具可以快速帮助我们生成这些共用代码从而使我们集中精力关注业务逻辑呢？</p> 
  <p><a href="https://github.com/kujtimiihoxha/kit" rel="nofollow">GoKit-CLI</a>就是解决这个问题的，下面来介绍一下这个工具应该如何使用。</p> 
  <h2><a id="GoKitCLI_4"></a>GoKit-CLI安装</h2> 
  <p>和其他go语言包一样，我们需要使用<code>go get</code>命令来安装：</p> 
  <pre><code class="prism language-bash">$ go get github.com/kujtimiihoxha/kit
</code></pre> 
  <p>安装成功后，会在<code>$GOPATH/bin</code>文件夹下生成<code>kit.exe</code>，如果没有将<code>$GOPATH/bin</code>加入到环境变量，请及时加入。</p> 
  <h2><a id="GoKitCLI_10"></a>GoKit-CLI构建服务</h2> 
  <p>以<a href="https://github.com/money-hub/MoneyDodo.service/tree/master/user" rel="nofollow">user</a>服务为例：此服务用于操作用户相关信息。</p> 
  <pre><code class="prism language-bash">$ kit new <span class="token function">service</span> user
<span class="token comment"># 或者可以使用简写\别名：kit n s user</span>
</code></pre> 
  <p>此时，我们可以在项目文件夹下看到生成的目录：</p> 
  <pre><code class="prism language-bash">user/
<span class="token operator">|</span>---pkg/
<span class="token operator">|</span>------service/
<span class="token operator">|</span>----------service.go
</code></pre> 
  <p><strong>service.go</strong></p> 
  <pre><code class="prism language-go"><span class="token keyword">package</span> service

<span class="token comment">// UserService describes the service.</span>
<span class="token keyword">type</span> UserService <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">// Add your methods here</span>
	<span class="token comment">// e.x: Foo(ctx context.Context,s string)(rs string, err error)</span>
<span class="token punctuation">}</span>
</code></pre> 
  <p>由上述注释可以看出我们需要在UserService接口中定义我们的业务逻辑函数。</p> 
  <p><strong>model</strong><br> 在定义业务逻辑之前我们需要定义好数据类型以供我们在业务逻辑函数中使用，此文件我们可以放在项目根路径（与user同级）下，以供后续创建的其他微服务使用：</p> 
  <pre><code class="prism language-go"><span class="token comment">// model.go</span>
<span class="token keyword">package</span> model

<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Id                  <span class="token builtin">string</span>  <span class="token string">`json:"id"`</span>
	SId                 <span class="token builtin">string</span>  <span class="token string">`json:"sId" xorm:"sId"`</span>
	Name                <span class="token builtin">string</span>  <span class="token string">`json:"name"`</span>
	Introduction        <span class="token builtin">string</span>  <span class="token string">`json:"introduction"`</span>
	Balance             <span class="token builtin">float64</span> <span class="token string">`json:"balance"`</span>
	Icon                <span class="token builtin">string</span>  <span class="token string">`json:"icon"`</span>
	Phone               <span class="token builtin">string</span>  <span class="token string">`json:"phone"`</span>
	Email               <span class="token builtin">string</span>  <span class="token string">`json:"email"`</span>
	<span class="token comment">// ......其他属性</span>
<span class="token punctuation">}</span>
</code></pre> 
  <p><strong>定义service</strong><br> 现在我们可以定义service.go文件中的函数，定义函数名称尽可能语义化，如果可以的话尽量符合REST风格：</p> 
  <pre><code class="prism language-go"><span class="token keyword">package</span> service

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"github.com/money-hub/MoneyDodo.service/model"</span>
<span class="token punctuation">)</span>

<span class="token comment">// UserService describes the service.</span>
<span class="token keyword">type</span> UserService <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">GetSpec</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>status <span class="token builtin">bool</span><span class="token punctuation">,</span> errinfo <span class="token builtin">string</span><span class="token punctuation">,</span> data <span class="token operator">*</span>model<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
	<span class="token function">GetAll</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> page<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> limit <span class="token builtin">int</span><span class="token punctuation">,</span> orderby <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>status <span class="token builtin">bool</span><span class="token punctuation">,</span> errinfo <span class="token builtin">string</span><span class="token punctuation">,</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span>model<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
	<span class="token function">GetUDF</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> page<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> limit <span class="token builtin">int</span><span class="token punctuation">,</span> orderby <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>status <span class="token builtin">bool</span><span class="token punctuation">,</span> errinfo <span class="token builtin">string</span><span class="token punctuation">,</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span>model<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
	<span class="token function">Post</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> user model<span class="token punctuation">.</span>User<span class="token punctuation">)</span> <span class="token punctuation">(</span>status <span class="token builtin">bool</span><span class="token punctuation">,</span> errinfo <span class="token builtin">string</span><span class="token punctuation">,</span> data <span class="token operator">*</span>model<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
	<span class="token function">Put</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">,</span> user model<span class="token punctuation">.</span>User<span class="token punctuation">)</span> <span class="token punctuation">(</span>status <span class="token builtin">bool</span><span class="token punctuation">,</span> errinfo <span class="token builtin">string</span><span class="token punctuation">,</span> data <span class="token operator">*</span>model<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
	<span class="token function">Delete</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>status <span class="token builtin">bool</span><span class="token punctuation">,</span> errinfo <span class="token builtin">string</span><span class="token punctuation">,</span> data <span class="token operator">*</span>model<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
  <p><strong>生成服务</strong></p> 
  <pre><code class="prism language-bash">$ kit g s todo -w --gorilla
</code></pre> 
  <p><code>-w</code> 生成一些默认的服务中间件<br> <code>--gorilla</code>使用<a href="https://github.com/gorilla/mux" rel="nofollow">gorilla/mux</a>来替换默认的http handler</p> 
  <p>成功运行命令之后，目录结构如下：</p> 
  <pre><code class="prism language-bash">user/
<span class="token operator">|</span>---cmd/
<span class="token operator">|</span>------service/
<span class="token operator">|</span>----------server.go          Wire the service.
<span class="token operator">|</span>----------server_gen.go      Also wire the service.
<span class="token operator">|</span>------main.go                Runs the <span class="token function">service</span>
<span class="token operator">|</span>---pkg/
<span class="token operator">|</span>------endpoints/
<span class="token operator">|</span>----------endpoint.go        The endpoint logic.
<span class="token operator">|</span>----------endpoint_gen.go    This will wire the endpoints.
<span class="token operator">|</span>----------middleware.go      Endpoint middleware
<span class="token operator">|</span>------http/
<span class="token operator">|</span>----------handler.go         Transport logic encode/decode data.
<span class="token operator">|</span>----------handler_gen.go     This will wire the transport.
<span class="token operator">|</span>------service/
<span class="token operator">|</span>----------middleware.go      The <span class="token function">service</span> middleware.
<span class="token operator">|</span>----------service.go         Business logic.
</code></pre> 
  <p>此时，我们就可以通过<code>go run user/cmd/main.go</code>来运行我们的服务，但是并不能提供任何操作。</p> 
  <h2><a id="_101"></a>完善业务逻辑</h2> 
  <p>完整的业务逻辑必定离不开数据库（mongodb、mysql、sqlite等）的支持，我以mysql数据库为例来进行说明。同样，此文件我们可以放在项目根路径（与user同级）下，以供后续创建的其他微服务使用：<br> <strong>db.go</strong></p> 
  <pre><code class="prism language-go"><span class="token keyword">package</span> db

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"io/ioutil"</span>
	<span class="token string">"log"</span>

	<span class="token boolean">_</span> <span class="token string">"github.com/go-sql-driver/mysql"</span>
	<span class="token string">"github.com/go-xorm/xorm"</span>
	yaml <span class="token string">"gopkg.in/yaml.v2"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> config <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Host     <span class="token builtin">string</span> <span class="token string">`yaml:"host"`</span>
	Port     <span class="token builtin">string</span> <span class="token string">`yaml:"port"`</span>
	Username <span class="token builtin">string</span> <span class="token string">`yaml:"username"`</span>
	Password <span class="token builtin">string</span> <span class="token string">`yaml:"password"`</span>
	Schema   <span class="token builtin">string</span> <span class="token string">`yaml:"schema"`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> DBService <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	conf   config
	engine <span class="token operator">*</span>xorm<span class="token punctuation">.</span>Engine
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">checkErr</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>dbsvc <span class="token operator">*</span>DBService<span class="token punctuation">)</span> <span class="token function">Bind</span><span class="token punctuation">(</span>dbconf <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	confFile<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>dbconf<span class="token punctuation">)</span>
	<span class="token function">checkErr</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>

	<span class="token comment">// fmt.Println(string(confFile))</span>
	err <span class="token operator">=</span> yaml<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>confFile<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dbsvc<span class="token punctuation">.</span>conf<span class="token punctuation">)</span>
	<span class="token function">checkErr</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	dataSourceName <span class="token operator">:=</span> dbsvc<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>Username <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> dbsvc<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>Password <span class="token operator">+</span> <span class="token string">"@tcp("</span> <span class="token operator">+</span> dbsvc<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>Host <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> dbsvc<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>Port <span class="token operator">+</span> <span class="token string">")/"</span> <span class="token operator">+</span> dbsvc<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>Schema <span class="token operator">+</span> <span class="token string">"?charset=utf8"</span>
	<span class="token comment">// fmt.Println(dataSourceName)</span>
	dbsvc<span class="token punctuation">.</span>engine<span class="token punctuation">,</span> err <span class="token operator">=</span> xorm<span class="token punctuation">.</span><span class="token function">NewEngine</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">,</span> dataSourceName<span class="token punctuation">)</span>
	<span class="token function">checkErr</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>dbsvc <span class="token operator">*</span>DBService<span class="token punctuation">)</span> <span class="token function">Engine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>xorm<span class="token punctuation">.</span>Engine <span class="token punctuation">{</span>
	<span class="token keyword">return</span> dbsvc<span class="token punctuation">.</span>engine
<span class="token punctuation">}</span>
</code></pre> 
  <p>微服务通过调用dbsvc.Bind()来绑定到数据库，之后便可以通过dbsvc.Engine()进行数据库操作。数据库操作我使用xorm，如果对xorm不了解，可以参考官方文档：<a href="http://www.xorm.io/docs/" rel="nofollow">http://www.xorm.io/docs/</a></p> 
  <p><strong>service.go</strong><br> 修改basicUserService结构体以及NewBasicUserService函数:</p> 
  <pre><code class="prism language-go"><span class="token keyword">type</span> basicUserService <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token operator">*</span>db<span class="token punctuation">.</span>DBService
<span class="token punctuation">}</span>
<span class="token comment">// ......</span>
<span class="token comment">// NewBasicUserService returns a naive, stateless implementation of UserService.</span>
<span class="token keyword">func</span> <span class="token function">NewBasicUserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> UserService <span class="token punctuation">{</span>
	basicUserSvc <span class="token operator">:=</span> <span class="token operator">&amp;</span>basicUserService<span class="token punctuation">{</span>
		<span class="token operator">&amp;</span>db<span class="token punctuation">.</span>DBService<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">:=</span> basicUserSvc<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token string">"conf/conf.moneydodo.yml"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"The UserService failed to bind with mysql"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> basicUserSvc
<span class="token punctuation">}</span>
</code></pre> 
  <p>其中，basicUserSvc.Bind(“conf/conf.moneydodo.yml”)中参数为项目根目录下的conf文件夹下的配置文件，自行编写即可，格式如下：</p> 
  <pre><code class="prism language-yml"><span class="token comment"># 服务器地址，mysql端口，用户名，密码，以及数据库名称</span>
<span class="token key atrule">host</span><span class="token punctuation">:</span> 127.0.0.1
<span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>
<span class="token key atrule">username</span><span class="token punctuation">:</span> XXXX
<span class="token key atrule">password</span><span class="token punctuation">:</span> XXXX
<span class="token key atrule">schema</span><span class="token punctuation">:</span> XXXX
</code></pre> 
  <p>至此，我们的工作重心终于集中到了业务逻辑。<br> 以GetSpec方法（根据用户id获取用户信息）为例：</p> 
  <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>basicUserService<span class="token punctuation">)</span> <span class="token function">GetSpec</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>status <span class="token builtin">bool</span><span class="token punctuation">,</span> errinfo <span class="token builtin">string</span><span class="token punctuation">,</span> data <span class="token operator">*</span>model<span class="token punctuation">.</span>User<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	data <span class="token operator">=</span> <span class="token operator">&amp;</span>model<span class="token punctuation">.</span>User<span class="token punctuation">{</span>
		Id<span class="token punctuation">:</span> id<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	status<span class="token punctuation">,</span> err <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token function">Engine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
	<span class="token keyword">if</span> status <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token punctuation">{</span>
		data <span class="token operator">=</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		errinfo <span class="token operator">=</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre> 
  <h2><a id="Transport_201"></a>Transport</h2> 
  <p>当我们书写完业务逻辑之后，我们便需要修改<code>user/http/handler.go</code><br> <strong>decode</strong><br> 以GetSpec服务为例，我们要从url中解析到userId，然后传递给业务逻辑函数：</p> 
  <pre><code class="prism language-go"><span class="token comment">// decodeGetSpecRequest is a transport/http.DecodeRequestFunc that decodes a</span>
<span class="token comment">// JSON-encoded request from the HTTP request body.</span>
<span class="token keyword">func</span> <span class="token function">decodeGetSpecRequest</span><span class="token punctuation">(</span><span class="token boolean">_</span> context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> r <span class="token operator">*</span>http1<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	vars <span class="token operator">:=</span> mux<span class="token punctuation">.</span><span class="token function">Vars</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
	id<span class="token punctuation">,</span> ok <span class="token operator">:=</span> vars<span class="token punctuation">[</span><span class="token string">"userId"</span><span class="token punctuation">]</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"not a valid ID"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	req <span class="token operator">:=</span> endpoint<span class="token punctuation">.</span>GetSpecRequest<span class="token punctuation">{</span>
		Id<span class="token punctuation">:</span> id<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> req<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> 
  <p><strong>encode</strong><br> 此函数无需修改</p> 
  <pre><code class="prism language-go"><span class="token comment">// encodeGetSpecResponse is a transport/http.EncodeResponseFunc that encodes</span>
<span class="token comment">// the response as JSON to the response writer</span>
<span class="token keyword">func</span> <span class="token function">encodeGetSpecResponse</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> w http1<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> response <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json; charset=utf-8"</span><span class="token punctuation">)</span>
	err <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre> 
  <p><strong>makeGetSpecHandler</strong><br> 在此函数中，我们需要注册路由，主要修改的是Methods、Path、handlers.AllowedMethods三个函数的参数：</p> 
  <pre><code class="prism language-go"><span class="token comment">// makeGetSpecHandler creates the handler logic</span>
<span class="token keyword">func</span> <span class="token function">makeGetSpecHandler</span><span class="token punctuation">(</span>m <span class="token operator">*</span>mux<span class="token punctuation">.</span>Router<span class="token punctuation">,</span> endpoints endpoint<span class="token punctuation">.</span>Endpoints<span class="token punctuation">,</span> options <span class="token punctuation">[</span><span class="token punctuation">]</span>http<span class="token punctuation">.</span>ServerOption<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	m<span class="token punctuation">.</span><span class="token function">Methods</span><span class="token punctuation">(</span><span class="token string">"GET"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Path</span><span class="token punctuation">(</span><span class="token string">"/api/users/{userId:[0-9]+}"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Handler</span><span class="token punctuation">(</span>
		handlers<span class="token punctuation">.</span><span class="token function">CORS</span><span class="token punctuation">(</span>
			handlers<span class="token punctuation">.</span><span class="token function">AllowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"GET"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			handlers<span class="token punctuation">.</span><span class="token function">AllowedOrigins</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"*"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span>endpoints<span class="token punctuation">.</span>GetSpecEndpoint<span class="token punctuation">,</span> decodeGetSpecRequest<span class="token punctuation">,</span> encodeGetSpecResponse<span class="token punctuation">,</span> options<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
  <h2><a id="_244"></a>运行服务</h2> 
  <p>至此，我们的user微服务基本实现，此时可以启动我们的服务：<code>go run user/cmd/main.go</code>。注意我们需要提前打开mysql，并创建相关的数据库和表。启动服务时，我们发现该服务启动了两个端口：</p> 
  <pre><code class="prism language-bash">ts<span class="token operator">=</span>2019-5-12T14:40:39.5168185Z caller<span class="token operator">=</span>service.go:80 tracer<span class="token operator">=</span>none
ts<span class="token operator">=</span>2019-5-12T14:40:39.5204223Z caller<span class="token operator">=</span>service.go:137 transport<span class="token operator">=</span>debug/HTTP addr<span class="token operator">=</span>:8080
ts<span class="token operator">=</span>2019-5-12T14:40:39.5204223Z caller<span class="token operator">=</span>service.go:102 transport<span class="token operator">=</span>HTTP addr<span class="token operator">=</span>:8081
</code></pre> 
  <p>其中，http协议端口为8081，我们的http请求使用此端口即可。<br> <strong>Post</strong><br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190512150605614.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpdXloNzM=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> <strong>Get</strong><br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190512150547714.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpdXloNzM=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> 查看数据库：<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190512144435390.png" alt="在这里插入图片描述"><br> 下面介绍一下8080端口：<br> 打开浏览器输入：127.0.0.1:8080/metrics，我们即可看到：<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190512151224199.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpdXloNzM=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> 此服务其实就是go-kit组件中的metrics服务，实现了跟踪计数、延迟、健康状况和其他的周期性的或针对每个请求信息的仪表盘化。</p> 
  <h2><a id="_262"></a>其他</h2> 
  <ol> 
   <li>当我们调用<code>kit g s xxxx -w --gorilla</code>生成好服务之后发现自己定义的service.go内interface中函数（endpoint）参数书写有问题应该怎么办？<br> 第一种方法便是修改参数后，删除之前的服务再次运行命令生成服务，但是这样的做法显然不是很好，尤其是我们做了大量改动之后。<br> 另一种方法便是自行修改gokit-cli生成代码，其实参数修改之后，我们需要更改<code>pkg/service/service.go</code>、<code>pkg/service/middleware.go</code>、<code>pkg/http/handler.go</code>、<code>pkg/endpoint/endpoint.go</code>等文件中与此函数相关的部分函数的参数，如果不确定需要修改哪些函数，我们可以尝试启动服务，报错位置便是我们需要修改的地方。<br> 如果是我们新增了一个endpoint，我们可以直接运行<code>kit g s xxx -w --gorilla</code>生成服务。</li> 
   <li>如何修改服务端口号？<br> <code>cmd/service/service.go</code>文件中定义了服务端口号：</li> 
  </ol> 
  <pre><code class="prism language-go"><span class="token keyword">var</span> debugAddr <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"debug.addr"</span><span class="token punctuation">,</span> <span class="token string">":8080"</span><span class="token punctuation">,</span> <span class="token string">"Debug and metrics listen address"</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> httpAddr <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"http-addr"</span><span class="token punctuation">,</span> <span class="token string">":8081"</span><span class="token punctuation">,</span> <span class="token string">"HTTP listen address"</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> grpcAddr <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"grpc-addr"</span><span class="token punctuation">,</span> <span class="token string">":8082"</span><span class="token punctuation">,</span> <span class="token string">"gRPC listen address"</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> thriftAddr <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"thrift-addr"</span><span class="token punctuation">,</span> <span class="token string">":8083"</span><span class="token punctuation">,</span> <span class="token string">"Thrift listen address"</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> thriftProtocol <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"thrift-protocol"</span><span class="token punctuation">,</span> <span class="token string">"binary"</span><span class="token punctuation">,</span> <span class="token string">"binary, compact, json, simplejson"</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> thriftBuffer <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">"thrift-buffer"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"0 for unbuffered"</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> thriftFramed <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">Bool</span><span class="token punctuation">(</span><span class="token string">"thrift-framed"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"true to enable framing"</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> zipkinURL <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"zipkin-url"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"Enable Zipkin tracing via a collector URL e.g. http://localhost:9411/api/v1/spans"</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> lightstepToken <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"lightstep-token"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"Enable LightStep tracing via a LightStep access token"</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> appdashAddr <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"appdash-addr"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"Enable Appdash tracing via an Appdash server host:port"</span><span class="token punctuation">)</span>
</code></pre> 
  <p>我们可以根据需要开启、关闭或者修改端口号。</p> 
 </div> 
 <link href="https://csdnimg.cn/release/phoenix/mdeditor/markdown_views-258a4616f7.css" rel="stylesheet"> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
