<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Sharding-JDBC的实践 « NotBeCN</title>
  <meta name="description" content="                   基本概念   这几天在研究分表分库的方案。综合了几种数据库方案。  最后选型Sharding-jdbc。它主要有如下几个优点。       支持分布式事务    适用于任何基于Java的ORM框架。    对业务零侵入。      数据分片   数据分片是指按照某个维度将存放...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2019/05/12/u014534808_90138993.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">Sharding-JDBC的实践</h1>
    <p class="post-meta">May 12, 2019</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">  
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div id="content_views" class="markdown_views prism-atom-one-dark"> 
  <!-- flowchart 箭头图标 勿删 --> 
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
   <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
  </svg> 
  <h2><a id="_0"></a>基本概念</h2> 
  <p>这几天在研究分表分库的方案。综合了几种数据库方案。<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190512121433947.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTQ1MzQ4MDg=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> 最后选型Sharding-jdbc。它主要有如下几个优点。</p> 
  <ol> 
   <li>支持分布式事务</li> 
   <li>适用于任何基于Java的ORM框架。</li> 
   <li>对业务零侵入。</li> 
  </ol> 
  <h2><a id="_7"></a>数据分片</h2> 
  <p>数据分片是指按照某个维度将存放在单一数据库中的数据分散地存放至多个数据库或者表中以达到提升性能瓶颈以及可用性的效果。数据分片有效手段是对关系型数据库进行分库和分表。分表可以降低每个单表的数据阈值，同时还能够将分布式事务转化为本地事务的。分库可以有效的分散数据库单点的访问量。</p> 
  <h3><a id="_9"></a>分片键</h3> 
  <p>用于分片的数据库字段，是将数据库（表）进行水平拆分的关键字段。例如：将订单表中的订单主键的尾数取模分批拿，则订单主键就是分片字段，SQL中如果没有分片字段，则执行全库路由，性能较差。Sharding-JDBC也支持多个字段进行分片。</p> 
  <h3><a id="_11"></a>分片策略和分片算法</h3> 
  <p>Sharding-JDBC 中共有五种分片策略。1、标准分片策略；2、复合分片策略；3、行表达式分片策略；4、Hint分片策略；5、不分片策略；对应的有4种分片算法，1、精确分片算法；2、范围分片算法；3、复合分片算法 ；4、Hint分片算法；<br> 分片算法：<br> Sharding-JDBC并没有提供内置分片算法，而是通过分片策略将各种场景提炼出来，提供更高层次的抽象，并提供接口让应用开发者自行实现分片算法。<br> 分片策略：<br> 包含分片键和分片算法，由于分片算法的独立性，将其独立抽离。真正可用于分片操作的是分片键+分片算法，也就是分片策略。</p> 
  <table> 
   <thead> 
    <tr> 
     <th>分片策略</th> 
     <th>概念</th> 
     <th>分片算法</th> 
     <th>概念</th> 
     <th>适用场景</th> 
    </tr> 
   </thead> 
   <tbody> 
    <tr> 
     <td>标准分片策略</td> 
     <td>对应StandardShardingStrategy,只支持单分片键,提供对SQL语句中的=，IN和BETWEEN AND的分片操作支持,提供PreciseShardingAlgorithm和RangeShardingAlgorithm两个分片算法。</td> 
     <td>精确分片算法</td> 
     <td>对应PreciseShardingAlgorithm</td> 
     <td>适用于单分片键的= 和IN进行分片的场景。需要配合StandardShardingStrategy使用</td> 
    </tr> 
    <tr> 
     <td>标准分片策略</td> 
     <td></td> 
     <td>范围分片算法</td> 
     <td>对应RangeShardingAlgorithm</td> 
     <td>适用于单分片键的BETWEEN AND进行分片的场景，需要配合StandardShardingStrategy使用</td> 
    </tr> 
    <tr> 
     <td>复合分片策略</td> 
     <td>对应ComplexShardingStrategy。听过对SQL语句中的=，IN的分片操作支持。由于多分片键之间的关系复杂，因此并未进行过多的封装，而是直接将分片键组合以及分片操作符透传至分片算法</td> 
     <td>复合分片算法</td> 
     <td>对应ComplexKeysShardingAlgorithm</td> 
     <td>适用于多分片键的情况，需要配合ComplexShardingStrategy使用</td> 
    </tr> 
    <tr> 
     <td>Hint分片策略</td> 
     <td>对应HintShardingStrategy。通过Hint而非SQL解析的方式分片的策略。</td> 
     <td>Hint分片算法</td> 
     <td>对应HintShardingAlgorithm</td> 
     <td>适用于使用Hint分片的场景，需要配合HintShardingStrategy使用</td> 
    </tr> 
    <tr> 
     <td>Hint分片策略</td> 
     <td>对应InlineShardingStrategy。使用Groovy的表达式，提供对SQL语句中的=和IN的分片操作支持，只支持单分片键。对于简单的分片算法，可以通过简单的配置使用，从而避免繁琐的Java代码开发，如: t_user_$-&gt;{u_id % 8} 表示t_user表根据u_id模8，而分成8张表，表名称为t_user_0到t_user_7。</td> 
     <td></td> 
     <td></td> 
     <td></td> 
    </tr> 
   </tbody> 
  </table>
  <h2><a id="ShardingJDBCSpringBoot_25"></a>Sharding-JDBC与SpringBoot整合策略</h2> 
  <h3><a id="_27"></a>总体说明</h3> 
  <p>本实例是结合相关项目来的，在该项目中订单id（orders_id）是一个核心的热点字段。然后，订单号是带有日期的，所以，本次分片的方案是安装时间分库分表，时间粒度可以年，月，季度。本demo中的时间粒度是年。</p> 
  <h3><a id="_29"></a>引入依赖</h3> 
  <pre><code class="prism language-xml">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>sharding-sphere.version</span><span class="token punctuation">&gt;</span></span>4.0.0-RC1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>sharding-sphere.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
     <span class="token comment">&lt;!--shardingsphere --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.shardingsphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sharding-core-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${sharding-sphere.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.shardingsphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sharding-jdbc-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${sharding-sphere.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
  <p>配置好依赖之后，接着就是配置数据源，以及数据的分片键，分片策略。在application.yml中配置如下</p> 
  <h3><a id="_47"></a>配置</h3> 
  <pre><code class="prism language-yml"><span class="token comment">#数据库连接</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">shardingsphere</span><span class="token punctuation">:</span>
    <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
      <span class="token key atrule">names</span><span class="token punctuation">:</span> shard_order_0<span class="token punctuation">,</span>shard_order_1
      <span class="token key atrule">shard_order_0</span><span class="token punctuation">:</span>
          <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
          <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/shard_order_0
          <span class="token key atrule">username</span><span class="token punctuation">:</span> root
          <span class="token key atrule">password</span><span class="token punctuation">:</span> admin
      <span class="token key atrule">shard_order_1</span><span class="token punctuation">:</span>
          <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
          <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/shard_order_1
          <span class="token key atrule">username</span><span class="token punctuation">:</span> root
          <span class="token key atrule">password</span><span class="token punctuation">:</span> admin
<span class="token comment"># 如下对orders表和orders_detail都做了分片配置，分片键分别是id，orders_id，</span>
    <span class="token key atrule">sharding</span><span class="token punctuation">:</span>
      <span class="token key atrule">tables</span><span class="token punctuation">:</span>
        <span class="token key atrule">orders</span><span class="token punctuation">:</span>
          <span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> shard_order_$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>.orders_$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>
          <span class="token key atrule">databaseStrategy</span><span class="token punctuation">:</span>
            <span class="token key atrule">inline</span><span class="token punctuation">:</span>
              <span class="token key atrule">shardingColumn</span><span class="token punctuation">:</span>  adddate
          <span class="token key atrule">tableStrategy</span><span class="token punctuation">:</span>
              <span class="token key atrule">inline</span><span class="token punctuation">:</span>
                <span class="token key atrule">shardingColumn</span><span class="token punctuation">:</span> id
        <span class="token key atrule">orders_detail</span><span class="token punctuation">:</span>
          <span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> shard_order_$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>.orders_detail_$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>
          <span class="token key atrule">tableStrategy</span><span class="token punctuation">:</span>
            <span class="token key atrule">inline</span><span class="token punctuation">:</span>
              <span class="token key atrule">shardingColumn</span><span class="token punctuation">:</span> orders_id     
</code></pre> 
  <p>如上可以看出，我这里配置了两个分库shard_order_0和shard_order_1；然后，每个分库下面又配置了两个逻辑表orders和orders_detail，每个逻辑表下有两个物理表。数据库的分片键是adddate，逻辑表orders的分片键是id，逻辑表orders_detail的分片键是orders_id。<br> 完成配置之后接着就是要定义数据库的分片策略和分片的策略以及初始化DataSource。因为本次在主库中加了一个路由表，在路由时动态查取该分片值所需要查找的分库分表，所以，需要再多配置一个数据源。<strong>用于执行分库的算法时可以查询路由表</strong>，项目结构如图所示：<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190512121510515.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTQ1MzQ4MDg=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> 
  <h3><a id="_85"></a>分库的数据源配置</h3> 
  <pre><code class="prism language-java"><span class="token comment">//*** DataSourceConfig</span>
    <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">*</span>
     <span class="token operator">*</span> 设置数据源
     <span class="token operator">*</span> @<span class="token keyword">return</span>
     <span class="token operator">*</span> @<span class="token keyword">throws</span> SQLException
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"shardingDataSource"</span><span class="token punctuation">)</span>
    DataSource <span class="token function">getShardingDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> SQLException <span class="token punctuation">{</span>
        ShardingRuleConfiguration shardingRuleConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShardingRuleConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        shardingRuleConfig<span class="token punctuation">.</span><span class="token function">getBindingTableGroups</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ordersLogicTable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        shardingRuleConfig<span class="token punctuation">.</span><span class="token function">getBindingTableGroups</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ordersDetailLogicTable<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 配置Orders表规则</span>
       shardingRuleConfig<span class="token punctuation">.</span><span class="token function">getTableRuleConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">getOrderTableRuleConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//配置ordersItem表规则</span>
        shardingRuleConfig<span class="token punctuation">.</span><span class="token function">getTableRuleConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">getOrderDetailTableRuleConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        shardingRuleConfig<span class="token punctuation">.</span><span class="token function">setDefaultDatabaseShardingStrategyConfig</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StandardShardingStrategyConfiguration</span><span class="token punctuation">(</span>databaseShardingColumn<span class="token punctuation">,</span> preciseModuloDatabaseShardingAlgorithm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        shardingRuleConfig<span class="token punctuation">.</span><span class="token function">setDefaultDatabaseShardingStrategyConfig</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StandardShardingStrategyConfiguration</span><span class="token punctuation">(</span>ordersShardingColumn<span class="token punctuation">,</span>preciseModuloTableShardingAlgorithm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//设置默认数据库</span>
        shardingRuleConfig<span class="token punctuation">.</span><span class="token function">setDefaultDataSourceName</span><span class="token punctuation">(</span>defaultDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> ShardingDataSourceFactory<span class="token punctuation">.</span><span class="token function">createDataSource</span><span class="token punctuation">(</span><span class="token function">createDataSourceMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> shardingRuleConfig<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/** * 获取sqlSessionFactory实例 * @param shardingDataSource * @return * @throws Exception */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Primary</span>
    <span class="token keyword">public</span> SqlSessionFactory <span class="token function">sqlSessionFactory</span><span class="token punctuation">(</span>DataSource shardingDataSource<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        SqlSessionFactoryBean bean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bean<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>shardingDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bean<span class="token punctuation">.</span><span class="token function">setMapperLocations</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PathMatchingResourcePatternResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span>mapperLocations<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	
	    TableRuleConfiguration <span class="token function">getOrderTableRuleConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        TableRuleConfiguration orderTableRuleConfig<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">TableRuleConfiguration</span><span class="token punctuation">(</span>ordersLogicTable<span class="token punctuation">,</span> ordersActualDataNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderTableRuleConfig<span class="token punctuation">.</span><span class="token function">setDatabaseShardingStrategyConfig</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StandardShardingStrategyConfiguration</span><span class="token punctuation">(</span>databaseShardingColumn<span class="token punctuation">,</span> preciseModuloDatabaseShardingAlgorithm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderTableRuleConfig<span class="token punctuation">.</span><span class="token function">setTableShardingStrategyConfig</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StandardShardingStrategyConfiguration</span><span class="token punctuation">(</span>ordersShardingColumn<span class="token punctuation">,</span>preciseModuloTableShardingAlgorithm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> orderTableRuleConfig<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    TableRuleConfiguration <span class="token function">getOrderDetailTableRuleConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        TableRuleConfiguration orderDetailTableRuleConfig<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">TableRuleConfiguration</span><span class="token punctuation">(</span>ordersDetailLogicTable<span class="token punctuation">,</span> ordersDetailActualDataNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDetailTableRuleConfig<span class="token punctuation">.</span><span class="token function">setDatabaseShardingStrategyConfig</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StandardShardingStrategyConfiguration</span><span class="token punctuation">(</span>databaseShardingColumn<span class="token punctuation">,</span> preciseModuloDatabaseShardingAlgorithm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDetailTableRuleConfig<span class="token punctuation">.</span><span class="token function">setTableShardingStrategyConfig</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StandardShardingStrategyConfiguration</span><span class="token punctuation">(</span>ordersDetailShardingColumn<span class="token punctuation">,</span> orderDetailTableShardingAlgorithm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> orderDetailTableRuleConfig<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	
</code></pre> 
  <p>如上，可以看出orders和orders_detail 两个逻辑表都采用的标准分片策略，使用的是精确分片算法。分库的策略也是标准分片策略，使用的是精确分片算法。</p> 
  <h3><a id="_144"></a>数据库的分库策略</h3> 
  <pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">"preciseModuloDatabaseShardingAlgorithm"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DatabaseShardingAlgorithm</span> <span class="token keyword">implements</span> <span class="token class-name">PreciseShardingAlgorithm</span><span class="token generics function"><span class="token punctuation">&lt;</span>Timestamp<span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>

    SimpleDateFormat df <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//定义格式，不显示毫秒</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> ShardConfigMapper shardConfigMapper<span class="token punctuation">;</span>

    <span class="token comment">/** * * @param collection * @param preciseShardingValue * @return */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> String <span class="token function">doSharding</span><span class="token punctuation">(</span>Collection<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> collection<span class="token punctuation">,</span> PreciseShardingValue<span class="token generics function"><span class="token punctuation">&lt;</span>Timestamp<span class="token punctuation">&gt;</span></span> preciseShardingValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String physicDatabase <span class="token operator">=</span> null<span class="token punctuation">;</span>
        Timestamp valueTime <span class="token operator">=</span> preciseShardingValue<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String orgValue <span class="token operator">=</span> df<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>valueTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        String subValue <span class="token operator">=</span> orgValue<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        physicDatabase <span class="token operator">=</span> <span class="token function">getShardConfig</span><span class="token punctuation">(</span>physicDatabase<span class="token punctuation">,</span> subValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>physicDatabase<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"-----&gt;该分片键值找不到对应的分库,默认取第一个库，分片键是={}，逻辑表是={},分片值是={}"</span><span class="token punctuation">,</span>preciseShardingValue<span class="token punctuation">.</span><span class="token function">getColumnName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>preciseShardingValue<span class="token punctuation">.</span><span class="token function">getLogicTableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>preciseShardingValue<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>String value <span class="token operator">:</span> collection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                physicDatabase <span class="token operator">=</span> value<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> physicDatabase<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> String <span class="token function">getShardConfig</span><span class="token punctuation">(</span>String physicDatabase <span class="token punctuation">,</span>String subValue <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ShardConfig shardConfig <span class="token operator">=</span> shardConfigMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>subValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shardConfig <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            physicDatabase <span class="token operator">=</span> shardConfig<span class="token punctuation">.</span><span class="token function">getConfigValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> physicDatabase<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
  <p>如上分片键是adddate，当SQL中含有adddate字段时会执行分片策略。如果SQL中adddate 字段是BETWEEN AND 需要执行复合分片算法。否则会全库查询。因为是按照年份来分库的，所以先截取当前的年份，然后去路由表中查。对应的分库id。分表策略也是类似的。</p> 
  <h3><a id="_192"></a>路由表</h3> 
  <p>接着我们来看看路由表，路由表是该分库分表方案中的核心表。表结构如下：<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190512121544798.png" alt="在这里插入图片描述"><br> 表的数据存储如下：<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190512121557228.png" alt="在这里插入图片描述"><br> 如上图所示，路由表中按照年份存放了，每个年份所对应的分库id，和分表id。所以当有分片键，进入分表策略时就可以根据年份找到对应的分库，分表。</p> 
  <h3><a id="_199"></a>多数据源配置</h3> 
  <p>由于路由表是公共表，不参与分片，所以只在主库中存储了一份。当进入数据库的分库策略时就要查询路由表。如果不配置多数据源的话，此时路由表对应的shardConfigMapper为null。不能进行查询。过需要配置多数据源。</p> 
  <pre><code class="prism language-java"><span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">"com.jay.mapper.nosharding"</span><span class="token punctuation">,</span> sqlSessionTemplateRef <span class="token operator">=</span> <span class="token string">"noshardingSqlSessionTemplate"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NoShardingDataSourceConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${spring.shardingsphere.datasource.shard_order_0.username}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String username0<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${spring.shardingsphere.datasource.shard_order_0.url}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String url0<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${spring.shardingsphere.datasource.shard_order_0.password}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String password0<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"noshardingDataSource"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> DataSource <span class="token function">testDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        BasicDataSource result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">setDriverClassName</span><span class="token punctuation">(</span>com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>Driver<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>url0<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>username0<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>password0<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** * 获取sqlSessionFactory实例 * * @param shardingDataSource * @return * @throws Exception */</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"noshardingSqlSessionFactory"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> SqlSessionFactory <span class="token function">sqlSessionFactory</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"noshardingDataSource"</span><span class="token punctuation">)</span> DataSource shardingDataSource<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        SqlSessionFactoryBean bean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bean<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>shardingDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bean<span class="token punctuation">.</span><span class="token function">setMapperLocations</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PathMatchingResourcePatternResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token string">"classpath:mapper/nosharding/*.xml"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> 
  <h2><a id="_239"></a>总结</h2> 
  <p>本文首先介绍了分库分表的相关概念，然后，对比了几种主流的分库分表中间件。接着重点介绍了分片策略和相关的算法。最后通过一个demo，实现了对Sharding-JDBC 数据分片的落地。</p> 
  <h2><a id="_241"></a>参考资料</h2> 
  <p><a href="https://shardingsphere.apache.org/document/current/cn/features/sharding/" rel="nofollow">Sharding-JDBC官方文档</a></p> 
 </div> 
 <link href="https://csdnimg.cn/release/phoenix/mdeditor/markdown_views-258a4616f7.css" rel="stylesheet"> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
