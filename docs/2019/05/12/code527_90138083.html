<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>IOå¤šè·¯å¤ç”¨ Â« NotBeCN</title>
  <meta name="description" content="                      1ã€åŸºæœ¬æ¦‚å¿µ    2ã€å¸¸è§çš„5ç§IOæ¨¡å‹    3ã€IOå¤šè·¯å¤ç”¨select           selectåŸç†      selectå‡½æ•°      selectæµ‹è¯•      selectè¿è¡Œ      selectæ€»ç»“          4ã€IOå¤šè·¯å¤ç”¨pol...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2019/05/12/code527_90138083.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">å…³äº</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">ç¤¾åŒº</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">å°„ä¸ªé¸­å­</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">IOå¤šè·¯å¤ç”¨</h1>
    <p class="post-meta">May 12, 2019</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div id="content_views" class="markdown_views prism-atom-one-dark"> 
  <!-- flowchart ç®­å¤´å›¾æ ‡ å‹¿åˆ  --> 
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
   <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
  </svg> 
  <ul> 
   <li><a href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5" rel="nofollow">1ã€åŸºæœ¬æ¦‚å¿µ</a></li> 
   <li><a href="#%E5%B8%B8%E8%A7%81%E7%9A%845%E7%A7%8DIO%E6%A8%A1%E5%9E%8B" rel="nofollow">2ã€å¸¸è§çš„5ç§IOæ¨¡å‹</a></li> 
   <li><a href="#IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8select" rel="nofollow">3ã€IOå¤šè·¯å¤ç”¨select</a> 
    <ul> 
     <li><a href="#select%E5%8E%9F%E7%90%86" rel="nofollow">selectåŸç†</a></li> 
     <li><a href="#select%E5%87%BD%E6%95%B0" rel="nofollow">selectå‡½æ•°</a></li> 
     <li><a href="#select%E6%B5%8B%E8%AF%95" rel="nofollow">selectæµ‹è¯•</a></li> 
     <li><a href="#select%E8%BF%90%E8%A1%8C" rel="nofollow">selectè¿è¡Œ</a></li> 
     <li><a href="#select%E6%80%BB%E7%BB%93" rel="nofollow">selectæ€»ç»“</a></li> 
    </ul> </li> 
   <li><a href="#IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8poll" rel="nofollow">4ã€IOå¤šè·¯å¤ç”¨poll</a> 
    <ul> 
     <li><a href="#poll%E5%8E%9F%E7%90%86" rel="nofollow">pollåŸç†</a></li> 
     <li><a href="#poll%E5%87%BD%E6%95%B0" rel="nofollow">pollå‡½æ•°</a></li> 
     <li><a href="#poll%E6%B5%8B%E8%AF%95" rel="nofollow">pollæµ‹è¯•</a></li> 
     <li><a href="#poll%E8%BF%90%E8%A1%8C" rel="nofollow">pollè¿è¡Œ</a></li> 
     <li><a href="#poll%E6%80%BB%E7%BB%93" rel="nofollow">pollæ€»ç»“</a></li> 
    </ul> </li> 
   <li><a href="#IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8epoll" rel="nofollow">5ã€IOå¤šè·¯å¤ç”¨epoll</a> 
    <ul> 
     <li><a href="#epoll%E5%8E%9F%E7%90%86" rel="nofollow">epollåŸç†</a></li> 
     <li><a href="#epoll%E5%87%BD%E6%95%B0" rel="nofollow">epollå‡½æ•°</a></li> 
     <li><a href="#epoll%E6%A8%A1%E5%BC%8F" rel="nofollow">epollæ¨¡å¼</a></li> 
     <li><a href="#epoll%E6%B5%8B%E8%AF%95" rel="nofollow">epollæµ‹è¯•</a></li> 
     <li><a href="#epoll%E8%BF%90%E8%A1%8C" rel="nofollow">epollè¿è¡Œ</a></li> 
     <li><a href="#epoll%E6%80%BB%E7%BB%93" rel="nofollow">epollæ€»ç»“</a></li> 
    </ul> </li> 
   <li><a href="#select%E3%80%81poll%E3%80%81epoll%E5%8C%BA%E5%88%AB" rel="nofollow">6ã€selectã€pollã€epollåŒºåˆ«</a> 
    <ul> 
     <li><a href="#%E6%9C%80%E5%A4%A7%E8%BF%9E%E6%8E%A5%E6%95%B0" rel="nofollow">1ã€æœ€å¤§è¿æ¥æ•°</a></li> 
     <li><a href="#IO%E6%95%88%E7%8E%87%E9%97%AE%E9%A2%98" rel="nofollow">2ã€IOæ•ˆç‡é—®é¢˜</a></li> 
     <li><a href="#%E6%B6%88%E6%81%AF%E4%BC%A0%E9%80%92%E6%96%B9%E5%BC%8F" rel="nofollow">3ã€æ¶ˆæ¯ä¼ é€’æ–¹å¼</a></li> 
    </ul> </li> 
  </ul> 
  <h1><a id="1_28"></a>1ã€åŸºæœ¬æ¦‚å¿µ</h1> 
  <p>IOå¤šè·¯å¤ç”¨æ˜¯æŒ‡å†…æ ¸ä¸€æ—¦å‘ç°è¿›ç¨‹æŒ‡å®šçš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªIOæ¡ä»¶å‡†å¤‡è¯»å–ï¼Œå®ƒå°±é€šçŸ¥è¯¥è¿›ç¨‹ã€‚IOå¤šè·¯å¤ç”¨é€‚ç”¨å¦‚ä¸‹åœºåˆï¼š</p> 
  <blockquote> 
   <p>ï¼ˆ1ï¼‰å½“å®¢æˆ·å¤„ç†å¤šä¸ªæè¿°å­—æ—¶ï¼ˆä¸€èˆ¬æ˜¯äº¤äº’å¼è¾“å…¥å’Œç½‘ç»œå¥—æ¥å£ï¼‰ï¼Œå¿…é¡»ä½¿ç”¨I/Oå¤ç”¨ã€‚</p> 
   <p>ï¼ˆ2ï¼‰å½“ä¸€ä¸ªå®¢æˆ·åŒæ—¶å¤„ç†å¤šä¸ªå¥—æ¥å£æ—¶ï¼Œè€Œè¿™ç§æƒ…å†µæ˜¯å¯èƒ½çš„ï¼Œä½†å¾ˆå°‘å‡ºç°ã€‚</p> 
   <p>ï¼ˆ3ï¼‰å¦‚æœä¸€ä¸ªTCPæœåŠ¡å™¨æ—¢è¦å¤„ç†ç›‘å¬å¥—æ¥å£ï¼Œåˆè¦å¤„ç†å·²è¿æ¥å¥—æ¥å£ï¼Œä¸€èˆ¬ä¹Ÿè¦ç”¨åˆ°I/Oå¤ç”¨ã€‚</p> 
   <p>ï¼ˆ4ï¼‰å¦‚æœä¸€ä¸ªæœåŠ¡å™¨å³è¦å¤„ç†TCPï¼Œåˆè¦å¤„ç†UDPï¼Œä¸€èˆ¬è¦ä½¿ç”¨I/Oå¤ç”¨ã€‚</p> 
   <p>ï¼ˆ5ï¼‰å¦‚æœä¸€ä¸ªæœåŠ¡å™¨è¦å¤„ç†å¤šä¸ªæœåŠ¡æˆ–å¤šä¸ªåè®®ï¼Œä¸€èˆ¬è¦ä½¿ç”¨I/Oå¤ç”¨ã€‚</p> 
  </blockquote> 
  <p>ä¸å¤šè¿›ç¨‹å’Œå¤šçº¿ç¨‹æŠ€æœ¯ç›¸æ¯”ï¼ŒI/Oå¤šè·¯å¤ç”¨æŠ€æœ¯çš„æœ€å¤§ä¼˜åŠ¿æ˜¯ç³»ç»Ÿå¼€é”€å°ï¼Œç³»ç»Ÿä¸å¿…åˆ›å»ºè¿›ç¨‹/çº¿ç¨‹ï¼Œä¹Ÿä¸å¿…ç»´æŠ¤è¿™äº›è¿›ç¨‹/çº¿ç¨‹ï¼Œä»è€Œå¤§å¤§å‡å°äº†ç³»ç»Ÿçš„å¼€é”€ã€‚</p> 
  <p>æ€»è€Œè¨€ä¹‹ï¼ŒIOå¤šè·¯å¤ç”¨å°±æ˜¯ï¼š<strong>ä¸€ä¸ªçº¿ç¨‹ï¼Œé€šè¿‡è®°å½•I/Oæµçš„çŠ¶æ€æ¥åŒæ—¶ç®¡ç†å¤šä¸ªI/Oï¼Œå¯ä»¥æé«˜æœåŠ¡å™¨çš„ååèƒ½åŠ›</strong>ã€‚</p> 
  <h1><a id="25IO_46"></a>2ã€å¸¸è§çš„5ç§IOæ¨¡å‹</h1> 
  <pre><code class="prism language-c"><span class="token number">1.</span>é˜»å¡I<span class="token operator">/</span>Oæ¨¡å‹
éš”å£è€ç‹å»ç«è½¦ç«™ä¹°ç¥¨ï¼Œæ’é˜Ÿä¸‰å¤©ä¹°åˆ°ä¸€å¼ é€€ç¥¨ã€‚
è€—è´¹ï¼šåœ¨è½¦ç«™åƒå–æ‹‰æ’’ç¡ <span class="token number">3</span> å¤©ï¼Œå…¶å®ƒäº‹ä¸€ä»¶æ²¡å¹²ã€‚
</code></pre> 
  <pre><code class="prism language-c"><span class="token number">2.</span>éé˜»å¡I<span class="token operator">/</span>Oæ¨¡å‹
éš”å£è€ç‹å»ç«è½¦ç«™ä¹°ç¥¨ï¼Œéš” <span class="token number">12</span> å°æ—¶å»ç«è½¦ç«™é—®æœ‰æ²¡æœ‰é€€ç¥¨ï¼Œä¸‰å¤©åä¹°åˆ°ä¸€å¼ ç¥¨ã€‚
è€—è´¹ï¼šå¾€è¿”è½¦ç«™ <span class="token number">6</span> æ¬¡ï¼Œè·¯ä¸Š <span class="token number">6</span> å°æ—¶ï¼Œå…¶å®ƒæ—¶é—´åšäº†å¥½å¤šäº‹ã€‚
</code></pre> 
  <pre><code class="prism language-c"><span class="token number">3.</span>I<span class="token operator">/</span>Oå¤ç”¨æ¨¡å‹
â‘  select<span class="token operator">/</span>poll
éš”å£è€ç‹å»ç«è½¦ç«™ä¹°ç¥¨ï¼Œå§”æ‰˜é»„ç‰›ï¼Œç„¶åæ¯éš” <span class="token number">6</span> å°æ—¶ç”µè¯é»„ç‰›è¯¢é—®ï¼Œé»„ç‰›ä¸‰å¤©å†…ä¹°åˆ°ç¥¨ï¼Œç„¶åéš”å£è€ç‹å»ç«è½¦ç«™äº¤é’±é¢†ç¥¨ã€‚
è€—è´¹ï¼šå¾€è¿”è½¦ç«™ <span class="token number">2</span> æ¬¡ï¼Œè·¯ä¸Š <span class="token number">2</span> å°æ—¶ï¼Œé»„ç‰›æ‰‹ç»­è´¹ <span class="token number">100</span> å…ƒï¼Œæ‰“ç”µè¯ <span class="token number">17</span> æ¬¡ã€‚
â‘¡ epoll
éš”å£è€ç‹å»ç«è½¦ç«™ä¹°ç¥¨ï¼Œå§”æ‰˜é»„ç‰›ï¼Œé»„ç‰›ä¹°åˆ°åå³é€šçŸ¥éš”å£è€ç‹å»é¢†ï¼Œç„¶åéš”å£è€ç‹å»ç«è½¦ç«™äº¤é’±é¢†ç¥¨ã€‚
è€—è´¹ï¼šå¾€è¿”è½¦ç«™ <span class="token number">2</span> æ¬¡ï¼Œè·¯ä¸Š <span class="token number">2</span> å°æ—¶ï¼Œé»„ç‰›æ‰‹ç»­è´¹ <span class="token number">100</span> å…ƒï¼Œæ— éœ€æ‰“ç”µè¯
</code></pre> 
  <pre><code class="prism language-c"><span class="token number">4.</span>ä¿¡å·é©±åŠ¨I<span class="token operator">/</span>Oæ¨¡å‹
éš”å£è€ç‹å»ç«è½¦ç«™ä¹°ç¥¨ï¼Œç»™å”®ç¥¨å‘˜ç•™ä¸‹ç”µè¯ï¼Œæœ‰ç¥¨åï¼Œå”®ç¥¨å‘˜ç”µè¯é€šçŸ¥éš”å£è€ç‹ï¼Œç„¶åéš”å£è€ç‹å»ç«è½¦ç«™äº¤é’±é¢†ç¥¨ã€‚
è€—è´¹ï¼šå¾€è¿”è½¦ç«™ <span class="token number">2</span> æ¬¡ï¼Œè·¯ä¸Š <span class="token number">2</span> å°æ—¶ï¼Œå…é»„ç‰›è´¹ <span class="token number">100</span> å…ƒï¼Œæ— éœ€æ‰“ç”µè¯
</code></pre> 
  <pre><code class="prism language-c"><span class="token number">5.</span>å¼‚æ­¥I<span class="token operator">/</span>Oæ¨¡å‹
éš”å£è€ç‹å»ç«è½¦ç«™ä¹°ç¥¨ï¼Œç»™å”®ç¥¨å‘˜ç•™ä¸‹ç”µè¯ï¼Œæœ‰ç¥¨åï¼Œå”®ç¥¨å‘˜ç”µè¯é€šçŸ¥éš”å£è€ç‹å¹¶å¿«é€’é€ç¥¨ä¸Šé—¨ã€‚
è€—è´¹ï¼šå¾€è¿”è½¦ç«™ <span class="token number">1</span> æ¬¡ï¼Œè·¯ä¸Š <span class="token number">1</span> å°æ—¶ï¼Œå…é»„ç‰›è´¹ <span class="token number">100</span> å…ƒï¼Œæ— éœ€æ‰“ç”µè¯
</code></pre> 
  <h1><a id="3IOselect_82"></a>3ã€IOå¤šè·¯å¤ç”¨select</h1> 
  <h2><a id="select_84"></a>selectåŸç†</h2> 
  <p>è¯¥å‡½æ•°å‡†è®¸è¿›ç¨‹æŒ‡ç¤ºå†…æ ¸ç­‰å¾…å¤šä¸ªäº‹ä»¶ä¸­çš„ä»»ä½•ä¸€ä¸ªå‘é€ï¼Œå¹¶åªåœ¨æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªäº‹ä»¶å‘ç”Ÿæˆ–ç»å†ä¸€æ®µæŒ‡å®šçš„æ—¶é—´åæ‰å”¤é†’ã€‚</p> 
  <h2><a id="select_88"></a>selectå‡½æ•°</h2> 
  <pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxfdp1<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>readset<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>writeset<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>exceptset<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> timeval <span class="token operator">*</span>timeout<span class="token punctuation">)</span>
</code></pre> 
  <blockquote> 
   <p>å‡½æ•°å‚æ•°ä»‹ç»å¦‚ä¸‹ï¼š</p> 
   <p>ï¼ˆ1ï¼‰ç¬¬ä¸€ä¸ªå‚æ•°maxfdp1æŒ‡å®šå¾…æµ‹è¯•çš„æè¿°å­—ä¸ªæ•°ï¼Œå®ƒçš„å€¼æ˜¯å¾…æµ‹è¯•çš„æœ€å¤§æè¿°å­—åŠ 1ï¼ˆå› æ­¤æŠŠè¯¥å‚æ•°å‘½åä¸ºmaxfdp1ï¼‰ï¼Œæè¿°å­—0ã€1ã€2â€¦maxfdp1-1å‡å°†è¢«æµ‹è¯•ã€‚å› ä¸ºæ–‡ä»¶æè¿°ç¬¦æ˜¯ä»0å¼€å§‹çš„ã€‚</p> 
   <p>ï¼ˆ2ï¼‰ä¸­é—´çš„ä¸‰ä¸ªå‚æ•°readsetã€writeset å’Œ exceptset æŒ‡å®šæˆ‘ä»¬è¦è®©å†…æ ¸æµ‹è¯•è¯»ã€å†™å’Œå¼‚å¸¸æ¡ä»¶çš„æè¿°å­—ã€‚å¦‚æœå¯¹æŸä¸€ä¸ªçš„æ¡ä»¶ä¸æ„Ÿå…´è¶£ï¼Œå°±å¯ä»¥æŠŠå®ƒè®¾ä¸ºç©ºæŒ‡é’ˆã€‚struct fd_setå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªé›†åˆï¼Œè¿™ä¸ªé›†åˆä¸­å­˜æ”¾çš„æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œå¯é€šè¿‡ä»¥ä¸‹å››ä¸ªå®è¿›è¡Œè®¾ç½®ï¼š</p> 
   <pre><code class="prism language-c">		<span class="token keyword">void</span> <span class="token function">FD_ZERO</span><span class="token punctuation">(</span>fd_set <span class="token operator">*</span>fdset<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//æ¸…ç©ºé›†åˆ</span>

â€‹ 	<span class="token keyword">void</span> <span class="token function">FD_SET</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>fdset<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å°†ä¸€ä¸ªç»™å®šçš„æ–‡ä»¶æè¿°ç¬¦åŠ å…¥é›†åˆä¹‹ä¸­</span>

â€‹   <span class="token keyword">void</span> <span class="token function">FD_CLR</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>fdset<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å°†ä¸€ä¸ªç»™å®šçš„æ–‡ä»¶æè¿°ç¬¦ä»é›†åˆä¸­åˆ é™¤</span>

â€‹   <span class="token keyword">int</span> <span class="token function">FD_ISSET</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>fdset<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// æ£€æŸ¥é›†åˆä¸­æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å¯ä»¥è¯»å†™ </span>
</code></pre> 
   <p>ï¼ˆ3ï¼‰timeoutå‘ŠçŸ¥å†…æ ¸ç­‰å¾…æ‰€æŒ‡å®šæè¿°å­—ä¸­çš„ä»»ä½•ä¸€ä¸ªå°±ç»ªå¯èŠ±å¤šå°‘æ—¶é—´ã€‚å…¶timevalç»“æ„ç”¨äºæŒ‡å®šè¿™æ®µæ—¶é—´çš„ç§’æ•°å’Œå¾®ç§’æ•°ã€‚</p> 
   <pre><code class="prism language-c"> <span class="token keyword">struct</span> timeval <span class="token punctuation">{</span>

â€‹ 		<span class="token keyword">long</span> tv_sec<span class="token punctuation">;</span>   <span class="token comment">//seconds</span>

â€‹     <span class="token keyword">long</span> tv_usec<span class="token punctuation">;</span>  <span class="token comment">//microseconds</span>

â€‹ <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
   <p>è¿™ä¸ªå‚æ•°æœ‰ä¸‰ç§å¯èƒ½ï¼š</p> 
   <p>ï¼ˆ1ï¼‰æ°¸è¿œç­‰å¾…ä¸‹å»ï¼šä»…åœ¨æœ‰ä¸€ä¸ªæè¿°å­—å‡†å¤‡å¥½I/Oæ—¶æ‰è¿”å›ã€‚ä¸ºæ­¤ï¼ŒæŠŠè¯¥å‚æ•°è®¾ç½®ä¸ºç©ºæŒ‡é’ˆNULLã€‚</p> 
   <p>ï¼ˆ2ï¼‰ç­‰å¾…ä¸€æ®µå›ºå®šæ—¶é—´ï¼šåœ¨æœ‰ä¸€ä¸ªæè¿°å­—å‡†å¤‡å¥½I/Oæ—¶è¿”å›ï¼Œä½†æ˜¯ä¸è¶…è¿‡ç”±è¯¥å‚æ•°æ‰€æŒ‡å‘çš„timevalç»“æ„ä¸­æŒ‡å®šçš„ç§’æ•°å’Œå¾®ç§’æ•°ã€‚</p> 
   <p>ï¼ˆ3ï¼‰æ ¹æœ¬ä¸ç­‰å¾…ï¼šæ£€æŸ¥æè¿°å­—åç«‹å³è¿”å›ï¼Œè¿™ç§°ä¸ºè½®è¯¢ã€‚ä¸ºæ­¤ï¼Œè¯¥å‚æ•°å¿…é¡»æŒ‡å‘ä¸€ä¸ªtimevalç»“æ„ï¼Œè€Œä¸”å…¶ä¸­çš„å®šæ—¶å™¨å€¼å¿…é¡»ä¸º0ã€‚</p> 
  </blockquote> 
  <blockquote> 
   <p><img src="./pic/select%E5%8E%9F%E7%90%86%E5%9B%BE.png" alt="selectåŸç†å›¾"></p> 
  </blockquote> 
  <h2><a id="select_135"></a>selectæµ‹è¯•</h2> 
  <p>æœåŠ¡å™¨ç«¯</p> 
  <pre><code class="prism language-c"><span class="token comment">/************************************************************************* &gt; File Name: select_server.c &gt; Author: zhengdongqi &gt; Mail: 1821260963@qq.com &gt; Created Time: ä¸€ 4/ 8 16:04:11 2019 ************************************************************************/</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;assert.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> _DEBUG</span>
<span class="token macro property">#<span class="token directive keyword">define</span> DBG(fmt, args...) printf(fmt, ##args)</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> DBG(fmt, args...)</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> IPADDR "192.168.2.165"</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PORT 8888</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MAXSIZE 1024</span>
<span class="token macro property">#<span class="token directive keyword">define</span> LISTENQ 5</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SIZE 10</span>

<span class="token comment">/*å®šä¹‰ä¸€ä¸ªç»“æ„ä½“å­˜æ”¾æ•°æ®ä¿¡æ¯*/</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> date_t <span class="token punctuation">{</span>
    <span class="token keyword">int</span> cli_cnt<span class="token punctuation">;</span> <span class="token comment">/*å®¢æˆ·æ•°é‡*/</span>
    <span class="token keyword">int</span> cli_fds<span class="token punctuation">[</span>SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/*å®¢æˆ·å¥—æ¥å­—*/</span>
    fd_set allfds<span class="token punctuation">;</span> <span class="token comment">/*å¥æŸ„é›†åˆ*/</span>
    <span class="token keyword">int</span> maxfd<span class="token punctuation">;</span> <span class="token comment">/*å¥æŸ„æœ€å¤§å€¼*/</span>
<span class="token punctuation">}</span>date_t<span class="token punctuation">;</span>
date_t <span class="token operator">*</span>cli_d <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

<span class="token comment">/*å‡½æ•°å£°æ˜*/</span>
<span class="token comment">/*åˆ›å»ºä¸€ä¸ªsocket ç±»å‹TCP*/</span>
<span class="token keyword">int</span> <span class="token function">socket_create_tcp</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*åˆ›å»ºä¸€ä¸ªæ¥æ”¶å‡½æ•°*/</span>
<span class="token keyword">int</span> <span class="token function">socket_accept_tcp</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯*/</span>
<span class="token keyword">int</span> <span class="token function">handle_recv_msg</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>s
 <span class="token comment">/*æ¥æ”¶æ¶ˆæ¯*/</span>
<span class="token keyword">void</span> <span class="token function">socket_recv_msg</span><span class="token punctuation">(</span>fd_set <span class="token operator">*</span>rset<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*selectå¤„ç†å‡½æ•°*/</span>
<span class="token keyword">void</span> <span class="token function">handle_select_proc</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*åˆ›å»ºä¸€ä¸ªsocket ç±»å‹TCP*/</span>
<span class="token comment">/*é”€æ¯æ•°æ®*/</span>
<span class="token keyword">void</span> <span class="token function">date_destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*åˆå§‹åŒ–*/</span>
<span class="token keyword">int</span> <span class="token function">socket_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"\033[33må¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ğŸ’\033[0m\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    <span class="token comment">/*åˆå§‹åŒ–æœåŠ¡ç«¯*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">socket_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*åˆ›å»ºæœåŠ¡,å¼€å§‹ç›‘å¬å®¢æˆ·ç«¯è¯·æ±‚*/</span>
    fd <span class="token operator">=</span> <span class="token function">socket_create_tcp</span><span class="token punctuation">(</span>PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"\033[31må¥—æ¥å­—åˆ›å»ºå¤±è´¥\033[0m\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*å¼€å§‹æ¥æ”¶å¹¶å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚*/</span>
    <span class="token function">handle_select_proc</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">date_destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*åˆ›å»ºä¸€ä¸ªsocket ç±»å‹TCP*/</span>
<span class="token keyword">int</span> <span class="token function">socket_create_tcp</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> socket_fd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sockaddr_in socket_addr<span class="token punctuation">;</span>
    <span class="token comment">//åˆ›å»ºå¥—æ¥å­—</span>
    socket_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>socket_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"socket_create_tcp-&gt;\033[31måˆ›å»ºå¥—æ¥å­—å¤±è´¥: %s\033[0m\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//è®¾ç½®æœåŠ¡å™¨</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>socket_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>socket_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ•°æ®åˆå§‹åŒ–æ¸…é›¶</span>
    socket_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span><span class="token comment">//è®¾ç½®åè®®æ—</span>
    socket_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç«¯å£</span>
    socket_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//IPåœ°å€</span>
    <span class="token comment">//ç«¯å£é‡ç”¨</span>
    <span class="token keyword">int</span> reuse <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reuse<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>reuse<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"socket_create_tcp-&gt;\033[31mè®¾ç½®ç«¯å£é‡ç”¨å¤±è´¥: %s\033[0m\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//ç»‘å®šè¿æ¥</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>socket_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"socket_create_tcp-&gt;\033[31mç»‘å®šå¤±è´¥: %s\033[0m\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//è®¾ç½®ç›‘å¬</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"socket_create_tcp-&gt;\033[31mç›‘å¬å¤±è´¥: %s\033[0m\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> socket_fd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*åˆ›å»ºä¸€ä¸ªæ¥æ”¶å‡½æ•°*/</span>
<span class="token keyword">int</span> <span class="token function">socket_accept_tcp</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> afd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sockaddr_in accept_addr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>accept_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    afd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>accept_addr<span class="token punctuation">,</span> <span class="token punctuation">(</span>socklen_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>afd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        DBG <span class="token punctuation">(</span><span class="token string">"socket_accept_tcp-&gt;\033[31mæ¥æ”¶å¤±è´¥: %s\033[0m\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//å°†æ–°çš„è¿æ¥æè¿°ç¬¦æ·»åŠ åˆ°æ•°ç»„ä¸­</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cli_d<span class="token operator">-&gt;</span>cli_fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cli_d<span class="token operator">-&gt;</span>cli_fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> afd<span class="token punctuation">;</span>
            cli_d<span class="token operator">-&gt;</span>cli_cnt<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"socket_accept_tcp-&gt;\033[31må¤ªå¤šå®¢æˆ·äº† å¥½ç´¯å•ŠğŸ˜¢\033[0m\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯*/</span>
<span class="token keyword">int</span> <span class="token function">handle_recv_msg</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"handle_recv_msg-&gt;\033[32mrecv buf is :%s\033[0m\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*æ¥æ”¶æ¶ˆæ¯*/</span>
<span class="token keyword">void</span> <span class="token function">socket_recv_msg</span><span class="token punctuation">(</span>fd_set <span class="token operator">*</span>rset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>MAXSIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> cli_d<span class="token operator">-&gt;</span>cli_cnt<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fd <span class="token operator">=</span> cli_d<span class="token operator">-&gt;</span>cli_fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/*åˆ¤æ–­å®¢æˆ·ç«¯å¥—æ¥å­—æ˜¯å¦æœ‰æ•°æ®*/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> rset<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„ä¿¡æ¯</span>
            n <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> MAXSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/*n==0è¡¨ç¤ºè¯»å–å®Œæˆï¼Œå®¢æˆ·éƒ½å…³é—­å¥—æ¥å­—*/</span>
                <span class="token function">FD_CLR</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cli_d<span class="token operator">-&gt;</span>allfds<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cli_d<span class="token operator">-&gt;</span>cli_fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">handle_recv_msg</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*selectå¤„ç†å‡½æ•°*/</span>
<span class="token keyword">void</span> <span class="token function">handle_select_proc</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> nfd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    fd_set <span class="token operator">*</span>rset <span class="token operator">=</span> <span class="token operator">&amp;</span>cli_d<span class="token operator">-&gt;</span>allfds<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> timeval tv<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*æ¯æ¬¡è°ƒç”¨selectå‰éƒ½è¦é‡æ–°è®¾ç½®æ–‡ä»¶æè¿°ç¬¦å’Œæ—¶é—´ï¼Œå› ä¸ºäº‹ä»¶å‘ç”Ÿåï¼Œæ–‡ä»¶æè¿°ç¬¦å’Œæ—¶é—´éƒ½è¢«å†…æ ¸ä¿®æ”¹å•¦*/</span>
        <span class="token function">FD_ZERO</span><span class="token punctuation">(</span>rset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*æ·»åŠ ç›‘å¬å¥—æ¥å­—*/</span>
        <span class="token function">FD_SET</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> rset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cli_d<span class="token operator">-&gt;</span>maxfd <span class="token operator">=</span> sockfd<span class="token punctuation">;</span>

        tv<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
        tv<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">/*æ·»åŠ å®¢æˆ·ç«¯å¥—æ¥å­—*/</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cli_d<span class="token operator">-&gt;</span>cli_cnt<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fd <span class="token operator">=</span> cli_d<span class="token operator">-&gt;</span>cli_fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">/*å»é™¤æ— æ•ˆçš„å®¢æˆ·ç«¯å¥æŸ„*/</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">FD_SET</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> rset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            cli_d<span class="token operator">-&gt;</span>maxfd <span class="token operator">=</span> <span class="token punctuation">(</span>fd <span class="token operator">&gt;</span> cli_d<span class="token operator">-&gt;</span>maxfd <span class="token operator">?</span> fd <span class="token punctuation">:</span> cli_d<span class="token operator">-&gt;</span>maxfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/*å¼€å§‹è½®è¯¢æ¥æ”¶å¤„ç†æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¥—æ¥å­—*/</span>
        nfd <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>cli_d<span class="token operator">-&gt;</span>maxfd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> rset<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"handle_socket_select-&gt;\033[31mselectå¤±è´¥: %s\033[0m\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nfd <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"handle_socket_select-&gt;\033[31mselectè¶…æ—¶: %s\033[0m\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> rset<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/*ç›‘å¬å®¢æˆ·ç«¯è¯·æ±‚*/</span>
            <span class="token function">socket_accept_tcp</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">/*æ¥å—å¤„ç†å®¢æˆ·ç«¯æ¶ˆæ¯*/</span>
            <span class="token function">socket_recv_msg</span><span class="token punctuation">(</span>rset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*é”€æ¯æ•°æ®*/</span>
<span class="token keyword">void</span> <span class="token function">date_destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cli_d<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">free</span><span class="token punctuation">(</span>cli_d<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cli_d <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*åˆå§‹åŒ–*/</span>
<span class="token keyword">int</span> <span class="token function">socket_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cli_d <span class="token operator">=</span> <span class="token punctuation">(</span>date_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>date_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cli_d <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">memset</span><span class="token punctuation">(</span>cli_d<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>date_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cli_d<span class="token operator">-&gt;</span>cli_fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
  <p>å®¢æˆ·ç«¯</p> 
  <pre><code class="prism language-c"><span class="token comment">/************************************************************************* &gt; File Name: select_client.c &gt; Author: zhengdongqi &gt; Mail: 1821260963@qq.com &gt; Created Time: ä¸€ 4/ 8 17:36:23 2019 ************************************************************************/</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> _DEBUG</span>
<span class="token macro property">#<span class="token directive keyword">define</span> DBG(fmt, args...) printf(fmt, ##args)</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> DBG(fmt, args...)</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> MAXLINE 1024</span>
<span class="token macro property">#<span class="token directive keyword">define</span> IPADDR "192.168.2.165"</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PORT 8888</span>
<span class="token comment">/*å¤„ç†æ¥æ”¶ä¿¡æ¯*/</span>
<span class="token keyword">void</span> <span class="token function">handle_recv_msg</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span>  <span class="token punctuation">{</span>
    <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"handle_recv_msg-&gt;\033[33mæœåŠ¡å™¨å‘æ¥æ¶ˆæ¯: %s\033[0m\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

 
<span class="token comment">/*å¤„ç†å¥—æ¥å­—è¿æ¥*/</span>
<span class="token keyword">void</span> <span class="token function">handle_socket_connect</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> sendline<span class="token punctuation">[</span>MAXLINE<span class="token punctuation">]</span><span class="token punctuation">,</span>recvline<span class="token punctuation">[</span>MAXLINE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> maxfd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    fd_set rset<span class="token punctuation">;</span>
    <span class="token keyword">int</span> n<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> timeval tv<span class="token punctuation">;</span>
    <span class="token keyword">int</span> nfd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">FD_SET</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        maxfd <span class="token operator">=</span> fd<span class="token punctuation">;</span>

        tv<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
        tv<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        nfd <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>maxfd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>rset<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tv<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>nfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>nfd <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"handle_socket_connect-&gt;\033[31mselectè¶…æ—¶\033[0m\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rset<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            n <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> recvline<span class="token punctuation">,</span> MAXLINE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"handle_socket_connect-&gt;\033[31mæœåŠ¡å™¨å·²å…³é—­\033[0m\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">FD_CLR</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token function">handle_recv_msg</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> recvline<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> socket_fd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sockaddr_in socket_addr<span class="token punctuation">;</span>

    socket_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>socket_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>socket_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    socket_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    socket_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    socket_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>IPADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> nfd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    nfd <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>socket_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>socket_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"\033[31mè¿æ¥å¤±è´¥: %s\033[0m\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"\033[33måˆæ¬¡è§é¢è¯·å¤šå…³ç…§ğŸ˜„\033[0m\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token string">"hello server"</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">handle_socket_connect</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
  <h2><a id="select_495"></a>selectè¿è¡Œ</h2> 
  <p><img src="../Linux/pic/select_server.png" alt="select_server"></p> 
  <p><img src="../Linux/pic/select_client.png" alt="select_client"></p> 
  <h2><a id="select_501"></a>selectæ€»ç»“</h2> 
  <p>selectç›®å‰å‡ ä¹åœ¨æ‰€æœ‰çš„å¹³å°ä¸Šæ”¯æŒï¼Œ<code>å…¶è‰¯å¥½è·¨å¹³å°æ”¯æŒä¹Ÿæ˜¯å®ƒçš„ä¸€ä¸ªä¼˜ç‚¹</code>ã€‚<code>selectçš„ä¸€ä¸ªç¼ºç‚¹åœ¨äºå•ä¸ªè¿›ç¨‹èƒ½å¤Ÿç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡å­˜åœ¨æœ€å¤§é™åˆ¶</code>ï¼Œåœ¨Linuxä¸Šä¸€èˆ¬ä¸º1024ï¼Œ<code>å¯ä»¥é€šè¿‡ä¿®æ”¹å®å®šä¹‰ç”šè‡³é‡æ–°ç¼–è¯‘å†…æ ¸çš„æ–¹å¼æå‡è¿™ä¸€é™åˆ¶</code>ï¼Œä½†æ˜¯è¿™æ ·ä¹Ÿä¼šé€ æˆæ•ˆç‡çš„é™ä½ã€‚</p> 
  <p><code>selectæœ¬è´¨ä¸Šæ˜¯é€šè¿‡è®¾ç½®æˆ–è€…æ£€æŸ¥å­˜æ”¾fdæ ‡å¿—ä½çš„æ•°æ®ç»“æ„æ¥è¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†</code>ã€‚è¿™æ ·æ‰€å¸¦æ¥çš„ç¼ºç‚¹æ˜¯ï¼š</p> 
  <p>1ã€selectæœ€å¤§çš„ç¼ºé™·å°±æ˜¯å•ä¸ªè¿›ç¨‹æ‰€æ‰“å¼€çš„FDæ˜¯æœ‰ä¸€å®šé™åˆ¶çš„ï¼Œå®ƒç”±FD_SETSIZEè®¾ç½®ï¼Œé»˜è®¤å€¼æ˜¯1024ã€‚</p> 
  <p>ä¸€èˆ¬æ¥è¯´è¿™ä¸ªæ•°ç›®å’Œç³»ç»Ÿå†…å­˜å…³ç³»å¾ˆå¤§ï¼Œ<code>å…·ä½“æ•°ç›®å¯ä»¥cat /proc/sys/fs/file-maxå¯Ÿçœ‹</code>ã€‚32ä½æœºé»˜è®¤æ˜¯1024ä¸ªã€‚64ä½æœºé»˜è®¤æ˜¯2048.</p> 
  <p>2ã€å¯¹socketè¿›è¡Œæ‰«ææ—¶æ˜¯çº¿æ€§æ‰«æï¼Œå³é‡‡ç”¨è½®è¯¢çš„æ–¹æ³•ï¼Œæ•ˆç‡è¾ƒä½ã€‚</p> 
  <p>å½“å¥—æ¥å­—æ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œæ¯æ¬¡select()éƒ½è¦é€šè¿‡éå†FD_SETSIZEä¸ªSocketæ¥å®Œæˆè°ƒåº¦ï¼Œä¸ç®¡å“ªä¸ªSocketæ˜¯æ´»è·ƒçš„ï¼Œéƒ½éå†ä¸€éã€‚è¿™ä¼šæµªè´¹å¾ˆå¤šCPUæ—¶é—´ã€‚<code>å¦‚æœèƒ½ç»™å¥—æ¥å­—æ³¨å†ŒæŸä¸ªå›è°ƒå‡½æ•°ï¼Œå½“ä»–ä»¬æ´»è·ƒæ—¶ï¼Œè‡ªåŠ¨å®Œæˆç›¸å…³æ“ä½œï¼Œé‚£å°±é¿å…äº†è½®è¯¢</code>ï¼Œè¿™æ­£æ˜¯epollä¸kqueueåšçš„ã€‚</p> 
  <p>3ã€éœ€è¦ç»´æŠ¤ä¸€ä¸ªç”¨æ¥å­˜æ”¾å¤§é‡fdçš„æ•°æ®ç»“æ„ï¼Œè¿™æ ·ä¼šä½¿å¾—ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´åœ¨ä¼ é€’è¯¥ç»“æ„æ—¶å¤åˆ¶å¼€é”€å¤§ã€‚</p> 
  <h1><a id="4IOpoll_517"></a>4ã€IOå¤šè·¯å¤ç”¨poll</h1> 
  <h2><a id="poll_519"></a>pollåŸç†</h2> 
  <p>pollçš„æœºåˆ¶ä¸selectç±»ä¼¼ï¼Œä¸selectåœ¨æœ¬è´¨ä¸Šæ²¡æœ‰å¤šå¤§å·®åˆ«ï¼Œç®¡ç†å¤šä¸ªæè¿°ç¬¦ä¹Ÿæ˜¯è¿›è¡Œè½®è¯¢ï¼Œæ ¹æ®æè¿°ç¬¦çš„çŠ¶æ€è¿›è¡Œå¤„ç†ï¼Œä½†æ˜¯pollæ²¡æœ‰æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°é‡çš„é™åˆ¶ã€‚pollå’ŒselectåŒæ ·å­˜åœ¨ä¸€ä¸ªç¼ºç‚¹å°±æ˜¯ï¼ŒåŒ…å«å¤§é‡æ–‡ä»¶æè¿°ç¬¦çš„æ•°ç»„è¢«æ•´ä½“å¤åˆ¶äºç”¨æˆ·æ€å’Œå†…æ ¸çš„åœ°å€ç©ºé—´ä¹‹é—´ï¼Œè€Œä¸è®ºè¿™äº›æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å°±ç»ªï¼Œå®ƒçš„å¼€é”€éšç€æ–‡ä»¶æè¿°ç¬¦æ•°é‡çš„å¢åŠ è€Œçº¿æ€§å¢å¤§ã€‚</p> 
  <h2><a id="poll_523"></a>pollå‡½æ•°</h2> 
  <p>å‡½æ•°æ ¼å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p> 
  <pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;poll.h&gt;</span></span>
<span class="token keyword">int</span> poll <span class="token punctuation">(</span> <span class="token keyword">struct</span> pollfd <span class="token operator">*</span> fds<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nfds<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
  <p>pollfdç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p> 
  <pre><code class="prism language-c"><span class="token keyword">struct</span> pollfd <span class="token punctuation">{</span>
		<span class="token keyword">int</span> fd<span class="token punctuation">;</span>         			<span class="token comment">/* æ–‡ä»¶æè¿°ç¬¦ */</span>
		<span class="token keyword">short</span> events<span class="token punctuation">;</span>         <span class="token comment">/* ç­‰å¾…çš„äº‹ä»¶ */</span>
		<span class="token keyword">short</span> revents<span class="token punctuation">;</span>       	<span class="token comment">/* å®é™…å‘ç”Ÿäº†çš„äº‹ä»¶ */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> 
</code></pre> 
  <p>æ¯ä¸€ä¸ªpollfdç»“æ„ä½“æŒ‡å®šäº†ä¸€ä¸ªè¢«ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¯ä»¥ä¼ é€’å¤šä¸ªç»“æ„ä½“ï¼ŒæŒ‡ç¤ºpoll()ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚æ¯ä¸ªç»“æ„ä½“çš„eventsåŸŸæ˜¯ç›‘è§†è¯¥æ–‡ä»¶æè¿°ç¬¦çš„äº‹ä»¶æ©ç ï¼Œç”±ç”¨æˆ·æ¥è®¾ç½®è¿™ä¸ªåŸŸã€‚reventsåŸŸæ˜¯æ–‡ä»¶æè¿°ç¬¦çš„æ“ä½œç»“æœäº‹ä»¶æ©ç ï¼Œå†…æ ¸åœ¨è°ƒç”¨è¿”å›æ—¶è®¾ç½®è¿™ä¸ªåŸŸã€‚eventsåŸŸä¸­è¯·æ±‚çš„ä»»ä½•äº‹ä»¶éƒ½å¯èƒ½åœ¨reventsåŸŸä¸­è¿”å›ã€‚åˆæ³•çš„äº‹ä»¶å¦‚ä¸‹ï¼š</p> 
  <pre><code class="prism language-c">POLLIN ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token comment">//æœ‰æ•°æ®å¯è¯»ã€‚</span>
POLLRDNORM ã€€ã€€ã€€ã€€   <span class="token comment">//æœ‰æ™®é€šæ•°æ®å¯è¯»ã€‚</span>
POLLRDBANDã€€ã€€ã€€ã€€ã€€  <span class="token comment">//æœ‰ä¼˜å…ˆæ•°æ®å¯è¯»ã€‚</span>
POLLPRIã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token comment">//æœ‰ç´§è¿«æ•°æ®å¯è¯»ã€‚</span>
POLLOUTã€€ã€€ã€€ã€€ã€€ã€€   <span class="token comment">//å†™æ•°æ®ä¸ä¼šå¯¼è‡´é˜»å¡ã€‚</span>
POLLWRNORMã€€ã€€ã€€ã€€ã€€  <span class="token comment">//å†™æ™®é€šæ•°æ®ä¸ä¼šå¯¼è‡´é˜»å¡ã€‚</span>
POLLWRBANDã€€ã€€ã€€ã€€ã€€  <span class="token comment">//å†™ä¼˜å…ˆæ•°æ®ä¸ä¼šå¯¼è‡´é˜»å¡ã€‚</span>
POLLMSGSIGPOLL ã€€ã€€ã€€<span class="token comment">//æ¶ˆæ¯å¯ç”¨ã€‚</span>

<span class="token comment">/*æ­¤å¤–ï¼ŒreventsåŸŸä¸­è¿˜å¯èƒ½è¿”å›ä¸‹åˆ—äº‹ä»¶ï¼š*/</span>
POLLERã€€ã€€   				<span class="token comment">//æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿé”™è¯¯ã€‚</span>
POLLHUPã€€ã€€ 				<span class="token comment">//æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦æŒ‚èµ·äº‹ä»¶ã€‚</span>
POLLNVALã€€ã€€				<span class="token comment">//æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦éæ³•ã€‚</span>
<span class="token comment">/*è¿™äº›äº‹ä»¶åœ¨eventsåŸŸä¸­æ— æ„ä¹‰ï¼Œå› ä¸ºå®ƒä»¬åœ¨åˆé€‚çš„æ—¶å€™æ€»æ˜¯ä¼šä»reventsä¸­è¿”å›*/</span>
</code></pre> 
  <p>ä½¿ç”¨poll()å’Œselect()ä¸ä¸€æ ·ï¼Œä½ ä¸éœ€è¦æ˜¾å¼åœ°è¯·æ±‚å¼‚å¸¸æƒ…å†µæŠ¥å‘Šã€‚<br> ã€€ã€€POLLIN | POLLPRIç­‰ä»·äºselect( )çš„è¯»äº‹ä»¶ï¼ŒPOLLOUT | POLLWRBAND ç­‰ä»·äºselect( )çš„å†™äº‹ä»¶ã€‚POLLIN ç­‰ä»·äºPOLLRDNORM | POLLRDBANDï¼Œè€Œ POLLOUT åˆ™ç­‰ä»·äº POLLWRNORMã€‚ä¾‹å¦‚ï¼Œè¦åŒæ—¶ç›‘è§†ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å¯è¯»å’Œå¯å†™ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½® events ä¸ºPOLLIN | POLLOUTã€‚åœ¨ poll è¿”å›æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥ revents ä¸­çš„æ ‡å¿—ï¼Œå¯¹åº”äºæ–‡ä»¶æè¿°ç¬¦è¯·æ±‚çš„ events ç»“æ„ä½“ã€‚å¦‚æœ POLLIN äº‹ä»¶è¢«è®¾ç½®ï¼Œåˆ™æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è¢«è¯»å–è€Œä¸é˜»å¡ã€‚å¦‚æœ POLLOUT è¢«è®¾ç½®ï¼Œåˆ™æ–‡ä»¶æè¿°ç¬¦å¯ä»¥å†™å…¥è€Œä¸å¯¼è‡´é˜»å¡ã€‚è¿™äº›æ ‡å¿—å¹¶ä¸æ˜¯äº’æ–¥çš„ï¼šå®ƒä»¬å¯èƒ½è¢«åŒæ—¶è®¾ç½®ï¼Œè¡¨ç¤ºè¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„è¯»å–å’Œå†™å…¥æ“ä½œéƒ½ä¼šæ­£å¸¸è¿”å›è€Œä¸é˜»å¡ã€‚</p> 
  <p>timeout å‚æ•°æŒ‡å®šç­‰å¾…çš„æ¯«ç§’æ•°ï¼Œæ— è®ºI/Oæ˜¯å¦å‡†å¤‡å¥½ï¼Œpoll éƒ½ä¼šè¿”å›ã€‚timeout æŒ‡å®šä¸ºè´Ÿæ•°å€¼è¡¨ç¤ºæ— é™è¶…æ—¶ï¼Œä½¿ poll( )ä¸€ç›´æŒ‚èµ·ç›´åˆ°ä¸€ä¸ªæŒ‡å®šäº‹ä»¶å‘ç”Ÿï¼›timeout ä¸º 0 æŒ‡ç¤º poll è°ƒç”¨ç«‹å³è¿”å›å¹¶åˆ—å‡ºå‡†å¤‡å¥½ I/O çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä½†å¹¶ä¸ç­‰å¾…å…¶å®ƒçš„äº‹ä»¶ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œpoll( ) å°±åƒå®ƒçš„åå­—é‚£æ ·ï¼Œä¸€æ—¦é€‰ä¸¾å‡ºæ¥ï¼Œç«‹å³è¿”å›ã€‚</p> 
  <p>è¿”å›å€¼å’Œé”™è¯¯ä»£ç <br> ã€€ã€€æˆåŠŸæ—¶ï¼Œpoll( ) è¿”å›ç»“æ„ä½“ä¸­ revents åŸŸä¸ä¸º 0 çš„æ–‡ä»¶æè¿°ç¬¦ä¸ªæ•°ï¼›å¦‚æœåœ¨è¶…æ—¶å‰æ²¡æœ‰ä»»ä½•äº‹ä»¶å‘ç”Ÿï¼Œpoll( )è¿”å› 0ï¼›å¤±è´¥æ—¶ï¼Œpoll( )è¿”å›-1ï¼Œå¹¶è®¾ç½® errno ä¸ºä¸‹åˆ—å€¼ä¹‹ä¸€ï¼š</p> 
  <pre><code class="prism language-c">EBADFã€€ã€€     <span class="token comment">//ä¸€ä¸ªæˆ–å¤šä¸ªç»“æ„ä½“ä¸­æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦æ— æ•ˆã€‚</span>
EFAULTfdsã€€ã€€ <span class="token comment">//æŒ‡é’ˆæŒ‡å‘çš„åœ°å€è¶…å‡ºè¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚</span>
EINTRã€€ã€€ã€€ã€€  <span class="token comment">//è¯·æ±‚çš„äº‹ä»¶ä¹‹å‰äº§ç”Ÿä¸€ä¸ªä¿¡å·ï¼Œè°ƒç”¨å¯ä»¥é‡æ–°å‘èµ·ã€‚</span>
EINVALnfdsã€€ã€€<span class="token comment">//å‚æ•°è¶…å‡ºPLIMIT_NOFILEå€¼ã€‚</span>
ENOMEMã€€ã€€    <span class="token comment">//å¯ç”¨å†…å­˜ä¸è¶³ï¼Œæ— æ³•å®Œæˆè¯·æ±‚ã€‚</span>
</code></pre> 
  <h2><a id="poll_577"></a>pollæµ‹è¯•</h2> 
  <p>æœåŠ¡å™¨ç«¯</p> 
  <pre><code class="prism language-c"><span class="token comment">/************************************************************************* &gt; File Name: poll_server.c &gt; Author: zhengdongqi &gt; Mail: 1821260963@qq.com &gt; Created Time: Tue 09 Apr 2019 14:15:43 CST ************************************************************************/</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;poll.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> _DEBUG</span>
<span class="token macro property">#<span class="token directive keyword">define</span> DBG(fmt, args...) printf(fmt, ##args)</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> DBG(fmt, args...)</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> IPADDR "192.168.1.44"</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PORT 8731</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MAXSIZE 1024</span>
<span class="token macro property">#<span class="token directive keyword">define</span> LISTENQ 5</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OPEN_MAX 1000</span>
<span class="token macro property">#<span class="token directive keyword">define</span> INFTIM -1</span>

<span class="token comment">/*å‡½æ•°å£°æ˜*/</span>
<span class="token comment">/*åˆ›å»ºå¥—æ¥å­—å¹¶è¿›è¡Œç»‘å®š*/</span>
<span class="token keyword">int</span> <span class="token function">socket_bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*IOå¤šè·¯å¤ç”¨poll*/</span>
<span class="token keyword">void</span> <span class="token function">do_poll</span><span class="token punctuation">(</span><span class="token keyword">int</span> listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*å¤„ç†å¤šä¸ªè¿æ¥*/</span>
<span class="token keyword">void</span> <span class="token function">handle_connect</span><span class="token punctuation">(</span><span class="token keyword">struct</span> pollfd <span class="token operator">*</span>pfds<span class="token punctuation">,</span> <span class="token keyword">int</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"\033[33mæƒ³è¦å°ğŸŒ¹å—?\033[0m\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span>  listenfd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sockaddr_in socket_addr<span class="token punctuation">;</span>
    listenfd <span class="token operator">=</span> <span class="token function">socket_bind</span><span class="token punctuation">(</span>PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> LISTENQ<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">do_poll</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*åˆ›å»ºå¥—æ¥å­—å¹¶è¿›è¡Œç»‘å®š*/</span>
<span class="token keyword">int</span> <span class="token function">socket_bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span>  listenfd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sockaddr_in socket_addr<span class="token punctuation">;</span>
    listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>listenfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"socket_bind-&gt;\033[31må¥—æ¥å­—åˆ›å»ºå¤±è´¥: %s\033[0m\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>socket_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>socket_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    socket_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    socket_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	socket_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
 	<span class="token comment">//ç«¯å£é‡ç”¨</span>
    <span class="token keyword">int</span> reuse <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reuse<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>reuse<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"socket_bind-&gt;\033[31mè®¾ç½®ç«¯å£é‡ç”¨å¤±è´¥: %s\033[0m\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>socket_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>socket_addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"socket_bind-&gt;\033[31mç»‘å®šå¤±è´¥: %s\033[0m\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> listenfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*IOå¤šè·¯å¤ç”¨ç ´poll*/</span>
<span class="token keyword">void</span> <span class="token function">do_poll</span><span class="token punctuation">(</span><span class="token keyword">int</span> listenfd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> poll_fd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sockaddr_in poll_addr<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> pollfd pfds<span class="token punctuation">[</span>OPEN_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> maxfd<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">int</span> nready<span class="token punctuation">;</span>
    <span class="token comment">//æ·»åŠ ç›‘å¬æè¿°ç¬¦</span>
    pfds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> listenfd<span class="token punctuation">;</span>
    pfds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span>
    <span class="token comment">//åˆå§‹åŒ–å®¢æˆ·è¿æ¥æè¿°ç¬¦</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> OPEN_MAX<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pfds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    maxfd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//å¾ªç¯å¤„ç†</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//è·å–å¯ç”¨æè¿°ç¬¦çš„ä¸ªæ•°</span>
        nready <span class="token operator">=</span> <span class="token function">poll</span><span class="token punctuation">(</span>pfds<span class="token punctuation">,</span> maxfd<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> INFTIM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nready <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"do_poll-&gt;\033[31mpoll error\033[0m\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//æµ‹è¯•ç›‘å¬æè¿°ç¬¦æ˜¯å¦å‡†å¤‡å¥½</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pfds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            socklen_t len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>poll_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//æ¥å—æ–°çš„è¿æ¥</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>poll_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>poll_addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                   <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"do_poll-&gt;\033[31maccept error\033[0m\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token keyword">return</span> <span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"do_poll-&gt;\033[33maccept a new client: %s-&gt;%d\033[0m\n"</span><span class="token punctuation">,</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>poll_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>poll_addr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//å°†æ–°çš„è¿æ¥æè¿°ç¬¦æ·»åŠ åˆ°æ•°ç»„ä¸­</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> OPEN_MAX<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pfds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    pfds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> poll_fd<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> OPEN_MAX<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"\033[34mç´¯æ­»äº†ğŸ˜¢\033[0m\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//å°†æ–°çš„æè¿°ç¬¦æ·»åŠ åˆ°è¯»æè¿°ç¬¦é›†åˆä¸­</span>
            pfds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span>
            <span class="token comment">//è®°å½•å®¢æˆ·è¿æ¥å¥—æ¥å­—çš„ä¸ªæ•°</span>
            maxfd <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> maxfd <span class="token operator">?</span> i <span class="token punctuation">:</span> maxfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>nready <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//å¤„ç†å®¢æˆ·è¿æ¥</span>
        <span class="token function">handle_connect</span><span class="token punctuation">(</span>pfds<span class="token punctuation">,</span>maxfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">handle_connect</span><span class="token punctuation">(</span><span class="token keyword">struct</span> pollfd <span class="token operator">*</span>pfds<span class="token punctuation">,</span> <span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> n<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>MAXSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MAXSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pfds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token comment">//æµ‹è¯•å®¢æˆ·æè¿°ç¬¦æ˜¯å¦å‡†å¤‡å¥½</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pfds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„ä¿¡æ¯</span>
            n <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pfds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> MAXSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">close</span><span class="token punctuation">(</span>pfds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pfds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"handle_connect-&gt;\033[33mread msg is: %s\033[0m"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//å‘å®¢æˆ·ç«¯å‘é€buf</span>
            <span class="token function">write</span><span class="token punctuation">(</span>pfds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
  <p>å®¢æˆ·ç«¯</p> 
  <pre><code class="prism language-c"><span class="token comment">/************************************************************************* &gt; File Name: poll_client.c &gt; Author: zhengdongqi &gt; Mail: 1821260963@qq.com &gt; Created Time: Tue 09 Apr 2019 14:19:14 CST ************************************************************************/</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;poll.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> _DEBUG</span>
<span class="token macro property">#<span class="token directive keyword">define</span> DBG(fmt, args...) printf(fmt, ##args)</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> DBG(fmt, args...)</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> MAXSIZE 1024</span>
<span class="token macro property">#<span class="token directive keyword">define</span> IPADDR "192.168.1.44"</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PORT 8731</span>
<span class="token comment">/*å¤„ç†è¿æ¥*/</span>
<span class="token keyword">void</span> <span class="token function">handle_connect</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"\033[33mé€ä½ ä¸€æœµå°èŠ±ğŸŒ¹\033[0m\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> socket_fd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sockaddr_in  socket_addr<span class="token punctuation">;</span>
    socket_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>socket_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>socket_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    socket_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    socket_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    socket_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>IPADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">connect</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>socket_addr<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>socket_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//å¤„ç†è¿æ¥æè¿°ç¬¦</span>
    <span class="token function">handle_connect</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*å¤„ç†è¿æ¥*/</span>
<span class="token keyword">void</span> <span class="token function">handle_connect</span><span class="token punctuation">(</span><span class="token keyword">int</span> socket_fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> sendline<span class="token punctuation">[</span>MAXSIZE<span class="token punctuation">]</span><span class="token punctuation">,</span> recvline<span class="token punctuation">[</span>MAXSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> pollfd pfds<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> n<span class="token punctuation">;</span>
    <span class="token comment">//æ·»åŠ è¿æ¥æè¿°ç¬¦</span>
    pfds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> socket_fd<span class="token punctuation">;</span>
    pfds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span>
    <span class="token comment">//æ·»åŠ æ ‡å‡†è¾“å…¥æè¿°ç¬¦</span>
    pfds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> STDIN_FILENO<span class="token punctuation">;</span>
    pfds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">poll</span><span class="token punctuation">(</span>pfds<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pfds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            n <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> recvline<span class="token punctuation">,</span> MAXSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"handle_connect-&gt;\033[31mæœåŠ¡å™¨å·²å…³é—­\033[0m\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"handle_connect-&gt;\033[33mrecvline: %s\033[0m"</span><span class="token punctuation">,</span> recvline<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> recvline<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//æµ‹è¯•æ ‡å‡†è¾“å…¥æ˜¯å¦å‡†å¤‡å¥½</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pfds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            n <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> sendline<span class="token punctuation">,</span> MAXSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">shutdown</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> SHUT_WR<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"handle_connect-&gt;\033[33msendline: %s\033[0m"</span><span class="token punctuation">,</span> sendline<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">write</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> sendline<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
  <h2><a id="poll_828"></a>pollè¿è¡Œ</h2> 
  <p><img src="../Linux/pic/poll_server.png" alt="poll_server"></p> 
  <p><img src="../Linux/pic/poll_client.png" alt="poll_client"></p> 
  <h2><a id="poll_834"></a>pollæ€»ç»“</h2> 
  <p><code>pollæœ¬è´¨ä¸Šå’Œselectæ²¡æœ‰åŒºåˆ«ï¼Œå®ƒå°†ç”¨æˆ·ä¼ å…¥çš„æ•°ç»„æ‹·è´åˆ°å†…æ ¸ç©ºé—´</code>ï¼Œç„¶åæŸ¥è¯¢æ¯ä¸ªfdå¯¹åº”çš„è®¾å¤‡çŠ¶æ€ï¼Œå¦‚æœè®¾å¤‡å°±ç»ªåˆ™åœ¨è®¾å¤‡ç­‰å¾…é˜Ÿåˆ—ä¸­åŠ å…¥ä¸€é¡¹å¹¶ç»§ç»­éå†ï¼Œå¦‚æœéå†å®Œæ‰€æœ‰fdåæ²¡æœ‰å‘ç°å°±ç»ªè®¾å¤‡ï¼Œåˆ™æŒ‚èµ·å½“å‰è¿›ç¨‹ï¼Œç›´åˆ°è®¾å¤‡å°±ç»ªæˆ–è€…ä¸»åŠ¨è¶…æ—¶ï¼Œè¢«å”¤é†’åå®ƒåˆè¦å†æ¬¡éå†fdã€‚è¿™ä¸ªè¿‡ç¨‹ç»å†äº†å¤šæ¬¡æ— è°“çš„éå†ã€‚</p> 
  <p>å®ƒæ²¡æœ‰æœ€å¤§è¿æ¥æ•°çš„é™åˆ¶ï¼Œ<code>åŸå› æ˜¯å®ƒæ˜¯åŸºäºé“¾è¡¨æ¥å­˜å‚¨çš„</code>ï¼Œä½†æ˜¯åŒæ ·æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼š</p> 
  <p><code>1ï¼‰å¤§é‡çš„fdçš„æ•°ç»„è¢«æ•´ä½“å¤åˆ¶äºç”¨æˆ·æ€å’Œå†…æ ¸åœ°å€ç©ºé—´ä¹‹é—´</code>ï¼Œè€Œä¸ç®¡è¿™æ ·çš„å¤åˆ¶æ˜¯ä¸æ˜¯æœ‰æ„ä¹‰ã€‚</p> 
  <p><code>2ï¼‰pollè¿˜æœ‰ä¸€ä¸ªç‰¹ç‚¹æ˜¯â€œæ°´å¹³è§¦å‘â€</code>ï¼Œå¦‚æœæŠ¥å‘Šäº†fdåï¼Œæ²¡æœ‰è¢«å¤„ç†ï¼Œé‚£ä¹ˆä¸‹æ¬¡pollæ—¶ä¼šå†æ¬¡æŠ¥å‘Šè¯¥fdã€‚</p> 
  <p>æ³¨æ„ï¼šä»ä¸Šé¢çœ‹ï¼Œselectå’Œpolléƒ½éœ€è¦åœ¨è¿”å›åï¼Œ<code>é€šè¿‡éå†æ–‡ä»¶æè¿°ç¬¦æ¥è·å–å·²ç»å°±ç»ªçš„socket</code>ã€‚äº‹å®ä¸Šï¼Œ<code>åŒæ—¶è¿æ¥çš„å¤§é‡å®¢æˆ·ç«¯åœ¨ä¸€æ—¶åˆ»å¯èƒ½åªæœ‰å¾ˆå°‘çš„å¤„äºå°±ç»ªçŠ¶æ€</code>ï¼Œå› æ­¤éšç€ç›‘è§†çš„æè¿°ç¬¦æ•°é‡çš„å¢é•¿ï¼Œå…¶æ•ˆç‡ä¹Ÿä¼šçº¿æ€§ä¸‹é™ã€‚</p> 
  <h1><a id="5IOepoll_846"></a>5ã€IOå¤šè·¯å¤ç”¨epoll</h1> 
  <h2><a id="epoll_848"></a>epollåŸç†</h2> 
  <p>epollæ˜¯åœ¨2.6å†…æ ¸ä¸­æå‡ºçš„ï¼Œæ˜¯ä¹‹å‰çš„selectå’Œpollçš„å¢å¼ºç‰ˆæœ¬ã€‚ç›¸å¯¹äºselectå’Œpollæ¥è¯´ï¼Œepollæ›´åŠ çµæ´»ï¼Œæ²¡æœ‰æè¿°ç¬¦é™åˆ¶ã€‚epollä½¿ç”¨ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ç®¡ç†å¤šä¸ªæè¿°ç¬¦ï¼Œå°†ç”¨æˆ·å…³ç³»çš„æ–‡ä»¶æè¿°ç¬¦çš„äº‹ä»¶å­˜æ”¾åˆ°å†…æ ¸çš„ä¸€ä¸ªäº‹ä»¶è¡¨ä¸­ï¼Œè¿™æ ·åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„copyåªéœ€ä¸€æ¬¡ã€‚</p> 
  <h2><a id="epoll_852"></a>epollå‡½æ•°</h2> 
  <p>epollæ“ä½œè¿‡ç¨‹éœ€è¦ä¸‰ä¸ªæ¥å£ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š</p> 
  <pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">int</span> op<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> epoll_event <span class="token operator">*</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> epoll_event <span class="token operator">*</span> events<span class="token punctuation">,</span> <span class="token keyword">int</span> maxevents<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
  <p><strong>ï¼ˆ1ï¼‰ int epoll_create(int size);</strong><br> ã€€ã€€åˆ›å»ºä¸€ä¸ªepollçš„å¥æŸ„ï¼Œsizeç”¨æ¥å‘Šè¯‰å†…æ ¸è¿™ä¸ªç›‘å¬çš„æ•°ç›®ä¸€å…±æœ‰å¤šå¤§ã€‚è¿™ä¸ªå‚æ•°ä¸åŒäºselect()ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œç»™å‡ºæœ€å¤§ç›‘å¬çš„fd+1çš„å€¼ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“åˆ›å»ºå¥½epollå¥æŸ„åï¼Œå®ƒå°±æ˜¯ä¼šå ç”¨ä¸€ä¸ªfdå€¼ï¼Œåœ¨linuxä¸‹å¦‚æœæŸ¥çœ‹/proc/è¿›ç¨‹id/fd/ï¼Œæ˜¯èƒ½å¤Ÿçœ‹åˆ°è¿™ä¸ªfdçš„ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨å®Œepollåï¼Œå¿…é¡»è°ƒç”¨close()å…³é—­ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´fdè¢«è€—å°½ã€‚</p> 
  <p>*<em>ï¼ˆ2ï¼‰int epoll_ctl(int epfd, int op, int fd, struct epoll_event <em>event);</em></em><br> ã€€ã€€epollçš„äº‹ä»¶æ³¨å†Œå‡½æ•°ï¼Œå®ƒä¸åŒä¸select()æ˜¯åœ¨ç›‘å¬äº‹ä»¶æ—¶å‘Šè¯‰å†…æ ¸è¦ç›‘å¬ä»€ä¹ˆç±»å‹çš„äº‹ä»¶epollçš„äº‹ä»¶æ³¨å†Œå‡½æ•°ï¼Œå®ƒä¸åŒä¸select()æ˜¯åœ¨ç›‘å¬äº‹ä»¶æ—¶å‘Šè¯‰å†…æ ¸è¦ç›‘å¬ä»€ä¹ˆç±»å‹çš„äº‹ä»¶ï¼Œè€Œæ˜¯åœ¨è¿™é‡Œå…ˆæ³¨å†Œè¦ç›‘å¬çš„äº‹ä»¶ç±»å‹ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯epoll_create()çš„è¿”å›å€¼ï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºåŠ¨ä½œï¼Œç”¨ä¸‰ä¸ªå®æ¥è¡¨ç¤ºï¼š</p> 
  <pre><code class="prism language-c">EPOLL_CTL_ADDï¼š<span class="token comment">//æ³¨å†Œæ–°çš„fdåˆ°epfdä¸­ï¼›</span>
EPOLL_CTL_MODï¼š<span class="token comment">//å·²ç»æ³¨å†Œçš„fdçš„ç›‘å¬äº‹ä»¶ï¼›</span>
EPOLL_CTL_DELï¼š<span class="token comment">//pfdä¸­åˆ é™¤ä¸€ä¸ªfdï¼›</span>
</code></pre> 
  <p>ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯éœ€è¦ç›‘å¬çš„fdï¼Œç¬¬å››ä¸ªå‚æ•°æ˜¯å‘Šè¯‰å†…æ ¸éœ€è¦ç›‘å¬ä»€ä¹ˆäº‹ï¼Œstruct epoll_eventç»“æ„å¦‚ä¸‹ï¼š</p> 
  <pre><code class="prism language-c"><span class="token keyword">struct</span> epoll_event <span class="token punctuation">{</span>
  __uint32_t events<span class="token punctuation">;</span>  <span class="token comment">/* Epoll events */</span>
  epoll_data_t data<span class="token punctuation">;</span>  <span class="token comment">/* User data variable */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
  <p>eventså¯ä»¥æ˜¯ä»¥ä¸‹å‡ ä¸ªå®çš„é›†åˆï¼š</p> 
  <pre><code class="prism language-c">EPOLLIN ï¼š<span class="token comment">//è¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è¯»ï¼ˆåŒ…æ‹¬å¯¹ç«¯SOCKETæ­£å¸¸å…³é—­ï¼‰ï¼›</span>
EPOLLOUTï¼š<span class="token comment">//è¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥å†™ï¼›</span>
EPOLLPRIï¼š<span class="token comment">//è¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦æœ‰ç´§æ€¥çš„æ•°æ®å¯è¯»ï¼ˆè¿™é‡Œåº”è¯¥è¡¨ç¤ºæœ‰å¸¦å¤–æ•°æ®åˆ°æ¥ï¼‰ï¼›</span>
EPOLLERRï¼š<span class="token comment">//è¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿé”™è¯¯ï¼›</span>
EPOLLHUPï¼š<span class="token comment">//è¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦è¢«æŒ‚æ–­ï¼›</span>
EPOLLETï¼š <span class="token comment">//å°†EPOLLè®¾ä¸ºè¾¹ç¼˜è§¦å‘(Edge Triggered)æ¨¡å¼ï¼Œè¿™æ˜¯ç›¸å¯¹äºæ°´å¹³è§¦å‘(Level Triggered)æ¥è¯´çš„ã€‚</span>
EPOLLONESHOTï¼š<span class="token comment">//åªç›‘å¬ä¸€æ¬¡äº‹ä»¶ï¼Œå½“ç›‘å¬å®Œè¿™æ¬¡äº‹ä»¶ä¹‹åï¼Œå¦‚æœè¿˜éœ€è¦ç»§ç»­ç›‘å¬è¿™ä¸ªsocketçš„è¯ï¼Œéœ€è¦å†æ¬¡æŠŠè¿™ä¸ªsocketåŠ å…¥åˆ°EPOLLé˜Ÿåˆ—é‡Œ</span>
</code></pre> 
  <p><strong>ï¼ˆ3ï¼‰ int epoll_wait(int epfd, struct epoll_event * events, int maxevents, int timeout);</strong><br> ã€€ã€€ç­‰å¾…äº‹ä»¶çš„äº§ç”Ÿï¼Œç±»ä¼¼äºselect()è°ƒç”¨ã€‚å‚æ•°eventsç”¨æ¥ä»å†…æ ¸å¾—åˆ°äº‹ä»¶çš„é›†åˆï¼Œmaxeventså‘Šä¹‹å†…æ ¸è¿™ä¸ªeventsæœ‰å¤šå¤§ï¼Œè¿™ä¸ªmaxeventsçš„å€¼ä¸èƒ½å¤§äºåˆ›å»ºepoll_create()æ—¶çš„sizeï¼Œå‚æ•°timeoutæ˜¯è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼Œ0ä¼šç«‹å³è¿”å›ï¼Œ-1å°†ä¸ç¡®å®šï¼Œä¹Ÿæœ‰è¯´æ³•è¯´æ˜¯æ°¸ä¹…é˜»å¡ï¼‰ã€‚è¯¥å‡½æ•°è¿”å›éœ€è¦å¤„ç†çš„äº‹ä»¶æ•°ç›®ï¼Œå¦‚è¿”å›0è¡¨ç¤ºå·²è¶…æ—¶ã€‚</p> 
  <h2><a id="epoll_899"></a>epollæ¨¡å¼</h2> 
  <p>â€‹ epollå¯¹æ–‡ä»¶æè¿°ç¬¦çš„æ“ä½œæœ‰ä¸¤ç§æ¨¡å¼ï¼šLTï¼ˆlevel triggerï¼‰å’ŒETï¼ˆedge triggerï¼‰ã€‚LTæ¨¡å¼æ˜¯é»˜è®¤æ¨¡å¼ï¼ŒLTæ¨¡å¼ä¸ETæ¨¡å¼çš„åŒºåˆ«å¦‚ä¸‹ï¼š</p> 
  <p>LTæ¨¡å¼ï¼š<strong>å½“epoll_waitæ£€æµ‹åˆ°æè¿°ç¬¦äº‹ä»¶å‘ç”Ÿå¹¶å°†æ­¤äº‹ä»¶é€šçŸ¥åº”ç”¨ç¨‹åºï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ä¸ç«‹å³å¤„ç†è¯¥äº‹ä»¶ã€‚ä¸‹æ¬¡è°ƒç”¨epoll_waitæ—¶ï¼Œä¼šå†æ¬¡å“åº”åº”ç”¨ç¨‹åºå¹¶é€šçŸ¥æ­¤äº‹ä»¶ã€‚</strong></p> 
  <p>ETæ¨¡å¼ï¼š<strong>å½“epoll_waitæ£€æµ‹åˆ°æè¿°ç¬¦äº‹ä»¶å‘ç”Ÿå¹¶å°†æ­¤äº‹ä»¶é€šçŸ¥åº”ç”¨ç¨‹åºï¼Œåº”ç”¨ç¨‹åºå¿…é¡»ç«‹å³å¤„ç†è¯¥äº‹ä»¶ã€‚å¦‚æœä¸å¤„ç†ï¼Œä¸‹æ¬¡è°ƒç”¨epoll_waitæ—¶ï¼Œä¸ä¼šå†æ¬¡å“åº”åº”ç”¨ç¨‹åºå¹¶é€šçŸ¥æ­¤äº‹ä»¶ã€‚</strong></p> 
  <p><strong>ETæ¨¡å¼åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå‡å°‘äº†epolläº‹ä»¶è¢«é‡å¤è§¦å‘çš„æ¬¡æ•°ï¼Œå› æ­¤æ•ˆç‡è¦æ¯”LTæ¨¡å¼é«˜ã€‚epollå·¥ä½œåœ¨ETæ¨¡å¼çš„æ—¶å€™ï¼Œå¿…é¡»ä½¿ç”¨éé˜»å¡å¥—æ¥å£ï¼Œä»¥é¿å…ç”±äºä¸€ä¸ªæ–‡ä»¶å¥æŸ„çš„é˜»å¡è¯»/é˜»å¡å†™æ“ä½œæŠŠå¤„ç†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„ä»»åŠ¡é¥¿æ­»ã€‚</strong></p> 
  <h2><a id="epoll_909"></a>epollæµ‹è¯•</h2> 
  <p>ç¼–å†™ä¸€ä¸ªæœåŠ¡å™¨å›å°„ç¨‹åºechoï¼Œç»ƒä¹ epollè¿‡ç¨‹ã€‚</p> 
  <pre><code class="prism language-c"><span class="token comment">/************************************************************************* &gt; File Name: epoll_server.c &gt; Author: zhengdongqi &gt; Mail: 1821260963@qq.com &gt; Created Time: Mon 08 Apr 2019 19:10:21 CST ************************************************************************/</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> _DEBUG</span>
<span class="token macro property">#<span class="token directive keyword">define</span> DBG(fmt, args...) printf(fmt, ##args)</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> DBG(fmt, args...)</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> IPADDR "192.168.1.44"</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PORT 8731</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MAXSIZE 1024</span>
<span class="token macro property">#<span class="token directive keyword">define</span> LISTENQ 5</span>
<span class="token macro property">#<span class="token directive keyword">define</span> FDSIZE 1000</span>
<span class="token macro property">#<span class="token directive keyword">define</span> EPOLLEVENTS 100</span>

<span class="token comment">/*å‡½æ•°å£°æ˜*/</span>
<span class="token comment">/*åˆ›å»ºå¥—æ¥å­—å¹¶è¿›è¡Œç»‘å®š*/</span>
<span class="token keyword">int</span> <span class="token function">socket_bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*IOå¤šè·¯å¤ç”¨epoll*/</span>
<span class="token keyword">void</span> <span class="token function">do_epoll</span><span class="token punctuation">(</span><span class="token keyword">int</span> listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*äº‹ä»¶å¤„ç†å‡½æ•°*/</span>
<span class="token keyword">void</span> <span class="token function">handle_events</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> epoll_event <span class="token operator">*</span>events<span class="token punctuation">,</span> <span class="token keyword">int</span> num<span class="token punctuation">,</span> <span class="token keyword">int</span> listenfd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*å¤„ç†æ¥æ”¶åˆ°çš„è¿æ¥*/</span>
<span class="token keyword">void</span> <span class="token function">handle_accpet</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*è¯»å¤„ç†*/</span>
<span class="token keyword">void</span> <span class="token function">do_read</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*å†™å¤„ç†*/</span>
<span class="token keyword">void</span> <span class="token function">do_write</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*æ·»åŠ äº‹ä»¶*/</span>
<span class="token keyword">void</span> <span class="token function">add_event</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*ä¿®æ”¹äº‹ä»¶*/</span>
<span class="token keyword">void</span> <span class="token function">modify_event</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*åˆ é™¤äº‹ä»¶*/</span>
<span class="token keyword">void</span> <span class="token function">delete_event</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span>  listenfd<span class="token punctuation">;</span>
    listenfd <span class="token operator">=</span> <span class="token function">socket_bind</span><span class="token punctuation">(</span>PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> LISTENQ<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">do_epoll</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*åˆ›å»ºå¥—æ¥å­—å¹¶è¿›è¡Œç»‘å®š*/</span>
<span class="token keyword">int</span> <span class="token function">socket_bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span>  listenfd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sockaddr_in socket_addr<span class="token punctuation">;</span>
    listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>listenfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"socket_bind-&gt;\033[31må¥—æ¥å­—åˆ›å»ºå¤±è´¥: %s\033[0m\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>socket_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>socket_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    socket_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    socket_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	socket_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
 	<span class="token comment">//ç«¯å£é‡ç”¨</span>
    <span class="token keyword">int</span> reuse <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reuse<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>reuse<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"socket_bind-&gt;\033[31mè®¾ç½®ç«¯å£é‡ç”¨å¤±è´¥: %s\033[0m\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>socket_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>socket_addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"socket_bind-&gt;\033[31mç»‘å®šå¤±è´¥: %s\033[0m\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> listenfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*IOå¤šè·¯å¤ç”¨epoll*/</span>
<span class="token keyword">void</span> <span class="token function">do_epoll</span><span class="token punctuation">(</span><span class="token keyword">int</span> listenfd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> epollfd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> epoll_event events<span class="token punctuation">[</span>EPOLLEVENTS<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>MAXSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MAXSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//åˆ›å»ºä¸€ä¸ªæè¿°ç¬¦</span>
    epollfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span>FDSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//æ·»åŠ ç›‘å¬æè¿°ç¬¦äº‹ä»¶</span>
    <span class="token function">add_event</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> listenfd<span class="token punctuation">,</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//è·å–å·²ç»å‡†å¤‡å¥½çš„æè¿°ç¬¦äº‹ä»¶</span>
        ret <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> EPOLLEVENTS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">handle_events</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> listenfd<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*äº‹ä»¶å¤„ç†å‡½æ•°*/</span>
<span class="token keyword">void</span> <span class="token function">handle_events</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> epoll_event <span class="token operator">*</span>events<span class="token punctuation">,</span> <span class="token keyword">int</span> num<span class="token punctuation">,</span> <span class="token keyword">int</span> listenfd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    <span class="token comment">//è¿›è¡Œé€‰å¥½éå†</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>
        <span class="token comment">//æ ¹æ®æè¿°ç¬¦çš„ç±»å‹å’Œäº‹ä»¶ç±»å‹è¿›è¡Œå¤„ç†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> listenfd<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">handle_accpet</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span>
            <span class="token function">do_read</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLOUT<span class="token punctuation">)</span>
            <span class="token function">do_write</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*å¤„ç†æ¥æ”¶åˆ°çš„è¿æ¥*/</span>
<span class="token keyword">void</span> <span class="token function">handle_accpet</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> listenfd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token keyword">struct</span> sockaddr_in socket_addr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr_in<span class="token punctuation">)</span><span class="token punctuation">,</span> fd<span class="token punctuation">;</span>
    fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>socket_addr<span class="token punctuation">,</span> <span class="token punctuation">(</span>socklen_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"handle_accpet-&gt;\033[31mæ¥å—å¥—æ¥å­—å¤±è´¥: %s\033[0m"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"handle_accpet-&gt;\033[33mæ£€æŸ¥åˆ°ä¸€ä¸ªæ–°ç”¨æˆ·: %s-&gt;%d\033[0m\n"</span><span class="token punctuation">,</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>socket_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>socket_addr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//æ·»åŠ ä¸€ä¸ªå®¢æˆ·æè¿°ç¬¦å’Œäº‹ä»¶</span>
        <span class="token function">add_event</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*è¯»å¤„ç†*/</span>
<span class="token keyword">void</span> <span class="token function">do_read</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> nread<span class="token punctuation">;</span>
    nread <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> MAXSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nread <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"do_read-&gt;\033[31mè¯»âŒ\033[0m\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delete_event</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nread <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"\033[33mç”¨æˆ·å·²ä¸‹çº¿\033[0m\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delete_event</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"do_read-&gt;\033[33mread: %s\033[0m"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ä¿®æ”¹æè¿°ç¬¦å¯¹åº”çš„äº‹ä»¶ï¼Œç”±è¯»æ”¹ä¸ºå†™</span>
        <span class="token function">modify_event</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> EPOLLOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*å†™å¤„ç†*/</span>
<span class="token keyword">void</span> <span class="token function">do_write</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> nwrite<span class="token punctuation">;</span>
    nwrite <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nwrite <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"do_write-&gt;\033[31mâŒ\033[0m\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delete_event</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> EPOLLOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span>
        <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"do_write-&gt;\033[33mwrite: %s\033[0m"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">modify_event</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>MAXSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*æ·»åŠ äº‹ä»¶*/</span>
<span class="token keyword">void</span> <span class="token function">add_event</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> epoll_event ev<span class="token punctuation">;</span>
    ev<span class="token punctuation">.</span>events <span class="token operator">=</span> state<span class="token punctuation">;</span>
    ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span><span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*åˆ é™¤äº‹ä»¶*/</span>
<span class="token keyword">void</span> <span class="token function">delete_event</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> epoll_event ev<span class="token punctuation">;</span>
    ev<span class="token punctuation">.</span>events <span class="token operator">=</span> state<span class="token punctuation">;</span>
    ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_DEL<span class="token punctuation">,</span> fd<span class="token punctuation">,</span><span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*ä¿®æ”¹äº‹ä»¶*/</span>
<span class="token keyword">void</span> <span class="token function">modify_event</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> epoll_event ev<span class="token punctuation">;</span>
    ev<span class="token punctuation">.</span>events <span class="token operator">=</span> state<span class="token punctuation">;</span>
    ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_MOD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span><span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
  <p>å®¢æˆ·ç«¯</p> 
  <pre><code class="prism language-c"><span class="token comment">/************************************************************************* &gt; File Name: epoll_client.c &gt; Author: zhengdongqi &gt; Mail: 1821260963@qq.com &gt; Created Time: Mon 08 Apr 2019 19:15:59 CST ************************************************************************/</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> _DEBUG</span>
<span class="token macro property">#<span class="token directive keyword">define</span> DBG(fmt, args...) printf(fmt, ##args)</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> DBG(fmt, args...)</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> MAXSIZE 1024</span>
<span class="token macro property">#<span class="token directive keyword">define</span> IPADDR "192.168.1.44"</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PORT 8731</span>
<span class="token macro property">#<span class="token directive keyword">define</span> FDSIZE 1024</span>
<span class="token macro property">#<span class="token directive keyword">define</span> EPOLLEVENTS 20</span>

<span class="token comment">/*å¤„ç†è¿æ¥*/</span>
<span class="token keyword">void</span> <span class="token function">handle_connection</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*å¤„ç†äº‹ä»¶*/</span>
<span class="token keyword">void</span> <span class="token function">handle_events</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> epoll_event <span class="token operator">*</span>events<span class="token punctuation">,</span> <span class="token keyword">int</span> num<span class="token punctuation">,</span> <span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*è¯»å¤„ç†*/</span>
<span class="token keyword">void</span> <span class="token function">do_read</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*å†™å¤„ç†*/</span>
<span class="token keyword">void</span> <span class="token function">do_write</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*æ·»åŠ äº‹ä»¶*/</span>
<span class="token keyword">void</span> <span class="token function">add_event</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*åˆ é™¤äº‹ä»¶*/</span>
<span class="token keyword">void</span> <span class="token function">delete_event</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*ä¿®æ”¹äº‹ä»¶*/</span>
<span class="token keyword">void</span> <span class="token function">modify_event</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> socket_fd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sockaddr_in  socket_addr<span class="token punctuation">;</span>
    socket_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>socket_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>socket_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    socket_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    socket_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	socket_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>IPADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">connect</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>socket_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>socket_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//å¤„ç†è¿æ¥</span>
    <span class="token function">handle_connection</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*å¤„ç†è¿æ¥*/</span>
<span class="token keyword">void</span> <span class="token function">handle_connection</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> epollfd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> epoll_event events<span class="token punctuation">[</span>EPOLLEVENTS<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>MAXSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    epollfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span>FDSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">add_event</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> STDIN_FILENO<span class="token punctuation">,</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> EPOLLEVENTS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">handle_events</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> sockfd<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*å¤„ç†äº‹ä»¶*/</span>
<span class="token keyword">void</span> <span class="token function">handle_events</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> epoll_event <span class="token operator">*</span>events<span class="token punctuation">,</span> <span class="token keyword">int</span> num<span class="token punctuation">,</span> <span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span>
            <span class="token function">do_read</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> sockfd<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLOUT<span class="token punctuation">)</span>
            <span class="token function">do_write</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> sockfd<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*è¯»å¤„ç†*/</span>
<span class="token keyword">void</span> <span class="token function">do_read</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> nread<span class="token punctuation">;</span>
    nread <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>MAXSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nread <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"do_read-&gt;\033[31mâŒ\033[0m\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nread <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"do_read-&gt;\033[31mæœåŠ¡å™¨å…³é—­\033[0m\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> STDIN_FILENO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"do_read-&gt;\033[32mread: %s\033[0m"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">add_event</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> sockfd<span class="token punctuation">,</span> EPOLLOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">delete_event</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> sockfd<span class="token punctuation">,</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">add_event</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> STDOUT_FILENO<span class="token punctuation">,</span> EPOLLOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*å†™å¤„ç†*/</span>
<span class="token keyword">void</span> <span class="token function">do_write</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> nwrite<span class="token punctuation">;</span>
    nwrite <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nwrite <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"do_write-&gt;\033[31mâŒ\033[0m\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 		<span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> STDOUT_FILENO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"do_write-&gt;\033[32mwrite: %s\033[0m"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">delete_event</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> EPOLLOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"do_write-&gt;\033[32mwrite: %s\033[0m"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">modify_event</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MAXSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*æ·»åŠ äº‹ä»¶*/</span>
<span class="token keyword">void</span> <span class="token function">add_event</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> epoll_event ev<span class="token punctuation">;</span>
    ev<span class="token punctuation">.</span>events <span class="token operator">=</span> state<span class="token punctuation">;</span>
    ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*åˆ é™¤äº‹ä»¶*/</span>
<span class="token keyword">void</span> <span class="token function">delete_event</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> epoll_event ev<span class="token punctuation">;</span>
    ev<span class="token punctuation">.</span>events <span class="token operator">=</span> state<span class="token punctuation">;</span>
    ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_DEL<span class="token punctuation">,</span> fd<span class="token punctuation">,</span><span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*ä¿®æ”¹äº‹ä»¶*/</span>
<span class="token keyword">void</span> <span class="token function">modify_event</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> epoll_event ev<span class="token punctuation">;</span>
    ev<span class="token punctuation">.</span>events <span class="token operator">=</span> state<span class="token punctuation">;</span>
    ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_MOD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
  <h2><a id="epoll_1253"></a>epollè¿è¡Œ</h2> 
  <p><img src="../Linux/pic/epoll_server.png" alt="epoll_server"></p> 
  <p><img src="../Linux/pic/epoll_clent.png" alt="epoll_clent"></p> 
  <h2><a id="epoll_1259"></a>epollæ€»ç»“</h2> 
  <p>epollçš„ä¼˜ç‚¹ï¼š</p> 
  <p><code>1ã€æ²¡æœ‰æœ€å¤§å¹¶å‘è¿æ¥çš„é™åˆ¶</code>ï¼Œèƒ½æ‰“å¼€çš„FDçš„ä¸Šé™è¿œå¤§äº1024ï¼ˆ1Gçš„å†…å­˜ä¸Šèƒ½ç›‘å¬çº¦10ä¸‡ä¸ªç«¯å£ï¼‰ã€‚</p> 
  <p><code>2ã€æ•ˆç‡æå‡ï¼Œä¸æ˜¯è½®è¯¢çš„æ–¹å¼ï¼Œä¸ä¼šéšç€FDæ•°ç›®çš„å¢åŠ æ•ˆç‡ä¸‹é™</code>ã€‚</p> 
  <p>åªæœ‰æ´»è·ƒå¯ç”¨çš„FDæ‰ä¼šè°ƒç”¨callbackå‡½æ•°ï¼›<code>å³Epollæœ€å¤§çš„ä¼˜ç‚¹å°±åœ¨äºå®ƒåªç®¡ä½ â€œæ´»è·ƒâ€çš„è¿æ¥ï¼Œè€Œè·Ÿè¿æ¥æ€»æ•°æ— å…³</code>ï¼Œå› æ­¤åœ¨å®é™…çš„ç½‘ç»œç¯å¢ƒä¸­ï¼ŒEpollçš„æ•ˆç‡å°±ä¼šè¿œè¿œé«˜äºselectå’Œpollã€‚</p> 
  <p><code>3ã€å†…å­˜æ‹·è´</code>ï¼Œåˆ©ç”¨mmap()æ–‡ä»¶æ˜ å°„å†…å­˜åŠ é€Ÿä¸å†…æ ¸ç©ºé—´çš„æ¶ˆæ¯ä¼ é€’ï¼›<code>å³epollä½¿ç”¨mmapå‡å°‘å¤åˆ¶å¼€é”€</code>ã€‚</p> 
  <p>æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰å¤§é‡çš„idle-connectionæˆ–è€…dead-connectionï¼Œepollçš„æ•ˆç‡å¹¶ä¸ä¼šæ¯”select/pollé«˜å¾ˆå¤šï¼Œä½†æ˜¯å½“é‡åˆ°å¤§é‡çš„idle-connectionï¼Œå°±ä¼šå‘ç°epollçš„æ•ˆç‡å¤§å¤§é«˜äºselect/pollã€‚</p> 
  <h1><a id="6selectpollepoll_1273"></a>6ã€selectã€pollã€epollåŒºåˆ«</h1> 
  <h2><a id="1_1275"></a>1ã€æœ€å¤§è¿æ¥æ•°</h2> 
  <table> 
   <thead> 
    <tr> 
     <th>select</th> 
     <th>å•ä¸ªè¿›ç¨‹æ‰€èƒ½æ‰“å¼€çš„æœ€å¤§è¿æ¥æ•°ç”±FD_SETSIZEå®å®šä¹‰ï¼Œå…¶å¤§å°æ˜¯32ä¸ªæ•´æ•°çš„å¤§å°ï¼ˆåœ¨32ä½çš„æœºå™¨ä¸Šï¼Œå¤§å°å°±æ˜¯32x32ï¼ŒåŒç†64ä½æœºå™¨ä¸ŠFD_SETSIZEä¸º32x64ï¼‰ï¼Œå½“ç„¶æˆ‘ä»¬å¯ä»¥å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼Œç„¶åé‡æ–°ç¼–è¯‘å†…æ ¸ï¼Œä½†æ˜¯æ€§èƒ½å¯èƒ½ä¼šå—åˆ°å½±å“ï¼Œè¿™éœ€è¦è¿›ä¸€æ­¥æµ‹è¯•ã€‚</th> 
    </tr> 
   </thead> 
   <tbody> 
    <tr> 
     <td>poll</td> 
     <td>pollæœ¬è´¨ä¸Šå’Œselectæ²¡æœ‰åŒºåˆ«ï¼Œä½†æ˜¯å®ƒæ²¡æœ‰æœ€å¤§è¿æ¥æ•°çš„é™åˆ¶ï¼ŒåŸå› æ˜¯å®ƒæ˜¯åŸºäºé“¾è¡¨æ¥å‚¨å­˜çš„ã€‚</td> 
    </tr> 
    <tr> 
     <td>epoll</td> 
     <td>è™½ç„¶è¿æ¥æœ‰ä¸Šçº¿ï¼Œä½†æ˜¯å¾ˆå¤§ï¼Œ1Gå†…å­˜çš„æœºå™¨ä¸Šå¯ä»¥æ‰“å¼€10ä¸‡å·¦å³çš„è¿æ¥ï¼Œ2Gå†…å­˜çš„æœºå™¨å¯ä»¥æ‰“å¼€20ä¸‡å·¦å³çš„è¿æ¥ã€‚</td> 
    </tr> 
   </tbody> 
  </table>
  <h2><a id="2IO_1282"></a>2ã€IOæ•ˆç‡é—®é¢˜</h2> 
  <table> 
   <thead> 
    <tr> 
     <th>select</th> 
     <th>å› ä¸ºæ¯æ¬¡è°ƒç”¨éƒ½ä¼šå¯¹è¿æ¥è¿›è¡Œçº¿æ€§éå†ï¼Œæ‰€ä»¥éšç€FDçš„å¢åŠ ä¼šé€ æˆéå†é€Ÿåº¦æ…¢çš„"çº¿æ€§ä¸‹é™æ€§èƒ½é—®é¢˜"ã€‚</th> 
    </tr> 
   </thead> 
   <tbody> 
    <tr> 
     <td>Poll</td> 
     <td>åŒä¸Š</td> 
    </tr> 
    <tr> 
     <td>Epoll</td> 
     <td>å› ä¸ºepollå†…æ ¸ä¸­å®ç°äº‹æ ¹æ®æ¯ä¸ªfdä¸Šçš„callbackå‡½æ•°æ¥å®ç°çš„ï¼Œåªæœ‰æ´»è·ƒçš„socketæ‰ä¼šä¸»åŠ¨è°ƒç”¨callbackï¼Œæ‰€ä»¥åœ¨æ´»è·ƒsocketè¾ƒå°‘çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨epollæ²¡æœ‰å‰é¢ä¸¤è€…çš„çº¿å½¢ä¸‹é™çš„æ€§èƒ½é—®é¢˜ï¼Œä½†æ˜¯æ‰€æœ‰socketéƒ½å¾ˆæ´»è·ƒçš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šæœ‰çº¿æ€§é—®é¢˜ã€‚</td> 
    </tr> 
   </tbody> 
  </table>
  <h2><a id="3_1289"></a>3ã€æ¶ˆæ¯ä¼ é€’æ–¹å¼</h2> 
  <table> 
   <thead> 
    <tr> 
     <th>select</th> 
     <th>å†…æ ¸éœ€è¦å°†æ¶ˆæ¯ä¼ é€’åˆ°ç”¨æˆ·ç©ºé—´ï¼Œéƒ½éœ€è¦å†…æ ¸æ‹·è´åŠ¨ä½œ</th> 
    </tr> 
   </thead> 
   <tbody> 
    <tr> 
     <td>poll</td> 
     <td>åŒä¸Š</td> 
    </tr> 
    <tr> 
     <td>epoll</td> 
     <td>epollé€šè¿‡å†…æ ¸å’Œç”¨æˆ·å…±äº«ä¸€å—å†…å­˜æ¥å®ç°çš„</td> 
    </tr> 
   </tbody> 
  </table>
  <p>ç»¼ä¸Šï¼Œåœ¨é€‰æ‹©selectï¼Œpollï¼Œepollæ—¶è¦æ ¹æ®å…·ä½“çš„ä½¿ç”¨åœºåˆä»¥åŠè¿™ä¸‰ç§æ–¹å¼çš„è‡ªèº«ç‰¹ç‚¹ï¼š</p> 
  <p>1ã€è¡¨é¢ä¸Šçœ‹epollçš„æ€§èƒ½æœ€å¥½ï¼Œ<code>ä½†æ˜¯åœ¨è¿æ¥æ•°å°‘å¹¶ä¸”è¿æ¥éƒ½ååˆ†æ´»è·ƒçš„æƒ…å†µä¸‹ï¼Œselectå’Œpollçš„æ€§èƒ½å¯èƒ½æ¯”epollå¥½</code>ï¼Œæ¯•ç«Ÿepollçš„é€šçŸ¥æœºåˆ¶éœ€è¦å¾ˆå¤šå‡½æ•°å›è°ƒã€‚</p> 
  <p><code>2ã€selectä½æ•ˆæ˜¯å› ä¸ºæ¯æ¬¡å®ƒéƒ½éœ€è¦è½®è¯¢</code>ã€‚ä½†ä½æ•ˆä¹Ÿæ˜¯ç›¸å¯¹çš„ï¼Œè§†æƒ…å†µè€Œå®šï¼Œä¹Ÿå¯é€šè¿‡è‰¯å¥½çš„è®¾è®¡æ”¹å–„ã€‚</p> 
 </div> 
 <link href="https://csdnimg.cn/release/phoenix/mdeditor/markdown_views-258a4616f7.css" rel="stylesheet"> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="æŸšå­ç¤¾åŒº">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>æœ€æ–°èµ„è®¯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">é‚®ç®±</a>
    
    <a href="https://uzshare.com" target="_blank">æŸšå­ç¤¾åŒº</a>
    
    <a href="https://uzzz.org" target="_blank">æ‰¾ç»„ç»‡</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">æœ€æ–°</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[åŸåˆ›è½¯ä»¶] [è½¯ä»¶å‘å¸ƒ] å®šæ—¶å¤‡ä»½æ–‡ä»¶å‘é€é‚®ç®±ï¼Œä¸å†æ€•æ•°æ®ä¸¢å¤±äº†</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Getæ™ºèƒ½å†™ä½œæ»¡æœˆè®° â€”â€”äº§å“ç¯‡</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">ã€Šæ·±åº¦æ¢ç´¢C++å¯¹è±¡æ¨¡å‹ã€‹..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql å¤šè¡¨è”æŸ¥ä¹‹è¿æ¥æŸ¥è¯¢</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golangåŸºç¡€(äºŒ)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">ä»Šæ—¥ä»½çš„PTAåˆ·é¢˜</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Androidä¹‹æŠ˜çº¿å›¾</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Androidä¹‹å®ç°é€‰ä¸­æ—¶æ”¹å˜æ ·å¼</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">ç›®å½•</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
