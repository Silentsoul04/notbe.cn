<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>C++后端 客户端使用select模型 « NotBeCN</title>
  <meta name="description" content="         Sever.cpp   &nbsp;   #define WIN32_LEAN_AND_MEAN #define _WINSOCK_DEPRECATED_NO_WARNINGS #define _CRT_SECURE_NO_WARNINGS   #include &lt;windows.h&gt...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2019/05/11/yeyuanqiye_90115812.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">C++后端 客户端使用select模型</h1>
    <p class="post-meta">May 11, 2019</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <p>Sever.cpp</p> 
  <p>&nbsp;</p> 
  <p>#define WIN32_LEAN_AND_MEAN<br> #define _WINSOCK_DEPRECATED_NO_WARNINGS<br> #define _CRT_SECURE_NO_WARNINGS</p> 
  <p>#include &lt;windows.h&gt;<br> #include &lt;WinSock2.h&gt;<br> #include &lt;stdio.h&gt;<br> #include &lt;map&gt;<br> #include &lt;string&gt;<br> #include &lt;vector&gt;<br> using namespace std;</p> 
  <p>string user[2] = { "lyh0", "lyh1" };<br> string pwd[2] = { "lyh0", "lyh1" };<br> string chat[2] = { "Hello!", "Hi!" };<br> vector&lt;string&gt; loginusr;</p> 
  <p>//存放socket的数组<br> vector&lt;SOCKET&gt; g_clients;</p> 
  <p>enum cmd<br> {<br> &nbsp;&nbsp; &nbsp;cmd_login,<br> &nbsp;&nbsp; &nbsp;cmd_login_result,<br> &nbsp;&nbsp; &nbsp;cmd_logout,<br> &nbsp;&nbsp; &nbsp;cmd_logout_result,<br> &nbsp;&nbsp; &nbsp;cmd_new_user_join,<br> &nbsp;&nbsp; &nbsp;cmd_chat,<br> &nbsp;&nbsp; &nbsp;cmd_error<br> };</p> 
  <p>//数据包头<br> struct DataHeader<br> {<br> &nbsp;&nbsp; &nbsp;short datalength;<br> &nbsp;&nbsp; &nbsp;short cmd;<br> };</p> 
  <p>//可以用下面的这种写法，但是不利于衍生成更复杂的消息。<br> //struct Login<br> //{<br> //&nbsp;&nbsp; &nbsp;DataHeader dataheader;<br> //&nbsp;&nbsp; &nbsp;char username[32];<br> //&nbsp;&nbsp; &nbsp;char password[32];<br> //};</p> 
  <p>//用继承的方式将报头和报体放在一起发送<br> struct Login : public DataHeader<br> {<br> &nbsp;&nbsp; &nbsp;//在构造函数里面初始化<br> &nbsp;&nbsp; &nbsp;Login()<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;datalength = sizeof(Login);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cmd = cmd_login;<br> &nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;char username[32];<br> &nbsp;&nbsp; &nbsp;char password[32];<br> };</p> 
  <p>struct Loginresult : public DataHeader<br> {<br> &nbsp;&nbsp; &nbsp;Loginresult()<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;datalength = sizeof(Loginresult);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cmd = cmd_login_result;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;result = 0;<br> &nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;int result;<br> };</p> 
  <p>struct Logout : public DataHeader<br> {<br> &nbsp;&nbsp; &nbsp;Logout()<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;datalength = sizeof(Logout);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cmd = cmd_logout;<br> &nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;char username[32];<br> };</p> 
  <p>struct Logoutresult : public DataHeader<br> {<br> &nbsp;&nbsp; &nbsp;Logoutresult()<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;datalength = sizeof(Logoutresult);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cmd = cmd_logout_result;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;result = 0;<br> &nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;int result;<br> };</p> 
  <p>struct Message : public DataHeader<br> {<br> &nbsp;&nbsp; &nbsp;Message()<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;datalength = sizeof(Message);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cmd = cmd_chat;<br> &nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;char message[256];<br> };</p> 
  <p>struct Messageret : public DataHeader<br> {<br> &nbsp;&nbsp; &nbsp;Messageret()<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;datalength = sizeof(Messageret);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cmd = cmd_chat;<br> &nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;char messageret[256];<br> };</p> 
  <p>struct Newuserjoin : public DataHeader<br> {<br> &nbsp;&nbsp; &nbsp;Newuserjoin()<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;datalength = sizeof(Newuserjoin);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cmd = cmd_new_user_join;<br> &nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;int socketid;<br> };</p> 
  <p>//把处理请求的逻辑写成一个函数<br> int Process(SOCKET _clientSock)<br> {<br> &nbsp;&nbsp; &nbsp;//用缓冲区接受数据<br> &nbsp;&nbsp; &nbsp;char recvBuf[1024] = {};<br> &nbsp;&nbsp; &nbsp;DataHeader* header = (DataHeader*)recvBuf;<br> &nbsp;&nbsp; &nbsp;//5.1. recv 接收客户端发送的数据<br> &nbsp;&nbsp; &nbsp;int nlen = recv(_clientSock, recvBuf, sizeof(DataHeader), 0);<br> &nbsp;&nbsp; &nbsp;if (nlen &lt;= 0)<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("Client %d exit!\n", (int)_clientSock);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;return -1;<br> &nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;//5.2 send 处理请求, 向客户端发送数据, 用switch判断命令<br> &nbsp;&nbsp; &nbsp;switch (header-&gt;cmd)<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;case cmd_login:<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//接受客户端输入的账号密码<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//使用datalength获取数据<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;recv(_clientSock, recvBuf + sizeof(DataHeader), header-&gt;datalength - sizeof(DataHeader), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Login* login = (Login*)recvBuf;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("receive cmd from &lt;Socket: %d&gt;, cmd: cmd_login.\n", (int)_clientSock);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Loginresult result;</p> 
  <p>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//防止重复登录<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (0 != loginusr.size())<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;for (int i = 0; i &lt; (int)loginusr.size(); i++)<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (loginusr[i] == string(login-&gt;username))<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;result.result = 2;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (2 == result.result)<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;send(_clientSock, (char*)&amp;result, sizeof(Loginresult), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;return 1;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}</p> 
  <p>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//判断用户名与密码是否正确的过程<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;for (int i = 0; i &lt; 2; i++)<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (user[i] == string(login-&gt;username))<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (pwd[i] == string(login-&gt;password))<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;loginusr.push_back(user[i]);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("it is %d users connect now.\n", (int)loginusr.size());<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;result.result = 1;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;send(_clientSock, (char*)&amp;result, sizeof(Loginresult), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;return 1;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;else<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;result.result = 0;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;send(_clientSock, (char*)&amp;result, sizeof(Loginresult), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;return 1;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;send(_clientSock, (char*)&amp;result, sizeof(Loginresult), 0);<br> &nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;break;<br> &nbsp;&nbsp; &nbsp;case cmd_logout:<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;recv(_clientSock, recvBuf + sizeof(DataHeader), header-&gt;datalength - sizeof(DataHeader), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Logout* logout = (Logout*)recvBuf;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Logoutresult result;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//判断用户名是否正确,且用户在已登录的名单中<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;for (int i = 0; i &lt; (int)loginusr.size(); i++)<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (loginusr[i] == string(logout-&gt;username))<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;result.result = 1;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("receive cmd from &lt;Socket: %d&gt;, cmd: cmd_logout.\n", (int)_clientSock);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("%s logout!\n", logout-&gt;username);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;loginusr.erase(loginusr.begin() + i);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("it is %d users connect now .\n", (int)loginusr.size());<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;break;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;send(_clientSock, (char*)&amp;result, sizeof(Logoutresult), 0);<br> &nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;break;<br> &nbsp;&nbsp; &nbsp;case cmd_chat:<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;recv(_clientSock, recvBuf + sizeof(DataHeader), header-&gt;datalength - sizeof(DataHeader), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("receive cmd from &lt;Socket: %d&gt;, cmd: cmd_chat.\n", (int)_clientSock);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Message* message = (Message*)recvBuf;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("receive message: %s \n", message-&gt;message);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Messageret messageret;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (0 == strcmp(message-&gt;message, "hello"))<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;strcpy(messageret.messageret, chat[0].c_str());<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//再发消息体<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;send(_clientSock, (char*)&amp;messageret, sizeof(Messageret), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;break;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;else if (0 == strcmp(message-&gt;message, "hi"))<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;strcpy(messageret.messageret, chat[1].c_str());<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//再发消息体<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;send(_clientSock, (char*)&amp;messageret, sizeof(Messageret), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;break;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;else<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;strcpy(messageret.messageret, "pardon");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//再发消息体<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;send(_clientSock, (char*)&amp;messageret, sizeof(Messageret), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;break;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;break;<br> &nbsp;&nbsp; &nbsp;default:<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;DataHeader head = { 0,cmd_error };<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;send(_clientSock, (char*)&amp;header, sizeof(DataHeader), 0);<br> &nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;break;<br> &nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;return 1;<br> }</p> 
  <p>int main()<br> {<br> &nbsp;&nbsp; &nbsp;WORD ver = MAKEWORD(2, 2);<br> &nbsp;&nbsp; &nbsp;WSADATA dat;<br> &nbsp;&nbsp; &nbsp;WSAStartup(ver, &amp;dat);</p> 
  <p>&nbsp;&nbsp; &nbsp;//用socket API建立简易的服务器端<br> &nbsp;&nbsp; &nbsp;//1.建立一个socket<br> &nbsp;&nbsp; &nbsp;SOCKET _sock = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);</p> 
  <p>&nbsp;&nbsp; &nbsp;//2.bind 绑定用于接受客户端连接的网络端口号<br> &nbsp;&nbsp; &nbsp;sockaddr_in _sin = {};<br> &nbsp;&nbsp; &nbsp;_sin.sin_family = AF_INET; &nbsp; &nbsp; &nbsp; &nbsp; //用于网络连接的类型，IPv4，与上面定义的一样<br> &nbsp;&nbsp; &nbsp;_sin.sin_port = htons(4567); &nbsp; &nbsp; &nbsp; //host to net unsigned short，这里要转换一下端口号<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; &nbsp; //_sin.sin_addr.S_un.S_addr = inet_addr("127.0.0.1"); &nbsp; &nbsp; //服务器程序绑定的IP地址，纯内网的应用程序可以用127.0.0.1<br> &nbsp;&nbsp; &nbsp;_sin.sin_addr.S_un.S_addr = INADDR_ANY;<br> &nbsp;&nbsp; &nbsp;//_sin.sin_addr.S_un.S_addr = INADDR_ANY; //随意什么地址都可以访问<br> &nbsp;&nbsp; &nbsp;//bind是有可能失败的，端口被占用的时候，所以要判断是否成功<br> &nbsp;&nbsp; &nbsp;int bindret = bind(_sock, (sockaddr*)&amp;_sin, sizeof(sockaddr_in));<br> &nbsp;&nbsp; &nbsp;if (SOCKET_ERROR == bindret)<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("ERROR! bind failed !\n");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;getchar();<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;return 1;<br> &nbsp;&nbsp; &nbsp;}</p> 
  <p>&nbsp;&nbsp; &nbsp;//3.listen 监听网络端口<br> &nbsp;&nbsp; &nbsp;//同样的监听也可能失败的，需要加以判断<br> &nbsp;&nbsp; &nbsp;int listenret = listen(_sock, 3);<br> &nbsp;&nbsp; &nbsp;if (SOCKET_ERROR == listenret)<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("ERROR! listen failed !\n");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;getchar();<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;return 1;<br> &nbsp;&nbsp; &nbsp;}</p> 
  <p>&nbsp;&nbsp; &nbsp;printf("* * * * * * * * * * * * * * * * * * * * * * * * * * * *\n");<br> &nbsp;&nbsp; &nbsp;printf("* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *\n");<br> &nbsp;&nbsp; &nbsp;printf("* &nbsp; &nbsp; &nbsp; &nbsp; Welcome to the first Socket Sever &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *\n");<br> &nbsp;&nbsp; &nbsp;printf("* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *\n");<br> &nbsp;&nbsp; &nbsp;printf("* * * * * * * * * * * * * * * * * * * * * * * * * * * *\n");</p> 
  <p>&nbsp;&nbsp; &nbsp;//5. send 向客户端发送数据<br> &nbsp;&nbsp; &nbsp;while (1)<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//使用select模型</p> 
  <p>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//定义socket集合<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;fd_set fdRead;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;fd_set fdWead;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;fd_set fdExp;</p> 
  <p>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//清空<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;FD_ZERO(&amp;fdRead);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;FD_ZERO(&amp;fdWead);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;FD_ZERO(&amp;fdExp);</p> 
  <p>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//设置集合<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;FD_SET(_sock, &amp;fdRead);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;FD_SET(_sock, &amp;fdWead);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;FD_SET(_sock, &amp;fdExp);</p> 
  <p>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//查询g_clients里面的socket是否有可读要求<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;for (int i = (int)g_clients.size() - 1; i &gt;= 0; i--)<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;FD_SET(g_clients[i], &amp;fdRead);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}</p> 
  <p>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//nfds 是一个整数值，是指集合fd_set中所有socket的范围（是最大的socket值+1），而不是数量。<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//而在Windows下可以传入0，Windows下自动处理了。</p> 
  <p>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;timeval time = { 1, 0 }; &nbsp; &nbsp;//第一个参数是最大查询时间 单位s，第二个是ms</p> 
  <p>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//select 设置了最后一个参数timeval之后，程序在select处等待最大时间，没有数据读取便会返回。不会一直阻塞在select处。<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;int selectret = select((int)_sock + 1, &amp;fdRead, &amp;fdWead, &amp;fdExp, &amp;time);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (selectret &lt; 0)<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//select小于0就是出错了<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("select finish..error.\n");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;break;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}</p> 
  <p>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (FD_ISSET(_sock, &amp;fdRead))<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//清理标志位<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;FD_CLR(_sock, &amp;fdRead);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//客户端的连接要放在此处执行<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//4.accept 等待接受客户端连接<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;sockaddr_in clientAddr = {}; &nbsp; &nbsp; //远程客户端的地址&nbsp;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;int nAddrlen = sizeof(sockaddr_in);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;SOCKET _clientSock = INVALID_SOCKET; &nbsp; &nbsp;//接受的客户端是无效的，大规模程序的时候有可能<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;_clientSock = accept(_sock, (sockaddr*)&amp;clientAddr, &amp;nAddrlen);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (INVALID_SOCKET == _clientSock)<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("ERROR!, INVALID CLIENT!\n");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//有新的客户端加入，群发消息给别的客户端。<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Newuserjoin userjoin; &nbsp; //构造函数里面已经初始化<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;userjoin.socketid = (int)_clientSock;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;for (int i = (int)g_clients.size() - 1; i &gt;= 0; i--)<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;send(g_clients[i], (const char*)&amp;userjoin, sizeof(Newuserjoin), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}</p> 
  <p>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//将新连接的客户端加入进g_clients数组中<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;g_clients.push_back(_clientSock);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("new Client connected &nbsp;:socket = %d &nbsp;IP = %s \n", (int)_clientSock, inet_ntoa(clientAddr.sin_addr));<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}</p> 
  <p>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//循环处理客户端数组里面的客户端请求<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;for (size_t i = 0; i &lt; fdRead.fd_count; i++)<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (-1 == Process(fdRead.fd_array[i]))<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;auto iter = find(g_clients.begin(), g_clients.end(), fdRead.fd_array[i]);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (iter != g_clients.end())<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;g_clients.erase(iter);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//printf("do other things.............\n");<br> &nbsp;&nbsp; &nbsp;}</p> 
  <p>&nbsp;&nbsp; &nbsp;//6.close 关闭socket<br> &nbsp;&nbsp; &nbsp;//程序结束一定要关闭所有的socket<br> &nbsp;&nbsp; &nbsp;for (int i = (int)g_clients.size() - 1; i &gt;= 0; i--)<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;closesocket(g_clients[i]);<br> &nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;closesocket(_sock);<br> &nbsp;&nbsp; &nbsp;WSACleanup();<br> &nbsp;&nbsp; &nbsp;//printf("Client exit !, Sever exit ! \n");<br> &nbsp;&nbsp; &nbsp;//getchar();<br> &nbsp;&nbsp; &nbsp;return 0;<br> }</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <p>Client.cpp</p> 
  <p>&nbsp;</p> 
  <p>#define WIN32_LEAN_AND_MEAN<br> #define _WINSOCK_DEPRECATED_NO_WARNINGS<br> #define _CRT_SECURE_NO_WARNINGS</p> 
  <p>//或者把winsock2放在Windows前面<br> #include &lt;Windows.h&gt;<br> #include &lt;WinSock2.h&gt;<br> #include &lt;stdio.h&gt;<br> #include &lt;thread&gt;<br> #include &lt;iostream&gt;<br> #include &lt;string&gt;<br> //#pragma comment(lib, "ws2_32.lib") &nbsp; //调用了Windows的库，要加载这个静态链接库才能使用<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; &nbsp; //Windows下才可以这样写，Linux下不可以这样写</p> 
  <p>int MainThreadRun = 1;</p> 
  <p>enum cmd<br> {<br> &nbsp;&nbsp; &nbsp;cmd_login,<br> &nbsp;&nbsp; &nbsp;cmd_login_result,<br> &nbsp;&nbsp; &nbsp;cmd_logout,<br> &nbsp;&nbsp; &nbsp;cmd_logout_result,<br> &nbsp;&nbsp; &nbsp;cmd_new_user_join,<br> &nbsp;&nbsp; &nbsp;cmd_chat,<br> &nbsp;&nbsp; &nbsp;cmd_error<br> };</p> 
  <p>//数据包头<br> struct DataHeader<br> {<br> &nbsp;&nbsp; &nbsp;short datalength;<br> &nbsp;&nbsp; &nbsp;short cmd;<br> };</p> 
  <p>//可以用下面的这种写法，但是不利于衍生成更复杂的消息。<br> //struct Login<br> //{<br> //&nbsp;&nbsp; &nbsp;DataHeader dataheader;<br> //&nbsp;&nbsp; &nbsp;char username[32];<br> //&nbsp;&nbsp; &nbsp;char password[32];<br> //};</p> 
  <p>//用继承的方式将报头和报体放在一起发送<br> struct Login : public DataHeader<br> {<br> &nbsp;&nbsp; &nbsp;//在构造函数里面初始化<br> &nbsp;&nbsp; &nbsp;Login()<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;datalength = sizeof(Login);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cmd = cmd_login;<br> &nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;char username[32];<br> &nbsp;&nbsp; &nbsp;char password[32];<br> };</p> 
  <p>struct Loginresult : public DataHeader<br> {<br> &nbsp;&nbsp; &nbsp;Loginresult()<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;datalength = sizeof(Loginresult);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cmd = cmd_login_result;<br> &nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;int result;<br> };</p> 
  <p>struct Logout : public DataHeader<br> {<br> &nbsp;&nbsp; &nbsp;Logout()<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;datalength = sizeof(Logout);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cmd = cmd_logout;<br> &nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;char username[32];<br> };</p> 
  <p>struct Logoutresult : public DataHeader<br> {<br> &nbsp;&nbsp; &nbsp;Logoutresult()<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;datalength = sizeof(Logoutresult);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cmd = cmd_logout_result;<br> &nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;int result;<br> };</p> 
  <p>struct Message : public DataHeader<br> {<br> &nbsp;&nbsp; &nbsp;Message()<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;datalength = sizeof(Message);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cmd = cmd_chat;<br> &nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;char message[256];<br> };</p> 
  <p>struct Messageret : public DataHeader<br> {<br> &nbsp;&nbsp; &nbsp;Messageret()<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;datalength = sizeof(Messageret);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cmd = cmd_chat;<br> &nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;char messageret[256];<br> };</p> 
  <p>struct Newuserjoin : public DataHeader<br> {<br> &nbsp;&nbsp; &nbsp;Newuserjoin()<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;datalength = sizeof(Newuserjoin);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cmd = cmd_new_user_join;<br> &nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;int socketid;<br> };</p> 
  <p>int Process(SOCKET _sock)<br> {<br> &nbsp;&nbsp; &nbsp;//接收缓冲区<br> &nbsp;&nbsp; &nbsp;char recvBuf[1024] = {};<br> &nbsp;&nbsp; &nbsp;//接收数据<br> &nbsp;&nbsp; &nbsp;int msglen = recv(_sock, recvBuf, sizeof(DataHeader), 0);<br> &nbsp;&nbsp; &nbsp;DataHeader* header = (DataHeader*)recvBuf;<br> &nbsp;&nbsp; &nbsp;if (msglen &lt;= 0)<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("Disconnect! Mission Done!\n");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;return -1;<br> &nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;//处理服务器发送/返回的消息<br> &nbsp;&nbsp; &nbsp;switch (header-&gt;cmd)<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;case cmd_login_result:<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//接收数据<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Loginresult loginret = {};<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;recv(_sock, recvBuf + sizeof(DataHeader), header-&gt;datalength - sizeof(DataHeader), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//判断返回的结果<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//printf("loginresult is : %d \n", loginret.result);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (loginret.result == 1)<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("&lt;SOCKET: %d&gt; login successfully....\n", (int)_sock);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//printf("Friday: Can I help you? Sir.\n");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//登录之后才能进行的操作<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//while (1)<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;char msg[256] = {};<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;scanf("%s", msg);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;if (0 == strcmp(msg, "exit"))<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("you are welcome.\n");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;break;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;Message message;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;strcpy(message.message, msg);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;//向服务器发送包体<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;send(_sock, (const char*)&amp;message, sizeof(Message), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;Messageret messageret = {};<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;recv(_sock, (char*)&amp;messageret, sizeof(Messageret), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;//打印收到的消息<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;printf("Friday : %s\n", messageret.messageret);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//else if (loginret.result == 2)<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;printf("the %s has already login !\n", username);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//else<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;printf("username or password error, please check.\n");<br> &nbsp;&nbsp; &nbsp;}break;</p> 
  <p>&nbsp;&nbsp; &nbsp;case cmd_logout_result:<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//接收数据<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;recv(_sock, recvBuf + sizeof(DataHeader), header-&gt;datalength - sizeof(DataHeader), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Logoutresult* logoutret = (Logoutresult*)recvBuf;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (1 == logoutret-&gt;result)<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("&lt;SOCKET: %d&gt; logout successfully....\n", (int)_sock);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}</p> 
  <p>&nbsp;&nbsp; &nbsp;}break;</p> 
  <p>&nbsp;&nbsp; &nbsp;case cmd_new_user_join:<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//接收数据<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;recv(_sock, recvBuf + sizeof(DataHeader), header-&gt;datalength - sizeof(DataHeader), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Newuserjoin* userjoin = (Newuserjoin*)recvBuf;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("New User Connected! &lt;SOCKET ID: %d&gt;\n", userjoin-&gt;socketid);<br> &nbsp;&nbsp; &nbsp;}break;</p> 
  <p>&nbsp;&nbsp; &nbsp;default:<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("Receive Nothing from Sever!\n");<br> &nbsp;&nbsp; &nbsp;}break;</p> 
  <p>&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;return 1;<br> }</p> 
  <p>void cmdthread(SOCKET _sock)<br> {<br> &nbsp;&nbsp; &nbsp;while (1)<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;char cmdBuf[256] = {};<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;scanf("%s", cmdBuf);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (0 == strcmp(cmdBuf, "exit"))<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("exit client!\n");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;MainThreadRun = 0;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;return;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;else if (0 == strcmp(cmdBuf, "login"))<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Login login;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Loginresult liret;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;char username[32] = {};<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;char password[32] = {};<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("input your username: ");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;scanf("%s", username);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("input your password: ");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;scanf("%s", password);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;strcpy(login.username, username);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;strcpy(login.password, password);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;send(_sock, (const char*)&amp;login, sizeof(Login), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//接受登录结果<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;recv(_sock, (char*)&amp;liret, sizeof(Loginresult), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//判断登录结果<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (liret.result == 1)<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("%s login successfully！\n", username);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//登录之后与服务器发送消息<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;while (1)<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("%s: ", username);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;char msg[256] = {};<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//std::cin.get();<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//这里有个getline的小bug...一开始函数进来总会多一个换行符号<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;std::cin.getline(msg, 255, '\n');<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (0 == strcmp(msg, "exit chat with sever"))<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("Exit Chatting Window.\n");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;break;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Message message;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;strcpy(message.message, msg);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//向服务器发送包体<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;send(_sock, (const char*)&amp;message, sizeof(Message), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Messageret messageret = {};<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;recv(_sock, (char*)&amp;messageret, sizeof(Messageret), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//打印收到的消息<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("Sever: %s\n", messageret.messageret);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;else if (liret.result == 2)<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("The %s had already login!\n", username);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;else<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("username or password error, please check.\n");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;else if (0 == strcmp(cmdBuf, "logout"))<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Logout logout;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Logoutresult lgret;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;char username[32] = {};<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("input the username you want to logout: ");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;scanf("%s", username);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;strcpy(logout.username, username);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;send(_sock, (const char*)&amp;logout, sizeof(Logout), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//接受登出结果<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;recv(_sock, (char*)&amp;lgret, sizeof(Logoutresult), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (lgret.result == 1)<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("%s logout successful!\n", username);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;else<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("%s logout failed ! %s may not login or it is not the legal user.\n", username, username);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;else<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("Usupported Cmd!\n");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;return;<br> }</p> 
  <p>int main()<br> {</p> 
  <p>&nbsp;&nbsp; &nbsp;WORD ver = MAKEWORD(2, 2); &nbsp; //版本号<br> &nbsp;&nbsp; &nbsp;WSADATA dat;<br> &nbsp;&nbsp; &nbsp;WSAStartup(ver, &amp;dat);</p> 
  <p>&nbsp;&nbsp; &nbsp;//1. socket 建立一个socket<br> &nbsp;&nbsp; &nbsp;SOCKET _sock = socket(AF_INET, SOCK_STREAM, 0);<br> &nbsp;&nbsp; &nbsp;if (INVALID_SOCKET == _sock)<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("ERROR! build socket failed !\n");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;getchar();<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;return 1;<br> &nbsp;&nbsp; &nbsp;}</p> 
  <p>&nbsp;&nbsp; &nbsp;//2.connect 连接服务器<br> &nbsp;&nbsp; &nbsp;sockaddr_in _sin = {};<br> &nbsp;&nbsp; &nbsp;_sin.sin_family = AF_INET;<br> &nbsp;&nbsp; &nbsp;_sin.sin_port = htons(4567);<br> &nbsp;&nbsp; &nbsp;//_sin.sin_addr.S_un.S_addr = inet_addr("193.112.24.176");<br> &nbsp;&nbsp; &nbsp;_sin.sin_addr.S_un.S_addr = inet_addr("127.0.0.1");<br> &nbsp;&nbsp; &nbsp;int ret = connect(_sock, (sockaddr*)&amp;_sin, sizeof(sockaddr_in));<br> &nbsp;&nbsp; &nbsp;if (SOCKET_ERROR == ret)<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("ERROR! connect sever failed !\n");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;getchar();<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;return 1;<br> &nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;printf("Successfully connect to the Sever, Please input your cmd.\n");</p> 
  <p>&nbsp;&nbsp; &nbsp;//启动线程<br> &nbsp;&nbsp; &nbsp;std::thread td(cmdthread, _sock);<br> &nbsp;&nbsp; &nbsp;//使得主线程和cmd线程分离，不然进入cmd线程之后，主线程可能先关了<br> &nbsp;&nbsp; &nbsp;td.detach();</p> 
  <p>&nbsp;&nbsp; &nbsp;while (MainThreadRun)<br> &nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//使用select模型<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;fd_set fdReads;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;FD_ZERO(&amp;fdReads);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;FD_SET(_sock, &amp;fdReads);</p> 
  <p>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;timeval time = { 1,0 };<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;int selectret = select((int)_sock, &amp;fdReads, 0, 0, &amp;time);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (selectret &lt; 0)<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("select error, exit...");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;break;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}</p> 
  <p>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (FD_ISSET(_sock, &amp;fdReads))<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;FD_CLR(_sock, &amp;fdReads);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (-1 == Process(_sock))<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("Disconnect! Mission Done!\n");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;break;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}</p> 
  <p>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//printf("do other things\n");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;////3. send 发送数据到服务器<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//char msgbuf[1024] = {};<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;////这个scanf函数是阻塞的，要是服务器也像客户端发送数据的话，应该使用多线程<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//scanf("%s", msgbuf);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//if (0 == strcmp(msgbuf, "exit"))<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;printf("exit client!\n");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;break;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//else if (0 == strcmp(msgbuf, "login"))<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;char username[32] = {};<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;char password[32] = {};<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;printf("input your username:\n");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;scanf("%s", username);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;printf("input the password:\n");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;scanf("%s", password);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;Login login;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;strcpy(login.username, username);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;strcpy(login.password, password);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;//向服务器发送报体（里面已经包含了报头）<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;send(_sock, (const char*)&amp;login, sizeof(Login), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;//接受服务器返回数据<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;Loginresult loginret = {};<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;recv(_sock, (char*)&amp;loginret, sizeof(Loginresult), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;//判断返回的结果<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;//printf("loginresult is : %d \n", loginret.result);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;if (loginret.result == 1)<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf(" %s login successfully....\n", username);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("Friday: Can I help you? Sir.\n");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//登录之后才能进行的操作<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;while (1)<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;char msg[256] = {};<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;scanf("%s", msg);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (0 == strcmp(msg, "exit"))<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("you are welcome.\n");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;break;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Message message;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;strcpy(message.message, msg);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//向服务器发送包体<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;send(_sock, (const char*)&amp;message, sizeof(Message), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Messageret messageret = {};<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;recv(_sock, (char*)&amp;messageret, sizeof(Messageret), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//打印收到的消息<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("Friday : %s\n", messageret.messageret);</p> 
  <p>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;else if (loginret.result == 2)<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("the %s has already login !\n", username);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;else<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("username or password error, please check.\n");</p> 
  <p>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//else if (0 == strcmp(msgbuf, "logout"))<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;char username[32] = {};<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;printf("input the username you want to logout:\n");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;scanf("%s", username);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;Logout logout;<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;strcpy(logout.username, username);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;//向服务器发送包体<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;send(_sock, (const char*)&amp;logout, sizeof(Logout), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;//接受服务器返回数据<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;Logoutresult logoutret = {};<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;recv(_sock, (char*)&amp;logoutret, sizeof(Logoutresult), 0);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;//判断返回的结果<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;//printf("%d\n", logoutret.result);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;if (logoutret.result == 1)<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("%s logout successful !\n", username);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;else<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;printf("%s logout failed ! %s may not login or it is not the legal user.\n", username, username);<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//}<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//else<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//{<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp; &nbsp;printf("Unsupportable cmd, request end.\n");<br> &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;//}<br> &nbsp;&nbsp; &nbsp;}</p> 
  <p>&nbsp;&nbsp; &nbsp;//5.close 关闭socket<br> &nbsp;&nbsp; &nbsp;closesocket(_sock);<br> &nbsp;&nbsp; &nbsp;WSACleanup();<br> &nbsp;&nbsp; &nbsp;printf("Client exit !\n");<br> &nbsp;&nbsp; &nbsp;getchar();<br> &nbsp;&nbsp; &nbsp;return 0;<br> }</p> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
