<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>推荐一个简单好用的接口——字典序列化 « NotBeCN</title>
  <meta name="description" content="                  一.&nbsp;我们的需求     &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;你是否和我一样有如下的困扰：          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;你需要将一个类转换为XML或JSON存储或传输，但总有你不想存储或想特殊处...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2016/09/27/weixin_33858485_90123839.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">推荐一个简单好用的接口——字典序列化</h1>
    <p class="post-meta">Sep 27, 2016</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <div class="blogpost-body"> 
    <h1>一.&nbsp;我们的需求</h1> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;你是否和我一样有如下的困扰：</p> 
    <ul>
     <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;你需要将一个类转换为XML或JSON存储或传输，但总有你不想存储或想特殊处理的字段，用序列化器自身的反射功能就看起来颇为鸡肋了。</li> 
     <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;与MongoDB等键值对数据库做交互，很多ORM框架都无效了，如何写一个通用的数据接口层？而且不用去添加丑陋的"MongoIgnore"这样的attribute?</li> 
     <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;你要将一个对象的属性“拷贝”到另外一个对象，怎么做？C语言的拷贝构造函数？那太原始了。</li> 
     <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;界面绑定：总有一些绑定表达式，想通过动态的形式提交给框架，而不是写死在xaml里，那是否又得在C#里写一堆对象映射的代码了？</li> 
    </ul>
    <p>&nbsp;&nbsp;&nbsp;&nbsp; 大家肯定都遇到过和我相似的困扰，为了存储或读取某个对象（比如从文件或数据库里读取），你不得不写下大量数据类型转换和赋值语句，而且在程序中不能复用，这样的代码到处都是，真是代码的臭味。&nbsp;</p> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp; 由于键值对的概念已经深入人心，于是便有了这样一个叫做“字典序列化”的接口，该接口不是官方定义的，而是我根据实际需求总结的，同时我发现，它真的非常好用。</p> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;废话不说，先看该接口的定义：</p> 
    <div class="cnblogs_code"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy"><img alt="复制代码" src="http://common.cnblogs.com/images/copycode.gif"></span>
     </div> 
     <pre>  <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;summary&gt;</span>
    <span style="color:#808080;">///</span><span style="color:#008000;"> 进行字典序列化的接口，方便实现键值对的映射关系和重建
    </span><span style="color:#808080;">///</span> <span style="color:#808080;">&lt;/summary&gt;</span>
    <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">interface</span> IDictionarySerializable
    {
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;summary&gt;</span>
        <span style="color:#808080;">///</span><span style="color:#008000;"> 从数据到字典
        </span><span style="color:#808080;">///</span> <span style="color:#808080;">&lt;/summary&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;returns&gt;&lt;/returns&gt;</span>
        IDictionary&lt;<span style="color:#0000ff;">string</span>, <span style="color:#0000ff;">object</span>&gt; DictSerialize(Scenario scenario = Scenario.Database);

        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;summary&gt;</span>
        <span style="color:#808080;">///</span><span style="color:#008000;"> 从字典到数据
        </span><span style="color:#808080;">///</span> <span style="color:#808080;">&lt;/summary&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;param name="dicts"&gt;</span><span style="color:#008000;">字典</span><span style="color:#808080;">&lt;/param&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;param name="scenario"&gt;</span><span style="color:#008000;">应用场景</span><span style="color:#808080;">&lt;/param&gt;</span>
        <span style="color:#0000ff;">void</span> DictDeserialize(IDictionary&lt;<span style="color:#0000ff;">string</span>, <span style="color:#0000ff;">object</span>&gt; dicts, Scenario scenario = Scenario.Database);
    }  </pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy"><img alt="复制代码" src="http://common.cnblogs.com/images/copycode.gif"></span>
     </div> 
    </div> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;它只有两个方法，一个是从字典中读取数据到实体类，另一个是将实体类的数据写入字典。你要做的，就是让你的实体类实现这个接口。</p> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp; 值得注意的是，函数参数中有一个Scenario枚举，该枚举指定了转换的场景，例如数据库和用户界面，在转换时可能就有一定的区别，程序员可通过实际情况来确定，具体原因可以看下边的部分。你可以传入更多的参数，指示该接口的独特序列化方法。</p> 
    <h1>二.&nbsp;如何使用？</h1> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;先定义一个实体类：Artical, 它是一个简单的POCO类型， 包含Title等六个属性，为了节约篇幅，就不在此声明它了。我们先看如下的代码：</p> 
    <div class="cnblogs_code"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy"><img alt="复制代码" src="http://common.cnblogs.com/images/copycode.gif"></span>
     </div> 
     <pre>  <span style="color:#008000;">//</span><span style="color:#008000;">define a entity named Artical with following propertynames</span>
   <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> DictDeserialize(IDictionary&lt;<span style="color:#0000ff;">string</span>, <span style="color:#0000ff;">object</span>&gt; dicts)
        {
            Title = (<span style="color:#0000ff;">string</span>)dicts[<span style="color:#800000;">"</span><span style="color:#800000;">Title</span><span style="color:#800000;">"</span>];
            PublishTime = (DateTime)dicts[<span style="color:#800000;">"</span><span style="color:#800000;">PublishTime</span><span style="color:#800000;">"</span>];
            Author = (<span style="color:#0000ff;">string</span>)dicts[<span style="color:#800000;">"</span><span style="color:#800000;">Author</span><span style="color:#800000;">"</span>];
            ArticalContent = (<span style="color:#0000ff;">string</span>)dicts[<span style="color:#800000;">"</span><span style="color:#800000;">ArticalContent</span><span style="color:#800000;">"</span>];
            PaperID =  (<span style="color:#0000ff;">int</span>)dicts[<span style="color:#800000;">"</span><span style="color:#800000;">PaperID</span><span style="color:#800000;">"</span>];
            ClassID =  (<span style="color:#0000ff;">string</span>)dicts[<span style="color:#800000;">"</span><span style="color:#800000;">ClassID</span><span style="color:#800000;">"</span>];
        }
     <span style="color:#0000ff;">public</span> IDictionary&lt;<span style="color:#0000ff;">string</span>, <span style="color:#0000ff;">object</span>&gt; DictSerialize()
        {
            <span style="color:#0000ff;">var</span> dict = <span style="color:#0000ff;">new</span> Dictionary&lt;<span style="color:#0000ff;">string</span>, <span style="color:#0000ff;">object</span>&gt;
                {
                    { <span style="color:#800000;">"</span><span style="color:#800000;">Title</span><span style="color:#800000;">"</span>, <span style="color:#0000ff;">this</span>.Title },
                    { <span style="color:#800000;">"</span><span style="color:#800000;">PublishTime</span><span style="color:#800000;">"</span>, <span style="color:#0000ff;">this</span>.PublishTime.Value },
                    { <span style="color:#800000;">"</span><span style="color:#800000;">Author</span><span style="color:#800000;">"</span>, <span style="color:#0000ff;">this</span>.Author },
                    { <span style="color:#800000;">"</span><span style="color:#800000;">ArticalContent</span><span style="color:#800000;">"</span>, <span style="color:#0000ff;">this</span>.ArticalContent },
                    { <span style="color:#800000;">"</span><span style="color:#800000;">PaperID</span><span style="color:#800000;">"</span>, <span style="color:#0000ff;">this</span>.PaperID.Value },
                    { <span style="color:#800000;">"</span><span style="color:#800000;">ClassID</span><span style="color:#800000;">"</span>, <span style="color:#0000ff;">this</span>.ClassID }
                };
            <span style="color:#0000ff;">return</span> dict;
        }</pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy"><img alt="复制代码" src="http://common.cnblogs.com/images/copycode.gif"></span>
     </div> 
    </div> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;它指示了最常用的使用场景。可是读者可能会注意到以下问题：</p> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Title = (<span style="color:#0000ff;">string</span>)dicts[<span style="color:#800000;">"</span><span style="color:#800000;">Title</span><span style="color:#800000;">"</span>];&nbsp;</p> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(1) 如果字典中没有对应的属性项，那么通过索引器读这个属性是会报错的。</p> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (2)&nbsp;即使有对应的属性项，可它的值是Null，那么它可能覆盖掉原本是正常的属性值。</p> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(3)&nbsp;类型不统一：这个字典可能是由JSON序列化器提供的，或是由某数据库的驱动提供的，那么，一个表示时间的字段，传过来的类型可能是DateTime,也可能是string，如何不用丑陋的代码做复杂的判断和转换呢？</p> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对此，我们添加了一个IDictionary的扩展方法：</p> 
    <div class="cnblogs_code"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy"><img alt="复制代码" src="http://common.cnblogs.com/images/copycode.gif"></span>
     </div> 
     <pre><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> T Set&lt;T&gt;(<span style="color:#0000ff;">this</span> IDictionary&lt;<span style="color:#0000ff;">string</span>, <span style="color:#0000ff;">object</span>&gt; dict, <span style="color:#0000ff;">string</span> key, T oldValue)
        {
            <span style="color:#0000ff;">object</span> data = <span style="color:#0000ff;">null</span>;
            <span style="color:#0000ff;">if</span> (dict.TryGetValue(key, <span style="color:#0000ff;">out</span> data))
            {
                Type type = <span style="color:#0000ff;">typeof</span>(T);
                <span style="color:#0000ff;">if</span> (type.IsEnum)
                {
                    <span style="color:#0000ff;">var</span> index = (T)Convert.ChangeType(data, <span style="color:#0000ff;">typeof</span>(<span style="color:#0000ff;">int</span>));
                    <span style="color:#0000ff;">return</span> (index);
                }
                <span style="color:#0000ff;">if</span> (data == <span style="color:#0000ff;">null</span>)
                {
                    <span style="color:#0000ff;">return</span> oldValue;
                }
                <span style="color:#0000ff;">var</span> value = (T)Convert.ChangeType(data, <span style="color:#0000ff;">typeof</span>(T));
                <span style="color:#0000ff;">return</span> value;
            }

            <span style="color:#0000ff;">return</span> oldValue;
        }</pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy"><img alt="复制代码" src="http://common.cnblogs.com/images/copycode.gif"></span>
     </div> 
    </div> 
    <p>&nbsp;</p> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;于是，从字典中读取数据（字典反序列化），就可以变得像下面这样优雅了，&nbsp;由于编译器的自动类型推断功能，连T都不用写了。如果数据获取失败，原有值不受影响。</p> 
    <div class="cnblogs_code"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy"><img alt="复制代码" src="http://common.cnblogs.com/images/copycode.gif"></span>
     </div> 
     <pre> <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> DictDeserialize(IDictionary&lt;<span style="color:#0000ff;">string</span>, <span style="color:#0000ff;">object</span>&gt; dicts, Scenario scenario = Scenario.Database)
        {
            <span style="color:#0000ff;">this</span>.Title = dicts.Set(<span style="color:#800000;">"</span><span style="color:#800000;">Title</span><span style="color:#800000;">"</span>, <span style="color:#0000ff;">this</span>.Title);
            <span style="color:#0000ff;">this</span>.PublishTime = dicts.Set(<span style="color:#800000;">"</span><span style="color:#800000;">PublishTime</span><span style="color:#800000;">"</span>, <span style="color:#0000ff;">this</span>.PublishTime);
            <span style="color:#0000ff;">this</span>.Author = dicts.Set(<span style="color:#800000;">"</span><span style="color:#800000;">Author</span><span style="color:#800000;">"</span>, <span style="color:#0000ff;">this</span>.Author);
            <span style="color:#0000ff;">this</span>.ArticalContent = dicts.Set(<span style="color:#800000;">"</span><span style="color:#800000;">ArticalContent</span><span style="color:#800000;">"</span>, <span style="color:#0000ff;">this</span>.ArticalContent);
            <span style="color:#0000ff;">this</span>.PaperID = dicts.Set(<span style="color:#800000;">"</span><span style="color:#800000;">PaperID</span><span style="color:#800000;">"</span>, <span style="color:#0000ff;">this</span>.PaperID);
            <span style="color:#0000ff;">this</span>.ClassID = dicts.Set(<span style="color:#800000;">"</span><span style="color:#800000;">ClassID</span><span style="color:#800000;">"</span>, <span style="color:#0000ff;">this</span>.ClassID);  
        }</pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy"><img alt="复制代码" src="http://common.cnblogs.com/images/copycode.gif"></span>
     </div> 
    </div> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;可是，又会有人问，如果某属性的类型是List&lt;T&gt;,比如是string的数组呢？</p> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这个问题会有点复杂，如何保存一个List&lt;string&gt;呢？如果是MongoDB，它的驱动是能直接存储/返回List&lt;string&gt;的，但如果是文件存储，一般会存储成JSON格式，例如["a","b","c","d"]这样的格式，因此我们可以定义如下的扩展方法：</p> 
    <div class="cnblogs_code"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy"><img alt="复制代码" src="http://common.cnblogs.com/images/copycode.gif"></span>
     </div> 
     <pre>        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> List&lt;T&gt; SetArray&lt;T&gt;(<span style="color:#0000ff;">this</span> IDictionary&lt;<span style="color:#0000ff;">string</span>, <span style="color:#0000ff;">object</span>&gt; dict, <span style="color:#0000ff;">string</span> key, List&lt;T&gt; oldValue)
           
        {
            <span style="color:#0000ff;">object</span> data = <span style="color:#0000ff;">null</span>;

            <span style="color:#0000ff;">if</span> (dict.TryGetValue(key, <span style="color:#0000ff;">out</span> data))
            {
                <span style="color:#0000ff;">var</span> list = data <span style="color:#0000ff;">as</span> List&lt;T&gt;;
                <span style="color:#0000ff;">if</span> (list != <span style="color:#0000ff;">null</span>) <span style="color:#0000ff;">return</span> list;
                <span style="color:#0000ff;">string</span> str = data.ToString();
                <span style="color:#0000ff;">if</span> (str==<span style="color:#800000;">"</span><span style="color:#800000;">[]</span><span style="color:#800000;">"</span>)
                    <span style="color:#0000ff;">return</span> oldValue;
                <span style="color:#0000ff;">if</span> (str[<span style="color:#800080;">0</span>] != <span style="color:#800000;">'</span><span style="color:#800000;">[</span><span style="color:#800000;">'</span>) <span style="color:#0000ff;">return</span> oldValue;
                <span style="color:#0000ff;">return</span> JsonConvert.Import&lt;List&lt;T&gt;&gt;(str);
            }
            <span style="color:#0000ff;">return</span> oldValue.ToList();
        }</pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy"><img alt="复制代码" src="http://common.cnblogs.com/images/copycode.gif"></span>
     </div> 
    </div> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这里为了转换JSON风格的string,用了第三方的JSON转换库：Jayrock.Json.&nbsp; 如果你自己有数组和string的转换方法，不妨可以写新的扩展方法。</p> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 通过该接口，可方便的实现对象间的数据拷贝：</p> 
    <div class="cnblogs_code"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy"><img alt="复制代码" src="http://common.cnblogs.com/images/copycode.gif"></span>
     </div> 
     <pre>    <span style="color:#0000ff;">public</span> T Copy&lt;T&gt;(T oldValue) <span style="color:#0000ff;">where</span> T : IDictionarySerializable, <span style="color:#0000ff;">new</span>()
        {
            IDictionary&lt;<span style="color:#0000ff;">string</span>, <span style="color:#0000ff;">object</span>&gt; data = oldValue.DictSerialize();
            <span style="color:#0000ff;">var</span> newValue = <span style="color:#0000ff;">new</span> T();
            newValue.DictDeserialize(data);
            <span style="color:#0000ff;">return</span> newValue;
        }</pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy"><img alt="复制代码" src="http://common.cnblogs.com/images/copycode.gif"></span>
     </div> 
    </div> 
    <p>&nbsp;</p> 
    <h1>&nbsp;&nbsp;三.&nbsp;如何做数据库接口层？</h1> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;有了这样的接口，我们就可以方便的做一个数据接口层，隔离数据库和真实类型了，下面依旧以MongoDB为例。如果我们需要获取表内所有的对象，可用如下的方法：</p> 
    <div class="cnblogs_code"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy"><img alt="复制代码" src="http://common.cnblogs.com/images/copycode.gif"></span>
     </div> 
     <pre>  <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;summary&gt;</span>
        <span style="color:#808080;">///</span><span style="color:#008000;"> 获取数据库中的所有实体
        </span><span style="color:#808080;">///</span> <span style="color:#808080;">&lt;/summary&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;returns&gt;&lt;/returns&gt;</span>
        <span style="color:#0000ff;">public</span> List&lt;T&gt; GetAllEntitys&lt;T&gt;(<span style="color:#0000ff;">string</span> tableName) <span style="color:#0000ff;">where</span> T : IDictionarySerializable, <span style="color:#0000ff;">new</span>()
        {
            <span style="color:#0000ff;">if</span> (<span style="color:#0000ff;">this</span>.IsUseable == <span style="color:#0000ff;">false</span>)
            {
                <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">new</span> List&lt;T&gt;();
            }

            IMongoCollection&lt;Document&gt; collection = <span style="color:#0000ff;">this</span>.DB.GetCollection&lt;Document&gt;(tableName);
            <span style="color:#0000ff;">var</span> documents = collection.FindAll().Documents.ToList();
            <span style="color:#0000ff;">var</span> list = <span style="color:#0000ff;">new</span> List&lt;T&gt;();
            <span style="color:#0000ff;">foreach</span> (Document document <span style="color:#0000ff;">in</span> documents)
            {
                <span style="color:#0000ff;">var</span> user = <span style="color:#0000ff;">new</span> T();
                user.DictDeserialize(document);
                list.Add(user);
            }
            <span style="color:#0000ff;">return</span> list;
        }</pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy"><img alt="复制代码" src="http://common.cnblogs.com/images/copycode.gif"></span>
     </div> 
    </div> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 如果想更新或保存一个文档，可以用如下的代码：</p> 
    <div class="cnblogs_code"> 
     <img class="code_img_closed" alt="" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif">
     <img class="code_img_opened" alt="" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif">
     <div class="cnblogs_code_hide">
      <pre>  <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;summary&gt;</span>
        <span style="color:#808080;">///</span><span style="color:#008000;"> 更新或增加一个新文档
        </span><span style="color:#808080;">///</span> <span style="color:#808080;">&lt;/summary&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;param name="entity"&gt;&lt;/param&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;param name="tableName"&gt;</span><span style="color:#008000;">表名 </span><span style="color:#808080;">&lt;/param&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;param name="keyName"&gt;</span> <span style="color:#808080;">&lt;/param&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;param name="keyvalue"&gt;</span> <span style="color:#808080;">&lt;/param&gt;</span>
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> SaveOrUpdateEntity(IDictionarySerializable entity, <span style="color:#0000ff;">string</span> tableName, <span style="color:#0000ff;">string</span> keyName, <span style="color:#0000ff;">object</span> keyvalue)
        {
            <span style="color:#0000ff;">if</span> (<span style="color:#0000ff;">this</span>.IsUseable == <span style="color:#0000ff;">false</span>)
            {
                <span style="color:#0000ff;">return</span>;
            }
            IMongoCollection&lt;Document&gt; collection = <span style="color:#0000ff;">this</span>.DB.GetCollection&lt;Document&gt;(tableName);
            Document document = collection.FindOne(<span style="color:#0000ff;">new</span> Document { { keyName, keyvalue } });
            <span style="color:#0000ff;">if</span> (document != <span style="color:#0000ff;">null</span>)
            {
                <span style="color:#0000ff;">this</span>.UpdateDocument(entity, document);
                collection.Save(document);
            }
            <span style="color:#0000ff;">else</span>
            {
                Document doc = <span style="color:#0000ff;">this</span>.GetNewDocument(entity);
                collection.Save(doc);
            }
        }

  
 <span style="color:#0000ff;">private</span> Document GetNewDocument(IDictionarySerializable entity)
        {
            IDictionary&lt;<span style="color:#0000ff;">string</span>, <span style="color:#0000ff;">object</span>&gt; datas = entity.DictSerialize();

            <span style="color:#0000ff;">var</span> document = <span style="color:#0000ff;">new</span> Document(datas);

            <span style="color:#0000ff;">return</span> document;
        }

        <span style="color:#0000ff;">private</span> <span style="color:#0000ff;">void</span> UpdateDocument(IDictionarySerializable data, Document document)
        {
            IDictionary&lt;<span style="color:#0000ff;">string</span>, <span style="color:#0000ff;">object</span>&gt; datas = data.DictSerialize();
            <span style="color:#0000ff;">foreach</span> (<span style="color:#0000ff;">string</span> key <span style="color:#0000ff;">in</span> datas.Keys)
            {
                document[key] = datas[key];
            }
        }</pre>
     </div> 
     <span class="cnblogs_code_collapse">SaveOrUpdateCode</span> 
    </div> 
    <p>&nbsp;&nbsp;&nbsp; &nbsp; 可以通过泛型或者接口的方法，方便的读取/存储这些数据。</p> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 完整的驱动层代码，在这里：</p> 
    <p>&nbsp;</p> 
    <div class="cnblogs_code"> 
     <img class="code_img_closed" alt="" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif">
     <img class="code_img_opened" alt="" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif">
     <div class="cnblogs_code_hide">
      <pre>  <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;summary&gt;</span>
    <span style="color:#808080;">///</span><span style="color:#008000;"> Mongo数据库服务
    </span><span style="color:#808080;">///</span> <span style="color:#808080;">&lt;/summary&gt;</span>
    <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">class</span> MongoServiceBase
    {
        <span style="color:#0000ff;">#region</span> Constants and Fields

        <span style="color:#0000ff;">protected</span> IMongoDatabase DB;

        <span style="color:#0000ff;">protected</span> Mongo Mongo;

        <span style="color:#0000ff;">private</span> Document update;

        <span style="color:#0000ff;">#endregion</span>

        <span style="color:#008000;">//</span><span style="color:#008000;">链接字符串 </span>

        <span style="color:#0000ff;">#region</span> Properties

        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">string</span> ConnectionString { <span style="color:#0000ff;">get</span>; <span style="color:#0000ff;">set</span>; }

        <span style="color:#008000;">//</span><span style="color:#008000;">数据库名 </span>
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">string</span> DBName { <span style="color:#0000ff;">get</span>; <span style="color:#0000ff;">set</span>; }

        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">bool</span> IsUseable { <span style="color:#0000ff;">get</span>; <span style="color:#0000ff;">set</span>; }

        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;summary&gt;</span>
        <span style="color:#808080;">///</span><span style="color:#008000;"> 本地数据库位置
        </span><span style="color:#808080;">///</span> <span style="color:#808080;">&lt;/summary&gt;</span>
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">string</span> LocalDBLocation { <span style="color:#0000ff;">get</span>; <span style="color:#0000ff;">set</span>; }

        <span style="color:#0000ff;">#endregion</span>

        <span style="color:#0000ff;">#region</span> Public Methods

        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;summary&gt;</span>
        <span style="color:#808080;">///</span><span style="color:#008000;"> 连接到数据库，只需执行一次
        </span><span style="color:#808080;">///</span> <span style="color:#808080;">&lt;/summary&gt;</span>
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">virtual</span> <span style="color:#0000ff;">bool</span> ConnectDB()
        {
            <span style="color:#0000ff;">var</span> config = <span style="color:#0000ff;">new</span> MongoConfigurationBuilder();

            config.ConnectionString(<span style="color:#0000ff;">this</span>.ConnectionString);
            <span style="color:#008000;">//</span><span style="color:#008000;">定义Mongo服务 </span>

            <span style="color:#0000ff;">this</span>.Mongo = <span style="color:#0000ff;">new</span> Mongo(config.BuildConfiguration());

            <span style="color:#0000ff;">if</span> (<span style="color:#0000ff;">this</span>.Mongo.TryConnect())
            {
                <span style="color:#0000ff;">this</span>.IsUseable = <span style="color:#0000ff;">true</span>;
                <span style="color:#0000ff;">this</span>.update = <span style="color:#0000ff;">new</span> Document();

                <span style="color:#0000ff;">this</span>.update[<span style="color:#800000;">"</span><span style="color:#800000;">$inc</span><span style="color:#800000;">"</span>] = <span style="color:#0000ff;">new</span> Document(<span style="color:#800000;">"</span><span style="color:#800000;">id</span><span style="color:#800000;">"</span>, <span style="color:#800080;">1</span>);

                <span style="color:#0000ff;">this</span>.DB = <span style="color:#0000ff;">this</span>.Mongo.GetDatabase(<span style="color:#0000ff;">this</span>.DBName);
            }
            <span style="color:#0000ff;">else</span>
            {
                <span style="color:#0000ff;">this</span>.IsUseable = <span style="color:#0000ff;">false</span>;
            }
            <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">this</span>.IsUseable;
        }

        <span style="color:#0000ff;">public</span> T Copy&lt;T&gt;(T oldValue) <span style="color:#0000ff;">where</span> T : IDictionarySerializable, <span style="color:#0000ff;">new</span>()
        {
            IDictionary&lt;<span style="color:#0000ff;">string</span>, <span style="color:#0000ff;">object</span>&gt; data = oldValue.DictSerialize();
            <span style="color:#0000ff;">var</span> newValue = <span style="color:#0000ff;">new</span> T();
            newValue.DictDeserialize(data);
            <span style="color:#0000ff;">return</span> newValue;
        }

        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;summary&gt;</span>
        <span style="color:#808080;">///</span><span style="color:#008000;"> 创建一个自增主键索引表
        </span><span style="color:#808080;">///</span> <span style="color:#808080;">&lt;/summary&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;param name="tableName"&gt;</span><span style="color:#008000;">表名</span><span style="color:#808080;">&lt;/param&gt;</span>
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> CreateIndexTable(<span style="color:#0000ff;">string</span> tableName)
        {
            <span style="color:#0000ff;">if</span> (<span style="color:#0000ff;">this</span>.IsUseable == <span style="color:#0000ff;">false</span>)
            {
                <span style="color:#0000ff;">return</span>;
            }
            IMongoCollection idManager = <span style="color:#0000ff;">this</span>.DB.GetCollection(<span style="color:#800000;">"</span><span style="color:#800000;">ids</span><span style="color:#800000;">"</span>);
            Document idDoc = idManager.FindOne(<span style="color:#0000ff;">new</span> Document(<span style="color:#800000;">"</span><span style="color:#800000;">Name</span><span style="color:#800000;">"</span>, tableName));
            <span style="color:#0000ff;">if</span> (idDoc == <span style="color:#0000ff;">null</span>)
            {
                idDoc = <span style="color:#0000ff;">new</span> Document();
                idDoc[<span style="color:#800000;">"</span><span style="color:#800000;">Name</span><span style="color:#800000;">"</span>] = tableName;
                idDoc[<span style="color:#800000;">"</span><span style="color:#800000;">id</span><span style="color:#800000;">"</span>] = <span style="color:#800080;">0</span>;
            }

            idManager.Save(idDoc);
        }

        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;summary&gt;</span>
        <span style="color:#808080;">///</span><span style="color:#008000;"> 获取数据库中的所有实体
        </span><span style="color:#808080;">///</span> <span style="color:#808080;">&lt;/summary&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;returns&gt;&lt;/returns&gt;</span>
        <span style="color:#0000ff;">public</span> List&lt;T&gt; GetAllEntitys&lt;T&gt;(<span style="color:#0000ff;">string</span> tableName) <span style="color:#0000ff;">where</span> T : IDictionarySerializable, <span style="color:#0000ff;">new</span>()
        {
            <span style="color:#0000ff;">if</span> (<span style="color:#0000ff;">this</span>.IsUseable == <span style="color:#0000ff;">false</span>)
            {
                <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">new</span> List&lt;T&gt;();
            }

            IMongoCollection&lt;Document&gt; collection = <span style="color:#0000ff;">this</span>.DB.GetCollection&lt;Document&gt;(tableName);
            List&lt;Document&gt; documents = collection.FindAll().Documents.ToList();
            <span style="color:#0000ff;">var</span> list = <span style="color:#0000ff;">new</span> List&lt;T&gt;();
            <span style="color:#0000ff;">foreach</span> (Document document <span style="color:#0000ff;">in</span> documents)
            {
                <span style="color:#0000ff;">var</span> user = <span style="color:#0000ff;">new</span> T();
                user.DictDeserialize(document);
                list.Add(user);
            }
            <span style="color:#0000ff;">return</span> list;
        }

        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;summary&gt;</span>
        <span style="color:#808080;">///</span><span style="color:#008000;"> 获取一定范围的实体
        </span><span style="color:#808080;">///</span> <span style="color:#808080;">&lt;/summary&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;param name="tableName"&gt;&lt;/param&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;param name="type"&gt;&lt;/param&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;param name="mount"&gt;&lt;/param&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;param name="skip"&gt;&lt;/param&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;returns&gt;&lt;/returns&gt;</span>
        <span style="color:#0000ff;">public</span> List&lt;IDictionarySerializable&gt; GetAllEntitys(<span style="color:#0000ff;">string</span> tableName, Type type)
        {
            <span style="color:#0000ff;">if</span> (<span style="color:#0000ff;">this</span>.IsUseable == <span style="color:#0000ff;">false</span>)
            {
                <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">new</span> List&lt;IDictionarySerializable&gt;();
            }

            List&lt;Document&gt; docuemts = <span style="color:#0000ff;">this</span>.DB.GetCollection&lt;Document&gt;(tableName).FindAll().Documents.ToList();
            <span style="color:#0000ff;">var</span> items = <span style="color:#0000ff;">new</span> List&lt;IDictionarySerializable&gt;();
            <span style="color:#0000ff;">foreach</span> (Document document <span style="color:#0000ff;">in</span> docuemts)
            {
                <span style="color:#0000ff;">object</span> data = Activator.CreateInstance(type);
                <span style="color:#0000ff;">var</span> suck = (IDictionarySerializable)data;
                suck.DictDeserialize(document);
                items.Add(suck);
            }
            <span style="color:#0000ff;">return</span> items;
        }

        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;summary&gt;</span>
        <span style="color:#808080;">///</span><span style="color:#008000;"> 获取一定范围的实体
        </span><span style="color:#808080;">///</span> <span style="color:#808080;">&lt;/summary&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;param name="tableName"&gt;&lt;/param&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;param name="type"&gt;&lt;/param&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;param name="mount"&gt;&lt;/param&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;param name="skip"&gt;&lt;/param&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;returns&gt;&lt;/returns&gt;</span>
        <span style="color:#0000ff;">public</span> List&lt;IDictionarySerializable&gt; GetEntitys(<span style="color:#0000ff;">string</span> tableName, Type type, <span style="color:#0000ff;">int</span> mount, <span style="color:#0000ff;">int</span> skip)
        {
            <span style="color:#0000ff;">if</span> (<span style="color:#0000ff;">this</span>.IsUseable == <span style="color:#0000ff;">false</span>)
            {
                <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">new</span> List&lt;IDictionarySerializable&gt;();
            }

            List&lt;Document&gt; docuemts =
                <span style="color:#0000ff;">this</span>.DB.GetCollection&lt;Document&gt;(tableName).FindAll().Skip(skip).Limit(mount).Documents.ToList();
            <span style="color:#0000ff;">var</span> items = <span style="color:#0000ff;">new</span> List&lt;IDictionarySerializable&gt;();
            <span style="color:#0000ff;">foreach</span> (Document document <span style="color:#0000ff;">in</span> docuemts)
            {
                <span style="color:#0000ff;">object</span> data = Activator.CreateInstance(type);
                <span style="color:#0000ff;">var</span> suck = (IDictionarySerializable)data;
                suck.DictDeserialize(document);
                items.Add(suck);
            }
            <span style="color:#0000ff;">return</span> items;
        }

        <span style="color:#0000ff;">public</span> List&lt;T&gt; GetEntitys&lt;T&gt;(<span style="color:#0000ff;">string</span> tableName, <span style="color:#0000ff;">int</span> mount, <span style="color:#0000ff;">int</span> skip) <span style="color:#0000ff;">where</span> T : IDictionarySerializable, <span style="color:#0000ff;">new</span>()
        {
            <span style="color:#0000ff;">if</span> (<span style="color:#0000ff;">this</span>.IsUseable == <span style="color:#0000ff;">false</span>)
            {
                <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">new</span> List&lt;T&gt;();
            }

            ICursor&lt;Document&gt; collection = <span style="color:#0000ff;">this</span>.DB.GetCollection&lt;Document&gt;(tableName).Find(<span style="color:#0000ff;">null</span>).Skip(skip).Limit(mount);

            <span style="color:#0000ff;">var</span> users = <span style="color:#0000ff;">new</span> List&lt;T&gt;();
            <span style="color:#0000ff;">foreach</span> (Document document <span style="color:#0000ff;">in</span> collection.Documents)
            {
                <span style="color:#0000ff;">var</span> user = <span style="color:#0000ff;">new</span> T();
                user.DictDeserialize(document);
                users.Add(user);
            }
            <span style="color:#0000ff;">return</span> users;
        }

        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;summary&gt;</span>
        <span style="color:#808080;">///</span><span style="color:#008000;"> 直接插入一个实体
        </span><span style="color:#808080;">///</span> <span style="color:#808080;">&lt;/summary&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;param name="user"&gt;&lt;/param&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;param name="tableName"&gt;&lt;/param&gt;</span>
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">bool</span> InsertEntity(IDictionarySerializable user, <span style="color:#0000ff;">string</span> tableName, <span style="color:#0000ff;">string</span> key, <span style="color:#0000ff;">out</span> <span style="color:#0000ff;">int</span> index)
        {
            <span style="color:#0000ff;">if</span> (<span style="color:#0000ff;">this</span>.IsUseable == <span style="color:#0000ff;">false</span>)
            {
                index = <span style="color:#800080;">0</span>;
                <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">false</span>;
            }

            IMongoCollection&lt;Document&gt; collection = <span style="color:#0000ff;">this</span>.DB.GetCollection&lt;Document&gt;(tableName);
            IMongoCollection idManager = <span style="color:#0000ff;">this</span>.DB.GetCollection(<span style="color:#800000;">"</span><span style="color:#800000;">ids</span><span style="color:#800000;">"</span>);
            Document docID = idManager.FindAndModify(<span style="color:#0000ff;">this</span>.update, <span style="color:#0000ff;">new</span> Document(<span style="color:#800000;">"</span><span style="color:#800000;">Name</span><span style="color:#800000;">"</span>, tableName), returnNew: <span style="color:#0000ff;">true</span>);

            <span style="color:#008000;">//</span><span style="color:#008000;">下面三句存入数据库</span>
            Document doc = <span style="color:#0000ff;">this</span>.GetNewDocument(user);

            doc[key] = docID[<span style="color:#800000;">"</span><span style="color:#800000;">id</span><span style="color:#800000;">"</span>];
            index = (<span style="color:#0000ff;">int</span>)docID[<span style="color:#800000;">"</span><span style="color:#800000;">id</span><span style="color:#800000;">"</span>];
            ;
            collection.Save(doc);
            <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">true</span>;
        }

        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> RepairDatabase()
        {
            <span style="color:#0000ff;">bool</span> local = (<span style="color:#0000ff;">this</span>.ConnectionString.Contains(<span style="color:#800000;">"</span><span style="color:#800000;">localhost</span><span style="color:#800000;">"</span>) || <span style="color:#0000ff;">this</span>.ConnectionString.Contains(<span style="color:#800000;">"</span><span style="color:#800000;">127.0.0.1</span><span style="color:#800000;">"</span>));
            <span style="color:#0000ff;">if</span> (local == <span style="color:#0000ff;">false</span>)
            {
                <span style="color:#0000ff;">throw</span> <span style="color:#0000ff;">new</span> Exception(<span style="color:#800000;">"</span><span style="color:#800000;">MongoDB数据库不在本地，无法启动自动数据库修复</span><span style="color:#800000;">"</span>);
            }

            <span style="color:#0000ff;">var</span> mydir = <span style="color:#0000ff;">new</span> DirectoryInfo(<span style="color:#0000ff;">this</span>.LocalDBLocation);
            FileInfo file = mydir.GetFiles().FirstOrDefault(d =&gt; d.Name == <span style="color:#800000;">"</span><span style="color:#800000;">mongod.lock</span><span style="color:#800000;">"</span>);
            <span style="color:#0000ff;">if</span> (file == <span style="color:#0000ff;">null</span>)
            {
                <span style="color:#0000ff;">throw</span> <span style="color:#0000ff;">new</span> Exception(<span style="color:#800000;">"</span><span style="color:#800000;">修复失败，您是否没有安装MongoDB数据库</span><span style="color:#800000;">"</span>);
            }
            <span style="color:#0000ff;">try</span>
            {
                File.Delete(file.FullName);
                <span style="color:#0000ff;">string</span> str = CMDHelper.Execute(<span style="color:#800000;">"</span><span style="color:#800000;">net start MongoDB</span><span style="color:#800000;">"</span>);
            }
            <span style="color:#0000ff;">catch</span> (Exception ex)
            {
            }
        }

        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;summary&gt;</span>
        <span style="color:#808080;">///</span><span style="color:#008000;"> 更新或增加一个新文档
        </span><span style="color:#808080;">///</span> <span style="color:#808080;">&lt;/summary&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;param name="entity"&gt;&lt;/param&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;param name="tableName"&gt;</span><span style="color:#008000;">表名 </span><span style="color:#808080;">&lt;/param&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;param name="keyName"&gt;</span> <span style="color:#808080;">&lt;/param&gt;</span>
        <span style="color:#808080;">///</span> <span style="color:#808080;">&lt;param name="keyvalue"&gt;</span> <span style="color:#808080;">&lt;/param&gt;</span>
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> SaveOrUpdateEntity(
            IDictionarySerializable entity, <span style="color:#0000ff;">string</span> tableName, <span style="color:#0000ff;">string</span> keyName, <span style="color:#0000ff;">object</span> keyvalue)
        {
            <span style="color:#0000ff;">if</span> (<span style="color:#0000ff;">this</span>.IsUseable == <span style="color:#0000ff;">false</span>)
            {
                <span style="color:#0000ff;">return</span>;
            }
            IMongoCollection&lt;Document&gt; collection = <span style="color:#0000ff;">this</span>.DB.GetCollection&lt;Document&gt;(tableName);
            Document document = collection.FindOne(<span style="color:#0000ff;">new</span> Document { { keyName, keyvalue } });
            <span style="color:#0000ff;">if</span> (document != <span style="color:#0000ff;">null</span>)
            {
                <span style="color:#0000ff;">this</span>.UpdateDocument(entity, document);
                collection.Save(document);
            }
            <span style="color:#0000ff;">else</span>
            {
                Document doc = <span style="color:#0000ff;">this</span>.GetNewDocument(entity);
                collection.Save(doc);
            }
        }

        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">bool</span> TryFindEntity&lt;T&gt;(<span style="color:#0000ff;">string</span> tableName, <span style="color:#0000ff;">string</span> keyName, <span style="color:#0000ff;">object</span> keyvalue, <span style="color:#0000ff;">out</span> T result)
            <span style="color:#0000ff;">where</span> T : <span style="color:#0000ff;">class</span>, IDictionarySerializable, <span style="color:#0000ff;">new</span>()
        {
            IMongoCollection&lt;Document&gt; collection = <span style="color:#0000ff;">this</span>.DB.GetCollection&lt;Document&gt;(tableName);
            Document document = collection.FindOne(<span style="color:#0000ff;">new</span> Document { { keyName, keyvalue } });
            <span style="color:#0000ff;">if</span> (document == <span style="color:#0000ff;">null</span>)
            {
                result = <span style="color:#0000ff;">null</span>;
                <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">false</span>;
            }
            result = <span style="color:#0000ff;">new</span> T();
            <span style="color:#0000ff;">try</span>
            {
                result.DictDeserialize(document);
            }
            <span style="color:#0000ff;">catch</span> (Exception ex)
            {
                XLogSys.Print.Error(ex);
            }

            <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">true</span>;
        }

        <span style="color:#0000ff;">#endregion</span>

        <span style="color:#0000ff;">#region</span> Methods

        <span style="color:#0000ff;">private</span> Document GetNewDocument(IDictionarySerializable entity)
        {
            IDictionary&lt;<span style="color:#0000ff;">string</span>, <span style="color:#0000ff;">object</span>&gt; datas = entity.DictSerialize();

            <span style="color:#0000ff;">var</span> document = <span style="color:#0000ff;">new</span> Document(datas);

            <span style="color:#0000ff;">return</span> document;
        }

        <span style="color:#0000ff;">private</span> <span style="color:#0000ff;">void</span> UpdateDocument(IDictionarySerializable data, Document document)
        {
            IDictionary&lt;<span style="color:#0000ff;">string</span>, <span style="color:#0000ff;">object</span>&gt; datas = data.DictSerialize();
            <span style="color:#0000ff;">foreach</span> (<span style="color:#0000ff;">string</span> key <span style="color:#0000ff;">in</span> datas.Keys)
            {
                document[key] = datas[key];
            }
        }

        <span style="color:#0000ff;">#endregion</span>
    }</pre>
     </div> 
     <span class="cnblogs_code_collapse">完整的驱动层代码</span> 
    </div> 
    <p>&nbsp;</p> 
    <h1>四.一些问题</h1> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 下面我们讨论一些遇到的问题：</p> 
    <ul>
     <li>&nbsp;&nbsp;&nbsp;&nbsp;<strong>为什么不用反射来读写字段？而非要显式的实现这两个接口呢？</strong> </li>
    </ul>
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;性能是首先要考虑的，而实现这两个接口意味着更多的控制权和灵活性。 另外，对于很多键值对的数据库来说<strong>，“Key”也是要占用存储空间的</strong>，而且占用不少。如果实体类中字段属性特别长，那么就会占用可观的存储，MongoDB就是如此。因此，在读写数据库的场景中，应当保持Key较短。&nbsp;</p> 
    <ul>
     <li>&nbsp;&nbsp;&nbsp; <strong>IDictionary&lt;<span style="color:#0000ff;">string</span>, <span style="color:#0000ff;">object</span>&gt; 的object是不是会有性能影响？</strong> </li>
    </ul>
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由于保存的是String-object的键值对形式，因此不可避免的存在装箱和拆箱操作，在数据量大时，性能损耗肯定还是有的。不过，大部分数据库驱动不也有大量这种操作么？毕竟只需要读写一次即可，性能损失可忽略不计，再说，还有更好的方法么？</p> 
    <ul>
     <li>&nbsp;&nbsp;&nbsp; <strong>是否能通过该接口实现LINQ查询甚至SQL查询？</strong> </li>
    </ul>
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;应该是可以的，它建立了属性与名称的映射关系，因此可以通过该接口实现LINQ和SQL解析器，实现查询等功能。</p> 
    <ul>
     <li>&nbsp;&nbsp;&nbsp; 为什么不用官方的ISerializable接口呢？</li>
    </ul>
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;原因如第一条，依靠attribute的方法没有灵活性，同时，对二进制序列化等操作，实现起来也比较困难。</p> 
    <h1>五. 其他应用场景</h1> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 除了上面介绍的应用场景之外，该接口还能用于如下用途：</p> 
    <ul>
     <li>&nbsp;&nbsp;环境和模块配置： 可以方便的将环境中所有的配置以键值对的方式存储，并在需要的时候加载</li> 
     <li>&nbsp;&nbsp;RPC: 由于实现了到XML/JSON的方便转换，可以很容易的实现远程过程调用</li> 
     <li>&nbsp; Word文档导出：该接口包含了键值对，因此在Word模板中，可以写上Key， 通过该接口，一次性全部替换即可，非常方便。</li> 
     <li>&nbsp; 界面绑定： 通过该接口实现动态的Binding语法。</li> 
    </ul>
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一个方便的东西，应该是简单的。通过该接口获得的好处非常多，还需要大家去挖掘。值得提出的是，它也能应用在其他语言上，比如JAVA, 用HashMap&lt;String,Object&gt;来实现类似的需求。</p> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果有任何问题，欢迎讨论！</p> 
    <p>&nbsp;&nbsp;&nbsp;</p> 
    <p>&nbsp;</p> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;</p> 
    <p>&nbsp;</p> 
    <p>&nbsp;</p> 
    <p>&nbsp;</p> 
    <p>&nbsp;</p> 
    <p>&nbsp;</p> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;</p> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;</p> 
   </div> 
   <div> 
    <div> 
     <p style="border-top:#e0e0e0 1px dashed;border-right:#e0e0e0 1px dashed;border-bottom:#e0e0e0 1px dashed;border-left:#e0e0e0 1px dashed;background:#e5f1f4 url(&quot;https://images.cnblogs.com/cnblogs_com/lloydsheng/239039/o_copyright.gif&quot;) no-repeat 1% 50%;font-family:'微软雅黑';font-size:11px;"><br> 作者：<a href="http://www.cnblogs.com/buptzym/" rel="nofollow">热情的沙漠</a> <br> 出处：<a href="http://www.cnblogs.com/buptzym/" rel="nofollow">http://www.cnblogs.com/buptzym/</a> <br> 本文版权归作者和博客园共有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</p> 
     <p style="border-top:#e0e0e0 1px dashed;border-right:#e0e0e0 1px dashed;border-bottom:#e0e0e0 1px dashed;border-left:#e0e0e0 1px dashed;background:#e5f1f4 url(&quot;https://images.cnblogs.com/cnblogs_com/lloydsheng/239039/o_copyright.gif&quot;) no-repeat 1% 50%;font-family:'微软雅黑';font-size:11px;"><br></p> 
     <p style="border-top:#e0e0e0 1px dashed;border-right:#e0e0e0 1px dashed;border-bottom:#e0e0e0 1px dashed;border-left:#e0e0e0 1px dashed;background:#e5f1f4 url(&quot;https://images.cnblogs.com/cnblogs_com/lloydsheng/239039/o_copyright.gif&quot;) no-repeat 1% 50%;font-family:'微软雅黑';font-size:11px;">&nbsp;本文转自FerventDesert博客园博客，原文链接：http://www.cnblogs.com/buptzym/p/3297979.html，如需转载请自行联系原作者</p> 
    </div> 
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
