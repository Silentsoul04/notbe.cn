<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>宏定义编写技巧__调试技巧【原创】 « NotBeCN</title>
  <meta name="description" content="             带颜色打印：    printk("\033[1;33;40m misc.c InterIoctl() action=%d\033[0m\r\n", action);    方法一、          1 #ifndef _PMU_DUMMY_ 2  3 #define _PMU_DUM...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2015/08/06/weixin_34293141_90117318.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">宏定义编写技巧__调试技巧【原创】</h1>
    <p class="post-meta">Aug 6, 2015</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p>带颜色打印：</p> 
   <p>printk("\033[1;33;40m misc.c InterIoctl() action=%d\033[0m\r\n", action);</p> 
   <p><span>方法一、</span></p> 
   <div class="cnblogs_code"> 
    <pre><span style="color:#008080;"> 1</span> <span style="color:#000000;">#ifndef _PMU_DUMMY_
</span><span style="color:#008080;"> 2</span> 
<span style="color:#008080;"> 3</span> <span style="color:#0000ff;">#define</span> _PMU_DUMMY_
<span style="color:#008080;"> 4</span> 
<span style="color:#008080;"> 5</span>  
<span style="color:#008080;"> 6</span> 
<span style="color:#008080;"> 7</span> <span style="color:#0000ff;">#define</span> PAX_PMU_DUMMY_DEBUG_ENABLE
<span style="color:#008080;"> 8</span> 
<span style="color:#008080;"> 9</span>  
<span style="color:#008080;">10</span> 
<span style="color:#008080;">11</span> <span style="color:#000000;">#ifdef PAX_PMU_DUMMY_DEBUG_ENABLE
</span><span style="color:#008080;">12</span> 
<span style="color:#008080;">13</span> <span style="color:#0000ff;">#define</span> PAX_PMU_DUMMY_DEBUG(x...)   do{printk("\r\n");printk(x);printk("\r\n");}while(0)
<span style="color:#008080;">14</span> 
<span style="color:#008080;">15</span> <span style="color:#0000ff;">#else</span>
<span style="color:#008080;">16</span> 
<span style="color:#008080;">17</span> <span style="color:#0000ff;">#define</span> PAX_PMU_DUMMY_DEBUG(x...)
<span style="color:#008080;">18</span> 
<span style="color:#008080;">19</span> <span style="color:#0000ff;">#endif</span>
<span style="color:#008080;">20</span> 
<span style="color:#008080;">21</span>  
<span style="color:#008080;">22</span> 
<span style="color:#008080;">23</span> <span style="color:#0000ff;">#define</span> REGULATOR_DUMMY        "dummy_regulator"
<span style="color:#008080;">24</span> 
<span style="color:#008080;">25</span>  
<span style="color:#008080;">26</span> 
<span style="color:#008080;">27</span> <span style="color:#0000ff;">#endif</span></pre> 
   </div> 
   <p><span>&nbsp;方法二、</span></p> 
   <div class="cnblogs_code"> 
    <pre><span style="color:#008080;"> 1</span> <span style="color:#0000ff;">#define</span> DEBUG_ENABLE   1
<span style="color:#008080;"> 2</span> 
<span style="color:#008080;"> 3</span>  
<span style="color:#008080;"> 4</span> 
<span style="color:#008080;"> 5</span> <span style="color:#0000ff;">#if</span>  DEBUG_ENABLE
<span style="color:#008080;"> 6</span> 
<span style="color:#008080;"> 7</span> <span style="color:#0000ff;">#define</span> PRINT(fmt, args...)  do{\
<span style="color:#008080;"> 8</span> 
<span style="color:#008080;"> 9</span>         printf(<span style="color:#800000;">"</span><span style="color:#800000;">&lt;%s&gt;【*%s()*】(%d):</span><span style="color:#800000;">"</span><span style="color:#000000;">, __FILE__, __func__, __LINE__);\
</span><span style="color:#008080;">10</span> 
<span style="color:#008080;">11</span> <span style="color:#000000;">        printf(fmt, ##args);\
</span><span style="color:#008080;">12</span> 
<span style="color:#008080;">13</span> }<span style="color:#0000ff;">while</span>(<span style="color:#800080;">0</span><span style="color:#000000;">)
</span><span style="color:#008080;">14</span> 
<span style="color:#008080;">15</span> <span style="color:#0000ff;">#else</span>
<span style="color:#008080;">16</span> 
<span style="color:#008080;">17</span> <span style="color:#0000ff;">#define</span> PRINT(fmt, args...)
<span style="color:#008080;">18</span> 
<span style="color:#008080;">19</span> <span style="color:#0000ff;">#endif</span></pre> 
   </div> 
   <p>&nbsp;</p> 
   <p>&nbsp;</p> 
   <p>&nbsp;</p> 
   <p><span>方法三、</span></p> 
   <div class="cnblogs_code"> 
    <pre><span style="color:#008080;"> 1</span> <span style="color:#008000;">//</span><span style="color:#008000;"> 带格式的打印调试</span>
<span style="color:#008080;"> 2</span> <span style="color:#0000ff;">int</span> Serial_Printf(<span style="color:#0000ff;">char</span> *<span style="color:#000000;">fmt, ...)
</span><span style="color:#008080;"> 3</span> <span style="color:#000000;">{
</span><span style="color:#008080;"> 4</span> <span style="color:#000000;">  va_list args;
</span><span style="color:#008080;"> 5</span>   <span style="color:#0000ff;">int</span> printed = <span style="color:#800080;">0</span><span style="color:#000000;">;
</span><span style="color:#008080;"> 6</span>   
<span style="color:#008080;"> 7</span> <span style="color:#000000;">  uint8 printf_buf[MAX_PRINTF_LEN];
</span><span style="color:#008080;"> 8</span>   
<span style="color:#008080;"> 9</span> <span style="color:#000000;">  va_start(args, fmt);
</span><span style="color:#008080;">10</span>   printed = vsprintf((<span style="color:#0000ff;">char</span>*<span style="color:#000000;">)printf_buf, fmt, args);
</span><span style="color:#008080;">11</span> <span style="color:#000000;">  va_end(args);
</span><span style="color:#008080;">12</span>   
<span style="color:#008080;">13</span>   printf_buf[MAX_PRINTF_LEN-<span style="color:#800080;">1</span>] = <span style="color:#800000;">'</span><span style="color:#800000;">\0</span><span style="color:#800000;">'</span><span style="color:#000000;">;
</span><span style="color:#008080;">14</span> <span style="color:#000000;">  SerialPrintString(printf_buf);
</span><span style="color:#008080;">15</span>   
<span style="color:#008080;">16</span>   <span style="color:#0000ff;">return</span><span style="color:#000000;"> printed;
</span><span style="color:#008080;">17</span> }</pre> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#008080;">1</span> <span style="color:#008000;">/*</span>
<span style="color:#008080;">2</span> <span style="color:#008000;">打印一个字符串
</span><span style="color:#008080;">3</span> <span style="color:#008000;">str不可以包含0x00，除非结尾
</span><span style="color:#008080;">4</span> <span style="color:#008000;">*/</span>
<span style="color:#008080;">5</span> <span style="color:#0000ff;">void</span><span style="color:#000000;"> SerialPrintString(uint8 str[])
</span><span style="color:#008080;">6</span> <span style="color:#000000;">{
</span><span style="color:#008080;">7</span>   HalUARTWrite (SBP_UART_PORT, str, osal_strlen((<span style="color:#0000ff;">char</span>*<span style="color:#000000;">)str));
</span><span style="color:#008080;">8</span> }</pre> 
    </div> 
    <div class="cnblogs_code"> 
     <pre><span style="color:#008080;"> 1</span> <span style="color:#008000;">//</span><span style="color:#008000;">#define DEBUG</span>
<span style="color:#008080;"> 2</span> 
<span style="color:#008080;"> 3</span> <span style="color:#000000;">#ifdef DEBUG
</span><span style="color:#008080;"> 4</span> <span style="color:#0000ff;">#define</span> DEBUG_PRINT(format, ...)            Serial_Printf(format, ##__VA_ARGS__)
<span style="color:#008080;"> 5</span> <span style="color:#0000ff;">#define</span> DEBUG_PRINT_BUFF(title, buff, len, display_char)  \
<span style="color:#008080;"> 6</span> <span style="color:#000000;">                                            Serial_PrintBuffer(title, buff, len, display_char)
</span><span style="color:#008080;"> 7</span> <span style="color:#0000ff;">#else</span>
<span style="color:#008080;"> 8</span> <span style="color:#0000ff;">#define</span> DEBUG_PRINT(format, ...)
<span style="color:#008080;"> 9</span> <span style="color:#0000ff;">#define</span> DEBUG_PRINT_BUFF(title, buff, len, display_char)
<span style="color:#008080;">10</span> <span style="color:#0000ff;">#endif</span>  </pre> 
    </div> 
    <p>&nbsp;</p> 
   </div> 
   <p>&nbsp;</p> 
   <pre>方法四、<br><br></pre> 
   <div class="cnblogs_code"> 
    <pre><span style="color:#008000;">//</span><span style="color:#008000;">console.c</span>
#include &lt;stdio.h&gt;<span style="color:#000000;">
#include </span>&lt;<span style="color:#0000ff;">string</span>.h&gt;<span style="color:#000000;">
#include </span>&lt;stdbool.h&gt;<span style="color:#000000;">
#include </span>&lt;pthread.h&gt;<span style="color:#000000;">
#include </span>&lt;stdarg.h&gt;<span style="color:#000000;">
#include </span>&lt;unistd.h&gt;<span style="color:#000000;">
#include </span>&lt;fcntl.h&gt;<span style="color:#000000;">
#include </span>&lt;sys/mman.h&gt;<span style="color:#000000;">


#include </span><span style="color:#800000;">"</span><span style="color:#800000;">Console.h</span><span style="color:#800000;">"</span>



<span style="color:#008000;">/*</span><span style="color:#008000;">----------------------------------------------------------</span><span style="color:#008000;">*/</span>
<span style="color:#008000;">/*</span><span style="color:#008000;">! \brief Structure which will be copied into shared memory, in order to synchronize console output from
 *         different processes and threads.
 </span><span style="color:#008000;">*/</span>
<span style="color:#008000;">/*</span><span style="color:#008000;">----------------------------------------------------------</span><span style="color:#008000;">*/</span><span style="color:#000000;">
typedef </span><span style="color:#0000ff;">struct</span><span style="color:#000000;"> {
    </span><span style="color:#808080;">///</span><span style="color:#008000;">If set to true, there is an segmented print ongoing (Start, Continue, Exit).</span>
    <span style="color:#0000ff;">bool</span><span style="color:#000000;"> criticalSection;
    </span><span style="color:#808080;">///</span><span style="color:#008000;">Handle of the shared mutex.</span>
<span style="color:#000000;">    pthread_mutex_t mutex;
} shared_data;

</span><span style="color:#008000;">/*</span><span style="color:#008000;">----------------------------------------------------------</span><span style="color:#008000;">*/</span>
<span style="color:#008000;">/*</span><span style="color:#008000;">! \brief Pointer to the shared memory instance.
 </span><span style="color:#008000;">*/</span>
<span style="color:#008000;">/*</span><span style="color:#008000;">----------------------------------------------------------</span><span style="color:#008000;">*/</span>
<span style="color:#0000ff;">static</span> shared_data* data =<span style="color:#000000;"> NULL;

</span><span style="color:#0000ff;">void</span> show_read(unsigned <span style="color:#0000ff;">char</span> *str, unsigned <span style="color:#0000ff;">char</span> *buff, unsigned <span style="color:#0000ff;">int</span><span style="color:#000000;"> len)
{        
    ConsolePrintfStart(</span><span style="color:#800000;">"</span><span style="color:#800000;">serial-RX: %s [</span><span style="color:#800000;">"</span><span style="color:#000000;">, str);
    </span><span style="color:#0000ff;">for</span> (<span style="color:#0000ff;">int</span> i = <span style="color:#800080;">0</span>; i &lt; len; i++<span style="color:#000000;">) {
        ConsolePrintfContinue(</span><span style="color:#800000;">"</span><span style="color:#800000;">%02X </span><span style="color:#800000;">"</span><span style="color:#000000;">, buff[i]);
    }
    ConsolePrintfExit(</span><span style="color:#800000;">"</span><span style="color:#800000;">]\r\n</span><span style="color:#800000;">"</span><span style="color:#000000;">);
}

</span><span style="color:#0000ff;">void</span> ConsoleInit(<span style="color:#0000ff;">void</span><span style="color:#000000;">)
{
    pthread_mutexattr_t attr;
    </span><span style="color:#0000ff;">int</span> prot = PROT_READ |<span style="color:#000000;"> PROT_WRITE;
    </span><span style="color:#0000ff;">int</span> flags = MAP_SHARED |<span style="color:#000000;"> MAP_ANONYMOUS;
    data </span>= (shared_data*)mmap(NULL, <span style="color:#0000ff;">sizeof</span>(shared_data), prot, flags, -<span style="color:#800080;">1</span>, <span style="color:#800080;">0</span><span style="color:#000000;">);

    data</span>-&gt;criticalSection = <span style="color:#0000ff;">false</span><span style="color:#000000;">;

    pthread_mutexattr_init(</span>&amp;<span style="color:#000000;">attr);
    pthread_mutexattr_setpshared(</span>&amp;<span style="color:#000000;">attr, PTHREAD_PROCESS_SHARED);
    pthread_mutex_init(</span>&amp;data-&gt;mutex, &amp;<span style="color:#000000;">attr);
}

</span><span style="color:#0000ff;">void</span> ConsoleDeinit(<span style="color:#0000ff;">void</span><span style="color:#000000;">)
{
    munmap(data, </span><span style="color:#0000ff;">sizeof</span><span style="color:#000000;">(data));
    data </span>=<span style="color:#000000;"> NULL;
}

</span><span style="color:#0000ff;">void</span> ConsolePrintf(<span style="color:#0000ff;">const</span> <span style="color:#0000ff;">char</span> *<span style="color:#000000;">statement, ...)
{
    </span><span style="color:#0000ff;">int</span><span style="color:#000000;"> err;
    </span><span style="color:#0000ff;">if</span> (NULL ==<span style="color:#000000;"> data) {
        printf(</span><span style="color:#800000;">"</span><span style="color:#800000;">ConsolePrintf data was null\n</span><span style="color:#800000;">"</span><span style="color:#000000;">);
        </span><span style="color:#0000ff;">while</span> (<span style="color:#0000ff;">true</span><span style="color:#000000;">);
    }
    </span><span style="color:#0000ff;">if</span> (<span style="color:#800080;">0</span> != (err = pthread_mutex_lock(&amp;data-&gt;<span style="color:#000000;">mutex))) {
        printf(</span><span style="color:#800000;">"</span><span style="color:#800000;">ConsolePrintf, pthread_mutex_lock error: %d\n</span><span style="color:#800000;">"</span><span style="color:#000000;">, err);
    }
    </span><span style="color:#0000ff;">if</span> (NULL !=<span style="color:#000000;"> statement) {
        va_list args;
        va_start(args, statement);
        vprintf(statement, args);
        va_end(args);
    }
    </span><span style="color:#0000ff;">if</span> (<span style="color:#800080;">0</span> != (err = pthread_mutex_unlock(&amp;data-&gt;<span style="color:#000000;">mutex))) {
        printf(</span><span style="color:#800000;">"</span><span style="color:#800000;">ConsolePrintf, pthread_mutex_unlock error: %d\n</span><span style="color:#800000;">"</span><span style="color:#000000;">, err);
        </span><span style="color:#0000ff;">while</span> (<span style="color:#0000ff;">true</span><span style="color:#000000;">);
    }
}


</span><span style="color:#0000ff;">void</span> ConsolePrintfStart(<span style="color:#0000ff;">const</span> <span style="color:#0000ff;">char</span> *<span style="color:#000000;">statement, ...)
{
    </span><span style="color:#0000ff;">int</span><span style="color:#000000;"> err;
    </span><span style="color:#0000ff;">if</span> (NULL ==<span style="color:#000000;"> data) {
        printf(</span><span style="color:#800000;">"</span><span style="color:#800000;">ConsolePrintfStart data was null\n</span><span style="color:#800000;">"</span><span style="color:#000000;">);
        </span><span style="color:#0000ff;">while</span> (<span style="color:#0000ff;">true</span><span style="color:#000000;">);
    }
    </span><span style="color:#0000ff;">if</span> (<span style="color:#800080;">0</span> != (err = pthread_mutex_lock(&amp;data-&gt;<span style="color:#000000;">mutex))) {
        printf(</span><span style="color:#800000;">"</span><span style="color:#800000;">ConsolePrintfStart, pthread_mutex_lock error: %d\n</span><span style="color:#800000;">"</span><span style="color:#000000;">, err);
    }
    data</span>-&gt;criticalSection = <span style="color:#0000ff;">true</span><span style="color:#000000;">;

    </span><span style="color:#0000ff;">if</span> (NULL !=<span style="color:#000000;"> statement) {
        va_list args;
        va_start(args, statement);
        vprintf(statement, args);
        va_end(args);
    }
}

</span><span style="color:#0000ff;">void</span> ConsolePrintfContinue(<span style="color:#0000ff;">const</span> <span style="color:#0000ff;">char</span> *<span style="color:#000000;">statement, ...)
{
    </span><span style="color:#0000ff;">if</span> (NULL ==<span style="color:#000000;"> data) {
        printf(</span><span style="color:#800000;">"</span><span style="color:#800000;">ConsolePrintfContinue data was null\n</span><span style="color:#800000;">"</span><span style="color:#000000;">);
        </span><span style="color:#0000ff;">while</span> (<span style="color:#0000ff;">true</span><span style="color:#000000;">);
    }
    </span><span style="color:#0000ff;">if</span> (!data-&gt;<span style="color:#000000;">criticalSection) {
        printf(</span><span style="color:#800000;">"</span><span style="color:#800000;">ConsolePrintfContinue not in critical section\n</span><span style="color:#800000;">"</span><span style="color:#000000;">);
        </span><span style="color:#0000ff;">while</span> (<span style="color:#0000ff;">true</span><span style="color:#000000;">);
    }

    </span><span style="color:#0000ff;">if</span> (NULL !=<span style="color:#000000;"> statement) {
        va_list args;
        va_start(args, statement);
        vprintf(statement, args);
        va_end(args);
    }
}

</span><span style="color:#0000ff;">void</span> ConsolePrintfExit(<span style="color:#0000ff;">const</span> <span style="color:#0000ff;">char</span> *<span style="color:#000000;">statement, ...)
{
    </span><span style="color:#0000ff;">int</span><span style="color:#000000;"> err;
    </span><span style="color:#0000ff;">if</span> (NULL ==<span style="color:#000000;"> data) {
        printf(</span><span style="color:#800000;">"</span><span style="color:#800000;">ConsolePrintfExit data was null\n</span><span style="color:#800000;">"</span><span style="color:#000000;">);
        </span><span style="color:#0000ff;">while</span> (<span style="color:#0000ff;">true</span><span style="color:#000000;">);
    }
    </span><span style="color:#0000ff;">if</span> (!data-&gt;<span style="color:#000000;">criticalSection) {
        printf(</span><span style="color:#800000;">"</span><span style="color:#800000;">ConsolePrintfExit not in critical section\n</span><span style="color:#800000;">"</span><span style="color:#000000;">);
        </span><span style="color:#0000ff;">while</span> (<span style="color:#0000ff;">true</span><span style="color:#000000;">);
    }
    </span><span style="color:#0000ff;">if</span> (NULL !=<span style="color:#000000;"> statement) {
        va_list args;
        va_start(args, statement);
        vprintf(statement, args);
        va_end(args);
    }
    data</span>-&gt;criticalSection = <span style="color:#0000ff;">false</span><span style="color:#000000;">;
    </span><span style="color:#0000ff;">if</span> (<span style="color:#800080;">0</span> != (err = pthread_mutex_unlock(&amp;data-&gt;<span style="color:#000000;">mutex))) {
        printf(</span><span style="color:#800000;">"</span><span style="color:#800000;">ConsolePrintfExit, pthread_mutex_unlock error: %d\n</span><span style="color:#800000;">"</span><span style="color:#000000;">, err);
        </span><span style="color:#0000ff;">while</span> (<span style="color:#0000ff;">true</span><span style="color:#000000;">);
    }
}</span></pre> 
   </div> 
   <div class="cnblogs_code"> 
    <pre><span style="color:#008000;">//</span><span style="color:#008000;">console.h</span><span style="color:#008000;">
/*</span><span style="color:#008000;">----------------------------------------------------------</span><span style="color:#008000;">*/</span>
<span style="color:#008000;">/*</span><span style="color:#008000;">! \file
 *  \brief This file contains C-functions starting with "Console" to provide
 *         process and thread safe access to the console output.
 </span><span style="color:#008000;">*/</span>
<span style="color:#008000;">/*</span><span style="color:#008000;">----------------------------------------------------------</span><span style="color:#008000;">*/</span><span style="color:#000000;">
#ifndef _CONSOLE_H_
</span><span style="color:#0000ff;">#define</span> _CONSOLE_H_

<span style="color:#0000ff;">#define</span> RESETCOLOR "\033[0m"
<span style="color:#0000ff;">#define</span> GREEN      "\033[0;32m"
<span style="color:#0000ff;">#define</span> RED        "\033[0;31m"
<span style="color:#0000ff;">#define</span> YELLOW     "\033[1;33m"
<span style="color:#0000ff;">#define</span> BLUE       "\033[0;34m"<span style="color:#000000;">


#ifdef __cplusplus
</span><span style="color:#0000ff;">extern</span> <span style="color:#800000;">"</span><span style="color:#800000;">C</span><span style="color:#800000;">"</span><span style="color:#000000;">
{
</span><span style="color:#0000ff;">#endif</span>

    <span style="color:#0000ff;">void</span> show_read(unsigned <span style="color:#0000ff;">char</span> *str, unsigned <span style="color:#0000ff;">char</span> *buff, unsigned <span style="color:#0000ff;">int</span><span style="color:#000000;"> len);
    </span><span style="color:#008000;">/*</span><span style="color:#008000;">----------------------------------------------------------</span><span style="color:#008000;">*/</span>
    <span style="color:#008000;">/*</span><span style="color:#008000;">! \brief Initializes the resources needed to synchronize between processes and threads.
     *  \note This function must be called before any other function of this component.
     *
     </span><span style="color:#008000;">*/</span>
    <span style="color:#008000;">/*</span><span style="color:#008000;">----------------------------------------------------------</span><span style="color:#008000;">*/</span>
    <span style="color:#0000ff;">void</span> ConsoleInit(<span style="color:#0000ff;">void</span><span style="color:#000000;">);

    </span><span style="color:#008000;">/*</span><span style="color:#008000;">----------------------------------------------------------</span><span style="color:#008000;">*/</span>
    <span style="color:#008000;">/*</span><span style="color:#008000;">! \brief Destroys the resources needed to synchronize between processes and threads.
     *  \note After this function, any other function (except ConsoleInit) must not be called.
     *
     </span><span style="color:#008000;">*/</span>
    <span style="color:#008000;">/*</span><span style="color:#008000;">----------------------------------------------------------</span><span style="color:#008000;">*/</span>
    <span style="color:#0000ff;">void</span> ConsoleDeinit(<span style="color:#0000ff;">void</span><span style="color:#000000;">);

    </span><span style="color:#008000;">/*</span><span style="color:#008000;">----------------------------------------------------------</span><span style="color:#008000;">*/</span>
    <span style="color:#008000;">/*</span><span style="color:#008000;">! \brief Uses the board specific PRINT mechanism and provides thread and process safety.
     *
     </span><span style="color:#008000;">*/</span>
    <span style="color:#008000;">/*</span><span style="color:#008000;">----------------------------------------------------------</span><span style="color:#008000;">*/</span>
    <span style="color:#0000ff;">void</span> ConsolePrintf(<span style="color:#0000ff;">const</span> <span style="color:#0000ff;">char</span> *<span style="color:#000000;">statement, ...);

    </span><span style="color:#008000;">/*</span><span style="color:#008000;">----------------------------------------------------------</span><span style="color:#008000;">*/</span>
    <span style="color:#008000;">/*</span><span style="color:#008000;">! \brief Starts to print and stay blocked after exit of this function
     *
     </span><span style="color:#008000;">*/</span>
    <span style="color:#008000;">/*</span><span style="color:#008000;">----------------------------------------------------------</span><span style="color:#008000;">*/</span>
    <span style="color:#0000ff;">void</span> ConsolePrintfStart(<span style="color:#0000ff;">const</span> <span style="color:#0000ff;">char</span> *<span style="color:#000000;">statement, ...);

    </span><span style="color:#008000;">/*</span><span style="color:#008000;">----------------------------------------------------------</span><span style="color:#008000;">*/</span>
    <span style="color:#008000;">/*</span><span style="color:#008000;">! \brief Continue to print and stay blocked after exit of this function
     *  \note ConsolePrintfStart must be called before and when finished ConsolePrintfExit must be called.
     *  \note This function may be called multiple times.
     </span><span style="color:#008000;">*/</span>
    <span style="color:#008000;">/*</span><span style="color:#008000;">----------------------------------------------------------</span><span style="color:#008000;">*/</span>
    <span style="color:#0000ff;">void</span> ConsolePrintfContinue(<span style="color:#0000ff;">const</span> <span style="color:#0000ff;">char</span> *<span style="color:#000000;">statement, ...);

    </span><span style="color:#008000;">/*</span><span style="color:#008000;">----------------------------------------------------------</span><span style="color:#008000;">*/</span>
    <span style="color:#008000;">/*</span><span style="color:#008000;">! \brief Continue to print and unblock after finishing.
     *  \note ConsolePrintfStart must be called before. ConsolePrintfContinue may have been called before multiple times.
     </span><span style="color:#008000;">*/</span>
    <span style="color:#008000;">/*</span><span style="color:#008000;">----------------------------------------------------------</span><span style="color:#008000;">*/</span>
    <span style="color:#0000ff;">void</span> ConsolePrintfExit(<span style="color:#0000ff;">const</span> <span style="color:#0000ff;">char</span> *<span style="color:#000000;">statement, ...);

#ifdef __cplusplus
}
</span><span style="color:#0000ff;">#endif</span>

<span style="color:#0000ff;">#endif</span> <span style="color:#008000;">//</span><span style="color:#008000;">_CONSOLE_H_</span></pre> 
   </div> 
   <div class="cnblogs_code"> 
    <pre><span style="color:#000000;">#ifndef _BASE_H_
</span><span style="color:#0000ff;">#define</span> _BASE_H_<span style="color:#000000;">


#include </span>&lt;stdio.h&gt;<span style="color:#000000;">     
#include </span>&lt;stdlib.h&gt;<span style="color:#000000;">   
#include </span>&lt;unistd.h&gt;<span style="color:#000000;">     
#include </span>&lt;sys/types.h&gt;<span style="color:#000000;"> 
#include </span>&lt;sys/stat.h&gt;<span style="color:#000000;">  
#include </span>&lt;fcntl.h&gt;<span style="color:#000000;">    
#include </span>&lt;termios.h&gt;<span style="color:#000000;">  
#include </span>&lt;errno.h&gt;<span style="color:#000000;">    
#include </span>&lt;<span style="color:#0000ff;">string</span>.h&gt;<span style="color:#000000;">
#include </span>&lt;signal.h&gt;<span style="color:#000000;">
#include </span>&lt;unistd.h&gt;<span style="color:#000000;">
#include </span>&lt;fcntl.h&gt;<span style="color:#000000;">
#include </span>&lt;setjmp.h&gt;<span style="color:#000000;">
#include </span>&lt;sys/mman.h&gt;<span style="color:#000000;">


#include </span><span style="color:#800000;">"</span><span style="color:#800000;">uart.h</span><span style="color:#800000;">"</span><span style="color:#000000;">
#include </span><span style="color:#800000;">"</span><span style="color:#800000;">Console.h</span><span style="color:#800000;">"</span>


<span style="color:#008000;">//</span><span style="color:#008000;">#define DEBUG</span>
<span style="color:#000000;">
#ifdef DEBUG
    </span><span style="color:#0000ff;">#define</span> DEBUG_PRINT(format, ...)    ConsolePrintf(format, ##__VA_ARGS__);
    <span style="color:#0000ff;">#define</span> SHOW_READ(format, ...)    show_read(format, ##__VA_ARGS__);
<span style="color:#0000ff;">#else</span>
    <span style="color:#0000ff;">#define</span> DEBUG_PRINT(format, ...)
    <span style="color:#0000ff;">#define</span> SHOW_READ(format, ...)
<span style="color:#0000ff;">#endif</span>


<span style="color:#0000ff;">#define</span>     FALSE        0
<span style="color:#0000ff;">#define</span>     TRUE        1<span style="color:#000000;">


typedef unsigned </span><span style="color:#0000ff;">char</span>   BYTE;           <span style="color:#008000;">//</span><span style="color:#008000;">  8-bit</span>
typedef unsigned <span style="color:#0000ff;">short</span>  WORD;           <span style="color:#008000;">//</span><span style="color:#008000;"> 16-bit</span>
typedef unsigned <span style="color:#0000ff;">long</span>   DWORD;          <span style="color:#008000;">//</span><span style="color:#008000;"> 32-bit</span>
typedef unsigned <span style="color:#0000ff;">char</span><span style="color:#000000;">        u8;
typedef unsigned </span><span style="color:#0000ff;">short</span><span style="color:#000000;">        u16;
typedef unsigned </span><span style="color:#0000ff;">int</span><span style="color:#000000;">        u32;
typedef unsigned </span><span style="color:#0000ff;">long</span> <span style="color:#0000ff;">long</span><span style="color:#000000;">    u64;
typedef unsigned </span><span style="color:#0000ff;">char</span><span style="color:#000000;">        uint8;
typedef unsigned </span><span style="color:#0000ff;">short</span><span style="color:#000000;">        uint16;
typedef unsigned </span><span style="color:#0000ff;">int</span><span style="color:#000000;">        uint32;
typedef unsigned </span><span style="color:#0000ff;">long</span> <span style="color:#0000ff;">long</span><span style="color:#000000;">    uint64;



</span><span style="color:#008000;">/*</span><span style="color:#008000;"> takes a byte out of a uint32 : var - uint32,  ByteNum - byte to take out (0 - 3) </span><span style="color:#008000;">*/</span>
<span style="color:#0000ff;">#define</span> BREAK_UINT32( var, ByteNum ) \<span style="color:#000000;">
          (uint8)((uint32)(((</span><span style="color:#0000ff;">var</span>) &gt;&gt;((ByteNum) * <span style="color:#800080;">8</span>)) &amp; <span style="color:#800080;">0x00FF</span><span style="color:#000000;">))

</span><span style="color:#0000ff;">#define</span> BUILD_UINT32(Byte0, Byte1, Byte2, Byte3) \<span style="color:#000000;">
          ((uint32)((uint32)((Byte0) </span>&amp; <span style="color:#800080;">0x00FF</span><span style="color:#000000;">) \
          </span>+ ((uint32)((Byte1) &amp; <span style="color:#800080;">0x00FF</span>) &lt;&lt; <span style="color:#800080;">8</span><span style="color:#000000;">) \
          </span>+ ((uint32)((Byte2) &amp; <span style="color:#800080;">0x00FF</span>) &lt;&lt; <span style="color:#800080;">16</span><span style="color:#000000;">) \
          </span>+ ((uint32)((Byte3) &amp; <span style="color:#800080;">0x00FF</span>) &lt;&lt; <span style="color:#800080;">24</span><span style="color:#000000;">)))

</span><span style="color:#0000ff;">#define</span> BUILD_UINT16(loByte, hiByte) \<span style="color:#000000;">
          ((uint16)(((loByte) </span>&amp; <span style="color:#800080;">0x00FF</span>) + (((hiByte) &amp; <span style="color:#800080;">0x00FF</span>) &lt;&lt; <span style="color:#800080;">8</span><span style="color:#000000;">)))

</span><span style="color:#0000ff;">#define</span> HI_UINT16(a) (((a) &gt;&gt; 8) &amp; 0xFF)
<span style="color:#0000ff;">#define</span> LO_UINT16(a) ((a) &amp; 0xFF)

<span style="color:#0000ff;">#define</span> BUILD_UINT8(hiByte, loByte) \<span style="color:#000000;">
          ((uint8)(((loByte) </span>&amp; <span style="color:#800080;">0x0F</span>) + (((hiByte) &amp; <span style="color:#800080;">0x0F</span>) &lt;&lt; <span style="color:#800080;">4</span><span style="color:#000000;">)))

</span><span style="color:#0000ff;">#define</span> HI_UINT8(a) (((a) &gt;&gt; 4) &amp; 0x0F)
<span style="color:#0000ff;">#define</span> LO_UINT8(a) ((a) &amp; 0x0F)



<span style="color:#0000ff;">#endif</span></pre> 
   </div> 
   <p>&nbsp;</p> 
   <p>printk 调试方法</p> 
   <p><strong>方法1：</strong></p> 
   <p>//#define MY_DEBUG<br>#ifdef MY_DEBUG<br>#define MY_DBG(x...) do{printk(x);}while(0)<br>#else<br>#define MY_DBG(x...)<br>#endif</p> 
   <p>&nbsp;</p> 
   <p><strong>方法2：</strong></p> 
   <p><span>驱动可以如下写：</span></p> 
   <p>#define MY_LEVEL1 (1 &lt;&lt; 0)<br>#define MY_LEVEL2 (1 &lt;&lt; 1)</p> 
   <p>unsigned int my_trace_param=0;<br>module_param_named(trace, my_trace_param, uint, S_IRUGO|S_IWUSR);</p> 
   <p><br>#define MY_DBG(flag, msg...) \<br>do { \<br>if (my_trace_param &amp; flag) \<br>printk(KERN_ERR "zbh-debug: " msg); \<br>} while (0)</p> 
   <p>&nbsp;</p> 
   <p>MY_DBG(MY_LEVEL1, "Goodbye module exit1.\r\n");<br>MY_DBG(MY_LEVEL2, "Goodbye module exit2.\r\n");<br>MY_DBG(MY_LEVEL2, "Goodbye module exit3.\r\n");</p> 
   <p>&nbsp;</p> 
   <p>测试：</p> 
   <p>insmod my_printk_driver.ko&nbsp;</p> 
   <p>echo 2 &gt; /sys/module/my_printk_driver/parameters/trace&nbsp;</p> 
   <p>这样就可以选择到底打印哪一条语句，用来动态调试开关，默认关打印</p> 
   <p><img src="https://yqfile.alicdn.com/img_827272b1f21b039d02ee078822449f14.png" alt=""></p> 
   <p>&nbsp;</p> 
   <p>&nbsp;</p> 
   <p>&nbsp;</p> 
   <p>code:</p> 
   <div class="cnblogs_code"> 
    <pre>#include &lt;linux/init.h&gt;<span>
#include &lt;linux/module.h&gt;<span> #include &lt;linux/fs.h&gt;<span> #include &lt;linux/kernel.h&gt;<span> #include&lt;linux/slab.h&gt; //kmalloc #include&lt;asm/io.h&gt; //ioremap #include&lt;linux/device.h&gt; //class_create/device_create #include &lt;asm/uaccess.h&gt;<span> #include &lt;linux/pwm.h&gt;<span> #include &lt;linux/cdev.h&gt;<span> #include &lt;pax/gpio_cfg.h&gt;<span> #include &lt;pax/bcm5830x_gpio_def.h&gt;<span> #include &lt;mach/iproc_regs.h&gt;<span> #include &lt;mach/memory.h&gt;<span> #include &lt;mach/iomux.h&gt;<span> #include &lt;linux/delay.h&gt;<span> #include &lt;linux/gpio.h&gt;<span> #include &lt;linux/timer.h&gt;<span> #include &lt;linux/hrtimer.h&gt;<span> #include &lt;linux/ktime.h&gt; #define PWM_IOC_MAGIC 'n' #define PWM_CONFIG _IOW(PWM_IOC_MAGIC, 1, int) #define PWM_DISABLE _IOW(PWM_IOC_MAGIC, 2, int) #define ONE_PWM_CONFIG _IOW(PWM_IOC_MAGIC, 3, int) #define ONE_PWM_DISABLE _IOW(PWM_IOC_MAGIC, 4, int) #define ONE_PWM_WHILE_10000 _IOW(PWM_IOC_MAGIC, 5, int) #define SET_PWM_GPIO _IOW(PWM_IOC_MAGIC, 6, int) #define SET_PWM_POLATIRY _IOW(PWM_IOC_MAGIC, 7, int) #define READ_ONEPLUSE_COUNTER _IOW(PWM_IOC_MAGIC, 8, int) #define SET_PWM_FUNC _IOW(PWM_IOC_MAGIC, 9, int) #define SET_PWM_WHILE _IOW(PWM_IOC_MAGIC, 10, int) #define ONE_PWM_DOORBELL _IOW(PWM_IOC_MAGIC, 11, int) #define MY_LEVEL1 (1 &lt;&lt; 0) #define MY_LEVEL2 (1 &lt;&lt; 1)<span> unsigned int my_trace_param = 0<span>; module_param_named(trace, my_trace_param, uint, S_IRUGO|<span>S_IWUSR); #define MY_DBG(flag, msg...) \ do<span> { \ if (my_trace_param &amp;<span> flag) \ printk(KERN_ERR "zbh-bbl: "<span> msg); \ } while (0<span>) static int ttime = 0<span>; static int pmode = 0; // pmode=0 ----&gt; asiu_pwmc , pmode=1 ----&gt; onepluse <span> module_param(ttime, int, 0<span>); module_param(pmode, int, 0<span>); //module_param(period, int, 0); #define HELLO_MAJOR 230 int hello_major =<span> HELLO_MAJOR; module_param(hello_major, int, 0<span>); static struct cdev *hello_cdev =<span> NULL; static struct class *dev_class =<span> NULL; static struct device *dev_device =<span> NULL; static int hello_open(struct inode *inode, struct file *<span>filp); static int hello_release(struct inode *inode, struct file *<span>filp); static int hello_open(struct inode *inode, struct file *<span>filp) { printk("hello_open is OK\r\n"<span>); return 0<span>; } static int hello_release(struct inode *inode, struct file *<span>filp) { printk("hello_release is OK\r\n"<span>); printk("pwm disable and free\r\n"<span>); return 0<span>; } struct file_operations hello_ops =<span> { .owner =<span> THIS_MODULE, .open =<span> hello_open, .release =<span> hello_release, //.unlocked_ioctl = hello_ioctl, <span>}; static int __init hello_init(void<span>) { dev_t devno; int<span> ret; devno = MKDEV(hello_major, 0<span>); ret = register_chrdev_region(devno, 1, "zbh_hello"<span>); if (!<span>ret) { printk("register dev OK.\r\n"<span>); } else<span> { printk("register dev failed.\r\n"<span>); } hello_cdev =<span> cdev_alloc(); cdev_init(hello_cdev, &amp;<span>hello_ops); cdev_add(hello_cdev, devno, 1<span>); hello_cdev-&gt;owner =<span> THIS_MODULE; hello_cdev-&gt;ops = &amp;<span>hello_ops; dev_class = class_create(THIS_MODULE, "dev_class"<span>); if<span> (IS_ERR(dev_class)) { printk(KERN_ERR "class_create() failed for dev_class\n"<span>); ret = -<span>EINVAL; goto<span> out_err_1; } dev_device = device_create(dev_class, NULL, devno, NULL, "zbh_hello"<span>); if<span> (IS_ERR(dev_device)) { printk(KERN_ERR "device_create failed.\r\n"<span>); ret = -<span>ENODEV; goto<span> out_err_2; } printk("Hello module init OK.\r\n"<span>); return 0<span>; out_err_2: class_destroy(dev_class); out_err_1: unregister_chrdev_region(MKDEV(hello_major, 0), 1<span>); cdev_del(hello_cdev); return<span> ret; } static void __exit hello_exit(void<span>) { cdev_del(hello_cdev); device_destroy(dev_class, MKDEV(hello_major, 0<span>)); class_destroy(dev_class); unregister_chrdev_region(MKDEV(hello_major, 0), 1<span>); MY_DBG(MY_LEVEL1, "Goodbye module exit1.\r\n"<span>); MY_DBG(MY_LEVEL2, "Goodbye module exit2.\r\n"<span>); MY_DBG(MY_LEVEL2, "Goodbye module exit3.\r\n"<span>); } module_init(hello_init); module_exit(hello_exit); MODULE_LICENSE("Dual BSD/GPL"<span>); MODULE_AUTHOR("zhangbinghua"<span>); MODULE_DESCRIPTION("zhangbh debug driver");</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre> 
   </div> 
   <p>&nbsp;</p> 
   <div> 
    <div>
     【作者】
     <a href="http://www.cnblogs.com/sky-heaven/" rel="nofollow">张昺华</a> 
    </div> 
    <div>
     【出处】
     <a href="http://www.cnblogs.com/sky-heaven/" rel="nofollow">http://www.cnblogs.com/sky-heaven/</a> 
    </div> 
    <div>
     【博客园】 
     <a href="http://www.cnblogs.com/sky-heaven/" rel="nofollow">http://www.cnblogs.com/sky-heaven/</a> 
    </div> 
    <div>
     【新浪博客】 
     <a href="http://blog.sina.com.cn/u/2049150530" rel="nofollow">http://blog.sina.com.cn/u/2049150530</a> 
    </div> 
    <div>
     【知乎】 
     <a href="http://www.zhihu.com/people/zhang-bing-hua" rel="nofollow">http://www.zhihu.com/people/zhang-bing-hua</a> 
    </div> 
    <div>
     【我的作品---旋转倒立摆】 
     <a href="http://v.youku.com/v_show/id_XODM5NDAzNjQw.html?spm=a2hzp.8253869.0.0&amp;from=y1.7-2" rel="nofollow">http://v.youku.com/v_show/id_XODM5NDAzNjQw.html?spm=a2hzp.8253869.0.0&amp;from=y1.7-2</a> 
    </div> 
    <div>
     【我的作品---自平衡自动循迹车】 
     <a href="http://v.youku.com/v_show/id_XODM5MzYyNTIw.html?spm=a2hzp.8253869.0.0&amp;from=y1.7-2" rel="nofollow">http://v.youku.com/v_show/id_XODM5MzYyNTIw.html?spm=a2hzp.8253869.0.0&amp;from=y1.7-2</a> 
    </div> 
    <div>
     【新浪微博】 张昺华--sky
    </div> 
    <div>
     【twitter】 @sky2030_
    </div> 
    <div>
     【facebook】 张昺华 zhangbinghua
    </div> 
    <div>
     本文版权归作者和博客园共有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利.
    </div> 
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
