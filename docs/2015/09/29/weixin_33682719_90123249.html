<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Linux内核启动流程分析（二）【转】 « NotBeCN</title>
  <meta name="description" content="             转自：http://blog.chinaunix.net/uid-25909619-id-3380544.html    S3C2410&nbsp;Linux&nbsp;2.6.35.7启动分析(第二阶段)    接着上面的分析，第一阶段的代码跳转后，会进入第二阶段的代码。    第二阶...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2015/09/29/weixin_33682719_90123249.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">Linux内核启动流程分析（二）【转】</h1>
    <p class="post-meta">Sep 29, 2015</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p>转自：<a href="http://blog.chinaunix.net/uid-25909619-id-3380544.html" rel="nofollow">http://blog.chinaunix.net/uid-25909619-id-3380544.html</a></p> 
   <p>S3C2410&nbsp;Linux&nbsp;2.6.35.7启动分析(第二阶段)</p> 
   <p>接着上面的分析，第一阶段的代码跳转后，会进入第二阶段的代码。</p> 
   <p>第二阶段的代码是从\arch\arm\kernel\head.S开始的。</p> 
   <p>内核启动第二阶段主要完成的工作有，cpu&nbsp;ID检查，machine&nbsp;ID(也就是开发板ID)检查，创建初始化页表，设置C代码运行环境，跳转到内核第一个真正的C函数startkernel开始执行。</p> 
   <p>这一阶段涉及到两个重要的结构体：</p> 
   <p>(1)&nbsp;一个是struct&nbsp;proc_info_list&nbsp;主要描述CPU相关的信息，定义在文件arch\arm\include\asm\procinfo.h中，与其相关的函数及变量在文件arch/arm/mm/proc_arm920.S中被定义和赋值。</p> 
   <p>(2)&nbsp;另一个结构体是描述开发板或者说机器信息的结构体struct&nbsp;machine_desc，定义在\arch\arm\include\asm\mach\arch.h文件中，其函数的定义和变量的赋值在板极相关文件arch/arm/mach-s3c2410/mach-smdk2410.c中实现，这也是内核移植非常重要的一个文件。</p> 
   <p>该阶段一般由前面的解压缩代码调用<span style="font-family:'Times New Roman';">,</span><span style="font-family:'宋体';">进入该阶段要求：</span></p> 
   <p>&nbsp;MMU&nbsp;=&nbsp;off,&nbsp;D-cache&nbsp;=&nbsp;off,&nbsp;I-cache&nbsp;=&nbsp;dont&nbsp;care,r0&nbsp;=&nbsp;0,&nbsp;r1&nbsp;=&nbsp;machine&nbsp;id.</p> 
   <p>所有的机器ID列表保存在arch/arm/tools/mach-types&nbsp;文件中，在编译时会将这些机器ID按照统一的格式链接到基本内核映像文件vmlinux的__arch_info_begin和__arch_info_end之间的段中。存储格式定义在include/asm-arm/mach/arch.h文件中的结构体struct&nbsp;machine_desc&nbsp;{}。这两个结构体的内容最终会被连接到基本内核映像vmlinux中的两个段内，分别是*(.proc.info.init)和*(.arch.info.init)，可以参考下面的连接脚本。</p> 
   <p>链接脚本：arch/arm/kernel/vmlinux.lds</p> 
   <p>*****************************链接脚本**************************************</p> 
   <p><span style="font-size:large;">SECTIONS</span></p> 
   <p><span style="font-size:large;">{</span></p> 
   <p><span style="font-size:large;">.&nbsp;=&nbsp;TEXTADDR;</span></p> 
   <p><span style="font-size:large;">.init&nbsp;:&nbsp;{&nbsp;/*&nbsp;初始化代码段*/</span></p> 
   <p><span style="font-size:large;">_stext&nbsp;=&nbsp;.;</span></p> 
   <p><span style="font-size:large;">_sinittext&nbsp;=&nbsp;.;</span></p> 
   <p><span style="font-size:large;">*(.init.text)</span></p> 
   <p><span style="font-size:large;">_einittext&nbsp;=&nbsp;.;</span></p> 
   <p><span style="font-size:large;">__proc_info_begin&nbsp;=&nbsp;.;</span></p> 
   <p><span style="font-size:large;">*(.proc.info.init)</span></p> 
   <p><span style="font-size:large;">__proc_info_end&nbsp;=&nbsp;.;</span></p> 
   <p><span style="font-size:large;">__arch_info_begin&nbsp;=&nbsp;.;</span></p> 
   <p><span style="font-size:large;">*(.arch.info.init)</span></p> 
   <p><span style="font-size:large;">__arch_info_end&nbsp;=&nbsp;.;</span></p> 
   <p><span style="font-size:large;">__tagtable_begin&nbsp;=&nbsp;.;</span></p> 
   <p><span style="font-size:large;">*(.taglist.init)</span></p> 
   <p><span style="font-size:large;">__tagtable_end&nbsp;=&nbsp;.;</span></p> 
   <p><span style="font-size:large;">.&nbsp;=&nbsp;ALIGN(16);</span></p> 
   <p><span style="font-size:large;">__setup_start&nbsp;=&nbsp;.;</span></p> 
   <p><span style="font-size:large;">*(.init.setup)</span></p> 
   <p><span style="font-size:large;">__setup_end&nbsp;=&nbsp;.;</span></p> 
   <p><span style="font-size:large;">__early_begin&nbsp;=&nbsp;.;</span></p> 
   <p><span style="font-size:large;">*(.early_param.init)</span></p> 
   <p><span style="font-size:large;">__early_end&nbsp;=&nbsp;.;</span></p> 
   <p><span style="font-size:large;">__initcall_start&nbsp;=&nbsp;.;</span></p> 
   <p><span style="font-size:large;">*(.initcall1.init)</span></p> 
   <p><span style="font-size:large;">*(.initcall2.init)</span></p> 
   <p><span style="font-size:large;">*(.initcall3.init)</span></p> 
   <p><span style="font-size:large;">*(.initcall4.init)</span></p> 
   <p><span style="font-size:large;">*(.initcall5.init)</span></p> 
   <p><span style="font-size:large;">*(.initcall6.init)</span></p> 
   <p><span style="font-size:large;">*(.initcall7.init)</span></p> 
   <p><span style="font-size:large;">__initcall_end&nbsp;=&nbsp;.;</span></p> 
   <p><span style="font-size:large;">__con_initcall_start&nbsp;=&nbsp;.;</span></p> 
   <p><span style="font-size:large;">*(.con_initcall.init)</span></p> 
   <p><span style="font-size:large;">__con_initcall_end&nbsp;=&nbsp;.;</span></p> 
   <p><span style="font-size:large;">__security_initcall_start&nbsp;=&nbsp;.;</span></p> 
   <p><span style="font-size:large;">*(.security_initcall.init)</span></p> 
   <p><span style="font-size:large;">__security_initcall_end&nbsp;=&nbsp;.;</span></p> 
   <p><span style="font-size:large;">.&nbsp;=&nbsp;ALIGN(32);</span></p> 
   <p><span style="font-size:large;">__initramfs_start&nbsp;=&nbsp;.;</span></p> 
   <p><span style="font-size:large;">usr/built-in.o(.init.ramfs)</span></p> 
   <p><span style="font-size:large;">__initramfs_end&nbsp;=&nbsp;.;</span></p> 
   <p><span style="font-size:large;">.&nbsp;=&nbsp;ALIGN(64);</span></p> 
   <p><span style="font-size:large;">__per_cpu_start&nbsp;=&nbsp;.;</span></p> 
   <p><span style="font-size:large;">*(.data.percpu)</span></p> 
   <p><span style="font-size:large;">__per_cpu_end&nbsp;=&nbsp;.;</span></p> 
   <p><span style="font-size:large;">#ifndef&nbsp;CONFIG_XIP_KERNEL</span></p> 
   <p><span style="font-size:large;">__init_begin&nbsp;=&nbsp;_stext;</span></p> 
   <p><span style="font-size:large;">*(.init.data)</span></p> 
   <p><span style="font-size:large;">.&nbsp;=&nbsp;ALIGN(4096);</span></p> 
   <p><span style="font-size:large;">__init_end&nbsp;=&nbsp;.;</span></p> 
   <p><span style="font-size:large;">#endif</span></p> 
   <p><span style="font-size:large;">}</span></p> 
   <p>*****************************链接脚本**************************************</p> 
   <p>下面开始代码\arch\arm\kernel\head.S的注释：</p> 
   <p>开始分析前先看下一点基础知识：</p> 
   <p>1.&nbsp;kernel运行的史前时期和内存布局</p> 
   <p><span style="font-size:large;">在arm平台下，zImage.bin压缩镜像是由bootloader加载到物理内存，然后跳到zImage.bin里一段程序，它专门于将被压缩的kernel解压缩到KERNEL_RAM_PADDR开始的一段内存中，接着跳进真正的kernel去执行。该kernel的执行起点是stext函数，定义于arch/arm/kernel/head.S。此时内存的布局如下图所示</span></p> 
   <p><a href="https://yqfile.alicdn.com/img_d3620ace70dab31d36ec3339d333355b.jpg" rel="nofollow"><img src="https://yqfile.alicdn.com/img_d3620ace70dab31d36ec3339d333355b.jpg" alt="" width="493" height="435"></a></p> 
   <p>&nbsp;</p> 
   <p><span style="font-size:large;">在开发板3c2410中，SDRAM连接到内存控制器的Bank6中，它的开始内存地址是0x30000000，大小为64M，即0x20000000。&nbsp;ARM&nbsp;Linux&nbsp;kernel将SDRAM的开始地址定义为PHYS_OFFSET。经bootloader加载kernel并由自解压部分代码运行后，最终kernel被放置到KERNEL_RAM_PADDR（=PHYS_OFFSET&nbsp;+&nbsp;TEXT_OFFSET，即0x30008000）地址上的一段内存，经此放置后，kernel代码以后均不会被移动。</span></p> 
   <p><span style="font-size:large;">在进入kernel代码前，即bootloader和自解压缩阶段，ARM未开启MMU功能。因此kernel启动代码一个重要功能是设置好相应的页表，并开启MMU功能。为了支持MMU功能，kernel镜像中的所有符号，包括代码段和数据段的符号，在链接时都生成了它在开启MMU时，所在物理内存地址映射到的虚拟内存地址。</span></p> 
   <p><span style="font-size:large;">以arm&nbsp;kernel第一个符号（函数）stext为例，在编译链接，它生成的虚拟地址是0xc0008000，而放置它的物理地址为0x30008000（还记得这是PHYS_OFFSET+TEXT_OFFSET吗？）。实际上这个变换可以利用简单的公式进行表示：va&nbsp;=&nbsp;pa&nbsp;–&nbsp;PHYS_OFFSET&nbsp;+&nbsp;PAGE_OFFSET。Arm&nbsp;linux最终的kernel空间的页表，就是按照这个关系来建立。</span></p> 
   <p><span style="font-size:large;">之所以较早提及arm&nbsp;linux&nbsp;的内存映射，原因是在进入kernel代码，里面所有符号地址值为清一色的0xCXXXXXXX地址，而此时ARM未开启MMU功能，故在执行stext函数第一条执行时，它的PC值就是stext所在的内存地址（即物理地址，0x30008000）。因此，下面有些代码，需要使用地址无关技术。</span></p> 
   <p>&nbsp;</p> 
   <p><span style="font-size:large;">__HEAD&nbsp;&nbsp;/*该宏定义了下面的代码位于".head.text"段内*/</span></p> 
   <p><span style="font-size:large;">.type&nbsp;stext,&nbsp;%function&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*声明stext为函数*/</span></p> 
   <p><span style="font-size:large;">ENTRY(stext)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*第二阶段的入口地址*/</span></p> 
   <p><span style="font-size:large;">setmode&nbsp;PSR_F_BIT&nbsp;|&nbsp;PSR_I_BIT&nbsp;|&nbsp;SVC_MODE,&nbsp;r9&nbsp;&nbsp;@&nbsp;ensure&nbsp;svc&nbsp;mode&nbsp;and&nbsp;irqs&nbsp;disabled&nbsp;进入超级权限模式，关中断</span></p> 
   <p><span style="font-size:large;">/*从协处理器CP15，C0读取CPU&nbsp;ID,然后在__proc_info_begin开始的段中进行查找，如果找到，则返回对应处理器相关结构体在物理地址空间的首地址到r5，最后保存在r10中*/</span></p> 
   <p><span style="font-size:large;">mrc&nbsp;p15,&nbsp;0,&nbsp;r9,&nbsp;c0,&nbsp;c0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;get&nbsp;processor&nbsp;id&nbsp;取出cpu&nbsp;id</span></p> 
   <p><span style="font-size:large;">bl&nbsp;__lookup_processor_type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;r5=procinfo&nbsp;r9=cpuid</span></p> 
   <p><span style="font-size:large;">/**********************************************************************/&nbsp;</span></p> 
   <p><span style="font-size:large;">__lookup_processor_type函数的具体解析开始（\arch\arm\kernel\&nbsp;head-common.S）</span></p> 
   <p><span style="font-size:large;">/**********************************************************************/&nbsp;</span></p> 
   <p><span style="font-size:large;">在讲解该程序段之前先来看一些相关知识，内核所支持的每一种CPU&nbsp;类型都由结构体proc_info_list来描述。&nbsp;</span></p> 
   <p><span style="font-size:large;">该结构体在文件arch/arm/include/asm/procinfo.h&nbsp;中定义：&nbsp;</span></p> 
   <p><span style="font-size:large;">struct&nbsp;proc_info_list&nbsp;{&nbsp;</span></p> 
   <p><span style="font-size:large;">unsigned&nbsp;int&nbsp;cpu_val;&nbsp;</span></p> 
   <p><span style="font-size:large;">unsigned&nbsp;int&nbsp;cpu_mask;&nbsp;</span></p> 
   <p><span style="font-size:large;">unsigned&nbsp;long&nbsp;__cpu_mm_mmu_flags;&nbsp;/*&nbsp;used&nbsp;by&nbsp;head.S&nbsp;*/&nbsp;</span></p> 
   <p><span style="font-size:large;">unsigned&nbsp;long&nbsp;__cpu_io_mmu_flags;&nbsp;/*&nbsp;used&nbsp;by&nbsp;head.S&nbsp;*/&nbsp;</span></p> 
   <p><span style="font-size:large;">unsigned&nbsp;long&nbsp;__cpu_flush;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;used&nbsp;by&nbsp;head.S&nbsp;*/&nbsp;</span></p> 
   <p><span style="font-size:large;">const&nbsp;char&nbsp;*arch_name;&nbsp;</span></p> 
   <p><span style="font-size:large;">const&nbsp;char&nbsp;*elf_name;&nbsp;</span></p> 
   <p><span style="font-size:large;">unsigned&nbsp;int&nbsp;elf_hwcap;&nbsp;</span></p> 
   <p><span style="font-size:large;">const&nbsp;char&nbsp;*cpu_name;&nbsp;</span></p> 
   <p><span style="font-size:large;">struct&nbsp;processor&nbsp;*proc;&nbsp;</span></p> 
   <p><span style="font-size:large;">struct&nbsp;cpu_tlb_fns&nbsp;*tlb;&nbsp;</span></p> 
   <p><span style="font-size:large;">struct&nbsp;cpu_user_fns&nbsp;*user;&nbsp;</span></p> 
   <p><span style="font-size:large;">struct&nbsp;cpu_cache_fns&nbsp;*cache;&nbsp;</span></p> 
   <p><span style="font-size:large;">};&nbsp;</span></p> 
   <p><span style="font-size:large;">对于&nbsp;arm920&nbsp;来说，其对应结构体在文件&nbsp;linux/arch/arm/mm/proc-arm920.S&nbsp;中初始化。&nbsp;</span></p> 
   <p><span style="font-size:large;">.section&nbsp;".proc.info.init",&nbsp;#alloc,&nbsp;#execinstr&nbsp;/*定义了一个段，下面的结构体存放在该段中*/</span></p> 
   <p><span style="font-size:large;">.type&nbsp;__arm920_proc_info,#object&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*声明一个结构体对象*/</span></p> 
   <p><span style="font-size:large;">__arm920_proc_info:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*为该结构体赋值*/</span></p> 
   <p><span style="font-size:large;">.long&nbsp;0x41009200</span></p> 
   <p><span style="font-size:large;">.long&nbsp;0xff00fff0</span></p> 
   <p><span style="font-size:large;">.long&nbsp;&nbsp;PMD_TYPE_SECT&nbsp;|&nbsp;\</span></p> 
   <p><span style="font-size:large;">PMD_SECT_BUFFERABLE&nbsp;|&nbsp;\</span></p> 
   <p><span style="font-size:large;">PMD_SECT_CACHEABLE&nbsp;|&nbsp;\</span></p> 
   <p><span style="font-size:large;">PMD_BIT4&nbsp;|&nbsp;\</span></p> 
   <p><span style="font-size:large;">PMD_SECT_AP_WRITE&nbsp;|&nbsp;\</span></p> 
   <p><span style="font-size:large;">PMD_SECT_AP_READ</span></p> 
   <p><span style="font-size:large;">.long&nbsp;&nbsp;PMD_TYPE_SECT&nbsp;|&nbsp;\</span></p> 
   <p><span style="font-size:large;">PMD_BIT4&nbsp;|&nbsp;\</span></p> 
   <p><span style="font-size:large;">PMD_SECT_AP_WRITE&nbsp;|&nbsp;\</span></p> 
   <p><span style="font-size:large;">PMD_SECT_AP_READ</span></p> 
   <p><span style="font-size:large;">b&nbsp;__arm920_setup</span></p> 
   <p><span style="font-size:large;">…………………………………</span></p> 
   <p><span style="font-size:large;">.section&nbsp;".proc.info.init"表明了该结构在编译后存放的位置。在链接文件&nbsp;arch/arm/kernel/vmlinux.lds&nbsp;中：&nbsp;</span></p> 
   <p><span style="font-size:large;">SECTIONS&nbsp;</span></p> 
   <p><span style="font-size:large;">{&nbsp;</span></p> 
   <p><span style="font-size:large;">#ifdef&nbsp;CONFIG_XIP_KERNEL&nbsp;</span></p> 
   <p><span style="font-size:large;">.&nbsp;=&nbsp;XIP_VIRT_ADDR(CONFIG_XIP_PHYS_ADDR);&nbsp;</span></p> 
   <p><span style="font-size:large;">#else&nbsp;</span></p> 
   <p><span style="font-size:large;">.&nbsp;=&nbsp;PAGE_OFFSET&nbsp;+&nbsp;TEXT_OFFSET;&nbsp;</span></p> 
   <p><span style="font-size:large;">#endif&nbsp;</span></p> 
   <p><span style="font-size:large;">.text.head&nbsp;:&nbsp;{&nbsp;</span></p> 
   <p><span style="font-size:large;">_stext&nbsp;=&nbsp;.;&nbsp;</span></p> 
   <p><span style="font-size:large;">_sinittext&nbsp;=&nbsp;.;&nbsp;</span></p> 
   <p><span style="font-size:large;">*(.text.head)&nbsp;</span></p> 
   <p><span style="font-size:large;">}</span></p> 
   <p><span style="font-size:large;">.init&nbsp;:&nbsp;{&nbsp;/*&nbsp;Init&nbsp;code&nbsp;and&nbsp;data&nbsp;*/&nbsp;</span></p> 
   <p><span style="font-size:large;">INIT_TEXT&nbsp;</span></p> 
   <p><span style="font-size:large;">_einittext&nbsp;=&nbsp;.;&nbsp;</span></p> 
   <p><span style="font-size:large;">__proc_info_begin&nbsp;=&nbsp;.;&nbsp;</span></p> 
   <p><span style="font-size:large;">*(.proc.info.init)&nbsp;</span></p> 
   <p><span style="font-size:large;">__proc_info_end&nbsp;=&nbsp;.;&nbsp;</span></p> 
   <p><span style="font-size:large;">__arch_info_begin&nbsp;=&nbsp;.;&nbsp;</span></p> 
   <p><span style="font-size:large;">*(.arch.info.init)&nbsp;</span></p> 
   <p><span style="font-size:large;">__arch_info_end&nbsp;=&nbsp;.;&nbsp;</span></p> 
   <p><span style="font-size:large;">__tagtable_begin&nbsp;=&nbsp;.;&nbsp;</span></p> 
   <p><span style="font-size:large;">*(.taglist.init)&nbsp;</span></p> 
   <p><span style="font-size:large;">__tagtable_end&nbsp;=&nbsp;.;&nbsp;</span></p> 
   <p><span style="font-size:large;">………………………………&nbsp;</span></p> 
   <p><span style="font-size:large;">｝&nbsp;</span></p> 
   <p><span style="font-size:large;">所有CPU类型对应的被初始化的&nbsp;proc_info_list结构体都放在&nbsp;__proc_info_begin和__proc_info_end之间。&nbsp;</span></p> 
   <p><span style="font-size:large;">/&nbsp;*</span></p> 
   <p><span style="font-size:large;">*&nbsp;r9&nbsp;=&nbsp;cpuid</span></p> 
   <p><span style="font-size:large;">*&nbsp;&nbsp;Returns:</span></p> 
   <p><span style="font-size:large;">*&nbsp;r5&nbsp;=&nbsp;proc_info&nbsp;pointer&nbsp;in&nbsp;physical&nbsp;address&nbsp;space</span></p> 
   <p><span style="font-size:large;">*&nbsp;r9&nbsp;=&nbsp;cpuid&nbsp;(preserved)</span></p> 
   <p><span style="font-size:large;">*/</span></p> 
   <p><span style="font-size:large;">__lookup_processor_type:</span></p> 
   <p><span style="font-size:large;">adr&nbsp;r3,&nbsp;3f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@r3存储的是标号&nbsp;3&nbsp;的物理地址（由于没有启用&nbsp;mmu&nbsp;，所以当前肯定是物理地址）&nbsp;</span></p> 
   <p><span style="font-size:large;">ldmia&nbsp;r3,&nbsp;{r5&nbsp;-&nbsp;r7}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;R5=__proc_info_begin，r6=__proc_info_end，r7=标号4处的虚拟地址，即4:&nbsp;.long&nbsp;.&nbsp;处的地址</span></p> 
   <p><span style="font-size:large;">add&nbsp;r3,&nbsp;r3,&nbsp;#8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;得到4处的物理地址，刚好是跳过两条指令</span></p> 
   <p><span style="font-size:large;">sub&nbsp;r3,&nbsp;r3,&nbsp;r7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;get&nbsp;offset&nbsp;between&nbsp;virt&amp;phys得到虚拟地址和物理地址之间的offset</span></p> 
   <p><span style="font-size:large;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*利用offset&nbsp;，将&nbsp;r5&nbsp;和&nbsp;r6&nbsp;中保存的虚拟地址转变为物理地址*/</span></p> 
   <p><span style="font-size:large;">add&nbsp;r5,&nbsp;r5,&nbsp;r3&nbsp;@&nbsp;convert&nbsp;virt&nbsp;addresses&nbsp;to</span></p> 
   <p><span style="font-size:large;">add&nbsp;r6,&nbsp;r6,&nbsp;r3&nbsp;@&nbsp;physical&nbsp;address&nbsp;space</span></p> 
   <p><span style="font-size:large;">1:&nbsp;ldmia&nbsp;r5,&nbsp;{r3,&nbsp;r4}&nbsp;@&nbsp;value,&nbsp;mask&nbsp;&nbsp;r3=&nbsp;cpu_val&nbsp;,&nbsp;r4=&nbsp;cpu_mask</span></p> 
   <p><span style="font-size:large;">and&nbsp;r4,&nbsp;r4,&nbsp;r9&nbsp;@&nbsp;mask&nbsp;wanted&nbsp;bits;r9&nbsp;中存放的是先前读出的&nbsp;processor&nbsp;ID&nbsp;，此处屏蔽不需要的位</span></p> 
   <p><span style="font-size:large;">teq&nbsp;r3,&nbsp;r4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;查看代码和CPU&nbsp;硬件是否匹配（&nbsp;比如想在arm920t上运行为cortex-a8编译的内核？不让）</span></p> 
   <p><span style="font-size:large;">beq&nbsp;2f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;如果相等则跳转到标号2处，执行返回指令</span></p> 
   <p><span style="font-size:large;">add&nbsp;r5,&nbsp;r5,&nbsp;#PROC_INFO_SZ&nbsp;@&nbsp;sizeof(proc_info_list结构的长度，在这等于48)如果没找到，&nbsp;跳到下一个proc_info_list&nbsp;处</span></p> 
   <p><span style="font-size:large;">cmp&nbsp;r5,&nbsp;r6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;判断是不是到了该段的结尾</span></p> 
   <p><span style="font-size:large;">blo&nbsp;1b&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;如果没有，继续跳到标号1处，查找下一个</span></p> 
   <p><span style="font-size:large;">mov&nbsp;r5,&nbsp;#0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;unknown&nbsp;processor&nbsp;，如果到了结尾，没找到匹配的，就把0赋值给r5，然后返回</span></p> 
   <p><span style="font-size:large;">2:&nbsp;mov&nbsp;pc,&nbsp;lr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;找到后返回，r5指向找到的结构体</span></p> 
   <p><span style="font-size:large;">ENDPROC(__lookup_processor_type)</span></p> 
   <p><span style="font-size:large;">.align&nbsp;2</span></p> 
   <p><span style="font-size:large;">3:&nbsp;.long&nbsp;__proc_info_begin</span></p> 
   <p><span style="font-size:large;">.long&nbsp;__proc_info_end</span></p> 
   <p><span style="font-size:large;">4:&nbsp;.long&nbsp;.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@“.”表示当前这行代码编译连接后的虚拟地址</span></p> 
   <p><span style="font-size:large;">.long&nbsp;__arch_info_begin</span></p> 
   <p><span style="font-size:large;">.long&nbsp;__arch_info_end</span></p> 
   <p><span style="font-size:large;">/**********************************************************************/&nbsp;</span></p> 
   <p><span style="font-size:large;">__lookup_processor_type函数的具体解析结束（\arch\arm\kernel\&nbsp;head-common.S）</span></p> 
   <p><span style="font-size:large;">/**********************************************************************/&nbsp;</span></p> 
   <p>&nbsp;</p> 
   <p><span style="font-size:large;">movs&nbsp;r10,&nbsp;r5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;invalid&nbsp;processor&nbsp;(r5=0)?</span></p> 
   <p><span style="font-size:large;">beq&nbsp;__error_p&nbsp;@&nbsp;yes,&nbsp;error&nbsp;'p'</span></p> 
   <p><span style="font-size:large;">/*机器&nbsp;ID是由u-boot引导内核是通过thekernel第二个参数传递进来的，现在保存在r1中,在__arch_info_begin开始的段中进行查找，如果找到，则返回machine对应相关结构体在物理地址空间的首地址到r5，最后保存在r8中。</span></p> 
   <p><span style="font-size:large;">bl&nbsp;__lookup_machine_type&nbsp;@&nbsp;r5=machinfo</span></p> 
   <p><span style="font-size:large;">/**********************************************************************/&nbsp;</span></p> 
   <p><span style="font-size:large;">__lookup_machine_type函数的具体解析开始（\arch\arm\kernel\&nbsp;head-common.S）</span></p> 
   <p><span style="font-size:large;">/**********************************************************************/&nbsp;</span></p> 
   <p><span style="font-size:large;">每一个CPU&nbsp;平台都可能有其不一样的结构体，描述这个平台的结构体是&nbsp;machine_desc&nbsp;。&nbsp;</span></p> 
   <p><span style="font-size:large;">这个结构体在文件arch/arm/include/asm/mach/arch.h&nbsp;中定义：&nbsp;</span></p> 
   <p><span style="font-size:large;">struct&nbsp;machine_desc&nbsp;{&nbsp;</span></p> 
   <p><span style="font-size:large;">unsigned&nbsp;int&nbsp;nr;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;architecture&nbsp;number&nbsp;*/&nbsp;</span></p> 
   <p><span style="font-size:large;">unsigned&nbsp;int&nbsp;phys_io;&nbsp;/*&nbsp;start&nbsp;of&nbsp;physical&nbsp;io&nbsp;*/&nbsp;</span></p> 
   <p><span style="font-size:large;">………………………………&nbsp;</span></p> 
   <p><span style="font-size:large;">};&nbsp;</span></p> 
   <p><span style="font-size:large;">对于平台smdk2410&nbsp;来说其对应&nbsp;machine_desc&nbsp;结构在文件linux/arch/arm/mach-s3c2410/mach-smdk2410.c中初始化：&nbsp;</span></p> 
   <p><span style="font-size:large;">MACHINE_START(SMDK2410,&nbsp;"SMDK2410")&nbsp;&nbsp;</span></p> 
   <p><span style="font-size:large;">.phys_io&nbsp;=&nbsp;S3C2410_PA_UART,&nbsp;</span></p> 
   <p><span style="font-size:large;">.io_pg_offst&nbsp;=&nbsp;(((u32)S3C24XX_VA_UART)&nbsp;&gt;&gt;&nbsp;18)&nbsp;&amp;&nbsp;0xfffc,&nbsp;</span></p> 
   <p><span style="font-size:large;">.boot_params&nbsp;=&nbsp;S3C2410_SDRAM_PA&nbsp;+&nbsp;0x100,&nbsp;</span></p> 
   <p><span style="font-size:large;">.map_io&nbsp;=&nbsp;smdk2410_map_io,&nbsp;</span></p> 
   <p><span style="font-size:large;">.init_irq&nbsp;=&nbsp;s3c24xx_init_irq,&nbsp;</span></p> 
   <p><span style="font-size:large;">.init_machine&nbsp;=&nbsp;smdk2410_init,&nbsp;</span></p> 
   <p><span style="font-size:large;">.timer&nbsp;=&nbsp;&amp;s3c24xx_timer,&nbsp;</span></p> 
   <p><span style="font-size:large;">MACHINE_END&nbsp;</span></p> 
   <p><span style="font-size:large;">对于宏MACHINE_START&nbsp;在文件&nbsp;arch/arm/include/asm/mach/arch.h&nbsp;中定义：&nbsp;</span></p> 
   <p><span style="font-size:large;">#define&nbsp;MACHINE_START(_type,_name)&nbsp;/&nbsp;</span></p> 
   <p><span style="font-size:large;">static&nbsp;const&nbsp;struct&nbsp;machine_desc&nbsp;__mach_desc_##_type&nbsp;/&nbsp;</span></p> 
   <p><span style="font-size:large;">&nbsp;__used&nbsp;/&nbsp;</span></p> 
   <p><span style="font-size:large;">&nbsp;__attribute__((__section__(".arch.info.init")))&nbsp;=&nbsp;{&nbsp;/&nbsp;</span></p> 
   <p><span style="font-size:large;">.nr&nbsp;=&nbsp;MACH_TYPE_##_type,&nbsp;/&nbsp;</span></p> 
   <p><span style="font-size:large;">.name&nbsp;=&nbsp;_name,&nbsp;</span></p> 
   <p><span style="font-size:large;">#define&nbsp;MACHINE_END&nbsp;/&nbsp;</span></p> 
   <p><span style="font-size:large;">};&nbsp;</span></p> 
   <p><span style="font-size:large;">__attribute__((__section__(".arch.info.init")))表明该结构体在并以后存放的位置。&nbsp;</span></p> 
   <p><span style="font-size:large;">在链接文件&nbsp;链接脚本文件&nbsp;arch/arm/kernel/vmlinux.lds&nbsp;中&nbsp;</span></p> 
   <p><span style="font-size:large;">SECTIONS&nbsp;</span></p> 
   <p><span style="font-size:large;">{&nbsp;</span></p> 
   <p><span style="font-size:large;">#ifdef&nbsp;CONFIG_XIP_KERNEL&nbsp;</span></p> 
   <p><span style="font-size:large;">.&nbsp;=&nbsp;XIP_VIRT_ADDR(CONFIG_XIP_PHYS_ADDR);&nbsp;</span></p> 
   <p><span style="font-size:large;">#else&nbsp;</span></p> 
   <p><span style="font-size:large;">.&nbsp;=&nbsp;PAGE_OFFSET&nbsp;+&nbsp;TEXT_OFFSET;&nbsp;</span></p> 
   <p><span style="font-size:large;">#endif&nbsp;</span></p> 
   <p><span style="font-size:large;">.text.head&nbsp;:&nbsp;{&nbsp;</span></p> 
   <p><span style="font-size:large;">_stext&nbsp;=&nbsp;.;&nbsp;</span></p> 
   <p><span style="font-size:large;">_sinittext&nbsp;=&nbsp;.;&nbsp;</span></p> 
   <p><span style="font-size:large;">*(.text.head)&nbsp;</span></p> 
   <p><span style="font-size:large;">}</span></p> 
   <p><span style="font-size:large;">.init&nbsp;:&nbsp;{&nbsp;/*&nbsp;Init&nbsp;code&nbsp;and&nbsp;data&nbsp;*/&nbsp;</span></p> 
   <p><span style="font-size:large;">INIT_TEXT&nbsp;</span></p> 
   <p><span style="font-size:large;">_einittext&nbsp;=&nbsp;.;&nbsp;</span></p> 
   <p><span style="font-size:large;">__proc_info_begin&nbsp;=&nbsp;.;&nbsp;</span></p> 
   <p><span style="font-size:large;">*(.proc.info.init)&nbsp;</span></p> 
   <p><span style="font-size:large;">__proc_info_end&nbsp;=&nbsp;.;&nbsp;</span></p> 
   <p><span style="font-size:large;">__arch_info_begin&nbsp;=&nbsp;.;&nbsp;</span></p> 
   <p><span style="font-size:large;">*(.arch.info.init)&nbsp;</span></p> 
   <p><span style="font-size:large;">__arch_info_end&nbsp;=&nbsp;.;&nbsp;</span></p> 
   <p><span style="font-size:large;">………………………………&nbsp;</span></p> 
   <p><span style="font-size:large;">｝&nbsp;</span></p> 
   <p><span style="font-size:large;">在__arch_info_begin和&nbsp;__arch_info_end之间存放了linux内核所支持的所有平台对应的&nbsp;machine_desc&nbsp;结构体。&nbsp;</span></p> 
   <p><span style="font-size:large;">/*</span></p> 
   <p><span style="font-size:large;">*&nbsp;&nbsp;r1&nbsp;=&nbsp;machine&nbsp;architecture&nbsp;number</span></p> 
   <p><span style="font-size:large;">&nbsp;*&nbsp;Returns:</span></p> 
   <p><span style="font-size:large;">*&nbsp;&nbsp;r5&nbsp;=&nbsp;mach_info&nbsp;pointer&nbsp;in&nbsp;physical&nbsp;address&nbsp;space</span></p> 
   <p><span style="font-size:large;">&nbsp;*/</span></p> 
   <p><span style="font-size:large;">__lookup_machine_type:</span></p> 
   <p><span style="font-size:large;">adr&nbsp;r3,&nbsp;4b&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;把标号4处的地址放到r3寄存器里面</span></p> 
   <p><span style="font-size:large;">ldmia&nbsp;r3,&nbsp;{r4,&nbsp;r5,&nbsp;r6}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;R&nbsp;4&nbsp;=&nbsp;标号4处的虚拟地址&nbsp;，r&nbsp;5&nbsp;=&nbsp;__arch_info_begin&nbsp;，r&nbsp;6=&nbsp;__arch_info_end</span></p> 
   <p><span style="font-size:large;">sub&nbsp;r3,&nbsp;r3,&nbsp;r4&nbsp;@&nbsp;get&nbsp;offset&nbsp;between&nbsp;virt&amp;phys&nbsp;计算出虚拟地址与物理地址的偏移</span></p> 
   <p><span style="font-size:large;">/*利用offset&nbsp;，将&nbsp;r5&nbsp;和&nbsp;r6&nbsp;中保存的虚拟地址转变为物理地址*/</span></p> 
   <p><span style="font-size:large;">add&nbsp;r5,&nbsp;r5,&nbsp;r3&nbsp;@&nbsp;convert&nbsp;virt&nbsp;addresses&nbsp;to</span></p> 
   <p><span style="font-size:large;">add&nbsp;r6,&nbsp;r6,&nbsp;r3&nbsp;@&nbsp;physical&nbsp;address&nbsp;space</span></p> 
   <p><span style="font-size:large;">/*读取machine_desc结构的&nbsp;nr&nbsp;参数，对于smdk2410&nbsp;来说该值是&nbsp;MACH_TYPE_SMDK2410,这个值在文件linux/arch/arm/tools/mach-types&nbsp;中:</span></p> 
   <p><span style="font-size:large;">smdk2410&nbsp;&nbsp;&nbsp;&nbsp;ARCH_SMDK2410&nbsp;SMDK2410&nbsp;&nbsp;193&nbsp;*/</span></p> 
   <p><span style="font-size:large;">1:&nbsp;ldr&nbsp;r3,&nbsp;[r5,&nbsp;#MACHINFO_TYPE]&nbsp;@&nbsp;get&nbsp;machine&nbsp;type</span></p> 
   <p><span style="font-size:large;">teq&nbsp;r3,&nbsp;r1&nbsp;@&nbsp;matches&nbsp;loader&nbsp;number?把取到的machine&nbsp;id和从uboot中传过来的machine&nbsp;id（存放r1中）相比较</span></p> 
   <p><span style="font-size:large;">beq&nbsp;2f&nbsp;@&nbsp;found&nbsp;如果相等，则跳到标号2处，返回</span></p> 
   <p><span style="font-size:large;">add&nbsp;r5,&nbsp;r5,&nbsp;#SIZEOF_MACHINE_DESC@&nbsp;next&nbsp;machine_desc&nbsp;没有找到，则继续找下一个，加上该结构体的长度</span></p> 
   <p><span style="font-size:large;">cmp&nbsp;r5,&nbsp;r6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;判断是否已经到该段的末尾</span></p> 
   <p><span style="font-size:large;">blo&nbsp;1b&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;如果没有，则跳转到标号1处，继续查找</span></p> 
   <p><span style="font-size:large;">mov&nbsp;r5,&nbsp;#0&nbsp;@&nbsp;unknown&nbsp;machine&nbsp;如果已经到末尾，并且没找到，则返回值r5寄存器赋值为0</span></p> 
   <p><span style="font-size:large;">2:&nbsp;mov&nbsp;pc,&nbsp;lr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;返回原函数，且r5作为返回值</span></p> 
   <p><span style="font-size:large;">ENDPROC(__lookup_machine_type)</span></p> 
   <p><span style="font-size:large;">.align&nbsp;2</span></p> 
   <p><span style="font-size:large;">3:&nbsp;.long&nbsp;__proc_info_begin</span></p> 
   <p><span style="font-size:large;">.long&nbsp;__proc_info_end</span></p> 
   <p><span style="font-size:large;">4:&nbsp;.long&nbsp;.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@“.”表示当前这行代码编译连接后的虚拟地址</span></p> 
   <p><span style="font-size:large;">.long&nbsp;__arch_info_begin</span></p> 
   <p><span style="font-size:large;">.long&nbsp;__arch_info_end</span></p> 
   <p><span style="font-size:large;">/**********************************************************************/&nbsp;</span></p> 
   <p><span style="font-size:large;">__lookup_machine_type函数的具体解析结束（\arch\arm\kernel\&nbsp;head-common.S）</span></p> 
   <p><span style="font-size:large;">/**********************************************************************/&nbsp;</span></p> 
   <p>&nbsp;</p> 
   <p><span style="font-size:large;">movs&nbsp;r8,&nbsp;r5&nbsp;@&nbsp;invalid&nbsp;machine&nbsp;(r5=0)?</span></p> 
   <p><span style="font-size:large;">beq&nbsp;__error_a&nbsp;@&nbsp;yes,&nbsp;error&nbsp;'a'</span></p> 
   <p><span style="font-size:large;">/*检查&nbsp;bootloader传入的参数列表&nbsp;atags&nbsp;的&nbsp;合法性*/</span></p> 
   <p><span style="font-size:large;">bl&nbsp;__vet_atags</span></p> 
   <p><span style="font-size:large;">/**********************************************************************/&nbsp;</span></p> 
   <p><span style="font-size:large;">__vet_atags函数的具体解析开始（\arch\arm\kernel\&nbsp;head-common.S）</span></p> 
   <p><span style="font-size:large;">/**********************************************************************/&nbsp;</span></p> 
   <p><span style="font-size:large;">关于参数链表：&nbsp;</span></p> 
   <p><span style="font-size:large;">内核参数链表的格式和说明可以从内核源代码目录树中的\arch\arm\include\asm\setup.h中找到，参数链表必须以ATAG_CORE开始，以ATAG_NONE结束。这里的&nbsp;ATAG_CORE，ATAG_NONE是各个参数的标记，本身是一个32&nbsp;位值，例如：&nbsp;ATAG_CORE=0x54410001&nbsp;。&nbsp;其它的参数标记还包括：&nbsp;ATAG_MEM32&nbsp;&nbsp;，&nbsp;&nbsp;ATAG_INITRD&nbsp;&nbsp;，&nbsp;&nbsp;ATAG_RAMDISK&nbsp;&nbsp;，&nbsp;ATAG_COMDLINE&nbsp;等。每个参数标记就代表一个参数结构体，由各个参数结构体构成了参数链表。参数结构体的定义如下：&nbsp;&nbsp;&nbsp;</span></p> 
   <p><span style="font-size:large;">struct&nbsp;tag&nbsp;{&nbsp;</span><br><span style="font-size:large;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;&nbsp;tag_header&nbsp;&nbsp;hdr;&nbsp;</span><br><span style="font-size:large;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;union&nbsp;{&nbsp;</span><br><span style="font-size:large;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;tag_core&nbsp;&nbsp;core;&nbsp;</span><br><span style="font-size:large;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;tag_mem32&nbsp;&nbsp;mem;&nbsp;</span><br><span style="font-size:large;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;tag_videotext&nbsp;videotext;&nbsp;</span><br><span style="font-size:large;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;tag_ramdisk&nbsp;&nbsp;&nbsp;ramdisk;&nbsp;</span><br><span style="font-size:large;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;tag_initrd&nbsp;&nbsp;&nbsp;&nbsp;initrd;&nbsp;</span><br><span style="font-size:large;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;tag_serialnr&nbsp;&nbsp;serialnr;&nbsp;</span><br><span style="font-size:large;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;tag_revision&nbsp;&nbsp;revision;&nbsp;</span><br><span style="font-size:large;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;tag_videolfb&nbsp;&nbsp;videolfb;&nbsp;</span><br><span style="font-size:large;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;tag_cmdline&nbsp;&nbsp;&nbsp;cmdline;&nbsp;</span><br><span style="font-size:large;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;tag_acorn&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acorn;&nbsp;</span><br><span style="font-size:large;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;tag_memclk&nbsp;&nbsp;&nbsp;&nbsp;memclk;&nbsp;</span><br><span style="font-size:large;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;u;&nbsp;</span><br><span style="font-size:large;">};&nbsp;</span></p> 
   <p><span style="font-size:large;">参数结构体包括两个部分，一个是&nbsp;tag_header&nbsp;结构体&nbsp;,&nbsp;一个是&nbsp;u&nbsp;联合体。&nbsp;</span></p> 
   <p><span style="font-size:large;">tag_header结构体的定义如下：&nbsp;&nbsp;</span></p> 
   <p><span style="font-size:large;">struct&nbsp;tag_header&nbsp;{&nbsp;&nbsp;</span></p> 
   <p><span style="font-size:large;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u32&nbsp;size;&nbsp;&nbsp;&nbsp;&nbsp;</span></p> 
   <p><span style="font-size:large;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u32&nbsp;tag;&nbsp;&nbsp;</span></p> 
   <p><span style="font-size:large;">};&nbsp;&nbsp;</span></p> 
   <p><span style="font-size:large;">其中&nbsp;size&nbsp;：表示整个&nbsp;&nbsp;tag&nbsp;&nbsp;结构体的大小&nbsp;(&nbsp;用字的个数来表示，而不是字节的个数&nbsp;)&nbsp;，等于tag_header的大小加上&nbsp;&nbsp;u&nbsp;联合体的大小，例如，参数结构体&nbsp;&nbsp;ATAG_CORE&nbsp;&nbsp;的size=(sizeof(tag-&gt;tag_header)+sizeof(tag-&gt;u.core))&gt;&gt;2，一般通过函数&nbsp;&nbsp;tag_size(struct&nbsp;*&nbsp;tag_xxx)&nbsp;来获得每个参数结构体的&nbsp;size&nbsp;。其中&nbsp;&nbsp;tag&nbsp;：表示整个&nbsp;&nbsp;tag&nbsp;&nbsp;结构体的标记，如：&nbsp;ATAG_CORE&nbsp;等。</span></p> 
   <p><span style="font-size:large;">/*&nbsp;r8&nbsp;&nbsp;=&nbsp;machinfo</span></p> 
   <p><span style="font-size:large;">*&nbsp;Returns:</span></p> 
   <p><span style="font-size:large;">&nbsp;*&nbsp;&nbsp;r2&nbsp;either&nbsp;valid&nbsp;atags&nbsp;pointer,&nbsp;or&nbsp;zero</span></p> 
   <p><span style="font-size:large;">*/</span></p> 
   <p><span style="font-size:large;">__vet_atags:</span></p> 
   <p><span style="font-size:large;">tst&nbsp;r2,&nbsp;#0x3&nbsp;@&nbsp;aligned?&nbsp;r2指向该参数链表的起始位置，此处判断它是否字对齐</span></p> 
   <p><span style="font-size:large;">bne&nbsp;1f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;如果没有对齐，跳到标号1处直接返回，并且把r2的值赋值为0，作为返回值</span></p> 
   <p><span style="font-size:large;">ldr&nbsp;r5,&nbsp;[r2,&nbsp;#0]&nbsp;@&nbsp;is&nbsp;first&nbsp;tag&nbsp;ATAG_CORE?&nbsp;获取第一个&nbsp;tag&nbsp;结构的&nbsp;size</span></p> 
   <p><span style="font-size:large;">cmp&nbsp;r5,&nbsp;#ATAG_CORE_SIZE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;判断该&nbsp;tag&nbsp;的长度是否合法</span></p> 
   <p><span style="font-size:large;">cmpne&nbsp;r5,&nbsp;#ATAG_CORE_SIZE_EMPTY&nbsp;&nbsp;&nbsp;</span></p> 
   <p><span style="font-size:large;">bne&nbsp;1f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;如果不合法，异常返回</span></p> 
   <p><span style="font-size:large;">ldr&nbsp;r5,&nbsp;[r2,&nbsp;#4]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;获取第一个&nbsp;tag&nbsp;结构体的标记</span></p> 
   <p><span style="font-size:large;">ldr&nbsp;r6,&nbsp;=ATAG_CORE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;取出标记ATAG_CORE的内容</span></p> 
   <p><span style="font-size:large;">cmp&nbsp;r5,&nbsp;r6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;判断该标记是否等于ATAG_CORE</span></p> 
   <p><span style="font-size:large;">bne&nbsp;1f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;如果不等，异常返回</span></p> 
   <p><span style="font-size:large;">mov&nbsp;pc,&nbsp;lr&nbsp;@&nbsp;atag&nbsp;pointer&nbsp;is&nbsp;ok，如果都相等，则正常返回</span></p> 
   <p><span style="font-size:large;">1:&nbsp;mov&nbsp;r2,&nbsp;#0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;异常返回值</span></p> 
   <p><span style="font-size:large;">mov&nbsp;pc,&nbsp;lr&nbsp;@&nbsp;异常返回</span></p> 
   <p><span style="font-size:large;">ENDPROC(__vet_atags)</span></p> 
   <p><span style="font-size:large;">/**********************************************************************/&nbsp;</span></p> 
   <p><span style="font-size:large;">__vet_atags函数的具体解析结束（\arch\arm\kernel\&nbsp;head-common.S）</span></p> 
   <p><span style="font-size:large;">/**********************************************************************/&nbsp;</span></p> 
   <p>&nbsp;</p> 
   <p><span style="font-size:large;">/*创建内核初始化页表*/</span></p> 
   <p><span style="font-size:large;">bl&nbsp;__create_page_tables</span></p> 
   <p><span style="font-size:large;">/**********************************************************************/&nbsp;</span></p> 
   <p><span style="font-size:large;">__create_page_tables函数的具体解析开始（\arch\arm\kernel\&nbsp;head.S）</span></p> 
   <p><span style="font-size:large;">/**********************************************************************/&nbsp;</span></p> 
   <p>&nbsp;</p> 
   <p><span style="font-size:large;">/*</span></p> 
   <p><span style="font-size:large;">*&nbsp;r8&nbsp;&nbsp;=&nbsp;machinfo</span></p> 
   <p><span style="font-size:large;">&nbsp;*&nbsp;r9&nbsp;&nbsp;=&nbsp;cpuid</span></p> 
   <p><span style="font-size:large;">&nbsp;*&nbsp;r10&nbsp;=&nbsp;procinfo</span></p> 
   <p><span style="font-size:large;">*&nbsp;Returns:</span></p> 
   <p><span style="font-size:large;">*&nbsp;&nbsp;r4&nbsp;=&nbsp;physical&nbsp;page&nbsp;table&nbsp;address</span></p> 
   <p><span style="font-size:large;">&nbsp;*/</span></p> 
   <p><span style="font-size:large;">/*在该文件的开头有如下宏定义*/</span></p> 
   <p><span style="font-size:large;">#define&nbsp;KERNEL_RAM_PADDR&nbsp;(PHYS_OFFSET&nbsp;+&nbsp;TEXT_OFFSET)</span></p> 
   <p><span style="font-size:large;">.macro&nbsp;pgtbl,&nbsp;rd</span></p> 
   <p><span style="font-size:large;">ldr\rd,&nbsp;=(KERNEL_RAM_PADDR&nbsp;-&nbsp;0x4000)</span></p> 
   <p><span style="font-size:large;">.endm</span></p> 
   <p><span style="font-size:large;">其中：PHYS_OFFSET在arch/arm/mach-s3c2410/include/mach/memory.h定义，为UL(0x30000000)，而TEXT_OFFSET在arch/arm/Makefile中定义，为内核镜像在内存中到内存开始位置的偏移（字节），为$(textofs-y)&nbsp;textofs-y也在文件arch/arm/Makefile中定义，为textofs-y&nbsp;&nbsp;&nbsp;:=&nbsp;0x00008000，r4&nbsp;=&nbsp;30004000为临时页表的起始地址，首先即是初始化16K的页表，高12位虚拟地址为页表索引，每个页表索引占4个字节，所以为4K*4&nbsp;=&nbsp;16K，大页表，每一个页表项，映射1MB虚拟地址.</span></p> 
   <p><span style="font-size:large;">__create_page_tables:</span></p> 
   <p><span style="font-size:large;">/*为内核代码存储区域创建页表，首先将内核起始地址-0x4000到内核起始地址之间的16K存储器清0&nbsp;，将创建的页表存于此处*/&nbsp;</span></p> 
   <p><span style="font-size:large;">pgtbl&nbsp;r4&nbsp;@&nbsp;r4中存放的为页表的基地址，最终该地址会写入cp15的寄存器c2，这个值必须是&nbsp;16K&nbsp;对齐的</span></p> 
   <p><span style="font-size:large;">mov&nbsp;r0,&nbsp;r4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;把页表的基地址存放到r0中</span></p> 
   <p><span style="font-size:large;">mov&nbsp;r3,&nbsp;#0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;把r3清0</span></p> 
   <p><span style="font-size:large;">add&nbsp;r6,&nbsp;r0,&nbsp;#0x4000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;r6指向16K的末尾</span></p> 
   <p><span style="font-size:large;">1:&nbsp;str&nbsp;r3,&nbsp;[r0],&nbsp;#4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;把16K的页表空间清0</span></p> 
   <p><span style="font-size:large;">str&nbsp;r3,&nbsp;[r0],&nbsp;#4</span></p> 
   <p><span style="font-size:large;">str&nbsp;r3,&nbsp;[r0],&nbsp;#4</span></p> 
   <p><span style="font-size:large;">str&nbsp;r3,&nbsp;[r0],&nbsp;#4</span></p> 
   <p><span style="font-size:large;">teq&nbsp;r0,&nbsp;r6</span></p> 
   <p><span style="font-size:large;">bne&nbsp;1b</span></p> 
   <p><span style="font-size:large;">/*从proc_info_list结构中获取字段&nbsp;__cpu_mm_mmu_flags&nbsp;，该字段包含了存储空间访问权限等,&nbsp;此处指令执行之后r7=0x00000c1e*/</span></p> 
   <p><span style="font-size:large;">ldr&nbsp;r7,&nbsp;[r10,&nbsp;#PROCINFO_MM_MMUFLAGS]&nbsp;@&nbsp;mm_mmuflags</span></p> 
   <p><span style="font-size:large;">/*为内核的第一MB创建一致的映射，以为打开MMU做准备，这个映射将会被paging_init()移除，这里使用程序计数器来获得相应的段的基地址*/</span></p> 
   <p><span style="font-size:large;">mov&nbsp;r6,&nbsp;pc</span></p> 
   <p><span style="font-size:large;">mov&nbsp;r6,&nbsp;r6,&nbsp;lsr&nbsp;#20&nbsp;@&nbsp;start&nbsp;of&nbsp;kernel&nbsp;section</span></p> 
   <p><span style="font-size:large;">orr&nbsp;r3,&nbsp;r7,&nbsp;r6,&nbsp;lsl&nbsp;#20&nbsp;@&nbsp;flags&nbsp;+&nbsp;kernel&nbsp;base</span></p> 
   <p><span style="font-size:large;">str&nbsp;r3,&nbsp;[r4,&nbsp;r6,&nbsp;lsl&nbsp;#2]&nbsp;@&nbsp;identity&nbsp;mapping</span></p> 
   <p>&nbsp;</p> 
   <p><span style="font-size:large;">/*&nbsp;MMU是通过&nbsp;C2&nbsp;中基地址（高&nbsp;18&nbsp;位）与虚拟地址的高&nbsp;12&nbsp;位组合成物理地址，在转换表中查找地址条目。&nbsp;R4&nbsp;中存放的就是这个基地址&nbsp;0x30004000*/&nbsp;</span></p> 
   <p><span style="font-size:large;">add&nbsp;r0,&nbsp;r4,&nbsp;&nbsp;#(KERNEL_START&nbsp;&amp;&nbsp;0xff000000)&nbsp;&gt;&gt;&nbsp;18&nbsp;&nbsp;&nbsp;@&nbsp;r0&nbsp;=&nbsp;0x30007000&nbsp;r0<span style="font-family:'宋体';">存放的是转换表的起始位置</span></span></p> 
   <p><span style="font-size:large;">str&nbsp;r3,&nbsp;[r0,&nbsp;#(KERNEL_START&nbsp;&amp;&nbsp;0x00f00000)&nbsp;&gt;&gt;&nbsp;18]!&nbsp;@&nbsp;r3存放的是内核镜像代码段的起始地址</span></p> 
   <p><span style="font-size:large;">ldr&nbsp;r6,&nbsp;=(KERNEL_END&nbsp;-&nbsp;1)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;获取内核的尾部虚拟地址存于r6中</span></p> 
   <p><span style="font-size:large;">add&nbsp;r0,&nbsp;r0,&nbsp;#4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;第一个地址条目存放在&nbsp;0x30007004&nbsp;处，以后依次递增</span></p> 
   <p><span style="font-size:large;">add&nbsp;r6,&nbsp;r4,&nbsp;r6,&nbsp;lsr&nbsp;#18&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;计算最后一个地址条目存放的位置</span></p> 
   <p><span style="font-size:large;">1:&nbsp;cmp&nbsp;r0,&nbsp;r6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;填充这之间的地址条目</span></p> 
   <p><span style="font-size:large;">/*每一个地址条目代表了&nbsp;1MB&nbsp;空间的地址映射。物理地址将从0x30100000开始映射。0X30000000&nbsp;开始的&nbsp;1MB&nbsp;空间将在下面映射*/</span></p> 
   <p><span style="font-size:large;">add&nbsp;r3,&nbsp;r3,&nbsp;#1&nbsp;&lt;&lt;&nbsp;20&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p> 
   <p><span style="font-size:large;">strls&nbsp;r3,&nbsp;[r0],&nbsp;#4</span></p> 
   <p><span style="font-size:large;">bls&nbsp;1b</span></p> 
   <p><span style="font-size:large;">…………………………………</span></p> 
   <p><span style="font-size:large;">…………………………………………</span></p> 
   <p><span style="font-size:large;">/*为了使用启动参数，将物理内存的第一MB映射到内核虚拟地址空间的第一个MB，r4存放的是页表的地址。映射0X30000000开始的&nbsp;1MB&nbsp;空间PAGE_OFFSET&nbsp;=&nbsp;0XC0000000,PHYS_OFFSET&nbsp;=&nbsp;0X30000000,&nbsp;r0&nbsp;=&nbsp;&nbsp;0x30007000,&nbsp;上面是从&nbsp;0x30007004开始存放地址条目的*/</span></p> 
   <p><span style="font-size:large;">add&nbsp;r0,&nbsp;r4,&nbsp;#PAGE_OFFSET&nbsp;&gt;&gt;&nbsp;18</span></p> 
   <p><span style="font-size:large;">orr&nbsp;r6,&nbsp;r7,&nbsp;#(PHYS_OFFSET&nbsp;&amp;&nbsp;0xff000000)&nbsp;&nbsp;@&nbsp;r6=&nbsp;0x30000c1e</span></p> 
   <p><span style="font-size:large;">.if&nbsp;(PHYS_OFFSET&nbsp;&amp;&nbsp;0x00f00000)</span></p> 
   <p><span style="font-size:large;">orr&nbsp;r6,&nbsp;r6,&nbsp;#(PHYS_OFFSET&nbsp;&amp;&nbsp;0x00f00000)</span></p> 
   <p><span style="font-size:large;">.endif</span></p> 
   <p><span style="font-size:large;">str&nbsp;r6,&nbsp;[r0]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;将0x30000c1e&nbsp;存于0x30007000处。</span></p> 
   <p><span style="font-size:large;">………………………</span></p> 
   <p><span style="font-size:large;">………………………………</span></p> 
   <p><span style="font-size:large;">mov&nbsp;pc,&nbsp;lr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@子程序返回</span></p> 
   <p><span style="font-size:large;">ENDPROC(__create_page_tables)</span></p> 
   <p><span style="font-size:large;">/**********************************************************************/&nbsp;</span></p> 
   <p><span style="font-size:large;">__create_page_tables函数的具体解析结束（\arch\arm\kernel\&nbsp;head.S）</span></p> 
   <p><span style="font-size:large;">/**********************************************************************/&nbsp;</span></p> 
   <p>&nbsp;</p> 
   <p><span style="font-size:large;">/*把__switch_data标号处的地址放入r13寄存器，当执行完__enable_mmu函数时会把r13寄存器的值赋值给pc，跳转到__switch_data&nbsp;处执行*/</span></p> 
   <p><span style="font-size:large;">ldr&nbsp;r13,&nbsp;__switch_data&nbsp;@&nbsp;address&nbsp;to&nbsp;jump&nbsp;to&nbsp;after&nbsp;mmu&nbsp;has&nbsp;been&nbsp;enabled</span></p> 
   <p><span style="font-size:large;">/*把__enable_mmu函数的地址值，赋值给lr寄存器，当执行完__arm920_setup时，返回后执行__enable_mmu&nbsp;*/</span></p> 
   <p><span style="font-size:large;">adr&nbsp;lr,&nbsp;BSYM(__enable_mmu)&nbsp;@&nbsp;return&nbsp;(PIC)&nbsp;address</span></p> 
   <p><span style="font-size:large;">/**********************************************************************/&nbsp;</span></p> 
   <p><span style="font-size:large;">__enable_mmu函数的具体解析开始（\arch\arm\kernel\&nbsp;head.S）</span></p> 
   <p><span style="font-size:large;">/**********************************************************************/&nbsp;</span></p> 
   <p>&nbsp;</p> 
   <p><span style="font-size:large;">__enable_mmu:&nbsp;</span></p> 
   <p><span style="font-size:large;">#ifdef&nbsp;CONFIG_ALIGNMENT_TRAP&nbsp;</span></p> 
   <p><span style="font-size:large;">orr&nbsp;r0,&nbsp;r0,&nbsp;#CR_A&nbsp;&nbsp;&nbsp;//使能地址对齐错误检测&nbsp;</span></p> 
   <p><span style="font-size:large;">#else&nbsp;</span></p> 
   <p><span style="font-size:large;">bic&nbsp;r0,&nbsp;r0,&nbsp;#CR_A&nbsp;</span></p> 
   <p><span style="font-size:large;">#endif&nbsp;</span></p> 
   <p><span style="font-size:large;">#ifdef&nbsp;CONFIG_CPU_DCACHE_DISABLE&nbsp;</span></p> 
   <p><span style="font-size:large;">bic&nbsp;r0,&nbsp;r0,&nbsp;#CR_C&nbsp;&nbsp;&nbsp;//禁止数据&nbsp;cache&nbsp;</span></p> 
   <p><span style="font-size:large;">#endif&nbsp;</span></p> 
   <p><span style="font-size:large;">#ifdef&nbsp;CONFIG_CPU_BPREDICT_DISABLE&nbsp;</span></p> 
   <p><span style="font-size:large;">bic&nbsp;r0,&nbsp;r0,&nbsp;#CR_Z&nbsp;</span></p> 
   <p><span style="font-size:large;">#endif&nbsp;</span></p> 
   <p><span style="font-size:large;">#ifdef&nbsp;CONFIG_CPU_ICACHE_DISABLE&nbsp;</span></p> 
   <p><span style="font-size:large;">bic&nbsp;r0,&nbsp;r0,&nbsp;#CR_I&nbsp;&nbsp;//禁止指令&nbsp;cache&nbsp;</span></p> 
   <p><span style="font-size:large;">#endif&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//配置相应的访问权限并存入&nbsp;r5&nbsp;中&nbsp;</span></p> 
   <p><span style="font-size:large;">mov&nbsp;r5,&nbsp;#(domain_val(DOMAIN_USER,&nbsp;DOMAIN_MANAGER)&nbsp;|&nbsp;/&nbsp;</span></p> 
   <p><span style="font-size:large;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;domain_val(DOMAIN_KERNEL,&nbsp;DOMAIN_MANAGER)&nbsp;|&nbsp;/&nbsp;</span></p> 
   <p><span style="font-size:large;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;domain_val(DOMAIN_TABLE,&nbsp;DOMAIN_MANAGER)&nbsp;|&nbsp;/&nbsp;</span></p> 
   <p><span style="font-size:large;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;domain_val(DOMAIN_IO,&nbsp;DOMAIN_CLIENT))&nbsp;</span></p> 
   <p><span style="font-size:large;">mcr&nbsp;p15,&nbsp;0,&nbsp;r5,&nbsp;c3,&nbsp;c0,&nbsp;0&nbsp;//将访问权限写入协处理器&nbsp;</span></p> 
   <p><span style="font-size:large;">mcr&nbsp;p15,&nbsp;0,&nbsp;r4,&nbsp;c2,&nbsp;c0,&nbsp;0&nbsp;//将页表基地址写入基址寄存器&nbsp;C2&nbsp;，&nbsp;0X30004000&nbsp;</span></p> 
   <p><span style="font-size:large;">b&nbsp;__turn_mmu_on&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//跳转到程序段去打开&nbsp;MMU&nbsp;</span></p> 
   <p><span style="font-size:large;">ENDPROC(__enable_mmu)&nbsp;</span></p> 
   <p><span style="font-size:large;">文件linux/arch/arm/kernel/head.S&nbsp;中&nbsp;</span></p> 
   <p><span style="font-size:large;">__turn_mmu_on:&nbsp;</span></p> 
   <p><span style="font-size:large;">mov&nbsp;r0,&nbsp;r0&nbsp;</span></p> 
   <p><span style="font-size:large;">mcr&nbsp;p15,&nbsp;0,&nbsp;r0,&nbsp;c1,&nbsp;c0,&nbsp;0&nbsp;//打开&nbsp;MMU&nbsp;同时打开&nbsp;cache&nbsp;等。&nbsp;</span></p> 
   <p><span style="font-size:large;">mrc&nbsp;p15,&nbsp;0,&nbsp;r3,&nbsp;c0,&nbsp;c0,&nbsp;0&nbsp;@&nbsp;read&nbsp;id&nbsp;reg&nbsp;读取&nbsp;id&nbsp;寄存器&nbsp;</span></p> 
   <p><span style="font-size:large;">mov&nbsp;r3,&nbsp;r3&nbsp;</span></p> 
   <p><span style="font-size:large;">mov&nbsp;r3,&nbsp;r3&nbsp;&nbsp;&nbsp;&nbsp;//两个空操作，等待前面所取的指令得以执行。&nbsp;</span></p> 
   <p><span style="font-size:large;">mov&nbsp;pc,&nbsp;r13&nbsp;&nbsp;//程序跳转&nbsp;</span></p> 
   <p><span style="font-size:large;">ENDPROC(__turn_mmu_on)&nbsp;</span></p> 
   <p><span style="font-size:large;">/**********************************************************************/&nbsp;</span></p> 
   <p><span style="font-size:large;">__enable_mmu函数的具体解析结束（\arch\arm\kernel\&nbsp;head.S）</span></p> 
   <p><span style="font-size:large;">/**********************************************************************/&nbsp;</span></p> 
   <p>&nbsp;</p> 
   <p><span style="font-size:large;">/*执行__arm920_setup函数(\arch\arm\mm\&nbsp;proc-arm920.S),该函数完成对数据cache，指令cache，write&nbsp;buffer等初始化操作*/</span></p> 
   <p><span style="font-size:large;">&nbsp;&nbsp;ARM(&nbsp;add&nbsp;pc,&nbsp;r10,&nbsp;#PROCINFO_INITFUNC&nbsp;)</span></p> 
   <p><span style="font-size:large;">/**********************************************************************/&nbsp;</span></p> 
   <p><span style="font-size:large;">__arm920_setup函数的具体解析开始（\arch\arm\mm\&nbsp;proc-arm920.S）</span></p> 
   <p><span style="font-size:large;">/**********************************************************************/&nbsp;</span></p> 
   <p>&nbsp;</p> 
   <p><span style="font-size:large;">在上面程序段.section&nbsp;".text.head",&nbsp;"ax"&nbsp;的最后有这样几行：&nbsp;</span></p> 
   <p><span style="font-size:large;">add&nbsp;pc,&nbsp;r10,&nbsp;#PROCINFO_INITFUNC&nbsp;</span></p> 
   <p><span style="font-size:large;">R10中存放的是在函数&nbsp;__lookup_processor_type&nbsp;中成功匹配的结构体&nbsp;proc_info_list。对于arm920&nbsp;来说在文件&nbsp;linux/arch/arm/mm/proc-arm920.S&nbsp;中有：&nbsp;</span></p> 
   <p><span style="font-size:large;">.section&nbsp;".proc.info.init",&nbsp;#alloc,&nbsp;#execinstr&nbsp;</span></p> 
   <p><span style="font-size:large;">.type&nbsp;&nbsp;__arm920_proc_info,#object&nbsp;</span></p> 
   <p><span style="font-size:large;">__arm920_proc_info:&nbsp;</span></p> 
   <p><span style="font-size:large;">.long&nbsp;0x41009200&nbsp;</span></p> 
   <p><span style="font-size:large;">.long&nbsp;0xff00fff0&nbsp;</span></p> 
   <p><span style="font-size:large;">.long&nbsp;&nbsp;&nbsp;PMD_TYPE_SECT&nbsp;|&nbsp;/&nbsp;</span></p> 
   <p><span style="font-size:large;">PMD_SECT_BUFFERABLE&nbsp;|&nbsp;/&nbsp;</span></p> 
   <p><span style="font-size:large;">PMD_SECT_CACHEABLE&nbsp;|&nbsp;/&nbsp;</span></p> 
   <p><span style="font-size:large;">PMD_BIT4&nbsp;|&nbsp;/&nbsp;</span></p> 
   <p><span style="font-size:large;">PMD_SECT_AP_WRITE&nbsp;|&nbsp;/&nbsp;</span></p> 
   <p><span style="font-size:large;">PMD_SECT_AP_READ&nbsp;</span></p> 
   <p><span style="font-size:large;">.long&nbsp;&nbsp;&nbsp;PMD_TYPE_SECT&nbsp;|&nbsp;/&nbsp;</span></p> 
   <p><span style="font-size:large;">PMD_BIT4&nbsp;|&nbsp;/&nbsp;</span></p> 
   <p><span style="font-size:large;">PMD_SECT_AP_WRITE&nbsp;|&nbsp;/&nbsp;</span></p> 
   <p><span style="font-size:large;">PMD_SECT_AP_READ&nbsp;</span></p> 
   <p><span style="font-size:large;">b&nbsp;__arm920_setup&nbsp;</span></p> 
   <p><span style="font-size:large;">………………………………&nbsp;</span></p> 
   <p><span style="font-size:large;">add&nbsp;pc,&nbsp;r10,&nbsp;#PROCINFO_INITFUNC的意思跳到函数&nbsp;__arm920_setup去执行。&nbsp;</span></p> 
   <p><span style="font-size:large;">.type&nbsp;__arm920_setup,&nbsp;#function&nbsp;&nbsp;//表明这是一个函数&nbsp;</span></p> 
   <p><span style="font-size:large;">__arm920_setup:&nbsp;</span></p> 
   <p><span style="font-size:large;">mov&nbsp;r0,&nbsp;#0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//设置&nbsp;r0&nbsp;为&nbsp;0&nbsp;。&nbsp;</span></p> 
   <p><span style="font-size:large;">mcr&nbsp;p15,&nbsp;0,&nbsp;r0,&nbsp;c7,&nbsp;c7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//使数据&nbsp;cahche,&nbsp;&nbsp;指令&nbsp;cache&nbsp;无效。&nbsp;</span></p> 
   <p><span style="font-size:large;">mcr&nbsp;p15,&nbsp;0,&nbsp;r0,&nbsp;c7,&nbsp;c10,&nbsp;4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//使&nbsp;write&nbsp;buffer&nbsp;无效。&nbsp;</span></p> 
   <p><span style="font-size:large;">#ifdef&nbsp;CONFIG_MMU&nbsp;</span></p> 
   <p><span style="font-size:large;">mcr&nbsp;p15,&nbsp;0,&nbsp;r0,&nbsp;c8,&nbsp;c7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//使数据&nbsp;TLB,&nbsp;指令&nbsp;TLB&nbsp;无效。&nbsp;</span></p> 
   <p><span style="font-size:large;">#endif&nbsp;</span></p> 
   <p><span style="font-size:large;">adr&nbsp;r5,&nbsp;arm920_crval&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//获取&nbsp;arm920_crval&nbsp;的地址，并存入&nbsp;r5&nbsp;。&nbsp;</span></p> 
   <p><span style="font-size:large;">ldmia&nbsp;r5,&nbsp;{r5,&nbsp;r6}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//获取&nbsp;arm920_crval&nbsp;地址处的连续&nbsp;8&nbsp;字节分别存入&nbsp;r5,r6&nbsp;。&nbsp;</span></p> 
   <p><span style="font-size:large;">mrc&nbsp;p15,&nbsp;0,&nbsp;r0,&nbsp;c1,&nbsp;c0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//获取&nbsp;CP15&nbsp;下控制寄存器的值，并存入&nbsp;r0&nbsp;。&nbsp;</span></p> 
   <p><span style="font-size:large;">bic&nbsp;r0,&nbsp;r0,&nbsp;r5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//通过查看&nbsp;arm920_crval&nbsp;的值可知该行是清除&nbsp;r0&nbsp;中相关位，为以后对这些位的赋值做准备&nbsp;</span></p> 
   <p><span style="font-size:large;">orr&nbsp;r0,&nbsp;r0,&nbsp;r6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//设置&nbsp;r0&nbsp;中的相关位，即为&nbsp;mmu&nbsp;做相应设置。&nbsp;</span></p> 
   <p><span style="font-size:large;">mov&nbsp;pc,&nbsp;lr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//上面有操作&nbsp;adr&nbsp;lr,&nbsp;__enable_mmu&nbsp;，此处将跳到程序段&nbsp;__enable_mmu&nbsp;处。&nbsp;</span></p> 
   <p><span style="font-size:large;">.size&nbsp;__arm920_setup,&nbsp;.&nbsp;-&nbsp;__arm920_setup&nbsp;</span></p> 
   <p><span style="font-size:large;">.type&nbsp;arm920_crval,&nbsp;#object&nbsp;</span></p> 
   <p><span style="font-size:large;">arm920_crval:&nbsp;</span></p> 
   <p><span style="font-size:large;">crval&nbsp;clear=0x00003f3f,&nbsp;mmuset=0x00003135,&nbsp;ucset=0x00001130&nbsp;</span></p> 
   <p><span style="font-size:large;">/**********************************************************************/&nbsp;</span></p> 
   <p><span style="font-size:large;">__arm920_setup函数的具体解析结束（\arch\arm\mm\&nbsp;proc-arm920.S）</span></p> 
   <p><span style="font-size:large;">/**********************************************************************/&nbsp;</span></p> 
   <p>&nbsp;</p> 
   <p><span style="font-size:large;">ENDPROC(stext)</span></p> 
   <p><span style="font-size:large;">接着往下分析linux/arch/arm/kernel/head-common.S中：</span></p> 
   <p><span style="font-size:large;">.type&nbsp;__switch_data,&nbsp;%object&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@定义__switch_data为一个对象</span></p> 
   <p><span style="font-size:large;">__switch_data:</span></p> 
   <p><span style="font-size:large;">.long&nbsp;__mmap_switched</span></p> 
   <p><span style="font-size:large;">.long&nbsp;__data_loc&nbsp;@&nbsp;r4</span></p> 
   <p><span style="font-size:large;">.long&nbsp;_data&nbsp;@&nbsp;r5</span></p> 
   <p><span style="font-size:large;">.long&nbsp;__bss_start&nbsp;@&nbsp;r6</span></p> 
   <p><span style="font-size:large;">.long&nbsp;_end&nbsp;@&nbsp;r7</span></p> 
   <p><span style="font-size:large;">.long&nbsp;processor_id&nbsp;@&nbsp;r4</span></p> 
   <p><span style="font-size:large;">.long&nbsp;__machine_arch_type&nbsp;@&nbsp;r5</span></p> 
   <p><span style="font-size:large;">.long&nbsp;__atags_pointer&nbsp;@&nbsp;r6</span></p> 
   <p><span style="font-size:large;">.long&nbsp;cr_alignment&nbsp;@&nbsp;r7</span></p> 
   <p><span style="font-size:large;">.long&nbsp;init_thread_union&nbsp;+&nbsp;THREAD_START_SP&nbsp;@&nbsp;sp</span></p> 
   <p><span style="font-size:large;">/*</span></p> 
   <p><span style="font-size:large;">&nbsp;*&nbsp;The&nbsp;following&nbsp;fragment&nbsp;of&nbsp;code&nbsp;is&nbsp;executed&nbsp;with&nbsp;the&nbsp;MMU&nbsp;on&nbsp;in&nbsp;MMU&nbsp;mode,</span></p> 
   <p><span style="font-size:large;">&nbsp;*&nbsp;and&nbsp;uses&nbsp;absolute&nbsp;addresses;&nbsp;this&nbsp;is&nbsp;not&nbsp;position&nbsp;independent.</span></p> 
   <p><span style="font-size:large;">*&nbsp;&nbsp;r0&nbsp;&nbsp;=&nbsp;cp#15&nbsp;control&nbsp;register</span></p> 
   <p><span style="font-size:large;">&nbsp;*&nbsp;&nbsp;r1&nbsp;&nbsp;=&nbsp;machine&nbsp;ID</span></p> 
   <p><span style="font-size:large;">&nbsp;*&nbsp;&nbsp;r2&nbsp;&nbsp;=&nbsp;atags&nbsp;pointer</span></p> 
   <p><span style="font-size:large;">&nbsp;*&nbsp;&nbsp;r9&nbsp;&nbsp;=&nbsp;processor&nbsp;ID</span></p> 
   <p><span style="font-size:large;">&nbsp;*/</span></p> 
   <p><span style="font-size:large;">&nbsp;/*其中上面的几个段的定义是在文件arch/arm/kernel/vmlinux.lds&nbsp;中指定*/</span></p> 
   <p><span style="font-size:large;">**********************************&nbsp;vmlinux.lds开始*******************************************</span></p> 
   <p><span style="font-size:large;">&nbsp;SECTIONS&nbsp;</span></p> 
   <p><span style="font-size:large;">&nbsp;{&nbsp;</span></p> 
   <p><span style="font-size:large;">&nbsp;……………………&nbsp;</span></p> 
   <p><span style="font-size:large;">&nbsp;#ifdef&nbsp;CONFIG_XIP_KERNEL&nbsp;</span></p> 
   <p><span style="font-size:large;">&nbsp;__data_loc&nbsp;=&nbsp;ALIGN(4);&nbsp;/*&nbsp;location&nbsp;in&nbsp;binary&nbsp;*/&nbsp;</span></p> 
   <p><span style="font-size:large;">&nbsp;.&nbsp;=&nbsp;PAGE_OFFSET&nbsp;+&nbsp;TEXT_OFFSET;&nbsp;</span></p> 
   <p><span style="font-size:large;">&nbsp;#else&nbsp;</span></p> 
   <p><span style="font-size:large;">&nbsp;.&nbsp;=&nbsp;ALIGN(THREAD_SIZE);&nbsp;</span></p> 
   <p><span style="font-size:large;">&nbsp;&nbsp;__data_loc&nbsp;=&nbsp;.;&nbsp;</span></p> 
   <p><span style="font-size:large;">&nbsp;#endif&nbsp;</span></p> 
   <p><span style="font-size:large;">&nbsp;.data&nbsp;:&nbsp;AT(__data_loc)&nbsp;{&nbsp;&nbsp;//此处数据存储在上面__data_loc处。&nbsp;</span></p> 
   <p><span style="font-size:large;">&nbsp;&nbsp;_data&nbsp;=&nbsp;.;&nbsp;/*&nbsp;address&nbsp;in&nbsp;memory&nbsp;*/&nbsp;&nbsp;</span></p> 
   <p><span style="font-size:large;">&nbsp;&nbsp;*(.data.init_task)&nbsp;</span></p> 
   <p><span style="font-size:large;">…………………………&nbsp;</span></p> 
   <p><span style="font-size:large;">.bss&nbsp;:&nbsp;{&nbsp;</span></p> 
   <p><span style="font-size:large;">__bss_start&nbsp;=&nbsp;.;&nbsp;/*&nbsp;BSS&nbsp;*/&nbsp;</span></p> 
   <p><span style="font-size:large;">*(.bss)&nbsp;</span></p> 
   <p><span style="font-size:large;">*(COMMON)&nbsp;</span></p> 
   <p><span style="font-size:large;">_end&nbsp;=&nbsp;.;&nbsp;</span></p> 
   <p><span style="font-size:large;">}&nbsp;</span></p> 
   <p><span style="font-size:large;">………………………………&nbsp;</span></p> 
   <p><span style="font-size:large;">｝&nbsp;</span></p> 
   <p><span style="font-size:large;">init_thread_union&nbsp;是&nbsp;init进程的基地址.在&nbsp;arch/arm/kernel/init_task.c&nbsp;中:&nbsp;</span></p> 
   <p><span style="font-size:large;">union&nbsp;thread_union&nbsp;init_thread_union&nbsp;__attribute__((__section__(".init.task")))&nbsp;=&nbsp;{&nbsp;INIT_THREAD_INFO(init_task)&nbsp;};&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p> 
   <p><span style="font-size:large;">对照&nbsp;vmlnux.lds.S&nbsp;中,我们可以知道init&nbsp;task是存放在&nbsp;.data&nbsp;段的开始8k,&nbsp;并且是THREAD_SIZE(8k)对齐的&nbsp;*/&nbsp;</span></p> 
   <p><span style="font-size:large;">**********************************&nbsp;vmlinux.lds结束*******************************************</span></p> 
   <p><span style="font-size:large;">__mmap_switched:</span></p> 
   <p><span style="font-size:large;">adr&nbsp;r3,&nbsp;__switch_data&nbsp;+&nbsp;4</span></p> 
   <p><span style="font-size:large;">ldmia&nbsp;r3!,&nbsp;{r4,&nbsp;r5,&nbsp;r6,&nbsp;r7}</span></p> 
   <p><span style="font-size:large;">……………………</span></p> 
   <p><span style="font-size:large;">………………………………</span></p> 
   <p><span style="font-size:large;">mov&nbsp;fp,&nbsp;#0&nbsp;@&nbsp;清除bss段</span></p> 
   <p><span style="font-size:large;">1:&nbsp;cmp&nbsp;r6,&nbsp;r7</span></p> 
   <p><span style="font-size:large;">strcc&nbsp;fp,&nbsp;[r6],#4</span></p> 
   <p><span style="font-size:large;">bcc&nbsp;1b</span></p> 
   <p><span style="font-size:large;">&nbsp;ARM(&nbsp;ldmia&nbsp;r3,&nbsp;{r4,&nbsp;r5,&nbsp;r6,&nbsp;r7,&nbsp;sp})&nbsp;&nbsp;/*把__machine_arch_type变量值放入r5中，把__atags_pointer变量的值放入r6中*/</span></p> 
   <p><span style="font-size:large;">str&nbsp;r9,&nbsp;[r4]&nbsp;@&nbsp;Save&nbsp;processor&nbsp;ID&nbsp;保存处理器id到processor_id所在的地址中</span></p> 
   <p><span style="font-size:large;">str&nbsp;r1,&nbsp;[r5]&nbsp;@&nbsp;Save&nbsp;machine&nbsp;type&nbsp;保存machine&nbsp;&nbsp;id到__machine_arch_type中</span></p> 
   <p><span style="font-size:large;">str&nbsp;r2,&nbsp;[r6]&nbsp;@&nbsp;Save&nbsp;atags&nbsp;pointer&nbsp;保存参数列表首地址到__atags_pointer中</span></p> 
   <p><span style="font-size:large;">bic&nbsp;r4,&nbsp;r0,&nbsp;#CR_A&nbsp;@&nbsp;Clear&nbsp;'A'&nbsp;bit</span></p> 
   <p><span style="font-size:large;">stmia&nbsp;r7,&nbsp;{r0,&nbsp;r4}&nbsp;@&nbsp;Save&nbsp;control&nbsp;register&nbsp;values</span></p> 
   <p><span style="font-size:large;">b&nbsp;start_kernel&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@程序跳转到函数&nbsp;start_kernel&nbsp;进入&nbsp;C&nbsp;语言部分。</span></p> 
   <p><span style="font-size:large;">ENDPROC(__mmap_switched)</span></p> 
   <p><span style="font-size:large;">到处我们的启动的第二阶段分析完毕。</span></p> 
   <p>后面会接着分析第三阶段。第三阶段完全是C语言代码，从start_kernel函数开始。</p> 
   <div> 
    <div>
     【作者】
     <a href="http://www.cnblogs.com/sky-heaven/" rel="nofollow">张昺华</a> 
    </div> 
    <div>
     【出处】
     <a href="http://www.cnblogs.com/sky-heaven/" rel="nofollow">http://www.cnblogs.com/sky-heaven/</a> 
    </div> 
    <div>
     【博客园】 
     <a href="http://www.cnblogs.com/sky-heaven/" rel="nofollow">http://www.cnblogs.com/sky-heaven/</a> 
    </div> 
    <div>
     【新浪博客】 
     <a href="http://blog.sina.com.cn/u/2049150530" rel="nofollow">http://blog.sina.com.cn/u/2049150530</a> 
    </div> 
    <div>
     【知乎】 
     <a href="http://www.zhihu.com/people/zhang-bing-hua" rel="nofollow">http://www.zhihu.com/people/zhang-bing-hua</a> 
    </div> 
    <div>
     【我的作品---旋转倒立摆】 
     <a href="http://v.youku.com/v_show/id_XODM5NDAzNjQw.html?spm=a2hzp.8253869.0.0&amp;from=y1.7-2" rel="nofollow">http://v.youku.com/v_show/id_XODM5NDAzNjQw.html?spm=a2hzp.8253869.0.0&amp;from=y1.7-2</a> 
    </div> 
    <div>
     【我的作品---自平衡自动循迹车】 
     <a href="http://v.youku.com/v_show/id_XODM5MzYyNTIw.html?spm=a2hzp.8253869.0.0&amp;from=y1.7-2" rel="nofollow">http://v.youku.com/v_show/id_XODM5MzYyNTIw.html?spm=a2hzp.8253869.0.0&amp;from=y1.7-2</a> 
    </div> 
    <div>
     【新浪微博】 张昺华--sky
    </div> 
    <div>
     【twitter】 @sky2030_
    </div> 
    <div>
     【facebook】 张昺华 zhangbinghua
    </div> 
    <div>
     本文版权归作者和博客园共有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利.
    </div> 
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
