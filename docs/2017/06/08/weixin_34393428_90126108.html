<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>ASP.NET MVC5+EF6+EasyUI 后台管理系统（58）-DAL层重构 « NotBeCN</title>
  <meta name="description" content="             系列目录    前言：这是对本文系统一次重要的革新，很久就想要重构数据访问层了，数据访问层重复代码太多。主要集中增删该查每个模块都有，所以本次是为封装相同接口方法    　　　如果你想了解怎么重构普通的接口DAL层请查看第二节点    　　　如果你只想了解利用T4链接EF生成代码，可以忽...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/06/08/weixin_34393428_90126108.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">ASP.NET MVC5+EF6+EasyUI 后台管理系统（58）-DAL层重构</h1>
    <p class="post-meta">Jun 8, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong style="line-height:1.5;"><a href="http://www.cnblogs.com/ymnets/p/3424309.html" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">系列目录</a></strong></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong style="line-height:1.5;">前言：</strong><span style="line-height:1.5;">这是对本文系统一次重要的革新，很久就想要重构数据访问层了，数据访问层重复代码太多。主要集中增删该查每个模块都有，所以本次是为封装相同接口方法</span></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　如果你想了解怎么重构普通的接口DAL层请查看第二节点</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　如果你只想了解利用T4链接EF生成代码，可以忽略前两节，之后跳后最后T4模版的使用。</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　（<span style="line-height:1.8;color:rgb(255,0,0);">代码在最后</span>）</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　 补充：</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　最后必须让初学者理解一个知识点：分部类&nbsp;<strong>partial</strong>&nbsp;关键字，因为我们的重构是围绕分部类而实现，包括接口</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span class="sentence" style="line-height:1.8;"><strong>partial</strong>&nbsp;关键字指示可在命名空间中定义该类、结构或接口的其他部分。<span class="sentence" style="line-height:1.8;">所有部分都必须使用&nbsp;<strong>partial</strong>&nbsp;关键字。<span class="sentence" style="line-height:1.8;">在编译时，各个部分都必须可用来形成最终的类型。<span class="sentence" style="line-height:1.8;">各个部分必须具有相同的可访问性，如&nbsp;<strong>public</strong>、<strong>private</strong>&nbsp;等。</span></span></span></span></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span class="sentence" style="line-height:1.8;">如果将任意部分声明为抽象的，则整个类型都被视为抽象的。<span class="sentence" style="line-height:1.8;">如果将任意部分声明为密封的，则整个类型都被视为密封的。<span class="sentence" style="line-height:1.8;">如果任意部分声明基类型，则整个类型都将继承该类。</span></span></span></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span class="sentence" style="line-height:1.8;">指定基类的所有部分必须一致，但忽略基类的部分仍继承该基类型。<span class="sentence" style="line-height:1.8;">各个部分可以指定不同的基接口，最终类型将实现所有分部声明所列出的全部接口。<span class="sentence" style="line-height:1.8;">在某一分部定义中声明的任何类、结构或接口成员可供所有其他部分使用。<span class="sentence" style="line-height:1.8;">最终类型是所有部分在编译时的组合。</span></span></span></span></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">下列声明:</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>partial class<span style="line-height:1.5;"> Earth : Planet, IRotate { }
partial class Earth : IRevolve { }</span></pre>
   </div> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">等效于下列声明：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>class Earth : Planet, IRotate, IRevolve { }</pre>
   </div> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong>知识点：</strong></p> 
   <ol style="line-height:30px;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style:decimal;">改变EF代码生成策略 
     <ol style="line-height:30px;">
      <li style="list-style:decimal;">改变生成策略为T4</li> 
      <li style="list-style:decimal;">添加TT模版</li> 
     </ol></li> 
    <li style="list-style:decimal;">重构DAL层 
     <ol style="line-height:30px;">
      <li style="list-style:decimal;">创建ICommonRepository&lt;T&gt;接口</li> 
      <li style="list-style:decimal;">实现ICommonRepository&lt;T&gt;方法</li> 
     </ol></li> 
    <li style="list-style:decimal;">T4模版的使用</li> 
   </ol>
   <h3 style="color:#008080;font-size:16px;line-height:45px;font-family:Verdana, Arial, Helvetica, sans-serif;"><strong>1.改变EF代码生成策略旧的ObjectContext改为T4（如果你的项目已经是DBContext API模式请跳过）（操作前备份项目）</strong></h3> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">在此之前我们也该改变一下代码生成策略，为什么会这个改变。这个项目我最初开始创建的时候用的EF版本为EF4.0当时EF4.0只提供了ObjectContext API接口模式</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">这个访问方式只能对于DataBase Frist用，不能用于Code Frist.所以一直用到这里，这个并不是很重要，最终都不会影响我们的功能开发</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">但是DBContext API的亮点，和现在教材都是基于DBContext策略的方式(EF4.1版本之后)，我们有必要与时俱进。</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">操作方式很简单：</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong>第一步：</strong></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><img src="https://images2015.cnblogs.com/blog/439652/201603/439652-20160313163315647-1085563270.png" alt="" width="1200" height="631" style="border:0px;"></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">从旧的ObjectContext改为T4（操作前备份项目）</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong>第二步：</strong></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><img src="https://images2015.cnblogs.com/blog/439652/201603/439652-20160313164042710-1129177600.png" alt="" style="border:0px;"></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong>第三步：</strong></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><img src="https://images2015.cnblogs.com/blog/439652/201603/439652-20160313164316194-641737793.png" alt="" width="628" height="354" style="border:0px;">-&gt;<img src="https://images2015.cnblogs.com/blog/439652/201603/439652-20160313164338804-300821791.png" alt="" width="364" height="352" style="border:0px;"></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">最后看到DB.emdx下生成了很多模型类。根据表而生成的！这时代码编译将出错<span style="line-height:1.8;color:rgb(51,102,255);">，根据出错的类库添加NUGET包。EntityFramework6.1.3版本，</span>添加完之后还会继续报错。</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">因为ObjectContext有些方法和属性在DBContext已经不能用了</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">ObjectContext和ObjectSet都提供了AddObject的功能：</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="line-height:1.8;color:rgb(255,102,0);">&nbsp; 比如 context.AddObject("Students", newStudent):</span></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;color:rgb(255,102,0);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.Students.AddObject(newStudent): &nbsp;</span></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;color:rgb(255,102,0);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 而 DBContext中则只有DBSet有这个功能，并且名称为成了Add</span></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;color:rgb(255,102,0);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.Students.Add(newStudent):&nbsp;</span></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">也包括DeleteObject，ObjectStateManager等。</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;color:rgb(255,0,0);">（忽略所有错误。这些错误将在我们重构DAL层被解决）</span></p> 
   <h3 style="color:#008080;font-size:16px;line-height:45px;font-family:Verdana, Arial, Helvetica, sans-serif;"><strong>2.重构DAL层，下面我们来看一张图</strong></h3> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><img src="https://images2015.cnblogs.com/blog/439652/201603/439652-20160313160307288-1624052053.png" alt="" style="border:0px;"></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">图中绿色部分为本次重构部分，再利用成T4连接EF 生成通用分部类部分。这样我们下次不用手动创建继承类，只需要创建其他操作的分部类，很是简单。来看代码才明白</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;color:rgb(255,0,0);"><strong>在第一节下载17讲代码</strong></span></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">我们来看现有代码，以SysSample 模块的IDAL和DAL为例子</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> Apps.Models;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> System.Linq;
</span><span style="color:rgb(0,0,255);line-height:1.5;">namespace</span><span style="line-height:1.5;"> Apps.IDAL
{
    </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">interface</span><span style="line-height:1.5;"> ISysSampleRepository
    {</span>
        IQueryable&lt;SysSample&gt;<span style="line-height:1.5;"> GetList(DBContainer db);</span>
        <span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> Create(SysSample entity);</span>
        <span style="color:rgb(0,0,255);line-height:1.5;">int</span> Delete(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> id);</span>
        <span style="color:rgb(0,0,255);line-height:1.5;">void</span> Delete(DBContainer db, <span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;">[] deleteCollection);</span>
        <span style="color:rgb(128,128,128);line-height:1.5;">///</span> <span style="color:rgb(128,128,128);line-height:1.5;">&lt;param name="entity"&gt;</span><span style="color:rgb(0,128,0);line-height:1.5;">实体</span><span style="color:rgb(128,128,128);line-height:1.5;">&lt;/param&gt;</span>
        <span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> Edit(SysSample entity);</span>
        SysSample GetById(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> id);</span>
        <span style="color:rgb(0,0,255);line-height:1.5;">bool</span> IsExist(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> id);
    }
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> System;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> System.Linq;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> Apps.IDAL;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> Apps.Models;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> System.Data;

</span><span style="color:rgb(0,0,255);line-height:1.5;">namespace</span><span style="line-height:1.5;"> Apps.DAL
{
    </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> SysSampleRepository : ISysSampleRepository, IDisposable
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> IQueryable&lt;SysSample&gt;<span style="line-height:1.5;"> GetList(DBContainer db)
        {
            IQueryable</span>&lt;SysSample&gt; list =<span style="line-height:1.5;"> db.SysSample.AsQueryable();
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> list;
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> Create(SysSample entity)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">using</span> (DBContainer db = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> DBContainer())
            {
                db.SysSample.AddObject(entity);
                </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> db.SaveChanges();
            }
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">int </span>Delete(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> id)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">using</span> (DBContainer db = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> DBContainer())
            {
                SysSample entity </span>= db.SysSample.SingleOrDefault(a =&gt; a.Id ==<span style="line-height:1.5;"> id);
                </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (entity != <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">)
                {
                    
                    db.SysSample.DeleteObject(entity);
                }
                </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> db.SaveChanges();
            }
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">int </span>Delete(DBContainer db, <span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;">[] deleteCollection)
        {
            IQueryable</span>&lt;SysSample&gt; collection = <span style="color:rgb(0,0,255);line-height:1.5;">from</span> f <span style="color:rgb(0,0,255);line-height:1.5;">in</span><span style="line-height:1.5;"> db.SysSample
                                               </span><span style="color:rgb(0,0,255);line-height:1.5;">where</span><span style="line-height:1.5;"> deleteCollection.Contains(f.Id)
                                               </span><span style="color:rgb(0,0,255);line-height:1.5;">select</span><span style="line-height:1.5;"> f;
            </span><span style="color:rgb(0,0,255);line-height:1.5;">foreach</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> deleteItem <span style="color:rgb(0,0,255);line-height:1.5;">in</span><span style="line-height:1.5;"> collection)
            {
                db.SysSample.DeleteObject(deleteItem);
            }
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> Edit(SysSample entity)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">using</span> (DBContainer db = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> DBContainer())
            {
                db.SysSample.Attach(entity);
                db.ObjectStateManager.ChangeObjectState(entity, EntityState.Modified);
                </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> db.SaveChanges();
            }
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> SysSample GetById(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> id)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">using</span> (DBContainer db = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> DBContainer())
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> db.SysSample.SingleOrDefault(a =&gt; a.Id ==<span style="line-height:1.5;"> id);
            }
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">bool</span> IsExist(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> id)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">using</span> (DBContainer db = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> DBContainer())
            {
                SysSample entity </span>=<span style="line-height:1.5;"> GetById(id);
                </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (entity != <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">)
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">;
                </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(0,0,255);line-height:1.5;">false</span><span style="line-height:1.5;">;
            }
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> Dispose()
        {

        }
    }
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">看到我们其他模块也都必须实现类似代码。其中不同之处只有SysSample模型</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;color:rgb(255,0,0);">好在.net提供索引访问对象的强类型List&lt;T&gt;这里的T代表SysSamle。是可变的</span></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong><span style="line-height:1.8;color:rgb(51,102,255);">1.接下来我们实现通用接口在IDAL层</span></strong></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> System;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> System.Collections.Generic;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> System.Linq;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> System.Linq.Expressions;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> System.Text;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> System.Threading.Tasks;

</span><span style="color:rgb(0,0,255);line-height:1.5;">namespace</span><span style="line-height:1.5;"> Apps.IDAL
{
    </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">interface</span> ICommonRepository&lt;T&gt; <span style="color:rgb(0,0,255);line-height:1.5;">where</span> T :<span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;">
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">bool</span><span style="line-height:1.5;"> Create(T model);
        </span><span style="color:rgb(0,0,255);line-height:1.5;">bool</span><span style="line-height:1.5;"> Edit(T model);
        </span><span style="color:rgb(0,0,255);line-height:1.5;">bool</span><span style="line-height:1.5;"> Delete(T model);
        </span><span style="color:rgb(128,128,128);line-height:1.5;">///</span> <span style="color:rgb(128,128,128);line-height:1.5;">&lt;summary&gt;</span>
        <span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> 按主键删除
        </span><span style="color:rgb(128,128,128);line-height:1.5;">///</span> <span style="color:rgb(128,128,128);line-height:1.5;">&lt;/summary&gt;</span>
        <span style="color:rgb(128,128,128);line-height:1.5;">///</span> <span style="color:rgb(128,128,128);line-height:1.5;">&lt;param name="keyValues"&gt;&lt;/param&gt;</span>
        <span style="color:rgb(0,0,255);line-height:1.5;">int</span> Delete(<span style="color:rgb(0,0,255);line-height:1.5;">params</span> <span style="color:rgb(0,0,255);line-height:1.5;">object</span><span style="line-height:1.5;">[] keyValues);
        T GetById(</span><span style="color:rgb(0,0,255);line-height:1.5;">params</span> <span style="color:rgb(0,0,255);line-height:1.5;">object</span><span style="line-height:1.5;">[] keyValues);
        </span><span style="color:rgb(128,128,128);line-height:1.5;">///</span> <span style="color:rgb(128,128,128);line-height:1.5;">&lt;summary&gt;</span>
        <span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> 获得所有数据
        </span><span style="color:rgb(128,128,128);line-height:1.5;">///</span> <span style="color:rgb(128,128,128);line-height:1.5;">&lt;/summary&gt;</span>
        <span style="color:rgb(128,128,128);line-height:1.5;">///</span> <span style="color:rgb(128,128,128);line-height:1.5;">&lt;returns&gt;&lt;/returns&gt;</span>
        IQueryable&lt;T&gt;<span style="line-height:1.5;"> GetList();
        </span><span style="color:rgb(128,128,128);line-height:1.5;">///</span> <span style="color:rgb(128,128,128);line-height:1.5;">&lt;summary&gt;</span>
        <span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> 根据表达式获取数据
        </span><span style="color:rgb(128,128,128);line-height:1.5;">///</span> <span style="color:rgb(128,128,128);line-height:1.5;">&lt;/summary&gt;</span>
        <span style="color:rgb(128,128,128);line-height:1.5;">///</span> <span style="color:rgb(128,128,128);line-height:1.5;">&lt;param name="whereLambda"&gt;&lt;/param&gt;</span>
        <span style="color:rgb(128,128,128);line-height:1.5;">///</span> <span style="color:rgb(128,128,128);line-height:1.5;">&lt;returns&gt;&lt;/returns&gt;</span>
        IQueryable&lt;T&gt; GetList(Func&lt;T, <span style="color:rgb(0,0,255);line-height:1.5;">bool</span>&gt;<span style="line-height:1.5;"> whereLambda);</span><span style="color:rgb(0,0,255);line-height:1.5;">bool</span> IsExist(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> id);
        </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> SaveChanges();
    }
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;<span style="line-height:1.8;color:rgb(255,153,0);">代码解析：接口实现了增删改查通用接口，并声明 where T :class 【T必须是一个类（class）类型】</span></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong><span style="line-height:1.8;color:rgb(51,102,255);">2.接下来我们实现通用方法DAL层 按照重构图所示，应该继承ICommonRepository接口，并实现接口方法</span></strong></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> Apps.IDAL;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> Apps.Models;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> System;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> System.Collections.Generic;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> System.Data.Entity;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> System.Linq;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> System.Linq.Expressions;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> System.Text;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> System.Threading.Tasks;

</span><span style="color:rgb(0,0,255);line-height:1.5;">namespace</span><span style="line-height:1.5;"> Apps.DAL
{
    </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">abstract</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span> CommonRepository&lt;T&gt; : ICommonRepository&lt;T&gt; <span style="color:rgb(0,0,255);line-height:1.5;">where</span> T:<span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;">
    {
        DBContainer db;
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> CommonRepository(DBContainer context)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">this</span>.db =<span style="line-height:1.5;"> context;
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> DBContainer Context
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">get</span> { <span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> db; }
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> <span style="color:rgb(0,0,255);line-height:1.5;">bool</span><span style="line-height:1.5;"> Create(T model)
        {
            db.Set</span>&lt;T&gt;<span style="line-height:1.5;">().Add(model);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> db.SaveChanges()&gt;<span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">;
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> <span style="color:rgb(0,0,255);line-height:1.5;">bool</span><span style="line-height:1.5;"> Edit(T model)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (db.Entry&lt;T&gt;(model).State ==<span style="line-height:1.5;"> EntityState.Modified)
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> db.SaveChanges() &gt; <span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">;
            }
            </span><span style="color:rgb(0,0,255);line-height:1.5;">else</span> <span style="color:rgb(0,0,255);line-height:1.5;">if</span> (db.Entry&lt;T&gt;(model).State ==<span style="line-height:1.5;"> EntityState.Detached)
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">try</span><span style="line-height:1.5;">
                {
                    db.Set</span>&lt;T&gt;<span style="line-height:1.5;">().Attach(model);
                    db.Entry</span>&lt;T&gt;(model).State =<span style="line-height:1.5;"> EntityState.Modified;
                }
                </span><span style="color:rgb(0,0,255);line-height:1.5;">catch</span><span style="line-height:1.5;"> (InvalidOperationException)
                {
                    </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">T old = Find(model._ID);
                    </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">db.Entry&lt;old&gt;.CurrentValues.SetValues(model);</span>
<span style="line-height:1.5;">                }
                </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> db.SaveChanges()&gt;<span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">;
            }
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(0,0,255);line-height:1.5;">false</span><span style="line-height:1.5;">;
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> <span style="color:rgb(0,0,255);line-height:1.5;">bool</span><span style="line-height:1.5;"> Delete(T model)
        {
            db.Set</span>&lt;T&gt;<span style="line-height:1.5;">().Remove(model);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> db.SaveChanges()&gt;<span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">;
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> <span style="color:rgb(0,0,255);line-height:1.5;">int</span> Delete(<span style="color:rgb(0,0,255);line-height:1.5;">params</span> <span style="color:rgb(0,0,255);line-height:1.5;">object</span><span style="line-height:1.5;">[] keyValues)
        {
            T model </span>=<span style="line-height:1.5;"> GetById(keyValues);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span>(model!=<span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">)
            {
                db.Set</span>&lt;T&gt;<span style="line-height:1.5;">().Remove(model);
                </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> db.SaveChanges();
            }
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> -<span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">;
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> T GetById(<span style="color:rgb(0,0,255);line-height:1.5;">params</span> <span style="color:rgb(0,0,255);line-height:1.5;">object</span><span style="line-height:1.5;">[] keyValues)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> db.Set&lt;T&gt;<span style="line-height:1.5;">().Find(keyValues);
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> IQueryable&lt;T&gt;<span style="line-height:1.5;"> GetList()
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> db.Set&lt;T&gt;<span style="line-height:1.5;">();
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> IQueryable&lt;T&gt; GetList(Func&lt;T, <span style="color:rgb(0,0,255);line-height:1.5;">bool</span>&gt;<span style="line-height:1.5;"> whereLambda)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> db.Set&lt;T&gt;<span style="line-height:1.5;">().Where(whereLambda).AsQueryable();
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> <span style="color:rgb(0,0,255);line-height:1.5;">bool</span> IsExist(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> id)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> GetById(id)!=<span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">;
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> SaveChanges()
        {
           </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> db.SaveChanges();
        }
    }
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;OK.全是DBContext API 操作EF方法。增删改查</p> 
   <h3 style="color:#008080;font-size:16px;line-height:45px;font-family:Verdana, Arial, Helvetica, sans-serif;"><strong>3.T4生成分部类</strong></h3> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">接下来我们来看这么用这个接口</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">我们IDAL所有表（即模块）都要实现ICommonRepository接口好调用其中的增删改查做扩展</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">删掉ISysSampleRepository中的原来代码变为：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> Apps.Models;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> System.Linq;
</span><span style="color:rgb(0,0,255);line-height:1.5;">namespace</span><span style="line-height:1.5;"> Apps.IDAL
{
    </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">interface</span> ISysSampleRepository : ICommonRepository&lt;SysSample&gt;<span style="line-height:1.5;">
    {
      
    }
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">观察到这里也是重复代码，因为同理我们所有表都要实现这样的接口，这样我们可以利用T4来生成这种的重复代码</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">我以前写过一篇文章是关于T4链接数据库的。<a href="http://www.cnblogs.com/ymnets/p/3578846.html" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">构建ASP.NET MVC4+EF5+EasyUI+Unity2.x注入的后台管理系统（29）-T4模版</a></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">这里我们是直接链接edmx的。同理</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong><span style="line-height:1.8;color:rgb(51,102,255);">1.新建一个文件夹。如下图所示并创建一个TT模版</span></strong></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><img src="https://images2015.cnblogs.com/blog/439652/201603/439652-20160313184850632-1652416358.png" alt="" width="1057" height="528" style="border:0px;"></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">创建后会产生2个文件。删掉Context.tt，因为在Apps.Models已经有了</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><img src="https://images2015.cnblogs.com/blog/439652/201603/439652-20160313184942991-1983485080.png" alt="" style="border:0px;"></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><img src="https://images2015.cnblogs.com/blog/439652/201603/439652-20160313185121491-1325086105.png" alt="" width="1037" height="335" style="border:0px;"></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;配置第五行的inputFile为上面所描述，可能因为环境不同你们EF路径有所不同。保存后TT模版会自动生成</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">tt模版如果没有高亮显示的。要安装一些工具。因为我是一边改一边发文章的。我这里也是没有的，下载T4Editor 安装高亮，什么版本就下什么就可以了（或者通过VS工具------扩展与更新 搜索）</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><a href="http://t4-editor.tangible-engineering.com/Download_T4Editor_Plus_ModelingTools.html" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">http://t4-editor.tangible-engineering.com/Download_T4Editor_Plus_ModelingTools.html</a></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">tangible T4 Editor 2.3.0 plus modeling tools for Visual Studio 2015<a href="http://visualstudiogallery.msdn.microsoft.com/784cf592-b797-4d4d-ad33-331fcf63faad" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">Download from Visual Studio Gallery</a></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">tangible T4 Editor 2.3.0 plus modeling tools for Visual Studio 2013<a href="http://visualstudiogallery.msdn.microsoft.com/6d1223ca-5e52-49d0-a489-910f9b76396e" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">Download from Visual Studio Gallery</a></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">按照ISysSampleRepository接口为例子。修改TT模版后代码</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <img class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" style="border:0px;vertical-align:middle;">&nbsp;
    <span class="cnblogs_code_collapse" style="border-width:1px;border-style:solid;border-color:#808080;line-height:1.5;">ICommonRepository</span> 
   </div> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">核心代码解析：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">foreach</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> entity <span style="color:rgb(0,0,255);line-height:1.5;">in</span> typeMapper.GetItemsToGenerate&lt;EntityType&gt;<span style="line-height:1.5;">(itemCollection))
{
    fileManager.StartNewFile(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">I</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>+entity.Name + <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Repository.cs</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
#</span>&gt;
<span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> Apps.Models;
</span><span style="color:rgb(0,0,255);line-height:1.5;">namespace</span><span style="line-height:1.5;"> Apps.IDAL
{
    </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">partial</span> <span style="color:rgb(0,0,255);line-height:1.5;">interface</span> I&lt;#=entity.Name #&gt;Repository:ICommonRepository&lt;&lt;#=entity.Name #&gt;&gt;<span style="line-height:1.5;">
    {
    
    }
</span>&lt;<span style="line-height:1.5;">#
    EndNamespace(code);
}

fileManager.Process();

#</span>&gt;</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">循环生成。达到预期效果</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><img src="https://images2015.cnblogs.com/blog/439652/201603/439652-20160313205927679-1456458119.png" alt="" width="929" height="377" style="border:0px;"></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;TT模版里面太多代码很难看懂，需要看官方帮助文档才行。但是我们可以提取公共部分。以后写TT就引入。看图</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><img src="https://images2015.cnblogs.com/blog/439652/201603/439652-20160313210209944-1682272632.png" alt="" width="859" height="586" style="border:0px;"></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">在WriteHeder方法后都是通用的访问代码。我们提取之后的代码。因为安装了T4高亮。我只能调浅色，深色效果太差</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">在Apps.Models创建 Common.ttinclude来做公共部分（你可以创建在其他路径，到时候是引入路径为准）</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">最后修改：ICommonRepository.tt第二行代码：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>&lt;#@ include file=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">../../Apps.Models/Common.ttinclude</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>#&gt;&lt;#@ </pre>
   </div> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">OK。看起来间接很多了，以后创建其他tt文件就可以直接引用公共部分，如果不提取tt模版也是没有问题的。</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">同理我们创建DAL层的公共部分，生成后的代码如下，同样是一个分部类CommonRepository</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <img class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" style="border:0px;vertical-align:middle;">&nbsp;
    <span class="cnblogs_code_collapse" style="border-width:1px;border-style:solid;border-color:#808080;line-height:1.5;">CommonRepository.tt</span> 
   </div> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">------------------------------------------------------------------------------
</span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> &lt;auto-generated&gt;
</span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     此代码已从模板生成。
</span><span style="color:rgb(0,128,0);line-height:1.5;">//</span>
<span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     手动更改此文件可能导致应用程序出现意外的行为。
</span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     如果重新生成代码，将覆盖对此文件的手动更改。
</span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> &lt;/auto-generated&gt;
</span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">------------------------------------------------------------------------------</span>

<span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> Apps.Models;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> Apps.DAL;
</span><span style="color:rgb(0,0,255);line-height:1.5;">namespace</span><span style="line-height:1.5;"> Apps.IDAL
{
    </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">partial</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span> SysSampleRepository:CommonRepository&lt;SysSample&gt;<span style="line-height:1.5;">
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> SysSampleRepository(DBContainer db):<span style="color:rgb(0,0,255);line-height:1.5;">base</span><span style="line-height:1.5;">(db)
        {
        
        }
    }
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">接下来原来很长的ISysSampleRepository接口最后变成了一个分部接口</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> Apps.Models;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> System.Linq;
</span><span style="color:rgb(0,0,255);line-height:1.5;">namespace</span><span style="line-height:1.5;"> Apps.IDAL
{
    </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">partial</span> <span style="color:rgb(0,0,255);line-height:1.5;">interface</span><span style="line-height:1.5;"> ISysSampleRepository
    {
     　　//处理通用部分外的业务
    }
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">SysSampleRepository变成了一个分部类</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> System;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> System.Linq;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> Apps.IDAL;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> Apps.Models;
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> System.Data;

</span><span style="color:rgb(0,0,255);line-height:1.5;">namespace</span><span style="line-height:1.5;"> Apps.DAL
{
    </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> SysSampleRepository
    {</span></pre> 
    <pre><span style="line-height:1.5;">　　　　//处理通用部分外的业务</span></pre> 
    <pre><span style="line-height:1.5;">} }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <pre></pre> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;">可以处理通用部分外的业务</span></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;">这样我们关注点真的很专注了。Ye...</span></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;">关于业务层，肯定还是报错的状态，这时候我们就来修改一下</span></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;">例如：</span></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;"><img src="https://images2015.cnblogs.com/blog/439652/201603/439652-20160313212448257-24228013.png" alt="" width="589" height="240" style="border:0px;">变为<img src="https://images2015.cnblogs.com/blog/439652/201603/439652-20160321000746318-2058828681.png" alt="" width="589" height="231" style="border:0px;"></span></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">最后业务层代码：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <img class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" style="border:0px;vertical-align:middle;">&nbsp;
    <span class="cnblogs_code_collapse" style="border-width:1px;border-style:solid;border-color:#808080;line-height:1.5;">View Code</span> 
   </div> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;color:rgb(128,0,128);"><strong><span style="line-height:1.5;">--------------------------------------------------------------------------------写在最后--------------------------------------------------------------------------------</span></strong></span></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.5;">可以对比以前DAL层的代码，明显的减少很多（虽然业务层没有减少）。也许在以后业务层也有必要的重构！</span></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.5;">最后我完全修改了我项目的DAL层。用数据直接说话</span></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.5;"><img src="https://images2015.cnblogs.com/blog/439652/201603/439652-20160321000148021-1175215200.png" alt="" style="border:0px;"></span></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><img src="https://images2015.cnblogs.com/blog/439652/201603/439652-20160321000209849-1287010652.png" alt="" style="border:0px;"></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">整整少了两万行。却完成了相同的功能。（代码类型.cs，与事实可能有点差别，但是可以效果明显）</p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong><span style="line-height:1.8;color:rgb(255,0,0);">代码参考下载。重构后的架构（VS2013）执行根目录下的script.sql脚本。并修改web.config数据库链接即可查看</span></strong></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong><span style="line-height:1.8;color:rgb(255,0,0);">如查看重构前代码可以到第一节下载17节代码</span></strong></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong><span style="line-height:1.8;color:rgb(255,0,0);">https://yunpan.cn/cYUdjssbmiLrL &nbsp;提取码 e622</span></strong></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong><span style="line-height:1.8;color:rgb(255,0,0);"><img src="https://images2015.cnblogs.com/blog/439652/201603/439652-20160321014557276-554002770.png" alt="" style="border:0px;"></span></strong></p> 
   <p style="text-indent:2em;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong><span style="line-height:1.8;color:rgb(255,0,0);"><br></span></strong></p> 
   <p style="text-indent:2em;"><strong><span style="line-height:1.8;"><font color="#ff0000"><span style="font-size:14px;">本文转自ymnets博客园博客，原文链接：http://www.cnblogs.com/ymnets/p/5306935.html，如需转载请自行联系原作者</span></font><br></span></strong></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
