<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>SQL Server死锁总结(转载) « NotBeCN</title>
  <meta name="description" content="             &nbsp;&nbsp;1.&nbsp;死锁原理    &nbsp;&nbsp;&nbsp;&nbsp;根据操作系统中的定义：死锁是指在一组进程中的各个进程均占有不会释放的资源，但因互相申请被其他进程所站用不会释放的资源而处于的一种永久等待状态。    &nbsp;&nbsp;&nbsp...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/09/13/weixin_34060299_90127220.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">SQL Server死锁总结(转载)</h1>
    <p class="post-meta">Sep 13, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;&nbsp;<strong><span style="font-size:12pt;">1.&nbsp;</span></strong><strong><span style="font-size:12pt;font-family:'宋体';">死锁原理</span></strong><strong></strong></p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family:'宋体';">根据操作系统中的定义：死锁是指在一组进程中的各个进程均占有不会释放的资源，但因互相申请被其他进程所站用不会释放的资源而处于的一种永久等待状态。</span></p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family:'宋体';">死锁的四个必要条件：<br></span><span style="font-family:'宋体';">互斥条件</span>(Mutual exclusion)<span style="font-family:'宋体';">：资源不能被共享，只能由一个进程使用。<br></span><span style="font-family:'宋体';">请求与保持条件</span>(Hold and wait)<span style="font-family:'宋体';">：已经得到资源的进程可以再次申请新的资源。<br></span><span style="font-family:'宋体';">非剥夺条件</span>(No pre-emption)<span style="font-family:'宋体';">：已经分配的资源不能从相应的进程中被强制地剥夺。<br></span><span style="font-family:'宋体';">循环等待条件</span>(Circular wait)<span style="font-family:'宋体';">：系统中若干进程组成环路，该环路中每个进程都在等待相邻进程正占用的资源。</span></p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;</p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><span style="font-family:'宋体';">对应到</span>SQL Server<span style="font-family:'宋体';">中，当在两个或多个任务中，如果每个任务锁定了其他任务试图锁定的资源，此时会造成这些任务永久阻塞，从而出现死锁；这些资源可能是<span style="font-size:10.5pt;">：单行</span><span style="font-size:10.5pt;font-family:'Times New Roman';">(RID</span><span style="font-size:10.5pt;">，堆中的单行</span><span style="font-size:10.5pt;font-family:'Times New Roman';">)</span><span style="font-size:10.5pt;">、索引中的键</span><span style="font-size:10.5pt;font-family:'Times New Roman';">(KEY</span><span style="font-size:10.5pt;">，行锁</span><span style="font-size:10.5pt;font-family:'Times New Roman';">)</span><span style="font-size:10.5pt;">、页</span><span style="font-size:10.5pt;font-family:'Times New Roman';">(PAG</span><span style="font-size:10.5pt;">，</span><span style="font-size:10.5pt;font-family:'Times New Roman';">8KB)</span><span style="font-size:10.5pt;">、区结构</span><span style="font-size:10.5pt;font-family:'Times New Roman';">(EXT</span><span style="font-size:10.5pt;">，连续的</span><span style="font-size:10.5pt;font-family:'Times New Roman';">8</span><span style="font-size:10.5pt;">页</span><span style="font-size:10.5pt;font-family:'Times New Roman';">)</span><span style="font-size:10.5pt;">、堆或</span><span style="font-size:10.5pt;font-family:'Times New Roman';">B</span><span style="font-size:10.5pt;">树</span><span style="font-size:10.5pt;font-family:'Times New Roman';">(HOBT)&nbsp;</span><span style="font-size:10.5pt;">、表</span><span style="font-size:10.5pt;font-family:'Times New Roman';">(TAB</span><span style="font-size:10.5pt;">，包括数据和索引</span><span style="font-size:10.5pt;font-family:'Times New Roman';">)</span><span style="font-size:10.5pt;">、文件</span><span style="font-size:10.5pt;font-family:'Times New Roman';">(File</span><span style="font-size:10.5pt;">，数据库文件</span><span style="font-size:10.5pt;font-family:'Times New Roman';">)</span><span style="font-size:10.5pt;">、应用程序专用资源</span><span style="font-size:10.5pt;font-family:'Times New Roman';">(APP)</span><span style="font-size:10.5pt;">、元数据</span><span style="font-size:10.5pt;font-family:'Times New Roman';">(METADATA)</span><span style="font-size:10.5pt;">、分配单元</span><span style="font-size:10.5pt;font-family:'Times New Roman';">(Allocation_Unit)</span><span style="font-size:10.5pt;">、整个数据库</span><span style="font-size:10.5pt;font-family:'Times New Roman';">(DB)</span><span style="font-size:10.5pt;">。</span></span><span style="font-family:'宋体';">一个死锁示例如下图所示：</span></p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"></p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><span style="font-family:'宋体';"><img height="148" alt="" src="https://images.cnblogs.com/cnblogs_com/happyhippy/DB/DBLock1.JPG" width="374" style="border:0px;"><br> &nbsp;&nbsp;&nbsp;&nbsp;说明：</span>T1<span style="font-family:'宋体';">、</span>T2<span style="font-family:'宋体';">表示两个任务；</span>R1<span style="font-family:'宋体';">和</span>R2<span style="font-family:'宋体';">表示两个资源；由资源指向任务的箭头</span>(<span style="font-family:'宋体';">如</span>R1-&gt;T1<span style="font-family:'宋体';">，</span>R2-&gt;T2)<span style="font-family:'宋体';">表示该资源被改任务所持有；由任务指向资源的箭头</span>(<span style="font-family:'宋体';">如</span>T1-&gt;S2<span style="font-family:'宋体';">，</span>T2-&gt;S1)<span style="font-family:'宋体';">表示该任务正在请求对应目标资源；<br></span><span style="font-family:'宋体';">&nbsp;&nbsp;&nbsp;&nbsp;其满足上面死锁的四个必要条件：<br></span>(1).<span style="font-family:'宋体';">互斥：资源</span>S1<span style="font-family:'宋体';">和</span>S2<span style="font-family:'宋体';">不能被共享，同一时间只能由一个任务使用；<br></span>(2).<span style="font-family:'宋体';">请求与保持条件：</span>T1<span style="font-family:'宋体';">持有</span>S1<span style="font-family:'宋体';">的同时，请求</span>S2<span style="font-family:'宋体';">；</span>T2<span style="font-family:'宋体';">持有</span>S2<span style="font-family:'宋体';">的同时请求</span>S1<span style="font-family:'宋体';">；<br></span>(3).<span style="font-family:'宋体';">非剥夺条件：</span>T1<span style="font-family:'宋体';">无法从</span>T2<span style="font-family:'宋体';">上剥夺</span>S2<span style="font-family:'宋体';">，</span>T2<span style="font-family:'宋体';">也无法从</span>T1<span style="font-family:'宋体';">上剥夺</span>S1<span style="font-family:'宋体';">；<br></span>(4).<span style="font-family:'宋体';">循环等待条件：上图中的箭头构成环路，存在循环等待。</span></p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;</p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><strong><span style="font-size:12pt;">2.&nbsp;</span></strong><strong><span style="font-size:12pt;font-family:'宋体';">死锁排查</span></strong><strong></strong></p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">(1).&nbsp;<span style="font-family:'宋体';">使用</span>SQL Server<span style="font-family:'宋体';">的系统存储过程</span>sp_who<span style="font-family:'宋体';">和</span>sp_lock<span style="font-family:'宋体';">，可以查看当前数据库中的锁情况；进而根据</span>objectID(@objID)(SQL Server 2005)/ object_name(@objID)(Sql Server 2000)<span style="font-family:'宋体';">可以查看哪个资源被锁，用</span>dbcc ld(@blk)<span style="font-family:'宋体';">，可以查看最后一条发生给</span>SQL Server<span style="font-family:'宋体';">的</span>Sql<span style="font-family:'宋体';">语句；</span></p> 
   <div style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"> 
    <img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">
    <span style="color:rgb(0,0,255);">CREATE</span>&nbsp;
    <span style="color:rgb(0,0,255);">Table</span>
    <span style="color:rgb(0,0,0);">&nbsp;#Who(spid&nbsp;</span>
    <span style="color:rgb(0,0,255);">int</span>
    <span style="color:rgb(0,0,0);">,<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;ecid&nbsp;</span>
    <span style="color:rgb(0,0,255);">int</span>
    <span style="color:rgb(0,0,0);">,<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;status&nbsp;</span>
    <span style="color:rgb(0,0,255);">nvarchar</span>
    <span style="color:rgb(0,0,0);">(</span>
    <span style="font-weight:bold;color:rgb(128,0,0);">50</span>
    <span style="color:rgb(0,0,0);">),<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;loginname&nbsp;</span>
    <span style="color:rgb(0,0,255);">nvarchar</span>
    <span style="color:rgb(0,0,0);">(</span>
    <span style="font-weight:bold;color:rgb(128,0,0);">50</span>
    <span style="color:rgb(0,0,0);">),<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;hostname&nbsp;</span>
    <span style="color:rgb(0,0,255);">nvarchar</span>
    <span style="color:rgb(0,0,0);">(</span>
    <span style="font-weight:bold;color:rgb(128,0,0);">50</span>
    <span style="color:rgb(0,0,0);">),<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;blk&nbsp;</span>
    <span style="color:rgb(0,0,255);">int</span>
    <span style="color:rgb(0,0,0);">,<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;dbname&nbsp;</span>
    <span style="color:rgb(0,0,255);">nvarchar</span>
    <span style="color:rgb(0,0,0);">(</span>
    <span style="font-weight:bold;color:rgb(128,0,0);">50</span>
    <span style="color:rgb(0,0,0);">),<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;cmd&nbsp;</span>
    <span style="color:rgb(0,0,255);">nvarchar</span>
    <span style="color:rgb(0,0,0);">(</span>
    <span style="font-weight:bold;color:rgb(128,0,0);">50</span>
    <span style="color:rgb(0,0,0);">),<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;request_ID&nbsp;</span>
    <span style="color:rgb(0,0,255);">int</span>
    <span style="color:rgb(0,0,0);">);<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">CREATE</span>&nbsp;
    <span style="color:rgb(0,0,255);">Table</span>
    <span style="color:rgb(0,0,0);">&nbsp;#Lock(spid&nbsp;</span>
    <span style="color:rgb(0,0,255);">int</span>
    <span style="color:rgb(0,0,0);">,<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;dpid&nbsp;</span>
    <span style="color:rgb(0,0,255);">int</span>
    <span style="color:rgb(0,0,0);">,<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;objid&nbsp;</span>
    <span style="color:rgb(0,0,255);">int</span>
    <span style="color:rgb(0,0,0);">,<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;indld&nbsp;</span>
    <span style="color:rgb(0,0,255);">int</span>
    <span style="color:rgb(0,0,0);">,<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(255,0,0);">[</span>
    <span style="color:rgb(255,0,0);">Type</span>
    <span style="color:rgb(255,0,0);">]</span>&nbsp;
    <span style="color:rgb(0,0,255);">nvarchar</span>
    <span style="color:rgb(0,0,0);">(</span>
    <span style="font-weight:bold;color:rgb(128,0,0);">20</span>
    <span style="color:rgb(0,0,0);">),<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;Resource&nbsp;</span>
    <span style="color:rgb(0,0,255);">nvarchar</span>
    <span style="color:rgb(0,0,0);">(</span>
    <span style="font-weight:bold;color:rgb(128,0,0);">50</span>
    <span style="color:rgb(0,0,0);">),<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;Mode&nbsp;</span>
    <span style="color:rgb(0,0,255);">nvarchar</span>
    <span style="color:rgb(0,0,0);">(</span>
    <span style="font-weight:bold;color:rgb(128,0,0);">10</span>
    <span style="color:rgb(0,0,0);">),<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;Status&nbsp;</span>
    <span style="color:rgb(0,0,255);">nvarchar</span>
    <span style="color:rgb(0,0,0);">(</span>
    <span style="font-weight:bold;color:rgb(128,0,0);">10</span>
    <span style="color:rgb(0,0,0);">)<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">);<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">INSERT</span>&nbsp;
    <span style="color:rgb(0,0,255);">INTO</span>
    <span style="color:rgb(0,0,0);">&nbsp;#Who<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">EXEC</span>
    <span style="color:rgb(0,0,0);">&nbsp;sp_who&nbsp;active&nbsp;&nbsp;</span>
    <span style="color:rgb(0,128,128);">--</span>
    <span style="color:rgb(0,128,128);">看哪个引起的阻塞，blk&nbsp;</span>
    <span style="color:rgb(0,128,128);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">INSERT</span>&nbsp;
    <span style="color:rgb(0,0,255);">INTO</span>
    <span style="color:rgb(0,0,0);">&nbsp;#Lock<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">EXEC</span>
    <span style="color:rgb(0,0,0);">&nbsp;sp_lock&nbsp;&nbsp;</span>
    <span style="color:rgb(0,128,128);">--</span>
    <span style="color:rgb(0,128,128);">看锁住了那个资源id，objid&nbsp;</span>
    <span style="color:rgb(0,128,128);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,0);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">DECLARE</span>&nbsp;
    <span style="color:rgb(0,128,0);">@DBName</span>&nbsp;
    <span style="color:rgb(0,0,255);">nvarchar</span>
    <span style="color:rgb(0,0,0);">(</span>
    <span style="font-weight:bold;color:rgb(128,0,0);">20</span>
    <span style="color:rgb(0,0,0);">);<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">SET</span>&nbsp;
    <span style="color:rgb(0,128,0);">@DBName</span>
    <span style="color:rgb(128,128,128);">=</span>
    <span style="color:rgb(255,0,0);">'</span>
    <span style="color:rgb(255,0,0);">NameOfDataBase</span>
    <span style="color:rgb(255,0,0);">'</span>
    <span style="color:rgb(0,0,0);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">SELECT</span>
    <span style="color:rgb(0,0,0);">&nbsp;#Who.</span>
    <span style="color:rgb(128,128,128);">*</span>&nbsp;
    <span style="color:rgb(0,0,255);">FROM</span>
    <span style="color:rgb(0,0,0);">&nbsp;#Who&nbsp;</span>
    <span style="color:rgb(0,0,255);">WHERE</span>
    <span style="color:rgb(0,0,0);">&nbsp;dbname</span>
    <span style="color:rgb(128,128,128);">=</span>
    <span style="color:rgb(0,128,0);">@DBName</span>
    <span style="color:rgb(0,0,0);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">SELECT</span>
    <span style="color:rgb(0,0,0);">&nbsp;#Lock.</span>
    <span style="color:rgb(128,128,128);">*</span>&nbsp;
    <span style="color:rgb(0,0,255);">FROM</span>
    <span style="color:rgb(0,0,0);">&nbsp;#Lock<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(128,128,128);">JOIN</span>
    <span style="color:rgb(0,0,0);">&nbsp;#Who<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">ON</span>
    <span style="color:rgb(0,0,0);">&nbsp;#Who.spid</span>
    <span style="color:rgb(128,128,128);">=</span>
    <span style="color:rgb(0,0,0);">#Lock.spid<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(128,128,128);">AND</span>
    <span style="color:rgb(0,0,0);">&nbsp;dbname</span>
    <span style="color:rgb(128,128,128);">=</span>
    <span style="color:rgb(0,128,0);">@DBName</span>
    <span style="color:rgb(0,0,0);">;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,128,128);">--</span>
    <span style="color:rgb(0,128,128);">最后发送到SQL&nbsp;Server的语句</span>
    <span style="color:rgb(0,128,128);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">DECLARE</span>
    <span style="color:rgb(0,0,0);">&nbsp;crsr&nbsp;</span>
    <span style="color:rgb(0,0,255);">Cursor</span>&nbsp;
    <span style="color:rgb(0,0,255);">FOR</span>
    <span style="color:rgb(0,0,0);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">SELECT</span>
    <span style="color:rgb(0,0,0);">&nbsp;blk&nbsp;</span>
    <span style="color:rgb(0,0,255);">FROM</span>
    <span style="color:rgb(0,0,0);">&nbsp;#Who&nbsp;</span>
    <span style="color:rgb(0,0,255);">WHERE</span>
    <span style="color:rgb(0,0,0);">&nbsp;dbname</span>
    <span style="color:rgb(128,128,128);">=</span>
    <span style="color:rgb(0,128,0);">@DBName</span>&nbsp;
    <span style="color:rgb(128,128,128);">AND</span>
    <span style="color:rgb(0,0,0);">&nbsp;blk</span>
    <span style="color:rgb(128,128,128);">&lt;&gt;</span>
    <span style="font-weight:bold;color:rgb(128,0,0);">0</span>
    <span style="color:rgb(0,0,0);">;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">DECLARE</span>&nbsp;
    <span style="color:rgb(0,128,0);">@blk</span>&nbsp;
    <span style="color:rgb(0,0,255);">int</span>
    <span style="color:rgb(0,0,0);">;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">open</span>
    <span style="color:rgb(0,0,0);">&nbsp;crsr;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">FETCH</span>&nbsp;
    <span style="color:rgb(0,0,255);">NEXT</span>&nbsp;
    <span style="color:rgb(0,0,255);">FROM</span>
    <span style="color:rgb(0,0,0);">&nbsp;crsr&nbsp;</span>
    <span style="color:rgb(0,0,255);">INTO</span>&nbsp;
    <span style="color:rgb(0,128,0);">@blk</span>
    <span style="color:rgb(0,0,0);">;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">WHILE</span>
    <span style="color:rgb(0,0,0);">&nbsp;(</span>
    <span style="font-weight:bold;color:rgb(0,128,0);">@@FETCH_STATUS</span>&nbsp;
    <span style="color:rgb(128,128,128);">=</span>&nbsp;
    <span style="font-weight:bold;color:rgb(128,0,0);">0</span>
    <span style="color:rgb(0,0,0);">)<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">BEGIN</span>
    <span style="color:rgb(0,0,0);">;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">dbcc</span>
    <span style="color:rgb(0,0,0);">&nbsp;inputbuffer(</span>
    <span style="color:rgb(0,128,0);">@blk</span>
    <span style="color:rgb(0,0,0);">);<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">FETCH</span>&nbsp;
    <span style="color:rgb(0,0,255);">NEXT</span>&nbsp;
    <span style="color:rgb(0,0,255);">FROM</span>
    <span style="color:rgb(0,0,0);">&nbsp;crsr&nbsp;</span>
    <span style="color:rgb(0,0,255);">INTO</span>&nbsp;
    <span style="color:rgb(0,128,0);">@blk</span>
    <span style="color:rgb(0,0,0);">;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">END</span>
    <span style="color:rgb(0,0,0);">;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">close</span>
    <span style="color:rgb(0,0,0);">&nbsp;crsr;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">DEALLOCATE</span>
    <span style="color:rgb(0,0,0);">&nbsp;crsr;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,128,128);">--</span>
    <span style="color:rgb(0,128,128);">锁定的资源</span>
    <span style="color:rgb(0,128,128);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">SELECT</span>
    <span style="color:rgb(0,0,0);">&nbsp;#Who.spid,hostname,objid,</span>
    <span style="color:rgb(255,0,0);">[</span>
    <span style="color:rgb(255,0,0);">type</span>
    <span style="color:rgb(255,0,0);">]</span>
    <span style="color:rgb(0,0,0);">,mode,</span>
    <span style="color:rgb(255,0,255);">object_name</span>
    <span style="color:rgb(0,0,0);">(objid)&nbsp;</span>
    <span style="color:rgb(0,0,255);">as</span>
    <span style="color:rgb(0,0,0);">&nbsp;objName&nbsp;</span>
    <span style="color:rgb(0,0,255);">FROM</span>
    <span style="color:rgb(0,0,0);">&nbsp;#Lock<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(128,128,128);">JOIN</span>
    <span style="color:rgb(0,0,0);">&nbsp;#Who<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">ON</span>
    <span style="color:rgb(0,0,0);">&nbsp;#Who.spid</span>
    <span style="color:rgb(128,128,128);">=</span>
    <span style="color:rgb(0,0,0);">#Lock.spid<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(128,128,128);">AND</span>
    <span style="color:rgb(0,0,0);">&nbsp;dbname</span>
    <span style="color:rgb(128,128,128);">=</span>
    <span style="color:rgb(0,128,0);">@DBName</span>
    <span style="color:rgb(0,0,0);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">WHERE</span>
    <span style="color:rgb(0,0,0);">&nbsp;objid</span>
    <span style="color:rgb(128,128,128);">&lt;&gt;</span>
    <span style="font-weight:bold;color:rgb(128,0,0);">0</span>
    <span style="color:rgb(0,0,0);">;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">DROP</span>&nbsp;
    <span style="color:rgb(0,0,255);">Table</span>
    <span style="color:rgb(0,0,0);">&nbsp;#Who;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">DROP</span>&nbsp;
    <span style="color:rgb(0,0,255);">Table</span>
    <span style="color:rgb(0,0,0);">&nbsp;#Lock;</span> 
   </div> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><br> (2).&nbsp;<span style="font-family:'宋体';">使用</span>&nbsp;SQL Server Profiler&nbsp;<span style="font-family:'宋体';">分析死锁</span>:&nbsp;<span style="font-family:'宋体';">将</span>&nbsp;Deadlock graph&nbsp;<span style="font-family:'宋体';">事件类添加到跟踪。此事件类使用死锁涉及到的进程和对象的</span>&nbsp;XML&nbsp;<span style="font-family:'宋体';">数据填充跟踪中的</span>TextData&nbsp;<span style="font-family:'宋体';">数据列。</span>SQL Server&nbsp;<span style="font-family:'宋体';">事件探查器</span>&nbsp;<span style="font-family:'宋体';">可以将</span>&nbsp;XML&nbsp;<span style="font-family:'宋体';">文档提取到死锁</span>&nbsp;XML (.xdl)&nbsp;<span style="font-family:'宋体';">文件中，以后可在</span>&nbsp;SQL Server Management Studio&nbsp;<span style="font-family:'宋体';">中查看该文件。</span></p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;</p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><strong><span style="font-size:12pt;">3.&nbsp;</span></strong><strong><span style="font-size:12pt;font-family:'宋体';">避免死锁</span></strong><strong></strong></p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family:'宋体';">上面</span>1<span style="font-family:'宋体';">中列出了死锁的四个必要条件，我们只要想办法破其中的任意一个或多个条件，就可以避免死锁发生，一般有以下几种方法</span>(FROM Sql Server 2005<span style="font-family:'宋体';">联机丛书</span>)<span style="font-family:'宋体';">：<br></span><strong>(1).</strong><strong><span style="font-family:'宋体';">按同一顺序访问对象。</span></strong>(<span style="font-family:'宋体';">注：避免出现循环</span>)<br><strong>(2).</strong><strong><span style="font-family:'宋体';">避免事务中的用户交互。</span></strong>(<span style="font-family:'宋体';">注：减少持有资源的时间，较少锁竞争</span>)<br><strong>(3).</strong><strong><span style="font-family:'宋体';">保持事务简短并处于一个批处理中。</span></strong>(<span style="font-family:'宋体';">注：同</span>(2)<span style="font-family:'宋体';">，减少持有资源的时间</span>)<br><strong>(4).</strong><strong><span style="font-family:'宋体';">使用较低的隔离级别。</span></strong>(<span style="font-family:'宋体';">注：使用较低的隔离级别（例如已提交读）比使用较高的隔离级别（例如可序列化）持有共享锁的时间更短，减少锁竞争</span>)<br><strong>(5).</strong><strong><span style="font-family:'宋体';">使用基于行版本控制的隔离级别</span></strong><span style="font-family:'宋体';">：</span>2005<span style="font-family:'宋体';">中支持快照事务隔离和指定</span>READ_COMMITTED<span style="font-family:'宋体';">隔离级别的事务使用行版本控制，可以将读与写操作之间发生的死锁几率降至最低：<br></span>SET ALLOW_SNAPSHOT_ISOLATION ON --<span style="font-family:'宋体';">事务可以指定</span>&nbsp;SNAPSHOT&nbsp;<span style="font-family:'宋体';">事务隔离级别</span>;<br> SET READ_COMMITTED_SNAPSHOT ON&nbsp;--<span style="font-family:'宋体';">指定</span>&nbsp;READ_COMMITTED&nbsp;<span style="font-family:'宋体';">隔离级别的事务将使用行版本控制而不是锁定。默认情况下</span>(<span style="font-family:'宋体';">没有开启此选项，没有加</span>with nolock<span style="font-family:'宋体';">提示</span>)<span style="font-family:'宋体';">，</span>SELECT<span style="font-family:'宋体';">语句会对请求的资源加</span>S<span style="font-family:'宋体';">锁</span>(<span style="font-family:'宋体';">共享锁</span>)<span style="font-family:'宋体';">；而开启了此选项后，</span>SELECT<span style="font-family:'宋体';">不会对请求的资源加</span>S<span style="font-family:'宋体';">锁。<br></span><strong><span style="font-family:'宋体';">注意：</span></strong><span style="font-family:'宋体';">设置</span>&nbsp;READ_COMMITTED_SNAPSHOT&nbsp;<span style="font-family:'宋体';">选项时，数据库中只允许存在执行</span>&nbsp;ALTER DATABASE&nbsp;<span style="font-family:'宋体';">命令的连接。在</span>&nbsp;ALTER DATABASE&nbsp;<span style="font-family:'宋体';">完成之前，数据库中决不能有其他打开的连接。数据库不必一定要处于单用户模式中。<br></span><strong>(6).</strong><strong><span style="font-family:'宋体';">使用绑定连接</span></strong><span style="font-family:'宋体';">。</span>(<span style="font-family:'宋体';">注：绑定会话有利于在同一台服务器上的多个会话之间协调操作。绑定会话允许一个或多个会话<strong>共享相同的事务和锁</strong></span><strong>(</strong><strong><span style="font-family:'宋体';">但每个回话保留其自己的事务隔离级别</span>)</strong><span style="font-family:'宋体';">，并可以使用同一数据，而不会有锁冲突。可以从同一个应用程序内的多个会话中创建绑定会话，也可以从包含不同会话的多个应用程序中创建绑定会话。在一个会话中开启事务</span>(begin tran)<span style="font-family:'宋体';">后，调用</span>exec sp_getbindtoken @Token out;<span style="font-family:'宋体';">来取得</span>Token<span style="font-family:'宋体';">，然后传入另一个会话并执行</span>EXEC sp_bindsession @Token<span style="font-family:'宋体';">来进行绑定</span>(<span style="font-family:'宋体';">最后的示例中演示了绑定连接</span>)<span style="font-family:'宋体';">。</span></p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;</p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><strong><span style="font-size:12pt;">4.&nbsp;</span></strong><strong><span style="font-size:12pt;font-family:'宋体';">死锁处理方法：</span></strong><strong></strong></p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">(1).&nbsp;<span style="font-family:'宋体';">根据</span>2<span style="font-family:'宋体';">中提供的</span>sql<span style="font-family:'宋体';">，查看那个</span>spid<span style="font-family:'宋体';">处于</span>wait<span style="font-family:'宋体';">状态，然后用</span><strong>kill spid</strong><span style="font-family:'宋体';">来干掉</span>(<span style="font-family:'宋体';">即破坏死锁的第四个必要条件</span>:<span style="font-family:'宋体';">循环等待</span>)<span style="font-family:'宋体';">；当然这只是一种临时解决方案，我们总不能在遇到死锁就在用户的生产环境上排查死锁、</span>Kill sp<span style="font-family:'宋体';">，我们应该考虑如何去避免死锁。</span></p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">(2).&nbsp;<span style="font-family:'宋体';">使用</span>SET LOCK_TIMEOUT timeout_period(<span style="font-family:'宋体';">单位为毫秒</span>)<span style="font-family:'宋体';">来<strong>设定锁请求超时</strong>。默认情况下，数据库没有超时期限</span>(timeout_period<span style="font-family:'宋体';">值为</span>-1<span style="font-family:'宋体';">，可以用</span>SELECT @@LOCK_TIMEOUT<span style="font-family:'宋体';">来查看该值，即无限期等待</span>)<span style="font-family:'宋体';">。当请求锁超过</span>timeout_period<span style="font-family:'宋体';">时，将返回错误。</span>timeout_period<span style="font-family:'宋体';">值为</span>0<span style="font-family:'宋体';">时表示根本不等待，一遇到锁就返回消息。设置锁请求超时，破环了死锁的第二个必要条件</span>(<span style="font-family:'宋体';">请求与保持条件</span>)<span style="font-family:'宋体';">。</span></p> 
   <div style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"> 
    <span style="color:rgb(0,0,0);">服务器:&nbsp;消息&nbsp;</span>
    <span style="color:rgb(0,0,0);">1222</span>
    <span style="color:rgb(0,0,0);">，级别&nbsp;</span>
    <span style="color:rgb(0,0,0);">16</span>
    <span style="color:rgb(0,0,0);">，状态&nbsp;</span>
    <span style="color:rgb(0,0,0);">50</span>
    <span style="color:rgb(0,0,0);">，行&nbsp;</span>
    <span style="color:rgb(0,0,0);">1</span>
    <span style="color:rgb(0,0,0);"><br> 已超过了锁请求超时时段。</span> 
   </div> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"></p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"></p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;</p> 
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">(3). SQL Server</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">内部有一个<strong>锁监视器线程执行死锁检查</strong>，锁监视器对特定线程启动死锁搜索时，会标识线程正在等待的资源；然后查找特定资源的所有者，并递归地继续执行对那些线程的死锁搜索，直到找到一个构成死锁条件的循环。检测到死锁后，数据库引擎</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">选择运行回滚开销最小的事务的会话作为死锁牺牲品，返回</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">1205&nbsp;</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">错误，回滚死锁牺牲品的事务并释放该事务持有的所有锁，使其他线程的事务可以请求资源并继续运行。</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"></span> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;</p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;</p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><strong><span style="font-size:12pt;">5.&nbsp;</span></strong><strong><span style="font-size:12pt;font-family:'宋体';">两个死锁示例及解决方法</span></strong><strong></strong></p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><strong>5.1 SQL</strong><strong><span style="font-family:'宋体';">死锁</span></strong></p> 
   <p style="text-indent:21pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><strong>(1).&nbsp;</strong><span style="font-family:'宋体';"><strong>测试用的基础数据：</strong></span></p> 
   <div style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"> 
    <img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">
    <span style="color:rgb(0,0,255);">CREATE</span>&nbsp;
    <span style="color:rgb(0,0,255);">TABLE</span>
    <span style="color:rgb(0,0,0);">&nbsp;Lock1(C1&nbsp;</span>
    <span style="color:rgb(0,0,255);">int</span>&nbsp;
    <span style="color:rgb(0,0,255);">default</span>
    <span style="color:rgb(0,0,0);">(</span>
    <span style="font-weight:bold;color:rgb(128,0,0);">0</span>
    <span style="color:rgb(0,0,0);">));<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">CREATE</span>&nbsp;
    <span style="color:rgb(0,0,255);">TABLE</span>
    <span style="color:rgb(0,0,0);">&nbsp;Lock2(C1&nbsp;</span>
    <span style="color:rgb(0,0,255);">int</span>&nbsp;
    <span style="color:rgb(0,0,255);">default</span>
    <span style="color:rgb(0,0,0);">(</span>
    <span style="font-weight:bold;color:rgb(128,0,0);">0</span>
    <span style="color:rgb(0,0,0);">));<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">INSERT</span>&nbsp;
    <span style="color:rgb(0,0,255);">INTO</span>
    <span style="color:rgb(0,0,0);">&nbsp;Lock1&nbsp;</span>
    <span style="color:rgb(0,0,255);">VALUES</span>
    <span style="color:rgb(0,0,0);">(</span>
    <span style="font-weight:bold;color:rgb(128,0,0);">1</span>
    <span style="color:rgb(0,0,0);">);<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">INSERT</span>&nbsp;
    <span style="color:rgb(0,0,255);">INTO</span>
    <span style="color:rgb(0,0,0);">&nbsp;Lock2&nbsp;</span>
    <span style="color:rgb(0,0,255);">VALUES</span>
    <span style="color:rgb(0,0,0);">(</span>
    <span style="font-weight:bold;color:rgb(128,0,0);">1</span>
    <span style="color:rgb(0,0,0);">);</span> 
   </div> 
   <p style="text-indent:21pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"></p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"></p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"></p> 
   <strong style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">(2).&nbsp;<span style="font-family:'宋体';">开两个查询窗口，分别执行下面两段</span></strong>
   <strong style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">sql</strong>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"></span> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;</p> 
   <div style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"> 
    <img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">
    <span style="color:rgb(0,128,128);">--</span>
    <span style="color:rgb(0,128,128);">Query&nbsp;1</span>
    <span style="color:rgb(0,128,128);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">Begin</span>&nbsp;
    <span style="color:rgb(0,0,255);">Tran</span>
    <span style="color:rgb(0,0,0);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">Update</span>
    <span style="color:rgb(0,0,0);">&nbsp;Lock1&nbsp;</span>
    <span style="color:rgb(0,0,255);">Set</span>
    <span style="color:rgb(0,0,0);">&nbsp;C1</span>
    <span style="color:rgb(128,128,128);">=</span>
    <span style="color:rgb(0,0,0);">C1</span>
    <span style="color:rgb(128,128,128);">+</span>
    <span style="font-weight:bold;color:rgb(128,0,0);">1</span>
    <span style="color:rgb(0,0,0);">;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">WaitFor</span>
    <span style="color:rgb(0,0,0);">&nbsp;Delay&nbsp;</span>
    <span style="color:rgb(255,0,0);">'</span>
    <span style="color:rgb(255,0,0);">00:01:00</span>
    <span style="color:rgb(255,0,0);">'</span>
    <span style="color:rgb(0,0,0);">;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">SELECT</span>&nbsp;
    <span style="color:rgb(128,128,128);">*</span>&nbsp;
    <span style="color:rgb(0,0,255);">FROM</span>
    <span style="color:rgb(0,0,0);">&nbsp;Lock2<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">Rollback</span>&nbsp;
    <span style="color:rgb(0,0,255);">Tran</span>
    <span style="color:rgb(0,0,0);">;</span> 
   </div> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;</p> 
   <div style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"> 
    <img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">
    <span style="color:rgb(0,128,128);">--</span>
    <span style="color:rgb(0,128,128);">Query&nbsp;2</span>
    <span style="color:rgb(0,128,128);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">Begin</span>&nbsp;
    <span style="color:rgb(0,0,255);">Tran</span>
    <span style="color:rgb(0,0,0);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">Update</span>
    <span style="color:rgb(0,0,0);">&nbsp;Lock2&nbsp;</span>
    <span style="color:rgb(0,0,255);">Set</span>
    <span style="color:rgb(0,0,0);">&nbsp;C1</span>
    <span style="color:rgb(128,128,128);">=</span>
    <span style="color:rgb(0,0,0);">C1</span>
    <span style="color:rgb(128,128,128);">+</span>
    <span style="font-weight:bold;color:rgb(128,0,0);">1</span>
    <span style="color:rgb(0,0,0);">;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">WaitFor</span>
    <span style="color:rgb(0,0,0);">&nbsp;Delay&nbsp;</span>
    <span style="color:rgb(255,0,0);">'</span>
    <span style="color:rgb(255,0,0);">00:01:00</span>
    <span style="color:rgb(255,0,0);">'</span>
    <span style="color:rgb(0,0,0);">;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">SELECT</span>&nbsp;
    <span style="color:rgb(128,128,128);">*</span>&nbsp;
    <span style="color:rgb(0,0,255);">FROM</span>
    <span style="color:rgb(0,0,0);">&nbsp;Lock1<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">Rollback</span>&nbsp;
    <span style="color:rgb(0,0,255);">Tran</span>
    <span style="color:rgb(0,0,0);">;</span> 
   </div> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;</p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><span style="font-family:'宋体';">上面的</span>SQL<span style="font-family:'宋体';">中有一句</span>WaitFor Delay '00:01:00'<span style="font-family:'宋体';">，用于等待</span>1<span style="font-family:'宋体';">分钟，以方便查看锁的情况。</span></p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><strong>(3).&nbsp;<span style="font-family:'宋体';">查看锁情况</span></strong></p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><span style="font-family:'宋体';">在执行上面的</span>WaitFor<span style="font-family:'宋体';">语句期间，执行第二节中提供的语句来查看锁信息：</span></p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"></p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><img height="151" alt="" src="https://images.cnblogs.com/cnblogs_com/happyhippy/DB/DBLock2.JPG" width="675" style="border:0px;"></p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">Query1<span style="font-family:'宋体';">中，持有</span>Lock1<span style="font-family:'宋体';">中第一行</span>(<span style="font-family:'宋体';">表中只有一行数据</span>)<span style="font-family:'宋体';">的行排他锁</span>(RID:X)<span style="font-family:'宋体';">，并持有该行所在页的意向更新锁</span>(PAG:IX)<span style="font-family:'宋体';">、该表的意向更新锁</span>(TAB:IX)<span style="font-family:'宋体';">；</span>Query2<span style="font-family:'宋体';">中，持有</span>Lock2<span style="font-family:'宋体';">中第一行</span>(<span style="font-family:'宋体';">表中只有一行数据</span>)<span style="font-family:'宋体';">的行排他锁</span>(RID:X)<span style="font-family:'宋体';">，并持有该行所在页的意向更新锁</span>(PAG:IX)<span style="font-family:'宋体';">、该表的意向更新锁</span>(TAB:IX)<span style="font-family:'宋体';">；</span></p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><span style="font-family:'宋体';">执行完</span>Waitfor<span style="font-family:'宋体';">，</span>Query1<span style="font-family:'宋体';">查询</span>Lock2<span style="font-family:'宋体';">，请求在资源上加</span>S<span style="font-family:'宋体';">锁，但该行已经被</span>Query2<span style="font-family:'宋体';">加上了</span>X<span style="font-family:'宋体';">锁；</span>Query2<span style="font-family:'宋体';">查询</span>Lock1<span style="font-family:'宋体';">，请求在资源上加</span>S<span style="font-family:'宋体';">锁，但该行已经被</span>Query1<span style="font-family:'宋体';">加上了</span>X<span style="font-family:'宋体';">锁；于是两个查询持有资源并互不相让，构成死锁。</span></p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><strong>(4).&nbsp;</strong><strong><span style="font-family:'宋体';">解决办法</span></strong></p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">a).&nbsp;<strong>SQL Server</strong><strong><span style="font-family:'宋体';">自动选择一条</span>SQL</strong><strong><span style="font-family:'宋体';">作死锁牺牲品</span></strong><span style="font-family:'宋体';">：运行完上面的两个查询后，我们会发现有一条</span>SQL<span style="font-family:'宋体';">能正常执行完毕，而另一个</span>SQL<span style="font-family:'宋体';">则报如下错误：</span></p> 
   <div style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"> 
    <span style="color:rgb(0,0,0);">服务器:&nbsp;消息&nbsp;</span>
    <span style="color:rgb(0,0,0);">1205</span>
    <span style="color:rgb(0,0,0);">，级别&nbsp;</span>
    <span style="color:rgb(0,0,0);">13</span>
    <span style="color:rgb(0,0,0);">，状态&nbsp;</span>
    <span style="color:rgb(0,0,0);">50</span>
    <span style="color:rgb(0,0,0);">，行&nbsp;</span>
    <span style="color:rgb(0,0,0);">1</span>
    <span style="color:rgb(0,0,0);"><br> 事务（进程&nbsp;ID&nbsp;&nbsp;xx）与另一个进程已被死锁在&nbsp;&nbsp;lock&nbsp;资源上，且该事务已被选作死锁牺牲品。请重新运行该事务。</span> 
   </div> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"></p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><span style="font-family:'宋体';">这就是上面第四节中介绍的<strong>锁监视器</strong>干活了。</span></p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">b).&nbsp;<strong><span style="font-family:'宋体';">按同一顺序访问对象：</span></strong><span style="font-family:'宋体';">颠倒任意一条</span>SQL<span style="font-family:'宋体';">中的</span>Update<span style="font-family:'宋体';">与</span>SELECT<span style="font-family:'宋体';">语句的顺序。例如修改第二条</span>SQL<span style="font-family:'宋体';">成如下：</span></p> 
   <div style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"> 
    <img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">
    <span style="color:rgb(0,128,128);">--</span>
    <span style="color:rgb(0,128,128);">Query2</span>
    <span style="color:rgb(0,128,128);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">Begin</span>&nbsp;
    <span style="color:rgb(0,0,255);">Tran</span>
    <span style="color:rgb(0,0,0);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">SELECT</span>&nbsp;
    <span style="color:rgb(128,128,128);">*</span>&nbsp;
    <span style="color:rgb(0,0,255);">FROM</span>
    <span style="color:rgb(0,0,0);">&nbsp;Lock1</span>
    <span style="color:rgb(0,128,128);">--</span>
    <span style="color:rgb(0,128,128);">在Lock1上申请S锁</span>
    <span style="color:rgb(0,128,128);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,0);">&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">WaitFor</span>
    <span style="color:rgb(0,0,0);">&nbsp;Delay&nbsp;</span>
    <span style="color:rgb(255,0,0);">'</span>
    <span style="color:rgb(255,0,0);">00:01:00</span>
    <span style="color:rgb(255,0,0);">'</span>
    <span style="color:rgb(0,0,0);">;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">Update</span>
    <span style="color:rgb(0,0,0);">&nbsp;Lock2&nbsp;</span>
    <span style="color:rgb(0,0,255);">Set</span>
    <span style="color:rgb(0,0,0);">&nbsp;C1</span>
    <span style="color:rgb(128,128,128);">=</span>
    <span style="color:rgb(0,0,0);">C1</span>
    <span style="color:rgb(128,128,128);">+</span>
    <span style="font-weight:bold;color:rgb(128,0,0);">1</span>
    <span style="color:rgb(0,0,0);">;</span>
    <span style="color:rgb(0,128,128);">--</span>
    <span style="color:rgb(0,128,128);">Lock2:RID:X</span>
    <span style="color:rgb(0,128,128);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">Rollback</span>&nbsp;
    <span style="color:rgb(0,0,255);">Tran</span>
    <span style="color:rgb(0,0,0);">;</span> 
   </div> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"></p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"></p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"></p> 
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">当然这样修改也是有代价的，这会导致第一条</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">SQL</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">执行完毕之前，第二条</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">SQL</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">一直处于阻塞状态。单独执行</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">Query1</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">或</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">Query2</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">需要约</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">1</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">分钟，但如果开始执行</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">Query1</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">时，马上同时执行</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">Query2</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">，则</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">Query2</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">需要</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">2</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">分钟才能执行完；这种按顺序请求资源从一定程度上<strong>降低了并发性。</strong></span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"></span> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;</p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">c).&nbsp;<strong>SELECT</strong><strong><span style="font-family:'宋体';">语句加</span>With(NoLock)</strong><strong><span style="font-family:'宋体';">提示</span></strong><span style="font-family:'宋体';">：默认情况下</span>SELECT<span style="font-family:'宋体';">语句会对查询到的资源加</span>S<span style="font-family:'宋体';">锁</span>(<span style="font-family:'宋体';">共享锁</span>)<span style="font-family:'宋体';">，</span>S<span style="font-family:'宋体';">锁与</span>X<span style="font-family:'宋体';">锁</span>(<span style="font-family:'宋体';">排他锁</span>)<span style="font-family:'宋体';">不兼容；但加上</span>With(NoLock)<span style="font-family:'宋体';">后，</span>SELECT<span style="font-family:'宋体';">不对查询到的资源加锁</span>(<span style="font-family:'宋体';">或者加</span>Sch-S<span style="font-family:'宋体';">锁，</span>Sch-S<span style="font-family:'宋体';">锁可以与任何锁兼容</span>)<span style="font-family:'宋体';">；从而可以是这两条</span>SQL可以并发地访问同一资源。当然，此方法适合解决读与写并发死锁的情况，但<strong>加With(NoLock)可能会导致脏读。</strong></p> 
   <div style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"> 
    <span style="color:rgb(0,0,255);">SELECT</span>&nbsp;
    <span style="color:rgb(128,128,128);">*</span>&nbsp;
    <span style="color:rgb(0,0,255);">FROM</span>
    <span style="color:rgb(0,0,0);">&nbsp;Lock2&nbsp;</span>
    <span style="color:rgb(0,0,255);">WITH</span>
    <span style="color:rgb(0,0,0);">(NOLock)<br></span>
    <span style="color:rgb(0,0,255);">SELECT</span>&nbsp;
    <span style="color:rgb(128,128,128);">*</span>&nbsp;
    <span style="color:rgb(0,0,255);">FROM</span>
    <span style="color:rgb(0,0,0);">&nbsp;Lock1&nbsp;</span>
    <span style="color:rgb(0,0,255);">WITH</span>
    <span style="color:rgb(0,0,0);">(NOLock)</span> 
   </div> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"></p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"></p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"></p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"></p> 
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">d).&nbsp;</span>
   <strong style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><span style="font-family:'宋体';">使用较低的隔离级别。</span></strong>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">SQL Server 2000</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">支持四种事务处理隔离级别</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">(TIL)</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">，分别为：</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">READ UNCOMMITTED</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">、</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">READ COMMITTED</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">、</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">REPEATABLE READ</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">、</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">SERIALIZABLE</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">；</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">SQL Server 2005</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">中增加了</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">SNAPSHOT TIL</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">。<strong>默认情况下，</strong></span>
   <strong style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">SQL Server</strong>
   <strong style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><span style="font-family:'宋体';">使用</span>READ COMMITTED TIL</strong>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">，我们可以在上面的两条</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">SQL</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">前都加上一句</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">，来<strong>降低</strong></span>
   <strong style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">TIL</strong>
   <strong style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><span style="font-family:'宋体';">以避免死锁</span></strong>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">；事实上，运行在</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">READ UNCOMMITTED TIL</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">的事务，其中的</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">SELECT</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">语句不对结果资源加锁或加</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">Sch-S</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">锁，而不会加</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">S</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">锁；但还有一点需要注意的是：</span>
   <strong style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">READ UNCOMMITTED TIL</strong>
   <strong style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><span style="font-family:'宋体';">允许脏读</span></strong>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">，虽然加上了降低</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">TIL</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">的语句后，上面两条</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">SQL</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">在执行过程中不会报错，但执行结果是一个返回</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">1</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">，一个返回</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">2</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">，即读到了脏数据，也许这并不是我们所期望的。</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"></span> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;</p> 
   <p style="text-indent:21pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">e).&nbsp;<span style="font-family:'宋体';">在</span>SQL<span style="font-family:'宋体';">前加</span>SET LOCK_TIMEOUT timeout_period<span style="font-family:'宋体';">，当请求锁超过设定的</span>timeout_period<span style="font-family:'宋体';">时间后，就会终止当前</span>SQL<span style="font-family:'宋体';">的执行，牺牲自己，成全别人。</span></p> 
   <p style="text-indent:21pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">f).&nbsp;<strong><span style="font-family:'宋体';">使用基于行版本控制的隔离级别</span>(SQL Server 2005</strong><strong><span style="font-family:'宋体';">支持</span>)</strong><span style="font-family:'宋体';">：开启下面的选项后，</span>SELECT<span style="font-family:'宋体';">不会对请求的资源加</span>S<span style="font-family:'宋体';">锁，不加锁或者加</span>Sch-S<span style="font-family:'宋体';">锁，<strong>从而将读与写操作之间发生的死锁几率降至最低；而且不会发生脏读。</strong>啊</span></p> 
   <div style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"> 
    <span style="color:rgb(0,0,255);">SET</span>
    <span style="color:rgb(0,0,0);">&nbsp;ALLOW_SNAPSHOT_ISOLATION&nbsp;</span>
    <span style="color:rgb(0,0,255);">ON</span>
    <span style="color:rgb(0,0,0);"><br></span>
    <span style="color:rgb(0,0,255);">SET</span>
    <span style="color:rgb(0,0,0);">&nbsp;READ_COMMITTED_SNAPSHOT&nbsp;</span>
    <span style="color:rgb(0,0,255);">ON</span> 
   </div> 
   <p style="text-indent:21pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"></p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"></p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;</p> 
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; g).&nbsp;</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">使用绑定连接</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">(</span>
   <span style="color:rgb(57,57,57);font-size:14px;line-height:21px;font-family:'宋体';">使用方法见下一个示例。</span>
   <span style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">)</span> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;</p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;</p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><strong>5.2&nbsp;</strong><strong><span style="font-family:'宋体';">程序死锁</span>(SQL</strong><strong><span style="font-family:'宋体';">阻塞</span>)</strong></p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><span style="font-family:'宋体';">看一个例子：<a href="http://www.cnblogs.com/kaima/archive/2008/04/24/1167550.html" rel="nofollow" style="color:rgb(100,102,179);">一个典型的数据库操作事务死锁分析</a></span><span style="font-family:'宋体';">，按照我自己的理解，我觉得这应该算是</span>C#<span style="font-family:'宋体';">程序中出现死锁，而不是数据库中的死锁；下面的代码模拟了该文中对数据库的操作过程：</span></p> 
   <div style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"> 
    <img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">
    <span style="color:rgb(0,128,0);">//</span>
    <span style="color:rgb(0,128,0);">略去的无关的code</span>
    <span style="color:rgb(0,128,0);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,0);">SqlConnection&nbsp;conn&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>&nbsp;
    <span style="color:rgb(0,0,255);">new</span>
    <span style="color:rgb(0,0,0);">&nbsp;SqlConnection(connectionString);<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">conn.Open();<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">SqlTransaction&nbsp;tran&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>
    <span style="color:rgb(0,0,0);">&nbsp;conn.BeginTransaction();<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">string</span>
    <span style="color:rgb(0,0,0);">&nbsp;sql1&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>&nbsp;
    <span style="color:rgb(128,0,0);">"</span>
    <span style="color:rgb(128,0,0);">Update&nbsp;Lock1&nbsp;SET&nbsp;C1=C1+1</span>
    <span style="color:rgb(128,0,0);">"</span>
    <span style="color:rgb(0,0,0);">;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">string</span>
    <span style="color:rgb(0,0,0);">&nbsp;sql2&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>&nbsp;
    <span style="color:rgb(128,0,0);">"</span>
    <span style="color:rgb(128,0,0);">SELECT&nbsp;*&nbsp;FROM&nbsp;Lock1</span>
    <span style="color:rgb(128,0,0);">"</span>
    <span style="color:rgb(0,0,0);">;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">ExecuteNonQuery(tran,&nbsp;sql1);&nbsp;</span>
    <span style="color:rgb(0,128,0);">//</span>
    <span style="color:rgb(0,128,0);">使用事务:事务中Lock了Table</span>
    <span style="color:rgb(0,128,0);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,0);">ExecuteNonQuery(</span>
    <span style="color:rgb(0,0,255);">null</span>
    <span style="color:rgb(0,0,0);">,&nbsp;sql2);&nbsp;</span>
    <span style="color:rgb(0,128,0);">//</span>
    <span style="color:rgb(0,128,0);">新开一个connection来读取Table</span>
    <span style="color:rgb(0,128,0);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,0);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">public</span>&nbsp;
    <span style="color:rgb(0,0,255);">static</span>&nbsp;
    <span style="color:rgb(0,0,255);">void</span>
    <span style="color:rgb(0,0,0);">&nbsp;ExecuteNonQuery(SqlTransaction&nbsp;tran,&nbsp;</span>
    <span style="color:rgb(0,0,255);">string</span>
    <span style="color:rgb(0,0,0);">&nbsp;sql)<br><img src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockStart.gif" align="top" style="border:0px;" alt="ExpandedBlockStart.gif"></span>
    <span><span style="color:rgb(0,0,0);">{<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;SqlCommand&nbsp;cmd&nbsp;</span><span style="color:rgb(0,0,0);">=</span>&nbsp;<span style="color:rgb(0,0,255);">new</span><span style="color:rgb(0,0,0);">&nbsp;SqlCommand(sql);<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:rgb(0,0,255);">if</span><span style="color:rgb(0,0,0);">&nbsp;(tran&nbsp;</span><span style="color:rgb(0,0,0);">!=</span>&nbsp;<span style="color:rgb(0,0,255);">null</span><span style="color:rgb(0,0,0);">)<br><img src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif" align="top" style="border:0px;" alt="ExpandedSubBlockStart.gif">&nbsp;&nbsp;&nbsp;&nbsp;</span><span><span style="color:rgb(0,0,0);">{<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd.Connection&nbsp;</span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);">&nbsp;tran.Connection;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd.Transaction&nbsp;</span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);">&nbsp;tran;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd.ExecuteNonQuery();<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span><span style="color:rgb(0,0,0);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:rgb(0,0,255);">else</span><span style="color:rgb(0,0,0);"><br><img src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif" align="top" style="border:0px;" alt="ExpandedSubBlockStart.gif">&nbsp;&nbsp;&nbsp;&nbsp;</span><span><span style="color:rgb(0,0,0);">{<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:rgb(0,0,255);">using</span><span style="color:rgb(0,0,0);">&nbsp;(SqlConnection&nbsp;conn&nbsp;</span><span style="color:rgb(0,0,0);">=</span>&nbsp;<span style="color:rgb(0,0,255);">new</span><span style="color:rgb(0,0,0);">&nbsp;SqlConnection(connectionString))<br><img src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif" align="top" style="border:0px;" alt="ExpandedSubBlockStart.gif">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span><span style="color:rgb(0,0,0);">{<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;conn.Open();<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd.Connection&nbsp;</span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);">&nbsp;conn;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd.ExecuteNonQuery();<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span><span style="color:rgb(0,0,0);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif" align="top" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span><span style="color:rgb(0,0,0);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockEnd.gif" align="top" style="border:0px;">}</span></span> 
   </div> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"></p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><span style="font-family:'宋体';">执行到</span><span style="font-size:11pt;font-family:Consolas;">ExecuteNonQuery(<span style="color:#0000FF;">null</span>, sql2)</span><span style="font-size:11pt;font-family:'宋体';">时抛出</span><span style="font-size:11pt;font-family:Consolas;">SQL</span><span style="font-size:11pt;font-family:'宋体';">执行超时的异常，下图从数据库的角度来看该问题：</span></p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img height="79" alt="" src="https://images.cnblogs.com/cnblogs_com/happyhippy/DB/DBLock3.JPG" width="522" style="border:0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><span style="font-family:'宋体';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;代码从上往下执行，会话</span>1<span style="font-family:'宋体';">持有了表</span>Lock1<span style="font-family:'宋体';">的</span>X<span style="font-family:'宋体';">锁，且事务没有结束，回话</span>1<span style="font-family:'宋体';">就一直持有</span>X<span style="font-family:'宋体';">锁不释放；而会话</span>2<span style="font-family:'宋体';">执行</span>select<span style="font-family:'宋体';">操作，请求在表</span>Lock1<span style="font-family:'宋体';">上加</span>S<span style="font-family:'宋体';">锁，但</span>S<span style="font-family:'宋体';">锁与</span>X<span style="font-family:'宋体';">锁是不兼容的，所以回话</span>2<span style="font-family:'宋体';">的被阻塞等待，不在等待中，就在等待中获得资源，就在等待中超时。。。从中我们可以看到，里面并没有出现死锁，而只是</span>SELECT<span style="font-family:'宋体';">操作被阻塞了。也正因为不是数据库死锁，所以</span>SQL Server<span style="font-family:'宋体';">的锁监视器无法检测到死锁。</span></p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family:'宋体';">我们再从</span>C#<span style="font-family:'宋体';">程序的角度来看该问题：</span></p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img height="222" alt="" src="https://images.cnblogs.com/cnblogs_com/happyhippy/DB/DBLock4.JPG" width="376" style="border:0px;">&nbsp;</p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; C#<span style="font-family:'宋体';">程序持有了表</span>Lock1<span style="font-family:'宋体';">上的</span>X<span style="font-family:'宋体';">锁，同时开了另一个</span>SqlConnection<span style="font-family:'宋体';">还想在该表上请求一把</span>S<span style="font-family:'宋体';">锁，图中已经构成了环路；太贪心了，结果自己把自己给锁死了。。。</span></p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family:'宋体';">虽然这不是一个数据库死锁，但却是因为数据库资源而导致的死锁，上例中提到的解决死锁的方法在这里也基本适用，主要是避免读操作被阻塞，解决方法如下：</span></p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; a).&nbsp;<strong><span style="font-family:'宋体';">把</span>SELECT<span style="font-family:'宋体';">放在</span>Update<span style="font-family:'宋体';">语句前：</span></strong>SELECT<span style="font-family:'宋体';">不在事务中，且执行完毕会释放</span>S<span style="font-family:'宋体';">锁；<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; b).&nbsp;<strong><span style="font-family:'宋体';">把</span>SELECT<span style="font-family:'宋体';">也放加入到事务中：</span></strong><span style="font-size:11pt;font-family:Consolas;">ExecuteNonQuery(tran, sql2);<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c).&nbsp;<strong>SELECT</strong><strong><span style="font-family:'宋体';">加</span>With(NOLock)</strong><span style="font-family:'宋体';"><strong>提示：</strong>可能产生脏读；<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; d).&nbsp;<span style="font-family:'宋体';"><strong>降低事务隔离级别：</strong></span>SELECT<span style="font-family:'宋体';">语句前加</span>SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED<span style="font-family:'宋体';">；同上，可能产生脏读；<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e).&nbsp;<span style="font-family:'宋体';"><strong>使用基于行版本控制的隔离级别</strong>（同上例）。<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; g).&nbsp;<span style="font-family:'宋体';"><strong>使用绑定连接：</strong>取得事务所在会话的</span>token<span style="font-family:'宋体';">，然后传入新开的</span>connection<span style="font-family:'宋体';">中；执行</span>EXEC sp_bindsession @Token<span style="font-family:'宋体';">后绑定了连接，最后执行</span>exec sp_bindsession null;<span style="font-family:'宋体';">来取消绑定；最后需要注意的四点是：<br> &nbsp;&nbsp;&nbsp;&nbsp;</span>(1).&nbsp;<span style="font-family:'宋体';">使用了绑定连接的多个</span>connection<span style="font-family:'宋体';">共享同一个事务和相同的锁，但各自保留自己的事务隔离级别；<br> &nbsp;&nbsp;&nbsp;&nbsp;</span>(2).&nbsp;<span style="font-family:'宋体';">如果在</span>sql3<span style="font-family:'宋体';">字符串的“</span>exec sp_bindsession null<span style="font-family:'宋体';">”换成“</span>commit tran<span style="font-family:'宋体';">”或者“</span>rollback tran<span style="font-family:'宋体';">”，则会提交整个事务，最后一行</span>C#<span style="font-family:'宋体';">代码</span>tran.Commit()<span style="font-family:'宋体';">就可以不用执行了</span>(<span style="font-family:'宋体';">执行会报错，因为事务已经结束了</span>-,-)<span style="font-family:'宋体';">。<br> &nbsp;&nbsp;&nbsp;&nbsp;</span>(3).&nbsp;<span style="font-family:'宋体';">开启事务</span>(begin tran)<span style="font-family:'宋体';">后，才可以调用</span>exec sp_getbindtoken @Token out<span style="font-family:'宋体';">来取得</span>Token<span style="font-family:'宋体';">；如果不想再新开的</span>connection<span style="font-family:'宋体';">中结束掉原有的事务，则在这个</span>connection close<span style="font-family:'宋体';">之前，必须执行“</span>exec sp_bindsession null<span style="font-family:'宋体';">”来取消绑定连接，或者在新开的</span>connectoin close<span style="font-family:'宋体';">之前先结束掉事务</span>(commit/tran)<span style="font-family:'宋体';">。<br> &nbsp;&nbsp;&nbsp;&nbsp;</span>(4). (Sql server 2005&nbsp;<span style="font-family:'宋体';">联机丛书</span>)<span style="font-family:'宋体';">后续版本的</span>&nbsp;Microsoft SQL Server&nbsp;<span style="font-family:'宋体';">将删除该功能。请避免在新的开发工作中使用该功能，并着手修改当前还在使用该功能的应用程序。</span>&nbsp;<span style="font-family:'宋体';">请改用多个活动结果集</span>&nbsp;(MARS)&nbsp;<span style="font-family:'宋体';">或分布式事务。</span></p> 
   <div style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"> 
    <img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">
    <span style="color:rgb(0,0,0);">tran&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>
    <span style="color:rgb(0,0,0);">&nbsp;connection.BeginTransaction();<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">string</span>
    <span style="color:rgb(0,0,0);">&nbsp;sql1&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>&nbsp;
    <span style="color:rgb(128,0,0);">"</span>
    <span style="color:rgb(128,0,0);">Update&nbsp;Lock1&nbsp;SET&nbsp;C1=C1+1</span>
    <span style="color:rgb(128,0,0);">"</span>
    <span style="color:rgb(0,0,0);">;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">ExecuteNonQuery(tran,&nbsp;sql1);&nbsp;</span>
    <span style="color:rgb(0,128,0);">//</span>
    <span style="color:rgb(0,128,0);">使用事务:事务中Lock了测试表Lock1</span>
    <span style="color:rgb(0,128,0);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">string</span>
    <span style="color:rgb(0,0,0);">&nbsp;sql2&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>&nbsp;
    <span style="color:rgb(128,0,0);">@"</span>
    <span style="color:rgb(128,0,0);">DECLARE&nbsp;@Token&nbsp;varchar(255);<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">exec&nbsp;sp_getbindtoken&nbsp;@Token&nbsp;out;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">SELECT&nbsp;@Token;</span>
    <span style="color:rgb(128,0,0);">"</span>
    <span style="color:rgb(0,0,0);">;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">string</span>
    <span style="color:rgb(0,0,0);">&nbsp;token&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>
    <span style="color:rgb(0,0,0);">&nbsp;ExecuteScalar(tran,&nbsp;sql2).ToString();<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,255);">string</span>
    <span style="color:rgb(0,0,0);">&nbsp;sql3&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>&nbsp;
    <span style="color:rgb(128,0,0);">"</span>
    <span style="color:rgb(128,0,0);">EXEC&nbsp;sp_bindsession&nbsp;@Token;Update&nbsp;Lock1&nbsp;SET&nbsp;C1=C1+1;exec&nbsp;sp_bindsession&nbsp;null;</span>
    <span style="color:rgb(128,0,0);">"</span>
    <span style="color:rgb(0,0,0);">;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">SqlParameter&nbsp;parameter&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>&nbsp;
    <span style="color:rgb(0,0,255);">new</span>
    <span style="color:rgb(0,0,0);">&nbsp;SqlParameter(</span>
    <span style="color:rgb(128,0,0);">"</span>
    <span style="color:rgb(128,0,0);">@Token</span>
    <span style="color:rgb(128,0,0);">"</span>
    <span style="color:rgb(0,0,0);">,&nbsp;SqlDbType.VarChar);<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">parameter.Value&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>
    <span style="color:rgb(0,0,0);">&nbsp;token;<br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;">ExecuteNonQuery(</span>
    <span style="color:rgb(0,0,255);">null</span>
    <span style="color:rgb(0,0,0);">,&nbsp;sql3,&nbsp;parameter);&nbsp;</span>
    <span style="color:rgb(0,128,0);">//</span>
    <span style="color:rgb(0,128,0);">新开一个connection来操作测试表Lock1</span>
    <span style="color:rgb(0,128,0);"><br><img alt="" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" style="border:0px;"></span>
    <span style="color:rgb(0,0,0);">tran.Commit();</span> 
   </div> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;</p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;</p> 
   <p style="text-indent:21pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"></p> 
   <p style="color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><strong><span style="font-size:12pt;font-family:'宋体';">附：锁兼容性</span></strong><strong><span style="font-size:12pt;">(FROM SQL Server 2005&nbsp;</span></strong><strong><span style="font-size:12pt;font-family:'宋体';">联机丛书</span></strong><strong><span style="font-size:12pt;">)</span></strong></p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><span style="font-family:'宋体';">锁兼容性控制多个事务能否同时获取同一资源上的锁。如果资源已被另一事务锁定，则仅当请求锁的模式与现有锁的模式相兼容时，才会授予新的锁请求。如果请求锁的模式与现有锁的模式不兼容，则请求新锁的事务将等待释放现有锁或等待锁超时间隔过期。<br><img height="524" alt="" src="https://images.cnblogs.com/cnblogs_com/happyhippy/DB/SQLServerLock.JPG" width="658" style="border:0px;"></span></p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><span style="font-family:'宋体';">作者: Silent Void&nbsp;&nbsp;<br> &nbsp;&nbsp;&nbsp; 主页:&nbsp;<a href="http://www.cnblogs.com/happyhippy/" rel="nofollow" style="color:rgb(100,102,179);">http://www.cnblogs.com/happyhippy/</a><br> &nbsp;&nbsp;&nbsp; URL:&nbsp;<a href="http://www.cnblogs.com/happyhippy/archive/2008/11/14/1333922.html" rel="nofollow" style="color:rgb(100,102,179);">http://www.cnblogs.com/happyhippy/archive/2008/11/14/1333922.html</a></span></p> 
   <p style="text-indent:21.75pt;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><br></p> 
   <p style="text-indent:21.75pt;"><font color="#393939"><span style="font-size:14px;line-height:21px;">本文转自温景良博客园博客，原文链接：http://www.cnblogs.com/wenjl520/archive/2008/11/15/1333965.html</span></font><span style="font-size:14px;line-height:21px;color:rgb(57,57,57);font-family:Verdana, Arial, Helvetica, sans-serif;text-indent:21.75pt;">，如需转载请自行联系原作者</span></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
