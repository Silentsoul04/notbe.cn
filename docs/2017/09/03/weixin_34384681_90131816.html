<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Android -- ViewRoot，关于子线程刷新UI « NotBeCN</title>
  <meta name="description" content="                             Android在4.0之后执行线程更新UI操作会报异常：CalledFromWrongThreadException：Only the original thread that created a view hierarchy can touch its ...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/09/03/weixin_34384681_90131816.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">Android -- ViewRoot，关于子线程刷新UI</h1>
    <p class="post-meta">Sep 3, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <div>
    <br>
   </div> 
   <div> 
    <p style="line-height:24px;color:rgb(153,153,153);font-family:'Comic Sans MS', '微软雅黑', '宋体', Arial;font-size:15px;">Android在4.0之后执行线程更新UI操作会报异常：<span style="color:rgb(255,0,0);">CalledFromWrongThreadException：Only the original thread that created a view hierarchy can touch its views.</span>那么你肯定能看到很多文章说android里子线程不能刷新UI。这句话不能说错，只是有些不太严谨。<strong><span style="color:rgb(255,0,0);">其实线程能否刷新UI的关键在于ViewRoot是否属于该线程。</span></strong></p> 
    <p style="line-height:24px;color:rgb(153,153,153);font-family:'Comic Sans MS', '微软雅黑', '宋体', Arial;font-size:15px;">首先，CalledFromWrongThreadException这个异常是有下面的代码抛出的：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(153,153,153);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre><span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> checkThread() {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (mThread !=<span style="line-height:1.5;"> Thread.currentThread()) {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">throw</span> <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> CalledFromWrongThreadException(
                    </span>"Only the original thread that created a view hierarchy can touch its views."<span style="line-height:1.5;">);
        }
}</span></pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(153,153,153);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="line-height:24px;color:rgb(153,153,153);font-family:'Comic Sans MS', '微软雅黑', '宋体', Arial;font-size:15px;">该段代码出自 framework/base/core/java/android/view/ViewRoot.java</p> 
    <p style="line-height:24px;color:rgb(153,153,153);font-family:'Comic Sans MS', '微软雅黑', '宋体', Arial;font-size:15px;">其次，看看RootView的构造函数：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(153,153,153);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> ViewRoot(Context context) {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">super</span><span style="line-height:1.5;">();
        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (MEASURE_LATENCY &amp;&amp; lt == <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">) {
            lt </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> LatencyTimer(100, 1000<span style="line-height:1.5;">);
        }
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> For debug only
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">++sInstanceCount;
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> Initialize the statics when this class is first instantiated. This is
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> done here instead of in the static block because Zygote does not
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> allow the spawning of threads.</span>
<span style="line-height:1.5;">        getWindowSession(context.getMainLooper());    

        mThread </span>=<span style="line-height:1.5;"> Thread.currentThread();

        mLocation </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> WindowLeaked(<span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">);

        mLocation.fillInStackTrace();

        mWidth </span>= -1<span style="line-height:1.5;">;

        mHeight </span>= -1<span style="line-height:1.5;">;

        mDirty </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> Rect();

        mTempRect </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> Rect();

        mVisRect </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> Rect();

        mWinFrame </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> Rect();

        mWindow </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> W(<span style="color:rgb(0,0,255);line-height:1.5;">this</span><span style="line-height:1.5;">, context);

        mInputMethodCallback </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> InputMethodCallback(<span style="color:rgb(0,0,255);line-height:1.5;">this</span><span style="line-height:1.5;">);

        mViewVisibility </span>=<span style="line-height:1.5;"> View.GONE;

        mTransparentRegion </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> Region();

        mPreviousTransparentRegion </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> Region();

        mFirst </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span>; <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> true for the first time the view is added</span>
<span style="line-height:1.5;">
        mAdded </span>= <span style="color:rgb(0,0,255);line-height:1.5;">false</span><span style="line-height:1.5;">;

        mAttachInfo </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> View.AttachInfo(sWindowSession, mWindow, <span style="color:rgb(0,0,255);line-height:1.5;">this</span>, <span style="color:rgb(0,0,255);line-height:1.5;">this</span><span style="line-height:1.5;">);

        mViewConfiguration </span>=<span style="line-height:1.5;"> ViewConfiguration.get(context);

        mDensity </span>=<span style="line-height:1.5;"> context.getResources().getDisplayMetrics().densityDpi;
    }</span></pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(153,153,153);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="line-height:24px;color:rgb(153,153,153);font-family:'Comic Sans MS', '微软雅黑', '宋体', Arial;font-size:15px;">最后，我们看看ViewRoot.checkThread的调用顺序：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(153,153,153);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre><span style="line-height:1.5;">com.david.test.helloworld.MainActivity$TestThread2.run

  </span>-&gt;<span style="line-height:1.5;"> android.widget.TextView.setText

    </span>-&gt;<span style="line-height:1.5;"> android.widget.TextView.checkForRelayout

      </span>-&gt;<span style="line-height:1.5;"> android.view.View.invalidate

        </span>-&gt;<span style="line-height:1.5;"> android.view.ViewGroup.invalidateChild

          </span>-&gt;<span style="line-height:1.5;"> android.view.ViewRoot.invalidateChildInParent

            </span>-&gt;<span style="line-height:1.5;"> android.view.ViewRoot.invalidateChild

              </span>-&gt; android.view.ViewRoot.checkThread</pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(153,153,153);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="line-height:24px;color:rgb(153,153,153);font-family:'Comic Sans MS', '微软雅黑', '宋体', Arial;font-size:15px;">到这里相信网友已经明白CalledFromWrongThreadException为什么出现了。那到底非主线程以外的线程能否刷新UI呢？答案当然是能，前提条件是它要拥有自己的ViewRoot。如果你要直接创建ViewRoot的实例的话，你会失望的发现不能找到这个类。那么我们要如何做呢？让我们用实例来说说吧，代码如下：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(153,153,153);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre><span style="color:rgb(0,0,255);line-height:1.5;">class</span> TestThread1 <span style="color:rgb(0,0,255);line-height:1.5;">extends</span><span style="line-height:1.5;"> Thread{
              @Override
              </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> run() {
                     Looper.prepare();                    
                     TextView tx </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> TextView(MainActivity.<span style="color:rgb(0,0,255);line-height:1.5;">this</span><span style="line-height:1.5;">);
                     tx.setText(</span>"test11111111111111111"<span style="line-height:1.5;">);                         
                     WindowManager wm </span>= MainActivity.<span style="color:rgb(0,0,255);line-height:1.5;">this</span><span style="line-height:1.5;">.getWindowManager();
                  WindowManager.LayoutParams params </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> WindowManager.LayoutParams(
</span>250, 250, 200, 200<span style="line-height:1.5;">, WindowManager.LayoutParams.FIRST_SUB_WINDOW,
                        WindowManager.LayoutParams.TYPE_TOAST,PixelFormat.OPAQUE);
                   
                     wm.addView(tx, params);
                     Looper.loop();
              }
    }</span></pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(153,153,153);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="line-height:24px;color:rgb(153,153,153);font-family:'Comic Sans MS', '微软雅黑', '宋体', Arial;font-size:15px;">MainActivity是建立android工程时生成的入口类，TestThread1是MainActivity的内部类。感兴趣的话，试试吧！看看是不是在屏幕上看到了"test11111111111111111"？</p> 
    <p style="line-height:24px;color:rgb(153,153,153);font-family:'Comic Sans MS', '微软雅黑', '宋体', Arial;font-size:15px;">最后，说说那里创建了ViewRoot，这里：wm.addView(tx, params)。还是看看具体流程吧：</p> 
    <p style="line-height:24px;color:rgb(153,153,153);font-family:'Comic Sans MS', '微软雅黑', '宋体', Arial;font-size:15px;">WindowManagerImpl.addView(View view, ViewGroup.LayoutParams params)</p> 
    <p style="line-height:24px;color:rgb(153,153,153);font-family:'Comic Sans MS', '微软雅黑', '宋体', Arial;font-size:15px;">-&gt; WindowManagerImpl.addView(View view, ViewGroup.LayoutParams params, boolean nest)</p> 
    <p style="line-height:24px;color:rgb(153,153,153);font-family:'Comic Sans MS', '微软雅黑', '宋体', Arial;font-size:15px;">奥妙就在这里，具体看看代码吧！</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(153,153,153);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span> addView(View view, ViewGroup.LayoutParams params, <span style="color:rgb(0,0,255);line-height:1.5;">boolean</span><span style="line-height:1.5;"> nest)
{
        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (Config.LOGV) Log.v("WindowManager", "addView view=" +<span style="line-height:1.5;"> view); 

        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (!(params <span style="color:rgb(0,0,255);line-height:1.5;">instanceof</span><span style="line-height:1.5;"> WindowManager.LayoutParams)) {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">throw</span> <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> IllegalArgumentException(
                    </span>"Params must be WindowManager.LayoutParams"<span style="line-height:1.5;">);
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">final</span><span style="line-height:1.5;"> WindowManager.LayoutParams wparams
                </span>=<span style="line-height:1.5;"> (WindowManager.LayoutParams)params;
       
        ViewRoot root;
        View panelParentView </span>= <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">;
     
        </span><span style="color:rgb(0,0,255);line-height:1.5;">synchronized</span> (<span style="color:rgb(0,0,255);line-height:1.5;">this</span><span style="line-height:1.5;">) {

            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> Here's an odd/questionable case: if someone tries to add a
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> view multiple times, then we simply bump up a nesting count
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> and they need to remove the view the corresponding number of
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> times to have it actually removed from the window manager.
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> This is useful specifically for the notification manager,
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> which can continually add/remove the same view as a
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> notification gets updated.</span>
            <span style="color:rgb(0,0,255);line-height:1.5;">int</span> index = findViewLocked(view, <span style="color:rgb(0,0,255);line-height:1.5;">false</span><span style="line-height:1.5;">);

            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (index &gt;= 0<span style="line-height:1.5;">) {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (!<span style="line-height:1.5;">nest) {
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">throw</span> <span style="color:rgb(0,0,255);line-height:1.5;">new</span> IllegalStateException("View " +<span style="line-height:1.5;"> view
                            </span>+ " has already been added to the window manager."<span style="line-height:1.5;">);
                }
                root </span>=<span style="line-height:1.5;"> mRoots[index];
                root.mAddNesting</span>++<span style="line-height:1.5;">;

                </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> Update layout parameters.</span>
<span style="line-height:1.5;">                view.setLayoutParams(wparams);
                root.setLayoutParams(wparams, </span><span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">);
                </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;">;
            }
         
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> If this is a panel window, then find the window it is being
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> attached to for future reference.</span>
            <span style="color:rgb(0,0,255);line-height:1.5;">if</span> (wparams.type &gt;= WindowManager.LayoutParams.FIRST_SUB_WINDOW &amp;&amp;<span style="line-height:1.5;">
                    wparams.type </span>&lt;=<span style="line-height:1.5;"> WindowManager.LayoutParams.LAST_SUB_WINDOW) {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">final</span> <span style="color:rgb(0,0,255);line-height:1.5;">int</span> count = mViews != <span style="color:rgb(0,0,255);line-height:1.5;">null</span> ? mViews.length : 0<span style="line-height:1.5;">;
                </span><span style="color:rgb(0,0,255);line-height:1.5;">for</span> (<span style="color:rgb(0,0,255);line-height:1.5;">int</span> i=0; i&lt;count; i++<span style="line-height:1.5;">) {
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (mRoots[i].mWindow.asBinder() ==<span style="line-height:1.5;"> wparams.token) {
                        panelParentView </span>=<span style="line-height:1.5;"> mViews[i];
                    }
                }
            }
          
            root </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> ViewRoot(view.getContext());
            root.mAddNesting </span>= 1<span style="line-height:1.5;">;
            view.setLayoutParams(wparams);
           
            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (mViews == <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">) {
                index </span>= 1<span style="line-height:1.5;">;
                mViews </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> View[1<span style="line-height:1.5;">];
                mRoots </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> ViewRoot[1<span style="line-height:1.5;">];
                mParams </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> WindowManager.LayoutParams[1<span style="line-height:1.5;">];
            } </span><span style="color:rgb(0,0,255);line-height:1.5;">else</span><span style="line-height:1.5;"> {
                index </span>= mViews.length + 1<span style="line-height:1.5;">;
                Object[] old </span>=<span style="line-height:1.5;"> mViews;
                mViews </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> View[index];
                System.arraycopy(old, </span>0, mViews, 0, index-1<span style="line-height:1.5;">);
                old </span>=<span style="line-height:1.5;"> mRoots;
                mRoots </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> ViewRoot[index];
                System.arraycopy(old, </span>0, mRoots, 0, index-1<span style="line-height:1.5;">);
                old </span>=<span style="line-height:1.5;"> mParams;
                mParams </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> WindowManager.LayoutParams[index];
                System.arraycopy(old, </span>0, mParams, 0, index-1<span style="line-height:1.5;">);
            }
            index</span>--<span style="line-height:1.5;">;
            mViews[index] </span>=<span style="line-height:1.5;"> view;
            mRoots[index] </span>=<span style="line-height:1.5;"> root;
            mParams[index] </span>=<span style="line-height:1.5;"> wparams;
        
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> do this last because it fires off messages to start doing things</span>
<span style="line-height:1.5;">        root.setView(view, wparams, panelParentView);
}</span></pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(153,153,153);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="line-height:24px;color:rgb(153,153,153);font-family:'Comic Sans MS', '微软雅黑', '宋体', Arial;font-size:15px;">出自：frameworks/base/core/java/android/view/WindowManagerImpl.java</p> 
    <p style="line-height:24px;color:rgb(153,153,153);font-family:'Comic Sans MS', '微软雅黑', '宋体', Arial;font-size:15px;">Ok，相信到了这里，大家都已经明白了：<strong>子线程是能够刷新UI的！！！</strong></p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(153,153,153);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span> TestActivity <span style="color:rgb(0,0,255);line-height:1.5;">extends</span><span style="line-height:1.5;"> Activity {

    Button btn </span>= <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">;

    </span><span style="color:rgb(0,128,0);line-height:1.5;">/**</span><span style="color:rgb(0,128,0);line-height:1.5;"> Called when the activity is first created. </span><span style="color:rgb(0,128,0);line-height:1.5;">*/</span>
    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> onCreate(Bundle savedInstanceState) {
       </span><span style="color:rgb(0,0,255);line-height:1.5;">super</span><span style="line-height:1.5;">.onCreate(savedInstanceState);
       setContentView(R.layout.main); 
       btn </span>=<span style="line-height:1.5;"> (Button) findViewById(R.id.Button01);
       TestThread2 t </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> TestThread2(btn);
       t.start();
    }

    </span><span style="color:rgb(0,0,255);line-height:1.5;">class</span> TestThread2 <span style="color:rgb(0,0,255);line-height:1.5;">extends</span><span style="line-height:1.5;"> Thread {
       Button btn </span>= <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">;
       </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> TestThread2(Button btn) {
           </span><span style="color:rgb(0,0,255);line-height:1.5;">this</span>.btn =<span style="line-height:1.5;"> btn;
       }
       @Override
       </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> run() {
           btn.setText(</span>"TestThread2.run"<span style="line-height:1.5;">);
       }
    }
}</span></pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(153,153,153);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="line-height:24px;color:rgb(153,153,153);font-family:'Comic Sans MS', '微软雅黑', '宋体', Arial;font-size:15px;">建立一个工程，将上述代码拷贝进去，运行看看吧! Btn的文本一定改变为"TestThread2.run"了。</p> 
    <p style="line-height:24px;color:rgb(153,153,153);font-family:'Comic Sans MS', '微软雅黑', '宋体', Arial;font-size:15px;">那么这到底是怎么回事呢？当我发现这个问题时，也困惑了。经过一番调查后，真相大白。现在和大家分享一下。奥秘在于ViewRoot的建立时间，它是在ActivityThread.java的<strong><span style="color:rgb(255,0,0);">final void handleResumeActivity(IBinder token, boolean clearHide, boolean isForward)</span></strong>里创建的。</p> 
    <p style="line-height:24px;color:rgb(153,153,153);font-family:'Comic Sans MS', '微软雅黑', '宋体', Arial;font-size:15px;">看看代码吧：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(153,153,153);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre><span style="color:rgb(0,0,255);line-height:1.5;">final</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span> handleResumeActivity(IBinder token, <span style="color:rgb(0,0,255);line-height:1.5;">boolean</span> clearHide, <span style="color:rgb(0,0,255);line-height:1.5;">boolean</span><span style="line-height:1.5;"> isForward) {
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> If we are getting ready to gc after going to the background, well
       </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> we are back active so skip it.</span>
<span style="line-height:1.5;">        unscheduleGcIdler();
        ActivityRecord r </span>=<span style="line-height:1.5;"> performResumeActivity(token, clearHide);
        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (r != <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">) {
           </span><span style="color:rgb(0,0,255);line-height:1.5;">final</span> Activity a =<span style="line-height:1.5;"> r.activity;
            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> (localLOGV) Slog.v(
                TAG, </span>"Resume " + r + " started activity: " +<span style="line-height:1.5;">
                a.mStartedActivity </span>+ ", hideForNow: " +<span style="line-height:1.5;"> r.hideForNow
                </span>+ ", finished: " +<span style="line-height:1.5;"> a.mFinished); 
            </span><span style="color:rgb(0,0,255);line-height:1.5;">final</span> <span style="color:rgb(0,0,255);line-height:1.5;">int</span> forwardBit = isForward ?<span style="line-height:1.5;">
                    WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION : </span>0<span style="line-height:1.5;">;
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> If the window hasn't yet been added to the window manager,
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> and this guy didn't finish itself or start another activity,
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> then go ahead and add the window.</span>
            <span style="color:rgb(0,0,255);line-height:1.5;">boolean</span> willBeVisible = !<span style="line-height:1.5;">a.mStartedActivity;
            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (!<span style="line-height:1.5;">willBeVisible) {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">try</span><span style="line-height:1.5;"> {
                    willBeVisible </span>=<span style="line-height:1.5;"> ActivityManagerNative.getDefault().willActivityBeVisible(
                            a.getActivityToken());
                } </span><span style="color:rgb(0,0,255);line-height:1.5;">catch</span><span style="line-height:1.5;"> (RemoteException e) {
                }
            }
            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (r.window == <span style="color:rgb(0,0,255);line-height:1.5;">null</span> &amp;&amp; !a.mFinished &amp;&amp;<span style="line-height:1.5;"> willBeVisible) {
                r.window </span>=<span style="line-height:1.5;"> r.activity.getWindow();
               View decor </span>=<span style="line-height:1.5;"> r.window.getDecorView();
                decor.setVisibility(View.INVISIBLE);
                ViewManager wm </span>=<span style="line-height:1.5;"> a.getWindowManager();
                WindowManager.LayoutParams l </span>=<span style="line-height:1.5;"> r.window.getAttributes();
                a.mDecor </span>=<span style="line-height:1.5;"> decor;
               l.type </span>=<span style="line-height:1.5;"> WindowManager.LayoutParams.TYPE_BASE_APPLICATION;
                l.softInputMode </span>|=<span style="line-height:1.5;"> forwardBit;
                </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> (a.mVisibleFromClient) {
                    a.mWindowAdded </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">;
                   wm.addView(decor, l);
                }
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> If the window has already been added, but during resume
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> we started another activity, then don't yet make the
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> window visible.</span>
            } <span style="color:rgb(0,0,255);line-height:1.5;">else</span> <span style="color:rgb(0,0,255);line-height:1.5;">if</span> (!<span style="line-height:1.5;">willBeVisible) {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> (localLOGV) Slog.v(
                    TAG, </span>"Launch " + r + " mStartedActivity set"<span style="line-height:1.5;">);
                r.hideForNow </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">;
            }
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> The window is now visible if it has been added, we are not
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> simply finishing, and we are not starting another activity.</span>
            <span style="color:rgb(0,0,255);line-height:1.5;">if</span> (!r.activity.mFinished &amp;&amp;<span style="line-height:1.5;"> willBeVisible
                    </span>&amp;&amp; r.activity.mDecor != <span style="color:rgb(0,0,255);line-height:1.5;">null</span> &amp;&amp; !<span style="line-height:1.5;">r.hideForNow) {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (r.newConfig != <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">) {
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG, "Resuming activity "
                            + r.activityInfo.name + " with newConfig " +<span style="line-height:1.5;"> r.newConfig);
                    performConfigurationChanged(r.activity, r.newConfig);
                    r.newConfig </span>= <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">;
                }
                </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (localLOGV) Slog.v(TAG, "Resuming " + r + " with isForward="
                        +<span style="line-height:1.5;"> isForward);
                WindowManager.LayoutParams l </span>=<span style="line-height:1.5;"> r.window.getAttributes();
                </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> ((l.softInputMode
                        </span>&amp;<span style="line-height:1.5;"> WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION)
                        </span>!=<span style="line-height:1.5;"> forwardBit) {
                    l.softInputMode </span>=<span style="line-height:1.5;"> (l.softInputMode
                            </span>&amp; (~<span style="line-height:1.5;">WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION))
                            </span>|<span style="line-height:1.5;"> forwardBit;
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> (r.activity.mVisibleFromClient) {
                        ViewManager wm </span>=<span style="line-height:1.5;"> a.getWindowManager();
                        View decor </span>=<span style="line-height:1.5;"> r.window.getDecorView();
                        wm.updateViewLayout(decor, l);
                    }
                }
                r.activity.mVisibleFromServer </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">;
                mNumVisibleActivities</span>++<span style="line-height:1.5;">;
                </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> (r.activity.mVisibleFromClient) {
                    r.activity.makeVisible();
                }
            }
            r.nextIdle </span>=<span style="line-height:1.5;"> mNewActivities;
            mNewActivities </span>=<span style="line-height:1.5;"> r;
            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> (localLOGV) Slog.v(
                TAG, </span>"Scheduling idle handler for " +<span style="line-height:1.5;"> r);
            Looper.myQueue().addIdleHandler(</span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> Idler());
        } </span><span style="color:rgb(0,0,255);line-height:1.5;">else</span><span style="line-height:1.5;"> {
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> If an exception was thrown when trying to resume, then
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> just end this activity.</span>
            <span style="color:rgb(0,0,255);line-height:1.5;">try</span><span style="line-height:1.5;"> {
                ActivityManagerNative.getDefault()
                    .finishActivity(token, Activity.RESULT_CANCELED, </span><span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">);
            } </span><span style="color:rgb(0,0,255);line-height:1.5;">catch</span><span style="line-height:1.5;"> (RemoteException ex) {
            }
        }
}</span></pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(153,153,153);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="line-height:24px;color:rgb(153,153,153);font-family:'Comic Sans MS', '微软雅黑', '宋体', Arial;font-size:15px;">在Activity.onResume前，ViewRoot实例没有建立，所以没有ViewRoot.checkThread检查。而btn.setText时设定的文本却保留了下来，所以当ViewRoot真正去刷新界面时，就把"TestThread2.run"刷了出来！</p> 
    <p style="line-height:24px;color:rgb(153,153,153);font-family:'Comic Sans MS', '微软雅黑', '宋体', Arial;font-size:15px;">注意onStart，因为onStart在oncreate-&gt;onStart-&gt;onResume过程中，子线程刷新UI没问题的，但是在onPause-&gt;onRestart-&gt;onStart过程中，就有问题了。</p> 
    <p style="line-height:24px;color:rgb(153,153,153);font-family:'Comic Sans MS', '微软雅黑', '宋体', Arial;font-size:15px;"><strong><span style="color:rgb(255,255,255);font-size:large;">我是天王盖地虎的分割线&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></strong></p> 
    <p style="line-height:24px;color:rgb(153,153,153);font-family:'Comic Sans MS', '微软雅黑', '宋体', Arial;font-size:15px;">&nbsp;</p> 
    <p style="line-height:24px;color:rgb(153,153,153);font-family:'Comic Sans MS', '微软雅黑', '宋体', Arial;font-size:15px;">&nbsp;</p> 
    <p style="line-height:24px;"><font color="#999999"><span style="font-size:15px;"><br></span></font></p> 
    <p style="line-height:24px;"><font color="#999999"><span style="font-size:15px;"><br></span></font></p> 
    <p style="line-height:24px;"><font color="#999999"><span style="font-size:15px;"><br></span></font></p> 
    <p style="line-height:24px;"><font color="#999999"><span style="font-size:15px;">本文转自我爱物联网博客园博客，原文链接：http://www.cnblogs.com/yydcdut/p/3864072.html如需转载请自行联系原作者</span></font></p> 
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
