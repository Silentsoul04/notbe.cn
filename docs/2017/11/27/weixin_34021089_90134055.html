<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>已被.NET基金会认可的弹性和瞬态故障处理库Polly介绍 « NotBeCN</title>
  <meta name="description" content="             前言    本节我们来介绍一款强大的库Polly，Polly是一种.NET弹性和瞬态故障处理库，允许我们以非常顺畅和线程安全的方式来执诸如行重试，断路，超时，故障恢复等策略。 Polly针对对.NET 4.0，.NET 4.5和.NET Standard 1.1以及.NET Core实现...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/27/weixin_34021089_90134055.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">已被.NET基金会认可的弹性和瞬态故障处理库Polly介绍</h1>
    <p class="post-meta">Nov 27, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <h1 style="font-size:28px;line-height:1.5;font-family:'Helvetica Neue', Arial;">前言</h1> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">本节我们来介绍一款强大的库Polly，Polly是一种.NET弹性和瞬态故障处理库，允许我们以非常顺畅和线程安全的方式来执诸如行重试，断路，超时，故障恢复等策略。 Polly针对对.NET 4.0，.NET 4.5和.NET Standard 1.1以及.NET Core实现，该项目作者现已成为.NET基金会一员，项目一直在不停迭代和更新，项目地址【<a title="Polly" href="https://github.com/App-vNext/Polly" rel="nofollow" style="text-decoration:none;color:rgb(45,161,45);">https://github.com/App-vNext/Polly</a>】，你值得拥有。接下来我们以.NET Framework &nbsp;4.5来演示它的强大功能。</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">Introduce Polly</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">首先我们得下载Polly包，最新版本为5.3.1，如下：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2017.cnblogs.com/blog/589642/201709/589642-20170925000529087-38794828.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">该库实现了七种恢复策略，下面我一一为您来介绍。</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">重试策略（Retry）</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">重试策略针对的前置条件是短暂的故障延迟且在短暂的延迟之后能够自我纠正。允许我们做的是能够自动配置重试机制。</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">断路器（Circuit-breaker）</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">断路器策略针对的前置条件是当系统繁忙时，快速响应失败总比让用户一直等待更好。保护系统故障免受过载，Polly可以帮其恢复。</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">超时（Timeout）</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">超时策略针对的前置条件是超过一定的等待时间，想要得到成功的结果是不可能的，保证调用者不必等待超时。</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">隔板隔离（Bulkhead Isolation）</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">隔板隔离针对的前置条件是当进程出现故障时，多个失败一直在主机中对资源（例如线程/ CPU）一直占用。下游系统故障也可能导致上游失败。这两个风险都将造成严重的后果。都说一粒老鼠子屎搅浑一锅粥，而Polly则将受管制的操作限制在固定的资源池中，免其他资源受其影响。</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">缓存（Cache）</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">缓存策略针对的前置条件是数据不会很频繁的进行更新，为了避免系统过载，首次加载数据时将响应数据进行缓存，如果缓存中存在则直接从缓存中读取。</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">回退（Fallback）</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">操作仍然会失败，也就是说当发生这样的事情时我们打算做什么。也就是说定义失败返回操作。</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">策略包装（PolicyWrap）</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">策略包装针对的前置条件是不同的故障需要不同的策略，也就意味着弹性灵活使用组合。</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">几种策略使用</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">一旦从事IT就得警惕异常并友好拥抱异常而非不闻不问，这个时候我们利用try{}catch{}来处理。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>            <span style="color:rgb(0,0,255);line-height:1.5;">try</span><span style="line-height:1.5;">
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> a = <span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">;
                </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> b = <span style="color:rgb(128,0,128);line-height:1.5;">1</span> /<span style="line-height:1.5;"> a;
            }
            </span><span style="color:rgb(0,0,255);line-height:1.5;">catch</span><span style="line-height:1.5;"> (DivideByZeroException ex)
            {

                </span><span style="color:rgb(0,0,255);line-height:1.5;">throw</span><span style="line-height:1.5;"> ex;
            }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">若我们想重试三次，此时我们只能进行循环三次操作。我们只能简单进行处理，自从有了Polly，什么重试机制，超时都不在话下，下面我们来简短介绍各种策略。Polly默认处理策略需要指定抛出的具体异常或者执行抛出异常返回的结果。处理单个类型异常如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre><span style="line-height:1.5;">Policy
  .Handle</span>&lt;DivideByZeroException&gt;()</pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">上述异常指尝试除以0，下面我们演示下具体使用，我们尝试除以0并用Polly指定该异常并重试三次。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>        <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> Compute()
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> a = <span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">;
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(128,0,128);line-height:1.5;">1</span> /<span style="line-height:1.5;"> a;
        }</span></pre>
   </div> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>            <span style="color:rgb(0,0,255);line-height:1.5;">try</span><span style="line-height:1.5;">
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> retryTwoTimesPolicy =<span style="line-height:1.5;">
                     Policy
                         .Handle</span>&lt;DivideByZeroException&gt;<span style="line-height:1.5;">()
                         .Retry(</span><span style="color:rgb(128,0,128);line-height:1.5;">3</span>, (ex, count) =&gt;<span style="line-height:1.5;">
                         {
                             Console.WriteLine(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">执行失败! 重试次数 {0}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, count);
                             Console.WriteLine(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">异常来自 {0}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, ex.GetType().Name);
                         });
                retryTwoTimesPolicy.Execute(() </span>=&gt;<span style="line-height:1.5;">
                {
                    Compute();
                });
            }
            </span><span style="color:rgb(0,0,255);line-height:1.5;">catch</span><span style="line-height:1.5;"> (DivideByZeroException e)
            {
                Console.WriteLine($</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Excuted Failed,Message: ({e.Message})</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);

            }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2017.cnblogs.com/blog/589642/201709/589642-20170926215722465-1647993675.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">如果我们想指定处理多个异常类型通过OR即可。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre><span style="line-height:1.5;">Policy
  .Handle</span>&lt;DivideByZeroException&gt;<span style="line-height:1.5;">()
  .Or</span>&lt;ArgumentException&gt;()</pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">当然还有更加强大的功能，比如在微信支付时，微信回调我们的应用程序时，此时若失败，想必微信那边也会做重试机制，例如隔一段时间重试调用一次，重复调用几次后仍失败则不再回调。我们利用Polly则可以演示等待重试机制。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>        <span style="color:rgb(128,128,128);line-height:1.5;">///</span> <span style="color:rgb(128,128,128);line-height:1.5;">&lt;summary&gt;</span>
        <span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> 抛出异常
        </span><span style="color:rgb(128,128,128);line-height:1.5;">///</span> <span style="color:rgb(128,128,128);line-height:1.5;">&lt;/summary&gt;</span>
        <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> ZeroExcepcion()
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">throw</span> <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> DivideByZeroException();
        }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>        <span style="color:rgb(128,128,128);line-height:1.5;">///</span> <span style="color:rgb(128,128,128);line-height:1.5;">&lt;summary&gt;</span>
        <span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> 异常信息
        </span><span style="color:rgb(128,128,128);line-height:1.5;">///</span> <span style="color:rgb(128,128,128);line-height:1.5;">&lt;/summary&gt;</span>
        <span style="color:rgb(128,128,128);line-height:1.5;">///</span> <span style="color:rgb(128,128,128);line-height:1.5;">&lt;param name="e"&gt;&lt;/param&gt;</span>
        <span style="color:rgb(128,128,128);line-height:1.5;">///</span> <span style="color:rgb(128,128,128);line-height:1.5;">&lt;param name="tiempo"&gt;&lt;/param&gt;</span>
        <span style="color:rgb(128,128,128);line-height:1.5;">///</span> <span style="color:rgb(128,128,128);line-height:1.5;">&lt;param name="intento"&gt;&lt;/param&gt;</span>
        <span style="color:rgb(128,128,128);line-height:1.5;">///</span> <span style="color:rgb(128,128,128);line-height:1.5;">&lt;param name="contexto"&gt;&lt;/param&gt;</span>
        <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span> ReportaError(Exception e, TimeSpan tiempo, <span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> intento, Context contexto)
        {
            Console.WriteLine($</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">异常: {intento:00} (调用秒数: {tiempo.Seconds} 秒)\t执行时间: {DateTime.Now}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
        }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>            <span style="color:rgb(0,0,255);line-height:1.5;">try</span><span style="line-height:1.5;">
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> politicaWaitAndRetry =<span style="line-height:1.5;"> Policy
                    .Handle</span>&lt;DivideByZeroException&gt;<span style="line-height:1.5;">()
                    .WaitAndRetry(</span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;">[]
                    {
                        TimeSpan.FromSeconds(</span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">),
                        TimeSpan.FromSeconds(</span><span style="color:rgb(128,0,128);line-height:1.5;">3</span><span style="line-height:1.5;">),
                        TimeSpan.FromSeconds(</span><span style="color:rgb(128,0,128);line-height:1.5;">5</span><span style="line-height:1.5;">),
                        TimeSpan.FromSeconds(</span><span style="color:rgb(128,0,128);line-height:1.5;">7</span><span style="line-height:1.5;">)
                    }, ReportaError);
                politicaWaitAndRetry.Execute(() </span>=&gt;<span style="line-height:1.5;">
                {
                    ZeroExcepcion();
                });
            }
            </span><span style="color:rgb(0,0,255);line-height:1.5;">catch</span><span style="line-height:1.5;"> (Exception e)
            {
                Console.WriteLine($</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Executed Failed,Message:({e.Message})</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
            }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2017.cnblogs.com/blog/589642/201709/589642-20170926223022590-648976778.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">我们讲完默认策略和重试策略，再来看看反馈策略，翻译的更通俗一点则是执行失败后返回的结果，此时要为Polly指定返回类型，然后指定异常，最后调用Fallback方法。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>        <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> ThrowException()
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">throw</span> <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> Exception();</span><span style="line-height:1.5;">
        }</span></pre>
   </div> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>           <span style="color:rgb(0,0,255);line-height:1.5;">var</span> fallBackPolicy =<span style="line-height:1.5;">
                Policy</span>&lt;<span style="color:rgb(0,0,255);line-height:1.5;">string</span>&gt;<span style="line-height:1.5;">
                    .Handle</span>&lt;Exception&gt;<span style="line-height:1.5;">()
                    .Fallback(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">执行失败，返回Fallback</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);

            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> fallBack = fallBackPolicy.Execute(() =&gt;<span style="line-height:1.5;">
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> ThrowException();
            });
            Console.WriteLine(fallBack);</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2017.cnblogs.com/blog/589642/201709/589642-20170926223425372-1784457531.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">包裹策略说到底就是混合多种策略，并执行。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>          <span style="color:rgb(0,0,255);line-height:1.5;">var</span> fallBackPolicy =<span style="line-height:1.5;">
                Policy</span>&lt;<span style="color:rgb(0,0,255);line-height:1.5;">string</span>&gt;<span style="line-height:1.5;">
                    .Handle</span>&lt;Exception&gt;<span style="line-height:1.5;">()
                    .Fallback(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">执行失败，返回Fallback</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);

            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> fallBack = fallBackPolicy.Execute(() =&gt;<span style="line-height:1.5;">
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> ThrowException();
            });
            Console.WriteLine(fallBack);

            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> politicaWaitAndRetry =<span style="line-height:1.5;"> 
                Policy</span>&lt;<span style="color:rgb(0,0,255);line-height:1.5;">string</span>&gt;<span style="line-height:1.5;">
                    .Handle</span>&lt;Exception&gt;<span style="line-height:1.5;">()
                    .Retry(</span><span style="color:rgb(128,0,128);line-height:1.5;">3</span>, (ex, count) =&gt;<span style="line-height:1.5;">
                    {
                        Console.WriteLine(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">执行失败! 重试次数 {0}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, count);
                        Console.WriteLine(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">异常来自 {0}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, ex.GetType().Name);
                    });

            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> mixedPolicy =<span style="line-height:1.5;"> Policy.Wrap(fallBackPolicy, politicaWaitAndRetry);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> mixedResult =<span style="line-height:1.5;"> mixedPolicy.Execute(ThrowException);
            Console.WriteLine($</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">执行结果: {mixedResult}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>);</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2017.cnblogs.com/blog/589642/201709/589642-20170926230205669-69185360.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">至此关于Polly的基本介绍就已结束，该库还是非常强大，更多特性请参考上述github例子，接下来我们来看看两种具体场景。</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">ASP.NET Web APi使用Polly重试机制</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">在Polly v4.30中以上可以利用HandleResult指定返回结果，如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre><span style="line-height:1.5;">Policy
  .HandleResult</span>&lt;HttpResponseMessage&gt;(r =&gt; r.StatusCode == HttpStatusCode.NotFound)</pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">基于此我们完全可以利用执行Web APi中的响应策略，如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre> <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">readonly</span> RetryPolicy&lt;HttpResponseMessage&gt; _httpRequestPolicy;</pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">拿到响应中状态码，若为500则重试三次。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre> _httpRequestPolicy = Policy.HandleResult&lt;HttpResponseMessage&gt;<span style="line-height:1.5;">(
            r </span>=&gt; r.StatusCode ==<span style="line-height:1.5;"> HttpStatusCode.InternalServerError)
            .WaitAndRetryAsync(</span><span style="color:rgb(128,0,128);line-height:1.5;">3</span><span style="line-height:1.5;">,
            retryAttempt </span>=&gt; TimeSpan.FromSeconds(retryAttempt));</pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">上述获取请求响应策略在构造函数中获取。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> PollyController : ApiController
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">readonly</span> RetryPolicy&lt;HttpResponseMessage&gt;<span style="line-height:1.5;"> _httpRequestPolicy;
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> PollyController()
        {
            _httpRequestPolicy </span>= Policy.HandleResult&lt;HttpResponseMessage&gt;<span style="line-height:1.5;">(
            r </span>=&gt; r.StatusCode ==<span style="line-height:1.5;"> HttpStatusCode.InternalServerError)
            .WaitAndRetryAsync(</span><span style="color:rgb(128,0,128);line-height:1.5;">3</span><span style="line-height:1.5;">,
            retryAttempt </span>=&gt;<span style="line-height:1.5;"> TimeSpan.FromSeconds(retryAttempt));
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">此时调用接口时执行策略的Execute或者ExecuteAsync方法即可。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>        <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">async</span> Task&lt;IHttpActionResult&gt;<span style="line-height:1.5;"> Get()
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> httpClient = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> HttpClient();
            </span><span style="color:rgb(0,0,255);line-height:1.5;">string</span> requestEndpoint = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">http://localhost:4096</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">;

            HttpResponseMessage httpResponse </span>= <span style="color:rgb(0,0,255);line-height:1.5;">await</span> _httpRequestPolicy.ExecuteAsync(() =&gt;<span style="line-height:1.5;"> httpClient.GetAsync(requestEndpoint));

            IEnumerable</span>&lt;<span style="color:rgb(0,0,255);line-height:1.5;">string</span>&gt; numbers = <span style="color:rgb(0,0,255);line-height:1.5;">await</span> httpResponse.Content.ReadAsAsync&lt;IEnumerable&lt;<span style="color:rgb(0,0,255);line-height:1.5;">string</span>&gt;&gt;<span style="line-height:1.5;">();

            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> Ok(numbers);
        }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">你以为仅限于在Web APi中使用吗？在其他框架中也可以使用，例如EntityFramework 6.x中，在EntityFramework 6+上出现了执行策略，也就是执行重试机制，这个时候我们依然可以借助Polly轮子来实现。</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">EntityFramework 6.x使用Polly重试机制</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">在EntityFramework 6.x中有如下执行策略接口，看起来是不是和Polly中的Execute方法是不是很类似。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,128,0);line-height:1.5;">//</span>
    <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> 摘要:
    </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     A strategy that is used to execute a command or query against the database, possibly
    </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     with logic to retry when a failure occurs.</span>
    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">interface</span><span style="line-height:1.5;"> IDbExecutionStrategy
    {
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span>
        <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> 摘要:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     Indicates whether this System.Data.Entity.Infrastructure.IDbExecutionStrategy
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     might retry the execution after a failure.</span>
        <span style="color:rgb(0,0,255);line-height:1.5;">bool</span> RetriesOnFailure { <span style="color:rgb(0,0,255);line-height:1.5;">get</span><span style="line-height:1.5;">; }

        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span>
        <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> 摘要:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     Executes the specified operation.
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span>
        <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> 参数:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">   operation:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     A delegate representing an executable operation that doesn't return any results.</span>
        <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> Execute(Action operation);
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span>
        <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> 摘要:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     Executes the specified operation and returns the result.
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span>
        <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> 参数:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">   operation:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     A delegate representing an executable operation that returns the result of type
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     TResult.
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span>
        <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> 类型参数:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">   TResult:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     The return type of operation.
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span>
        <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> 返回结果:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     The result from the operation.</span>
        TResult Execute&lt;TResult&gt;(Func&lt;TResult&gt;<span style="line-height:1.5;"> operation);
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span>
        <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> 摘要:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     Executes the specified asynchronous operation.
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span>
        <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> 参数:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">   operation:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     A function that returns a started task.
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span>
        <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">   cancellationToken:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     A cancellation token used to cancel the retry operation, but not operations that
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     are already in flight or that already completed successfully.
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span>
        <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> 返回结果:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     A task that will run to completion if the original task completes successfully
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     (either the first time or after retrying transient failures). If the task fails
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     with a non-transient error or the retry limit is reached, the returned task will
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     become faulted and the exception must be observed.</span>
        Task ExecuteAsync(Func&lt;Task&gt;<span style="line-height:1.5;"> operation, CancellationToken cancellationToken);
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span>
        <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> 摘要:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     Executes the specified asynchronous operation and returns the result.
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span>
        <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> 参数:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">   operation:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     A function that returns a started task of type TResult.
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span>
        <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">   cancellationToken:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     A cancellation token used to cancel the retry operation, but not operations that
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     are already in flight or that already completed successfully.
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span>
        <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> 类型参数:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">   TResult:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     The result type of the System.Threading.Tasks.Task`1 returned by operation.
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span>
        <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> 返回结果:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     A task that will run to completion if the original task completes successfully
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     (either the first time or after retrying transient failures). If the task fails
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     with a non-transient error or the retry limit is reached, the returned task will
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     become faulted and the exception must be observed.</span>
        [SuppressMessage(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Microsoft.Design</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">CA1006:DoNotNestGenericTypesInMemberSignatures</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">)]
        Task</span>&lt;TResult&gt; ExecuteAsync&lt;TResult&gt;(Func&lt;Task&lt;TResult&gt;&gt;<span style="line-height:1.5;"> operation, CancellationToken cancellationToken);
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">EntityFramework 6.x中的执行策略说到底就是数据库连接问题即弹性连接，若考虑到数据库过渡负载问题，此时应用程序和数据库之间存在网络问题的话。可能数据库连接在几秒内才返回，此时也没有什么很大的问题，我们完全可以再尝试一次，此时或许过了连接频繁期，保证连接立马恢复。如果数据库连接一会恢复不了呢？或许是五分钟，又或者是半个小时。如果我们只是一味盲目的进行重试，这显然不可取。如果我们的应用程序连接超时时间超过了20秒，若我们选择继续连接到数据库，我们将很快用完我们应用程序池中的工作线程。一直等待数据库的响应。此时网站将完全无响应，同时会给用户页面无响应的友好提醒。这是Polly库中描述断路器的很好例子，换句话说如果我们捕获了m个数量的SqlExceptions，假设数据库有其他问题存在，导致我们不能在n秒内再尝试连接数据库。此时在数据库连接上存在一个问题，那就是阻塞了我们的应用程序工作线程被挂起，我们试图连接数据库，我们假设不可用的话，但是我们要打破这种不可用，那就用Polly吧。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">我们看到上述EntityFramework 6.x实现了IDbExecutionStrategy接口，但没有实现如Polly中的断路器模式，EntityFramework 6.x中的执行策略只是重试机制而已。 比如SqlAzureExecutionStrategy将在指定的时间段内重试指定的次数，直到一段时间段过去，重试指数过后，接着就是失败。 同时所有后续调用将执行相同操作，重试并失败。 这是调用数据库时最好的策略吗？ 不敢肯定，或许Polly中的断路器模式值得我们借鉴。我们自己来实现上述执行策略接口。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> CirtuitBreakerExecutionStrategy : IDbExecutionStrategy
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> Policy _policy;

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> CirtuitBreakerExecutionStrategy(Policy policy)
        {
            _policy </span>=<span style="line-height:1.5;"> policy;
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> Execute(Action operation)
        {

            _policy.Execute(() </span>=&gt;<span style="line-height:1.5;">
            {
                operation.Invoke();
            });
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> TResult Execute&lt;TResult&gt;(Func&lt;TResult&gt;<span style="line-height:1.5;"> operation)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> _policy.Execute(() =&gt;<span style="line-height:1.5;">
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> operation.Invoke();
            });
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">async</span> Task ExecuteAsync(Func&lt;Task&gt;<span style="line-height:1.5;"> operation, CancellationToken cancellationToken)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">await</span> _policy.ExecuteAsync(() =&gt;<span style="line-height:1.5;">
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> operation.Invoke();
            });
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">async</span> Task&lt;TResult&gt; ExecuteAsync&lt;TResult&gt;(Func&lt;Task&lt;TResult&gt;&gt;<span style="line-height:1.5;"> operation, CancellationToken cancellationToken)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(0,0,255);line-height:1.5;">await</span> _policy.ExecuteAsync(() =&gt;<span style="line-height:1.5;">
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> operation.Invoke();
            });
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">bool</span> RetriesOnFailure { <span style="color:rgb(0,0,255);line-height:1.5;">get</span> { <span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">; } }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">接下来在基于代码配置文件中设置我们上述自定义实现的断路器模式。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">    public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> EFConfiguration : DbConfiguration
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> Policy _policy;
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> EFConfiguration()
        {
            _policy </span>= Policy.Handle&lt;Exception&gt;().CircuitBreaker(<span style="color:rgb(128,0,128);line-height:1.5;">3</span>, TimeSpan.FromSeconds(<span style="color:rgb(128,0,128);line-height:1.5;">60</span><span style="line-height:1.5;">));

            SetExecutionStrategy(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">System.Data.SqlClient</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, () =&gt; <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> CirtuitBreakerExecutionStrategy(_policy));
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">上述自定义实现执行策略不保证一定有用或许也是一种解决方案呢。</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">总结</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">本节我们介绍了强大的Polly库和其对应使用的两种实际场景，有此轮子我们何不用起，将其进行封装可以用于一切重试、缓存、异常等处理。&nbsp;</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p><font color="#111111"><span style="font-size:13px;line-height:23.4px;">本文转自Jeffcky博客园博客，原文链接：http://www.cnblogs.com/CreateMyself/p/7589397.html，如需转载请自行联系原作者</span></font><br></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
