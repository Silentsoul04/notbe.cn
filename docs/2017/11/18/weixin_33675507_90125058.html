<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>探索 OpenStack 之（13）：研究 Keystone « NotBeCN</title>
  <meta name="description" content="                  Keystone 是 OpenStack Identity Service 的项目名称。本文就试着尽可能深入地研究 Keystone。     1. Keystone 的功能     做为 OpenStack 云系统的入口，Keystone 提供了云系统入口所需要的许多功能： ...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/18/weixin_33675507_90125058.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">探索 OpenStack 之（13）：研究 Keystone</h1>
    <p class="post-meta">Nov 18, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <div class="blogpost-body"> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">Keystone 是 OpenStack Identity Service 的项目名称。本文就试着尽可能深入地研究 Keystone。</p> 
    <h2 style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:21px;line-height:1.5;">1. Keystone 的功能</h2> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">做为 OpenStack 云系统的入口，Keystone 提供了云系统入口所需要的许多功能：</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">（1）. 用户身份验证：系统得知道用户是不是合法的用户。为此，Keystone 需要对 user 进行管理和保存；管理用户相关的 tenant、role、group 和 domain等；用户 credential 的存放、验证、令牌管理等。</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">（2）. 服务目录列表：用户需要知道系统提供的服务目录。为此，Keystone 得提供服务目录的管理，包括 service、endpoint 等。</p> 
    <h3 style="color:rgb(102,102,102);font-family:Verdana;font-size:16px;background-image:none;background-repeat:no-repeat;line-height:1.5;">1.1 Keystone 管理的相关概念</h3> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">（1）User 用户：一个使用 OpenStack 云服务的人、系统或者服务的数字表示。 用户需要登录，然后被分配 token 去访问资源。用户可以被分配到一个tenant。<br> （2）Credential 用户证据：用来证明用户身份的证据，可以是用户名和密码、用户名和API key，或者一个 Keystone 分配的身份token。<br> （3）Authentication 身份验证：验证用户身份的过程。Keystone 服务通过检查用户的 Credential 来确定用户的身份。最开始，使用用户名/密码或者用户名/API key作为credential。当用户的credential被验证后，Kestone 会给用户分配一个 authentication token 供该用户后续的请求使用。<br> （4）Token 令牌：一个用于访问 OpenStack API 和资源的 alpha 数字字符串。一个 token 可能在任何时间被撤销（revoke），因此其有效期是有限的。OpenStack中，token 是和特定的 tenant 绑定的，因此如果 user 如果访问多个tenant的话他就需要多个tocken。<br> （5）Tenant 租户：一个用于分组或者隔离资源的容器。一个 tenant 可能对应一个客户、账号、组织或者项目。在 OpenStack 中，用户至少必须在一个tenant中。tenant 容器的可使用资源的限制成为 Tenant Quota，它包括tenant 内各子资源的quota。<br> （6）Service 服务：一个 OpenStack 服务，比如Nova、Swift或者Glance等。每个服务提供一个或者多个 endpoint 供用户访问资源以及进行操作。<br> （7）Endpoint 端点：一个网络可访问的服务地址，通过它你可以访问一个服务，通常是个 URL 地址。不同 region 有不同的service endpoint。endpoint告诉也可告诉 OpenStack service 去哪里访问特定的 servcie。比如，当 Nova 需要访问 Glance 服务去获取 image 时，Nova 通过访问 Keystone 拿到 Glance 的 endpoint，然后通过访问该 endpoint 去获取Glance服务。我们可以通过Endpoint的 region 属性去定义多个 region。Endpoint 该使用对象分为三类：</p> 
    <ul style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:12px;list-style:none;">
     <li style="list-style-type:disc;">adminurl 给 admin 用户使用</li> 
     <li style="list-style-type:disc;">internalurl 给 OpenStack 内部服务使用来跟别的服务通信</li> 
     <li style="list-style-type:disc;">publicurl 其它用户可以访问的地址</li> 
    </ul>
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">比如创建一个使用不同 IP 的 endpoint：</p> 
    <pre class="screen">$ keystone endpoint-create \
 --region RegionOne \
 --service-id=1ff4ece13c3e48d8a6461faebd9cd38f \
 --publicurl='https://public-ip:8776/v1/%(tenant_id)s' \
 --internalurl='https://management-ip:8776/v1/%(tenant_id)s' \
 --adminurl='https://management-ip:8776/v1/%(tenant_id)s'<br>
然后你可以配置 OpenStack service 使用另一个 service 的 endpoint 的 internalurl 去访问另一个资源。</pre> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">（8）Role 角色：一个 role 可看着一个ACL的集合。Keystone 中，分配给用户的 token 包含了 role 列表。被访问的服务会判断访问它的用户的角色，以及每个role访问资源或者操作的权限。系统默认使用 admin 和 _member_ role。User 验证的时候必须带有制定的 tenant，roles 会被分配到指定的 tenant。</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">（9）Policy 策略：OpenStack 对用户的验证除了 OpenStack 的身份验证以外，还需要鉴别用户对某个服务是否有访问权限。Policy 机制就是用来控制某一个 User 在某个 Tenant 中某个操作的权限。这个 User 能执行什么操作，不能执行什么操作，就是通过 policy 机制来实现的。对于 Keystone 服务来说，policy 就是一个json 文件，默认是 /etc/keystone/policy.json。通过配置这个文件，Keystone Service 实现了对 User 的基于用户角色的权限管理。</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;"><strong>这些Keystone 管理对象之间的关系：</strong></p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;"><img src="https://images0.cnblogs.com/blog/697113/201502/061449475462757.jpg" alt="" style="border:0px;"></p> 
    <h3 style="color:rgb(102,102,102);font-family:Verdana;font-size:16px;background-image:none;background-repeat:no-repeat;line-height:1.5;">1.2 Keystone 管理这些概念的方法</h3> 
    <table border="0" style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;border:1px solid #C0C0C0;border-collapse:collapse;">
     <tbody>
      <tr>
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><strong>组件名称</strong></td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><strong>管理对象</strong></td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><strong>生成方法</strong></td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><strong>保存方式</strong></td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><strong>配置项</strong></td> 
      </tr>
      <tr>
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">identity</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">user，以及 user group</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">-</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <strong>sql</strong>, kvs, ldap</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p style="line-height:1.5;">[identity]</p> <p style="line-height:1.5;">driver = keystone.identity.backends.[<strong>sql</strong>|kvs|ldap].Identity</p> </td> 
      </tr>
      <tr>
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">token</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">用户的临时 token</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">pki，pkiz，uuid</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">sql, kvs,memcached</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p align="left" style="line-height:1.5;">[token]</p> <p align="left" style="line-height:1.5;">driver = keystone.token.persistence.backends.[<strong>sql</strong>|kvs|memcached].Token</p> provider=keystone.token.providers.[pkiz|pki|<strong>uuid</strong>].Provider</td> 
      </tr>
      <tr>
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">credential</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">EC2 credential</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><strong>sql</strong></td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p align="right" style="line-height:1.5;">[credential]</p> <p align="right" style="line-height:1.5;">driver = keystone.credential.backends.sql.Credential</p> </td> 
      </tr>
      <tr>
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">catalog</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">region,service,endpoint</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <strong>sql</strong>|kvs| template</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p style="line-height:1.5;"><span style="line-height:1.5;font-size:10px;">[catalog]</span></p> <p style="line-height:1.5;">driver = keystone.catalog.backends.[<strong>sql</strong>|kvs| template].Catalog</p> </td> 
      </tr>
      <tr>
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">assignment</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">tenant，domain，role 以及它们与 user 之间的关系</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">external, password, token</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p style="line-height:1.5;"><span style="line-height:1.5;font-size:10px;">[assignment]</span></p> <p style="line-height:1.5;">methods = external, password, token</p> <p style="line-height:1.5;">password = keystone.auth.plugins.password.Password</p> </td> 
      </tr>
      <tr>
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">trust</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">trust</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;<strong>sql</strong>，kvs</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p style="line-height:1.5;"><span style="line-height:1.5;font-size:10px;">[trust]</span></p> <p style="line-height:1.5;"><span style="line-height:1.5;font-size:10px;">driver = keystone.trust.backends.[s<strong>sql</strong>|kvs].Trust</span></p> </td> 
      </tr>
      <tr>
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">policy</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">Keystone service 的用户鉴权策略</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;sql</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p align="left" style="line-height:1.5;">[default]</p> <p align="left" style="line-height:1.5;">policy_file = policy.json</p> <p align="left" style="line-height:1.5;">[policy]</p> <p style="line-height:1.5;"><span style="line-height:1.5;font-size:10px;">driver = keystone.policy.backends.<strong>sql</strong>.Policy</span></p> </td> 
      </tr>
     </tbody>
    </table>
    <h3 style="color:rgb(102,102,102);font-family:Verdana;font-size:16px;background-image:none;background-repeat:no-repeat;line-height:1.5;">1.3 Keystone 代码结构&nbsp;</h3> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">Keystone 的代码结果和 OpenStack 的其它组件一样，非常有层次感：</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;"><img src="https://images0.cnblogs.com/blog/697113/201502/062252150621486.jpg" alt="" style="border:0px;"></p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">（1）bin 目录下：</p> 
    <ul style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:12px;list-style:none;">
     <li style="list-style-type:disc;">keystone-manage 是个 CLI 工具，它通过和 Keystone service 交互来做一些无法使用 Keystone REST API 来进行的操作，包括： 
      <ul style="list-style:none;">
       <li style="list-style-type:disc;">db_sync: Sync the database.</li> 
       <li style="list-style-type:disc;">db_version: Print the current migration version of the database.</li> 
       <li style="list-style-type:disc;">mapping_purge: Purge the identity mapping table.</li> 
       <li style="list-style-type:disc;">pki_setup: Initialize the certificates used to sign tokens.</li> 
       <li style="list-style-type:disc;">saml_idp_metadata: Generate identity provider metadata.</li> 
       <li style="list-style-type:disc;">ssl_setup: Generate certificates for SSL.</li> 
       <li style="list-style-type:disc;">token_flush: Purge expired tokens.</li> 
      </ul></li> 
     <li style="list-style-type:disc;">keystone-all 用于启动 Keystone 的服务，下面有章节描述其服务启动过程。</li> 
    </ul>
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">（2）keystone 目录下：</p> 
    <ul style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:12px;list-style:none;">
     <li style="list-style-type:none;"> 
      <ul style="list-style:none;">
       <li style="list-style-type:disc;">每个Keystone 组件，比如 catalog， token 等都有一个单独的目录。</li> 
       <li style="list-style-type:disc;">每个组件目录中：</li> 
      </ul></li>
    </ul>
    <ul style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:12px;list-style:none;">
     <li style="list-style-type:none;"> 
      <ul style="list-style:none;">
       <li style="list-style-type:none;"> 
        <ul style="list-style:none;">
         <li style="list-style-type:disc;">routes.py 定义了该组件的 routes （routes 见&nbsp;<a id="homepage1_HomePageDays_DaysList_ctl01_DayList_TitleUrl_0" class="postTitle2" href="http://www.cnblogs.com/sammyliu/p/4272611.html" rel="nofollow" style="text-decoration:none;color:rgb(26,139,200);">探索 OpenStack 之（11）：cinder-api Service 启动过程分析 以及 WSGI / Paste deploy / Router 等介绍</a>）。其中，identity 和 assignment 分别定义了 admin 和 public 使用的 routes，分别供 admin service 和 public service 使用。&nbsp;</li> 
         <li style="list-style-type:disc;">controller.py 文件定义了该组件所管理的对象，比如 assignment 的controller.py 文件定义了 Tenant、Role、Project 等类。</li> 
         <li style="list-style-type:disc;">core.py 定了了两个类 Manager 和 Driver。Manager 类对外提供该组件操作具体对象的方法入口； Driver 类定义了该组件需要其Driver实现类所提供的接口。</li> 
         <li style="list-style-type:disc;">backend 目录下的每个文件是每个具体driver 的实现</li> 
        </ul></li> 
       <li style="list-style-type:disc;">contrib 目录包括resource extension 和 extension resource 的类文件</li> 
      </ul></li>
    </ul>
    <h3 style="color:rgb(102,102,102);font-family:Verdana;font-size:16px;background-image:none;background-repeat:no-repeat;line-height:1.5;">1.4 Keystone 服务启动</h3> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">/usr/bin/keystone-all 会启动 keystone 的两个service：admin and main，它们分别对应 /etc/keystone/keystone-paste.ini&nbsp;文件中的两个composite：</p> 
    <div class="cnblogs_code" style="color:rgb(0,0,0);font-family:'Courier New';font-size:12px;border:1px solid rgb(204,204,204);"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre><span style="line-height:1.5;">[composite:main]
use </span>=<span style="line-height:1.5;"> egg:Paste#urlmap
</span>/v2.<span style="color:rgb(128,0,128);line-height:1.5;">0</span> =<span style="line-height:1.5;"> public_api
</span>/v3 =<span style="line-height:1.5;"> api_v3
</span>/ =<span style="line-height:1.5;"> public_version_api

[composite:admin]
use </span>=<span style="line-height:1.5;"> egg:Paste#urlmap
</span>/v2.<span style="color:rgb(128,0,128);line-height:1.5;">0</span> =<span style="line-height:1.5;"> admin_api
</span>/v3 =<span style="line-height:1.5;"> api_v3
</span>/ = admin_version_api</pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">可见 admin service 提供给administrator 使用；main 提供给 public 使用。它们分别都有 V2.0 和 V3 版本，只是目前的 keystone Cli 只支持 V2.0. 本文的分析以 V2.0 为对象，最后会看看两个版本你的区别。比较下 admin 和 public：</p> 
    <table border="0" style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;border:1px solid #C0C0C0;border-collapse:collapse;">
     <tbody>
      <tr>
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><strong>名称</strong></td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><strong>middlewares</strong></td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><strong>factory</strong></td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><strong>功能区别</strong></td> 
      </tr>
      <tr>
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">admin</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">比 public 多&nbsp;s3_extension</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">keystone.service:public_app_factory</td> 
       <td rowspan="2" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p style="line-height:1.5;">从 factory 函数来看， admin service 比 public service 多了&nbsp;identity 管理功能， 以及 assignment 的admin/public 区别：</p> <p style="line-height:1.5;">1. admin 多了对 GET&nbsp;/users/{user_id} 的支持，多了&nbsp;get_all_projects，&nbsp;get_project，get_user_roles 等功能</p> <p style="line-height:1.5;">2. keystone 对 admin service 提供 admin extensions, 比如&nbsp;<a href="http://docs.rackspace.com/openstack-extensions/auth/OS-KSADM-admin-devguide/content/Admin_API_Service_Developer_Operations-d1e1357.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">OS-KSADM</a>&nbsp;等；对 public service 提供 public extensions。</p> <p style="line-height:1.5;"><strong>简单总结一下， public service 主要提供了身份验证和目录服务功能；admin service 增加了 tenant、user、role、user group 的管理功能。</strong></p> </td> 
      </tr>
      <tr>
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">public</td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p style="line-height:1.5;">sizelimit url_normalize build_auth_context token_auth admin_token_auth xml_body_v2</p> <p style="line-height:1.5;">json_body ec2_extension user_crud_extension</p> </td> 
       <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">keystone.service:admin_app_factory</td> 
      </tr>
     </tbody>
    </table>
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">&nbsp;</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">/usr/bin/keystone-all 会启动 admin 和 public 两个 service，分别绑定不同 host 和 端口。默认的话，绑定host 都是 0.0.0.0； admin 的绑定端口是 35357 （admin_port）， public 的绑定端口是 5000 （public_port）。因此，给 admin 使用的&nbsp;OS_AUTH_URL 为 http://controller:35357/v2.0， 给 public 使用的&nbsp;OS_AUTH_URL=http://controller:5000/v2.0.</p> 
    <h2 style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:21px;line-height:1.5;">2. Keystone 中的几个重点</h2> 
    <h3 style="color:rgb(102,102,102);font-family:Verdana;font-size:16px;background-image:none;background-repeat:no-repeat;line-height:1.5;">2.1 用户的 username/password 身份验证和 token 生成</h3> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;"><span style="line-height:1.5;">HTTP Verb：POST /tokens</span></p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">HTTP params: {'auth': {u'tenantName': u'admin', u'passwordCredentials': {u'username': u'admin', u'password': u'1111'}}}</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">method: &lt;bound method Auth.authenticate of &lt;keystone.token.controllers.Auth object at 0x7fb58f611610&gt;&gt;</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">基本步骤：</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">（3）通过 user name 获取 user id，最终会从 identity backend 中获取到。</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">（6）校验用户的 password 和 identity backend 中的 password 的一致性。sql backend 的话，直接比较两个值。</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">（8）获取 project info，接下来检查 domain，project，tenant 是否都是 enabled。</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">（19）获取 catalog 和 roles。</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">（22）使用 &nbsp;user_ref,tenant_ref,metadata_ref,expiry,audit_id 构造 token_auth_data。</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;"><strong>user_user_ref</strong>: {'name': u'admin', 'domain_id': u'default', 'enabled': True, u'email': u'admin@admin.com', 'id': u'1dc0db32a936496ebfc50be54924a7cc'},&nbsp;<strong>tenant_ref</strong>: {'domain_id': u'default', 'description': u'Admin Tenant', 'enabled': True, 'id': u'43f66bb82e684bbe9eb9ef6892bd7fd6', 'name': u'admin'},<strong>metadata_ref</strong>: {'roles': [u'ea26bd3b3d0b4ce187ab606cd83eff69', u'4135d78453fb4975a959cd860bacdca0']},&nbsp;<strong>expiry</strong>: 2015-02-08 15:41:31.064022,&nbsp;<strong>bind</strong>: None, audit_id: None</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">（23）再基于 catalog，roles 和 token_auth_data，创建 token data，创建好了以后该 token 会被保存到 persistence backend 中。 token data其内容包括：</p> 
    <ul style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:12px;list-style:none;">
     <li style="list-style-type:disc;">user data，比如name，domain id，id， role names 等</li> 
     <li style="list-style-type:disc;">tenant data，包括id，name，enabled 等。</li> 
     <li style="list-style-type:disc;">catalog data，包括catalog 数组。比如：</li> 
     <li style="list-style-type:disc;"> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">endpoints</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">: [
                    {
                        </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">adminURL</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">http://controller:8776/v2/43f66bb82e684bbe9eb9ef6892bd7fd6</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                        </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">region</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">regionOne</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                        </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">internalURL</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">http://controller:8776/v2/43f66bb82e684bbe9eb9ef6892bd7fd6</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                        </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">id</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">652eb96c0d2f41e0ab17f4b61a1b8ee3</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                        </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">publicURL</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">http://controller:8776/v2/43f66bb82e684bbe9eb9ef6892bd7fd6</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">
                    }
                ],
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">endpoints_links</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">: [],
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">type</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">volumev2</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">name</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">cinderv2</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> </li> 
     <li style="list-style-type:disc;">metadata，比如 is_admin 以及 role ids。其中，is_admin 仅仅在headers中的 token 等于 keystone.conf 中设置的 admin_token 时设置为true。</li> 
     <li style="list-style-type:disc;">token data，比如issued_at，token id，expire 等</li> 
     <li style="list-style-type:disc;">trust data</li> 
    </ul>
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;"><span style="line-height:1.5;">其中，token_id 是调用相应的 token provider 的&nbsp;_get_token_id 方法生成的：</span></p> 
    <ul style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:12px;list-style:none;">
     <li style="list-style-type:disc;">UUID：uuid.uuid4().hex</li> 
     <li style="list-style-type:disc;">PKI：token_id = str(cms.cms_sign_token(jsonutils.dumps(token_data),&nbsp;CONF.signing.certfile,CONF.signing.keyfile))</li> 
     <li style="list-style-type:disc;">PKIZ：token_id = str(cms.pkiz_sign(jsonutils.dumps(token_data),CONF.signing.certfile,CONF.signing.keyfile))</li> 
    </ul>
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">从中可见：</p> 
    <ul style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:12px;list-style:none;">
     <li style="list-style-type:disc;"> <a href="https://docs.python.org/2/library/uuid.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">UUDI&nbsp;</a>的 token id 只是一个纯粹的32位十六进制字符串</li> 
     <li style="list-style-type:disc;"> <a href="http://baike.baidu.com/view/7615.htm" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">PKI&nbsp;</a>（Public Key Infrastructure） 的 token id 是使用 cert file 和 key file 对 token data 加密的结果</li> 
     <li style="list-style-type:disc;">PKIZ 的 token id 是使用 pkiz_sign 函数，使用 cert file 和 key file 对 token data 加密的结果。从下面的 code 可以看出，pkiz 生成的 token id 其实就是使用 zlib 对 PKI 生成的 token id 进行压缩，然后加上 PKIZ_ 前缀而已。其原因应该是 PKI 的 token id 太长了。供结果估计，PKIZ 能压缩 PKI 一半左右，感觉这压缩率也不高。</li> 
     <li style="list-style-type:disc;"> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.5;">def pkiz_sign(text, signing_cert_file_name, signing_key_file_name, compression_level</span>=<span style="color:rgb(128,0,128);line-height:1.5;">6</span><span style="line-height:1.5;">):
    signed </span>=<span style="line-height:1.5;"> cms_sign_data(text, signing_cert_file_name, signing_key_file_name, PKIZ_CMS_FORM)
    compressed </span>=<span style="line-height:1.5;"> zlib.compress(signed, compression_level)
    encoded </span>= PKIZ_PREFIX +<span style="line-height:1.5;"> base64.urlsafe_b64encode(
        compressed).decode(</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">utf-8</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">)
    </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> encoded</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> <p style="line-height:1.5;"><img src="https://images0.cnblogs.com/blog/697113/201502/082210575786774.jpg" alt="" style="border:0px;line-height:1.5;"></p> </li> 
    </ul>
    <h3 style="color:rgb(102,102,102);font-family:Verdana;font-size:16px;background-image:none;background-repeat:no-repeat;line-height:1.5;"> <span style="line-height:1.5;font-size:1.17em;">2.2 keystone 验证及&nbsp;</span>keystonemiddleware filter</h3> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">客户端在调用 POST /tokens 后拿到返回结果，如果用户名和密码验证成功，则拿到诸如user，tenant，token，metadata，catalog等数据。从 catalog 中找到要访问的 service 的 endpoint 的 URL，然后在 headers 中放入 {X-Auth-Token，token id}，就可以访问该 service 了。service 的 WSGI App 在收到该 Request 后，首先要验证该 token id 是否有效，该验证一般都使用一个&nbsp;<a href="http://www.cnblogs.com/sammyliu/p/4271239.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">keystonemiddleware&nbsp;</a>的 middleware filter 来完成，其&nbsp;AuthProtocol.__call__ 是处理Request 的入口函数。其处理过程大致如下：</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;"><img src="https://images0.cnblogs.com/blog/697113/201502/091503166833440.jpg" alt="" style="border:0px;"></p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">这篇文章&nbsp;<a href="https://www.mirantis.com/blog/understanding-openstack-authentication-keystone-pki/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">understanding-openstack-authentication-keystone-pki</a>&nbsp;仔细分析了UUID/PKI/PKIZ token id 的生成和验证过程。&nbsp;</p> 
    <h3 style="color:rgb(102,102,102);font-family:Verdana;font-size:16px;background-image:none;background-repeat:no-repeat;line-height:1.5;">2.3 Role 和 Policy 策略</h3> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">上面 2.1 和 2.2 只是验证 user 的 credential，至于 user 有没有权限来执行某个操作则取决于 Role 和 基于 Roles 的鉴权。每个 OpenStack 组件分别实现了鉴权功能，Keystone 和 其它组件中的实现有一些不同。</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">Keystone API V3 与 V2 相比，对 policy 的支持有很多的增强。V2 的支持和 OpenStack 其它组件比如cinder，nova 等差不多，只支持基于 policy.json 文件的 policy 控制；而 V3 中，支持对 policy 的 CURD 操作，以及对 endpoint，service 等的 policy 操作等。</p> 
    <h3 style="color:rgb(102,102,102);font-family:Verdana;font-size:16px;background-image:none;background-repeat:no-repeat;line-height:1.5;">2.3.1 Keystone 中的 RBAC （Role Based Access Controll）</h3> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">Keystone 在每个子模块的 controller.py 文件中的各个控制类的方法上实施 RBAC。有几种方法，比如：</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;"><span style="line-height:1.5;color:rgb(0,0,255);">@controller.protected()</span><br> def create_region(self, context, region)</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;"><span style="line-height:1.5;color:rgb(0,0,255);">@controller.filterprotected('type', 'name')</span><br> def list_services(self, context, filters)</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">或者直接在函数体中使用&nbsp;self.assert_admin(context)：</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">def get_services(self, context):<br> &nbsp; &nbsp;&nbsp;<span style="line-height:1.5;color:rgb(0,0,255);">self.assert_admin(context)</span><br> &nbsp; &nbsp; service_list = self.catalog_api.list_services()<br> &nbsp; &nbsp; return {'OS-KSADM:services': service_list}</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">其中，protected 和 filterprotected 在 /keystone/common/controller.py 中实现。</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">protected/filterprotected 最终会调用 /keystone/openstack/common/policy.py 中的&nbsp;enforce 方法，具体见 2.3.2 （2）中的描述。keystone 与 openstack 其它component 中的 RBAC 实现的不同之处在于 keystone 中有时候需要做 token 验证再做 policy 检查。</p> 
    <h4 style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:14px;">2.3.2 Keystone V3 API 中的 policy 操作</h4> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">支持的policy 操作：</p> 
    <div class="doc-entry" style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
     <div class="row d193e8184"> 
      <ul style="list-style:none;font-size:12px;">
       <li class="col-md-1" style="list-style-type:disc;"> <span class="label label-success" style="line-height:1.5;">POST&nbsp;</span>/v3/policies 创建一个 policy</li> 
       <li class="col-md-1" style="list-style-type:disc;">GET /v3/policies 获取所有 policys</li> 
       <li class="col-md-1" style="list-style-type:disc;">GET /v3/policys/{policy id} 获取一个policy</li> 
       <li class="col-md-1" style="list-style-type:disc;"><span class="label label-success" style="line-height:1.5;">PATCH&nbsp;/v3/policies/​{policy_id}​ 修改一个 policy</span></li> 
       <li class="col-md-1" style="list-style-type:disc;"> <span class="label label-success" style="line-height:1.5;">DELETE&nbsp;/v3/policies/​{policy_id}​ 删除一个 policy</span><span style="line-height:1.5;">&nbsp;</span> </li> 
      </ul>
     </div> 
    </div> 
    <h4 style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:14px;">2.3.3 Keystone V3 API 中的&nbsp;Endpoint Policy Assignment</h4> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">Keystone 的 V3 API 的&nbsp;OS-ENDPOINT-POLICY 扩展资源提供了 API 来支持：</p> 
    <ul style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:12px;list-style:none;">
     <li style="list-style-type:disc;">给特定的 endpoint 分配 policy。 REST API：&nbsp;/endpoints/{endpoint_id}/OS-ENDPOINT-POLICY/policy</li> 
     <li style="list-style-type:disc;">给特定的 service 的所有 endpoint 分配 policy。 REST API：PUT/DELETE&nbsp;/policies/{policy_id}/OS-ENDPOINT-POLICY/services/{service_id}</li> 
     <li style="list-style-type:disc;">给指定 region 中的指定 service 的所有 endpoint 分配 policy。REST API：GET/HEAD/PUT/DELETE&nbsp;/policies/{policy_id}/OS-ENDPOINT-POLICY/services/{service_id}/regions/{region_id}</li> 
    </ul>
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">支持 policy 存放在 sql db 中。</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">它的实现在&nbsp;/keystone/contrib/endpoint_policy 中。</p> 
    <h4 style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:14px;">2.3.4 Cinder 中的 RBAC (Role Based Access Controll)</h4> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">（1）使用 /etc/cinder/policy.json 文件</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">（2）Volume/Backup/ConsistencyGroup 等 API 类中的接口函数上的&nbsp;@wrap_check_policy 或者在函数体内显式调用 check_policy(context, 'get', volume) 来判断调用用户的 role 是否满足 policy.json 中定义的要求。比如 /volume/api.py 中的 delete 方法：</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">@wrap_check_policy<br> def delete(self, context, volume, force=False, unmanage_only=False)</p> 
    <div class="cnblogs_code" style="color:rgb(0,0,0);font-family:'Courier New';font-size:12px;border:1px solid rgb(204,204,204);"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre><span style="line-height:1.5;">def wrap_check_policy(func):
    </span><span style="color:rgb(128,0,0);line-height:1.5;">"""</span><span style="color:rgb(128,0,0);line-height:1.5;">Check policy corresponding to the wrapped methods prior to execution. </span><span style="line-height:1.5;">This decorator requires the first </span><span style="color:rgb(128,0,128);line-height:1.5;">3</span><span style="line-height:1.5;"> args of the wrapped function  to be (self, context, volume)    </span><span style="color:rgb(128,0,0);line-height:1.5;">"""
</span><span style="line-height:1.5;">    @functools.wraps(func)
    def wrapped(self, context, target_obj, </span>*args, **<span style="line-height:1.5;">kwargs):
        check_policy(context, func.__name__, target_obj)
        </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> func(self, context, target_obj, *args, **<span style="line-height:1.5;">kwargs)
    </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> wrapped

def check_policy(context, action, target_obj</span>=<span style="line-height:1.5;">None):
    target </span>=<span style="line-height:1.5;"> {</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">project_id</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">: context.project_id, </span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">user_id</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">: context.user_id,}
    target.update(target_obj or {})
    _action </span>= <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">volume:%s</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> %<span style="line-height:1.5;"> action
    cinder.policy.enforce(context, _action, target)<br></span></pre> 
     <p style="line-height:1.5;">def enforce(self, rule, target, creds, do_raise=False,&nbsp;exc=None, *args, **kwargs):</p> 
     <p style="line-height:1.5;">&nbsp; &nbsp;&nbsp;<span style="color:rgb(0,0,255);line-height:1.5;">#rule:volume:get_all</span></p> 
     <p style="line-height:1.5;">&nbsp; &nbsp;&nbsp;<span style="color:rgb(0,0,255);line-height:1.5;">#target: {'project_id': u'43f66bb82e684bbe9eb9ef6892bd7fd6', 'user_id': u'1dc0db32a936496ebfc50be54924a7cc'},</span>&nbsp;&nbsp;</p> 
     <p style="line-height:1.5;">&nbsp; &nbsp;&nbsp;<span style="color:rgb(0,0,255);line-height:1.5;">#creds 中包括 user role 等信息</span></p> 
     <p style="line-height:1.5;">&nbsp; &nbsp;&nbsp;self.load_rules()&nbsp;<span style="color:rgb(0,0,255);line-height:1.5;">#重新读取 policy.json 文件</span></p> 
     <p style="line-height:1.5;">&nbsp; &nbsp; ...</p> 
     <p style="line-height:1.5;">&nbsp; &nbsp;&nbsp;result = self.rules[rule](target, creds, self)&nbsp;<span style="color:rgb(0,0,255);line-height:1.5;">#使用特定的 rule 来检查 user 的权限</span></p> 
     <p style="line-height:1.5;">&nbsp; &nbsp; ...</p> 
     <p style="line-height:1.5;">&nbsp; &nbsp; return True or&nbsp;PolicyNotAuthorized(rule)</p> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">cinder 的 policy.json 文件片段：</p> 
    <div class="cnblogs_code" style="color:rgb(0,0,0);font-family:'Courier New';font-size:12px;border:1px solid rgb(204,204,204);"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre><span style="line-height:1.5;">{
    </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">context_is_admin</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">role:admin</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
    </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">admin_or_owner</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>:  <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">is_admin:True or project_id:%(project_id)s</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
    </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">default</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">rule:admin_or_owner</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
    </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">admin_api</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">is_admin:True</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,

    </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">volume:create</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">""</span><span style="line-height:1.5;">,<span style="color:rgb(0,0,255);line-height:1.5;"> #'volume' 是 API 的类别名称，比如’volume‘，’snapshot‘等。任何role的经过验证的用户都可以调用该API。 </span></span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">volume:get_volume_admin_metadata</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">rule:admin_api</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, <span style="color:rgb(0,0,255);line-height:1.5;">#'get_volume_admin_metadata' 是 API 函数名称。该函数需要 is_admin:True。 </span></span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">volume:delete_volume_admin_metadata</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">rule:admin_api</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
    </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">volume:extend</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">""</span><span style="line-height:1.5;">,
    </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">volume:update_readonly_flag</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">""</span><span style="line-height:1.5;">,
    </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">volume:retype</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">""</span><span style="line-height:1.5;">,<br></span></pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">这篇文章&nbsp;<a href="http://bingotree.cn/?p=132" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">HAVANA KEYSTONE中policy.json的解析过程</a>&nbsp;详细分析了该 enfore 过程。</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">如果要添加新的 role 来限制 cinder api 的话，需要（1）在keystone 中创建新的 role （2）修改 cinder 的 policy.json 文件，修改policy条件 （3）设置 user 的role 到新的role.</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">其它模块，比如 nova， glance 等，和 cinder 模块类似，只是区分了 admin role 和 非 admin role 的用户。</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">&nbsp;</p> 
    <h2 style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:21px;line-height:1.5;">3. V3 版本 Keystone API</h2> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;"><img src="https://images0.cnblogs.com/blog/697113/201502/101353016049716.jpg" alt="" style="border:0px;"></p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">V3 与 V2 相比，Keystone 的 API 得到了很大的增强：</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">1. 增加了 Domain，Group，Policy， Catalog 等对象的操作API</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">2. 似乎又将 Tenant 改成了 Project</p> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;"><span style="line-height:1.5;">&nbsp;</span></p> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
     <span style="line-height:1.5;"><br></span>
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
     <span style="line-height:1.5;"><br></span>
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
     <span style="line-height:1.5;"><br></span>
    </div> 
    <div> 
     <span style="line-height:1.5;"> </span>
     <div> 
      <font color="#4b4b4b"><span style="font-size:15px;">&nbsp; &nbsp; 本文转自SammyLiu博客园博客，原文链接：http://www.cnblogs.com/sammyliu/p/4277178.html</span></font>
      <span style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">，如需转载请自行联系原作者</span> 
     </div> 
     <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
      <br>
     </div> 
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
     <span style="line-height:1.5;"><br></span>
    </div> 
   </div> 
   <div class="clear" style="clear:both;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"></div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"></div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
