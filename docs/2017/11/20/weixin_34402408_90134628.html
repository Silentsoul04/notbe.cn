<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Web APi之异常处理（Exception）以及日志记录（NLog）（十六） « NotBeCN</title>
  <meta name="description" content="             前言    上一篇文章我们介绍了关于日志记录用的是Log4net，确实也很挺强大，但是别忘了我们.NET有专属于我们的日志框架，那就是NLog，相对于Log4net而言，NLog可以说也是一个很好的记录日志的框架，并且其中的异步日志等都有非常大的改善，本文借此用了最新的NLog来在Web...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/20/weixin_34402408_90134628.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">Web APi之异常处理（Exception）以及日志记录（NLog）（十六）</h1>
    <p class="post-meta">Nov 20, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <h1 style="font-size:28px;line-height:1.5;font-family:'Helvetica Neue', Arial;">前言</h1> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">上一篇文章我们介绍了关于日志记录用的是Log4net，确实也很挺强大，但是别忘了我们.NET有专属于我们的日志框架，那就是NLog，相对于Log4net而言，NLog可以说也是一个很好的记录日志的框架，并且其中的异步日志等都有非常大的改善，本文借此用了最新的NLog来在Web APi中进行记录日志。</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">NLog</h2> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">第一步则是下载我们需要的程序包，包括程序集以及配置文件</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201512/589642-20151201220956765-1157077015.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">利用NLog记录日志同样可以实现如我们上篇文章利用Log4net来实现的那样，所以在这里就不多说，下面我们来讲另外一种方式，那就是利用.NET内置的跟踪级别类来进行记录日志。从而达到我们所需。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">在NLog.config配置文件中，我们添加如下进行日志的记录【注意：只是简单的利用了NLog，它还是比较强大，更多的详细内容请到官网或通过其他途径进行学习】</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre> &lt;targets&gt;
    &lt;target name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">logfile</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> xsi:type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">File</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> fileName=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">${basedir}/WebAPiNLog/${date:format=yyyyMMdd}.log</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> /&gt; <span style="color:rgb(128,128,0);line-height:1.5;">//在根目录下的WebAPiNlog文件下生成日志</span>
  &lt;/targets&gt;
  &lt;rules&gt;
    &lt;logger name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">*</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> minlevel=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Trace</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> writeTo=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">logfile</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> /&gt;
  &lt;/rules&gt;</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">第二步</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">既然是利用.NET内置的跟踪级别类来实现，那么我们就需要实现其接口&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">ITraceWriter</span>&nbsp;，该接口需要实现如下方法</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>        <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> 摘要: 
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     当且仅当在给定 category 和 level 允许跟踪时，调用指定的 traceAction 以允许在新的 System.Web.Http.Tracing.TraceRecord
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     中设置值。
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span>
        <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> 参数: 
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">   request:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     当前 System.Net.Http.HttpRequestMessage。它可以为 null，但这样做将阻止后续跟踪分析将跟踪与特定请求关联。
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span>
        <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">   category:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     跟踪的逻辑类别。用户可以定义自己的跟踪。
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span>
        <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">   level:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     写入此跟踪时所在的 System.Web.Http.Tracing.TraceLevel。
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span>
        <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">   traceAction:
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">     启用了跟踪时要调用的操作。在此操作中，调用方应填充给定 System.Web.Http.Tracing.TraceRecord 的各个字段。</span>
        <span style="color:rgb(0,0,255);line-height:1.5;">void</span> Trace(HttpRequestMessage request, <span style="color:rgb(0,0,255);line-height:1.5;">string</span> category, TraceLevel level, Action&lt;TraceRecord&gt; traceAction);</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">【注意】利用内置的跟踪级别则需要引用如下命名空间</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">using</span> System.Web.Http.Tracing;</pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">首先创建一个NLogger类并实现如上接口，当然我们也得创建NLog实例并利用其实例进行级别处理，如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre> <span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">readonly</span> Logger NlogLogger = LogManager.GetCurrentClassLogger();</pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">接着我们该如何做呢？我们需要利用&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">TraceLevel</span>&nbsp;跟踪级别，同时结合NLog得到相应的级别信息，可能创建对象实例的过程比较长，我们可以利用Lazy&lt;&gt;来实现延迟加载，代码如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>  <span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">readonly</span> Lazy&lt;Dictionary&lt;TraceLevel, Action&lt;<span style="color:rgb(0,0,255);line-height:1.5;">string</span>&gt;&gt;&gt; LoggingMap = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> Lazy&lt;Dictionary&lt;TraceLevel, Action&lt;<span style="color:rgb(0,0,255);line-height:1.5;">string</span>&gt;&gt;&gt;<span style="line-height:1.5;">
            (() </span>=&gt; <span style="color:rgb(0,0,255);line-height:1.5;">new</span> Dictionary&lt;TraceLevel, Action&lt;<span style="color:rgb(0,0,255);line-height:1.5;">string</span>&gt;&gt;<span style="line-height:1.5;"> 
            {{ TraceLevel.Info, NlogLogger.Info }, 
            { TraceLevel.Debug, NlogLogger.Debug },
            { TraceLevel.Error, NlogLogger.Error }, 
            { TraceLevel.Fatal, NlogLogger.Fatal }, 
            { TraceLevel.Warn, NlogLogger.Warn } 
            });</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">然后，我们定义一个属性来返回其实例的值，如下</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre> <span style="color:rgb(0,0,255);line-height:1.5;">private</span> Dictionary&lt;TraceLevel, Action&lt;<span style="color:rgb(0,0,255);line-height:1.5;">string</span>&gt;&gt;<span style="line-height:1.5;"> Logger
 {
       </span><span style="color:rgb(0,0,255);line-height:1.5;">get</span> { <span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> LoggingMap.Value; }
 }</span></pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">紧接着我们就是实现上述ITraceWriter接口</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre> <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span> Trace(System.Net.Http.HttpRequestMessage request, <span style="color:rgb(0,0,255);line-height:1.5;">string</span> category, TraceLevel level, Action&lt;TraceRecord&gt;<span style="line-height:1.5;"> traceAction)
 {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (level !=<span style="line-height:1.5;"> TraceLevel.Off) <span style="color:rgb(128,128,0);line-height:1.5;">//如果没用禁用日志跟踪</span>
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (traceAction != <span style="color:rgb(0,0,255);line-height:1.5;">null</span> &amp;&amp; traceAction.Target != <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">)
                {
                    category </span>= category + Environment.NewLine + <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Action Parameters : </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> +<span style="line-height:1.5;"> JsonConvert.SerializeObject(traceAction.Target);
                }
                </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> record = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> TraceRecord(request, category, level);
                </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (traceAction != <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">) traceAction(record);
                Log(record);
            }

 }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">我们记录请求的参数，URL，以及Token、返回的JSON等等，上述Log方法则如下</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre> <span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> Log(TraceRecord record)
 {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> message = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> StringBuilder();

            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (!<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;">.IsNullOrWhiteSpace(record.Message))
                message.Append(</span><span style="color:rgb(128,0,0);line-height:1.5;">""</span>).Append(record.Message +<span style="line-height:1.5;"> Environment.NewLine);

            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (record.Request != <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">)
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (record.Request.Method != <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">)
                    message.Append(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Method: </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> + record.Request.Method +<span style="line-height:1.5;"> Environment.NewLine);

                </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (record.Request.RequestUri != <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">)
                    message.Append(</span><span style="color:rgb(128,0,0);line-height:1.5;">""</span>).Append(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">URL: </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> + record.Request.RequestUri +<span style="line-height:1.5;"> Environment.NewLine);

                </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (record.Request.Headers != <span style="color:rgb(0,0,255);line-height:1.5;">null</span> &amp;&amp; record.Request.Headers.Contains(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Token</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>) &amp;&amp; record.Request.Headers.GetValues(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Token</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>) != <span style="color:rgb(0,0,255);line-height:1.5;">null</span> &amp;&amp; record.Request.Headers.GetValues(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Token</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>).FirstOrDefault() != <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">)
                    message.Append(</span><span style="color:rgb(128,0,0);line-height:1.5;">""</span>).Append(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Token: </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> + record.Request.Headers.GetValues(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Token</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>).FirstOrDefault() +<span style="line-height:1.5;"> Environment.NewLine);
            }

            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (!<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;">.IsNullOrWhiteSpace(record.Category))
                message.Append(</span><span style="color:rgb(128,0,0);line-height:1.5;">""</span><span style="line-height:1.5;">).Append(record.Category);

            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (!<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;">.IsNullOrWhiteSpace(record.Operator))
                message.Append(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> <span style="color:rgb(128,0,0);line-height:1.5;">"</span>).Append(record.Operator).Append(<span style="color:rgb(128,0,0);line-height:1.5;">"</span> <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">).Append(record.Operation);
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">第三步&nbsp;</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">我们自定义日志特性取名为&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">NLogFilterAttribute</span>&nbsp;，我们在访问Action时来进行记载日志也就是需要继承于&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">ActionFilterAttribute</span>&nbsp;，简单来说代码如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre> <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> NLogFilterAttribute : ActionFilterAttribute
 {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">override</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> OnActionExecuting(HttpActionContext filterContext)
        {......}
 }</span></pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><span style="font-size:16px;"><strong style="line-height:normal;"><span style="color:rgb(255,102,0);">那么问题来了，.NET默认确确实实是走得内置的跟踪级别，我们如何让其实现我们上述实现的接口的级别呢？</span></strong></span></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><span style="color:rgb(255,102,0);"><span style="color:rgb(0,0,0);">此时我们之前所学就派上了一点用场，我们将其服务容器的关于ITraceWriter接口实现进行替换我们自定义实现的接口即可，用如下一句即可</span></span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>GlobalConfiguration.Configuration.Services.Replace(<span style="color:rgb(0,0,255);line-height:1.5;">typeof</span>(ITraceWriter), <span style="color:rgb(0,0,255);line-height:1.5;">new</span> NLogHelper());</pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">接下来就是从服务容器中获取我们自定义实现的跟踪级别</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre> <span style="color:rgb(0,0,255);line-height:1.5;">var</span> trace = GlobalConfiguration.Configuration.Services.GetTraceWriter();</pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">然后调用比如说隔离级别中的Info，获取其访问的控制器名、Action名称以及JSON等数据，如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre><span style="line-height:1.5;">  trace.Info(filterContext.Request, 
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Controller : </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> + filterContext.ControllerContext.ControllerDescriptor.ControllerType.FullName + Environment.NewLine + 
                <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Action : </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> +<span style="line-height:1.5;"> filterContext.ActionDescriptor.ActionName, 
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">JSON</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, filterContext.ActionArguments);  </pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">我们简单个给出所请求的控制器以及需要返回的数据，如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> AboutController : ApiController
    {
        [POST(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">about</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">)]
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> about()
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> test = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;">
            {
                name </span>= <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">xpy0928</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                gender </span>= <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">男</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                age </span>= <span style="color:rgb(128,0,128);line-height:1.5;">12</span><span style="line-height:1.5;">
            };
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> Newtonsoft.Json.JsonConvert.SerializeObject(test);
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">接下来我们利用WebAPiTestOnHelpPage进行测试，看结果是否如我们所期望</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201512/589642-20151201225053562-929424761.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">结果如我们所期待的那样</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201512/589642-20151201225154843-741823602.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">但是我们的重点是是否生成了相应的日志，我们一起来看下：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201512/589642-20151201225333812-613558198.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">到此，关于利用.NET内置的跟踪级别结合NLog来实现日志的记录也就告一段落，接下来我们来看看异常处理</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">Exception</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">既然异常处理，那么我们当然就得利用自定义异常特性实现&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">ExceptionFilterAttribute</span>&nbsp;，其基本实现如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre> <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> CustomExceptionAttribute:ExceptionFilterAttribute
 {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">override</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> OnException(HttpActionExecutedContext actionExecutedContext)
        {....}
 }</span></pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">关于其实现和上面大同小异，如下</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>            GlobalConfiguration.Configuration.Services.Replace(<span style="color:rgb(0,0,255);line-height:1.5;">typeof</span>(ITraceWriter), <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> NLogHelper());
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> trace =<span style="line-height:1.5;"> GlobalConfiguration.Configuration.Services.GetTraceWriter();
            trace.Error(actionExecutedContext.Request, </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Controller : </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> + actionExecutedContext.ActionContext.ControllerContext.ControllerDescriptor.ControllerType.FullName + Environment.NewLine + <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Action : </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> +<span style="line-height:1.5;"> actionExecutedContext.ActionContext.ActionDescriptor.ActionName, actionExecutedContext.Exception);

            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> exceptionType =<span style="line-height:1.5;"> actionExecutedContext.Exception.GetType();

            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (exceptionType == <span style="color:rgb(0,0,255);line-height:1.5;">typeof</span><span style="line-height:1.5;">(ValidationException))
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> resp = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> HttpResponseMessage(HttpStatusCode.BadRequest) { Content = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> StringContent(actionExecutedContext.Exception.Message), ReasonPhrase = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ValidationException</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, };
                </span><span style="color:rgb(0,0,255);line-height:1.5;">throw</span> <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> HttpResponseException(resp);

            }
            </span><span style="color:rgb(0,0,255);line-height:1.5;">else</span> <span style="color:rgb(0,0,255);line-height:1.5;">if</span> (exceptionType == <span style="color:rgb(0,0,255);line-height:1.5;">typeof</span><span style="line-height:1.5;">(UnauthorizedAccessException))
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">throw</span> <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> HttpResponseException(actionExecutedContext.Request.CreateResponse(HttpStatusCode.Unauthorized));
            }
            </span><span style="color:rgb(0,0,255);line-height:1.5;">else</span><span style="line-height:1.5;">
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">throw</span> <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> HttpResponseException(actionExecutedContext.Request.CreateResponse(HttpStatusCode.InternalServerError));
            }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">此时我们还需要在日志NLogger类中添加如下一句</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>             <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">处理异常</span>
            <span style="color:rgb(0,0,255);line-height:1.5;">if</span> (record.Exception != <span style="color:rgb(0,0,255);line-height:1.5;">null</span> &amp;&amp; !<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;">.IsNullOrWhiteSpace(record.Exception.GetBaseException().Message))
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> exceptionType =<span style="line-height:1.5;"> record.Exception.GetType();
                message.Append(Environment.NewLine);
                message.Append(</span><span style="color:rgb(128,0,0);line-height:1.5;">""</span>).Append(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Error: </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> + record.Exception.GetBaseException().Message +<span style="line-height:1.5;"> Environment.NewLine);
            }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">如此就基本实现了利用NLog记录异常，当然我们可以自定义个异常类来更好的管理异常例如，如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> ApiExceptions:Exception
    {

        </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span> ErrorCode { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">string</span> ErrorDescription { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }

        HttpStatusCode HttpStatus { </span><span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }
</span><span style="line-height:1.5;">
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">总结</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">本节我们学习了利用NLog来实现记录异常通过集合内置的跟踪级别。NLog是属于.NET所以就单独拿来讲讲，其强大也是不可言喻的。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p><font color="#111111"><span style="font-size:13px;line-height:23.4px;">本文转自Jeffcky博客园博客，原文链接：http://www.cnblogs.com/CreateMyself/p/4999217.html，如需转载请自行联系原作者</span></font></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
