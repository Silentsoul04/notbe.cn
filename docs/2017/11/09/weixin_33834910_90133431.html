<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>在C++中反射调用.NET（三） « NotBeCN</title>
  <meta name="description" content="             使用非泛型集合的委托方法    先看看.NET类中的一个返回列表数据的方法：                        //返回List或者数组，不影响 C++调用        public List&lt;IUserInfo&gt; GetUsers(string likeNam...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/09/weixin_33834910_90133431.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">在C++中反射调用.NET（三）</h1>
    <p class="post-meta">Nov 9, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <h2 style="font-size:21px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;">使用非泛型集合的委托方法</h2> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">先看看.NET类中的一个返回列表数据的方法：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre> <span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">返回List或者数组，不影响 C++调用</span>
        <span style="color:rgb(0,0,255);line-height:1.5;">public</span> List&lt;IUserInfo&gt; GetUsers(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> likeName)
        {
            List</span>&lt;IUserInfo&gt; users = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> List&lt;NetLib.IUserInfo&gt;<span style="line-height:1.5;">();
            </span><span style="color:rgb(0,0,255);line-height:1.5;">for</span> (<span style="color:rgb(0,0,255);line-height:1.5;">int</span> i = <span style="color:rgb(128,0,128);line-height:1.5;">0</span>; i &lt; <span style="color:rgb(128,0,128);line-height:1.5;">10</span>; i++<span style="line-height:1.5;">)
            {
                IUserInfo userinfo </span>=<span style="line-height:1.5;"> GetUserByID(i);
                userinfo.Name </span>+=<span style="line-height:1.5;"> likeName;
                users.Add(userinfo);
            }
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">return users.ToArray();</span>
            <span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> users;
        }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre> <span style="color:rgb(0,0,255);line-height:1.5;">public</span> IUserInfo GetUserByID(<span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> userId)
        {
            IUserInfo userinfo</span>= EntityBuilder.CreateEntity&lt;IUserInfo&gt;<span style="line-height:1.5;">();
            userinfo.ID </span>=<span style="line-height:1.5;"> userId;
            userinfo.Name </span>= <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">姓名_</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> +<span style="line-height:1.5;"> userId;
            userinfo.Birthday </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> DateTime(<span style="color:rgb(128,0,128);line-height:1.5;">1980</span>, <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, <span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">);

            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> userinfo;
        }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">该方法没有什么复杂业务逻辑，就是将传递进来的参数给DTO对象，创建包含10个这样的对象的列表并返回而已。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">对于 GetUsers方法，我们可以创建下面的委托方法来绑定：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>Func&lt;String, IEnumerable&gt; fun;</pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">注意这里使用的是非泛型的 IEnumerable接口，在C++需要使用下面这个命名空间：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">using</span> <span style="color:rgb(0,0,255);line-height:1.5;">namespace</span> System::Collections;</pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">那么为何不能使用泛型集合呢？</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">using</span> <span style="color:rgb(0,0,255);line-height:1.5;">namespace</span> System::Collections::Generic;</pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">因为在C++端，没有直接引用用户项目的.NET程序集，并不知道泛型集合类型的具体类型，IUserInfo这个接口无法直接访问，好在IEnumerable&lt;T&gt;也是继承 IEnumerable 的，所以可以当做非泛型对象在C++中访问，因此创建上面的委托方法是可行的。</p> 
   <h2 style="font-size:21px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;">C++中的列表对象list</h2> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">下面看看完整的C++/CLI反射调用的代码：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>        std::list&lt;CppUserInfo&gt; GetUsers(String^<span style="line-height:1.5;"> likeName)
        {
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">调用.NET方法，得到结果</span>
            MethodInfo^ method = dotnetObject-&gt;GetType()-&gt;GetMethod(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">GetUsers</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, BindingFlags::Public |<span style="line-height:1.5;"> BindingFlags::Instance);
            Func</span>&lt;String^, IEnumerable^&gt;^ fun = (Func&lt;String^, IEnumerable^&gt;^)Delegate::CreateDelegate(Func&lt;String^, IEnumerable^&gt;<span style="line-height:1.5;">::typeid, 
                </span><span style="color:rgb(0,0,255);line-height:1.5;">this</span>-&gt;<span style="line-height:1.5;">dotnetObject, method);
            IEnumerable</span>^ result =<span style="line-height:1.5;"> fun(likeName);

            std::list</span>&lt;CppUserInfo&gt;<span style="line-height:1.5;"> cppResult;

            </span><span style="color:rgb(0,0,255);line-height:1.5;">for</span> each (Object^ item <span style="color:rgb(0,0,255);line-height:1.5;">in</span><span style="line-height:1.5;"> result)
            {
                Func</span>&lt;String^, Object^&gt;^ entityProp =<span style="line-height:1.5;"> EntityHelper::EntityCallDelegate(item);
                CppUserInfo user;
                user.ID </span>= (<span style="color:rgb(0,0,255);line-height:1.5;">int</span>)entityProp(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ID</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
                user.Name </span>= (String^)entityProp(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Name</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
                user.Birthday </span>= Convert2CppDateTime((DateTime^)entityProp(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Birthday</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">));

                cppResult.push_back(user);
            }

            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> cppResult;
        }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">在C++中，常常使用 list来表示一个列表数据，例如上面方法中的代码：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>std::list&lt;CppUserInfo&gt; cppResult;</pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">为此C++需要包含以下头文件：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>#include &lt;list&gt;</pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;要将一个对象添加到列表结尾，像下面这样调用即可：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>cppResult.push_back(user);</pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">在上一篇中已经讲述了如何从.NET对象转换给C++本地结构体，所以这个转换代码可以直接拿来用，综合起来，要从.NET集合得到C++的列表对象，像下面这样使用：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>std::list&lt;CppUserInfo&gt;<span style="line-height:1.5;"> cppResult;

            </span><span style="color:rgb(0,0,255);line-height:1.5;">for</span> each (Object^ item <span style="color:rgb(0,0,255);line-height:1.5;">in</span><span style="line-height:1.5;"> result)
            {
                Func</span>&lt;String^, Object^&gt;^ entityProp =<span style="line-height:1.5;"> EntityHelper::EntityCallDelegate(item);
                CppUserInfo user;
                user.ID </span>= (<span style="color:rgb(0,0,255);line-height:1.5;">int</span>)entityProp(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ID</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
                user.Name </span>= (String^)entityProp(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Name</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
                user.Birthday </span>= Convert2CppDateTime((DateTime^)entityProp(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Birthday</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">));

                cppResult.push_back(user);
            }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h2 style="font-size:21px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;">&nbsp;C++传递集合数据给.NET</h2> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">前面讲了从.NET反射调用获得一个集合，看起来比较容易，但是从C++反射调用时候传递一个集合就不容易了。注意，这里传递的还是.NET的集合，所以这里需要做3件事情：<br> 1，首先构建一个.NET集合对象；<br> 2，转换C++本机结构数据到.NET集合元素；<br> 3，反射调用.NET方法，传递数据过去。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">先看要反射调用的.NET方法定义：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>        <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">bool</span> SaveUsers(IList&lt;IUserInfo&gt;<span style="line-height:1.5;"> users)
        {
            UserDb.AddRange(users);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">;
        }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">方法非常简单，没有什么业务逻辑，接受一个列表接口的数据，然后返回一个布尔值。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">在C++端看来，SaveUsers方法的参数对象是一个泛型集合，但是具体是什么对象并不知道，所以需要反射出泛型集合的类型，同时还需要构建这样一个泛型集合对象实例。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">在本例中，要得到IUserInfo 这个泛型集合的类型，可以通过下面的代码：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>MethodInfo^ method = dotnetObject-&gt;GetType()-&gt;GetMethod(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">SaveUsers</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, BindingFlags::Public |<span style="line-height:1.5;"> BindingFlags::Instance);
array</span>&lt;ParameterInfo^&gt;^ pars = method-&gt;<span style="line-height:1.5;">GetParameters();
Type</span>^ paraType= pars[<span style="color:rgb(128,0,128);line-height:1.5;">0</span>]-&gt;<span style="line-height:1.5;">ParameterType;
Type</span>^ interfaceType = paraType-&gt;GetGenericArguments()[<span style="color:rgb(128,0,128);line-height:1.5;">0</span>];</pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">注意上面的代码中使用了C++/CLI的数组类型 array&lt;Type^&gt;^ ,而不是C++标准库的数组，因此不要引用下面的命名空间：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">using</span> <span style="color:rgb(0,0,255);line-height:1.5;">namespace</span> std;</pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">否则VS会提示数组定义缺少参数。</p> 
   <h2 style="font-size:21px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;">创建泛型List实例</h2> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">我们使用List来做集合对象，在C#中，我们可以通过下面的方式得到List泛型的类型，然后进一步创建泛型对象实例：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>Type t= <span style="color:rgb(0,0,255);line-height:1.5;">typeof</span>(List&lt;&gt;);</pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">但是，对应的C++/CLI写法却无法通过编译：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>Type^ t=List&lt;&gt;::typeid;</pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">VS总是提示List缺少类型参数，不过像下面这样子是可以的：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>Type^ t2= List&lt;IUserInfo&gt;::typeid;</pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">但是IUserInfo 类型正是我们要动态反射的，事先并不知道，所以一时不知道在C++/CLI中如何构建List泛型的具体实例，MS你不能这么坑好么？</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">既然无法直接解决，只好曲线救国了，通过类型名字，来创建类型：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre> String^ listTypeName = System::String::Format(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">System.Collections.Generic.List`1[{0}]</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, interfaceType-&gt;FullName);</pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">可惜，这种方式不成功，只好一步步来了，先创建基本的List泛型类型：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>    String^ listTypeName = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">System.Collections.Generic.List`1</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">;
    Type</span>^ listType = System::Type::GetType(listTypeName);</pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">成功，在此基础上，创建真正的泛型List对象实例就可以了，完整代码如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">static</span> Type^ CreateGenericListType(Type^<span style="line-height:1.5;"> interfaceType)
    {
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">直接这样创建泛型List不成功：
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">  String^ listTypeName = System::String::Format("System.Collections.Generic.List`1[{0}]", interfaceType-&gt;FullName);</span>
        String^ listTypeName = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">System.Collections.Generic.List`1</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">;
        Type</span>^ listType =<span style="line-height:1.5;"> System::Type::GetType(listTypeName);

        Type</span>^ generListType = listType-&gt;<span style="line-height:1.5;">MakeGenericType(interfaceType);
        </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> generListType;
    }

    </span><span style="color:rgb(0,0,255);line-height:1.5;">static</span> IList^ CreateGenericList(Type^<span style="line-height:1.5;"> interfaceType)
    {
        Type</span>^ generListType =<span style="line-height:1.5;"> CreateGenericListType(interfaceType);

        Object</span>^ listObj =<span style="line-height:1.5;"> System::Activator::CreateInstance(generListType, nullptr);
        IList</span>^ realList = (IList^<span style="line-height:1.5;">)listObj;
        </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> realList;
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><br> 在方法 CreateGenericListType得到只是一个泛型List的类型，但我们并不知道这个List具体的形参类型，所以这个泛型List还是无法直接使用，幸好，泛型List也是继承自非泛型的IList接口的，所以在 CreateGenericList 方法中将泛型List对象转换成IList接口对象，之后就可以愉快的使用List对象了。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>IList^ realList =<span style="line-height:1.5;"> CreateGenericList(interfaceType);
realList</span>-&gt;Add(CurrEntity);<span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">CurrEntity 是interfaceType 类型的动态实体类</span></pre>
   </div> 
   <h2 style="font-size:21px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;">反射静态方法</h2> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">在上一篇中，我们在一个.NET方法中通过接口动态创建实体类，用的是下面的方式：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>IUserInfo userinfo= EntityBuilder.CreateEntity&lt;IUserInfo&gt;();</pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">CreateEntity是EntityBuilder的静态方法，现在我们需要在C++/CLI中，反射调用此方法。<br> 为什么要反射创建实体类？<br> 因为CreateGenericList(interfaceType) 创建的是一个泛型List对象，要求它的成员是一个实体类。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>Object^ CreateEntityFromInterface(Type^<span style="line-height:1.5;"> interfaceType)
        {
            MethodInfo</span>^ method = <span style="color:rgb(0,0,255);line-height:1.5;">this</span>-&gt;entityBuilderType-&gt;GetMethod(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">CreateEntity</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, BindingFlags::Public |<span style="line-height:1.5;"> BindingFlags::Static);
            MethodInfo</span>^ genMethod = method-&gt;<span style="line-height:1.5;">MakeGenericMethod(interfaceType);
            Object</span>^ entity = genMethod-&gt;<span style="line-height:1.5;">Invoke(nullptr, nullptr);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">this</span>-&gt;CurrEntity =<span style="line-height:1.5;"> entity;
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> entity;
        }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">注意，由于是反射调用静态方法，并且调用方法时候并不需要参数，所以Invoke方法的参数为空。<br> 在C++/CLI中，用nullptr表示空引用，跟C#的null作用一样。</p> 
   <h2 style="font-size:21px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;">反射调用索引器</h2> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">SOD实体类可以通过索引器来访问对象属性，例如下面的C#代码：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">int</span> id=(<span style="color:rgb(0,0,255);line-height:1.5;">int</span>)CurrEntity[<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ID</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">];
CurrEntity[</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Name</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>]=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">张三</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">;
</span><span style="color:rgb(0,0,255);line-height:1.5;">string</span> name=(<span style="color:rgb(0,0,255);line-height:1.5;">string</span>)CurrEntity[<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Name</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>];<span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">张三</span></pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">下面，我们研究如何通过索引器来给实体类的属性赋值：</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">我们定义一个 EntityHelper的C++/CLI类，在中间添加下面的代码：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;">:
        Type</span>^<span style="line-height:1.5;"> entityBuilderType;
        MethodInfo</span>^<span style="line-height:1.5;"> mset; 
        Object</span>^<span style="line-height:1.5;"> _CurrEntity;
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">Action&lt;String^, Object^&gt;^ idxAction;</span>

        <span style="color:rgb(0,0,255);line-height:1.5;">void</span> SetPropertyValue(Object^ entity, MethodInfo^ propMethod, String^ propName, Object^<span style="line-height:1.5;"> value)
        {
            array</span>&lt;Object^&gt;^ paraArr = gcnew array&lt;Object^&gt;<span style="line-height:1.5;">{propName, value};
            propMethod</span>-&gt;<span style="line-height:1.5;">Invoke(entity, paraArr);
        }

</span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;">:

</span><span style="color:rgb(0,0,255);line-height:1.5;">void</span> <span style="color:rgb(0,0,255);line-height:1.5;">set</span>(Object^<span style="line-height:1.5;"> value)
{
  </span><span style="color:rgb(0,0,255);line-height:1.5;">this</span>-&gt;mset = _CurrEntity-&gt;GetType()-&gt;GetMethod(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">set_Item</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, BindingFlags::Public |<span style="line-height:1.5;">      BindingFlags::Instance);
    </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">this-&gt;idxAction= (Action&lt;String^, Object^&gt;^)Delegate::CreateDelegate(Action&lt;String^, Object^&gt;::typeid, _CurrEntity, this-&gt;mset);</span>
<span style="line-height:1.5;">}

</span><span style="color:rgb(0,0,255);line-height:1.5;">void</span> SetPropertyValue(String^ propName, Object^<span style="line-height:1.5;"> value)
{
    </span><span style="color:rgb(0,0,255);line-height:1.5;">this</span>-&gt;SetPropertyValue(<span style="color:rgb(0,0,255);line-height:1.5;">this</span>-&gt;CurrEntity, <span style="color:rgb(0,0,255);line-height:1.5;">this</span>-&gt;<span style="line-height:1.5;">mset, propName, value);
    </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">参数类型为 Object的委托，可能没有性能优势，反而更慢。
    </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">this-&gt;idxAction(propName, value);</span>
}</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">对索引器的访问，实际上就是调用类的 set_Item 方法，VS编译器会给包含索引器的对象生成这个方法，一般来说我们会对要反射调用的方法创建一个委托，但是实验证明，对索引器使用委托方法调用，反而效率不如直接反射调用，即下面的代码：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">void</span> SetPropertyValue(Object^ entity, MethodInfo^ propMethod, String^ propName, Object^<span style="line-height:1.5;"> value)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; array</span>&lt;Object^&gt;^ paraArr = gcnew array&lt;Object^&gt;<span style="line-height:1.5;">{propName, value};
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; propMethod</span>-&gt;<span style="line-height:1.5;">Invoke(entity, paraArr);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">注：C++/CLI 的数组，也可以通过{ } 进行初始化。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">一切准备就绪，下面可以通过以下步骤提交集合数据给.NET方法了：<br> 1，反射.NET方法，获取参数的泛型形参类型；<br> 2，创建此泛型形参的泛型List对象实例；<br> 3，遍历C++集合（列表list），将结构数据赋值给动态创建的实体类对象；<br> 4，添加动态实体类到泛型List对象集合内；<br> 5，反射调用.NET方法，提交数据。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,128,0);line-height:1.5;">        //</span><span style="color:rgb(0,128,0);line-height:1.5;">示例1：直接调用.NET强类型的参数方法
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">仅仅适用于有一个参数的情况并且要求是泛型类型参数</span>
        <span style="color:rgb(0,0,255);line-height:1.5;">bool</span> SaveUsers(std::list&lt;CppUserInfo&gt;<span style="line-height:1.5;"> users)
        {
            MethodInfo</span>^ method = dotnetObject-&gt;GetType()-&gt;GetMethod(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">SaveUsers</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, BindingFlags::Public |<span style="line-height:1.5;"> BindingFlags::Instance);
            array</span>&lt;ParameterInfo^&gt;^ pars = method-&gt;<span style="line-height:1.5;">GetParameters();
            Type</span>^ paraType= pars[<span style="color:rgb(128,0,128);line-height:1.5;">0</span>]-&gt;<span style="line-height:1.5;">ParameterType;
            Type</span>^ interfaceType = paraType-&gt;GetGenericArguments()[<span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">];

            IList</span>^ realList =<span style="line-height:1.5;"> CreateGenericList(interfaceType);
            Object</span>^ userObj = helper-&gt;<span style="line-height:1.5;">CreateEntityFromInterface(interfaceType);

            </span><span style="color:rgb(0,0,255);line-height:1.5;">for</span> each (CppUserInfo user <span style="color:rgb(0,0,255);line-height:1.5;">in</span><span style="line-height:1.5;"> users)
            {
                helper</span>-&gt;CurrEntity = ((ICloneable^)userObj)-&gt;Clone();<span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">使用克隆，避免每次反射</span>
                helper-&gt;SetPropertyValue(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ID</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, user.ID);
                helper</span>-&gt;SetPropertyValue(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Name</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, gcnew String(user.Name));
                helper</span>-&gt;SetPropertyValue(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Birthday</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, Covert2NetDateTime(user.Birthday));

                realList</span>-&gt;Add(helper-&gt;<span style="line-height:1.5;">CurrEntity);
            }
            
            Object</span>^ result= method-&gt;Invoke(dotnetObject, gcnew array&lt;Object^&gt;<span style="line-height:1.5;">{ realList});
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> (<span style="color:rgb(0,0,255);line-height:1.5;">bool</span><span style="line-height:1.5;">)result;
        }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h1 style="font-size:28px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;">使用弱类型集合传输数据</h1> 
   <h2 style="font-size:21px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;">当委托遇到协变和逆变</h2> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">看看下面两个委托方法，哪个可以绑定到本文说的这个.NET方法：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">bool</span> SaveUsers(IList&lt;IUserInfo&gt;<span style="line-height:1.5;"> users){ }
Func</span>&lt;List&lt;IUserInfo&gt;,<span style="color:rgb(0,0,255);line-height:1.5;">bool</span>&gt;<span style="line-height:1.5;"> fun;
Func</span>&lt;List&lt;Object&gt;,<span style="color:rgb(0,0,255);line-height:1.5;">bool</span>&gt; fun2;</pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><br> 很明显，委托方法 fun2不能绑定，因为参数是 in 的，不是方法out的，所以调用的参数类型不能使用派生程度更小的类型；</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">再看看下面这种情况：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>List&lt;IUserInfo&gt; GetUsers(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> likeName){ }

Func</span>&lt;<span style="color:rgb(0,0,255);line-height:1.5;">string</span>,IEnumerable&lt;IUserInfo&gt;&gt;<span style="line-height:1.5;"> fun;
Func</span>&lt;<span style="color:rgb(0,0,255);line-height:1.5;">string</span>,IEnumerable&gt; fun2;</pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><br> 这里，fun,fun2都可以绑定到方法上，因为泛型方法的形参作为返回值，是out的，可以使用派生程度更小的类型。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">这是不是很熟悉的泛型类型的 协变和逆变？</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">我们知道，反射的时候，利用委托绑定要反射的方法，能够大大提高方法的调用效率，所以对于我们的方法参数，如果调用的时候无法获知具体的类型，从而无法正确构造合适的委托方法，不如退而求其次，让被调用的方法参数采用弱类型方式，这样就可以构造对应的委托方法了。<br> 因此，对我们.NET方法中的 SaveUsers 进行改造：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre> <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">bool</span> SaveUsers(IList&lt;IUserInfo&gt;<span style="line-height:1.5;"> users)
        {
            UserDb.AddRange(users);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">;
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> IUserInfo CreateUserObject()
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> EntityBuilder.CreateEntity&lt;IUserInfo&gt;<span style="line-height:1.5;">();
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">bool</span> SaveUsers2(IEnumerable&lt;Object&gt;<span style="line-height:1.5;"> para)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> users = <span style="color:rgb(0,0,255);line-height:1.5;">from</span> u <span style="color:rgb(0,0,255);line-height:1.5;">in</span><span style="line-height:1.5;"> para
                        </span><span style="color:rgb(0,0,255);line-height:1.5;">select</span> u <span style="color:rgb(0,0,255);line-height:1.5;">as</span><span style="line-height:1.5;"> IUserInfo;
           
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> SaveUsers (users.ToList());
        }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">这里增加一个方法 SaveUsers2，它采用IEnumerable&lt;Object&gt; ,而不是更为具体的&nbsp; IList&lt;IUserInfo&gt;，那么采用下面的方式构造方法 SaveUsers2 对应的委托方法就可以了：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>MethodInfo^ method = dotnetObject-&gt;GetType()-&gt;GetMethod(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">SaveUsers2</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, BindingFlags::Public |<span style="line-height:1.5;"> BindingFlags::Instance);
Func</span>&lt;System::Collections::Generic::IEnumerable&lt;Object^&gt;^,<span style="color:rgb(0,0,255);line-height:1.5;">bool</span>&gt;^ fun2 = <br>
(Func&lt;System::Collections::Generic::IEnumerable&lt;Object^&gt;^, <span style="color:rgb(0,0,255);line-height:1.5;">bool</span>&gt;^)Delegate::CreateDelegate(System::Func&lt;Collections::Generic::IEnumerable&lt;Object^&gt;^, <span style="color:rgb(0,0,255);line-height:1.5;">bool</span>&gt;<span style="line-height:1.5;">::typeid,
                </span><span style="color:rgb(0,0,255);line-height:1.5;">this</span>-&gt;dotnetObject, method);</pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">这样要构造一个泛型List就不必像之前的方法那么麻烦了：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>System::Collections::Generic::List&lt;Object^&gt;^ list = gcnew System::Collections::Generic::List&lt;Object^&gt;;</pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">反射调用SaveUser2完整的代码如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">示例2：调用.NET弱类型的参数方法，以便通过委托方法调用
        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">构建委托方法比较容易，适用于参数数量多于1个的情况，</span>
        <span style="color:rgb(0,0,255);line-height:1.5;">bool</span> SaveUsers2(std::list&lt;CppUserInfo&gt;<span style="line-height:1.5;"> users)
        {
            MethodInfo</span>^ method = dotnetObject-&gt;GetType()-&gt;GetMethod(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">SaveUsers2</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, BindingFlags::Public |<span style="line-height:1.5;"> BindingFlags::Instance);
            Func</span>&lt;System::Collections::Generic::IEnumerable&lt;Object^&gt;^,<span style="color:rgb(0,0,255);line-height:1.5;">bool</span>&gt;^ fun2 =<br>
(Func&lt;System::Collections::Generic::IEnumerable&lt;Object^&gt;^, <span style="color:rgb(0,0,255);line-height:1.5;">bool</span>&gt;^)Delegate::CreateDelegate(System::Func&lt;Collections::Generic::IEnumerable&lt;Object^&gt;^, <span style="color:rgb(0,0,255);line-height:1.5;">bool</span>&gt;<span style="line-height:1.5;">::typeid,
                        </span><span style="color:rgb(0,0,255);line-height:1.5;">this</span>-&gt;<span style="line-height:1.5;">dotnetObject, method);
            
            Object</span>^ userObj =<span style="line-height:1.5;"> CreateUserObject();
            System::Collections::Generic::List</span>&lt;Object^&gt;^ list = gcnew System::Collections::Generic::List&lt;Object^&gt;<span style="line-height:1.5;">;

            </span><span style="color:rgb(0,0,255);line-height:1.5;">for</span> each (CppUserInfo user <span style="color:rgb(0,0,255);line-height:1.5;">in</span><span style="line-height:1.5;"> users)
            {
                helper</span>-&gt;CurrEntity = ((ICloneable^)userObj)-&gt;Clone();<span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">使用克隆，避免每次反射</span>
                helper-&gt;SetPropertyValue(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ID</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, user.ID);
                helper</span>-&gt;SetPropertyValue(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Name</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, gcnew String(user.Name));
                helper</span>-&gt;SetPropertyValue(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Birthday</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, Covert2NetDateTime(user.Birthday));

                list</span>-&gt;Add(helper-&gt;<span style="line-height:1.5;">CurrEntity);
            }

            </span><span style="color:rgb(0,0,255);line-height:1.5;">bool</span> result =<span style="line-height:1.5;"> fun2(list);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> result;
        }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <h1 style="font-size:28px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;">性能测试</h1> 
   <h2 style="font-size:21px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;">C++/CLI 反射性能测试</h2> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">为了测试 C++/CLI 反射调用两种方案（直接反射调用，委托方法调用）的效率，我们循环1000次测试，下面是测试代码：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>NetLibProxy::UserProxy^ proxy = gcnew NetLibProxy::UserProxy(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">..\\NetLib\\bin\\Debug\\NetLib.dll</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
std::list</span>&lt;CppUserInfo&gt; list = proxy-&gt;GetUsers(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">张</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
    System::Console::WriteLine(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">C++ Get List data From .NET function,OK.</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);

    System::Diagnostics::Stopwatch</span>^ sw =<span style="line-height:1.5;"> gcnew System::Diagnostics::Stopwatch;
    sw</span>-&gt;<span style="line-height:1.5;">Start();
    </span><span style="color:rgb(0,0,255);line-height:1.5;">for</span> (<span style="color:rgb(0,0,255);line-height:1.5;">int</span> i = <span style="color:rgb(128,0,128);line-height:1.5;">0</span>; i&lt;<span style="color:rgb(128,0,128);line-height:1.5;">1000</span>; i++<span style="line-height:1.5;">)
        proxy</span>-&gt;<span style="line-height:1.5;">SaveUsers(list);
    sw</span>-&gt;<span style="line-height:1.5;">Stop();
    System::Console::WriteLine(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">1,1000 loop,C++  Post List data To .NET function,OK.use time(ms):{0}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>,sw-&gt;<span style="line-height:1.5;">ElapsedMilliseconds);

    sw</span>-&gt;<span style="line-height:1.5;">Restart();
    </span><span style="color:rgb(0,0,255);line-height:1.5;">for</span>(<span style="color:rgb(0,0,255);line-height:1.5;">int</span> i=<span style="color:rgb(128,0,128);line-height:1.5;">0</span>;i&lt;<span style="color:rgb(128,0,128);line-height:1.5;">1000</span>;i++<span style="line-height:1.5;">)
        proxy</span>-&gt;<span style="line-height:1.5;">SaveUsers2(list);
    sw</span>-&gt;<span style="line-height:1.5;">Stop();
    System::Console::WriteLine(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">2,1000 loop,C++  Post List data To .NET function,OK..use time(ms):{0}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, sw-&gt;ElapsedMilliseconds);</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(29,88,209);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">不调试，直接执行：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>C++ Get List data From .NET <span style="color:rgb(0,0,255);line-height:1.5;">function</span><span style="line-height:1.5;">,OK.
</span><span style="color:rgb(128,0,128);line-height:1.5;">1</span>,<span style="color:rgb(128,0,128);line-height:1.5;">1000</span> loop,C++  Post List data To .NET <span style="color:rgb(0,0,255);line-height:1.5;">function</span>,OK.<span style="color:rgb(0,0,255);line-height:1.5;">use</span> <span style="color:rgb(0,0,255);line-height:1.5;">time</span>(ms):<span style="color:rgb(128,0,128);line-height:1.5;">65</span>
<span style="color:rgb(128,0,128);line-height:1.5;">2</span>,<span style="color:rgb(128,0,128);line-height:1.5;">1000</span> loop,C++  Post List data To .NET <span style="color:rgb(0,0,255);line-height:1.5;">function</span>,OK..<span style="color:rgb(0,0,255);line-height:1.5;">use</span> <span style="color:rgb(0,0,255);line-height:1.5;">time</span>(ms):<span style="color:rgb(128,0,128);line-height:1.5;">48</span></pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">可见，虽然在.NET程序端，我们使用了弱类型的泛型集合，综合起来还是反射+委托方法执行，效率要高。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">所以如果你能够适当对要调用的.NET方法进行封装，那么可采用使用弱类型集合传输数据的方案，否则，就在C++/CLI端多写2行代码，使用强类型传输数据的方案。</p> 
   <h2 style="font-size:21px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;">与.NET直接调用和反射的性能比较</h2> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">在本篇的方案中，都是C++反射来调用.NET方法的，如果都是在.NET应用程序中直接调用或者反射.NET方法，性能差距有多少呢？<br> 我们模拟文中 C++/CLI的UserProxy，写一个.NET中的 UserProxy:</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <img class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" style="border:0px;vertical-align:middle;">&nbsp;
    <span class="cnblogs_code_collapse" style="border-width:1px;border-style:solid;border-color:#808080;font-size:12px;line-height:1.5;">.Net UserProxy</span> 
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">然后同样循环1000此调用，直接执行，看执行结果：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre><span style="color:rgb(128,0,128);line-height:1.5;">1</span>,<span style="color:rgb(128,0,128);line-height:1.5;">1000</span> loop,.NET  Post List data To .NET <span style="color:rgb(0,0,255);line-height:1.5;">function</span>,OK.<span style="color:rgb(0,0,255);line-height:1.5;">use</span> <span style="color:rgb(0,0,255);line-height:1.5;">time</span>(ms):<span style="color:rgb(128,0,128);line-height:1.5;">4</span>
<span style="color:rgb(128,0,128);line-height:1.5;">2</span>,<span style="color:rgb(128,0,128);line-height:1.5;">1000</span> loop,.NET Reflection  Post List data To .NET <span style="color:rgb(0,0,255);line-height:1.5;">function</span>,OK.<span style="color:rgb(0,0,255);line-height:1.5;">use</span> <span style="color:rgb(0,0,255);line-height:1.5;">time</span>(ms):<span style="color:rgb(128,0,128);line-height:1.5;">14</span></pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">可见，.NET 平台内调用，反射+委托的性能是接近于直接方法调用的。<br> 综合对比，C++/CLI中反射调用.NET,比起在.NET平台内部反射调用，性能没有很大的差距，<span style="color:rgb(0,0,255);">所以C++/CLI中反射调用.NET是一个可行的方案</span>。</p> 
   <h1 style="font-size:28px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;">总结</h1> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">C++/CLI是一种很好的混合编写本机代码与.NET托管代码的技术，使用它反射调用.NET方法也是一种可行的方案，结合<a href="http://www.pwmis.com/sqlmap" rel="nofollow" style="color:rgb(29,88,209);text-decoration:none;">PDF.NET SOD框架</a>的实体类特征，可以更加方便的简化C++/CLI反射代码的编写并且提高C++代码与.NET代码通信的效率。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><br></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><br></p> 
   <p><font><span style="font-size:15px;">&nbsp; &nbsp; 本文转自深蓝医生博客园博客，原文链接：http://www.cnblogs.com/bluedoctor/p/6364555.html</span></font><span style="font-size:15px;font-family:Verdana, Arial, Helvetica, sans-serif;">，如需转载请自行联系原作者</span></p> 
   <div>
    <br>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><br></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
