<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>理解 OpenStack + Ceph （3）：Ceph RBD 接口和工具 [Ceph RBD API and Tools] « NotBeCN</title>
  <meta name="description" content="             本系列文章会深入研究 Ceph 以及 Ceph 和 OpenStack 的集成：    （1）安装和部署    （2）Ceph RBD 接口和工具    （3）Ceph 物理和逻辑结构    （4）Ceph 的基础数据结构    （5）Ceph 与 OpenStack 集成的实现    ...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/09/weixin_34306676_90124676.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">理解 OpenStack + Ceph （3）：Ceph RBD 接口和工具 [Ceph RBD API and Tools]</h1>
    <p class="post-meta">Nov 9, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">本系列文章会深入研究 Ceph 以及 Ceph 和 OpenStack 的集成：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）<a href="http://www.cnblogs.com/sammyliu/p/4804037.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">安装和部署</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）<a href="http://www.cnblogs.com/sammyliu/p/4838139.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">Ceph RBD 接口和工具</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（3）<a href="http://www.cnblogs.com/sammyliu/p/4836014.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">Ceph 物理和逻辑结构</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（4）<a href="http://www.cnblogs.com/sammyliu/p/4843812.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">Ceph 的基础数据结构</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（5）<a href="http://www.cnblogs.com/sammyliu/p/4838138.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">Ceph 与 OpenStack 集成的实现</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（6）<a href="http://www.cnblogs.com/sammyliu/p/5066895.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">QEMU-KVM 和 Ceph RBD 的 缓存机制总结</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（7）<a href="http://www.cnblogs.com/sammyliu/p/5555218.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">Ceph 的基本操作和常见故障排除方法</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; Ceph 作为一个统一的分布式存储，其一大特色是提供了丰富的编程接口。我们来看看下面这张经典的图：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/697113/201509/697113-20150925154437381-1528208764.jpg" alt="" width="375" height="266" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">其中，librados 是 Ceph 的基础接口，其它的接口比如 RADOSGW, RBD 和 CephFS 都是基于 librados 实现的。本文试着分析下 Ceph 的各种接口库和常用的工具。</p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;"><span style="line-height:1.5;font-size:1.17em;">1 librados</span></h2> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.1 librados 概述</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; Ceph 提供一个消息层协议（messaging layer protocol）使得 ceph 客户端可以和 Ceph Monitor 以及 Ceph OSD Daemon 交互。librados 就是一个该协议的编码库形式的实现。所有的 Ceph clients 要么使用 librados 要么使用其封装的更高层 API 与对象存储进行交互。比如，librbd 使用 librados 提供 Ceph 客户端与 RBD 交互 API。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/697113/201509/697113-20150925095237990-912076641.jpg" alt="" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">librados 是使用 C++ 实现的。它实现了 Ceph 的一个私有协议，使得客户端可以<span style="line-height:1.5;text-decoration:underline;">直接、同步或者异步、并行地</span>和 MON &nbsp;和 OSD 服务通信，来执行如下操作：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">Pool Operations</li> 
    <li style="list-style-type:disc;">Snapshots</li> 
    <li style="list-style-type:disc;">Read/Write Objects</li> 
    <li style="list-style-type:disc;">Create or Remove</li> 
    <li style="list-style-type:disc;">Entire Object or Byte Range</li> 
    <li style="list-style-type:disc;">Append or Truncate</li> 
    <li style="list-style-type:disc;">Create/Set/Get/Remove XATTRs</li> 
    <li style="list-style-type:disc;">Create/Set/Get/Remove Key/Value Pairs</li> 
    <li style="list-style-type:disc;">Compound operations and dual-ack semantics</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">librados 于 OSD 交互的示例：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/697113/201512/697113-20151222183619640-918519735.jpg" alt="" width="372" height="373" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">同时也提供 C, python，Java 和 PHD 语言的绑定。使用它之前，你需要安装它：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">安装 C/C++ 版本的 librados，比如在 Ubuntu 环境中，运行&nbsp;sudo apt-<span style="line-height:1.5;color:rgb(0,0,255);">get</span>&nbsp;install librados-dev，然后你就会在&nbsp;<span class="n" style="line-height:1.5;"><span class="o" style="line-height:1.5;">/<span class="n" style="line-height:1.5;">usr<span class="o" style="line-height:1.5;">/<span class="n" style="line-height:1.5;">include<span class="o" style="line-height:1.5;">/<span class="n" style="line-height:1.5;">rados 目录中找到C/C++的头文件。</span></span></span></span></span></span></span> </li> 
    <li style="list-style-type:disc;"> <span class="n" style="line-height:1.5;"><span class="o" style="line-height:1.5;"><span class="n" style="line-height:1.5;"><span class="o" style="line-height:1.5;"><span class="n" style="line-height:1.5;"><span class="o" style="line-height:1.5;"><span class="n" style="line-height:1.5;">使用 Python 版本的 librados，比如在 Ubuntu 环境中，运行&nbsp;</span></span></span></span></span></span></span>sudo apt-get install python-rados。具体请见 1.1.2 部分。</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;">一个 Ceph client 通过 librados 存放或者读取数据块到 Ceph 中，需要经过以下步骤：</span></p> 
   <ol style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;">Client 调用 librados 连接到 Ceph monitor，获取 Cluster map。</li> 
    <li style="list-style-type:decimal;">当 client 要读或者写数据时，它创建一个与 pool 的 I/O Context。该 pool 关联有 ruleset，它定义了数据在 Ceph 存储集群中是怎么存放的。</li> 
    <li style="list-style-type:decimal;">client 通过 I/O Context 提供 object name 给 librados，它使用该 object name 和 cluster map 计算出 PG 和 OSD 来定位到数据的位置。</li> 
    <li style="list-style-type:decimal;">client 直接和 OSD Deamon 交互来读或者写数据。</li> 
   </ol>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/697113/201509/697113-20150925100559037-1388278685.jpg" alt="" width="372" height="180" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">可见，第一步中，ceph client 需要知道 Ceph Minotor 的访问方法，以及用户的身份信息，而这些信息往往是放在 ceph 配置文件中，比如：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>[<span style="color:rgb(0,0,255);line-height:1.5;">global</span><span style="line-height:1.5;">]
mon host </span>= <span style="color:rgb(128,0,128);line-height:1.5;">192.168</span>.<span style="color:rgb(128,0,128);line-height:1.5;">1.1</span><span style="line-height:1.5;">
keyring </span>= /etc/ceph/ceph.client.admin.keyring</pre>
   </div> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.2 librados for phthon</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp; Python rados 模块是 librados 的 Python 的很薄的封装，它在 github 上的源文件在&nbsp;<span class="pre" style="line-height:1.5;"><a href="https://github.com/ceph/ceph/blob/master/src/pybind/rados.py" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">/src/pybind/rados.py</a>, 安装到 Ubunt 后的源文件在&nbsp;<span style="line-height:1.5;text-decoration:underline;">/usr/lib/python2.7/dist-packages/rados.py</span>。<br></span></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span class="pre" style="line-height:1.5;">（1）要使用&nbsp;rados.py 模块，在你的代码中 import rados</span></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span class="pre" style="line-height:1.5;">（2）创建一个 cluster handler，你需要提供 ceph.conf 文件和 keystring</span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="line-height:1.5;">import rados, sys

#Create Handle Examples. <span style="color:rgb(0,0,255);line-height:1.5;">你有多种方式来指定 ceph.conf</span>
（1）cluster </span>= rados.Rados(conffile=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">ceph.conf</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">) <span style="color:rgb(0,0,255);line-height:1.5;">#默认路径的 ceph.conf</span>
（2）cluster </span>= rados.Rados(conffile=sys.argv[<span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">]) <span style="color:rgb(0,0,255);line-height:1.5;">#指定路径的 ceph.conf</span>
（3）cluster </span>= rados.Rados(conffile = <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">ceph.conf</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>, conf = dict (keyring = <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">/path/to/keyring</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>)) <span style="color:rgb(0,0,255);line-height:1.5;">#默认路径的 ceph.conf 和指定的 keystring</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（3）连接到 ceph cluster</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>cluster.connect()</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（4）获取 ceph cluster 的信息，以及操作 pool</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>cluster_stats = cluster.get_cluster_stats()<br><span class="hll" style="line-height:1.5;"><span class="n" style="line-height:1.5;">pools <span class="o" style="line-height:1.5;">= <span class="n" style="line-height:1.5;">cluster<span class="o" style="line-height:1.5;">.<span class="n" style="line-height:1.5;">list_pools<span class="p" style="line-height:1.5;">()<br></span></span></span></span></span></span></span><span class="hll" style="line-height:1.5;"><span class="n" style="line-height:1.5;">cluster<span class="o" style="line-height:1.5;">.<span class="n" style="line-height:1.5;">create_pool<span class="p" style="line-height:1.5;">(<span class="s" style="line-height:1.5;">'test'<span class="p" style="line-height:1.5;">)<br></span></span></span></span></span></span></span><span class="hll" style="line-height:1.5;"><span class="n" style="line-height:1.5;">cluster<span class="o" style="line-height:1.5;">.<span class="n" style="line-height:1.5;">delete_pool<span class="p" style="line-height:1.5;">(<span class="s" style="line-height:1.5;">'test'<span class="p" style="line-height:1.5;">)</span></span></span></span></span></span></span></pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（5）向 ceph 集群读写数据，需要有一个 I/O Context （ioctx）</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>ioctx = cluster.open_ioctx(<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">data</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>)</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（6）然后就可以读写数据了</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>ioctx.write_full(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">hw</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Hello World!</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>) #向 “hw” <span style="color:rgb(0,0,255);line-height:1.5;">object</span> 写入 <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Hello World!</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">
print ioctx.read(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">hw</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>) #读取 ”hw“ <span style="color:rgb(0,0,255);line-height:1.5;">object</span><span style="line-height:1.5;"> 的数据
ioctx.remove_object(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">hw</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>) #删除 “hw” <span style="color:rgb(0,0,255);line-height:1.5;">object</span></pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">更多的信息，可以参考&nbsp;<a href="http://docs.ceph.com/docs/master/rados/api/python/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">LIBRADOS (PYTHON)</a>。</p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">2. librbd：Go 语言实现的访问&nbsp;Ceph RBD 的接口</h2> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">RBD 是 &nbsp;Rados Block Device &nbsp;的缩写，而 librbd 是访问 RBD 的库。它调用 librados C 语言绑定，以及与Linux 内核中的 rbd 模块通信，来提供 RMD image 的创建、删除、映射和删除映射等操作。其中，创建和删除等操作是调用 librados，而将 RDB Image 映射到主机上则是调用 Linux rbd 内核模块：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> MapDevice maps an image to a device on the host. Returns the device path and
</span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> any errors. On error, the device path will be blank.</span>
func (img *Image) MapDevice() (<span style="color:rgb(0,0,255);line-height:1.5;">string</span>, error)</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; librbd 的源代码在&nbsp;<a href="https://github.com/contiv/librbd" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">https://github.com/contiv/librbd</a>，是使用 Go 语言实现的，调用 librados 的 C 库以及linux 内核模块，在 Ubuntu 14 上它的文件在 /usr/lib/x86_64-linux-gnu/librbd.so.1。它支持：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <ol style="margin-left:0px;color:#008080;">
     <li style="list-style-image:none;list-style-type:decimal;"><span style="color:rgb(0,0,0);line-height:1.5;font-size:12px;">Open a connection to the rbd pool</span></li> 
     <li style="list-style-image:none;list-style-type:decimal;"> <span style="color:rgb(0,0,0);line-height:1.5;font-size:12px;">Creates an image called test (Removing it before&nbsp;</span><span style="color:rgb(0,0,255);line-height:1.5;font-size:12px;">if</span><span style="color:rgb(0,0,0);line-height:1.5;font-size:12px;">&nbsp;necessary)</span> </li> 
     <li style="list-style-image:none;list-style-type:decimal;"><span style="color:rgb(0,0,0);line-height:1.5;font-size:12px;">Maps it to a block device on the local host</span></li> 
     <li style="list-style-image:none;list-style-type:decimal;"> <span style="color:rgb(0,0,0);line-height:1.5;font-size:12px;">Creates a snapshot of the image, called test</span>-<span style="color:rgb(0,0,0);line-height:1.5;font-size:12px;">snap.</span> </li> 
     <li style="list-style-image:none;list-style-type:decimal;"><span style="color:rgb(0,0,0);line-height:1.5;font-size:12px;">Lists and prints the snapshots available.</span></li> 
    </ol>
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;"><span style="line-height:1.5;font-size:1.17em;">3. rbd.py：librbd 的 python 封装</span></h2> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp;<a href="http://docs.ceph.com/docs/master/rbd/librbdpy/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">rbd python 模块</a>&nbsp;rbd.py 的源代码在&nbsp;<a href="https://github.com/ceph/ceph/blob/master/src/pybind/rbd.py" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">https://github.com/ceph/ceph/blob/master/src/pybind/rbd.py</a>，它是 librbd 的一个 python 封装。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="line-height:1.5;">def load_librbd():
    </span><span style="color:rgb(128,0,0);line-height:1.5;">"""
</span><span style="line-height:1.5;">    Load the librbd shared library.
    </span><span style="color:rgb(128,0,0);line-height:1.5;">"""
</span>    librbd_path = find_library(<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">rbd</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">)
    </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> librbd_path:
        </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> CDLL(librbd_path)

    # </span><span style="color:rgb(0,0,255);line-height:1.5;">try</span> harder, find_library() doesn<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">t search LD_LIBRARY_PATH</span>
    # <span style="color:rgb(0,0,255);line-height:1.5;">in</span> addition, it doesn<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">t seem work on centos 6.4 (see e46d2ca067b5)</span>
    <span style="color:rgb(0,0,255);line-height:1.5;">try</span><span style="line-height:1.5;">:
        </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> CDLL(<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">librbd.so.1</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">)
    except OSError </span><span style="color:rgb(0,0,255);line-height:1.5;">as</span><span style="line-height:1.5;"> e:
        raise EnvironmentError(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Unable to load librbd: %s</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> % e)</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;">&nbsp; &nbsp;它只封装了 librbd 中的同步操作。它主要提供了 RBD、Image 和 SnapIterator 三个类。</span><span style="line-height:1.5;">在 Ubuntu 上，安装&nbsp;python-rbd 包就可以在你的机器上找到该文件：/usr/lib/python2.7/dist-packages/rbd.py。</span><span style="line-height:1.5;">&nbsp;提供类似文件访问的方式去访问 ceph RBD image （连接-打开-使用-关闭）。该模块除了提供主要三个类&nbsp;</span>Rados<span style="line-height:1.5;">,&nbsp;</span>Ioctx<span style="line-height:1.5;">, 和</span>Image （Rados 对应于 ceph 集群；Ioctx 对应于 pool；Image 对应于 RBD Image）以外，还封装了 librdb 的返回值作为 Error 类。rbd 模块还提供 Error 类的具体的子类，比如&nbsp;PermissionError 和&nbsp;IOError。</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">3.1 基本流程</h3> 
   <div> 
    <div class="cnblogs_code" style="color:rgb(0,0,0);font-family:'Courier New';font-size:12px;border:1px solid rgb(204,204,204);"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre><span style="line-height:1.5;">#使用 rbd 之前，连接到 RADOS，并打开一个 IO context （和特定 pool 相关）
cluster </span>= rados.Rados(conffile=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">my_ceph.conf</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">)
cluster.connect()
ioctx </span>= cluster.open_ioctx(<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">mypool</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">)

#初始化一个 RBD 对象
rbd_inst </span>=<span style="line-height:1.5;"> rbd.RBD()
size </span>= <span style="color:rgb(128,0,128);line-height:1.5;">4</span> * <span style="color:rgb(128,0,128);line-height:1.5;">1024</span>**<span style="color:rgb(128,0,128);line-height:1.5;">3</span>  # <span style="color:rgb(128,0,128);line-height:1.5;">4</span><span style="line-height:1.5;"> GiB
#创建 image
rbd_inst.create(ioctx, </span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">myimage</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">, size)

#初始化 image 对象
image </span>= rbd.Image(ioctx, <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">myimage</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">)
#准备 </span><span style="color:rgb(128,0,128);line-height:1.5;">600</span><span style="line-height:1.5;"> 个字符的数据
data </span>= <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">foo</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> * <span style="color:rgb(128,0,128);line-height:1.5;">200</span><span style="line-height:1.5;">
#写入数据
image.write(data, </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">)

#关闭 image 对象
image.close()
#关闭 IO Context
ioctx.close()
#关闭连接
cluster.shutdown()</span></pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">更优化的编码方式：</p> 
    <div class="cnblogs_code" style="color:rgb(0,0,0);font-family:'Courier New';font-size:12px;border:1px solid rgb(204,204,204);"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre>with rados.Rados(conffile=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">my_ceph.conf</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>) <span style="color:rgb(0,0,255);line-height:1.5;">as</span><span style="line-height:1.5;"> cluster:
    with cluster.open_ioctx(</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">mypool</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>) <span style="color:rgb(0,0,255);line-height:1.5;">as</span><span style="line-height:1.5;"> ioctx:
        rbd_inst </span>=<span style="line-height:1.5;"> rbd.RBD()
        size </span>= <span style="color:rgb(128,0,128);line-height:1.5;">4</span> * <span style="color:rgb(128,0,128);line-height:1.5;">1024</span>**<span style="color:rgb(128,0,128);line-height:1.5;">3</span>  # <span style="color:rgb(128,0,128);line-height:1.5;">4</span><span style="line-height:1.5;"> GiB
        rbd_inst.create(ioctx, </span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">myimage</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">, size)
        with rbd.Image(ioctx, </span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">myimage</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>) <span style="color:rgb(0,0,255);line-height:1.5;">as</span><span style="line-height:1.5;"> image:
            data </span>= <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">foo</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> * <span style="color:rgb(128,0,128);line-height:1.5;">200</span><span style="line-height:1.5;">
            image.write(data, </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span>)</pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <h3 style="color:rgb(102,102,102);font-family:Verdana;font-size:16px;background-image:none;background-repeat:no-repeat;line-height:1.5;">3.2&nbsp;<em>class&nbsp;</em>rbd.RBD&nbsp;类</h3> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
     <em style="line-height:1.5;">class&nbsp;</em>rbd.RBD 该类封装了 librbd 的 CURD 操作，包括：
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
     <ul style="list-style:none;font-size:12px;">
      <li style="list-style-type:disc;">create(<em>ioctx</em>,&nbsp;<em>name</em>,&nbsp;<em>size</em>,&nbsp;<em>order=None</em>,&nbsp;<em>old_format=True</em>,&nbsp;<em>features=0</em>,&nbsp;<em>stripe_unit=0</em>,&nbsp;<em>stripe_count=0</em>)：创建一个 RBD Image</li> 
      <li style="list-style-type:disc;">list(<em>ioctx</em>) &nbsp;返回 RBD Image 的名称列表</li> 
      <li style="list-style-type:disc;">clone(<em style="line-height:1.5;">p_ioctx</em><span style="line-height:1.5;">,&nbsp;</span><em style="line-height:1.5;">p_name</em><span style="line-height:1.5;">,&nbsp;</span><em style="line-height:1.5;">p_snapname</em><span style="line-height:1.5;">,&nbsp;</span><em style="line-height:1.5;">c_ioctx</em><span style="line-height:1.5;">,&nbsp;</span><em style="line-height:1.5;">c_name</em><span style="line-height:1.5;">,&nbsp;</span><em style="line-height:1.5;">features=0</em><span style="line-height:1.5;">,&nbsp;</span><em style="line-height:1.5;">order=None</em>)：克隆 Image 的snapshot 到一个 COW 克隆 
       <ul style="list-style:none;">
        <li style="list-style-type:disc;"> <strong style="line-height:1.5;">features</strong><span style="line-height:1.5;">&nbsp;(</span><em style="line-height:1.5;">int</em><span style="line-height:1.5;">) – bitmask of features to enable; if set, must include layering</span> </li> 
        <li style="list-style-type:disc;"> <strong style="line-height:1.5;">order</strong><span style="line-height:1.5;">&nbsp;(</span><em style="line-height:1.5;">int</em><span style="line-height:1.5;">) – the image is split into (2**order) byte objects</span> </li> 
       </ul></li> 
     </ul>
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
     <ul style="list-style:none;font-size:12px;">
      <li style="list-style-type:disc;">remove(<em style="line-height:1.5;">ioctx</em><span style="line-height:1.5;">,&nbsp;</span><em style="line-height:1.5;">name</em>) ：<span style="line-height:1.5;">删除一个 RBD image。这可能会需要较长的时间，因为它需要等待组成该 image 的每个对象都被删除。</span> </li> 
      <li style="list-style-type:disc;">rename(<em>ioctx</em>,&nbsp;<em>src</em>,&nbsp;<em>dest</em>)：修改 RBD Image 的名称</li> 
     </ul>
    </div> 
    <h3 style="color:rgb(102,102,102);font-family:Verdana;font-size:16px;background-image:none;background-repeat:no-repeat;line-height:1.5;">3.3 &nbsp;<em>class&nbsp;</em>rbd.Image</h3> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
     该类的一个实例代表一个 RBD image。它的方法用于对 image 的 I/O 操作和处理其 snapshot。它的主要方法包括：
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
     <ul style="list-style:none;font-size:12px;">
      <li style="list-style-type:disc;"> <em>class&nbsp;</em>rbd.Image(<em>ioctx</em>,&nbsp;<em>name</em>,&nbsp;<em>snapshot=None</em>,&nbsp;<em>read_only=False</em>)</li> 
      <li style="list-style-type:disc;">copy(<em>dest_ioctx</em>,&nbsp;<em>dest_name</em>)&nbsp;<span style="line-height:1.5;">Copy the image to another location.</span> </li> 
     </ul>
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
     <ul style="list-style:none;font-size:12px;">
      <li style="list-style-type:disc;">create_snap(<em>name</em>) &nbsp;Create a snapshot of the image</li> 
      <li style="list-style-type:disc;">flatten() &nbsp;Flatten clone image (copy all blocks from parent to child)</li> 
      <li style="list-style-type:disc;">list_snaps() &nbsp;Iterate over the snapshots of an image</li> 
      <li style="list-style-type:disc;">protect_snap(<em>name</em>)&nbsp;Mark a snapshot as protected. This means it can’t be deleted until it is unprotected.</li> 
      <li style="list-style-type:disc;">read(<em>offset</em>,&nbsp;<em>length</em>,&nbsp;<em>fadvise_flags=0</em>) &nbsp;Read data from the image.&nbsp;</li> 
      <li style="list-style-type:disc;">remove_snap(<em>name</em>)&nbsp;&nbsp;Delete a snapshot of the image</li> 
      <li style="list-style-type:disc;">resize(<em>size</em>)&nbsp;&nbsp;Change the size of the image</li> 
      <li style="list-style-type:disc;">rollback_to_snap(<em>name</em>)&nbsp;&nbsp;Revert the image to its contents at a snapshot.</li> 
      <li style="list-style-type:disc;">set_snap(<em>name</em>) &nbsp;&nbsp;Set the snapshot to read from. Writes will raise ReadOnlyImage while a snapshot is set. Pass None to unset the snapshot (reads come from the current image) , and allow writing again.</li> 
      <li style="list-style-type:disc;">size()&nbsp;&nbsp;Get the size of the image&nbsp;&nbsp;in bytes</li> 
      <li style="list-style-type:disc;">stat()&nbsp;&nbsp;Get information about the image.</li> 
      <li style="list-style-type:disc;">unprotect_snap(<em>name</em>) &nbsp;&nbsp;Mark a snapshot unprotected. This allows it to be deleted if it was protected.</li> 
      <li style="list-style-type:disc;">write(<em>data</em>,&nbsp;<em>offset</em>,&nbsp;<em>fadvise_flags=0</em>)&nbsp;&nbsp;Write data to the image.</li> 
      <li style="list-style-type:disc;">parent_info&nbsp;&nbsp;Get information about a cloned image’s parent (if any)</li> 
     </ul>
     <h2 style="font-size:21px;line-height:1.5;"><span style="line-height:1.5;font-size:1.17em;">4. Ceph RBD 对 Linux 主机和虚机的支持，以及 Linux RBD 内核模块</span></h2> 
     <p style="line-height:1.5;">&nbsp; 使用 Ceph 的块存储有两种路径：</p> 
     <ul style="list-style:none;font-size:12px;">
      <li style="list-style-type:disc;">一种是利用QEMU走librbd路径，主要为虚拟机提供块存储设备</li> 
      <li style="list-style-type:disc;">另一种是使用 kernel module，走 kernel 的路径，主要为Host提供块设备支持。</li> 
     </ul>
     <p style="line-height:1.5;">&nbsp; 两种途径的接口实现不完全相同。就目前来说，前者是目前更稳定的途径，也是Ceph所有应用场景中最广泛使用的。网上多篇文章认为目前内核模块尚不稳定，建议尽量不要使用。</p> 
     <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">4.1&nbsp;qemu-kvm 使用librbd 访问 RBD</h3> 
     <p style="line-height:1.5;">QEMU 通过 librbd 库访问 RBD，而 librbd 是调用 librados。</p> 
     <p style="line-height:1.5;"><img src="https://images2015.cnblogs.com/blog/697113/201509/697113-20150925132153162-1589870805.jpg" alt="" width="445" height="192" style="border:0px;"></p> 
     <p style="line-height:1.5;">QEMU 对 librbd 的调用关系可以使用 ldd 命令查看：</p> 
     <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
      <pre>root@compute1:~# ldd /usr/bin/qemu-system-x86_64 |<span style="line-height:1.5;"> grep rbd
        librbd.so.</span><span style="color:rgb(128,0,128);line-height:1.5;">1</span> =&gt; /usr/lib/x86_64-linux-gnu/librbd.so.<span style="color:rgb(128,0,128);line-height:1.5;">1</span> (<span style="color:rgb(128,0,128);line-height:1.5;">0x00007f76ef9e8000</span>)</pre>
     </div> 
     <p style="line-height:1.5;">qemu-img 命令支持直接创建 rbd 镜像，比如：</p> 
     <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
      <pre>qemu-img create -f rbd rbd:vmimages/ubuntu-newdrive 2G</pre>
     </div> 
     <p style="line-height:1.5;">然后可以使用 virsh 将它定义为一个 device，下面是 device.xml 文件：</p> 
     <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
      <div class="cnblogs_code_toolbar">
       <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
      </div> 
      <pre>&lt;disk type=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">network</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> device=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">disk</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>&gt;
  &lt;driver name=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">qemu</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> type=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">raw</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
  &lt;auth username=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">vmimages</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>&gt;
    &lt;secret type=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">ceph</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> uuid=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">76e3a541-b997-58ac-f7bd-77dd7d4347cb</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
  &lt;/auth&gt;
  &lt;source protocol=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">rbd</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> name=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">vmimages/ubuntu-newdrive</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>&gt;
    &lt;host name=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">192.168.0.100</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> port=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">6789</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
  &lt;/source&gt;
  &lt;target dev=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">vdc</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> bus=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">virtio</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
&lt;/disk&gt;</pre> 
      <div class="cnblogs_code_toolbar">
       <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
      </div> 
     </div> 
     <p style="line-height:1.5;">然后该 device 添加到虚机中即可。虚机访问 RBD 设备是通过：</p> 
     <p style="line-height:1.5;"><img src="https://images2015.cnblogs.com/blog/697113/201509/697113-20150925133621553-1885762547.jpg" alt="" width="329" height="461" style="border:0px;"></p> 
     <p style="line-height:1.5;">&nbsp; &nbsp;我们知道，Linux Kernel 中的块设备驱动是 virtio_blk，它会对虚机的块设备各种请求封装成一个消息通过 virtio 框架提供的队列发送到 QEMU 的 IO 线程，QEMU 收到请求后会转给相应的 QEMU Block Driver 来完成请求，当使用 RDB 时 QEMU block driver 会调用 librbd 来访问 Ceph RDB 设备。</p> 
     <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">4.2 使用内核模块，将 RBD 设备映射给主机</h3> 
     <p style="line-height:1.5;">&nbsp; &nbsp; rbd 工具也可以调用 Linux RBD 内核模块来将 RBD Image 挂载到Linux 主机上作为一个新的设备。一开始，该内核模块并没有被加载，但是在执行了 rbd map 操作后，libceph 模块自动被加载：</p> 
     <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
      <div class="cnblogs_code_toolbar">
       <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
      </div> 
      <p style="line-height:1.5;">root@compute2:~# lsmod | grep rbd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color:rgb(0,0,255);line-height:1.5;">#此时，rbd 内核模块还没有被加载</span></p> 
      <p style="line-height:1.5;">root@compute2:~# rbd -n client.cinder map vms/smb01_d1&nbsp;<span style="color:rgb(0,0,255);line-height:1.5;">#做 rbd map 操作</span><br> /dev/rbd1<br> root@compute2:~# lsmod | grep rbd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color:rgb(0,0,255);line-height:1.5;">#此时， rbd 内核模块已经被自动加载</span><br> rbd 63787 1<br> libceph 225461 1 rbd<br> root@compute2:~# rmmod rbd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color:rgb(0,0,255);line-height:1.5;">#这时候，rbd 内核模块也无法被卸载</span><br> rmmod: ERROR: Module rbd is in use</p> 
      <div class="cnblogs_code_toolbar">
       <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
      </div> 
     </div> 
     <p style="line-height:1.5;">在看 rbd 的帮助，我们要可以看到 map，unmap，showmapped 命令确实调用的是 rbd 内核模块：</p> 
     <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
      <pre>map &lt;image-name&gt;<span style="line-height:1.5;">                            map image to a block device </span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> the kernel
unmap </span>&lt;device&gt;<span style="line-height:1.5;">                              unmap a rbd device that was mapped by the kernel
showmapped                                  show the rbd images mapped by the kernel</span></pre>
     </div> 
     <p style="line-height:1.5;">过程：</p> 
     <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
      <div class="cnblogs_code_toolbar">
       <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
      </div> 
      <pre><span style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;">#创建一个 RDB Image</span>
root@compute1:</span>~# rbd -n client.cinder create vms/smb01_d2 --<span style="line-height:1.5;">size</span> 1000 --image-format 2</pre> 
      <pre><span style="color:rgb(0,0,255);line-height:1.5;">#将 Image map 给主机 </span><span style="line-height:1.5;"> <br>
root@compute1:</span>~# rbd -n client.cinder map vms/<span style="line-height:1.5;">smb01_d2 </span>/dev/rbd2<br><br><span style="color:rgb(0,0,255);line-height:1.5;">#列表已经被映射的 RDB Image</span><br>
root@compute1:~# rbd showmapped<br>
id pool image    snap device<br>
1  vms  smb01_d1 -    /dev/rbd1<br>
2  vms  smb01_d2 -    /dev/rbd2<br>
3  vms  smb01_d3 -    /dev/rbd3<br><span style="color:rgb(0,0,255);line-height:1.5;">#unmap</span><br>
root@compute1:~# rbd unmap /dev/rbd1<br>
root@compute1:~# rbd unmap /dev/rbd2<br>
root@compute1:~# rbd unmap /dev/rbd3</pre> 
      <div class="cnblogs_code_toolbar">
       <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
      </div> 
     </div> 
     <p style="line-height:1.5;">其实，rbd 是和&nbsp;/sys/bus/rbd 交互来完成map：</p> 
     <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
      <div class="cnblogs_code_toolbar">
       <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
      </div> 
      <pre>access(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">/sys/bus/rbd</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, F_OK)            = <span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">
socket(PF_NETLINK, SOCK_RAW</span>|SOCK_CLOEXEC|SOCK_NONBLOCK, <span style="color:rgb(128,0,128);line-height:1.5;">15</span>) = <span style="color:rgb(128,0,128);line-height:1.5;">3</span><span style="line-height:1.5;">
setsockopt(</span><span style="color:rgb(128,0,128);line-height:1.5;">3</span>, SOL_SOCKET, SO_ATTACH_FILTER, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">\r\0\0\0\0\0\0\0\3000b\261\375\177\0\0</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(128,0,128);line-height:1.5;">16</span>) = <span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">
bind(</span><span style="color:rgb(128,0,128);line-height:1.5;">3</span>, {sa_family=AF_NETLINK, pid=<span style="color:rgb(128,0,128);line-height:1.5;">0</span>, groups=<span style="color:rgb(128,0,128);line-height:1.5;">00000002</span>}, <span style="color:rgb(128,0,128);line-height:1.5;">12</span>) = <span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">
getsockname(</span><span style="color:rgb(128,0,128);line-height:1.5;">3</span>, {sa_family=AF_NETLINK, pid=<span style="color:rgb(128,0,128);line-height:1.5;">6958</span>, groups=<span style="color:rgb(128,0,128);line-height:1.5;">00000002</span>}, [<span style="color:rgb(128,0,128);line-height:1.5;">12</span>]) = <span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">
setsockopt(</span><span style="color:rgb(128,0,128);line-height:1.5;">3</span>, SOL_SOCKET, SO_PASSCRED, [<span style="color:rgb(128,0,128);line-height:1.5;">1</span>], <span style="color:rgb(128,0,128);line-height:1.5;">4</span>) = <span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">
open(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">/sys/bus/rbd/add_single_major</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, O_WRONLY) = -<span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;"> ENOENT (No such file or directory)
open(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">/sys/bus/rbd/add</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, O_WRONLY)      = <span style="color:rgb(128,0,128);line-height:1.5;">4</span><span style="line-height:1.5;">
write(</span><span style="color:rgb(128,0,128);line-height:1.5;">4</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">9.115.251.194:6789,9.115.251.195:6789,9.115.251.218:6789 nam</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>..., <span style="color:rgb(128,0,128);line-height:1.5;">101</span>) = <span style="color:rgb(128,0,128);line-height:1.5;">101</span><span style="line-height:1.5;">
close(</span><span style="color:rgb(128,0,128);line-height:1.5;">4</span>)    </pre> 
      <div class="cnblogs_code_toolbar">
       <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
      </div> 
     </div> 
     <p style="line-height:1.5;">你甚至可以直接对 /sys/bus/rbd 操作来 map，showmapped 和 unmap RBD Image：</p> 
     <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
      <div class="cnblogs_code_toolbar">
       <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
      </div> 
      <pre>root@compute1:~#echo <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">10.20.30.40  name=admin rbd foo</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> | sudo tee /sys/bus/rbd/<span style="line-height:1.5;">add <span style="color:rgb(0,0,255);line-height:1.5;">#map</span>

root@compute1:</span>~# ls /sys/bus/rbd/<span style="line-height:1.5;">devices                                           <span style="color:rgb(0,0,255);line-height:1.5;">#showmapped </span></span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">
root@compute1:</span>~# echo <span style="color:rgb(128,0,128);line-height:1.5;">1</span> | sudo tee /sys/bus/rbd/<span style="line-height:1.5;">remove                             <span style="color:rgb(0,0,255);line-height:1.5;">#unmap </span></span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">
root@compute1:</span>~# ls /sys/bus/rbd/devices               </pre> 
      <div class="cnblogs_code_toolbar">
       <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
      </div> 
     </div> 
     <p style="line-height:1.5;">相信可以参考&nbsp;<a href="http://docs.ceph.com/docs/argonaut/rbd/rbd-ko/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">RBD KERNEL OBJECT OPERATIONS</a>&nbsp;和&nbsp;<a href="https://www.kernel.org/doc/Documentation/ABI/testing/sysfs-bus-rbd" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这篇文章</a>。</p> 
     <h2 style="font-size:21px;line-height:1.5;">5. rbd 命令行</h2> 
     <p style="line-height:1.5;">&nbsp; Ceph 提供 rbd 作为一个操作 ceph rados 块设备（RBD）image 的 工具，根据调用的底层模块，其功能可分为两部分：</p> 
     <ul style="list-style:none;font-size:12px;">
      <li style="list-style-type:disc;">常规的 create, list, introspect 和 remove block device images，以及 clone images, create snapshots, rollback an image to a snapshot, view a snapshot 等操作，是通过调用 librados 来实现的。其调用层次为 rbd -&gt; librbd -&gt; librados：</li>
     </ul>
     <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
      <div class="cnblogs_code_toolbar">
       <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
      </div> 
      <pre>root@compute1:~<span style="line-height:1.5;"># which rbd
</span>/usr/bin/<span style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;">rbd</span>
root@compute1:</span>~# ldd /usr/bin/rbd |<span style="line-height:1.5;"> grep rbd
        <span style="color:rgb(0,0,255);line-height:1.5;">librbd</span>.so.</span><span style="color:rgb(128,0,128);line-height:1.5;">1</span> =&gt; /usr/lib/x86_64-linux-gnu/librbd.so.<span style="color:rgb(128,0,128);line-height:1.5;">1</span> (<span style="color:rgb(128,0,128);line-height:1.5;">0x00007fcf7ae62000</span><span style="line-height:1.5;">)
root@compute1:</span>~# ldd /usr/lib/x86_64-linux-gnu/librbd.so.<span style="color:rgb(128,0,128);line-height:1.5;">1</span> |<span style="line-height:1.5;"> grep rados
        <span style="color:rgb(0,0,255);line-height:1.5;">librados</span>.so.</span><span style="color:rgb(128,0,128);line-height:1.5;">2</span> =&gt; /usr/lib/x86_64-linux-gnu/librados.so.<span style="color:rgb(128,0,128);line-height:1.5;">2</span> (<span style="color:rgb(128,0,128);line-height:1.5;">0x00007f29b543f000</span>)</pre> 
      <div class="cnblogs_code_toolbar">
       <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
      </div> 
     </div> 
     <ul style="list-style:none;font-size:12px;">
      <li style="list-style-type:disc;">将 RBD image map 给 Linux 主机，以及从 Linux 主机 unmap等操作，是通过和 Linux rbd 内核模块通信来实现的。详情请参考 1.4.2 部分。</li>
     </ul>
     <p style="line-height:1.5;">&nbsp; 在 Ubuntu 上，你安装了<a href="http://packages.ubuntu.com/wily/amd64/ceph-common/filelist" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">&nbsp;ceph-common</a>&nbsp;就可以得到该工具，其命令行格式为：</p> 
     <div> 
      <strong>rbd</strong>&nbsp;[ -c&nbsp;
      <em>ceph.conf</em>&nbsp;] [ -m&nbsp;
      <em>monaddr</em>&nbsp;] [ -p | –pool&nbsp;
      <em>pool</em>&nbsp;] [ –size&nbsp;
      <em>size</em>&nbsp;] [ –order&nbsp;
      <em>bits</em>&nbsp;] [&nbsp;
      <em>command</em>&nbsp;... ]
     </div> 
     <div>
      &nbsp;
     </div> 
     <div>
      &nbsp; 部分使用示例：
     </div> 
     <ul style="list-style:none;font-size:12px;">
      <li style="list-style-type:disc;">在 pool ‘mypool’ 中创建 100 GB 的 rbd image ‘myimage’: &nbsp;rbd create mypool/myimage --size 102400</li> 
      <li style="list-style-type:disc;">在默认的 ‘rbd’ pool 中创建 image：rbd create myimage --size 102400</li> 
      <li style="list-style-type:disc;">创建对象大小为 8MB 的 image：rbd create mypool/myimage --size 102400 --order 23</li> 
     </ul>
     <div style="margin-left:30px;">
      这里的 order 参数比较特别，它和 ceph 的对象条带化有关。ceph 客户端的一个数据块，会被条带化成多个小的对象，被保存在&nbsp;Ceph 分布式对象存储（RADOS） 中。这样的话，对 image 的读和写操作可以被分散到集群的多个节点上，通常来讲这样可以防止某个 image 非常大或者非常忙时单个节点称为性能瓶颈。 
      <div style="margin-left:30px;"> 
       <div>
        Ceph 的条带化行为受三个参数控制：
       </div> 
       <ul style="list-style:none;font-size:12px;">
        <li style="list-style-type:disc;">order：被条带化的对象的大小为&nbsp;2^[<em>order</em>] bytes。默认的 oder 为 22，这时候对象大小为4MB。</li> 
        <li style="list-style-type:disc;">stripe_unit：每个 [stripe_unit]的连续字节会被相连的保存到同一个对象中，直到去写下一个对象</li> 
        <li style="list-style-type:disc;">stripe_count：在写入了&nbsp;[stripe_unit] 字节到&nbsp;[stripe_unit]各对象后，ceph 又重新从第一个对象开始写下一个条带，直到该对象达到了它的最大size。这时候，ceph 转移到下&nbsp;[stripe_unit] 个对象。</li> 
       </ul>
       <div>
        默认的时候，[stripe_unit] 等于 object size；stripe_count 为1. 要设置其他的&nbsp;[
        <em>stripe_unit</em>] 值，需要Ceph v0.53 版本及以后版本对&nbsp;STRIPINGV2&nbsp;的支持以及使用 format 2 image 格式。
        <span style="line-height:1.5;">&nbsp;</span> 
       </div> 
      </div> 
     </div> 
     <ul style="list-style:none;font-size:12px;">
      <li style="list-style-type:disc;">删除 image：rbd rm mypool/myimage</li> 
      <li style="list-style-type:disc;">创建 snapshot：rbd snap create mypool/myimage@mysnap</li> 
      <li style="list-style-type:disc;">创建 clone：rbd clone mypool/myimage@mysnap otherpool/cloneimage</li> 
      <li style="list-style-type:disc;">查看snapshot 的所有 clone：rbd children mypool/myimage@mysnap</li> 
      <li style="list-style-type:disc;">删除 snapshot：rbd snap rm mypool/myimage@mysnap</li> 
      <li style="list-style-type:disc;">将 image map 到 linux 主机：rbd map mypool/myimage&nbsp;</li> 
      <li style="list-style-type:disc;">将 image 从主机上删除 （unmap）：rbd unmap /dev/rbd0</li> 
     </ul>
     <h2 style="font-size:21px;line-height:1.5;">6. 总结一下各模块的关系（以 OpenStack 的计算节点为例）</h2> 
     <p style="line-height:1.5;"><img src="https://images2015.cnblogs.com/blog/697113/201509/697113-20150925152411678-1151129580.jpg" alt="" style="border:0px;"></p> 
     <h2 style="font-size:21px;line-height:1.5;"><span style="line-height:1.5;font-size:14px;">参考链接：</span></h2> 
     <div> 
      <p style="line-height:1.5;"><a href="http://www.wzxue.com/rbdcache/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://www.wzxue.com/rbdcache/</a></p> 
      <p style="line-height:1.5;"><a href="https://www.kernel.org/doc/Documentation/ABI/testing/sysfs-bus-rbd" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">https://www.kernel.org/doc/Documentation/ABI/testing/sysfs-bus-rbd</a></p> 
      <p style="line-height:1.5;"><a href="http://docs.ceph.com/docs/master/rbd/rbd/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://docs.ceph.com/docs/master/rbd/rbd/</a></p> 
      <div>
       &nbsp;
      </div> 
     </div> 
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
     <br>
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
     <br>
    </div> 
    <div> 
     <font color="#4b4b4b"><span style="font-size:15px;">&nbsp; &nbsp; 本文转自SammyLiu博客园博客，原文链接：http://www.cnblogs.com/sammyliu/p/4838139.html</span></font>
     <span style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">，如需转载请自行联系原作者</span> 
    </div> 
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
