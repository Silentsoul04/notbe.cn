<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>KVM 介绍（7）：使用 libvirt 做 QEMU/KVM 快照和 Nova 实例的快照 （Nova Instances Snapshot Libvirt）... « NotBeCN</title>
  <meta name="description" content="             学习 KVM 的系列文章：                    （1）介绍和安装       （2）CPU 和 内存虚拟化       （3）I/O QEMU 全虚拟化和准虚拟化（Para-virtulizaiton）       （4）I/O PCI/PCIe设备直接分配和 SR-I...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/13/weixin_34037515_90123318.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">KVM 介绍（7）：使用 libvirt 做 QEMU/KVM 快照和 Nova 实例的快照 （Nova Instances Snapshot Libvirt）...</h1>
    <p class="post-meta">Nov 13, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">学习 KVM 的系列文章：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:none;"> 
     <ul style="list-style:none;font-size:12px;">
      <li style="list-style-type:disc;"><a href="http://www.cnblogs.com/sammyliu/p/4543110.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">（1）介绍和安装</a></li> 
      <li style="list-style-type:disc;"><a href="http://www.cnblogs.com/sammyliu/p/4543597.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">（2）CPU 和 内存虚拟化</a></li> 
      <li style="list-style-type:disc;"><a href="http://www.cnblogs.com/sammyliu/p/4543657.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">（3）I/O QEMU 全虚拟化和准虚拟化（Para-virtulizaiton）</a></li> 
      <li style="list-style-type:disc;"><a href="http://www.cnblogs.com/sammyliu/p/4548194.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">（4）I/O PCI/PCIe设备直接分配和 SR-IOV</a></li> 
      <li style="list-style-type:disc;"><a href="http://www.cnblogs.com/sammyliu/p/4558638.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">（5）libvirt 介绍</a></li> 
      <li style="list-style-type:disc;"><a href="http://www.cnblogs.com/sammyliu/p/4568188.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">（6）Nova 通过 libvirt 管理 QEMU/KVM 虚机</a></li> 
      <li style="list-style-type:disc;"><a href="http://www.cnblogs.com/sammyliu/p/4468757.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">（7）快照 （snapshot）</a></li> 
      <li style="list-style-type:disc;"><a href="http://www.cnblogs.com/sammyliu/p/4572287.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">（8）迁移 （migration）</a></li> 
     </ul></li>
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">本文将梳理 QEMU/KVM 快照相关的知识，以及在 OpenStack Nova 中使用 libvirt 来对 QEMU/KVM 虚机做快照的过程。</p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1. QEMU/KVM 快照<strong><br></strong> </h2> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.1 概念</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">QEMU/KVM 快照的定义：快照就是将虚机在某一个时间点上的磁盘、内存和设备状态保存一下，以备将来之用。它包括以下几类：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">磁盘快照：磁盘的内容（可能是虚机的全部磁盘或者部分磁盘）在某个时间点上被保存，然后可以被恢复。 
     <ul style="list-style:none;font-size:12px;">
      <li style="list-style-type:disc;">磁盘数据的保存状态： 
       <ul style="list-style:none;">
        <li style="list-style-type:disc;">在一个运行着的系统上，一个磁盘快照很可能只是崩溃一致的（crash-consistent） 而不是完整一致（clean）的，也是说它所保存的磁盘状态可能相当于机器突然掉电时硬盘数据的状态，机器重启后需要通过 fsck 或者别的工具来恢复到完整一致的状态（类似于 Windows 机器在断电后会执行文件检查）。(注：命令 qemu-img check -f qcow2 --output=qcow2 -r all filename-img.qcow2 可以对 qcow2 和 vid 格式的镜像做一致性检查。)</li> 
        <li style="list-style-type:disc;">对一个非运行中的虚机来说，如果上次虚机关闭的时候磁盘是完整一致的，那么其被快照的磁盘快照也将是完整一致的。</li> 
       </ul></li> 
      <li style="list-style-type:disc;">磁盘快照有两种： 
       <ul style="list-style:none;">
        <li style="list-style-type:disc;">内部快照 - 使用单个的 qcow2 的文件来保存快照和快照之后的改动。这种快照<span style="line-height:1.5;font-size:14px;">是 libvirt 的默认行为，现在的支持很完善（创建、回滚和删除），但是只能针对 qcow2 格式的磁盘镜像文件，而且其过程较慢等。</span> </li> 
        <li style="list-style-type:disc;">外部快照 - 快照是一个只读文件，快照之后的修改是另一个 qcow2 文件中。<span style="line-height:1.5;font-size:14px;">外置快照可以针对各种格式的磁盘镜像文件。外置快照的结果是形成一个 qcow2 文件链：original &lt;- snap1 &lt;- snap2 &lt;- snap3。</span><a href="http://wiki.libvirt.org/page/I_created_an_external_snapshot,_but_libvirt_won' rel=" nofollow"t_let_me_delete_or_revert_to_it" style="color:rgb(26,139,200);text-decoration:none;font-size:14px;line-height:1.5;">这里有文章</a><span style="line-height:1.5;font-size:14px;">详细讨论外置快照。</span> </li> 
       </ul></li> 
     </ul></li> 
    <li style="list-style-type:disc;">内存状态（或者虚机状态）：只是保持内存和虚机使用的其它资源的状态。如果虚机状态快照在做和恢复之间磁盘没有被修改，那么虚机将保持一个持续的状态；如果被修改了，那么很可能导致数据corruption。</li> 
    <li style="list-style-type:disc;">系统还原点（system checkpoint）：虚机的所有磁盘的快照和内存状态快照的集合，可用于恢复完整的系统状态（类似于系统休眠）。</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">关于&nbsp;崩溃一致（crash-consistent）的附加说明：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">应该尽量避免在虚机I/O繁忙的时候做快照。这种时候做快照不是可取的办法。</li> 
    <li style="list-style-type:disc;">vmware 的做法是装一个 tools，它是个 PV driver，可以在做快照的时候挂起系统</li> 
    <li style="list-style-type:disc;">似乎 KVM 也有类似的实现 QEMU Guest Agent，但是还不是很成熟，可参考&nbsp;<a href="http://wiki.libvirt.org/page/Qemu_guest_agent" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://wiki.libvirt.org/page/Qemu_guest_agent</a> </li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">快照还可以分为 live snapshot（热快照）和 Clod snapshot：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">Live snapshot：系统运行状态下做的快照</li> 
    <li style="list-style-type:disc;">Cold snapshot：系统停止状态下的快照</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;font-size:14px;">libvit 做 snapshot 的各个 API：</span></p> 
   <table border="0" style="border:1px solid #C0C0C0;border-collapse:collapse;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <tbody>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">snapshot</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">做快照的 libvirt API</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">从快照恢复的 libvirt API</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">virsh 命令</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">磁盘快照</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">virDomainSnapshotCreateXML（flags =&nbsp;<code>VIR_DOMAIN_SNAPSHOT_CREATE_DISK_ONLY</code>&nbsp;）</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">virDomainRevertToSnapshot</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;virsh snapshot-create/snapshot-revert</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">内存（状态）快照</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p style="line-height:1.5;">virDomainSave</p> <p style="line-height:1.5;">virDomainSaveFlags</p> <p style="line-height:1.5;">virDomainManagedSave</p> </td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p style="line-height:1.5;">virDomainRestore</p> <p style="line-height:1.5;">virDomainRestoreFlags</p> <p style="line-height:1.5;">virDomainCreate</p> <p style="line-height:1.5;">virDomainCreateWithFlags</p> </td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><pre>virsh save/restore</pre></td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">系统检查点</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">virDomainSnapshotCreateXML</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">virDomainRevertToSnapshot</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;virsh snapshot-create/snapshot-revert</td> 
     </tr>
    </tbody>
   </table>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">分别来看看这些 API 是如何工作的：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">1.&nbsp;<span class="Apple-tab-span" style="line-height:1.5;">virDomainSnapshotCreateXML<span class="Apple-tab-span" style="line-height:1.5;">&nbsp;(virDomainPtr domain, const char * xmlDesc, unsigned int flags)</span></span></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">作用：根据 xmlDesc 指定的 snapshot xml 和 flags 来创建虚机的快照。</p> 
   <table border="0" style="border:1px solid #C0C0C0;border-collapse:collapse;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <tbody>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">flags 包含</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;虚机处于运行状态时快照的做法</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">虚机处于关闭状态时快照的做法</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">0</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">创建系统检查点，包括磁盘状态和内存状态比如内存内容</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">保持关机时的磁盘状态</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">VIR_DOMAIN_SNAPSHOT_CREATE_LIVE</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">做快照期间，虚机将不会被 paused。这会增加内存 dump file 的大小，但是可以减少系统停机时间。部分 Hypervisor 只在做外部的系统检查点时才设置该 flag，这意味着普通快照还是需要暂停虚机。</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">VIR_DOMAIN_SNAPSHOT_CREATE_DISK_ONLY</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">只做指定磁盘的快照。对应运行着的虚机，磁盘快照可能是不完整的（类似于突然电源被拔了的情形）。</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">只做指定磁盘的快照。</td> 
     </tr>
    </tbody>
   </table>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;font-size:14px;">其内部实现根据虚机的运行状态有两种情形：</span></p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;"><span style="line-height:1.5;font-size:14px;">对运行着的虚机，API 使用 QEMU Monitor 去做快照，磁盘镜像文件必须是 qcow2 格式，虚机的 CPU 被停止，快照结束后会重新启动。</span></li> 
    <li style="list-style-type:disc;"><span style="line-height:1.5;font-size:14px;">对停止着的虚机，API 调用 qemu-img 方法来操作所有磁盘镜像文件。</span></li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;font-size:14px;"><a href="http://libvirt.org/git/?p=libvirt.git;a=blob;f=src/qemu/qemu_driver.c;h=be678f36527fd7918a1aaa69f54a6c939f258714;hb=HEAD" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这里</a>有其实现代码，可见其基本的实现步骤：</span><span style="line-height:1.5;font-size:14px;">&nbsp;</span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="line-height:1.5;">static</span><span style="line-height:1.5;"> virDomainSnapshotPtr qemuDomainSnapshotCreateXML
{<br>
....
    call qemuDomainSnapshotCreateDiskActive
    {
        call qemuProcessStopCPUs <span style="color:rgb(0,0,255);line-height:1.5;"># 停止 vCPUs </span></span><span style="line-height:1.5;">for</span><span style="line-height:1.5;"> each disk call qemuDomainSnapshotCreateSingleDiskActive
        {
            call qemuMonitorDiskSnapshot <span style="color:rgb(0,0,255);line-height:1.5;"># 调用 QEMU Monitor 去为每个磁盘做snapshot</span>
        }
        call qemuProcessStartCPUs <span style="color:rgb(0,0,255);line-height:1.5;"># 启动 vCPUs<br><span style="color:rgb(0,0,0);line-height:1.5;"> }</span><br><span style="color:rgb(0,0,0);line-height:1.5;"> ....</span></span>
}</span><span style="line-height:1.5;font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">2.&nbsp;<span class="Apple-tab-span" style="line-height:1.5;">virDomainSave<span class="Apple-tab-span" style="line-height:1.5;">&nbsp;</span>相关</span>的几个 API</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">这几个API 功能都比较类似：</p> 
   <table border="0" style="border:1px solid #C0C0C0;border-collapse:collapse;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <tbody>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><span class="Apple-tab-span" style="line-height:1.5;">virDomainSave<span class="Apple-tab-span" style="line-height:1.5;">&nbsp;</span></span></td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">该方法会 suspend 一个运行着的虚机，然后保存期内存内容到一个文件中。成功调用以后，domain 将不会处于 running 状态。使用&nbsp;virDomainRestore 来恢复虚机。</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><span class="Apple-tab-span" style="line-height:1.5;">virDomainSaveFlags<span class="Apple-tab-span" style="line-height:1.5;">&nbsp;</span></span></td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">类似于&nbsp;<span class="Apple-tab-span" style="line-height:1.5;">virDomainSave&nbsp;API</span>，可使用几个 &nbsp;flags<span class="Apple-tab-span" style="line-height:1.5;">。一些 Hypervisor 在调用该方法前需要调用&nbsp;&nbsp;<a href="http://libvirt.org/html/libvirt-libvirt-domain.html#virDomainBlockJobAbort" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">virDomainBlockJobAbort</a>() 方法来停止 block copy 操作。</span> </td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><span class="Apple-tab-span" style="line-height:1.5;">virDomainManagedSave<span class="Apple-tab-span" style="line-height:1.5;">&nbsp;</span></span></td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">也类似于&nbsp;<span class="Apple-tab-span" style="line-height:1.5;">virDomainSave&nbsp;API。主要区别是 libvirt 将其内存保存到一个受 libvirt 管理的文件中，因此libvirt 可以一直跟踪 snapshot 的状态；当调用 virDomainCreate/virDomainCreateWithFlags 方法重启该&nbsp;domain的时候，libvirt 会使用该受管文件，而不是一个空白的文件，这样就可以 restore 该snapshot。</span> </td> 
     </tr>
    </tbody>
   </table>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><a href="http://wiki.qemu.org/Features/SnapshotsMultipleDevices" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;line-height:1.5;">Features/SnapshotsMultipleDevices</a><span style="line-height:1.5;">&nbsp;这篇文章讨论同时对多个磁盘做快照的问题。</span></p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.2 使用 virsh 实验</h3> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1.2.1 virsh save 命令</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">对运行中的 domain d-2 运行 “virsh save” 命令。命令执行完成后，d-2 变成 “shut off” 状态。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images0.cnblogs.com/blog2015/697113/201506/140853234419111.jpg" alt="" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">看看 domain 的磁盘镜像文件和 snapshot 文件：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images0.cnblogs.com/blog2015/697113/201506/140855200989538.jpg" alt="" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">内存数据被保存到 raw 格式的文件中。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">要恢复的时候，可以运行 “vish restore d-2.snap1” 命令从保存的文件上恢复。</p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1.2.2 virsh snapshot-create/snapshort-create-as</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">先看看它的用法：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="line-height:1.5;">virsh # help snapshot-create-as
  NAME
    snapshot-create-as - Create a snapshot from a set of args

  SYNOPSIS
    snapshot-create-as &lt;domain&gt; [&lt;name&gt;] [&lt;description&gt;] [--print-xml] [--no-metadata] [--halt] [--disk-only] [--reuse-external] [--quiesce] [--atomic] [--live] [--memspec &lt;string&gt;] [[--diskspec] &lt;string&gt;]...

  DESCRIPTION
    Create a snapshot (disk and RAM) from arguments

  OPTIONS
    [--domain] &lt;string&gt;  domain name, id or uuid
    [--name] &lt;string&gt;  name of snapshot
    [--description] &lt;string&gt;  description of snapshot
    --print-xml      print XML document rather than create
    --no-metadata    take snapshot but create no metadata  <span style="color:rgb(0,0,255);line-height:1.5;">#创建的快照不带任何元数据</span>
    --halt           halt domain after snapshot is created <span style="color:rgb(0,0,255);line-height:1.5;">#快照创建后虚机会关闭</span>
    --disk-only      capture disk state but not vm state   <span style="color:rgb(0,0,255);line-height:1.5;">#只对磁盘做快照，忽略其它参数</span>
    --reuse-external  reuse any existing external files
    --quiesce        quiesce guest's file systems <span style="color:rgb(0,0,255);line-height:1.5;">#libvirt 会通过 QEMU GA 尝试去freeze和unfreeze客户机已经mounted的文件系统；如果客户机没有安装QEMU GA，则操作会失败。</span>
    --atomic         require atomic operation <span style="color:rgb(0,0,255);line-height:1.5;">#快照要么完全成功要么完全失败，不允许部分成果。不是所有的VMM都支持。</span>
    --live           take a live snapshot     <span style="color:rgb(0,0,255);line-height:1.5;">#当客户机处于运行状态下做快照</span>
    --memspec &lt;string&gt;  memory attributes: [file=]name[,snapshot=type]
    [--diskspec] &lt;string&gt;  disk attributes: disk[,snapshot=type][,driver=type][,file=name]</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">其中一些参数，比如 --atomic，在一些老的 QEMU libary 上不支持，需要更新它到新的版本。根据&nbsp;<a href="http://wiki.qemu.org/Features/SnapshotsMultipleDevices" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这篇文章</a>，atomic 应该是 QEMU 1.0 中加入的。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）默认的话，该命令创建虚机的所有磁盘和内存做内部快照，创建快照时虚机处于 paused 状态，快照完成后变为 running 状态。持续时间较长。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>&lt;memory snapshot=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">internal</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
  &lt;disks&gt;
    &lt;disk name=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">vda</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> snapshot=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">internal</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
    &lt;disk name=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">vdb</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> snapshot=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">internal</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
    &lt;disk name=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">vdc</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> snapshot=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">internal</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
  &lt;/disks&gt;<span style="line-height:1.5;font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images0.cnblogs.com/blog2015/697113/201506/140936147851885.jpg" alt="" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">每个磁盘的镜像文件都包含了 snapshot 的信息：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="line-height:1.5;">root@compute1:/var/lib/nova/instances/eddc46a8-e026-4b2c-af51-dfaa436fcc7b# qemu-img info disk
image: disk
file format: qcow2
virtual size: 1.0G (1073741824 bytes)
disk size: 43M
cluster_size: 65536
backing file: /var/lib/nova/instances/_base/fbad3d96a1727069346073e51d5bbb1824e76e34
<span style="color:rgb(0,0,255);line-height:1.5;">Snapshot list: ID TAG VM SIZE DATE VM CLOCK 1 1433950148 41M 2015-06-10 23:29:08 05:16:55.007</span>
Format specific information:
    compat: 1.1
    lazy refcounts: false<br></span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;font-size:14px;">你可以运行 snapshot-revert 命令回滚到指定的snapshot。</span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>virsh # snapshot-revert instance-0000002e <span style="color:rgb(128,0,128);line-height:1.5;">1433950148</span></pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">根据&nbsp;<a href="http://www.redhat.com/archives/libvir-list/2012-October/msg01390.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这篇文章</a>，libvirt 将内存状态保存到某一个磁盘镜像文件内 （”state is saved inside one of the disks (as in qemu's 'savevm'system checkpoint implementation). If needed in the future,we can also add an attribute pointing out _which_ disk saved the internal state; maybe disk='vda'.）</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）可以使用 “--memspec” 和 “--diskspec” 参数来给内存和磁盘外部快照。这时候，在获取内存状态之前需要 Pause 虚机，就会产生服务的 downtime。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>virsh # snapshot-create-<span style="color:rgb(136,136,136);line-height:1.5;">as</span> 0000002e livesnap2  --memspec /home/s1/livesnap2mem,snapshot=external --diskspec vda,snapshot=<span style="line-height:1.5;">external
Domain snapshot livesnap2 created
virsh # snapshot</span>-<span style="line-height:1.5;">dumpxml 0000002e livesnap2
</span>  <span style="color:rgb(0,0,255);line-height:1.5;">&lt;memory snapshot='external' file='/home/s1/livesnap2mem'/&gt;</span>
  &lt;disks&gt;
    <span style="color:rgb(0,0,255);line-height:1.5;">&lt;disk name='vda' snapshot='external' type='file'&gt;</span>
      &lt;driver type=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">qcow2</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
      &lt;source file=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">/home/s1/testvm/testvm1.livesnap2</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
    &lt;/disk&gt;
  &lt;/disks&gt;</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;">（3）可以使用 “--disk-only” 参数，这时会做所有磁盘的外部快照，但是不包含内存的快照。不指定快照文件名字的话，会放在原来的磁盘文件所在的目录中。多次快照后，会形成一个外部快照链，新的快照使用前一个快照的镜像文件作为 backing file。</span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>virsh # snapshot-list instance-0000002e --<span style="line-height:1.5;">tree
</span><span style="color:rgb(128,0,128);line-height:1.5;">1433950148 #内部快照</span>
<span style="color:rgb(128,0,128);line-height:1.5;">1433950810 #内部快照</span>
<span style="color:rgb(128,0,128);line-height:1.5;">1433950946 #内部快照</span><span style="line-height:1.5;">
snap1 #第一个外部快照
  </span>|
  +-<span style="line-height:1.5;"> snap2 #第二个外部快照
      </span>|
      +- <span style="color:rgb(128,0,128);line-height:1.5;">1433954941 #第三个外部快照</span>
          |
          +- <span style="color:rgb(128,0,128);line-height:1.5;">1433954977 #第四个外部快照</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">而第一个外部快照的镜像文件是以虚机的原始镜像文件作为 backing file 的：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="line-height:1.5;">root@compute1:/var/lib/nova/instances/eddc46a8-e026-4b2c-af51-dfaa436fcc7b# qemu-img info disk.snap1
image: disk.snap1
file format: qcow2
virtual size: 30M (31457280 bytes)
disk size: 196K
cluster_size: 65536
backing file: /var/lib/nova/instances/eddc46a8-e026-4b2c-af51-dfaa436fcc7b/disk.swap <span style="color:rgb(0,0,255);line-height:1.5;">#虚机的 swap disk 原始镜像文件</span>
backing file format: qcow2
Format specific information:
    compat: 1.1
    lazy refcounts: false</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">目前还不支持回滚到某一个extrenal disk snapshot。<a href="https://lists.fedoraproject.org/pipermail/virt/2015-March/004236.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这篇文章</a>&nbsp;谈到了一个workaround。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <p style="line-height:1.5;">[root@rh65 osdomains]# virsh snapshot-revert d-2 1434467974<br> error: unsupported configuration: revert to external disk snapshot not supported yet</p> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（4）还可以使用 “--live” 参数创建系统还原点，包括磁盘、内存和设备状态等。使用这个参数时，虚机不会被 Paused（那怎么实现的？）。其后果是增加了内存 dump 文件的大小，但是减少了系统的 downtime。该参数只能用于做外部的系统还原点（external checkpoint）。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>virsh # snapshot-create-<span style="line-height:1.5;">as</span> 0000002e livesnap3  --memspec /home/s1/livesnap3mem,snapshot=external --diskspec vda,snapshot=external <span style="color:rgb(0,0,255);line-height:1.5;">--</span><span style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;">live</span>
Domain snapshot livesnap3 created
virsh # snapshot</span>-<span style="line-height:1.5;">dumpxml 0000002e livesnap3
</span>  &lt;memory snapshot=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">external</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> file=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">/home/s1/livesnap3mem</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
  &lt;disks&gt;
    &lt;disk name=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">vda</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> snapshot=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">external</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> type=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">file</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>&gt;
      &lt;driver type=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">qcow2</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
      &lt;source file=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">/home/s1/testvm/testvm1.livesnap3</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
    &lt;/disk&gt;
  &lt;/disks&gt;</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;">注意到加 “--live” 生成的快照和不加这个参数生成的快照不会被链在一起：</span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>virsh # snapshot-list 0000002e --<span style="line-height:1.5;">tree
</span><span style="line-height:1.5;">livesnap1 <span style="color:rgb(0,0,255);line-height:1.5;">#没加 --live </span></span>|
  +-<span style="line-height:1.5;"> livesnap2 <span style="color:rgb(0,0,255);line-height:1.5;">#没加 --live</span>

livesnap3 <span style="color:rgb(0,0,255);line-height:1.5;">#加了 --live </span></span>|
  +- livesnap4 <span style="color:rgb(0,0,255);line-height:1.5;">#加了 --live</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;">不过，奇怪的是，使用 QEMU 2.3 的情况下，即使加了 --live 参数，虚机还是会被短暂的 Paused 住：</span></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>[root@rh65 ~]# virsh snapshot-create-<span style="color:rgb(0,0,255);line-height:1.5;">as</span> d-<span style="color:rgb(128,0,128);line-height:1.5;">2</span> --memspec /home/work/d-<span style="color:rgb(128,0,128);line-height:1.5;">2</span>/mem3,snapshot=external --diskspec hda,snapshot=external --<span style="line-height:1.5;">live
Domain snapshot </span><span style="color:rgb(128,0,128);line-height:1.5;">1434478667</span><span style="line-height:1.5;"> created

[root@rh65 </span>~]# virsh list --<span style="line-height:1.5;">all
 Id    Name                           State
</span>----------------------------------------------------
 <span style="color:rgb(128,0,128);line-height:1.5;">40</span><span style="line-height:1.5;">    osvm1                          running
 </span><span style="color:rgb(128,0,128);line-height:1.5;">42</span><span style="line-height:1.5;">    osvm2                          running
 </span><span style="color:rgb(128,0,128);line-height:1.5;">43</span>    d-<span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">                            running

[root@rh65 </span>~]# virsh list --<span style="line-height:1.5;">all
 Id    Name                           State
</span>----------------------------------------------------
 <span style="color:rgb(128,0,128);line-height:1.5;">40</span><span style="line-height:1.5;">    osvm1                          running
 </span><span style="color:rgb(128,0,128);line-height:1.5;">42</span><span style="line-height:1.5;">    osvm2                          running
 </span><span style="color:rgb(0,0,255);line-height:1.5;">43    d-2</span><span style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;"> paused # 不是说好我用 --live 你就不pause 虚机的么？这是肿了么。。</span>

[root@rh65 </span>~]# virsh list --<span style="line-height:1.5;">all
 Id    Name                           State
</span>----------------------------------------------------
 <span style="color:rgb(128,0,128);line-height:1.5;">40</span><span style="line-height:1.5;">    osvm1                          running
 </span><span style="color:rgb(128,0,128);line-height:1.5;">42</span><span style="line-height:1.5;">    osvm2                          running
 </span><span style="color:rgb(128,0,128);line-height:1.5;">43</span>    d-<span style="color:rgb(128,0,128);line-height:1.5;">2</span>                            running</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;">综上所述，对于&nbsp;snapshot-create-as 命令来说，</span></p> 
   <table border="0" style="border:1px solid #C0C0C0;border-collapse:collapse;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <tbody>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">参数</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">结果</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&lt;不使用额外的参数&gt;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">所有磁盘和内存的内部的内部快照</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <pre>--memspec snapshot=external --diskspec vda,snapshot=external</pre>&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">磁盘和内存的外部快照，虚机需要被暂停</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">--live &nbsp;<span style="line-height:1.5;font-family:'Courier New';">--memspec snapshot=external --diskspec vda,snapshot=external</span> </td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">创建系统检查点（包括磁盘和内存的快照），而且<span style="line-height:1.5;color:rgb(0,0,255);">虚机不会被暂停（？测试结果显示还是会暂停，只是暂停时间比不使用 --live 要短一些）</span> </td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">--disk-only</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">创建所有或者部分磁盘的外部快照</td> 
     </tr>
    </tbody>
   </table>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;font-size:14px;">&nbsp;可以使用 sanpshot-revert 命令来回滚到指定的系统还原点，不过得使用 “-force” 参数：</span></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>[root@rh65 ~]# virsh snapshot-revert d-<span style="color:rgb(128,0,128);line-height:1.5;">2</span> <span style="color:rgb(128,0,128);line-height:1.5;">1434478313</span><span style="line-height:1.5;">
error: revert requires force: Target device address type none does not match source pci

[root@rh65 </span>~]# virsh snapshot-revert d-<span style="color:rgb(128,0,128);line-height:1.5;">2</span> <span style="color:rgb(128,0,128);line-height:1.5;">1434478313</span>  --<span style="line-height:1.5;">force

[root@rh65 </span>~]#</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;"><span style="line-height:1.5;font-size:14px;">1.3 外部快照的删除</span></h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;font-size:14px;">目前 libvirt 还不支持直接删除一个外部快照，可以参考&nbsp;<a href="http://wiki.libvirt.org/page/I_created_an_external_snapshot,_but_libvirt_won%27t_let_me_delete_or_revert_to_it" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这篇文章</a>&nbsp;介绍的 workaround。</span></p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">2. OpenStack 中的快照</h2> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    &nbsp;OpenStack Snapshot 可分为下面的几种情形：
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.1 对 Nova Instance 进行快照</h3> 
    <p style="line-height:1.5;">（1）对从镜像文件启动的虚机做快照</p> 
    <ul style="list-style:none;font-size:12px;">
     <li style="list-style-type:disc;">只将运行当中的虚机的 Root disk （第一个vd 或者 hd disk） 做成 image，然后上传到 glance 里面</li> 
     <li style="list-style-type:disc;">Live Snapshot：对满足特定条件（QEMU 1.3+ 和 Libvirt 1.0.0+，以及 source_format not in ('lvm', 'rbd') and not CONF.ephemeral_storage_encryption.enabled and not CONF.workarounds.disable_libvirt_livesnapshot，以及能正常调用 libvirt.blockJobAbort ，其前提条件可参考<a href="http://www.sebastien-han.fr/blog/2012/12/10/openstack-perform-consistent-snapshots/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这文章</a>）的虚机，会进行 Live snapshot。Live Snapshot 允许用户在虚机处于运行状态时不停机做快照。</li> 
     <li style="list-style-type:disc;">Cold Snapshot：对不能做 live snapshot 的虚机做 Cold snapshot。这种快照必须首先 Pause 虚机。</li> 
    </ul>
    <p style="line-height:1.5;">（2）对从卷启动的虚机做快照</p> 
    <ul style="list-style:none;font-size:12px;">
     <li style="list-style-type:disc;">对虚机的每个挂载的 volume 调用 cinder API 做 snapshot。</li> 
     <li style="list-style-type:disc;">Snapshot 出的 metadata 会保存到 glance 里面，但是不会有 snapshot 的 image 上传到 Glance 里面。</li> 
     <li style="list-style-type:disc;">这个 snapshot 也会出现在 cinder 的数据库里面，对 cinder API 可见。</li> 
    </ul>
    <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.2 对卷做快照</h3> 
    <ul style="list-style:none;font-size:12px;">
     <li style="list-style-type:disc;">调用 cinder driver api，对 backend 中的 volume 进行 snapshot。</li> 
     <li style="list-style-type:disc;">这个 snapshot 会出现在 cinder 的数据库里面，对 cinder API 可见。<strong style="line-height:1.5;">&nbsp;</strong><span style="line-height:1.5;">&nbsp;</span> </li> 
    </ul>
   </div> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">3. 从镜像文件启动的 Nova 虚机做快照</h2> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp; 严格地说，Nova 虚机的快照，并不是对虚机做完整的快照，而是对虚机的<span style="line-height:1.5;text-decoration:underline;">启动盘</span>（root disk，即 vda 或者 hda）做快照生成 qcow2 格式的文件，并将其传到 Glance 中，其作用也往往是方便使用快照生成的镜像来部署新的虚机。Nova 快照分为 Live Snapshot （不停机快照）和 Clold Snapshot （停机快照）。</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">3.1 Nova Live Snapshot</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">满足 2.1.1 中所述条件时，运行命令 &nbsp;”<a>nova image-create &lt;instance name or uuid&gt; &lt;name of new image&gt;“ 后，</a>Nova 会执行 Live Snapshot。其过程如下：</p> 
   <ol style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;">找到虚机的 root disk (vda 或者 hda)。</li> 
    <li style="list-style-type:decimal;">在&nbsp;CONF.libvirt.snapshots_directory 指定的文件夹（默认为 /var/lib/nova/instances/snapshots）中创建一个临时文件夹，在其中创建一个 qcow2 格式的 delta 文件，其文件名为 uuid 字符串，该文件的 backing file 和 root disk 文件的 backing file 相同 （下面步骤 a）。</li> 
    <li style="list-style-type:decimal;"><span style="line-height:1.5;">调用 virDomainGetXMLDesc 来保存 domain 的 xml 配置。</span></li> 
    <li style="list-style-type:decimal;"> <span style="line-height:1.5;">调用&nbsp;</span>virDomainBlockJobAbort 来停止对 root disk 的活动块操作 （Cancel the active block job on the given disk）。</li> 
    <li style="list-style-type:decimal;">调用&nbsp;virDomainUndefine 来将 domain 变为 transimit 类型的，这是因为&nbsp;BlockRebase API 不能针对 Persistent domain 调用。</li> 
    <li style="list-style-type:decimal;">调用&nbsp;<span style="line-height:1.5;text-decoration:underline;">virDomainBlockRebase</span>&nbsp;来将 root disk image 文件中不同的数据拷贝到 delta disk file 中。（下面步骤 b）</li> 
    <li style="list-style-type:decimal;">步骤 6 是一个持续的过程，因为可能有应用正在向该磁盘写数据。Nova&nbsp;每隔 0.5 秒调用&nbsp;<span style="line-height:1.5;text-decoration:underline;">virDomainBlockJobInfo</span>&nbsp;API 来检查拷贝是否结束。</li> 
    <li style="list-style-type:decimal;">拷贝结束后，调用 &nbsp;<span style="line-height:1.5;">virDomainBlockJobAbort 来终止数据拷贝。</span> </li> 
    <li style="list-style-type:decimal;"> <span style="line-height:1.5;">调用</span>&nbsp;virDomainDefineXML 将domain 由 transimisit 该回到 persistent。</li> 
    <li style="list-style-type:decimal;">调用&nbsp;qemu-img convert 命令将&nbsp;delta image 文件和 backing file 变为一个 qcow2 文件 （下面步骤 c）</li> 
    <li style="list-style-type:decimal;">将 image 的元数据和 qcow2 文件传到 Glance 中。</li> 
   </ol>
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="line-height:1.5;">（a）执行  qemu</span>-img create -f qcow2 （qemu-<span style="line-height:1.5;">img create 创建一个基于镜像1的镜像2，镜像2的文件将基于镜像1，镜像2中的文件将基于镜像1中的。在镜像2中所作的任何读写操作都不会影响到镜像1. 镜像1可以被其他镜像当做backing file. 但是要确保镜像1不要被修改）。比如：

</span><span style="line-height:1.5;">qemu</span>-img create -f qcow2 -o backing_file=/<span style="color:rgb(0,0,255);line-height:1.5;">var</span>/lib/nova/instances/_base/ed39541b2c77cd7b069558570fa1dff4fda4f678,size=<span style="color:rgb(128,0,128);line-height:1.5;">21474836480</span> /<span style="color:rgb(0,0,255);line-height:1.5;">var</span>/lib/nova/instances/snapshots/tmpzfjdJS/<span style="line-height:1.5;">7f8d11be9ff647f6b7a0a643fad1f030.delta <br></span></pre> 
    <pre>（b）相当于执行 virsh blockjob &lt;domain&gt; &lt;path&gt; [--abort] [--async] [--pivot] [--info] [&lt;bandwidth&gt;]</pre> 
    <pre><span style="line-height:1.5;">（c）执行 </span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">qemu-img </span><span style="color:rgb(128,0,0);line-height:1.5;">convert </span><span style="color:rgb(128,0,0);line-height:1.5;">-f </span>qcow2 <span style="color:rgb(128,0,0);line-height:1.5;">-o</span><span style="line-height:1.5;"> dest_fmt' 来将带 backing file 的 qcow2 image 转化成不带 backing file 的 flat image。其中 dest_fmt 由 snapshot_image_format 决定，有效值是 raw, qcow2, vmdk, vdi，默认值是 source image 的 format。比如： qemu</span>-img convert -f qcow2 -O qcow2 /<span style="color:rgb(0,0,255);line-height:1.5;">var</span>/lib/nova/instances/snapshots/tmpzfjdJS/7f8d11be9ff647f6b7a0a643fad1f030.delta /<span style="color:rgb(0,0,255);line-height:1.5;">var</span>/lib/nova/instances/snapshots/tmpzfjdJS/7f8d11be9ff647f6b7a0a643fad1f030</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">来看看其中的一个关键 API&nbsp;int<span class="Apple-tab-span" style="line-height:1.5;">&nbsp;virDomainBlockRebase<span class="Apple-tab-span" style="line-height:1.5;">&nbsp;(virDomainPtr dom, const char * disk, const char * base, unsigned long bandwidth,unsigned int flags)</span></span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <pre><span style="line-height:1.5;">该 API 从 backing 文件中拷贝数据，或者拷贝整个 backing 文件到  @base 文件。</span></pre> 
    <pre><span style="line-height:1.5;">Nova 中的调用方式为：</span>domain.blockRebase(disk_path, disk_delta, 0,libvirt.VIR_DOMAIN_BLOCK_REBASE_COPY |libvirt.VIR_DOMAIN_BLOCK_REBASE_REUSE_EXT |libvirt.VIR_DOMAIN_BLOCK_REBASE_SHALLOW)</pre> 
    <pre>默认的话，该 API 会拷贝整个@disk 文件到 @base 文件，但是使用 &nbsp;<a href="http://libvirt.org/html/libvirt-libvirt-domain.html#VIR_DOMAIN_BLOCK_REBASE_SHALLOW" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">VIR_DOMAIN_BLOCK_REBASE_SHALLOW</a> 的话就只拷贝差异数据（top data）因为 @disk 和 @base 使用相同的 backing 文件。&nbsp;<a href="http://libvirt.org/html/libvirt-libvirt-domain.html#VIR_DOMAIN_BLOCK_REBASE_REUSE_EXT" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">VIR_DOMAIN_BLOCK_REBASE_REUSE_EXT</a> 表示需要使用已经存在的 @base 文件因为 Nova 会预先创建好这个文件。</pre> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">简单的示意图：</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;"><img src="https://images0.cnblogs.com/blog2015/697113/201506/121541330666799.jpg" alt="" style="border:0px;"></h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><a href="https://gist.github.com/rmk40/4617831" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这里</a>&nbsp;有个过程的 PoC 代码描述该过程。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><a href="https://kashyapc.fedorapeople.org/virt/openstack/nova_live_snapshot_libvirt_analysis.txt" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这里</a>&nbsp;有该过程的完整 libvirt 日志分析。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><a href="http://wiki.qemu.org/Features/SnapshotsMultipleDevices" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这里</a>&nbsp;有文章讲 Libvirt&nbsp;Features/SnapshotsMultipleDevices。</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">3.2 Nova Cold Snapshot</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">当虚机不在运行中时或者不满足 live snapshot 的条件的情况下，Nova 会执行 Cold snapshot。其主要过程如下：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）当虚机处于 running 或者 paused 状态时：</p> 
   <ol style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;">detach PCI devices</li> 
    <li style="list-style-type:decimal;">detach SR-IOV devices</li> 
    <li style="list-style-type:decimal;">调用&nbsp;virDomainManagedSave API 来将虚机 suspend 并且将内存状态保存到磁盘文件中。</li> 
   </ol>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）调用&nbsp;qemu-img convert 命令将 root disk 的镜像文件转化一个相同格式的镜像文件。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（3）调用 virDomainCreateWithFlags&nbsp; API&nbsp;将虚机变为初始状态</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（4）将在步骤1 中卸载的 PCI 和 SR-IOV 设备重新挂载回来</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（5）将元数据和 qcow2 文件传到 Glance 中</p> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <h2 style="font-size:21px;line-height:1.5;">4. 从 volume 启动的 Nova 实例的快照</h2> 
    <p style="line-height:1.5;">（0）从卷启动虚机，并且再挂载一个卷，然后运行 nova image-create 命令。</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
     <pre>| image                                | Attempt to boot <span style="color:rgb(0,0,255);line-height:1.5;">from</span> volume - no image supplied                                                  |
| key_name                             | -                                                                                                |
| metadata                             | {}                                                                                               |
| name                                 | vm10                                                                                             |
| os-extended-volumes:volumes_attached | [{<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">id</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">26446902-5a56-4c79-b839-a8e13a66dc7a</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>}, {<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">id</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">de127d46-ed92-471d-b18b-e89953c305fd</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>}]</pre>
    </div> 
    <p style="line-height:1.5;">（1）从 DB 获取该虚机的块设备（ Block Devices Mapping）列表。</p> 
    <p style="line-height:1.5;">（2）对该列表中的每一个卷，依次调用 Cinder API 做快照。对 LVM Driver 的 volume 来说，执行的命令类似于 " lvcreate --size 100M --snapshot --name snap /dev/vg00/lvol1“。</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre>s1@controller:~$ cinder snapshot-<span style="line-height:1.5;">list
</span>+--------------------------------------+--------------------------------------+-----------+------------------------+------+
|                  ID                  |              Volume ID               |   Status  |          Name          | Size |
+--------------------------------------+--------------------------------------+-----------+------------------------+------+
| a7c591fb-<span style="color:rgb(128,0,128);line-height:1.5;">3413</span>-<span style="color:rgb(128,0,128);line-height:1.5;">4548</span>-abd8-86753da3158b | de127d46-ed92-471d-b18b-e89953c305fd | available | snapshot <span style="color:rgb(0,0,255);line-height:1.5;">for</span> vm10-snap |  <span style="color:rgb(128,0,128);line-height:1.5;">1</span>   |
| d1277ea9-e972-4dd4-89c0-0b9d74956247 | <span style="color:rgb(128,0,128);line-height:1.5;">26446902</span>-5a56-4c79-b839-a8e13a66dc7a | available | snapshot <span style="color:rgb(0,0,255);line-height:1.5;">for</span> vm10-snap |  <span style="color:rgb(128,0,128);line-height:1.5;">1</span>   |
+--------------------------------------+--------------------------------------+-----------+------------------------+------+</pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="line-height:1.5;">（3）将快照的 metadata 放到 Glance 中。（注：该 image 只是一些属性的集合，比如 block device mapping, kernel 和 ramdisk IDs 等，它并没有 image 数据, 因此其 size 为 0。）</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre>s1@controller:~$ glance image-show e86cc562-349c-48cb-a81c-<span style="line-height:1.5;">896584accde3
</span>+---------------------------------+----------------------------------------------------------------------------------+
| Property                        | Value                                                                            |
+---------------------------------+----------------------------------------------------------------------------------+
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">bdm_v2</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>               | True                                                                             |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">block_device_mapping</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> | [{<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">guest_format</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(0,0,255);line-height:1.5;">null</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">boot_index</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,128);line-height:1.5;">0</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">no_device</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(0,0,255);line-height:1.5;">null</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">snapshot_id</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>:       |
| <span style="color:rgb(0,0,255);line-height:1.5;"># 分别是该虚机挂载的两个volume 的   | "d1277ea9-e972-4dd4-89c0-0b9d74956247", "delete_on_termination": null,           |
| snapshot 的信息</span>                  | <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">disk_bus</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">virtio</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">image_id</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(0,0,255);line-height:1.5;">null</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">source_type</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">snapshot</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>,               |
|                                 | <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">device_type</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">disk</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">volume_id</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(0,0,255);line-height:1.5;">null</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">destination_type</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">volume</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>,          |
|                                 | <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">volume_size</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(0,0,255);line-height:1.5;">null</span>}, {<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">guest_format</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(0,0,255);line-height:1.5;">null</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">boot_index</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(0,0,255);line-height:1.5;">null</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">no_device</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>:    |
|                                 | <span style="color:rgb(0,0,255);line-height:1.5;">null</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">snapshot_id</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">a7c591fb-3413-4548-abd8-86753da3158b</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>,                     |
|                                 | <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">delete_on_termination</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(0,0,255);line-height:1.5;">null</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">disk_bus</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(0,0,255);line-height:1.5;">null</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">image_id</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(0,0,255);line-height:1.5;">null</span>,               |
|                                 | <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">source_type</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">snapshot</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">device_type</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(0,0,255);line-height:1.5;">null</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">volume_id</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(0,0,255);line-height:1.5;">null</span>,               |
|                                 | <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">destination_type</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">volume</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">volume_size</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(0,0,255);line-height:1.5;">null</span>}]                              |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">checksum</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>             | 64d7c1cd2b6f60c92c14662941cb7913                                                 |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">container_format</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>     | bare                                                                             |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">disk_format</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>          | qcow2                                                                            |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">image_id</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>             | bb9318db-<span style="color:rgb(128,0,128);line-height:1.5;">5554</span>-<span style="color:rgb(128,0,128);line-height:1.5;">4857</span>-a309-268c6653b9ff                                             |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">image_name</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>           | image                                                                            |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">min_disk</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>             | <span style="color:rgb(128,0,128);line-height:1.5;">0</span>                                                                                |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">min_ram</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>              | <span style="color:rgb(128,0,128);line-height:1.5;">0</span>                                                                                |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">root_device_name</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>     | /dev/vda                                                                         |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">size</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>                 | <span style="color:rgb(128,0,128);line-height:1.5;">13167616</span>                                                                         |
| created_at                      | <span style="color:rgb(128,0,128);line-height:1.5;">2015</span>-<span style="color:rgb(128,0,128);line-height:1.5;">06</span>-10T05:<span style="color:rgb(128,0,128);line-height:1.5;">52</span>:<span style="color:rgb(128,0,128);line-height:1.5;">24</span>                                                              |
| deleted                         | False                                                                            |
| id                              | e86cc562-349c-48cb-a81c-896584accde3                                             |
| is_public                       | False                                                                            |
| min_disk                        | <span style="color:rgb(128,0,128);line-height:1.5;">0</span>                                                                                |
| min_ram                         | <span style="color:rgb(128,0,128);line-height:1.5;">0</span>                                                                                |
| name                            | vm10-snap                                                                        |
| owner                           | 74c8ada23a3449f888d9e19b76d13aab                                                 |
| <span style="color:rgb(0,0,255);line-height:1.5;">protected</span>                       | False                                                                            |
| size                            | <span style="color:rgb(128,0,128);line-height:1.5;">0</span>      <span style="color:rgb(0,0,255);line-height:1.5;"># 这里 size 是 0，表明该 image 只是元数据，</span>                                   |
| status                          | active                                                                           |
| updated_at                      | <span style="color:rgb(128,0,128);line-height:1.5;">2015</span>-<span style="color:rgb(128,0,128);line-height:1.5;">06</span>-10T05:<span style="color:rgb(128,0,128);line-height:1.5;">52</span>:<span style="color:rgb(128,0,128);line-height:1.5;">24</span>                                                              |
+---------------------------------+----------------------------------------------------------------------------------+<span style="line-height:1.5;font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</span></pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <h2 style="font-size:21px;line-height:1.5;"><span style="line-height:1.5;">5. 当前 Nova snapshot 的局限</span></h2> 
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <ul style="list-style:none;font-size:12px;">
     <li style="list-style-type:disc;">Nova snapshot 其实只是提供一种创造<span style="line-height:1.5;text-decoration:underline;">系统盘镜像</span>的方法。不支持回滚至快照点，只能采用该快照镜像创建一个新的虚拟机。</li> 
     <li style="list-style-type:disc;">在虚机是从 image boot 的时候，只对<span style="line-height:1.5;text-decoration:underline;">系统盘</span>进行快照，不支持内存快照，不支持系统还原点&nbsp;（blueprint：https://blueprints.launchpad.net/nova/+spec/live-snapshot-vms）</li> 
     <li style="list-style-type:disc;"> <span style="line-height:1.5;">Live Snapshot 需要用户进行一致性操作：</span><a href="http://www.sebastien-han.fr/blog/2012/12/10/openstack-perform-consistent-snapshots/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;line-height:1.5;">http://www.sebastien-han.fr/blog/2012/12/10/openstack-perform-consistent-snapshots/</a> </li> 
     <li style="list-style-type:disc;"><span style="line-height:1.5;">只支持虚拟机内置（全量）快照，不支持外置（增量）快照。这与当前快照的实现方式有关，因为是通过 image 进行保存的。</span></li> 
     <li style="list-style-type:disc;">从 image boot 的虚机的快照以 Image 方式保存到 Glance 中，而非以 Cinder 卷方式保存。</li> 
     <li style="list-style-type:disc;">过程较长（需要先通过存储快照，然后抽取并上传至 Glance)，网络开销大。</li> 
    </ul>
    <p style="line-height:1.5;">那为什么 Nova 不实现虚机的快照而只是系统盘的快照呢？据说，社区关于这个功能有过讨论，讨论的结果是<span style="line-height:1.5;text-decoration:underline;">不加入</span>这个功能，原因主要有几点：</p> 
    <ul style="list-style:none;font-size:12px;">
     <li style="list-style-type:disc;">这应该是一种虚拟化技术的功能，不是云计算平台的功能。</li> 
     <li style="list-style-type:disc;">openstack 由于底层要支持多种虚拟化的技术，某些虚拟化技术实现这种功能比较困难。</li> 
     <li style="list-style-type:disc;">创建的 VM state snapshot 会面临 cpu feature 不兼容的问题。</li> 
     <li style="list-style-type:disc;">目前 libvirt 对 QEMU/KVM 虚机的外部快照的支持还不完善，即使更新到最新的 libvirt 版本，造成兼容性比较差。</li> 
    </ul>
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    &nbsp;
    <a href="http://www.gossamer-threads.com/lists/openstack/dev/8678" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这里</a>&nbsp;也有很多的讨论。
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <br>
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <br>
   </div> 
   <div> 
    <font color="#4b4b4b"><span style="font-size:15px;">&nbsp; &nbsp; 本文转自SammyLiu博客园博客，原文链接：http://www.cnblogs.com/sammyliu/p/4468757.html</span></font>
    <span style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">，如需转载请自行联系原作者</span> 
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
