<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Hadoop MapReduce编程 API入门系列之小文件合并（二十九） « NotBeCN</title>
  <meta name="description" content="             &nbsp;&nbsp;Hadoop 自身提供了几种机制来解决相关的问题，包括HAR，SequeueFile和CombineFileInputFormat。    &nbsp;    &nbsp;    &nbsp;    Hadoop 自身提供的几种小文件合并机制    Hadoop ...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/13/weixin_34248487_90122591.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">Hadoop MapReduce编程 API入门系列之小文件合并（二十九）</h1>
    <p class="post-meta">Nov 13, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;&nbsp;Hadoop 自身提供了几种机制来解决相关的问题，包括HAR，SequeueFile和CombineFileInputFormat。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="font-size:18pt;"><strong>Hadoop 自身提供的几种小文件合并机制</strong></span></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong>Hadoop HAR</strong></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;将众多小文件打包成一个大文件进行存储，并且打包后原来的文件仍然可以通过Map-reduce进行操作，打包后的文件由索引和存储两大部分组成</p> 
   <div class="alert alert-success" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    &nbsp; &nbsp; &nbsp; &nbsp; 缺点：一旦创建就不能修改，也不支持追加操作，还不支持文档压缩，当有新文件进来以后，需要重新打包。
   </div> 
   <div class="alert alert-success" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    &nbsp;
   </div> 
   <div class="alert alert-success" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    &nbsp;
   </div> 
   <div class="alert alert-success" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    &nbsp;
   </div> 
   <div class="alert alert-success"> 
    <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong>SequeuesFile</strong></p> 
    <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sequence file由一系列的二进制key/value组成，如果key为小文件名，value为文件内容，则可以将大批小文件合并成一个大文件。</p> 
    <div class="alert alert-success" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
     &nbsp; &nbsp; &nbsp; &nbsp; 优缺点：对小文件的存取都比较自由，也不限制用户和文件的多少，但是该方法不能使用append方法，所以适合一次性写入大量小文件的场景。
    </div> 
    <div class="alert alert-success" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
     &nbsp;
    </div> 
    <div class="alert alert-success" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
     &nbsp;
    </div> 
    <div class="alert alert-success" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
     &nbsp;
    </div> 
    <div class="alert alert-success"> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong>CombineFileInputFormat</strong></p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CombineFileInputFormat是一种新的inputformat，用于将多个文件合并成一个单独的split作为输入，而不是通常使用一个文件作为输入。另外，它会考虑数据的存储位置。</p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><img src="https://images2015.cnblogs.com/blog/855959/201612/855959-20161213202902979-804067871.png" alt="" style="border:0px;"></p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><img src="https://images2015.cnblogs.com/blog/855959/201612/855959-20161213202918729-1600185173.png" alt="" style="border:0px;"></p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong><span style="color:rgb(0,0,255);">&nbsp;&nbsp; &nbsp; 目前很多公司采用的方法就是在数据进入 Hadoop 的 HDFS 系统之前进行合并（也是本博文这方法）</span></strong>，一般效果较上述三种方法明显。</p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;<img src="https://images2015.cnblogs.com/blog/855959/201612/855959-20161213203043558-699170447.png" alt="" style="border:0px;"></p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><img src="https://images2015.cnblogs.com/blog/855959/201612/855959-20161213203233511-1602732184.png" alt="" style="border:0px;"></p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><img src="https://images2015.cnblogs.com/blog/855959/201612/855959-20161213204324901-2010077794.png" alt="" style="border:0px;"></p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><img src="https://images2015.cnblogs.com/blog/855959/201612/855959-20161213204338370-1061928250.png" alt="" style="border:0px;"></p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><img src="https://images2015.cnblogs.com/blog/855959/201612/855959-20161213204736683-170769673.png" alt="" style="border:0px;"></p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="font-size:18pt;"><strong>&nbsp;代码版本1</strong></span></p> 
     <pre><strong><span style="color:rgb(0,0,255);">MergeSmallFilesToHDFS .java</span></strong></pre> 
     <div class="cnblogs_code" style="font-family:'Courier New';font-size:12px;border:1px solid rgb(204,204,204);"> 
      <div class="cnblogs_code_toolbar">
       <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
      </div> 
      <pre><span style="font-size:12px;line-height:1.5;">package zhouls.bigdata.myMapReduce.MergeSmallFiles;

import java.io.IOException;
import java.net.URI;
import java.net.URISyntaxException;
import org.apache.hadoop.conf.Configuration;
import org.apache.hadoop.fs.FSDataInputStream;
import org.apache.hadoop.fs.FSDataOutputStream;
import org.apache.hadoop.fs.FileStatus;
import org.apache.hadoop.fs.FileSystem;
import org.apache.hadoop.fs.FileUtil;
import org.apache.hadoop.fs.Path;
import org.apache.hadoop.fs.PathFilter;
import org.apache.hadoop.io.IOUtils;
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*
* function 合并小文件至 HDFS 
* 
*
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;"> MergeSmallFilesToHDFS {
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> FileSystem fs = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> FileSystem local = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*
* @function main 
* @param args
* @throws IOException
* @throws URISyntaxException
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span><span style="font-size:12px;line-height:1.5;"> main(String[] args) throws IOException,
URISyntaxException {
list();
}

</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*
* 
* @throws IOException
* @throws URISyntaxException
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span><span style="font-size:12px;line-height:1.5;"> list() throws IOException, URISyntaxException {
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 读取hadoop文件系统的配置</span>
Configuration conf = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> Configuration();
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">文件系统访问接口</span>
URI uri = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> URI(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">hdfs://HadoopMaster:9000</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">创建FileSystem对象aa</span>
fs = FileSystem.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">get</span><span style="font-size:12px;line-height:1.5;">(uri, conf);
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 获得本地文件系统</span>
local =<span style="font-size:12px;line-height:1.5;"> FileSystem.getLocal(conf);
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">过滤目录下的 svn 文件</span>
FileStatus[] dirstatus = local.globStatus(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> Path(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">./data/mergeSmallFiles/*</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>),<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> RegexExcludePathFilter(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">^.*svn$</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">));
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">获取73目录下的所有文件路径</span>
Path[] dirs =<span style="font-size:12px;line-height:1.5;"> FileUtil.stat2Paths(dirstatus);
FSDataOutputStream </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">out</span> = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">;
FSDataInputStream </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">in</span> = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span><span style="font-size:12px;line-height:1.5;"> (Path dir : dirs) {
String fileName </span>= dir.getName().replace(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">-</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">""</span>);<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">文件名称
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">只接受日期目录下的.txt文件a</span>
FileStatus[] localStatus = local.globStatus(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> Path(dir+<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>),<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> RegexAcceptPathFilter(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">^.*txt$</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">));
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 获得日期目录下的所有文件</span>
Path[] listedPaths =<span style="font-size:12px;line-height:1.5;"> FileUtil.stat2Paths(localStatus);
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">输出路径</span>
Path block = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> Path(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">hdfs://HadoopMaster:9000/tv/</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>+ fileName + <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">.txt</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 打开输出流</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">out</span> =<span style="font-size:12px;line-height:1.5;"> fs.create(block);    
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span><span style="font-size:12px;line-height:1.5;"> (Path p : listedPaths) {
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">in</span> = local.open(p);<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 打开输入流</span>
IOUtils.copyBytes(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">in</span>, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">out</span>, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">4096</span>, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">false</span>); <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 复制数据
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 关闭输入流</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">in</span><span style="font-size:12px;line-height:1.5;">.close();
}
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">out</span> != <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">) {
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 关闭输出流a</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">out</span><span style="font-size:12px;line-height:1.5;">.close();
}
}

}

</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*
* 
* @function 过滤 regex 格式的文件
*
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;"> RegexExcludePathFilter implements PathFilter {
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span><span style="font-size:12px;line-height:1.5;"> final String regex;

</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span><span style="font-size:12px;line-height:1.5;"> RegexExcludePathFilter(String regex) {
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">this</span>.regex =<span style="font-size:12px;line-height:1.5;"> regex;
}

@Override
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span><span style="font-size:12px;line-height:1.5;"> boolean accept(Path path) {
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> TODO Auto-generated method stub</span>
boolean flag =<span style="font-size:12px;line-height:1.5;"> path.toString().matches(regex);
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> !<span style="font-size:12px;line-height:1.5;">flag;
}

}

</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*
* 
* @function 接受 regex 格式的文件
*
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;"> RegexAcceptPathFilter implements PathFilter {
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span><span style="font-size:12px;line-height:1.5;"> final String regex;

</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span><span style="font-size:12px;line-height:1.5;"> RegexAcceptPathFilter(String regex) {
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">this</span>.regex =<span style="font-size:12px;line-height:1.5;"> regex;
}

@Override
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span><span style="font-size:12px;line-height:1.5;"> boolean accept(Path path) {
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> TODO Auto-generated method stub</span>
boolean flag =<span style="font-size:12px;line-height:1.5;"> path.toString().matches(regex);
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;"> flag;
}

}
}</span></pre> 
      <div class="cnblogs_code_toolbar">
       <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
      </div> 
     </div> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="font-size:18pt;color:rgb(0,0,255);"><strong>&nbsp;代码版本2</strong></span></p> 
     <pre><span style="color:rgb(0,0,255);"><strong>MergeSmallFilesToHDFS .java</strong></span></pre> 
     <div class="cnblogs_code" style="font-family:'Courier New';font-size:12px;border:1px solid rgb(204,204,204);"> 
      <div class="cnblogs_code_toolbar">
       <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
      </div> 
      <pre><span style="font-size:12px;line-height:1.5;">package zhouls.bigdata.myMapReduce.MergeSmallFiles;

import java.io.IOException;
import java.net.URI;
import java.net.URISyntaxException;
import org.apache.hadoop.conf.Configuration;
import org.apache.hadoop.fs.FSDataInputStream;
import org.apache.hadoop.fs.FSDataOutputStream;
import org.apache.hadoop.fs.FileStatus;
import org.apache.hadoop.fs.FileSystem;
import org.apache.hadoop.fs.FileUtil;
import org.apache.hadoop.fs.Path;
import org.apache.hadoop.fs.PathFilter;
import org.apache.hadoop.io.IOUtils;
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*
 * function 合并小文件至 HDFS     ，  文件与块大小（比如128M）来比，小的话，称为小文件。是一个相对概念！相对于数据块而言的！
 * @author 小讲
 *
 </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;"> MergeSmallFilesToHDFS {
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> FileSystem fs = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> FileSystem local = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">;
    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*
     * @function main 
     * @param args
     * @throws IOException
     * @throws URISyntaxException
     </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
    <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span><span style="font-size:12px;line-height:1.5;"> main(String[] args) throws IOException,
            URISyntaxException {
        list();
    }

    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*
     * 
     * @throws IOException
     * @throws URISyntaxException
     </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
    <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span><span style="font-size:12px;line-height:1.5;"> list() throws IOException, URISyntaxException {
        </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 读取hadoop文件系统的配置</span>
        Configuration conf = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> Configuration();
        </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">文件系统访问接口</span>
        URI uri = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> URI(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">hdfs://master:9000</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
        
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">        URL、URI与Path三者的区别
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">        Hadoop文件系统中通过Hadoop Path对象来代表一个文件    
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">        URL（相当于绝对路径）    -&gt;   （文件） -&gt;    URI（相当于相对路径，即代表URL前面的那一部分）
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">        URI：如hdfs:</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">master:9000
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">        如，URL.openStream
        
        
        
        </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">获得FileSystem实例，即HDFS</span>
        fs = FileSystem.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">get</span><span style="font-size:12px;line-height:1.5;">(uri, conf);
            
        
        </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">获得FileSystem实例，即Local</span>
        local =<span style="font-size:12px;line-height:1.5;"> FileSystem.getLocal(conf);
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">            为什么要获取到Local呢，因为，我们要把本地D盘下data/73目录下的文件要合并后，上传到HDFS里，所以，我们需先获取到Local，再来做合并工作啦！
        
        
        </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">过滤目录下的 svn 文件，globStatus从第一个参数通配符合到文件，剔除满足第二个参数到结果，因为PathFilter中accept是return!  </span>
        FileStatus[] dirstatus = local.globStatus(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> Path(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">D://data/73/*</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>),<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> RegexExcludePathFilter(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">^.*svn$</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>));<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">一般这是隐藏文件，所以得排除
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">        ^表示匹配我们字符串开始的位置               *代表0到多个字符                        $代表字符串结束的位置
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">        RegexExcludePathFilter来只排除我们不需要的，即svn格式
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">        RegexExcludePathFilter这个方法我们自己写
        
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">        但是我们，最终是要处理文件里的东西，最终是要转成Path类型，因为Path对象f,它对应着一个文件。
        
        </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">获取73目录下的所有文件路径，注意FIleUtil中stat2Paths()的使用，它将一个FileStatus对象数组转换为Path对象数组。</span>
        Path[] dirs = FileUtil.stat2Paths(dirstatus);<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">dirstatus是FileStatus数组类型</span>
<span style="font-size:12px;line-height:1.5;">        
        
        FSDataOutputStream </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">out</span> = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span>;<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">输出流</span>
        FSDataInputStream <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">in</span> = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span>;<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">输入流
        
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">        很多人搞不清输入流和输出流，！！！！
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">        其实啊，输入流、输出流都是针对内存的
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">        往内存里写，是输入流。
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">        内存往文件里写，是输出Luis。
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span>        
<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">        比如一个文件A复制到另一文件B，那么，先写到内存里，再写到文件B。
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">           =&gt;   则文件A写到内存里，叫输入流。
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">           =&gt;    则内存里写到文件B，叫输出流    </span>
        
        
        <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span> (Path dir : dirs) {<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">for星型循环，即将dirs是Path对象数组，一一传给Path dir</span>
<span style="font-size:12px;line-height:1.5;">            
            String fileName </span>= dir.getName().replace(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">-</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">""</span>);<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">文件名称
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">                        即获取到如2012-09-17，然后经过replace("-", "")，得到20120917
            
            
            </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">只接受日期目录下的.txt文件，^匹配输入字符串的开始位置,$匹配输入字符串的结束位置,*匹配0个或多个字符。</span>
            FileStatus[] localStatus = local.globStatus(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> Path(dir+<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>),<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> RegexAcceptPathFilter(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">^.*txt$</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">));
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">            FileStatus[] localStatus = local.listStatus(new Path(dir+"/*"),new RegexAcceptPathFilter("^.*txt$"));</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">试试，看有什么区别？出现错误的！为什么?

    
                    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">RegexAcceptPathFilter这个方法，我们自己写
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">            RegexAcceptPathFilter来只接收我们需要，即txt格式
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">            这里，我们还可以只接收别的格式，自己去改，一定要锻炼学会改别人的代码
            
            
            </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 获得如2012-09-17日期目录下的所有文件</span>
            Path[] listedPaths =<span style="font-size:12px;line-height:1.5;"> FileUtil.stat2Paths(localStatus);
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">            同样，但是我们，最终是要处理文件里的东西，最终是要转成Path类型，因为Path对象f,它对应着一个文件。
            
            
            
            </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">输出路径</span>
            Path block = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> Path(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">hdfs://master:9000/outData/MergeSmallFilesToHDFS/</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>+ fileName + <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">.txt</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
            
            
            </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 打开输出流</span>
            <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">out</span> = fs.create(block);<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">因为，合并小文件之后，比如这是，合并2012-09-17日期目录下的所有小文件，之后，要上传到HDFS里。
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">                类似于，文件A写到内存里，再内存里写到文件B。而这行代码out = fs.create(block);是相当于是，内存里写到文件B。所以是输出流，即是从内存里输出的，所以叫输出流。
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">                            这里，文件A是Local                文件B是HDFS

</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">                                        文件与块大小（比如128M）来比，小的话，称为小文件。是一个相对概念！相对于数据块而言的！
            
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">            很多人搞不清输入流和输出流，！！！！
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">            其实啊，输入流、输出流都是针对内存的
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">            往内存里写，是输入流。
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">            内存往文件里写，是输出Luis。
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span>            
<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">            比如一个文件A复制到另一文件B，那么，先写到内存里，再写到文件B。
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">               =&gt;   则文件A写到内存里，叫输入流。
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">               =&gt;    则内存里写到文件B，叫输出流    </span>
            
            
            <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span> (Path p : listedPaths) {<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">for星型循环，即将listedPaths的值一一传给Path p</span>
                <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">in</span> = local.open(p);<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 打开输入流in
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">                类似于，文件A写到内存里，再内存里写到文件B。而这行代码in = local.open(p);是相当于是，文件A写到内存里。所以是输如流，即是写到内存里的，所以叫输入流。
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">                    这里，文件A是Local                文件B是HDFS</span>
<span style="font-size:12px;line-height:1.5;">                
                IOUtils.copyBytes(</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">in</span>, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">out</span>, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">4096</span>, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">false</span>); <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 复制数据，IOUtils.copyBytes可以方便地将数据写入到文件，不需要自己去控制缓冲区，也不用自己去循环读取输入源。false表示不自动关闭数据流，那么就手动关闭。
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">                IOUtils.copyBytes这个方法很重要
                                </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">是否自动关闭输入流和输出流，若是false，就要单独去关闭。则不在这个方法体里关闭输入和输出流了。
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">                                                     若是true，则在这个方法里关闭输入和输出流。不需单独去关闭了
                
                
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">                明白，IOUtils类的copyBytes将hdfs数据流拷贝到标准输出流System.out中，
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">                copyBytes前两个参数好理解，一个输入，一个输出，第三个是缓存大小，第四个指定拷贝完毕后是否关闭流。
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">                要设置为false，标准输出流不关闭，我们要手动关闭输入流。即，设置为false表示关闭输入流
                
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">                主要是把最后的这个参数定义好， 就可以了。 定义为true还是false，则决定着是否在这个方法体里关闭
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">                若定义为true,则在这个方法体里直接关闭输入流、输出流。不需单独去关闭了
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">                若定义为false,则不在这个方法体里直接关闭输入流、输出流。需单独去关闭了
                
                
                </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 关闭输入流</span>
                <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">in</span>.close();<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">若定义为false,则不在这个方法体里直接关闭输入流、输出流。需单独去关闭了。这就是单独在关闭输入流！！！懂了吗</span>
<span style="font-size:12px;line-height:1.5;">            }
            </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">out</span> != <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span>) {<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">这里为什么不为空，空指针，则说明里面还有资源。
                </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 关闭输出流</span>
                <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">out</span>.close();<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">若定义为false,则不在这个方法体里直接关闭输入流、输出流。需单独去关闭了。这就是单独在关闭输出流！！！懂了吗</span>
<span style="font-size:12px;line-height:1.5;">            }
        }
        
    }

    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*
     * 
     * @function 过滤 regex 格式的文件
     *
     </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
    <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;"> RegexExcludePathFilter implements PathFilter {
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> final String regex;<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">变量</span>

        <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> RegexExcludePathFilter(String regex) {<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">这个是上面的那个，正在表达式</span>
            <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">this</span>.regex = regex;<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">将String regex的值，赋给RegexExcludePathFilter类里的private final String regex的值</span>
<span style="font-size:12px;line-height:1.5;">        }

        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> boolean accept(Path path) {<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">主要是实现accept方法
            </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> TODO Auto-generated method stub</span>
            boolean flag = path.toString().matches(regex);<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">匹配正则表达式，这里是^.*svn$</span>
            <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> !flag;<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">如果要接收 regex 格式的文件，则accept()方法就return flag; 如果想要过滤掉regex格式的文件，则accept()方法就return !flag。</span>
<span style="font-size:12px;line-height:1.5;">        }

    }

    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*
     * 
     * @function 接受 regex 格式的文件
     *
     </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
    <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;"> RegexAcceptPathFilter implements PathFilter {
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> final String regex;<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">变量</span>

        <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> RegexAcceptPathFilter(String regex) {<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">这个是上面的那个，正在表达式</span>
            <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">this</span>.regex = regex;<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">将String regex的值，赋给RegexAcceptPathFilter类里的private final String regex的值</span>
<span style="font-size:12px;line-height:1.5;">        }

        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> boolean accept(Path path) {<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">主要是实现accept方法
            </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> TODO Auto-generated method stub</span>
            boolean flag = path.toString().matches(regex);<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">匹配正则表达式,这里是^.*txt$</span>
            <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> flag;<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">如果要接收 regex 格式的文件，则accept()方法就return flag; 如果想要过滤掉regex格式的文件，则accept()方法就return !flag。</span>
<span style="font-size:12px;line-height:1.5;">        }

    }
}</span></pre> 
      <div class="cnblogs_code_toolbar">
       <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
      </div> 
     </div> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
     <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
     <p><font><span style="font-size:14px;">本文转自大数据躺过的坑博客园博客，原文链接：http://www.cnblogs.com/zlslch/p/6171460.html，如需转载请自行联系原作者</span></font><br></p> 
    </div> 
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
