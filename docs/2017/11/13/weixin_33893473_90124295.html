<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>理解 OpenStack 高可用（HA）（5）：RabbitMQ HA « NotBeCN</title>
  <meta name="description" content="             本系列会分析OpenStack 的高可用性（HA）概念和解决方案：    （1）OpenStack 高可用方案概述    （2）Neutron L3 Agent HA - VRRP （虚拟路由冗余协议）    （3）Neutron L3 Agent HA - DVR （分布式虚机路由器）...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/13/weixin_33893473_90124295.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">理解 OpenStack 高可用（HA）（5）：RabbitMQ HA</h1>
    <p class="post-meta">Nov 13, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">本系列会分析OpenStack 的高可用性（HA）概念和解决方案：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）<a href="http://www.cnblogs.com/sammyliu/p/4741967.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">OpenStack 高可用方案概述</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）<a href="http://www.cnblogs.com/sammyliu/p/4692081.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">Neutron L3 Agent HA - VRRP （虚拟路由冗余协议）</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（3）<a href="http://www.cnblogs.com/sammyliu/p/4713562.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">Neutron L3 Agent HA - DVR （分布式虚机路由器）</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（4）<a href="http://www.cnblogs.com/sammyliu/p/5025362.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">Pacemaker 和 OpenStack Resource Agent （RA）</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（5）<a href="http://www.cnblogs.com/sammyliu/p/4730517.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">RabbitMQ HA</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（6）<a href="http://www.cnblogs.com/sammyliu/p/4995868.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">MySQL HA</a></p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;"> <span style="line-height:1.5;font-size:1.5em;">1.&nbsp;</span><span style="line-height:1.5;font-size:1.17em;">RabbitMQ 集群</span> </h2> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;">&nbsp; &nbsp; 你可以使用若干个RabbitMQ 节点组成一个 RabbitMQ 集群。集群解决的是扩展性问题。所有的数据和状态都会在集群内所有的节点上被复制，只有queue是例外。默认的情况下，消息只会存在于它被创建的节点上，但是它们在所有节点上可见和可访问。</span></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp; 对于Queue 来说，消息实体只存在于其中一个节点，A、B两个节点仅有相同的元数据，即队列结构。当消息进入A节点的Queue中后，consumer从B节点拉取时，RabbitMQ会临时在A、B间进行消息传输，把A中的消息实体取出并经过B发送给consumer。所以consumer应尽量连接每一个节点，从中取消息。即对于同一个逻辑队列，要在多个节点建立物理Queue。否则无论consumer连A或B，出口总在A，会产生瓶颈。该模式存在一个问题就是当A节点故障后，B节点无法取到A节点中还未消费的消息实体。如果做了消息持久化，那么得等A节点恢复，然后才可被消费；如果没有持久化的话，然后就没有然后了。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;">&nbsp; &nbsp;因此，在集群环境中,队列只有元数据会在集群的所有节点同步，但队列中的数据只会存在于一个节点，数据没有冗余且容易丢，甚至在durable的情况下,如果所在的服务器节点宕机，就要等待节点恢复才能继续提供消息服务。那既然有这种问题，为什么依然有这个选项呢？官方的说法是：</span></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp;（1）存储空间：如果集群的每个节点都有每个queue的一个拷贝，那么增加节点将无法增加存储容量。比如，如果一个节点可以存放 1GB 的消息，增加另外两个节点只会增加另外两个拷贝而已。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; （2）性能：发布消息，将会将它拷贝其它节点上。如果是持久性消息，那么每个节点上都会触发磁盘操作。你的网络和磁盘负载在每次增加节点时都会增加。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;">&nbsp; 可见，RabbitMQ Clustering 技术不能完全解决HA 问题。单纯的集群只适合于在不需要HA的场景中使用。</span></p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;"><span style="line-height:1.5;">2. Active/Passive HA 方案</span></h2> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;font-size:14px;">&nbsp; &nbsp; RabbitMQ A/P HA&nbsp;</span><a href="https://www.rabbitmq.com/pacemaker.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;font-size:14px;line-height:1.5;">官方方案</a><span style="line-height:1.5;font-size:14px;">&nbsp;是采用 Pacemaker + （DRBD 或者其它可靠的共享 NAS/SNA 存储） +&nbsp;（CoroSync 或者&nbsp;Heartbeat 或者 OpenAIS）组合来实现的。需要注意的是&nbsp;CoroSync 需要使用多播，而多播在某些云环境中是被禁用的，这时候可以改为使用 Heartbeat，它采用单播。其架构为：</span></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://www.rabbitmq.com/img/pacemaker.png" alt="" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">实现 HA 的原理：</p> 
   <ol style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;"> <span style="line-height:1.5;font-size:14px;">RabbitMQ 将数据库文件和</span><span style="line-height:1.5;font-size:14px;">持久性消息</span><span style="line-height:1.5;font-size:14px;">保存在 DRBD 挂载点上。注意，</span><span style="line-height:1.5;font-size:14px;">在 failover 时，非持久性消息会丢失。</span> </li> 
    <li style="list-style-type:decimal;">DRBD 要求在某一时刻，只能有一个 node （primary）能够访问其共享存储，因此，不会有多个node 同时写一块数据的风险。这要求必须依赖 Pacemaker 来控制使用 DRBD 共享存储的 node。Pacemaker 使得在某一时刻，只有 active node 来访问 DRBD 共享存储。在 failover 时，Pacemaker 会卸载当前 active node 上的 DRBD 共享存储，并在新的 active node （原 secondary node）上挂载 DRBD 共享存储。</li> 
    <li style="list-style-type:decimal;">在 node 启动时，不会自动启动 RabbitMQ。Pacemaker 会在 active node 启动 RabbitMQ。</li> 
    <li style="list-style-type:decimal;">RabbitMQ HA 只会提供一个访问 RabbitMQ 的 虚拟IP 地址。该方案依赖 Pacemaker 来保证 VIP 的切换。</li> 
   </ol>
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.1 基于&nbsp;Pacemaker&nbsp;+ DRBD + CoroSync 的 RabbitMQ HA 方案配置</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp; RabbitMQ 官方的&nbsp;<a href="https://www.rabbitmq.com/pacemaker.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这篇文章</a>介绍了基于 Pacemaker 的 RabbitMQ HA 方案。它同时指出，这是传统的 RabbitMQ HA 方案，并且建议使用 RabbitMQ 集群 + 镜像 Message Queue 的方式来实现 A/A HA。使用 Pacemaker 实现 HA 的方案主要步骤包括：</p> 
   <div class="itemizedlist" style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <ol>
     <li class="listitem" style="list-style-type:decimal;"> <p style="line-height:1.5;">为 RabbitMQ 配置一个 DRBD 设备</p> </li> 
     <li class="listitem" style="list-style-type:decimal;"> <p style="line-height:1.5;">配置 RabbitMQ 使用建立在 DRBD 设备之上的数据目录</p> </li> 
     <li class="listitem" style="list-style-type:decimal;"> <p style="line-height:1.5;">选择并绑定一个可以在各集群节点之间迁移的虚拟 IP 地址 （即 VIP ）</p> </li> 
     <li class="listitem" style="list-style-type:decimal;"> <p style="line-height:1.5;">配置 RabbitMQ 监听该 IP 地址</p> </li> 
     <li class="listitem" style="list-style-type:decimal;"> <p style="line-height:1.5;">使用 Pacemaker 管理上述所有资源，包括 RabbitMQ 守护进程本身</p> </li> 
    </ol>
    <h4 style="font-size:14px;">2.1.1 安装 Corosync 和 Pacemaker</h4> 
    <p style="line-height:1.5;">本配置使用两个节点。</p> 
    <p style="line-height:1.5;">首先，在两个节点上安装软件包：apt-get install pacemaker crmsh corosync cluster-glue resource-agents，并配置&nbsp;Corosync，设它为 boot 自启动：vi&nbsp;/etc/default/corosync，START=yes。</p> 
    <p style="line-height:1.5;">两个节点上，</p> 
    <p style="line-height:1.5;">（1）修改配置文件：vim /etc/corosync/corosync.conf</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre><span style="line-height:1.5;">totem {
        #...
        </span><span style="color:rgb(0,0,255);line-height:1.5;">interface</span><span style="line-height:1.5;"> {
                ringnumber: </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">
                bindnetaddr: <span style="color:rgb(0,0,255);line-height:1.5;">#节点1上，192.168.1.15；节点2上，</span></span><span style="color:rgb(0,0,255);line-height:1.5;">192.168.1.32</span><span style="line-height:1.5;">
                broadcast: yes
                mcastport: </span><span style="color:rgb(128,0,128);line-height:1.5;">5405</span><span style="line-height:1.5;">
        }
        transport: udpu
}
 
nodelist {
        node {
                ring0_addr: </span><span style="color:rgb(128,0,128);line-height:1.5;">192.168</span>.<span style="color:rgb(128,0,128);line-height:1.5;">1.15</span><span style="line-height:1.5;">
                nodeid: </span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">
        }
        node {
                ring0_addr: </span><span style="color:rgb(128,0,128);line-height:1.5;">192.168</span>.<span style="color:rgb(128,0,128);line-height:1.5;">1.32</span><span style="line-height:1.5;">
                nodeid: </span><span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">
        }
}</span></pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="line-height:1.5;"><span style="line-height:1.5;font-size:14px;">（2）启动服务&nbsp;service corosync start</span></p> 
    <p style="line-height:1.5;">（3）查看状态</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre><span style="line-height:1.5;">root@compute2:/home/s1# corosync-cfgtool -s</span></pre> 
     <p style="line-height:1.5;">Printing ring status.<br> Local node ID 2<br> RING ID 0<br> id = 192.168.1.32<br> status = ring 0 active with no faults</p> 
     <p style="line-height:1.5;">root@compute2:/home/s1# corosync-cmapctl runtime.totem.pg.mrp.srp.members&nbsp;<span style="color:rgb(0,0,255);line-height:1.5;">#需要确保两个节点都加入了组</span><br> runtime.totem.pg.mrp.srp.members.1.config_version (u64) = 0<br> runtime.totem.pg.mrp.srp.members.1.ip (str) = r(0) ip(192.168.1.15)<br> runtime.totem.pg.mrp.srp.members.1.join_count (u32) = 1<br> runtime.totem.pg.mrp.srp.members.1.status (str) = joined<br> runtime.totem.pg.mrp.srp.members.2.config_version (u64) = 0<br> runtime.totem.pg.mrp.srp.members.2.ip (str) = r(0) ip(192.168.1.32)<br> runtime.totem.pg.mrp.srp.members.2.join_count (u32) = 1<br> runtime.totem.pg.mrp.srp.members.2.status (str) = joined</p> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="line-height:1.5;">（4）启动 pacemaker：service pacemaker start</p> 
    <p style="line-height:1.5;">（5）查看 pacemaker 状态：crm_mon</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre>Last updated: Sun Aug <span style="color:rgb(128,0,128);line-height:1.5;">16</span> <span style="color:rgb(128,0,128);line-height:1.5;">15</span>:<span style="color:rgb(128,0,128);line-height:1.5;">59</span>:<span style="color:rgb(128,0,128);line-height:1.5;">10</span> <span style="color:rgb(128,0,128);line-height:1.5;">2015</span><span style="line-height:1.5;">
Last change: Sun Aug </span><span style="color:rgb(128,0,128);line-height:1.5;">16</span> <span style="color:rgb(128,0,128);line-height:1.5;">15</span>:<span style="color:rgb(128,0,128);line-height:1.5;">58</span>:<span style="color:rgb(128,0,128);line-height:1.5;">59</span> <span style="color:rgb(128,0,128);line-height:1.5;">2015</span><span style="line-height:1.5;"> via crmd on compute1
Stack: corosync
Current DC: compute1 (</span><span style="color:rgb(128,0,128);line-height:1.5;">1</span>) -<span style="line-height:1.5;"> partition with quorum
Version: </span><span style="color:rgb(128,0,128);line-height:1.5;">1.1</span>.<span style="color:rgb(128,0,128);line-height:1.5;">10</span>-<span style="line-height:1.5;">42f2063
</span><span style="color:rgb(128,0,128);line-height:1.5;">3</span><span style="line-height:1.5;"> Nodes configured
</span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;"> Resources configured

Node compute1 (</span><span style="color:rgb(128,0,128);line-height:1.5;">1084752143</span><span style="line-height:1.5;">): UNCLEAN (offline)
Online: [ compute1 compute2 ]</span></pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="line-height:1.5;">（6）配置 pacemaker</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre>root@compute2:/home/<span style="line-height:1.5;">s1# crm
crm(live)# configure
crm(live)configure# property no</span>-quorum-policy=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ignore</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> \ <span style="color:rgb(0,0,255);line-height:1.5;">#因为这里只有两个节点，因此需要设置为 ‘ignore’。两个节点以上，不可以设置为 ‘ignore’ </span></span>&gt;   pe-warn-series-max=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">1000</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> \
</span>&gt;   pe-input-series-max=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">1000</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> \
</span>&gt;   pe-error-series-max=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">1000</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> \
</span>&gt;   cluster-recheck-interval=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">2min</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">
crm(live)configure# quit
There are changes pending. Do you want to commit them</span>?<span style="line-height:1.5;"> yes
bye</span></pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <h4 style="font-size:14px;">2.1.2 为 RabbitMQ 配置一个 DRBD 设备</h4> 
    <p style="line-height:1.5;">&nbsp;在 node1 和 node2 上，依次进行：</p> 
    <p style="line-height:1.5;">（0）安装 DRBD，并设置机器启动时 DRBD 服务不自动启动。该服务的启停升降级等都需要由 Pacemaker 控制。</p> 
    <p style="line-height:1.5;">（1）添加一个 1G 的 hard disk，fdiskl -l 可见 /dev/sdb</p> 
    <p style="line-height:1.5;">（2）创建 LVM：pvcreate /dev/sdb，vgcreate vg_rabbit /dev/sdb，lvcreate -L1000 -n rabbit vg_rabbit。创建好的 LVM 为&nbsp;/dev/mapper/vg_rabbit-rabbit。</p> 
    <p style="line-height:1.5;">（3）定义 rabbitmq 资源：vi /etc/drbd.d/rabbitmq.res</p> 
    <p style="line-height:1.5;">根据&nbsp;/etc/drbd.conf，资源的配置文件需要放置在&nbsp;/etc/drbd.d/ 目录中，并以 res 为文件类型。DRBD 会自动读取这些配置文件并创建相应的资源。</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre><span style="line-height:1.5;">rource rabbitmq {
  device    minor </span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">;               <span style="color:rgb(0,0,255);line-height:1.5;"># DRBD device 是 /dev/drbd1，相当于 device /dev/drbd1</span>
  disk      </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">/dev/mapper/vg_rabbit-rabbit</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">; <span style="color:rgb(0,0,255);line-height:1.5;"># Raw device, 本例中是 LVM path。也可以使用不同名字的 Raw device，这样的话需要放到 host 定义部分。</span>
  meta</span>-disk <span style="line-height:1.5;">internal</span><span style="line-height:1.5;">;               <span style="color:rgb(0,0,255);line-height:1.5;"># 这是默认值，更多信息可以参考<a href="http://www.drbd.org/users-guide-emb/ch-internals.html#s-metadata" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;"><span style="color:rgb(0,0,255);line-height:1.5;">这个</span></a></span>
  on compute1 {                     <span style="color:rgb(0,0,255);line-height:1.5;"># 节点1，名称需要与 uname -n 的输出相同。</span>
    address ipv4 </span><span style="color:rgb(128,0,128);line-height:1.5;">192.168</span>.<span style="color:rgb(128,0,128);line-height:1.5;">1.15</span>:<span style="color:rgb(128,0,128);line-height:1.5;">7701</span><span style="line-height:1.5;">; <span style="color:rgb(0,0,255);line-height:1.5;">#7701 是 DRBD 通信的 TCP 端口，需要确保该端口可以被访问</span>
  }
  on compute2 {                     <span style="color:rgb(0,0,255);line-height:1.5;"># 节点2</span>
    address ipv4 </span><span style="color:rgb(128,0,128);line-height:1.5;">192.168</span>.<span style="color:rgb(128,0,128);line-height:1.5;">1.32</span>:<span style="color:rgb(128,0,128);line-height:1.5;">7701</span><span style="line-height:1.5;">;
  }
}</span></pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="line-height:1.5;">&nbsp;（4）drbdadm create-md rabbitmq</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
     <pre>root@compute2:/home/s1# drbdadm create-<span style="line-height:1.5;">md rabbitmq
Writing meta data...
initializing activity log
NOT initializing bitmap
New drbd meta data block successfully created.</span></pre>
    </div> 
    <pre class="screen">（5）drbdadm up rabbitmq<br><br>
在 compute 2 上，<br>
（1）drbdadm -- --force primary rabbitmq<br>
（2）mkfs -t xfs /dev/drbd1 （如果提示 mkfs.xsf 找不到，则 sudo apt-get install xfsprogs）</pre> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre>meta-data=/dev/drbd1             isize=<span style="color:rgb(128,0,128);line-height:1.5;">256</span>    agcount=<span style="color:rgb(128,0,128);line-height:1.5;">4</span>, agsize=<span style="color:rgb(128,0,128);line-height:1.5;">63996</span><span style="line-height:1.5;"> blks
         </span>=                       sectsz=<span style="color:rgb(128,0,128);line-height:1.5;">512</span>   attr=<span style="color:rgb(128,0,128);line-height:1.5;">2</span>, projid32bit=<span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">
data     </span>=                       bsize=<span style="color:rgb(128,0,128);line-height:1.5;">4096</span>   blocks=<span style="color:rgb(128,0,128);line-height:1.5;">255983</span>, imaxpct=<span style="color:rgb(128,0,128);line-height:1.5;">25</span>
         =                       sunit=<span style="color:rgb(128,0,128);line-height:1.5;">0</span>      swidth=<span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;"> blks
naming   </span>=version <span style="color:rgb(128,0,128);line-height:1.5;">2</span>              bsize=<span style="color:rgb(128,0,128);line-height:1.5;">4096</span>   ascii-ci=<span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">
log      </span>=<span style="color:rgb(0,0,255);line-height:1.5;">internal</span> log           bsize=<span style="color:rgb(128,0,128);line-height:1.5;">4096</span>   blocks=<span style="color:rgb(128,0,128);line-height:1.5;">1200</span>, version=<span style="color:rgb(128,0,128);line-height:1.5;">2</span>
         =                       sectsz=<span style="color:rgb(128,0,128);line-height:1.5;">512</span>   sunit=<span style="color:rgb(128,0,128);line-height:1.5;">0</span> blks, lazy-count=<span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">
realtime </span>=none                   extsz=<span style="color:rgb(128,0,128);line-height:1.5;">4096</span>   blocks=<span style="color:rgb(128,0,128);line-height:1.5;">0</span>, rtextents=<span style="color:rgb(128,0,128);line-height:1.5;">0</span></pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="line-height:1.5;">（3）mount /dev/drbd1 /var/lib/rabbitmq</p> 
    <p style="line-height:1.5;">（4）umount /var/lib/rabbitmq</p> 
    <p style="line-height:1.5;">（3）drbdadm secondary rabbitmq</p> 
    <p style="line-height:1.5;">在 compute 1 上：</p> 
    <ol>
     <li style="list-style-type:decimal;"><span style="line-height:1.5;font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">drbdadm -- --force primary rabbitmq</span></li> 
     <li style="list-style-type:decimal;"><span style="line-height:1.5;font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">mkfs -t xfs /dev/drbd1</span></li> 
     <li style="list-style-type:decimal;"><span style="line-height:1.5;font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">mount /dev/drbd1 /var/lib/rabbitmq</span></li> 
    </ol>
    <p style="line-height:1.5;">至此，DRBD 设置完成，目前 compute 1 上的 DRBD 是主，compute 2 上的是备。查看其状态：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre>root@compute1:/home/s1# /etc/init.d/<span style="line-height:1.5;">drbd status
drbd driver loaded OK; device status:
version: </span><span style="color:rgb(128,0,128);line-height:1.5;">8.4</span>.<span style="color:rgb(128,0,128);line-height:1.5;">3</span> (api:<span style="color:rgb(128,0,128);line-height:1.5;">1</span>/proto:<span style="color:rgb(128,0,128);line-height:1.5;">86</span>-<span style="color:rgb(128,0,128);line-height:1.5;">101</span><span style="line-height:1.5;">)
srcversion: 6551AD2C98F533733BE558C
m:res       cs         ro                 ds                 p  mounted            fstype
</span><span style="color:rgb(128,0,128);line-height:1.5;">1</span>:rabbitmq  Connected  Primary/Secondary  UpToDate/UpToDate  C  /<span style="line-height:1.5;">var</span>/lib/<span style="line-height:1.5;">rabbitmq  xfs

root@compute2:</span>/home/s1# /etc/init.d/<span style="line-height:1.5;">drbd status
drbd driver loaded OK; device status:
version: </span><span style="color:rgb(128,0,128);line-height:1.5;">8.4</span>.<span style="color:rgb(128,0,128);line-height:1.5;">3</span> (api:<span style="color:rgb(128,0,128);line-height:1.5;">1</span>/proto:<span style="color:rgb(128,0,128);line-height:1.5;">86</span>-<span style="color:rgb(128,0,128);line-height:1.5;">101</span><span style="line-height:1.5;">)
srcversion: 6551AD2C98F533733BE558C
m:res       cs         ro                 ds                 p  mounted  fstype
</span><span style="color:rgb(128,0,128);line-height:1.5;">1</span>:rabbitmq  Connected  Secondary/Primary  UpToDate/UpToDate  C</pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="line-height:1.5;">调试时遇到一个脑裂问题，就是两个node上 drbd 的状态都是 StandAlone，然后 DRBD 服务在 compute 2 上能起来，在 compute 1 上起不来。</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre>root@compute1:/home/s1# /etc/init.d/<span style="line-height:1.5;">drbd status
drbd driver loaded OK; device status:
version: </span><span style="color:rgb(128,0,128);line-height:1.5;">8.4</span>.<span style="color:rgb(128,0,128);line-height:1.5;">3</span> (api:<span style="color:rgb(128,0,128);line-height:1.5;">1</span>/proto:<span style="color:rgb(128,0,128);line-height:1.5;">86</span>-<span style="color:rgb(128,0,128);line-height:1.5;">101</span><span style="line-height:1.5;">)
srcversion: 6551AD2C98F533733BE558C
m:res       cs          ro                 ds                 p       mounted  fstype
</span><span style="color:rgb(128,0,128);line-height:1.5;">1</span>:rabbitmq  StandAlone  Secondary/Unknown  UpToDate/DUnknown  r-----<span style="line-height:1.5;">

DRBD</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">s startup script waits for the peer node(s) to appear.</span>
 - In <span style="color:rgb(0,0,255);line-height:1.5;">case</span> <span style="color:rgb(0,0,255);line-height:1.5;">this</span><span style="line-height:1.5;"> node was already a degraded cluster before the
   reboot the timeout </span><span style="color:rgb(0,0,255);line-height:1.5;">is</span> <span style="color:rgb(128,0,128);line-height:1.5;">0</span> seconds. [degr-wfc-<span style="line-height:1.5;">timeout]
 </span>-<span style="line-height:1.5;"> If the peer was available before the reboot the timeout will
   expire after </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span> seconds. [wfc-<span style="line-height:1.5;">timeout]
   (These values are </span><span style="color:rgb(0,0,255);line-height:1.5;">for</span> resource <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">rabbitmq</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>; <span style="color:rgb(128,0,128);line-height:1.5;">0</span> sec -&gt;<span style="line-height:1.5;"> wait forever)
 To abort waiting enter </span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">yes</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> [ <span style="color:rgb(128,0,128);line-height:1.5;">148</span>]:</pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="line-height:1.5;"><a href="http://www.gossamer-threads.com/lists/drbd/users/13667" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这篇文章</a>&nbsp;和&nbsp;<a href="https://drbd.linbit.com/users-guide/s-resolve-split-brain.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这篇文章</a>&nbsp;给出了这个问题的解决办法：</p> 
    <ul style="list-style:none;font-size:12px;">
     <li style="list-style-type:disc;">在起不来 DRBD 服务的节点（compute1）上，运行&nbsp;<span style="line-height:1.5;font-family:'Courier New';">drbdadm disconnect rabbitmq，</span>drbdadm secondary rabbitmq，和&nbsp;drbdadm --discard-my-data connect rabbitmq</li> 
     <li style="list-style-type:disc;">在能起来 DRBD 服务的节点（compute2）上，运行&nbsp;drbdadm connect rabbitmq</li> 
     <li style="list-style-type:disc;">然后 DRBD 状态恢复成 Connected 了。</li> 
    </ul>
    <p style="line-height:1.5;">SUSE 有关于 DRBD 安装、配置和测试的&nbsp;<a href="https://www.suse.com/documentation/sle_ha/book_sleha/data/sec_ha_drbd_test.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">不错的文档</a>&nbsp;。</p> 
    <h4 style="font-size:14px;">2.1.3 安装和配置 RabbitMQ</h4> 
    <p style="line-height:1.5;">（1）在两个节点上安装 RabbitMQ。rabbitmq-server 进程会在 rabbitmq 组内的 rabbitmq 用户下运行。</p> 
    <p style="line-height:1.5;">（2）确保 rabbitmq 组和用户在两个节点上具有相同的 ID。运行&nbsp;cat /etc/passwd | grep rabbitmq 和&nbsp;cat /etc/group | grep rabbitmq 查看 ID，必要时进行修改。</p> 
    <p style="line-height:1.5;">（3）确保 rabbitmq 用户对 /var/lib/rabbitmq/&nbsp;有读写权限。 运行 chmod a+w&nbsp;/var/lib/rabbitmq/。</p> 
    <p style="line-height:1.5;">（4）确保各节点都使用相同的 Erlang cookie。需要将 compute 1 上的 RabbitMQ cookie 拷贝到 compute 2 上：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
     <pre>（1）compute 1：scp /var/lib/rabbitmq/.erlang.cookie s1@compute2:/home/<span style="line-height:1.5;">s1<br>
（2）compute 2：mv .erlang.cookie /var/lib/rabbitmq/<br>
（3）</span>compute 2：chown rabbitmq: /var/lib/rabbitmq/.erlang.cookie<br>
（4）compute 2：chmod 400 /var/lib/rabbitmq/.erlang.cookie<br>
（5）再执行相同的步骤，将该文件拷贝到 DRBD 共享存储文件系统中</pre>
    </div> 
    <p style="line-height:1.5;">（5）确保计算机启动时不自动启动 rabbitmq。修改&nbsp;/etc/init.d/rabbitmq-server 文件，在文件头注释后面添加 exit 0.</p> 
    <h4 style="font-size:14px;">2.1.4 在 Pacemaker 中添加 RabbitMQ 资源</h4> 
    <p style="line-height:1.5;">在添加前，<span style="line-height:1.5;font-size:14px;">在 compute 1 节点上，运行 crm configure，输入：</span></p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre><span style="line-height:1.5;">primitive <span style="color:rgb(0,0,255);line-height:1.5;">p_ip_rabbitmq</span> ocf:heartbeat:IPaddr2 \  <span style="color:rgb(0,0,255);line-height:1.5;">#定义访问 RabbitMQ 的 VIP。使用 RA ocf:heartbeat:IPaddr2。对该 VIP 的监控间隔为 10s。 </span></span><span style="line-height:1.5;">params </span>ip=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">192.168.1.222</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> cidr_netmask=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">24</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> \
  op monitor interval</span>=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">10s</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">
primitive <span style="color:rgb(0,0,255);line-height:1.5;">p_drbd_rabbitmq</span> ocf:linbit:drbd \ <span style="color:rgb(0,0,255);line-height:1.5;">#定义RabbitMQ 的 DRBD 资源，pacemaker 会对它 start，stop，promote，demote 和 monitor。 </span></span><span style="line-height:1.5;">params </span>drbd_resource=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">rabbitmq</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> \
  op start timeout</span>=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">90s</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> \ <span style="color:rgb(0,0,255);line-height:1.5;">#启动的超时时间</span>
  op stop timeout</span>=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">180s</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> \
  op promote timeout</span>=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">180s</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> \
  op demote timeout</span>=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">180s</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> \
  op monitor interval</span>=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">30s</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> role=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Slave</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> \ <span style="color:rgb(0,0,255);line-height:1.5;">#对 Slave drbd 的监控间隔定义为 30s</span>
  op monitor interval</span>=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">29s</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> role=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Master</span><span style="color:rgb(128,0,0);line-height:1.5;">"  <span style="color:rgb(0,0,255);line-height:1.5;">#对 master drbd 的监控间隔定义为 29s</span></span><span style="line-height:1.5;">
primitive <span style="color:rgb(0,0,255);line-height:1.5;">p_fs_rabbitmq</span> ocf:heartbeat:Filesystem \ <span style="color:rgb(0,0,255);line-height:1.5;"># 在 /dev/drbd1 上创建 xfs 文件系统，并 mount 到 /var/lib/rabbitmq </span></span><span style="line-height:1.5;">params </span>device=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">/dev/drbd1</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> directory</span>=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">/var/lib/rabbitmq</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> fstype</span>=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">xfs</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> options=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">relatime</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> \
  op start timeout</span>=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">60s</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> op stop timeout</span>=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">180s</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> op monitor interval</span>=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">60s</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> timeout=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">60s</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">
primitive <span style="color:rgb(0,0,255);line-height:1.5;">p_rabbitmq</span> ocf:rabbitmq:rabbitmq</span>-<span style="line-height:1.5;">server \ <span style="color:rgb(0,0,255);line-height:1.5;">#定义 RabbitMQ 资源 </span></span><span style="line-height:1.5;">params </span>nodename=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">rabbit@localhost</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> \
    mnesia_base</span>=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">/var/lib/rabbitmq</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> \
  op monitor interval</span>=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">20s</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> timeout=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">10s</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;"> group g_rabbitmq</span> p_ip_rabbitmq p_fs_rabbitmq p_rabbitmq <span style="color:rgb(0,0,255);line-height:1.5;">#group 指定一组资源需要在同一个node上 ip -&gt; fs -&gt; rabbitmq，顺序启动，逆序停止</span>
<span style="color:rgb(0,0,255);line-height:1.5;">ms ms_drbd_rabbitmq</span> p_drbd_rabbitmq meta notify</span>=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">true</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> master-max=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">1</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> clone-max=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">2</span><span style="color:rgb(128,0,0);line-height:1.5;">" <span style="color:rgb(0,0,255);line-height:1.5;"># 定义一个资源集合，往往用于 master-slave 资源集群。其中，clone-max 定义集合内的 drbd 节点数目，master-max 指定 master 最多只能有一个；notify = “true” 表示启用notification。</span></span><span style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;"> colocation c_rabbitmq_on_drbd</span> inf: g_rabbitmq ms_drbd_rabbitmq:Master <span style="color:rgb(0,0,255);line-height:1.5;">#colocation 定义在同一个节点上启动的资源。这里定义了一个约束，rabbitmq 只能在 DRBD Master 节点上启动</span>
<span style="color:rgb(0,0,255);line-height:1.5;">order o_drbd_before_rabbitmq</span> inf: ms_drbd_rabbitmq:promote g_rabbitmq:start<span style="color:rgb(0,0,255);line-height:1.5;"> #oder 指定服务启动顺序。这个定义要求先 DRBD 升级为 Master 然后依次执行 ip，fs 和 rabbitmq 启动。</span></span></pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="line-height:1.5;">更多的 Pacemaker 配置细节，请参考&nbsp;<a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1/html-single/Pacemaker_Explained" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这个文档</a>。</p> 
    <p style="line-height:1.5;">Pacemaker 一些有用的命令：</p> 
    <ul style="list-style:none;font-size:12px;">
     <li style="list-style-type:disc;">crm status：显示集群状态</li> 
     <li style="list-style-type:disc;">crm configure show：显示集群配置</li> 
     <li style="list-style-type:disc;">crm configure edit：修改集群配置</li> 
     <li style="list-style-type:disc;">crm node standby：将当前节点设为备节点</li> 
     <li style="list-style-type:disc;">crm node online：将当前节点设为主节点</li> 
     <li style="list-style-type:disc;">crm ra meta ocf:heartbeat:IPaddr2：查看 RA 的 metadata<span style="line-height:1.5;">&nbsp;</span> </li> 
    </ul>
    <p style="line-height:1.5;">配置完成后，RabbitMQ 起不来。一堆问题，挨个来说：</p> 
    <p style="line-height:1.5;">（1）Corosync 调试：设置日志文件</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre><span style="line-height:1.5;">logging {
        fileline: off
        to_stderr: yes
        to_logfile: yes
        to_syslog: yes
        logfile: </span>/<span style="line-height:1.5;">var</span>/log/cluster/<span style="line-height:1.5;">corosync.log
        syslog_facility: daemon
        debug: off
        timestamp: on        
        }</span></pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="line-height:1.5;">（2）pacemaker 调试：pacemaker 的日志在 corosync 的 log file 中。</p> 
    <p style="line-height:1.5;">（3）运行 crm status，如果出现 &nbsp;Could not establish cib_ro connection: Connection refused (111) ，原因是 pacemaker 服务没有启动。运行 service pacemaker start 即可。</p> 
    <p style="line-height:1.5;">（4）rabbitmq 启动的错误日志可以在&nbsp;/var/log/rabbitmq 目录下找到。可能的错误之一是，rabbit 用户没有目录 /var/lib/rabbitmq 的写权限。</p> 
    <p style="line-height:1.5;">成功后，是这样的效果：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre>root@compute2:/<span style="color:rgb(0,0,255);line-height:1.5;">var</span>/lib/rabbitmq/<span style="line-height:1.5;">rabbit@localhost# crm status
Last updated: Mon Aug </span><span style="color:rgb(128,0,128);line-height:1.5;">17</span> <span style="color:rgb(128,0,128);line-height:1.5;">00</span>:<span style="color:rgb(128,0,128);line-height:1.5;">16</span>:<span style="color:rgb(128,0,128);line-height:1.5;">11</span> <span style="color:rgb(128,0,128);line-height:1.5;">2015</span><span style="line-height:1.5;">
Last change: Sun Aug </span><span style="color:rgb(128,0,128);line-height:1.5;">16</span> <span style="color:rgb(128,0,128);line-height:1.5;">22</span>:<span style="color:rgb(128,0,128);line-height:1.5;">54</span>:<span style="color:rgb(128,0,128);line-height:1.5;">27</span> <span style="color:rgb(128,0,128);line-height:1.5;">2015</span><span style="line-height:1.5;"> via cibadmin on compute1
Stack: corosync
Current DC: compute1 (</span><span style="color:rgb(128,0,128);line-height:1.5;">1</span>) -<span style="line-height:1.5;"> partition with quorum
Version: </span><span style="color:rgb(128,0,128);line-height:1.5;">1.1</span>.<span style="color:rgb(128,0,128);line-height:1.5;">10</span>-<span style="line-height:1.5;">42f2063
</span><span style="color:rgb(128,0,128);line-height:1.5;">3</span><span style="line-height:1.5;"> Nodes configured
</span><span style="color:rgb(128,0,128);line-height:1.5;">5</span><span style="line-height:1.5;"> Resources configured

Online: [ compute1 compute2 ] <span style="color:rgb(0,0,255);line-height:1.5;"># pacemaker 集群中有两个节点</span>
OFFLINE: [ compute1 ]         <span style="color:rgb(0,0,255);line-height:1.5;"># compute 1 是备节点</span>

 Resource Group: g_rabbitmq
     p_ip_rabbitmq      (ocf::heartbeat:IPaddr2):       Started compute2 <span style="color:rgb(0,0,255);line-height:1.5;">#在 compute 2 上启动 VIP，成功</span>
     p_rabbitmq (ocf::rabbitmq:rabbitmq</span>-<span style="line-height:1.5;">server):        Started compute2 <span style="color:rgb(0,0,255);line-height:1.5;">#在 compute 2 上启动 rabbitmq，成功</span>
 Master</span>/<span style="line-height:1.5;">Slave Set: ms_drbd_rabbitmq [p_drbd_rabbitmq]
     Masters: [ compute2 ]
     Slaves: [ compute1 ]
 p_fs_rabbitmq  (ocf::heartbeat:Filesystem):    Started compute2 <span style="color:rgb(0,0,255);line-height:1.5;"># 在 compute 2 上设置 drbd 文件系统，成功</span></span></pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="line-height:1.5;">可见，根据配置，pacemaker 会（1）根据 corosync 确定集群中的节点和状态 （2）启动 VIP （3）启动指定的服务 （4）设置 DRBD 文件系统。每一步都可能失败，失败则需要调试。</p> 
    <p style="line-height:1.5;">（5）将主节点停机，rabbitmq 服务顺利地被切换到备节点上。</p> 
   </div> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;"> <span style="line-height:1.5;font-size:1.17em;">2. 基于集群+镜像队列的A/A 方案</span>&nbsp;</h2> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp; 从 3.6.0 版本开始，RabbitMQ&nbsp;支持镜像队列功能，官方文档在<a href="http://www.rabbitmq.com/clustering.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这里</a>。。与普通集群相比，其实质和普通模式不同之处在于，消息实体会主动在镜像节点间同步，而不是在 consumer 取数据时临时拉取。该模式带来的副作用也很明显，除了降低系统性能外，如果镜像队列数量过多，加之大量的消息进入，集群内部的网络带宽将会被这种同步通讯大大消耗掉。所以在对可靠性要求较高的场合中适用。&nbsp;</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp; Mirrorred queue 是 RabbitMQ 高可用的一种方案，相对于普通的集群方案来讲，queue中的消息每个节点都会存在一份 copy,&nbsp;这个在单个节点失效的情况下，整个集群仍旧可以提供服务。但是由于数据需要在多个节点复制，在增加可用性的同时，系统的吞吐量会有所下降。&nbsp;</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp; 选举机制：mirror queue 内部实现了一套选举算法，有一个 master 和多个slave，queue 中的消息以 master 为主。镜像队列有主从之分，一个主节点(master)，0个或多个从节点(slave)。当master宕掉后，会在 slave 中选举新的master，其选举算法为最早启动的节点。&nbsp;若master节点失效，则 mirror queue 会自动选举出一个节点（slave中消息队列最长者）作为master，作为消息消费的基准参考;&nbsp;在这种情况下可能存在ack消息未同步到所有节点的情况(默认异步)，若 slave 节点失效，mirror queue 集群中其他节点的状态无需改变。所以，看起来可以使用两节点的镜像队列集群。&nbsp;</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp; 使用：对于publish，可以选择任意一个节点进行连接，rabbitmq内部若该节点不是master，则转发给master，master向其他slave节点发送该消息，后进行消息本地化处理，并组播复制消息到其他节点存储；对于consumer，可以选择任意一个节点进行连接，消费的请求会转发给master,为保证消息的可靠性，consumer需要进行ack确认，master收到ack后，才会删除消息，ack消息会同步(默认异步)到其他各个节点，进行slave节点删除消息。 &nbsp;&nbsp;</p> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    &nbsp; &nbsp;考虑到性能问题，复制可以在可控范围内进行，包括集群内全节点复制的镜像队列和集群内局部节点复制的镜像队列两种模式。&nbsp;
   </div> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;"><span style="line-height:1.5;font-size:1.17em;">2.1 配置</span></h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp; 多个单独的 RabbitMQ 服务，可以加入到一个集群中，也可以从集群中退出。集群中的 RabbitMQ 服务，使用同样的 Erlang cookie（unix 系统上默认为&nbsp;/var/lib/rabbitmq/.erlang.cookie）。所有在一个 RabbitMQ 服务中被操作的数据和状态（date/state）都会被同步到集群中的其它节点。&nbsp;&nbsp;</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp;镜像队列的配置通过添加 policy 完成，policy 添加的命令为：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <ul style="list-style:none;font-size:12px;">
     <li style="list-style-type:disc;">rabbitmqctl set_policy [-<span style="line-height:1.5;">p Vhost] Name Pattern Definition [Priority]</span> </li> 
     <li style="list-style-type:disc;">-<span style="line-height:1.5;">p Vhost: 可选参数，针对指定vhost下的queue进行设置</span> </li> 
     <li style="list-style-type:disc;"><span style="line-height:1.5;">Name: policy的名称</span></li> 
     <li style="list-style-type:disc;"><span style="line-height:1.5;">Pattern: queue的匹配模式（正则表达式）</span></li> 
     <li style="list-style-type:disc;"> <span style="line-height:1.5;">Definition: 镜像定义，包括三个部分 ha</span>-mode，ha-<span style="line-height:1.5;">params</span>，ha-sync-<span style="line-height:1.5;">mode</span> 
      <ul style="list-style:none;">
       <li style="list-style-type:disc;"> <span style="line-height:1.5;">ha</span>-mode: 指明镜像队列的模式，有效值为 all/exactly/<span style="line-height:1.5;">nodes</span> 
        <ul style="list-style:none;">
         <li style="list-style-type:disc;"><span style="line-height:1.5;">all表示在集群所有的节点上进行镜像</span></li> 
         <li style="list-style-type:disc;"> <span style="line-height:1.5;">exactly 表示在指定个数的节点上进行镜像，节点的个数由ha</span>-<span style="line-height:1.5;">params指定</span> </li> 
         <li style="list-style-type:disc;"> <span style="line-height:1.5;">nodes 表示在指定的节点上进行镜像，节点名称通过ha</span>-<span style="line-height:1.5;">params指定</span> </li> 
        </ul></li> 
       <li style="list-style-type:disc;"> <span style="line-height:1.5;">ha</span>-<span style="line-height:1.5;">params</span>: ha-<span style="line-height:1.5;">mode模式需要用到的参数</span> </li> 
       <li style="list-style-type:disc;"> <span style="line-height:1.5;">ha</span>-sync-<span style="line-height:1.5;">mode: 镜像队列中消息的同步方式，有效值为automatic，manually</span> </li> 
      </ul></li> 
     <li style="list-style-type:disc;"><span style="line-height:1.5;">Priority: 可选参数， policy的优先级</span></li> 
    </ul>
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">例如，对队列名称以 ’hello‘ 开头的所有队列进行镜像，并在集群的两个节点上完成镜像，policy的设置命令为：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>rabbitmqctl  set_policy  hello-ha  <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">^hello</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>  <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">{"ha-mode":"exactly","ha-params":2,"ha-sync-mode":"automatic"}</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span></pre>
   </div> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.2 HAProxy 和 RabbitMQ A/A 集群</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">RabbitMQ 实现镜像队列的方式比较特别。<a href="http://insidethecpu.com/2014/11/17/load-balancing-a-rabbitmq-cluster/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这篇文章</a>进行了深入的阐述。假设有如下的配置：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/697113/201511/697113-20151125165710077-931847628.jpg" alt="" width="339" height="307" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">创建 queue 的过程：</p> 
   <ol style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;">LB 将 client request 分发到 node 2，client 创建队列 “NewQueue”，然后开始向其中放入 message。</li> 
    <li style="list-style-type:decimal;">最终，后端服务会对 node 2 上的 “NewQueue” 创建一个快照，并在一段时间内将其拷贝到node 1 和 3 上。这时候，node2 上的队列是&nbsp;master Queue，node 1 和 3 上的队列是 slave queue。</li> 
   </ol>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">假如现在 node2 宕机了：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">node 2 不再响应心跳，它会被认为已经被从集群中移出了</li> 
    <li style="list-style-type:disc;">node 2 上的 master queue 不再可用</li> 
    <li style="list-style-type:disc;">RabbitMQ 将 node 1 或者 3 上的 salve instance 升级为 master instance</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">假设 master queue 还在 node 2 上，客户端通过 LB 访问该队列：</p> 
   <ol style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;">客户端连接到集群，要访问&nbsp;“NewQueue” 队列</li> 
    <li style="list-style-type:decimal;">LB 根据配置的轮询算法将请求分发到一个节点上</li> 
    <li style="list-style-type:decimal;">假设客户端请求被转到 node 3 上</li> 
    <li style="list-style-type:decimal;">RabbitMQ 发现&nbsp;“NewQueue” master node 是 node 2</li> 
    <li style="list-style-type:decimal;">RabbitMQ 将消息转到 node 2 上</li> 
    <li style="list-style-type:decimal;">最终客户端成功连接到 node 2 上的 master 队列</li> 
   </ol>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">可见，这种配置下，2/3 的客户端请求需要重定向，这会造成大概率的访问延迟，但是终究访问还是会成功的。要优化的话，总共有两种方式：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">直接连到 master queue 所在的节点，这样就不需要重定向了。但是对这种方式，需要提前计算，然后告诉客户端哪个节点上有 master queue。</li> 
    <li style="list-style-type:disc;">尽可能地在所有节点间平均分布队列，减少重定向概率</li> 
   </ul>
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.3 镜像队列的负载均衡</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp; &nbsp;使用镜像队列的 RabbitMQ 不支持负载均衡，这是由其镜像队列的实现机制决定的。如前面所述，假设一个集群里有两个实例，记作 rabbitA 和 rabbitB。如果某个队列在rabbitA 上创建，随后在 rabbitB 上镜像备份，那么 rabbitA 上的队列称为该队列的主队列（master queue），其它备份均为从队列。接下来，无论client 访问rabbitA 或 rabbitB，最终消费的队列都是主队列。换句话说，即使在连接时主动连接rabbitB，RabbitMQ的 cluster 会自动把连接转向 rabbitA。当且仅当rabbitA服务down掉以后，在剩余的从队列中再选举一个作为继任的主队列。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp; 如果这种机制是真的（需要看代码最最终确认），那么负载均衡就不能简单地随机化连接就能做到了。要实现轮询，需要满足下面的条件：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">队列本身的建立需要随机化，即将队列分布于各个服务器</li> 
    <li style="list-style-type:disc;">client 访问需要知道每个队列的主队列保存在哪个服务器</li> 
    <li style="list-style-type:disc;">如果某个服务器down了，需要知道哪个从队列被选择成为继任的主队列。</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp;要实现这种方案，<a href="http://insidethecpu.com/2014/11/17/load-balancing-a-rabbitmq-cluster/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这篇文章</a>&nbsp;给出了一个方案：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/697113/201511/697113-20151125152707937-2011571265.jpg" alt="" width="479" height="382" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">首先，在建立一个新队列的时候，Randomiser 会随机选择一个服务器，这样能够保证队列均匀分散在各个服务器（这里暂且不考虑负载）。建立队列后需要在Meta data 里记录这个队列对应的服务器；另外，Monitor Service是关键，它用于处理某个服务器down掉的情况。一旦发生down机，它需要为之前主队列在该服务器的队列重新建立起与服务器的映射关系。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">这里会遇到一个问题，即怎么判断某个队列的主队列呢？一个方法是通过rabbitmqctl，如下面的例子：&nbsp;</p> 
   <div class="crayon-syntax crayon-theme-vs2012 crayon-font-monaco crayon-os-pc print-yes notranslate" style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <div class="crayon-main"> 
     <table class="crayon-table" style="border:1px solid #C0C0C0;border-collapse:collapse;">
      <tbody>
       <tr>
        <td class="crayon-nums" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> 
         <div class="crayon-nums-content"> 
          <div class="crayon-num">
           1
          </div> 
          <div class="crayon-num crayon-striped-num">
           2
          </div> 
          <div class="crayon-num">
           3
          </div> 
         </div> </td> 
        <td class="crayon-code" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> 
         <div class="crayon-pre"> 
          <div class="crayon-line">
           <span class="crayon-sy" style="line-height:1.5;">.<span class="crayon-o" style="line-height:1.5;">/<span class="crayon-v" style="line-height:1.5;">rabbitmqctl<span class="crayon-h" style="line-height:1.5;">&nbsp;<span class="crayon-o" style="line-height:1.5;">-<span class="crayon-i" style="line-height:1.5;">p<span class="crayon-h" style="line-height:1.5;">&nbsp;<span class="crayon-e" style="line-height:1.5;">production&nbsp;<span class="crayon-e" style="line-height:1.5;">list_queues&nbsp;<span class="crayon-e" style="line-height:1.5;">pid&nbsp;<span class="crayon-e" style="line-height:1.5;">slave_pids</span></span></span></span></span></span></span></span></span></span></span>
          </div> 
          <div class="crayon-line crayon-striped-line">
           <span class="crayon-v" style="line-height:1.5;">registration<span class="crayon-o" style="line-height:1.5;">-<span class="crayon-v" style="line-height:1.5;">email<span class="crayon-o" style="line-height:1.5;">-<span class="crayon-v" style="line-height:1.5;">queue<span class="crayon-h" style="line-height:1.5;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="crayon-o" style="line-height:1.5;">&lt;<span class="crayon-v" style="line-height:1.5;">rabbit<span class="crayon-sy" style="line-height:1.5;">@<span class="crayon-v" style="line-height:1.5;">mq01<span class="crayon-sy" style="line-height:1.5;">.<span class="crayon-cn" style="line-height:1.5;">2.1076.0<span class="crayon-o" style="line-height:1.5;">&gt;<span class="crayon-h" style="line-height:1.5;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="crayon-sy" style="line-height:1.5;">[<span class="crayon-o" style="line-height:1.5;">&lt;<span class="crayon-v" style="line-height:1.5;">rabbit<span class="crayon-sy" style="line-height:1.5;">@<span class="crayon-v" style="line-height:1.5;">mq00<span class="crayon-sy" style="line-height:1.5;">.<span class="crayon-cn" style="line-height:1.5;">1.285.0<span class="crayon-o" style="line-height:1.5;">&gt;<span class="crayon-sy" style="line-height:1.5;">]</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>
          </div> 
          <div class="crayon-line">
           <span class="crayon-v" style="line-height:1.5;">registration<span class="crayon-o" style="line-height:1.5;">-<span class="crayon-v" style="line-height:1.5;">sms<span class="crayon-o" style="line-height:1.5;">-<span class="crayon-v" style="line-height:1.5;">queue<span class="crayon-h" style="line-height:1.5;">&nbsp;&nbsp;<span class="crayon-o" style="line-height:1.5;">&lt;<span class="crayon-v" style="line-height:1.5;">rabbit<span class="crayon-sy" style="line-height:1.5;">@<span class="crayon-v" style="line-height:1.5;">mq01<span class="crayon-sy" style="line-height:1.5;">.<span class="crayon-cn" style="line-height:1.5;">2.1067.0<span class="crayon-o" style="line-height:1.5;">&gt;<span class="crayon-h" style="line-height:1.5;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="crayon-sy" style="line-height:1.5;">[<span class="crayon-o" style="line-height:1.5;">&lt;<span class="crayon-v" style="line-height:1.5;">rabbit<span class="crayon-sy" style="line-height:1.5;">@<span class="crayon-v" style="line-height:1.5;">mq00<span class="crayon-sy" style="line-height:1.5;">.<span class="crayon-cn" style="line-height:1.5;">1.281.0<span class="crayon-o" style="line-height:1.5;">&gt;<span class="crayon-sy" style="line-height:1.5;">]</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>
          </div> 
         </div> </td> 
       </tr>
      </tbody>
     </table>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;可以看到pid和slave_pids分别对应主队列所在的服务器和从服务器（可能有多个）。利用这个命令就可以了解每个队列所在的主服务器了。</p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">3. OpenStack 中RabbitMQ集群的用法和配置</h2> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">3.1 配置</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp; OpenStack 官方建议至少使用三节点 RabbitMQ 集群，而且推荐配置是使用镜像队列。对于测试和演示环境，使用两节点也是可以。以下OpenStack&nbsp;服务都支持这种 A/A 形式的 RabbitMQ：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">计算服务</li> 
    <li style="list-style-type:disc;">块设备存储服务</li> 
    <li style="list-style-type:disc;">网络服务</li> 
    <li style="list-style-type:disc;">Telemetry</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp;&nbsp;OpenStack 支持如下的 RabbitMQ 配置：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;"><span style="line-height:1.5;">rabbit_hosts=rabbit1:5672,rabbit2:5672,rabbit3:5672：所有RabbitMQ 服务列表</span></li> 
    <li style="list-style-type:disc;"><span style="line-height:1.5;">rabbit_retry_interval=1: 连接失败时候的重试间隔</span></li> 
    <li style="list-style-type:disc;"><span style="line-height:1.5;">rabbit_retry_backoff=2：&nbsp;How long to back-off for between retries when connecting to RabbitMQ。不太明白其含义。</span></li> 
    <li style="list-style-type:disc;"><span style="line-height:1.5;">rabbit_max_retries=0：最大重试次数。0 表示一直重试</span></li> 
    <li style="list-style-type:disc;"><span style="line-height:1.5;">rabbit_durable_queues=true：true 的话表示使用持久性队列，Kilo 中默认为 false。</span></li> 
    <li style="list-style-type:disc;"> <span style="line-height:1.5;">rabbit_ha_queues=true: 设置为 true 的话则使用镜像队列，并设置&nbsp;</span><span style="line-height:1.5;">x-ha-policy 为 all；但是 Kilo 中其默认值为 false。</span> </li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">具体的配置可以参考&nbsp;<a href="http://www.lnmpy.com/rabbitmq-ha-lb/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这篇文章</a>&nbsp;以及 OpenStack 官网，以及&nbsp;<a href="https://www.rabbitmq.com/clustering.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">RabbitMQ 官网</a>。</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">3.2 RabbitMQ 节点选择</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">OpenStack 的 oslo_messaging 的 RabbitMQ driver 的实现代码在&nbsp;<a href="https://github.com/openstack/oslo.messaging/blob/master/oslo_messaging/_drivers/impl_rabbit.py" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这里</a>。它采用的逻辑正是上面所提到的第二种优化方法“尽可能地在所有节点间平均分布队列，减少重定向概率”。这表现在：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）将 rabbit_hosts 打乱，然后构造新的包含多host的 url：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="line-height:1.5;">if len(self.rabbit_hosts) &gt; 1:
    random.shuffle(self.rabbit_hosts)<span style="color:rgb(0,0,255);line-height:1.5;"> #将多个 hosts 打乱</span>
for adr in self.rabbit_hosts:
    hostname, port = netutils.parse_host_port(
        adr, default_port=self.rabbit_port)
    self._url += '%samqp://%s:%s@%s:%s/%s' % ( <span style="color:rgb(0,0,255);line-height:1.5;">#将多个url合并，以分号分割，kombu 会按照指定策略在连接失败时重新选择别的host重连</span>
        ";" if self._url else '',
        parse.quote(self.rabbit_userid, ''),
        parse.quote(self.rabbit_password, ''),
        self._parse_url_hostname(hostname), port,
        virtual_host)</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）在建立 Connection 的时候，设置 failover_strategy 为 “shuffle”，这样，在连接不成功需要重连的时候，kombu 会 “随机”地选择一个新的 host:port 重新连接（kombu 库支持 轮询和随机两种策略，<a href="https://github.com/celery/kombu/blob/master/kombu/connection.py" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">代码在这里</a>）</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>self.connection =<span style="line-height:1.5;"> kombu.connection.Connection(
    self._url, ssl</span>=<span style="line-height:1.5;">self._fetch_ssl_params(),
    login_method</span>=<span style="line-height:1.5;">self.login_method,
    failover_strategy</span>=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(0,0,255);line-height:1.5;">shuffle</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
    heartbeat</span>=<span style="line-height:1.5;">self.heartbeat_timeout_threshold,
    transport_options</span>=<span style="line-height:1.5;">{
        </span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">confirm_publish</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">: True,
        </span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">on_blocked</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">: self._on_connection_blocked,
        </span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">on_unblocked</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">: self._on_connection_unblocked,
    },
)</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">3.3 性能配置</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">OpenStack 支持如下几种 RPC 性能配置：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">rpc_conn_pool_size = 30 (IntOpt) （RPC 连接池的大小）</li> 
    <li style="list-style-type:disc;">rpc_response_timeout = 60 (IntOpt) （等待返回的超时时间，单位是秒）</li> 
    <li style="list-style-type:disc;">rpc_thread_pool_size = 64 (IntOpt) （RPC 线程池的大小）</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;这些参数在做RPC 性能调试的时候往往需要考虑到。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">参考链接：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;"><a href="http://leejia.blog.51cto.com/4356849/841084" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://leejia.blog.51cto.com/4356849/841084</a></li> 
    <li style="list-style-type:disc;"><a href="http://drbd.linbit.com/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://drbd.linbit.com/</a></li> 
    <li style="list-style-type:disc;"><a href="http://kafecho.github.io/presentations/introduction-to-pacemaker/#/8" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://kafecho.github.io/presentations/introduction-to-pacemaker/#/8</a></li> 
    <li style="list-style-type:disc;"><a href="http://chuansong.me/n/412792" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://chuansong.me/n/412792</a></li> 
    <li style="list-style-type:disc;"><a href="http://www.gpfeng.com/?p=603" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://www.gpfeng.com/?p=603</a></li> 
    <li style="list-style-type:disc;"><a href="http://fengchj.com/?p=2273" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://fengchj.com/?p=2273</a></li> 
    <li style="list-style-type:disc;"><a href="http://onlychoice.github.io/blog/2013/11/12/rabbitmq-ha/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://onlychoice.github.io/blog/2013/11/12/rabbitmq-ha/</a></li> 
    <li style="list-style-type:disc;"><a href="http://insidethecpu.com/2014/11/17/load-balancing-a-rabbitmq-cluster/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://insidethecpu.com/2014/11/17/load-balancing-a-rabbitmq-cluster/</a></li> 
    <li style="list-style-type:disc;"><a href="http://my.oschina.net/hncscwc/blog/186350" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://my.oschina.net/hncscwc/blog/186350</a></li> 
    <li style="list-style-type:disc;"><a href="http://www.rabbitmq.com/ha.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://www.rabbitmq.com/ha.html</a></li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><br></p> 
   <p style="line-height:1.5;"><font color="#4b4b4b"><span style="font-size:15px;">&nbsp; &nbsp; 本文转自SammyLiu博客园博客，原文链接：http://www.cnblogs.com/sammyliu/p/4730517.html</span></font><span style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">，如需转载请自行联系原作者</span></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><br></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
