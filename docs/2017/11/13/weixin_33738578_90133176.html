<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Elasticsearch之elasticsearch5.x 新特性 « NotBeCN</title>
  <meta name="description" content="             　其实，elasticsearch5.x 和 elasticsearch2.x 并不区别很大。    　　是因为，ELK里之前版本各种很混乱，直接升级到5.0了。    　　其实，elasticsearch5.x 按理来说是elasticsearch3.x，只是为了跟随ELK整体版本的统...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/13/weixin_33738578_90133176.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">Elasticsearch之elasticsearch5.x 新特性</h1>
    <p class="post-meta">Nov 13, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　其实，elasticsearch5.x 和 elasticsearch2.x 并不区别很大。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　是因为，ELK里之前版本各种很混乱，直接升级到5.0了。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　其实，elasticsearch5.x 按理来说是elasticsearch3.x，只是为了跟随ELK整体版本的统一。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　&nbsp;<img src="https://images2015.cnblogs.com/blog/855959/201703/855959-20170325235135596-1837440713.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong><span style="font-size:18pt;">下面给大家介绍一下&nbsp;5.0&nbsp;版里面的一些新的特性和改进</span></strong></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong>　　5.0</strong><strong>？ 天啦噜，你是不是觉得版本跳的太快了。</strong></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　好吧，先来说说背后的原因吧。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　　　<img src="https://images2015.cnblogs.com/blog/855959/201703/855959-20170325235159643-512355029.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　相信大家都听说&nbsp;ELK&nbsp;吧，是&nbsp;Elasticsearch&nbsp;、&nbsp;Logstash&nbsp;、&nbsp;Kibana&nbsp;三个产品的首字母缩写，<strong><span style="color:rgb(0,0,255);">现在&nbsp;Elastic&nbsp;又新增了一个新的开源项目成员：&nbsp;Beats。</span></strong></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　　　　　<img src="https://images2015.cnblogs.com/blog/855959/201703/855959-20170325235222299-1801587901.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;　　有人建议以后这么叫：&nbsp;<strong><span style="color:rgb(0,0,255);">ELKB&nbsp;</span></strong>？</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　为了未来更好的扩展性:) ELKBS？ELKBSU？.....</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　所以我们打算将产品线命名为&nbsp;ElasticStack</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　同时<strong><span style="color:rgb(0,0,255);">由于现在的版本比较混乱，每个产品的版本号都不一样</span></strong>，&nbsp;Elasticsearch和Logstash目前是2.3.4；Kibana是4.5.3；Beats是1.2.3；</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　　　<img src="https://images2015.cnblogs.com/blog/855959/201703/855959-20170325235257611-1406158587.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　版本号太乱了有没有，什么版本的&nbsp;ES&nbsp;用什么版本的&nbsp;Kibana&nbsp;？有没有兼容性问题？</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　<span style="font-size:14pt;"><strong><span style="color:rgb(0,0,255);">所以我们打算将这些的产品版本号也统一一下</span></strong></span>，即&nbsp;v5.0&nbsp;，为什么是&nbsp;5.0&nbsp;，因为&nbsp;Kibana&nbsp;都&nbsp;4.x&nbsp;了，下个版本就只能是&nbsp;5.0&nbsp;了，其他产品就跟着跳跃一把，第一个&nbsp;5.0&nbsp;正式版将在今年的秋季发布，目前最新的测试版本是：&nbsp;5.0 Alpha 4。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　　　　　<img src="https://images2015.cnblogs.com/blog/855959/201703/855959-20170325235341783-190444500.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　目前各团队正在紧张的开发测试中，每天都有新的功能和改进，本次分享主要介绍一下&nbsp;Elasticsearch&nbsp;的主要变化。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong><span style="font-size:18pt;">Elasticsearch5.0新增功能</span></strong></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　首先来看看&nbsp;5.0&nbsp;里面都引入了哪些新的功能吧。</p> 
   <h4 style="font-size:14px;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;"> <span style="font-size:18pt;"><strong><span style="color:rgb(0,0,255);">1、</span></strong></span>首先看看跟性能有关的</h4> 
   <h4 style="font-size:14px;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">　　1.1 第一个就是Lucene 6.x 的支持。</h4> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　Elasticsearch5.0率先集成了Lucene6版本，其中最重要的特性就是 Dimensional Point Fields，多维浮点字段，ES里面相关的字段如date, numeric，ip 和 Geospatial 都将大大提升性能。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　这么说吧，磁盘空间少一半；索引时间少一半；查询性能提升25%；IPV6也支持了。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　为什么快，底层使用的是Block k-d trees，核心思想是将数字类型编码成定长的字节数组，对定长的字节数组内容进行编码排序，然后来构建二叉树，然后依次递归构建，目前底层支持8个维度和最多每个维度16个字节，基本满足大部分场景。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　说了这么多，看图比较直接。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　　　　　　　&nbsp;<img src="https://images2015.cnblogs.com/blog/855959/201703/855959-20170325235432549-997243375.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　图中从&nbsp;2015&nbsp;/10/32&nbsp;&nbsp;total bytes&nbsp;飙升是因为&nbsp;es&nbsp;启用了&nbsp;docvalues&nbsp;，我们关注红线，最近的引入新的数据结构之后，红色的索引大小只有原来的一半大小。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　索引小了之后，&nbsp;merge&nbsp;的时间也响应的减少了，看下图：</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　　　　　　　<img src="https://images2015.cnblogs.com/blog/855959/201703/855959-20170325235455861-885058949.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;　　相应的&nbsp;Java&nbsp;堆内存占用只原来的一半：</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　　　　　&nbsp;<img src="https://images2015.cnblogs.com/blog/855959/201703/855959-20170325235509721-1185550732.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　<strong>1.2</strong>&nbsp;&nbsp;再看看&nbsp;<strong>索引的性能</strong>&nbsp;，也是飙升：</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　　　　　&nbsp;<img src="https://images2015.cnblogs.com/blog/855959/201703/855959-20170325235522721-1949146733.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　当然&nbsp;Lucene6&nbsp;里面还有很多优化和改进，这里没有一一列举。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　<strong>　1.3&nbsp;</strong>&nbsp;我们再看看索引性能方面的其他优化。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　ES5.0在Internal engine级别移除了用于避免同一文档并发更新的竞争锁，带来15%-20%的性能提升&nbsp;<strong>#18060</strong>&nbsp;。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　　　　　<img src="https://images2015.cnblogs.com/blog/855959/201703/855959-20170325235606986-1682862552.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　以上截图来自&nbsp;ES&nbsp;的每日持续性能监控：&nbsp;https://benchmarks.elastic.co/index.html</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <h4 style="font-size:14px;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">　　1.4 另一个&nbsp;和&nbsp;aggregation&nbsp;的改进也是非常大，&nbsp;Instant Aggregations。</h4> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　Elasticsearch已经在Shard层面提供了Aggregation缓存，如果你的数据没有变化，ES能够直接返回上次的缓存结果，但是有一个场景比较特殊，就是 date histogram，大家kibana上面的条件是不是经常设置的相对时间，如：from:now-30d to:now，好吧，now是一个变量，每时每刻都在变，所以query条件一直在变，缓存也就是没有利用起来。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　经过一年时间大量的重构，现在可以做到对查询做到灵活的重写：</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　首先，`now`关键字最终会被重写成具体的值；</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　其次&nbsp;<strong>，</strong>&nbsp;每个shard会根据自己的数据的范围来重写查询为 `match_all`或者是`match_none`查询，所以现在的查询能够被有效的缓存，并且只有个别数据有变化的Shard才需要重新计算，大大提升查询速度。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　<strong>1.5 &nbsp;&nbsp;</strong>另外再看看和Scroll相关的吧。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　现在新增了一个：Sliced Scroll类型</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　用过Scroll接口吧，很慢？如果你数据量很大，用Scroll遍历数据那确实是接受不了，现在Scroll接口可以并发来进行数据遍历了。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　每个Scroll请求，可以分成多个Slice请求，可以理解为切片，各Slice独立并行，利用Scroll重建或者遍历要快很多倍。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　看看这个demo</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　　　　　　　　　<img src="https://images2015.cnblogs.com/blog/855959/201703/855959-20170325235721799-48686168.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　可以看到两个&nbsp;scroll&nbsp;请求，&nbsp;id&nbsp;分别是&nbsp;0&nbsp;和&nbsp;1&nbsp;，&nbsp;max&nbsp;是最大可支持的并行任务，可以各自独立进行数据的遍历获取。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="font-size:18pt;"><strong><span style="color:rgb(0,0,255);">2、</span></strong></span>我们再看看es在查询优化这块做的工作</p> 
   <h4 style="font-size:14px;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">　　2.1 新增了一个Profile API。</h4> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">#https://www.elastic.co/guide/en/elasticsearch/reference/master/search-profile.html#_usage_3</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　都说要致富先修路，要调优当然需要先监控啦，elasticsearch在很多层面都提供了stats方便你来监控调优，但是还不够，其实很多情况下查询速度慢很大一部分原因是糟糕的查询引起的，玩过SQL的人都知道，数据库服务的执行计划（execution plan）非常有用，可以看到那些查询走没走索引和执行时间，用来调优，elasticsearch现在提供了Profile API来进行查询的优化，只需要在查询的时候开启profile：true就可以了，一个查询执行过程中的每个组件的性能消耗都能收集到。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　　　　　　　<img src="https://images2015.cnblogs.com/blog/855959/201703/855959-20170325235753908-1505539590.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　那个子查询耗时多少，占比多少，一目了然。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　同时支持search和aggregation的profile。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　还有一个和翻页相关的问题，就是深度分页&nbsp;，是个老大难的问题，因为需要全局排序（&nbsp;number_of_shards * (from + size)&nbsp;），所以需要消耗大量内存，以前的&nbsp;es&nbsp;没有限制，有些同学翻到几千页发现&nbsp;es&nbsp;直接内存溢出挂了，后面&nbsp;elasticsearch&nbsp;加上了限制，&nbsp;from+size&nbsp;不能超过&nbsp;1w&nbsp;条，并且如果需要深度翻页，建议使用&nbsp;scroll&nbsp;来做。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　但是&nbsp;scroll&nbsp;有几个问题，第一个是没有顺序，直接从底层&nbsp;segment&nbsp;进行遍历读取，第二个实时性没法保证，&nbsp;scroll&nbsp;操作有状态，&nbsp;es&nbsp;会维持&nbsp;scroll&nbsp;请求的上下文一段时间，超时后才释放，另外你在&nbsp;scroll&nbsp;过程中对索引数据进行了修改了，这个时候&nbsp;scroll接口是拿不到的，灵活性较差，&nbsp;现在有一个新的&nbsp;Search After&nbsp;机制，其实和&nbsp;scroll&nbsp;类似，也是游标的机制，它的原理是对文档按照多个字段进行排序，然后利用上一个结果的最后一个文档作为起始值，拿&nbsp;size&nbsp;个文档，一般我们建议使用&nbsp;_uid&nbsp;这个字段，它的值是唯一的&nbsp;id&nbsp;。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">#（Search After</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">https://github.com/elastic/elasticsearch/blob/148f9af5857f287666aead37f249f204a870ab39/docs/reference/search/request/search-after.asciidoc&nbsp;）</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　来看一个Search After 的demo 吧，比较直观的理解一下：</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　　　　　　　　　<img src="https://images2015.cnblogs.com/blog/855959/201703/855959-20170325235818002-1726839844.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　上面的&nbsp;demo&nbsp;，&nbsp;search_after&nbsp;后面带的两个参数，就是&nbsp;sort&nbsp;的两个结果。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　根据你的排序条件来的，三个排序条件，就传三个参数。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="font-size:18pt;"><strong><span style="color:rgb(0,0,255);">3、</span></strong></span>再看看跟索引与分片管理相关的新功能吧。</p> 
   <h4 style="font-size:14px;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">　　3.1 新增了一个&nbsp;Shrink&nbsp;&nbsp;API</h4> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">#https://www.elastic.co/guide/en/elasticsearch/reference/master/indices-shrink-index.html#_shrinking_an_index</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　相信大家都知道elasticsearch索引的shard数是固定的，设置好了之后不能修改，如果发现shard太多或者太少的问题，之前如果要设置Elasticsearch的分片数，只能在创建索引的时候设置好，并且数据进来了之后就不能进行修改，如果要修改，只能重建索引。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　现在有了Shrink接口，它可将分片数进行收缩成它的因数，如之前你是15个分片，你可以收缩成5个或者3个又或者1个，那么我们就可以想象成这样一种场景，在写入压力非常大的收集阶段，设置足够多的索引，充分利用shard的并行写能力，索引写完之后收缩成更少的shard，提高查询性能。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　这里是一个API调用的例子</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　　　<img src="https://images2015.cnblogs.com/blog/855959/201703/855959-20170325235846877-1512182075.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　上面的例子对&nbsp;my_source_index&nbsp;伸缩成一个分片的&nbsp;my_targe_index,&nbsp;使用了最佳压缩。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　有人肯定会问慢不慢？非常快！ Shrink的过程会借助操作系统的Hardlink进行索引文件的链接，这个操作是非常快的，毫秒级Shrink就可收缩完成，当然windows不支持hard link，需要拷贝文件，可能就会很慢了。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　再来看另外一个比较有意思的新特性，除了有意思，当然还很强大。</p> 
   <h4 style="font-size:14px;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">　　3.2 新增了一个Rollover API。</h4> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">https://www.elastic.co/guide/en/elasticsearch/reference/master/indices-rollover-index.html#indices-rollover-index</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　前面说的这种场景对于日志类的数据非常有用，一般我们按天来对索引进行分割（数据量更大还能进一步拆分），我们以前是在程序里设置一个自动生成索引的模板，大家用过logstash应该就记得有这么一个模板logstash-[YYYY-MM-DD]这样的模板，现在es5.0里面提供了一个更加简单的方式：Rollover API</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　API调用方式如下：</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　　　　　　　　　<img src="https://images2015.cnblogs.com/blog/855959/201703/855959-20170325235912330-417331800.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　从上面可以看到，首先创建一个&nbsp;logs-0001&nbsp;的索引，它有一个别名是&nbsp;logs_write,&nbsp;然后我们给这个&nbsp;logs_write&nbsp;创建了一个&nbsp;rollover&nbsp;规则，即这个索引文档不超过&nbsp;1000&nbsp;个或者最多保存&nbsp;7&nbsp;天的数据，超过会自动切换别名到&nbsp;logs-0002,&nbsp;你也可以设置索引的&nbsp;setting&nbsp;、&nbsp;mapping&nbsp;等参数&nbsp;,&nbsp;剩下的&nbsp;es&nbsp;会自动帮你处理。这个特性对于存放日志数据的场景是极为友好的。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <h4 style="font-size:14px;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">　　3.3 &nbsp;新增：Reindex。</h4> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　另外关于索引数据，大家之前经常重建，数据源在各种场景，重建起来很是头痛，那就不得不说说现在新加的Reindex接口了，Reindex可以直接在Elasticsearch集群里面对数据进行重建，如果你的mapping因为修改而需要重建，又或者索引设置修改需要重建的时候，借助Reindex可以很方便的异步进行重建，并且支持跨集群间的数据迁移。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　比如按天创建的索引可以定期重建合并到以月为单位的索引里面去。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　当然索引里面要启用_source。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　来看看这个demo吧，重建过程中，还能对数据就行加工。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　　　　　　　<img src="https://images2015.cnblogs.com/blog/855959/201703/855959-20170325235938127-1989503956.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong>　　3.4 &nbsp;再看看跟Java开发者最相关的吧，就是 RestClient了</strong></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　5.0里面提供了第一个Java原生的REST客户端SDK，相比之前的TransportClient，版本依赖绑定，集群升级麻烦，不支持跨Java版本的调用等问题，新的基于HTTP协议的客户端对Elasticsearch的依赖解耦，没有jar包冲突，提供了集群节点自动发现、日志处理、节点请求失败自动进行请求轮询，充分发挥Elasticsearch的高可用能力，并且性能不相上下。&nbsp;<strong>#19055</strong>&nbsp;。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="font-size:18pt;color:rgb(0,0,255);"><strong>4、</strong></span>然后我们再看看其他的特性吧：</p> 
   <h4 style="font-size:14px;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">　　4.1 新增了一个&nbsp;Wait for refresh&nbsp;功能。</h4> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　简单来说相当于是提供了文档级别的Refresh： https://www.elastic.co/guide/en/elasticsearch/reference/master/docs-refresh.html。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　索引操作新增refresh参数，大家知道elasticsearch可以设置refresh时间来保证数据的实时性，refresh时间过于频繁会造成很大的开销，太小会造成数据的延时，之前提供了索引层面的_refresh接口，但是这个接口工作在索引层面，我们不建议频繁去调用，如果你有需要修改了某个文档，需要客户端实时可见怎么办？</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　在 5.0中，Index、Bulk、Delete、Update这些数据新增和修改的接口能够在单个文档层面进行refresh控制了，有两种方案可选，一种是创建一个很小的段，然后进行刷新保证可见和消耗一定的开销，另外一种是请求等待es的定期refresh之后再返回。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　调用例子：</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　　　　　<img src="https://images2015.cnblogs.com/blog/855959/201703/855959-20170326000005315-1224242494.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <h4 style="font-size:14px;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">　　4.2 # 新增：&nbsp;Ingest Node&nbsp;#</h4> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　#https://www.elastic.co/guide/en/elasticsearch/reference/master/ingest.html#</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　再一个比较重要的特性就是IngestNode了，大家之前如果需要对数据进行加工，都是在索引之前进行处理，比如logstash可以对日志进行结构化和转换，现在直接在es就可以处理了，目前es提供了一些常用的诸如convert、grok之类的处理器，在使用的时候，先定义一个pipeline管道，里面设置文档的加工逻辑，在建索引的时候指定pipeline名称，那么这个索引就会按照预先定义好的pipeline来处理了；</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　Demo again：</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　　　　　　　<img src="https://images2015.cnblogs.com/blog/855959/201703/855959-20170326000021783-1467409645.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　上图首先创建了一个名为my-pipeline-id的处理管道，然后接下来的索引操作就可以直接使用这个管道来对foo字段进行操作了，上面的例子是设置foo字段为bar值。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　上面的还不太酷，我们再来看另外一个例子，现在有这么一条原始的日志，内容如下：</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">{</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">"message": "55.3.244.1 GET /index.html 15824 0.043”</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">}</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　google之后得知其Grok的pattern如下：）</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">%{IP:client} %{WORD:method} %{URIPATHPARAM:request} %{NUMBER:bytes} %{NUMBER:duration}</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　那么我们使用Ingest就可以这么定义一个pipeline：</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　　　　　&nbsp;<img src="https://images2015.cnblogs.com/blog/855959/201703/855959-20170326000038596-600212832.png" alt="" style="border:0px;">　　</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　那么通过我们的&nbsp;pipeline&nbsp;处理之后的文档长什么样呢，我们获取这个文档的内容看看：</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　　　　　<img src="https://images2015.cnblogs.com/blog/855959/201703/855959-20170326000107611-2004280656.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　很明显，原始字段&nbsp;message&nbsp;被拆分成了更加结构化的对象了。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong><span style="color:rgb(0,0,255);font-size:18pt;">5、</span></strong>再看看脚本方面的改变</p> 
   <h4 style="font-size:14px;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">　　5.1 &nbsp;#新增Painless Scripting#</h4> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　还记得Groove脚本的漏洞吧，Groove脚本开启之后，如果被人误用可能带来的漏洞，为什么呢，主要是这些外部的脚本引擎太过于强大，什么都能做，用不好或者设置不当就会引起安全风险，基于安全和性能方面，我们自己开发了一个新的脚本引擎，名字就叫Painless，顾名思义，简单安全，无痛使用，和Groove的沙盒机制不一样，Painless使用白名单来限制函数与字段的访问，针对es的场景来进行优化，只做es数据的操作，更加轻量级，速度要快好几倍，并且支持Java静态类型，语法保持Groove类似，还支持Java的lambda表达式。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　我们对比一下性能，看下图</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　　　　　<img src="https://images2015.cnblogs.com/blog/855959/201703/855959-20170326000134190-1658627867.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　Groovy&nbsp;是弱弱的绿色的那根。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　再看看如何使用：</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">def first = input.doc.first_name.0;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">def last &nbsp;= input.doc.last_name.0;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">return first + " " + last;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　是不是和之前的写法差不多</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　或者还可以是强类型（10倍速度于上面的动态类型）</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">String first = (String)((List)((Map)input.get("doc")).get("first_name")).get(0);</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">String last &nbsp;= (String)((List)((Map)input.get("doc")).get("last_name")).get(0);</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">return first + " " + last;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　脚本可以在很多地方使用，比如搜索自定义评分；更新时对字段进行加工等</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　如：</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　　　　　<img src="https://images2015.cnblogs.com/blog/855959/201703/855959-20170326000157393-1176168364.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong><span style="color:rgb(0,0,255);font-size:18pt;">&nbsp;6、</span>再来看看基础架构方面的变化</strong></p> 
   <h4 style="font-size:14px;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">　　6.1 新增：Task Manager</h4> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　这个是5.0 引入任务调度管理机制，用来做&nbsp;离线任务的管理，比如长时间运行的reindex和update_by_query等都是运行在TaskManager机制之上的，并且任务是可管理的，你可以随时cancel掉，并且任务状态持久化，支持故障恢复；</p> 
   <h4 style="font-size:14px;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">　　6.2 还新增一个：&nbsp;Depreated logging</h4> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　大家在用ES的时候，其实有些接口可能以及打上了Depreated标签，即废弃了，在将来的某个版本中就会移除，你当前能用是因为一般废弃的接口都不会立即移除，给足够的时间迁移，但是也是需要知道哪些不能用了，要改应用代码了，所以现在有了Depreated日志，当打开这个日志之后，你调用的接口如果已经是废弃的接口，就会记录下日志，那么接下来的事情你就知道你应该怎么做了。</p> 
   <h4 style="font-size:14px;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">　　6.3 新增&nbsp;: Cluster allocation explain API</h4> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　『谁能给我一个shard不能分配的理由』，现在有了，大家如果之前遇到过分片不能正常分配的问题，但是不知道是什么原因，只能尝试手动路由或者重启节点，但是不一定能解决，其实里面有很多原因，现在提供的这个explain接口就是告诉你目前为什么不能正常分配的原因，方便你去解决。</p> 
   <h4 style="font-size:14px;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">　　6.4 另外在数据结构这块，新增&nbsp;: half_float&nbsp;类型</h4> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">https://www.elastic.co/guide/en/elasticsearch/reference/master/number.html</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　只使用 16 位 足够满足大部分存储监控数值类型的场景，支持范围：2负24次方 到 65504，但是只占用float一半的存储空间。</p> 
   <h4 style="font-size:14px;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">　　6.5 Aggregation&nbsp;新增&nbsp;: Matrix Stats Aggregation #&nbsp;18300</h4> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">金融领域非常有用的，可计算多个向量元素协方差矩阵、相关系数矩阵等等</p> 
   <h4 style="font-size:14px;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">　　6.6 另外一个重要的特性：为索引写操作添加顺序号&nbsp;#&nbsp;10708</h4> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　大家知道es是在primary上写完然后同步写副本，这些请求都是并发的，虽然可以通过version来控制冲突，</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　但是没法保证其他副本的操作顺序，通过写的时候产生顺序号，并且在本地也写入checkpoint来记录操作点，</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　这样在副本恢复的时候也可以知道当前副本的数据位置，而只需要从指定的数据开始恢复就行了，而不是像以前的粗暴的做完整的文件同步&nbsp;，另外这些顺序号也是持久化的，重启后也可以快速恢复副本信息，想想以前的大量无用拷贝吧和来回倒腾数据吧。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong><span style="font-size:18pt;">7、Elasticsearch5.0其他方面的改进</span></strong></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　<strong>7.1</strong>&nbsp;我们再看看&nbsp;<strong>mapping</strong><strong>&nbsp;</strong><strong>这块的改进</strong><strong>&nbsp;</strong>吧。</p> 
   <h4 style="font-size:14px;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">　　　　引入新的字段类型&nbsp;Text/Keyword&nbsp;来替换&nbsp;&nbsp;String</h4> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　以前的string类型被分成Text和Keyword两种类型，keyword类型的数据只能完全匹配，适合那些不需要分词的数据，</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　对过滤、聚合非常友好，text当然就是全文检索需要分词的字段类型了。将类型分开的好处就是使用起来更加简单清晰，以前需要设置analyzer和index，并且有很多都是自定义的分词器，从名称根本看不出来到底分词没有，用起来很麻烦。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　另外string类型暂时还在的，6.0会移除。</p> 
   <h4 style="font-size:14px;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">　　7.2 还有关于&nbsp;Index&nbsp;Settings&nbsp;的改进</h4> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　Elasticsearch的配置实在太多，在以前的版本间，还移除过很多无用的配置，经常弄错有没有？</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　现在，配置验证更加严格和保证原子性，如果其中一项失败，那个整个都会更新请求都会失败，不会一半成功一半失败。下面主要说两点：</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　1.设置可以重设会默认值，只需要设置为 `null`即可</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　2.获取设置接口新增参数`?include_defaults`,可以直接返回所有设置和默认值</p> 
   <h4 style="font-size:14px;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">　　7.3 集群处理的改进&nbsp;: Deleted Index Tombstones</h4> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　在以前的es版本中，如果你的旧节点包含了部分索引数据，但是这个索引可能后面都已经删掉了，你启动这个节点之后，会把索引重新加到集群中，是不是觉得有点阴魂不散，现在es5.0会在集群状态信息里面保留500个删除的索引信息，所以如果发现这个索引是已经删除过的就会自动清理，不会再重复加进来了。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　文档对象的改进&nbsp;:&nbsp;字段名重新支持英文句号，再&nbsp;2.0&nbsp;的时候移除过&nbsp;dot&nbsp;在字段名中的支持，现在问题解决了，又重新支持了。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　es会认为下面两个文档的内容一样：</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　　　　　　　&nbsp;<img src="https://images2015.cnblogs.com/blog/855959/201703/855959-20170326000251393-166746379.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;　　7.4&nbsp;<strong>还有其他的一些改进</strong></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　Cluster state&nbsp;的修改现在会和所有节点进行&nbsp;ack&nbsp;确认。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　Shard&nbsp;的一个副本如果失败了，&nbsp;Primary&nbsp;标记失败的时候会和&nbsp;Master&nbsp;节点确认完毕再返回。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　使用&nbsp;UUID&nbsp;来作为索引的物理的路径名，有很多好处，避免命名的冲突。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　_timestamp&nbsp;和&nbsp;_ttl&nbsp;已经移除，需要在&nbsp;Ingest&nbsp;或者程序端处理。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　ES&nbsp;可直接用&nbsp;HDFS&nbsp;来进行备份还原（&nbsp;Snapshot/Restore&nbsp;）了&nbsp;<strong>#15191</strong><strong>&nbsp;</strong>。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　Delete-by-query&nbsp;和&nbsp;Update-by-query&nbsp;重新回到&nbsp;core&nbsp;，以前是插件，现在可以直接使用了，也是构建在&nbsp;Reindex&nbsp;机制之上。(es1.x版本是直接支持，在es2.x中提取为插件，5.x继续回归直接支持)</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　HTTP&nbsp;请求默认支持压缩，当然&nbsp;http&nbsp;调用端需要在&nbsp;header&nbsp;信息里面传对应的支持信息。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　创建索引不会再让集群变红了，不会因为这个卡死集群了。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　默认使用&nbsp;BM25&nbsp;评分算法，效果更佳，之前是&nbsp;TF/IDF。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　快照&nbsp;Snapshots&nbsp;添加&nbsp;UUID&nbsp;解决冲突&nbsp;<strong>#18156</strong><strong>&nbsp;</strong>。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　限制索引请求大小，避免大量并发请求压垮&nbsp;ES&nbsp;<strong>#16011</strong><strong>。</strong></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　限制单个请求的&nbsp;shards&nbsp;数量，默认&nbsp;1000&nbsp;个&nbsp;<strong>#17396</strong><strong>。</strong></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　移除&nbsp;site plugins&nbsp;，就是说&nbsp;head&nbsp;、&nbsp;bigdesk&nbsp;都不能直接装&nbsp;es&nbsp;里面了，不过可以部署独立站点（反正都是静态文件）或开发&nbsp;kibana&nbsp;插件&nbsp;<strong>#16038</strong><strong>&nbsp;</strong>。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　允许现有&nbsp;parent&nbsp;类型新增&nbsp;child&nbsp;类型&nbsp;<strong>#17956</strong><strong>。</strong></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　这个功能对于使用parent-child特性的人应该非常有用。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　支持分号（；）来分割&nbsp;url&nbsp;参数，与符号（&nbsp;&amp;&nbsp;）一样&nbsp;<strong>#18175</strong><strong>&nbsp;</strong>。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　比如下面这个例子：</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">curl http://localhost:9200/_cluster/health?level=indices;pretty=true</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　好吧，貌似很多，其实上面说的还只是众多特性和改进的一部分，&nbsp;es5.0&nbsp;做了非常非常多工作，本来还打算讲讲&nbsp;bug&nbsp;修复的，但是太多了，时间有限，&nbsp;一些重要的&nbsp;bug在&nbsp;2.x&nbsp;都已经第一时间解决了。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><br></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><br></p> 
   <p><font><span style="font-size:14px;">本文转自大数据躺过的坑博客园博客，原文链接：http://www.cnblogs.com/zlslch/p/6619089.html，如需转载请自行联系原作者</span></font><br></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
