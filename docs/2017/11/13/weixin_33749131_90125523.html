<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>MapReduce中的Join « NotBeCN</title>
  <meta name="description" content="             一. MR中的join的两种方式：    1.reduce side join(面试题)    reduce side join是一种最简单的join方式，其主要思想如下：    在map阶段，map函数同时读取两个文件File1和File2，为了区分两种来源的key/value对，对每...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/13/weixin_33749131_90125523.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">MapReduce中的Join</h1>
    <p class="post-meta">Nov 13, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <h1 style="font-size:28px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;">一. MR中的join的两种方式：</h1> 
   <h2 style="font-size:21px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;">1.reduce side join(面试题)</h2> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">reduce side join是一种最简单的join方式，其主要思想如下：</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">在map阶段，map函数同时读取两个文件File1和File2，为了区分两种来源的key/value对，对每条数据打一个标签（tag）,比如：tag=1表示来自文件File1，tag=2表示来自文件File2。即：map阶段的主要任务是对不同文件中的数据打标签,在shuffle阶段已经自然按key分组.</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">在reduce阶段，reduce函数获取相同k2的v2 list（v2来自File1和File2<span style="font-family:'宋体';">），</span>&nbsp;<span style="font-family:'宋体';">然后对于同一个</span>key，对File1和File2中的数据进行join（笛卡尔乘积）。即：reduce阶段进行实际的连接操作。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">这种方法有2个问题：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre><span style="color:rgb(128,0,0);font-weight:bold;font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">, map阶段没有对数据瘦身，shuffle的网络传输和排序性能很低。

</span><span style="color:rgb(128,0,0);font-weight:bold;font-size:12px;line-height:1.5;">2</span>, reduce端对2个集合做乘积计算，很耗内存，容易导致OOM。</pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">我关于reduce side join的博文总结地址：<a href="http://www.cnblogs.com/DreamDrive/p/7692042.html" rel="nofollow" style="color:#000000;">http://www.cnblogs.com/DreamDrive/p/7692042.html</a></p> 
   <h2 style="font-size:21px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;">2.map side join(面试题)</h2> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">之所以存在reduce side join，是因为在map阶段不能获取所有需要的join字段，即：同一个key对应的字段可能位于不同map中。Reduce side join是非常低效的，因为shuffle阶段要进行大量的数据传输。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">Map side join是针对以下场景进行的优化：</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">两个待连接表中，有一个表非常大，而另一个表非常小，以至于小表可以直接存放到内存中。这样，我们可以将小表复制多份，让每个map task内存中存在一份（比如存放到hash table中），</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">然后只扫描大表：对于大表中的每一条记录key/value，在hash table中查找是否有相同的key的记录，如果有，则连接后输出即可。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">为了支持文件的复制，Hadoop提供了一个类DistributedCache，使用该类的方法如下：</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">（1）用户使用静态方法DistributedCache.addCacheFile()指定要复制的文件，它的参数是文件的URI（如果是HDFS上的文件，可以这样：hdfs://namenode:9000/home/XXX/file，其中9000是自己配置的NameNode端口号）。Job在作业启动之前会获取这个URI列表，并将相应的文件拷贝到各个Container的本地磁盘上。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">（2）用户使用DistributedCache.getLocalCacheFiles()方法获取文件目录，并使用标准的文件读写API读取相应的文件。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;这种方法的局限性：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre><span style="font-size:12px;line-height:1.5;">这种方法，要使用hadoop中的DistributedCache把小数据分布到各个计算节点，每个map节点都要把小数据库加载到内存，按关键字建立索引。
这种方法有明显的局限性：有一份数据比较小，在map端，能够把它加载到内存，并进行join操作。</span></pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <h2 style="font-size:21px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;">3.针对Map Side Join 局限的解决方法：</h2> 
   <h3 style="font-size:16px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;">①使用内存服务器，扩大节点的内存空间</h3> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">针对map join，可以把一份数据存放到专门的内存服务器，在map()方法中，对每一个&lt;key,value&gt;的输入对，根据key到内存服务器中取出数据，进行连接</p> 
   <h3 style="font-size:16px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;">②使用BloomFilter过滤空连接的数据</h3> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">对其中一份数据在内存中建立BloomFilter，另外一份数据在连接之前，用BloomFilter判断它的key是否存在，如果不存在，那这个记录是空连接，可以忽略。</p> 
   <h3 style="font-size:16px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;">③使用mapreduce专为join设计的包</h3> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">在mapreduce包里看到有专门为join设计的包，对这些包还没有学习，不知道怎么使用，只是在这里记录下来，作个提醒。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>jar： mapreduce<span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">-</span>client<span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">-</span><span style="font-size:12px;line-height:1.5;">core.jar

package： org.apache.hadoop.mapreduce.lib.</span><span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">join</span></pre>
   </div> 
   <h2 style="font-size:21px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;">&nbsp;4.具体Map Side Join的使用</h2> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">有客户数据customer和订单数据orders。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong>customer</strong></p> 
   <table style="border-collapse:collapse;border-spacing:0px;border:1px solid #C0C0C0;font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <thead>
     <tr>
      <th style="border:1px solid #C0C0C0;border-collapse:collapse;">客户编号</th> 
      <th style="border:1px solid #C0C0C0;border-collapse:collapse;">姓名</th> 
      <th style="border:1px solid #C0C0C0;border-collapse:collapse;">地址</th> 
      <th style="border:1px solid #C0C0C0;border-collapse:collapse;">电话</th> 
     </tr>
    </thead>
    <tbody>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">1</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">hanmeimei</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">ShangHai</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">110</td> 
     </tr>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">2</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">leilei</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">BeiJing</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">112</td> 
     </tr>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">3</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">lucy</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">GuangZhou</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">119</td> 
     </tr>
    </tbody>
   </table>
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">** order**</p> 
   <table style="border-collapse:collapse;border-spacing:0px;border:1px solid #C0C0C0;font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <thead>
     <tr>
      <th style="border:1px solid #C0C0C0;border-collapse:collapse;">订单编号</th> 
      <th style="border:1px solid #C0C0C0;border-collapse:collapse;">客户编号</th> 
      <th style="border:1px solid #C0C0C0;border-collapse:collapse;">其它字段被忽略</th> 
     </tr>
    </thead>
    <tbody>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">1</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">1</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">50</td> 
     </tr>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">2</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">1</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">200</td> 
     </tr>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">3</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">3</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">15</td> 
     </tr>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">4</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">3</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">350</td> 
     </tr>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">5</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">3</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">58</td> 
     </tr>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">6</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">1</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">42</td> 
     </tr>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">7</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">1</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">352</td> 
     </tr>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">8</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">2</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">1135</td> 
     </tr>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">9</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">2</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">400</td> 
     </tr>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">10</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">2</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">2000</td> 
     </tr>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">11</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">2</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">300</td> 
     </tr>
    </tbody>
   </table>
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">要求对customer和orders按照客户编号进行连接，结果要求对客户编号分组，对订单编号排序，对其它字段不作要求</p> 
   <table style="border-collapse:collapse;border-spacing:0px;border:1px solid #C0C0C0;font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <thead>
     <tr>
      <th style="border:1px solid #C0C0C0;border-collapse:collapse;">客户编号</th> 
      <th style="border:1px solid #C0C0C0;border-collapse:collapse;">订单编号</th> 
      <th style="border:1px solid #C0C0C0;border-collapse:collapse;">订单金额</th> 
      <th style="border:1px solid #C0C0C0;border-collapse:collapse;">姓名</th> 
      <th style="border:1px solid #C0C0C0;border-collapse:collapse;">地址</th> 
      <th style="border:1px solid #C0C0C0;border-collapse:collapse;">电话</th> 
     </tr>
    </thead>
    <tbody>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">1</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">1</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">50</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">hanmeimei</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">ShangHai</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">110</td> 
     </tr>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">1</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">2</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">200</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">hanmeimei</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">ShangHai</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">110</td> 
     </tr>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">1</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">6</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">42</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">hanmeimei</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">ShangHai</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">110</td> 
     </tr>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">1</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">7</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">352</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">hanmeimei</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">ShangHai</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">110</td> 
     </tr>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">2</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">8</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">1135</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">leilei</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">BeiJing</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">112</td> 
     </tr>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">2</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">9</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">400</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">leilei</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">BeiJing</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">112</td> 
     </tr>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">2</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">10</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">2000</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">leilei</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">BeiJing</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">112</td> 
     </tr>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">2</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">11</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">300</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">leilei</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">BeiJing</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">112</td> 
     </tr>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">3</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">3</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">15</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">lucy</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">GuangZhou</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">119</td> 
     </tr>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">3</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">4</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">350</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">lucy</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">GuangZhou</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">119</td> 
     </tr>
     <tr>
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">3</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">5</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">58</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">lucy</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">GuangZhou</td> 
      <td style="border:1px solid #C0C0C0;border-collapse:collapse;">119</td> 
     </tr>
    </tbody>
   </table>
   <ol style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style:decimal;">在提交job的时候，把小数据通过DistributedCache分发到各个节点。</li> 
    <li style="list-style:decimal;">map端使用DistributedCache读到数据，在内存中构建映射关系--如果使用专门的内存服务器，就把数据加载到内存服务器，map()节点可以只保留一份小缓存；如果使用BloomFilter来加速，在这里就可以构建；</li> 
    <li style="list-style:decimal;">map()函数中，对每一对&lt;key,value&gt;，根据key到第2)步构建的映射里面中找出数据，进行连接，输出。</li> 
   </ol>
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">上代码：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  1</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span> MapSideJoin <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">extends</span> Configured <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">implements</span><span style="font-size:12px;line-height:1.5;"> Tool {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  2</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> customer文件在hdfs上的位置。</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  3</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">final</span> String CUSTOMER_CACHE_URL = "hdfs://hadoop1:9000/user/hadoop/mapreduce/cache/customer.txt"<span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  4</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">客户数据表对应的实体类</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  5</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;"> CustomerBean {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  6</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> custId;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  7</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span><span style="font-size:12px;line-height:1.5;"> String name;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  8</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span><span style="font-size:12px;line-height:1.5;"> String address;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  9</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span><span style="font-size:12px;line-height:1.5;"> String phone;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 10</span>         
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 11</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span><span style="font-size:12px;line-height:1.5;"> CustomerBean() {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 12</span> <span style="font-size:12px;line-height:1.5;">        }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 13</span>         
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 14</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> CustomerBean(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> custId, String name, String address,String phone) {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 15</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">super</span><span style="font-size:12px;line-height:1.5;">();
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 16</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">this</span>.custId =<span style="font-size:12px;line-height:1.5;"> custId;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 17</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">this</span>.name =<span style="font-size:12px;line-height:1.5;"> name;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 18</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">this</span>.address =<span style="font-size:12px;line-height:1.5;"> address;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 19</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">this</span>.phone =<span style="font-size:12px;line-height:1.5;"> phone;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 20</span> <span style="font-size:12px;line-height:1.5;">        }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 21</span>         
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 22</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> getCustId() {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 23</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;"> custId;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 24</span> <span style="font-size:12px;line-height:1.5;">        }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 25</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 26</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span><span style="font-size:12px;line-height:1.5;"> String getName() {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 27</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;"> name;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 28</span> <span style="font-size:12px;line-height:1.5;">        }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 29</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 30</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span><span style="font-size:12px;line-height:1.5;"> String getAddress() {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 31</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;"> address;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 32</span> <span style="font-size:12px;line-height:1.5;">        }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 33</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 34</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span><span style="font-size:12px;line-height:1.5;"> String getPhone() {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 35</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;"> phone;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 36</span> <span style="font-size:12px;line-height:1.5;">        }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 37</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 38</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">客户订单对应的实体类</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 39</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span> CustOrderMapOutKey <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">implements</span> WritableComparable&lt;CustOrderMapOutKey&gt;<span style="font-size:12px;line-height:1.5;"> {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 40</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> custId;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 41</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> orderId;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 42</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 43</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> set(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> custId, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> orderId) {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 44</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">this</span>.custId =<span style="font-size:12px;line-height:1.5;"> custId;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 45</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">this</span>.orderId =<span style="font-size:12px;line-height:1.5;"> orderId;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 46</span> <span style="font-size:12px;line-height:1.5;">        }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 47</span>         
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 48</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> getCustId() {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 49</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;"> custId;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 50</span> <span style="font-size:12px;line-height:1.5;">        }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 51</span>         
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 52</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> getOrderId() {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 53</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;"> orderId;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 54</span> <span style="font-size:12px;line-height:1.5;">        }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 55</span>         
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 56</span> <span style="font-size:12px;line-height:1.5;">        @Override
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 57</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> write(DataOutput out) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> IOException {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 58</span> <span style="font-size:12px;line-height:1.5;">            out.writeInt(custId);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 59</span> <span style="font-size:12px;line-height:1.5;">            out.writeInt(orderId);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 60</span> <span style="font-size:12px;line-height:1.5;">        }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 61</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 62</span> <span style="font-size:12px;line-height:1.5;">        @Override
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 63</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> readFields(DataInput in) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> IOException {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 64</span>             custId =<span style="font-size:12px;line-height:1.5;"> in.readInt();
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 65</span>             orderId =<span style="font-size:12px;line-height:1.5;"> in.readInt();
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 66</span> <span style="font-size:12px;line-height:1.5;">        }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 67</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 68</span> <span style="font-size:12px;line-height:1.5;">        @Override
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 69</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> compareTo(CustOrderMapOutKey o) {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 70</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> res =<span style="font-size:12px;line-height:1.5;"> Integer.compare(custId, o.custId);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 71</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> res == 0 ?<span style="font-size:12px;line-height:1.5;"> Integer.compare(orderId, o.orderId) : res;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 72</span> <span style="font-size:12px;line-height:1.5;">        }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 73</span>         
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 74</span> <span style="font-size:12px;line-height:1.5;">        @Override
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 75</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">boolean</span><span style="font-size:12px;line-height:1.5;"> equals(Object obj) {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 76</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (obj <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">instanceof</span><span style="font-size:12px;line-height:1.5;"> CustOrderMapOutKey) {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 77</span>                 CustOrderMapOutKey o =<span style="font-size:12px;line-height:1.5;"> (CustOrderMapOutKey)obj;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 78</span>                 <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> custId == o.custId &amp;&amp; orderId ==<span style="font-size:12px;line-height:1.5;"> o.orderId;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 79</span>             } <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">else</span><span style="font-size:12px;line-height:1.5;"> {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 80</span>                 <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">false</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 81</span> <span style="font-size:12px;line-height:1.5;">            }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 82</span> <span style="font-size:12px;line-height:1.5;">        }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 83</span>         
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 84</span> <span style="font-size:12px;line-height:1.5;">        @Override
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 85</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span><span style="font-size:12px;line-height:1.5;"> String toString() {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 86</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> custId + "\t" +<span style="font-size:12px;line-height:1.5;"> orderId;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 87</span> <span style="font-size:12px;line-height:1.5;">        }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 88</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 89</span>     
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 90</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span> JoinMapper <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">extends</span> Mapper&lt;LongWritable, Text, CustOrderMapOutKey, Text&gt;<span style="font-size:12px;line-height:1.5;"> {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 91</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">final</span> CustOrderMapOutKey outputKey = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> CustOrderMapOutKey();
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 92</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">final</span> Text outputValue = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> Text();
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 93</span>         <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/**</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 94</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">         * 把表中每一行的客户信息封装成一个Map，存储在内存中
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 95</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">         * Map的key是客户的id，value是封装的客户bean对象
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 96</span>          <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 97</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">final</span> Map&lt;Integer, CustomerBean&gt; CUSTOMER_MAP = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> HashMap&lt;Integer, Join.CustomerBean&gt;<span style="font-size:12px;line-height:1.5;">();
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 98</span> <span style="font-size:12px;line-height:1.5;">        @Override
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 99</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">protected</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> map(LongWritable key, Text value, Context context) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> IOException, InterruptedException {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">100</span>             <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 格式: 订单编   客户编号    订单金额</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">101</span>             String[] cols = value.toString().split("\t"<span style="font-size:12px;line-height:1.5;">);           
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">102</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (cols.length &lt; 3<span style="font-size:12px;line-height:1.5;">) {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">103</span>                 <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">104</span> <span style="font-size:12px;line-height:1.5;">            }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">105</span>             
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">106</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> custId = Integer.parseInt(cols[1]);<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 取出客户编号</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">107</span>             CustomerBean customerBean =<span style="font-size:12px;line-height:1.5;"> CUSTOMER_MAP.get(custId);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">108</span>             
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">109</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (customerBean == <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span>) {<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 没有对应的customer信息可以连接</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">110</span>                 <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">111</span> <span style="font-size:12px;line-height:1.5;">            }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">112</span>             
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">113</span>             StringBuffer sb = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> StringBuffer();
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">114</span>             sb.append(cols[2]).append("\t"<span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">115</span>                 .append(customerBean.getName()).append("\t"<span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">116</span>                 .append(customerBean.getAddress()).append("\t"<span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">117</span> <span style="font-size:12px;line-height:1.5;">                .append(customerBean.getPhone());
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">118</span> <span style="font-size:12px;line-height:1.5;">            outputValue.set(sb.toString());
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">119</span>             outputKey.set(custId, Integer.parseInt(cols[0<span style="font-size:12px;line-height:1.5;">]));
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">120</span> <span style="font-size:12px;line-height:1.5;">            context.write(outputKey, outputValue);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">121</span> <span style="font-size:12px;line-height:1.5;">        }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">122</span>         
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">123</span>         <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">在Mapper方法执行前执行</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">124</span> <span style="font-size:12px;line-height:1.5;">        @Override
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">125</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">protected</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> setup(Context context) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> IOException, InterruptedException {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">126</span>             FileSystem fs =<span style="font-size:12px;line-height:1.5;"> FileSystem.get(URI.create(CUSTOMER_CACHE_URL), context.getConfiguration());
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">127</span>             FSDataInputStream fdis = fs.open(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> Path(CUSTOMER_CACHE_URL));
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">128</span>             
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">129</span>             BufferedReader reader = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> BufferedReader(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> InputStreamReader(fdis));
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">130</span>             String line = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">131</span>             String[] cols = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">132</span>             
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">133</span>             <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 格式：客户编号  姓名  地址  电话</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">134</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">while</span> ((line = reader.readLine()) != <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">) {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">135</span>                 cols = line.split("\t"<span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">136</span>                 <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (cols.length &lt; 4) {<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 数据格式不匹配，忽略</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">137</span>                     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">continue</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">138</span> <span style="font-size:12px;line-height:1.5;">                }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">139</span>                 CustomerBean bean = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> CustomerBean(Integer.parseInt(cols[0]), cols[1], cols[2], cols[3<span style="font-size:12px;line-height:1.5;">]);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">140</span> <span style="font-size:12px;line-height:1.5;">                CUSTOMER_MAP.put(bean.getCustId(), bean);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">141</span> <span style="font-size:12px;line-height:1.5;">            }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">142</span> <span style="font-size:12px;line-height:1.5;">        }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">143</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">144</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">145</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/**</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">146</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">     * reduce
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">147</span>      <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">148</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span> JoinReducer <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">extends</span> Reducer&lt;CustOrderMapOutKey, Text, CustOrderMapOutKey, Text&gt;<span style="font-size:12px;line-height:1.5;"> {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">149</span> <span style="font-size:12px;line-height:1.5;">        @Override
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">150</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">protected</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> reduce(CustOrderMapOutKey key, Iterable&lt;Text&gt; values, Context context) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> IOException, InterruptedException {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">151</span>             <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 什么事都不用做，直接输出</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">152</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span><span style="font-size:12px;line-height:1.5;"> (Text value : values) {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">153</span> <span style="font-size:12px;line-height:1.5;">                context.write(key, value);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">154</span> <span style="font-size:12px;line-height:1.5;">            }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">155</span> <span style="font-size:12px;line-height:1.5;">        }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">156</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">157</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/**</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">158</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">     * </span><span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">@param</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> args
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">159</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">     * </span><span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">@throws</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Exception
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">160</span>      <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">161</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> main(String[] args) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> Exception {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">162</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (args.length &lt; 2<span style="font-size:12px;line-height:1.5;">) {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">163</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> IllegalArgumentException("Usage: &lt;inpath&gt; &lt;outpath&gt;"<span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">164</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">165</span> <span style="font-size:12px;line-height:1.5;">        }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">166</span>         ToolRunner.run(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> Configuration(), <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> Join(), args);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">167</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">168</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">169</span> <span style="font-size:12px;line-height:1.5;">    @Override
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">170</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> run(String[] args) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> Exception {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">171</span>         Configuration conf =<span style="font-size:12px;line-height:1.5;"> getConf();
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">172</span>         Job job = Job.getInstance(conf, Join.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;">.getSimpleName());
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">173</span>         job.setJarByClass(SecondarySortMapReduce.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">174</span>         
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">175</span>         <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 添加customer cache文件</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">176</span> <span style="font-size:12px;line-height:1.5;">        job.addCacheFile(URI.create(CUSTOMER_CACHE_URL));
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">177</span>         
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">178</span>         FileInputFormat.addInputPath(job, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> Path(args[0<span style="font-size:12px;line-height:1.5;">]));
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">179</span>         FileOutputFormat.setOutputPath(job, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> Path(args[1<span style="font-size:12px;line-height:1.5;">]));
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">180</span>         
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">181</span>         <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> map settings</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">182</span>         job.setMapperClass(JoinMapper.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">183</span>         job.setMapOutputKeyClass(CustOrderMapOutKey.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">184</span>         job.setMapOutputValueClass(Text.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">185</span>         
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">186</span>         <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> reduce settings</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">187</span>         job.setReducerClass(JoinReducer.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">188</span>         job.setOutputKeyClass(CustOrderMapOutKey.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">189</span>         job.setOutputKeyClass(Text.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">190</span>         
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">191</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">boolean</span> res = job.waitForCompletion(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">true</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">192</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> res ? 0 : 1<span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">193</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">194</span> }</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">上面的代码没有使用DistributedCache类：</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">5.Map Side Join的再一个例子：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  1</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> java.io.BufferedReader;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  2</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> java.io.FileReader;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  3</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> java.io.IOException;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  4</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> java.util.HashMap;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  5</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.conf.Configuration;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  6</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.conf.Configured;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  7</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.filecache.DistributedCache;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  8</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.fs.Path;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  9</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.io.Text;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 10</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.mapreduce.Job;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 11</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.mapreduce.Mapper;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 12</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 13</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.mapreduce.lib.input.TextInputFormat;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 14</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 15</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.mapreduce.lib.output.TextOutputFormat;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 16</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.util.Tool;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 17</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.util.ToolRunner;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 18</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.slf4j.Logger;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 19</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.slf4j.LoggerFactory;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 20</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/**</span>   
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 21</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 用途说明：   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 22</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * Map side join中的left outer join   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 23</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 左连接，两个文件分别代表2个表,连接字段table1的id字段和table2的cityID字段   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 24</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * table1(左表):tb_dim_city
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 25</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * (id int,name string,orderid int,city_code int,is_show int)，   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 26</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 假设tb_dim_city文件记录数很少
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 27</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * tb_dim_city.dat文件内容,分隔符为"|"：   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 28</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * id     name  orderid  city_code  is_show   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 29</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 0       其他        9999     9999         0   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 30</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 1       长春        1        901          1   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 31</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 2       吉林        2        902          1   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 32</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 3       四平        3        903          1   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 33</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 4       松原        4        904          1   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 34</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 5       通化        5        905          1   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 35</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 6       辽源        6        906          1   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 36</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 7       白城        7        907          1   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 37</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 8       白山        8        908          1   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 38</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 9       延吉        9        909          1   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 39</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * -------------------------风骚的分割线-------------------------------   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 40</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * table2(右表)：tb_user_profiles
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 41</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * (userID int,userName string,network string,flow double,cityID int)   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 42</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * tb_user_profiles.dat文件内容,分隔符为"|"：   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 43</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * userID   network     flow    cityID   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 44</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 1           2G       123      1   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 45</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 2           3G       333      2   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 46</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 3           3G       555      1   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 47</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 4           2G       777      3   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 48</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 5           3G       666      4   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 49</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * ..................................
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 50</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * ..................................
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 51</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * -------------------------风骚的分割线-------------------------------   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 52</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> *  结果：   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 53</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> *  1   长春  1   901 1   1   2G  123   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 54</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> *  1   长春  1   901 1   3   3G  555   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 55</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> *  2   吉林  2   902 1   2   3G  333   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 56</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> *  3   四平  3   903 1   4   2G  777   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 57</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> *  4   松原  4   904 1   5   3G  666   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 58</span>  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 59</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span> MapSideJoinMain <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">extends</span> Configured <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">implements</span><span style="font-size:12px;line-height:1.5;"> Tool{   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 60</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">final</span> Logger logger = LoggerFactory.getLogger(MapSideJoinMain.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 61</span>     
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 62</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span> LeftOutJoinMapper <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">extends</span> Mapper&lt;Object, Text, Text, Text&gt;<span style="font-size:12px;line-height:1.5;"> {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 63</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> HashMap&lt;String,String&gt; city_infoMap = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> HashMap&lt;String, String&gt;<span style="font-size:12px;line-height:1.5;">();   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 64</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> Text outPutKey = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> Text();   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 65</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> Text outPutValue = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> Text();   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 66</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> String mapInputStr = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 67</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> String mapInputSpit[] = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 68</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> String city_secondPart = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 69</span>         <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/**</span>   
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 70</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">         * 此方法在每个task开始之前执行，这里主要用作从DistributedCache   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 71</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">         * 中取到tb_dim_city文件，并将里边记录取出放到内存中。   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 72</span>          <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 73</span> <span style="font-size:12px;line-height:1.5;">        @Override 
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 74</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">protected</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> setup(Context context) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> IOException, InterruptedException {   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 75</span>             BufferedReader br = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 76</span>             <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">获得当前作业的DistributedCache相关文件   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 77</span>             Path[] distributePaths =<span style="font-size:12px;line-height:1.5;"> DistributedCache.getLocalCacheFiles(context.getConfiguration());   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 78</span>             String cityInfo = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 79</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span><span style="font-size:12px;line-height:1.5;">(Path p : distributePaths){   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 80</span>                 <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(p.toString().endsWith("tb_dim_city.dat"<span style="font-size:12px;line-height:1.5;">)){   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 81</span>                     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">读缓存文件，并放到mem中   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 82</span>                     br = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> BufferedReader(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> FileReader(p.toString()));   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 83</span>                     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">while</span>(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span>!=(cityInfo=<span style="font-size:12px;line-height:1.5;">br.readLine())){   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 84</span>                         String[] cityPart = cityInfo.split("\\|",5<span style="font-size:12px;line-height:1.5;">);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 85</span>                         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(cityPart.length ==5<span style="font-size:12px;line-height:1.5;">){   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 86</span>                             city_infoMap.put(cityPart[0], cityPart[1]+"\t"+cityPart[2]+"\t"+cityPart[3]+"\t"+cityPart[4<span style="font-size:12px;line-height:1.5;">]);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 87</span> <span style="font-size:12px;line-height:1.5;">                        }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 88</span> <span style="font-size:12px;line-height:1.5;">                    }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 89</span> <span style="font-size:12px;line-height:1.5;">                }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 90</span> <span style="font-size:12px;line-height:1.5;">            }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 91</span> <span style="font-size:12px;line-height:1.5;">        }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 92</span>  
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 93</span>         <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/**</span>   
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 94</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">         * Map端的实现相当简单，直接判断tb_user_profiles.dat中的   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 95</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">         * cityID是否存在我的map中就ok了，这样就可以实现Map Join了   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 96</span>          <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 97</span> <span style="font-size:12px;line-height:1.5;">        @Override 
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 98</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">protected</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> map(Object key, Text value, Context context) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> IOException, InterruptedException {   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 99</span>             <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">排掉空行   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">100</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(value == <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span> || value.toString().equals(""<span style="font-size:12px;line-height:1.5;">)){   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">101</span>                 <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;">;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">102</span> <span style="font-size:12px;line-height:1.5;">            }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">103</span>             mapInputStr =<span style="font-size:12px;line-height:1.5;"> value.toString();   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">104</span>             mapInputSpit = mapInputStr.split("\\|",4<span style="font-size:12px;line-height:1.5;">);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">105</span>             <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">过滤非法记录   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">106</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(mapInputSpit.length != 4<span style="font-size:12px;line-height:1.5;">){   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">107</span>                 <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;">;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">108</span> <span style="font-size:12px;line-height:1.5;">            }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">109</span>             <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">判断链接字段是否在map中存在   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">110</span>             city_secondPart = city_infoMap.get(mapInputSpit[3<span style="font-size:12px;line-height:1.5;">]);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">111</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(city_secondPart != <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">){   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">112</span>                 <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">this</span>.outPutKey.set(mapInputSpit[3<span style="font-size:12px;line-height:1.5;">]);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">113</span>                 <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">this</span>.outPutValue.set(city_secondPart+"\t"+mapInputSpit[0]+"\t"+mapInputSpit[1]+"\t"+mapInputSpit[2<span style="font-size:12px;line-height:1.5;">]);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">114</span> <span style="font-size:12px;line-height:1.5;">                context.write(outPutKey, outPutValue);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">115</span> <span style="font-size:12px;line-height:1.5;">            }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">116</span> <span style="font-size:12px;line-height:1.5;">        }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">117</span> <span style="font-size:12px;line-height:1.5;">    }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">118</span> <span style="font-size:12px;line-height:1.5;">    @Override 
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">119</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> run(String[] args) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> Exception {   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">120</span>             Configuration conf=getConf(); <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">获得配置文件对象   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">121</span>             DistributedCache.addCacheFile(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> Path(args[1]).toUri(), conf);<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">为该job添加缓存文件   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">122</span>             Job job=<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> Job(conf,"MapJoinMR"<span style="font-size:12px;line-height:1.5;">);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">123</span>             job.setNumReduceTasks(0<span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">124</span>  
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">125</span>             FileInputFormat.addInputPath(job, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> Path(args[0])); <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">设置map输入文件路径   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">126</span>             FileOutputFormat.setOutputPath(job, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> Path(args[2])); <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">设置reduce输出文件路径</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">127</span>  
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">128</span>             job.setJarByClass(MapSideJoinMain.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;">);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">129</span>             job.setMapperClass(LeftOutJoinMapper.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">130</span>  
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">131</span>             job.setInputFormatClass(TextInputFormat.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span>); <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">设置文件输入格式   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">132</span>             job.setOutputFormatClass(TextOutputFormat.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span>);<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">使用默认的output格式
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">133</span>  
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">134</span>             <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">设置map的输出key和value类型   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">135</span>             job.setMapOutputKeyClass(Text.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">136</span>  
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">137</span>             <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">设置reduce的输出key和value类型   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">138</span>             job.setOutputKeyClass(Text.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;">);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">139</span>             job.setOutputValueClass(Text.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;">);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">140</span>             job.waitForCompletion(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">true</span><span style="font-size:12px;line-height:1.5;">);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">141</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> job.isSuccessful()?0:1<span style="font-size:12px;line-height:1.5;">;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">142</span> <span style="font-size:12px;line-height:1.5;">    }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">143</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> main(String[] args) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> IOException, ClassNotFoundException, InterruptedException {   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">144</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">try</span><span style="font-size:12px;line-height:1.5;"> {   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">145</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> returnCode = ToolRunner.run(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> MapSideJoinMain(),args);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">146</span> <span style="font-size:12px;line-height:1.5;">            System.exit(returnCode);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">147</span>         } <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">catch</span><span style="font-size:12px;line-height:1.5;"> (Exception e) {   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">148</span> <span style="font-size:12px;line-height:1.5;">            logger.error(e.getMessage());   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">149</span> <span style="font-size:12px;line-height:1.5;">        }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">150</span> <span style="font-size:12px;line-height:1.5;">    }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">151</span> } </pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <h2 style="font-size:21px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;">&nbsp;6.<strong>SemiJoin</strong> </h2> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;SemiJoin就是所谓的半连接，其实仔细一看就是reduce join的一个变种，就是在map端过滤掉一些数据，在网络中只传输参与连接的数据不参与连接的数据不必在网络中进行传输，从而减少了shuffle的网络传输量，使整体效率得到提高，其他思想和reduce join是一模一样的。说得更加接地气一点就是将小表中参与join的key单独抽出来通过DistributedCach分发到相关节点，然后将其取出放到内存中（可以放到HashSet中），在map阶段扫描连接表，将join key不在内存HashSet中的记录过滤掉，让那些参与join的记录通过shuffle传输到reduce端进行join操作，其他的和reduce join都是一样的。看代码：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  1</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> java.io.BufferedReader;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  2</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> java.io.FileReader;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  3</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> java.io.IOException;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  4</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> java.util.ArrayList;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  5</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> java.util.HashSet;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  6</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.conf.Configuration;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  7</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.conf.Configured;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  8</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.filecache.DistributedCache;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  9</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.fs.Path;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 10</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.io.Text;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 11</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.mapreduce.Job;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 12</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.mapreduce.Mapper;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 13</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.mapreduce.Reducer;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 14</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 15</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.mapreduce.lib.input.FileSplit;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 16</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.mapreduce.lib.input.TextInputFormat;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 17</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 18</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.mapreduce.lib.output.TextOutputFormat;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 19</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.util.Tool;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 20</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.apache.hadoop.util.ToolRunner;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 21</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.slf4j.Logger;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 22</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> org.slf4j.LoggerFactory;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 23</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/**</span>   
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 24</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * </span><span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">@author</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> zengzhaozheng   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 25</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> *   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 26</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 用途说明：   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 27</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * reudce side join中的left outer join   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 28</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 左连接，两个文件分别代表2个表,连接字段table1的id字段和table2的cityID字段   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 29</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * table1(左表):tb_dim_city
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 30</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * (id int,name string,orderid int,city_code,is_show)   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 31</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * tb_dim_city.dat文件内容,分隔符为"|"：   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 32</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * id     name  orderid  city_code  is_show   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 33</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 0       其他        9999     9999         0   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 34</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 1       长春        1        901          1   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 35</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 2       吉林        2        902          1   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 36</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 3       四平        3        903          1   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 37</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 4       松原        4        904          1   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 38</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 5       通化        5        905          1   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 39</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 6       辽源        6        906          1   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 40</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 7       白城        7        907          1   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 41</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 8       白山        8        908          1   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 42</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 9       延吉        9        909          1   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 43</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * -------------------------风骚的分割线-------------------------------   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 44</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * table2(右表)：tb_user_profiles(userID int,userName string,network string,double flow,cityID int)   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 45</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * tb_user_profiles.dat文件内容,分隔符为"|"：   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 46</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * userID   network     flow    cityID   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 47</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 1           2G       123      1   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 48</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 2           3G       333      2   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 49</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 3           3G       555      1   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 50</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 4           2G       777      3   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 51</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 5           3G       666      4   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 52</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * ..................................
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 53</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * ..................................
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 54</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * -------------------------风骚的分割线-------------------------------   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 55</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * joinKey.dat内容：   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 56</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * city_code   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 57</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 1   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 58</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 2   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 59</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 3   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 60</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * 4   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 61</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> * -------------------------风骚的分割线-------------------------------   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 62</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> *  结果：   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 63</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> *  1   长春  1   901 1   1   2G  123   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 64</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> *  1   长春  1   901 1   3   3G  555   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 65</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> *  2   吉林  2   902 1   2   3G  333   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 66</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> *  3   四平  3   903 1   4   2G  777   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 67</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> *  4   松原  4   904 1   5   3G  666   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 68</span>  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 69</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span> SemiJoin <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">extends</span> Configured <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">implements</span><span style="font-size:12px;line-height:1.5;"> Tool{   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 70</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">final</span> Logger logger = LoggerFactory.getLogger(SemiJoin.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;">);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 71</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span> SemiJoinMapper <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">extends</span> Mapper&lt;Object, Text, Text, CombineValues&gt;<span style="font-size:12px;line-height:1.5;"> {   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 72</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> CombineValues combineValues = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> CombineValues();   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 73</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> HashSet&lt;String&gt; joinKeySet = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> HashSet&lt;String&gt;<span style="font-size:12px;line-height:1.5;">();   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 74</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> Text flag = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> Text();   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 75</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> Text joinKey = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> Text();   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 76</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> Text secondPart = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> Text();   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 77</span>         <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/**</span>   
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 78</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">         * 将参加join的key从DistributedCache取出放到内存中，以便在map端将要参加join的key过滤出来。b   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 79</span>          <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 80</span> <span style="font-size:12px;line-height:1.5;">        @Override 
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 81</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">protected</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> setup(Context context) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> IOException, InterruptedException {   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 82</span>             BufferedReader br = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 83</span>             <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">获得当前作业的DistributedCache相关文件   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 84</span>             Path[] distributePaths =<span style="font-size:12px;line-height:1.5;"> DistributedCache.getLocalCacheFiles(context.getConfiguration());   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 85</span>             String joinKeyStr = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 86</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span><span style="font-size:12px;line-height:1.5;">(Path p : distributePaths){   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 87</span>                 <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(p.toString().endsWith("joinKey.dat"<span style="font-size:12px;line-height:1.5;">)){   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 88</span>                     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">读缓存文件，并放到mem中   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 89</span>                     br = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> BufferedReader(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> FileReader(p.toString()));   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 90</span>                     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">while</span>(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span>!=(joinKeyStr=<span style="font-size:12px;line-height:1.5;">br.readLine())){   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 91</span> <span style="font-size:12px;line-height:1.5;">                        joinKeySet.add(joinKeyStr);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 92</span> <span style="font-size:12px;line-height:1.5;">                    }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 93</span> <span style="font-size:12px;line-height:1.5;">                }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 94</span> <span style="font-size:12px;line-height:1.5;">            }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 95</span> <span style="font-size:12px;line-height:1.5;">        }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 96</span> <span style="font-size:12px;line-height:1.5;">        @Override 
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 97</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">protected</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> map(Object key, Text value, Context context) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> IOException, InterruptedException {   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 98</span>             <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">获得文件输入路径   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 99</span>             String pathName =<span style="font-size:12px;line-height:1.5;"> ((FileSplit) context.getInputSplit()).getPath().toString();   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">100</span>             <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">数据来自tb_dim_city.dat文件,标志即为"0"   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">101</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(pathName.endsWith("tb_dim_city.dat"<span style="font-size:12px;line-height:1.5;">)){   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">102</span>                 String[] valueItems = value.toString().split("\\|"<span style="font-size:12px;line-height:1.5;">);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">103</span>                 <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">过滤格式错误的记录   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">104</span>                 <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(valueItems.length != 5<span style="font-size:12px;line-height:1.5;">){   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">105</span>                     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;">;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">106</span> <span style="font-size:12px;line-height:1.5;">                }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">107</span>                 <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">过滤掉不需要参加join的记录   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">108</span>                 <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(joinKeySet.contains(valueItems[0<span style="font-size:12px;line-height:1.5;">])){   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">109</span>                     flag.set("0"<span style="font-size:12px;line-height:1.5;">);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">110</span>                     joinKey.set(valueItems[0<span style="font-size:12px;line-height:1.5;">]);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">111</span>                     secondPart.set(valueItems[1]+"\t"+valueItems[2]+"\t"+valueItems[3]+"\t"+valueItems[4<span style="font-size:12px;line-height:1.5;">]);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">112</span> <span style="font-size:12px;line-height:1.5;">                    combineValues.setFlag(flag);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">113</span> <span style="font-size:12px;line-height:1.5;">                    combineValues.setJoinKey(joinKey);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">114</span> <span style="font-size:12px;line-height:1.5;">                    combineValues.setSecondPart(secondPart);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">115</span> <span style="font-size:12px;line-height:1.5;">                    context.write(combineValues.getJoinKey(), combineValues);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">116</span>                 }<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">else</span><span style="font-size:12px;line-height:1.5;">{   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">117</span>                     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;"> ;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">118</span> <span style="font-size:12px;line-height:1.5;">                }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">119</span>             }<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">数据来自于tb_user_profiles.dat，标志即为"1"   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">120</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">else</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(pathName.endsWith("tb_user_profiles.dat"<span style="font-size:12px;line-height:1.5;">)){   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">121</span>                 String[] valueItems = value.toString().split("\\|"<span style="font-size:12px;line-height:1.5;">);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">122</span>                 <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">过滤格式错误的记录   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">123</span>                 <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(valueItems.length != 4<span style="font-size:12px;line-height:1.5;">){   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">124</span>                     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;">;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">125</span> <span style="font-size:12px;line-height:1.5;">                }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">126</span>                 <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">过滤掉不需要参加join的记录   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">127</span>                 <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(joinKeySet.contains(valueItems[3<span style="font-size:12px;line-height:1.5;">])){   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">128</span>                     flag.set("1"<span style="font-size:12px;line-height:1.5;">);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">129</span>                     joinKey.set(valueItems[3<span style="font-size:12px;line-height:1.5;">]);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">130</span>                     secondPart.set(valueItems[0]+"\t"+valueItems[1]+"\t"+valueItems[2<span style="font-size:12px;line-height:1.5;">]);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">131</span> <span style="font-size:12px;line-height:1.5;">                    combineValues.setFlag(flag);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">132</span> <span style="font-size:12px;line-height:1.5;">                    combineValues.setJoinKey(joinKey);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">133</span> <span style="font-size:12px;line-height:1.5;">                    combineValues.setSecondPart(secondPart);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">134</span> <span style="font-size:12px;line-height:1.5;">                    context.write(combineValues.getJoinKey(), combineValues);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">135</span>                 }<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">else</span><span style="font-size:12px;line-height:1.5;">{   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">136</span>                     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;"> ;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">137</span> <span style="font-size:12px;line-height:1.5;">                }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">138</span> <span style="font-size:12px;line-height:1.5;">            }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">139</span> <span style="font-size:12px;line-height:1.5;">        }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">140</span> <span style="font-size:12px;line-height:1.5;">    }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">141</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span> SemiJoinReducer <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">extends</span> Reducer&lt;Text, CombineValues, Text, Text&gt;<span style="font-size:12px;line-height:1.5;"> {   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">142</span>         <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">存储一个分组中的左表信息   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">143</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> ArrayList&lt;Text&gt; leftTable = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> ArrayList&lt;Text&gt;<span style="font-size:12px;line-height:1.5;">();   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">144</span>         <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">存储一个分组中的右表信息   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">145</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> ArrayList&lt;Text&gt; rightTable = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> ArrayList&lt;Text&gt;<span style="font-size:12px;line-height:1.5;">();   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">146</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> Text secondPar = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">147</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> Text output = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> Text();   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">148</span>         <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/**</span>   
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">149</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">         * 一个分组调用一次reduce函数   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">150</span>          <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">151</span> <span style="font-size:12px;line-height:1.5;">        @Override 
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">152</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">protected</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> reduce(Text key, Iterable&lt;CombineValues&gt; value, Context context) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> IOException, InterruptedException {   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">153</span> <span style="font-size:12px;line-height:1.5;">            leftTable.clear();   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">154</span> <span style="font-size:12px;line-height:1.5;">            rightTable.clear();   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">155</span>             <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/**</span>   
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">156</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">             * 将分组中的元素按照文件分别进行存放   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">157</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">             * 这种方法要注意的问题：   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">158</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">             * 如果一个分组内的元素太多的话，可能会导致在reduce阶段出现OOM，   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">159</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">             * 在处理分布式问题之前最好先了解数据的分布情况，根据不同的分布采取最   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">160</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">             * 适当的处理方法，这样可以有效的防止导致OOM和数据过度倾斜问题。   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">161</span>              <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">162</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span><span style="font-size:12px;line-height:1.5;">(CombineValues cv : value){   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">163</span>                 secondPar = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> Text(cv.getSecondPart().toString());   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">164</span>                 <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">左表tb_dim_city   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">165</span>                 <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>("0"<span style="font-size:12px;line-height:1.5;">.equals(cv.getFlag().toString().trim())){   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">166</span> <span style="font-size:12px;line-height:1.5;">                    leftTable.add(secondPar);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">167</span> <span style="font-size:12px;line-height:1.5;">                }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">168</span>                 <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">右表tb_user_profiles   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">169</span>                 <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">else</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>("1"<span style="font-size:12px;line-height:1.5;">.equals(cv.getFlag().toString().trim())){   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">170</span> <span style="font-size:12px;line-height:1.5;">                    rightTable.add(secondPar);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">171</span> <span style="font-size:12px;line-height:1.5;">                }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">172</span> <span style="font-size:12px;line-height:1.5;">            }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">173</span>             logger.info("tb_dim_city:"+<span style="font-size:12px;line-height:1.5;">leftTable.toString());   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">174</span>             logger.info("tb_user_profiles:"+<span style="font-size:12px;line-height:1.5;">rightTable.toString());   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">175</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span><span style="font-size:12px;line-height:1.5;">(Text leftPart : leftTable){   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">176</span>                 <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span><span style="font-size:12px;line-height:1.5;">(Text rightPart : rightTable){   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">177</span>                     output.set(leftPart+ "\t" +<span style="font-size:12px;line-height:1.5;"> rightPart);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">178</span> <span style="font-size:12px;line-height:1.5;">                    context.write(key, output);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">179</span> <span style="font-size:12px;line-height:1.5;">                }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">180</span> <span style="font-size:12px;line-height:1.5;">            }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">181</span> <span style="font-size:12px;line-height:1.5;">        }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">182</span> <span style="font-size:12px;line-height:1.5;">    }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">183</span> <span style="font-size:12px;line-height:1.5;">    @Override 
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">184</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> run(String[] args) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> Exception {   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">185</span>             Configuration conf=getConf(); <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">获得配置文件对象   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">186</span>             DistributedCache.addCacheFile(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> Path(args[2<span style="font-size:12px;line-height:1.5;">]).toUri(), conf);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">187</span>             Job job=<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> Job(conf,"LeftOutJoinMR"<span style="font-size:12px;line-height:1.5;">);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">188</span>             job.setJarByClass(SemiJoin.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">189</span>  
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">190</span>             FileInputFormat.addInputPath(job, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> Path(args[0])); <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">设置map输入文件路径   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">191</span>             FileOutputFormat.setOutputPath(job, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> Path(args[1])); <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">设置reduce输出文件路径</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">192</span>  
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">193</span>             job.setMapperClass(SemiJoinMapper.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;">);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">194</span>             job.setReducerClass(SemiJoinReducer.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">195</span>  
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">196</span>             job.setInputFormatClass(TextInputFormat.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span>); <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">设置文件输入格式   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">197</span>             job.setOutputFormatClass(TextOutputFormat.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span>);<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">使用默认的output格式
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">198</span>  
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">199</span>             <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">设置map的输出key和value类型   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">200</span>             job.setMapOutputKeyClass(Text.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;">);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">201</span>             job.setMapOutputValueClass(CombineValues.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">202</span>  
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">203</span>             <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">设置reduce的输出key和value类型   </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">204</span>             job.setOutputKeyClass(Text.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;">);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">205</span>             job.setOutputValueClass(Text.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;">);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">206</span>             job.waitForCompletion(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">true</span><span style="font-size:12px;line-height:1.5;">);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">207</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> job.isSuccessful()?0:1<span style="font-size:12px;line-height:1.5;">;   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">208</span> <span style="font-size:12px;line-height:1.5;">    }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">209</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> main(String[] args) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> IOException, ClassNotFoundException, InterruptedException {   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">210</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">try</span><span style="font-size:12px;line-height:1.5;"> {   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">211</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> returnCode =  ToolRunner.run(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> SemiJoin(),args);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">212</span> <span style="font-size:12px;line-height:1.5;">            System.exit(returnCode);   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">213</span>         } <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">catch</span><span style="font-size:12px;line-height:1.5;"> (Exception e) {   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">214</span> <span style="font-size:12px;line-height:1.5;">            logger.error(e.getMessage());   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">215</span> <span style="font-size:12px;line-height:1.5;">        }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">216</span> <span style="font-size:12px;line-height:1.5;">    }   
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">217</span> } </pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">这里还说说SemiJoin也是有一定的适用范围的，其抽取出来进行join的key是要放到内存中的，所以不能够太大，容易在Map端造成OOM。</p> 
   <h1 style="font-size:28px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;"><strong>二、总结</strong></h1> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">blog介绍了三种join方式。这三种join方式适用于不同的场景，其处理效率上的相差还是蛮大的，其中主要导致因素是网络传输。Map join效率最高，其次是SemiJoin，最低的是reduce join。另外，写分布式大数据处理程序的时最好要对整体要处理的数据分布情况作一个了解，这可以提高我们代码的效率，使数据的倾斜度降到最低，使我们的代码倾向性更好。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><br></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><br></p> 
   <p><font><span style="font-size:14px;">本文转自SummerChill博客园博客，原文链接：http://www.cnblogs.com/DreamDrive/p/7692618.html，如需转载请自行联系原作者</span></font><br></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
