<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>理解 OpenStack + Ceph （5）：OpenStack 与 Ceph 之间的集成 [OpenStack Integration with Ceph]... « NotBeCN</title>
  <meta name="description" content="             理解 OpenStack + Ceph 系列文章：    （1）安装和部署    （2）Ceph RBD 接口和工具    （3）Ceph 物理和逻辑结构    （4）Ceph 的基础数据结构    （5）Ceph 与 OpenStack 集成的实现    （6）QEMU-KVM 和 C...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/13/weixin_34356310_90124903.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">理解 OpenStack + Ceph （5）：OpenStack 与 Ceph 之间的集成 [OpenStack Integration with Ceph]...</h1>
    <p class="post-meta">Nov 13, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">理解 OpenStack + Ceph 系列文章：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）<a href="http://www.cnblogs.com/sammyliu/p/4804037.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">安装和部署</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）<a href="http://www.cnblogs.com/sammyliu/p/4838139.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">Ceph RBD 接口和工具</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（3）<a href="http://www.cnblogs.com/sammyliu/p/4836014.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">Ceph 物理和逻辑结构</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（4）<a href="http://www.cnblogs.com/sammyliu/p/4843812.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">Ceph 的基础数据结构</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（5）<a href="http://www.cnblogs.com/sammyliu/p/4838138.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">Ceph 与 OpenStack 集成的实现</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（6）<a href="http://www.cnblogs.com/sammyliu/p/5066895.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">QEMU-KVM 和 Ceph RBD 的 缓存机制总结</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（7）<a href="http://www.cnblogs.com/sammyliu/p/5555218.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">Ceph 的基本操作和常见故障排除方法</a></p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1. Glance 与 Ceph RBD 集成</h2> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.1 代码</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">Kilo 版本中，glance-store 代码被从 glance 代码中分离出来了，地址在&nbsp;<a href="https://github.com/openstack/glance_store" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">https://github.com/openstack/glance_store</a>。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">Glance 中与 Ceph 相关的配置项：&nbsp;</p> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <table border="1" style="border:1px solid #C0C0C0;border-collapse:collapse;">
     <tbody>
      <tr>
       <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">配置项</td> 
       <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">含义</td> 
       <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">默认值</td> 
      </tr>
      <tr>
       <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">rbd_pool</td> 
       <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">保存rbd 卷的ceph pool 名称</td> 
       <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">images</td> 
      </tr>
      <tr>
       <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">rbd_user</td> 
       <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">rbd user id，仅仅在使用 cephx 认证时使用</td> 
       <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">none。让 librados 根据 ceph 配置文件决定</td> 
      </tr>
      <tr>
       <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">rbd_ceph_conf</td> 
       <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">Ceph 配置文件的完整路径</td> 
       <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">/etc/ceph/ceph.conf</td> 
      </tr>
      <tr>
       <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">rbd_store_chunk_size</td> 
       <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">卷会被分成对象的大小（单位为 MB）</td> 
       <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">64</td> 
      </tr>
     </tbody>
    </table>
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    &nbsp;
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    Glance_store 使用 rbd 和 rados 模块：
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    &nbsp; &nbsp; import rados
    <br> &nbsp;&nbsp;&nbsp; import rbd
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    &nbsp;
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    Glance_store 中新增了文件 /glance_store/_drivers/rbd.py，其中实现了三个类：
   </div> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">class StoreLocation(location.StoreLocation) #表示 Glance image 在 RBD 中的location，格式为&nbsp;"rbd://&lt;FSID&gt;/&lt;POOL&gt;/&lt;IMAGE&gt;/&lt;SNAP&gt;"</li> 
    <li style="list-style-type:disc;"><span class="pl-k" style="line-height:1.5;">class&nbsp;<span class="pl-en" style="line-height:1.5;">ImageIterator(<span class="pl-e" style="line-height:1.5;"><span class="pl-c1" style="line-height:1.5;">object) #实现从 RBD image 中读取数据块</span></span></span></span></li> 
    <li style="list-style-type:disc;">class Store(driver.Store): #实现将 RBD 作为Nova 镜像后端（backend）</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">class Store(driver.Store) 实现的主要方法：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）获取 image 数据：根据传入的Glance image location，获取 image 的 IO Interator</p> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
     <pre>def get(self, location, offset=0, chunk_size=None, context=None):
    return (ImageIterator(loc.pool, loc.image, loc.snapshot, self), self.get_size(location))
1. 根据 location，定位到 rbd image
2. 调用 image.read 方法，按照 chunk size 读取 image data
3. 将 image data 返回调用端</pre>
    </div> 
    <p style="line-height:1.5;">（2）<span style="line-height:1.5;">获取 image 的 size</span></p> 
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
     <pre>def get_size(self, location, context=<span style="line-height:1.5;">None):
</span><span style="color:rgb(128,0,128);line-height:1.5;">1</span>. 找到 store location：loc =<span style="line-height:1.5;"> location.store_location
</span><span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">. 使用 loc 中指定的 pool 或者配置的默认pool
</span><span style="color:rgb(128,0,128);line-height:1.5;">3</span>. 建立 connection 和 打开 IO Context：with rbd.Image(ioctx, loc.image, snapshot=loc.snapshot) <span style="color:rgb(0,0,255);line-height:1.5;">as</span><span style="line-height:1.5;"> image
</span><span style="color:rgb(128,0,128);line-height:1.5;">4</span>. 获取 image.stat() 并获取 “size”</pre>
    </div> 
    <p style="line-height:1.5;">（3）<span style="line-height:1.5;">添加 image</span></p> 
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre>def add(self, image_id, image_file, image_size, context=<span style="line-height:1.5;">None):
</span><span style="color:rgb(128,0,128);line-height:1.5;">1</span>. 将 image_id 作为 rbd image name：image_name =<span style="line-height:1.5;"> str(image_id)
</span><span style="color:rgb(128,0,128);line-height:1.5;">2</span>. 创建 rbd image：librbd.create(ioctx, image_name, size, order, old_format=False, features=rbd.RBD_FEATURE_LAYERING)。如果 rbd 支持 RBD_FEATURE_LAYERING 的话，创建一个 clonable snapshot：rbd:<span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">fsid/pool/image/snapshot；否则，创建一个 rbd image：rbd:</span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">image        </span>
<span style="color:rgb(128,0,128);line-height:1.5;">3</span><span style="line-height:1.5;">. 调用 image.write 方法将 image_file 的内容按照 chunksize 依次写入 rbd image
</span><span style="color:rgb(128,0,128);line-height:1.5;">4</span>. 如果要创建 snapshot 的话，调用 image.create_snap(loc.snapshot) 和 image.protect_snap(loc.snapshot) 创建snapshot</pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="line-height:1.5;">（4）<span style="line-height:1.5;">删除 image</span></p> 
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
     <pre>def delete(self, location, context=<span style="line-height:1.5;">None):
</span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">. 根据 location 计算出 rbd image，snapshot 和 pool
</span><span style="color:rgb(128,0,128);line-height:1.5;">2</span>. 如果它是一个 snapshot （location 是 rbd:<span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">fsid/pool/image/snapshot），则 unprotect_snap，再 remove_snap，然后删除 image；这时候有可能出错，比如存在基于该 image 的 volume。</span>
<span style="color:rgb(128,0,128);line-height:1.5;">3</span>. 如果它不是一个 snapshot （location 是 rbd:<span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">image），直接删除 rbd image。这操作也可能会出错。</span></pre>
    </div> 
    <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.2 使用</h3> 
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    （1）使用 Ceph RDB 作为后端存储创建一个&nbsp;Glance image：
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    root@controller:~/s1# glance image-show 71dc76da-774c-411f-a958-1b51816ec50f
    <br> +------------------+----------------------------------------------------------------------------------+
    <br> | Property &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Value&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |
    <br> +------------------+----------------------------------------------------------------------------------+
    <br> | checksum &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 56730d3091a764d5f8b38feeef0bfcef &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |
    <br> | container_format | bare &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |
    <br> | created_at &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2015-09-18T10:22:49Z &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |
    <br> | direct_url &nbsp; &nbsp; &nbsp; &nbsp; | rbd://4387471a-ae2b-47c4-b67e-9004860d0fd0/images/71dc76da-774c- &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 411f-a958-1b51816ec50f/snap&nbsp;&nbsp;&nbsp;
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    &nbsp;
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    可见该Glance image 在 Ceph 中其实是个 RBD snapshot，其父&nbsp;image 为&nbsp;rbd://4387471a-ae2b-47c4-b67e-9004860d0fd0/images/71dc76da-774c-411f-a958-1b51816ec50f/，snapshot 名称为 “snap”。
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    &nbsp;
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    查看 rdb：
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre>root@ceph1:~# rbd info images/71dc76da-774c-411f-a958-<span style="line-height:1.5;">1b51816ec50f
rbd image </span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">71dc76da-774c-411f-a958-1b51816ec50f</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">:
size </span><span style="color:rgb(128,0,128);line-height:1.5;">40162</span> kB <span style="color:rgb(0,0,255);line-height:1.5;">in</span> <span style="color:rgb(128,0,128);line-height:1.5;">5</span><span style="line-height:1.5;"> objects
order </span><span style="color:rgb(128,0,128);line-height:1.5;">23</span> (<span style="color:rgb(128,0,128);line-height:1.5;">8192</span><span style="line-height:1.5;"> kB objects)
block_name_prefix: rbd_data.103d2246be0e
format: </span><span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">
features: layering</span></pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    Glance 自动创建了它的 snapshot：
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
     <pre>root@ceph1:~# rbd snap ls images/71dc76da-774c-411f-a958-<span style="line-height:1.5;">1b51816ec50f
SNAPID NAME      SIZE
     </span><span style="color:rgb(128,0,128);line-height:1.5;">2</span> snap  <span style="color:rgb(128,0,128);line-height:1.5;">40162</span> kB </pre>
    </div> 
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    查看该 snapshot：
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre><span style="color:rgb(128,0,0);line-height:1.5;">root@ceph1:~# rbd info images/71dc76da-774c-411f-a958-1b51816ec50f@snap
rbd image '71dc76da-774c-411f-a958-1b51816ec50f':
size 40162 kB in 5 objects
order 23 (8192 kB objects)
block_name_prefix: rbd_data.103d2246be0e
format: 2
features: layering
protected: True</span></pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="line-height:1.5;"><span style="line-height:1.5;">基于该 Glance image 创建的 Cinder volume 都是该 snapshot 的 clone：</span></p> 
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
     <pre>root@ceph1:~# rbd children images/71dc76da-774c-411f-a958-<span style="line-height:1.5;">1b51816ec50f@snap
volumes</span>/volume-65dbaf38-0b9d-<span style="color:rgb(128,0,128);line-height:1.5;">4654</span>-bba4-<span style="line-height:1.5;">53f12cc906e3
volumes</span>/volume-6868a043-<span style="color:rgb(128,0,128);line-height:1.5;">1412</span>-4f6c-917f-bbffb1a8d21a</pre>
    </div> 
    <p style="line-height:1.5;"><span style="line-height:1.5;">此时如果试着去删除该&nbsp;image，则会报错：</span></p> 
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
     <pre>The image cannot be deleted because it is in use through the backend store outside of Glance.
这是因为该 image 的 rbd image 的 snapshot 被使用了。</pre>
    </div> 
   </div> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">2. Cinder 与 Ceph RBD 的集成</h2> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">OpenStack Cinder 组件和 Ceph RBD 集成的目的是将 Cinder 卷（volume）保存在 Ceph RBD 中。当使用 Ceph RBD 作为 Cinder 的后端存储时，你不需要单独的一个 Cinder-volume 节点.</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.1 配置项</h3> 
   <table border="1" style="border:1px solid #C0C0C0;border-collapse:collapse;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <tbody>
     <tr>
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">配置项</td> 
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">含义</td> 
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">默认值</td> 
     </tr>
     <tr>
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">rbd_pool</td> 
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">保存rbd 卷的ceph pool 名称</td> 
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">rbd</td> 
     </tr>
     <tr>
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">rbd_user</td> 
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">访问 RBD 的用户的 ID，仅仅在使用 cephx 认证时使用</td> 
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">none</td> 
     </tr>
     <tr>
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">rbd_ceph_conf</td> 
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">Ceph 配置文件的完整路径</td> 
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">‘’，表示使用 librados 的默认ceph 配置文件</td> 
     </tr>
     <tr>
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">rbd_secret_uuid</td> 
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">rbd secret uuid</td> 
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
     </tr>
     <tr>
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">rbd_flatten_volume_from_snapshot</td> 
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">RBD Snapshot 在底层会快速复制一个元信息表，但不会产生实际的数据拷贝，因此当从 Snapshot 创建新的卷时，用户可能会期望不要依赖原来的 Snapshot，这个选项开启会在创建新卷时对原来的 Snapshot 数据进行拷贝来生成一个不依赖于源 Snapshot 的卷。</td> 
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">false</td> 
     </tr>
     <tr>
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">rbd_max_clone_depth</td> 
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p style="line-height:1.5;"><span style="line-height:1.5;font-size:10px;">卷克隆的最大层数，超过的话则使用 fallter。设为 0 的话，则禁止克隆。</span></p> <p style="line-height:1.5;"><span style="line-height:1.5;font-size:10px;">与上面这个选项类似的原因，RBD 在支持 Cinder 的部分 API (如从 Snapshot 创建卷和克隆卷)都会使用 rbd clone 操作，但是由于 RBD 目前对于多级卷依赖的 IO 操作不好，多级依赖卷会有比较严重的性能问题。因此这里设置了一个最大克隆值来避免这个问题，一旦超出这个阀值，新的卷会自动被 flatten。</span></p> </td> 
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">5</td> 
     </tr>
     <tr>
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">rbd_store_chunk_size</td> 
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">每个 RBD 卷实际上就是由多个对象组成的，因此用户可以指定一个对象的大小来决定对象的数量，默认是 4 MB</td> 
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">4</td> 
     </tr>
     <tr>
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">rados_connect_timeout</td> 
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">连接 ceph 集群的超时时间，单位为秒。如果设为负值，则使用默认 librados 中的值</td> 
      <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">-1</td> 
     </tr>
    </tbody>
   </table>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">从这里也能看出来，</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）Cinder 不支持单个 volume 的条带化参数设置，而只是使用了公共配置项 rbd_store_chunk_size 来指定 order。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）Cinder 不支持卷被附加到客户机时设置缓存模式。</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.2 代码</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">Cinder&nbsp;使用的就是之前介绍过的 rbd phthon 模块：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre><span style="line-height:1.5;">import rados
import rbd</span><span style="line-height:1.5;font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><br></span></pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">它实现了以下主要接口。</p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">2.2.1 与 RBD 的连接</h4> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    （1）初始化连接到 RBD 的连接
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre><span style="line-height:1.5;">def initialize_connection(self, volume, connector):
hosts, ports = self._get_mon_addrs() <span style="color:rgb(0,0,255);line-height:1.5;">#调用 args = ['ceph', 'mon', 'dump', '--format=json'</span><span style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;">] 获取 monmap，再获取 hosts 和 ports</span> data =<span style="line-height:1.5;"> { 'driver_volume_type': 'rbd'<span style="line-height:1.5;">, 'data'<span style="line-height:1.5;">: { 'name': '%s/%s' %<span style="line-height:1.5;"> (self.configuration.rbd_pool, volume['name'<span style="line-height:1.5;">]), 'hosts'<span style="line-height:1.5;">: hosts, 'ports'<span style="line-height:1.5;">: ports, 'auth_enabled': (self.configuration.rbd_user is<span style="line-height:1.5;"> not None), 'auth_username'<span style="line-height:1.5;">: self.configuration.rbd_user, 'secret_type': 'ceph'<span style="line-height:1.5;">, 'secret_uuid'<span style="line-height:1.5;">: self.configuration.rbd_secret_uuid, } }</span></span></span></span></span></span></span></span></span></span></span></span></span></pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="line-height:1.5;">（2）连接到 ceph rados</p> 
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
     <pre>client = self.rados.Rados(rados_id=self.configuration.rbd_user, conffile=<span style="line-height:1.5;">self.configuration.rbd_ceph_conf)
client.connect(timeout=<span style="line-height:1.5;"> self.configuration.rados_connect_timeout) ioctx = client.open_ioctx(pool)</span></span></pre>
    </div> 
    <p style="line-height:1.5;">（3）断开连接</p> 
   </div> 
   <div> 
    <div class="cnblogs_code" style="color:rgb(0,0,0);font-family:'Courier New';font-size:12px;border:1px solid rgb(204,204,204);">
     <pre><span style="line-height:1.5;">ioctx.close()
client.shutdown()</span></pre>
    </div> 
    <h4 style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:14px;">2.2.2&nbsp;创建卷</h4> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
     Cinder API：create_volume
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
     调用的是 RBD 的 create 方法来创建 RBD image：
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
     <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
      <div class="cnblogs_code_toolbar">
       <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
      </div> 
      <pre>with RADOSClient(self) <span style="color:rgb(0,0,255);line-height:1.5;">as</span><span style="line-height:1.5;"> client:
            self.rbd.RBD().create(client.ioctx,
                                  encodeutils.safe_encode(volume[</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">name</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">]),
                                  size,
                                  order,
                                  old_format</span>=<span style="line-height:1.5;">old_format,
                                  features</span>=features)</pre> 
      <div class="cnblogs_code_toolbar">
       <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
      </div> 
     </div> 
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
     <h4 style="font-size:14px;">2.2.3 克隆卷</h4> 
     <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
      <div class="cnblogs_code_toolbar">
       <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
      </div> 
      <pre><span style="color:rgb(0,0,255);line-height:1.5;">#创建克隆卷</span>
def create_cloned_volume(self, volume, src_vref): <br><br><span style="color:rgb(0,0,255);line-height:1.5;"># 因为 RBD 的 clone 方法是基于 snapshot 的，所有 cinder 会首先创建一个 snapshot，再创建一个 clone。</span>

 if CONF.rbd_max_clone_depth &lt;= 0: <span style="color:rgb(0,0,255);line-height:1.5;">#如果设置的 rbd_max_clone_depth  为负数，则做一个完整的 rbd image copy</span>
     vol.copy(vol.ioctx, dest_name)
depth = self._get_clone_depth(client, src_name) <span style="color:rgb(0,0,255);line-height:1.5;">#判断 volume 对应的 image 的 clone depth，如果已经达到 CONF.rbd_max_clone_depth，则需要做 flattern</span>
src_volume = self.rbd.Image(client.ioctx, src_name) <span style="color:rgb(0,0,255);line-height:1.5;">#获取 source volume 对应的 rbd image</span>
<span style="color:rgb(0,0,255);line-height:1.5;">#如果需要 flattern，</span>
   _pool, parent, snap = self._get_clone_info(src_volume,  src_name) <span style="color:rgb(0,0,255);line-height:1.5;">#获取 parent 和 snapshot</span>
   src_volume.flatten() <span style="color:rgb(0,0,255);line-height:1.5;"># 将 parent 的data 拷贝到该 clone 中</span>
   parent_volume = self.rbd.Image(client.ioctx, parent) <span style="color:rgb(0,0,255);line-height:1.5;">#获取 paraent image</span>
   parent_volume.unprotect_snap(snap) <span style="color:rgb(0,0,255);line-height:1.5;">#将 snap 去保护</span>
   parent_volume.remove_snap(snap) <span style="color:rgb(0,0,255);line-height:1.5;">#删除 snapshot</span>
src_volume.create_snap(clone_snap) <span style="color:rgb(0,0,255);line-height:1.5;">#创建新的 snapshot</span>
src_volume.protect_snap(clone_snap) <span style="color:rgb(0,0,255);line-height:1.5;">#将 snapshot 加保护</span>
self.rbd.RBD().clone(client.ioctx, src_name, clone_snap, client.ioctx, dest_name, features=client.features) <span style="color:rgb(0,0,255);line-height:1.5;">#在 snapshot 上做clone</span>
self._resize(volume) <span style="color:rgb(0,0,255);line-height:1.5;">#如果 clone 的size 和 src volume 的size 不一样，则 resiz</span>e&nbsp;</pre> 
      <div class="cnblogs_code_toolbar">
       <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
      </div> 
     </div> 
    </div> 
    <h2 style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:21px;line-height:1.5;">3. Nova 与 Ceph 的集成</h2> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
     常规地，Nova 将虚机的镜像文件放在本地磁盘或者Cinder 卷上。为了与 Ceph 集成，Nova 中添加了新的代码来将镜像文件保存在 Ceph 中。
    </div> 
    <h3 style="color:rgb(102,102,102);font-family:Verdana;font-size:16px;background-image:none;background-repeat:no-repeat;line-height:1.5;">3.1 Nova 与 Ceph 集成的配置项</h3> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
     <table border="1" style="border:1px solid #C0C0C0;border-collapse:collapse;">
      <tbody>
       <tr>
        <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">配置项</td> 
        <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">含义</td> 
        <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">默认值</td> 
       </tr>
       <tr>
        <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">images_type</td> 
        <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p style="line-height:1.5;">其值可以设为下面几个选项中的一个：</p> 
         <ul style="list-style:none;">
          <li style="list-style-type:disc;">raw：实现了 class Raw(Image) 类，在&nbsp;CONF.instances_path 指定的目录中保存 raw 格式的 镜像文件</li> 
          <li style="list-style-type:disc;">qcow2：实现了&nbsp;class Qcow2(Image) 类，在&nbsp;CONF.instances_path 指定的目录中创建和保存 qcow2 格式的镜像文件 ['qemu-img', 'create', '-f', 'qcow2']</li> 
          <li style="list-style-type:disc;">lvm：实现了 class Lvm(Image) 类，在 CONF.libvirt.images_volume_group 指定的 LVM Volume Group 中创建 local vm 来存放 vm images</li> 
          <li style="list-style-type:disc;">rbd：实现了&nbsp;class Rbd(Image) 类</li> 
          <li style="list-style-type:disc;">default：使用&nbsp;use_cow_images 配置项</li> 
         </ul></td> 
        <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">default</td> 
       </tr>
       <tr>
        <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">images_rbd_pool</td> 
        <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">存放 vm 镜像文件的 RBD pool</td> 
        <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">rbd</td> 
       </tr>
       <tr>
        <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">images_rbd_ceph_conf</td> 
        <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">Ceph 配置文件的完整路径</td> 
        <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">‘’</td> 
       </tr>
       <tr>
        <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">hw_disk_discard</td> 
        <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p style="line-height:1.5;">设置使用或者不使用discard 模式，使用的话需要 Need Libvirt(1.0.6)、 Qemu1.5&nbsp;(raw format) 和 Qemu1.6(qcow2 format)') 的支持</p> <p style="line-height:1.5;">"unmap" : Discard requests("trim" or "unmap") are passed to the filesystem.<br> "ignore": Discard requests("trim" or "unmap") are ignored and aren't passed&nbsp;to the filesystem.</p> </td> 
        <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">none</td> 
       </tr>
       <tr>
        <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">rbd_user</td> 
        <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">rbd user ID</td> 
        <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
       </tr>
       <tr>
        <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">rbd_secret_uuid</td> 
        <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">rbd secret UUID&nbsp;</td> 
        <td valign="top" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
       </tr>
      </tbody>
     </table>
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
     &nbsp;
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
     关于 discard 模式（详情见
     <a href="http://specs.openstack.org/openstack/nova-specs/specs/juno/implemented/libvirt-disk-discard-option.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这篇文章</a>）：
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
     &nbsp; &nbsp;&nbsp;Discard，在 SSD 上称为 trim，是在磁盘上回收不使用的数据块的机制。默认地 RBD image 是稀疏的（thin provision），这意味着只有在你写入数据时物理空间才会被占用。在 OpenStack 虚机中使用 discard 机制需要满足两个条件：
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
     （1）虚机使用&nbsp;Virtio-scsi 作为存储接口，而不是使用传统的&nbsp;Virtio-blk。这是因为&nbsp;Virtio-scsi 中实现了如下的新的功能：
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
     <ul style="list-style:none;font-size:12px;">
      <li style="list-style-type:disc;">设备直接暴露给客户机（device pass-through to directly expose physical storage devices to guests）</li> 
      <li style="list-style-type:disc;">更好的性能（better performance and support for true SCSI device）</li> 
      <li style="list-style-type:disc;">标准的设备命名方法（common and standard device naming identical to the physical world thus virtualising physical applications is made easier）</li> 
      <li style="list-style-type:disc;">更好的扩展性（better scalability of the storage where virtual machines can attach more device (more LUNs etc…)）</li> 
     </ul>
     <p style="line-height:1.5;">要让虚机使用该接口，需要设置 Glance image 的属性：</p> 
     <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
      <pre>$ glance image-update --property hw_scsi_model=virtio-scsi --property hw_disk_bus=scsi</pre>
     </div> 
     <p style="line-height:1.5;">（2）在 nova.conf 中配置&nbsp;hw_disk_discard = unmap</p> 
     <p style="line-height:1.5;">注意目前 cinder 尚不支持 discard。</p> 
    </div> 
    <h3 style="color:rgb(102,102,102);font-family:Verdana;font-size:16px;background-image:none;background-repeat:no-repeat;line-height:1.5;">3.2 Nova 中实现的 RBD image 操作</h3> 
    <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">Nova 在&nbsp;\nova\virt\libvirt\imagebackend.py 文件中添加了支持 RBD 的新类&nbsp;class Rbd(Image) 来支持将虚机的image 放在 RBD 中。其主要方法包括：</p> 
    <div> 
     <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
      （1）image create API
     </div> 
     <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre>def create_image(self, prepare_template, <span style="color:rgb(0,0,255);line-height:1.5;">base</span>, size, *args, **<span style="line-height:1.5;">kwargs):
# 调用 </span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">rbd</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>, <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">import</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> 命令将 image file 的数据保存到 rbd image 中</pre>
      </div> 
     </div> 
     <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
      rbd import 命令：
     </div> 
     <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.5;">import [–image</span>-format format-id] [–order bits] [–stripe-unit size-<span style="color:rgb(0,0,255);line-height:1.5;">in</span>-B/K/M –stripe-count num] [–image-feature feature-name]... [–image-shared] src-path[image-<span style="line-height:1.5;">spec]
Creates a </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span> image and imports its data <span style="color:rgb(0,0,255);line-height:1.5;">from</span> path (use - <span style="color:rgb(0,0,255);line-height:1.5;">for</span> stdin). The import operation will <span style="color:rgb(0,0,255);line-height:1.5;">try</span> to create sparse rbd images <span style="color:rgb(0,0,255);line-height:1.5;">if</span> possible. For import <span style="color:rgb(0,0,255);line-height:1.5;">from</span> stdin, the sparsification unit <span style="color:rgb(0,0,255);line-height:1.5;">is</span> the data block size of the destination image (<span style="color:rgb(128,0,128);line-height:1.5;">1</span> &lt;&lt;<span style="line-height:1.5;"> order).
The –stripe</span>-unit and –stripe-count arguments are optional, but must be used together.</pre>
      </div> 
     </div> 
     <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
      <p style="line-height:1.5;">虚机创建成功后，在 RBD 中查看创建出来的 image：</p> 
     </div> 
     <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre>root@ceph1:~<span style="line-height:1.5;"># rbd ls vms
74cbdb41</span>-<span style="color:rgb(128,0,128);line-height:1.5;">3789</span>-4eae-b22e-<span style="line-height:1.5;">5085de8caba8_disk.local

root@ceph1:</span>~# rbd info vms/74cbdb41-<span style="color:rgb(128,0,128);line-height:1.5;">3789</span>-4eae-b22e-<span style="line-height:1.5;">5085de8caba8_disk.local
rbd image </span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">74cbdb41-3789-4eae-b22e-5085de8caba8_disk.local</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">:
size </span><span style="color:rgb(128,0,128);line-height:1.5;">1024</span> MB <span style="color:rgb(0,0,255);line-height:1.5;">in</span> <span style="color:rgb(128,0,128);line-height:1.5;">256</span><span style="line-height:1.5;"> objects
order </span><span style="color:rgb(128,0,128);line-height:1.5;">22</span> (<span style="color:rgb(128,0,128);line-height:1.5;">4096</span><span style="line-height:1.5;"> kB objects)
block_name_prefix: rbd_data.11552ae8944a
format: </span><span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">
features: layering</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p style="line-height:1.5;">查看虚机的 xml 定义文件，能看到虚机的系统盘、临时盘和交换盘的镜像文件都在 RBD 中，而且可以使用特定的 cache 模式（由 CONF.libvirt.<span class="n" style="line-height:1.5;">disk_cachemodes 配置项指定</span>）和 discard 模式（由 CONF.libvirt.hw_disk_discard 配置项设置）：</p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre>&lt;devices&gt;
    &lt;disk type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">network</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> device=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">disk</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>&gt;
      &lt;driver type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">raw</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> cache=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">writeback</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> discard=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">unmap</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      <span style="color:rgb(0,0,255);line-height:1.5;">&lt;source protocol="rbd" name="vms/74cbdb41-3789-4eae-b22e-5085de8caba8_disk.local"&gt;</span>
        &lt;host name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">9.115.251.194</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> port=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">6789</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
        &lt;host name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">9.115.251.195</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> port=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">6789</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
        &lt;host name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">9.115.251.218</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> port=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">6789</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;/source&gt;
      &lt;auth username=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">cinder</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>&gt;
        &lt;secret type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ceph</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> uuid=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">e21a123a-31f8-425a-86db-7204c33a6161</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;/auth&gt;
      &lt;target bus=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">virtio</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> dev=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">vdb</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
    &lt;/disk&gt;
    &lt;disk type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">network</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> device=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">disk</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>&gt;
      &lt;driver name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">qemu</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">raw</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> cache=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">writeback</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      <span style="color:rgb(0,0,255);line-height:1.5;">&lt;source protocol="rbd" name="volumes/volume-6868a043-1412-4f6c-917f-bbffb1a8d21a"&gt;</span>
        &lt;host name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">9.115.251.194</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> port=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">6789</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
        &lt;host name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">9.115.251.195</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> port=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">6789</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
        &lt;host name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">9.115.251.218</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> port=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">6789</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;/source&gt;
      &lt;auth username=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">cinder</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>&gt;
        &lt;secret type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ceph</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> uuid=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">e21a123a-31f8-425a-86db-7204c33a6161</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;/auth&gt;
      &lt;target bus=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">virtio</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> dev=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">vda</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;serial&gt;6868a043-<span style="color:rgb(128,0,128);line-height:1.5;">1412</span>-4f6c-917f-bbffb1a8d21a&lt;/serial&gt;
    &lt;/disk&gt;</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p style="line-height:1.5;">&nbsp; &nbsp; 关于 libvirt.<span class="n" style="line-height:1.5;">disk_cachemodes 配置项，可以指定镜像文件的缓存模式，其值的格式为 ”A=B"，其中：</span></p> 
      <ul style="list-style:none;font-size:12px;">
       <li style="list-style-type:disc;"><span class="n" style="line-height:1.5;">A 可以为 'file'，'block'，'network'，'mount'。其中，file 是针对 file-backend 的disk（比如使用 qcow2 格式的镜像文件），block 是针对块设备的disk（比如使用 cinder volume 或者 lvm），network 是针对通过网络连接的设备的disk（比如 Ceph）。</span></li> 
       <li style="list-style-type:disc;"><span class="n" style="line-height:1.5;">B 可以为&nbsp;none,writethrough,writeback,directsync,unsafe。writethrough 和 writeback 可以参考&nbsp;<a href="http://www.cnblogs.com/sammyliu/p/4836014.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">理解 OpenStack + Ceph （2）：Ceph 的物理和逻辑结构</a>，其它的请自行google。</span></li> 
       <li style="list-style-type:disc;"><span style="line-height:1.5;">比如，disk_cachemodes="network=writeback"，disk_cachemodes="block=writeback"。</span></li> 
      </ul>
      <p style="line-height:1.5;"><span class="n" style="line-height:1.5;">&nbsp; &nbsp;上面的虚机 XML 定义文件是在Nova 配置为&nbsp;</span>disk_cachemodes="network=writeback" 和&nbsp;hw_disk_discard = unmap 的情形下生成的。</p> 
      <p style="line-height:1.5;">（2）<span style="line-height:1.5;">image clone API</span></p> 
     </div> 
     <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.5;">def clone(self, context, image_id_or_uri):
</span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">. 通过 Glance API 获取 image 的 rbd location
</span><span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">. 检查 rbd image 是否可以被克隆（检查它是不是在本 ceph cluster 内、是不是 raw 格式、是不是可以访问等）
</span><span style="color:rgb(128,0,128);line-height:1.5;">3</span>. 调用 rbd 的 clone 方法来创建 clone</pre>
      </div> 
     </div> 
     <h3 style="color:rgb(102,102,102);font-family:Verdana;font-size:16px;background-image:none;background-repeat:no-repeat;line-height:1.5;">3.3 镜像 clone 而非下载</h3> 
     <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">&nbsp; &nbsp; 使用传统存储作为 image 的后端存储时，在创建虚机的过程中的创建镜像文件时，都是调用 &nbsp;_try_fetch_image_cache 方法来从 Glance 中将镜像文件下载到本地（第一次会缓存，以后就直接读缓存而不用下载），然后再创建镜像文件的方法。而在使用 RBD 作为镜像的后端存储时，如果 Glance 镜像文件被保存在 RBD 中，那么该过程将是重复的（先通过 Glance 从 RDB 中倒出镜像，然后再由 Nova 放到RBD中），而且是非常耗时的。针对这种情况，Nova 实现了<a href="http://specs.openstack.org/openstack/nova-specs/specs/juno/implemented/rbd-clone-image-handler.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">一种新的办法</a>，具体见下面的蓝色字体部分：&nbsp;</p> 
     <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
      在 Spawn 虚机过程中，一个步骤是 create image，如下的方法会被调用：
     </div> 
     <div> 
      <div class="cnblogs_code" style="color:rgb(0,0,0);font-family:'Courier New';font-size:12px;border:1px solid rgb(204,204,204);"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.5;">def _create_image(self, context, instance,
                      disk_mapping, suffix</span>=<span style="color:rgb(128,0,0);line-height:1.5;">''</span><span style="line-height:1.5;">,
                      disk_images</span>=None, network_info=<span style="line-height:1.5;">None,
                      block_device_info</span>=None, files=<span style="line-height:1.5;">None,
                      admin_pass</span>=None, inject_files=<span style="line-height:1.5;">True,
                      fallback_from_host</span>=<span style="line-height:1.5;">None):
 
      </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> not booted_from_volume: <span style="color:rgb(0,0,255);line-height:1.5;">#如果不是从 volume 启动虚机</span>
            root_fname </span>= imagecache.get_cache_fname(disk_images, <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">image_id</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">)
            size </span>= instance.root_gb *<span style="line-height:1.5;"> units.Gi
            backend </span>= image(<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">disk</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">)
            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> backend.SUPPORTS_CLONE: <span style="color:rgb(0,0,255);line-height:1.5;">#如果 image backend 支持 clone 的话（目前的各种 image backend，只有 RBD 支持 clone）</span>
                def clone_fallback_to_fetch(</span>*args, **<span style="line-height:1.5;">kwargs):
                        backend.clone(context, disk_images[</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">image_id</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">]) <span style="color:rgb(0,0,255);line-height:1.5;">#直接调用 backend 的 clone 函数做 image clone</span>
                fetch_func </span>=<span style="line-height:1.5;"> clone_fallback_to_fetch
            </span><span style="color:rgb(0,0,255);line-height:1.5;">else</span><span style="line-height:1.5;">:
                fetch_func </span>= libvirt_utils.fetch_image <span style="color:rgb(0,0,255);line-height:1.5;">#否则走常规的 image 下载-</span><span style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;">导入过程</span>
            self._try_fetch_image_cache(backend, fetch_func, context, root_fname, disk_images[</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">image_id</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>], instance, size, fallback_from_host)</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;"><span style="line-height:1.5;">&nbsp; &nbsp; 可见，当 nova 后端使用 ceph 时，nova driver 调用 RBD imagebackend 命令，直接在 ceph 存储层完成镜像拷贝动作（无需消耗太多的nova性能，也无需将镜像下载到hypervisor本地，再上传镜像到ceph），如此创建虚拟机时间将会大大提升。当然，这个的前提是 image 也是保存在 ceph 中，而且 image 的格式为 raw，否则 clone 过程会报错。&nbsp;</span><span style="line-height:1.5;">具体过程如下：</span></p> 
      <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;"><span style="line-height:1.5;">（1）</span>这是 Glance image 对应的 rbd image：</p> 
      <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
       <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
        <div class="cnblogs_code_toolbar">
         <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
        </div> 
        <pre>root@ceph1:~# rbd info <span style="color:rgb(0,0,255);line-height:1.5;">images/0a64fa67-3e34-42e7-b7b0-</span><span style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;">423c11850e18</span>
rbd image </span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">0a64fa67-3e34-42e7-b7b0-423c11850e18</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">:
        size </span><span style="color:rgb(128,0,128);line-height:1.5;">564</span> MB <span style="color:rgb(0,0,255);line-height:1.5;">in</span> <span style="color:rgb(128,0,128);line-height:1.5;">71</span><span style="line-height:1.5;"> objects
        order </span><span style="color:rgb(128,0,128);line-height:1.5;">23</span> (<span style="color:rgb(128,0,128);line-height:1.5;">8192</span><span style="line-height:1.5;"> kB objects)
        block_name_prefix: rbd_data.16d21e1d755b
        format: </span><span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">
        features: layering</span></pre> 
        <div class="cnblogs_code_toolbar">
         <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
        </div> 
       </div> 
       <p style="line-height:1.5;">（2）使用该 image 创建第一个虚机</p> 
       <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
        <div class="cnblogs_code_toolbar">
         <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
        </div> 
        <pre>root@ceph1:~# rbd info vms/982b8eac-6bcc-4a21-bd04-<span style="line-height:1.5;">b67e26188be0_disk
rbd image </span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">982b8eac-6bcc-4a21-bd04-b67e26188be0_disk</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">:
        size </span><span style="color:rgb(128,0,128);line-height:1.5;">3072</span> MB <span style="color:rgb(0,0,255);line-height:1.5;">in</span> <span style="color:rgb(128,0,128);line-height:1.5;">384</span><span style="line-height:1.5;"> objects
        order </span><span style="color:rgb(128,0,128);line-height:1.5;">23</span> (<span style="color:rgb(128,0,128);line-height:1.5;">8192</span><span style="line-height:1.5;"> kB objects)
        block_name_prefix: rbd_data.130a36a6b435
        format: </span><span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">
        features: layering
        parent: <span style="color:rgb(0,0,255);line-height:1.5;">images</span></span><span style="color:rgb(0,0,255);line-height:1.5;">/0a64fa67-3e34-42e7-b7b0-</span><span style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;">423c11850e18@snap</span>
        overlap: </span><span style="color:rgb(128,0,128);line-height:1.5;">564</span><span style="line-height:1.5;"> MB

root@ceph1:</span>~# rbd info vms/982b8eac-6bcc-4a21-bd04-<span style="line-height:1.5;">b67e26188be0_disk.local
rbd image </span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">982b8eac-6bcc-4a21-bd04-b67e26188be0_disk.local</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">:
        size </span><span style="color:rgb(128,0,128);line-height:1.5;">2048</span> MB <span style="color:rgb(0,0,255);line-height:1.5;">in</span> <span style="color:rgb(128,0,128);line-height:1.5;">512</span><span style="line-height:1.5;"> objects
        order </span><span style="color:rgb(128,0,128);line-height:1.5;">22</span> (<span style="color:rgb(128,0,128);line-height:1.5;">4096</span><span style="line-height:1.5;"> kB objects)
        block_name_prefix: rbd_data.a69b2ae8944a
        format: </span><span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">
        features: layering

root@ceph1:</span>~# rbd info vms/982b8eac-6bcc-4a21-bd04-<span style="line-height:1.5;">b67e26188be0_disk.swap
rbd image </span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">982b8eac-6bcc-4a21-bd04-b67e26188be0_disk.swap</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">:
        size </span><span style="color:rgb(128,0,128);line-height:1.5;">102400</span> kB <span style="color:rgb(0,0,255);line-height:1.5;">in</span> <span style="color:rgb(128,0,128);line-height:1.5;">25</span><span style="line-height:1.5;"> objects
        order </span><span style="color:rgb(128,0,128);line-height:1.5;">22</span> (<span style="color:rgb(128,0,128);line-height:1.5;">4096</span><span style="line-height:1.5;"> kB objects)
        block_name_prefix: rbd_data.a69e74b0dc51
        format: </span><span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">
        features: layering</span></pre> 
        <div class="cnblogs_code_toolbar">
         <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
        </div> 
       </div> 
       <p style="line-height:1.5;">（3）创建第二个虚机</p> 
       <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
        <div class="cnblogs_code_toolbar">
         <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
        </div> 
        <pre>root@ceph1:~# rbd info vms/a9670d9a-8aa7-49ba-baf5-<span style="line-height:1.5;">9d7a450172f3_disk
rbd image </span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">a9670d9a-8aa7-49ba-baf5-9d7a450172f3_disk</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">:
        size </span><span style="color:rgb(128,0,128);line-height:1.5;">3072</span> MB <span style="color:rgb(0,0,255);line-height:1.5;">in</span> <span style="color:rgb(128,0,128);line-height:1.5;">384</span><span style="line-height:1.5;"> objects
        order </span><span style="color:rgb(128,0,128);line-height:1.5;">23</span> (<span style="color:rgb(128,0,128);line-height:1.5;">8192</span><span style="line-height:1.5;"> kB objects)
        block_name_prefix: rbd_data.13611f6abac6
        format: </span><span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">
        features: layering
        parent: images</span>/0a64fa67-3e34-42e7-b7b0-<span style="line-height:1.5;">423c11850e18@snap
        overlap: </span><span style="color:rgb(128,0,128);line-height:1.5;">564</span> MB</pre> 
        <div class="cnblogs_code_toolbar">
         <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
        </div> 
       </div> 
       <p style="line-height:1.5;">（4）会看到 Glance image 对应的 RBD image 有两个克隆，分别是上面虚机的系统盘</p> 
       <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
        <pre>root@ceph1:~# rbd children  images/0a64fa67-3e34-42e7-b7b0-<span style="line-height:1.5;">423c11850e18@snap
vms</span>/982b8eac-6bcc-4a21-bd04-<span style="line-height:1.5;">b67e26188be0_disk
vms</span>/a9670d9a-8aa7-49ba-baf5-9d7a450172f3_disk</pre>
       </div> 
       <h2 style="font-size:21px;line-height:1.5;">&nbsp;4. 其它集成</h2> 
       <p style="line-height:1.5;">除了上面所描述的 Cinder、Nova 和 Glance 与 Ceph RBD 的集成外，OpenStack 和 Ceph 之间还有其它的集成点：</p> 
       <p style="line-height:1.5;">（1）使用 Ceph 替代 Swift 作为对象存储 （网络上有很多比较 Ceph 和 Swift 的文章，比如&nbsp;<a href="http://blogs.rdoproject.org/6427/ceph-and-swift-why-we-are-not-fighting" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">1</a>,2,3,）</p> 
       <p style="line-height:1.5;">（2）CephFS 作为 Manila 的后端（backend）</p> 
       <p style="line-height:1.5;">（3）Keystone 和 &nbsp;Ceph Object Gateway 的集成，具体可以参考文章&nbsp;<a href="http://www.smanjara.in/integrating-ceph-rados-gateway-with-openstack-keystone/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">（1）</a><a href="http://docs.ceph.com/docs/v0.86/radosgw/keystone/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">（2）</a></p> 
       <p style="line-height:1.5;"><img src="https://images2015.cnblogs.com/blog/697113/201510/697113-20151015134557335-625202655.jpg" alt="" style="border:0px;"></p> 
      </div> 
      <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;">&nbsp;参考文档：</p> 
      <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;"><a href="http://www.sebastien-han.fr/blog/2015/02/02/openstack-and-ceph-rbd-discard/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://www.sebastien-han.fr/blog/2015/02/02/openstack-and-ceph-rbd-discard/</a></p> 
      <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;"><a href="http://www.sebastien-han.fr/blog/2013/11/26/back-from-icehouse-openstack-summit-ceph-slas" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://www.sebastien-han.fr/blog/2013/11/26/back-from-icehouse-openstack-summit-ceph-slash-openstack-integration/</a></p> 
      <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;"><a href="http://www.wzxue.com/openstack-cinder-advance/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://www.wzxue.com/openstack-cinder-advance/</a></p> 
      <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;"><br></p> 
      <p style="line-height:1.5;"><font color="#4b4b4b"><span style="font-size:15px;">&nbsp; &nbsp; 本文转自SammyLiu博客园博客，原文链接：http://www.cnblogs.com/sammyliu/p/4838138.html</span></font><span style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">，如需转载请自行联系原作者</span></p> 
      <p style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;line-height:1.5;"><br></p> 
     </div> 
    </div> 
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
