<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>探索 OpenStack 之（12）：cinder-api Service 处理 HTTP Request 的过程分析 « NotBeCN</title>
  <meta name="description" content="             本文是上一篇&nbsp;探索 OpenStack 之（11）：cinder-api Service 启动过程分析 以及 WSGI / Paste deploy / Router 等介绍&gt; 的后续篇。&nbsp;    osapi_volume 的 WSGI Service 进程在收...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/17/weixin_34138377_90124674.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">探索 OpenStack 之（12）：cinder-api Service 处理 HTTP Request 的过程分析</h1>
    <p class="post-meta">Nov 17, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">本文是上一篇&nbsp;<a class="titlelink" href="http://www.cnblogs.com/sammyliu/p/4272611.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">探索 OpenStack 之（11）：cinder-api Service 启动过程分析 以及 WSGI / Paste deploy / Router 等介绍</a>&gt; 的后续篇。&nbsp;</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;font-size:14px;">osapi_volume 的 WSGI Service 进程在收到 HTTP Request 后，首先将HTTP request 封装成wsgi request，然后依次执行以下步骤。</span></p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1. 按顺序调用已经注册的 middleware （filter） 实例的&nbsp;__call__ 方法</h2> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.1 filter:keystonecontext</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">该 filter 会提取 request header 中 token 相关数据，组成一个 ctx， 放入 request.environ 的&nbsp;cinder.context 项中，供后续 app 使用。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>def __call__(self, req):
'keystonecontext : Make a request context from keystone headers.'
ctx = context.RequestContext(user_id,
                                     project_id,
                                     project_name=project_name,
                                     roles=roles,
                                     auth_token=auth_token,
                                     remote_address=remote_address,
                                     service_catalog=service_catalog,
                                     request_id=req_id)

req.environ['cinder.context'] = ctx <span style="color:rgb(0,0,255);line-height:1.5;">#添加 cinder.context</span>
return self.application <span style="color:rgb(0,0,255);line-height:1.5;">//If you are not modifying the output, you can just return the app.</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.2 filter:authtoken</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">该 filter 的代码在&nbsp;<a href="https://github.com/openstack/keystonemiddleware" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">https://github.com/openstack/keystonemiddleware</a>。&nbsp;该 filter 会通过校验request所带的 token 来校验用户身份。当request来的时候，它根据 token 来判断这个请求是否合法。校验失败则直接返回 401 错误，校验通过则提取&nbsp;token 中的信息，放入到env中，供后续的其它app使用。具体会在 token 相关的文章中详细分析。&nbsp;</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.3 &nbsp;filter:osprofiler</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">该 filter 的代码在&nbsp;<a href="https://github.com/stackforge/osprofiler" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">https://github.com/stackforge/osprofiler</a>， 它用来&nbsp;enables tracing for an application。似乎是在 enabled = yes 的情况下，记录 request 的如下信息：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">"request": {<br> "host_url": request.host_url,<br> "path": request.path,<br> "query": request.query_string,<br> "method": request.method,<br> "scheme": request.scheme<br> }</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">具体细节待查。</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.4 filter:sizelimit</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">该 filer 会检查 request 的 conent length，如果超过 cinder.conf 中 osapi_max_request_body_size&nbsp;定义的最大size，则直接报 HTTPRequestEntityTooLarge</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">，不再进行后续处理。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>def __call__(self, req):
     if req.content_length &gt; CONF.osapi_max_request_body_size: <span style="color:rgb(0,0,255);line-height:1.5;">#判断 req.content_length，大于 CONF.osapi_max_request_body_size 则直接失败</span>
            msg = _("Request is too large.")
            raise webob.exc.HTTPRequestEntityTooLarge(explanation=msg)
        if req.content_length is None and req.is_body_readable:
            limiter = LimitingReader(req.body_file, CONF.osapi_max_request_body_size)
            req.body_file = limiter
        return self.application&nbsp;</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.5 filter:faultwrap</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">该 filter 不会修改 request 和 respone，而是在一旦之前的App 处理 response 出错的话，它 catch 住错误并调用 _error 方法，返回一个适当的错误信息。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>def __call__(self, req):
       try:
           return req.get_response(self.application)
       except Exception as ex:
           return self._error(ex, req) //return wsgi.Fault(outer) 如果application返回response过程出错，则返回Traceback (most recent call last)</pre>
   </div> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.6 filter:request_id</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">该 filter 不会修改 request，而是做为第一个修改 APIRouter 生成的 response 的 filter，在 response headers里面添加&nbsp;x-openstack-request-id 项，其值为一个随机的 UUID.</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="line-height:1.5;">def __call__(self, req):
        req_id = context.generate_request_id()  <span style="color:rgb(0,0,255);line-height:1.5;">//req-&lt;UUID&gt;</span>
        req.environ[ENV_REQUEST_ID] = req_id <span style="color:rgb(0,0,255);line-height:1.5;">//添加 'openstack.request_id'</span>
        response =<span style="line-height:1.5;"> req.get_response(self.application) if HTTP_RESP_HEADER_REQUEST_ID not in response.headers: <span style="color:rgb(0,0,255);line-height:1.5;">// 'x-openstack-request-id'</span> response.headers.add(HTTP_RESP_HEADER_REQUEST_ID, req_id) <span style="color:rgb(0,0,255);line-height:1.5;">#在response上添加x-openstack-request-id，比如 x-openstack-request-id: 123567890</span> return response <span style="color:rgb(0,0,255);line-height:1.5;">//return 修改后的 response</span></span></span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">2. 调用已注册的 APIRouter 实例的&nbsp;__call__ 方法</h2> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">该方法直接返回&nbsp;self._router，而它是一个&nbsp;routes.middleware.RoutesMiddleware 类型的 WSGI app，所以调用其 __call__ 方法。</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.1 以 cinder list 为例分析 Core Resource 基本方法的分发过程&nbsp;</h3> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">2.1.1 调用&nbsp;routes.middleware.RoutesMiddleware 的&nbsp;__call__ 方法</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">过程见注释部分：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="line-height:1.5;">def __call__(self, environ, start_response):
        </span><span style="color:rgb(128,0,0);line-height:1.5;">"""</span><span style="color:rgb(128,0,0);line-height:1.5;">Resolves the URL in PATH_INFO, and uses wsgi.routing_args to pass on URL resolver results.</span><span style="color:rgb(128,0,0);line-height:1.5;">"""</span><span style="line-height:1.5;">
                
        # Run the actual route matching
        # </span>--<span style="line-height:1.5;"> Assignment of environ to config triggers route matching
        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> self.singleton: #singleton 默认值为 True，所以执行该分支
            config </span>=<span style="line-height:1.5;"> request_config()
            config.mapper </span>=<span style="line-height:1.5;"> self.mapper
            config.environ </span>=<span style="line-height:1.5;"> environ
            match </span>= config.mapper_dict <span style="color:rgb(0,0,255);line-height:1.5;">#获取match，（{'action': u'detail',&nbsp;'controller': &lt;cinder.api.openstack.wsgi.Resource object at 0x7fa137be8950&gt;, 'project_id': u'fa2046aaead44a698de8268f94759fc1'</span><span style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;">})</span>
            route </span>=<span style="line-height:1.5;"> config.route <span style="color:rgb(0,0,255);line-height:1.5;">#获取route</span>
        ...</span><span style="line-height:1.5;">                
        url </span>= URLGenerator(self.mapper, environ) <span style="color:rgb(0,0,255);line-height:1.5;">#比如 &lt;routes.util.URLGenerator object at 0x7fa137a15590&gt;</span><span style="line-height:1.5;">
        environ[</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">wsgiorg.routing_args</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>] =<span style="line-height:1.5;"> ((url), match) 
        environ[</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">routes.route</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>] =<span style="line-height:1.5;"> route <span style="color:rgb(0,0,255);line-height:1.5;">#比如 'routes.route': &lt;routes.route.Route object at 0x7fa137bef4d0&gt;</span>
        environ[</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">routes.url</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>] =<span style="line-height:1.5;"> url <span style="color:rgb(0,0,255);line-height:1.5;">#比如 'routes.url': &lt;routes.util.URLGenerator object at 0x7fa137a15590&gt;</span>
</span><span style="line-height:1.5;">        ...
</span><span style="color:rgb(0,0,255);line-height:1.5;">       
        response =</span><span style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;"> self.app(environ, start_response)</span> <span style="color:rgb(0,0,255);line-height:1.5;">#调用 _dispatch WSGI App</span>
</span><span style="line-height:1.5;">        ...
        </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> response</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;"><span style="line-height:1.5;font-size:.83em;">2.1.2 调用 Router.def _dispatch(req) 方法</span></h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">其代码如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>match = req.environ['wsgiorg.routing_args'][1] <span style="color:rgb(0,0,255);line-height:1.5;">#match：{'action': u'detail', 'controller': &lt;cinder.api.openstack.wsgi.Resource object at 0x7fa137be8950&gt;, 'project_id': u'fa2046aaead44a698de8268f94759fc1'}</span>
if not match:
     return webob.exc.HTTPNotFound()
app = match['controller'] <span style="color:rgb(0,0,255);line-height:1.5;">#&lt;cinder.api.openstack.wsgi.Resource object at 0x7fa137be8950&gt;</span>
return app <span style="color:rgb(0,0,255);line-height:1.5;">#调用该 App 的 __call__ 方法</span></pre>
   </div> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">2.1.3 执行&nbsp;cinder.api.openstack.wsgi.Resource 的&nbsp;def __call__(self, request) 方法</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">该方法负责（反）序列化和方法分发。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="line-height:1.5;"># Identify the action, its arguments, and the requested content type
action_args =<span style="line-height:1.5;"> self.get_action_args(request.environ) <span style="color:rgb(0,0,255);line-height:1.5;">#从environ 获取 match</span> action = action_args.pop('action'<span style="line-height:1.5;">, None) <span style="color:rgb(0,0,255);line-height:1.5;">#得到 action 'detail'</span> content_type, body =<span style="line-height:1.5;"> self.get_body(request) <span style="color:rgb(0,0,255);line-height:1.5;">#得到request 的 content_type 和 body。body 为空。</span> accept =<span style="line-height:1.5;"> request.best_match_content_type() <span style="color:rgb(0,0,255);line-height:1.5;">#如果 environ 中有 'cinder.best_content_type' 的话，直接返回，比如 'application/json'；没有的话，则找个最合适的content type，并设置到environ。</span> return<span style="line-height:1.5;"> self._process_stack(request, action, action_args, content_type, body, accept) <span style="color:rgb(0,0,255);line-height:1.5;">#调用 _process_stack</span></span></span></span></span></span></span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;函数&nbsp;_process_stack&nbsp;的主要代码如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <p style="line-height:1.5;">def _process_stack(self, request, action, action_args,content_type, body, accept):</p> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">#action_args：{'project_id': u'43f66bb82e684bbe9eb9ef6892bd7fd6'}， action: detail， body:， <br></span><br>
meth, extensions =<span style="line-height:1.5;"> self.get_method(request, action, content_type, body) <br><span style="color:rgb(0,0,255);line-height:1.5;">#找到 action 对应的 Controller 的 method 和 这个 Core Resource 的所有带这个 aciton 的 Resource extensions（如果 action 是 ‘action’ 的话，根据 request body 中的信息，会把 action 转化为具体的 Controller 的 method）。 <br><strong>#返回值 meth</strong>： &lt;bound method VolumeController.detail of &lt;cinder.api.v2.volumes.VolumeController object at 0x7f2fd96863d0&gt;&gt;。<br><strong>#返回值 extensions</strong>: [&lt;bound method VolumeTenantAttributeController.detail of &lt;cinder.api.contrib.volume_tenant_attribute.VolumeTenantAttributeController object at 0x7f2fd885ac50&gt;&gt;, &lt;bound method VolumeReplicationController.detail of &lt;cinder.api.contrib.volume_replication.VolumeReplicationController object at 0x7f2fd86eacd0&gt;&gt;, &lt;bound method VolumeHostAttributeController.detail of &lt;cinder.api.contrib.volume_host_attribute.VolumeHostAttributeController object at 0x7f2fd87088d0&gt;&gt;, &lt;bound method VolumeMigStatusAttributeController.detail of &lt;cinder.api.contrib.volume_mig_status_attribute.VolumeMigStatusAttributeController object at 0x7f2fd870e090&gt;&gt;, &lt;bound method VolumeImageMetadataController.detail of &lt;cinder.api.contrib.volume_image_metadata.VolumeImageMetadataController object at 0x7f2fd870e790&gt;&gt;]</span><br><br>
contents = self.deserialize(meth, content_type, body) <span style="color:rgb(0,0,255);line-height:1.5;">#根据 content_type 反序列化 request body</span><br>
response, post = self.pre_process_extensions(extensions, request, action_args) <span style="color:rgb(0,0,255);line-height:1.5;"># 找出 extensions 的 _call__ 方法，分别调用，得到 response<br></span></span></pre> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre>def pre_process_extensions(self, extensions, request, action_args)<br>
{<br><br><span style="line-height:1.5;">for ext in extensions:<br><span style="color:rgb(0,0,255);line-height:1.5;">#遍历所有的Resource extension，比如 &lt;bound method VolumeTenantAttributeController.detail of &lt;cinder.api.contrib.volume_tenant_attribute.VolumeTenantAttributeController object at 0x7f2fd885ac50&gt;&gt;</span></span></pre> 
     <p style="line-height:1.5;">&nbsp; &nbsp; if inspect.isgeneratorfunction(ext):&nbsp;<span style="color:rgb(0,0,255);line-height:1.5;">#如果object是一个生成器函数(任何包含yield表达式的函数即为生成器方法), 则返回True。现在还没有这样的方法。这里会返回false</span><br> &nbsp; &nbsp; &nbsp; &nbsp; response = None</p> 
     <p style="line-height:1.5;"># If it's a generator function, the part before the&nbsp;yield is the preprocessing stage<br> try:<br> with ResourceExceptionHandler():<br> gen = ext(req=request, **action_args)<br> response = gen.next()<br> except Fault as ex:<br> response = ex</p> 
     <p style="line-height:1.5;"># We had a response...<br> if response:<br> return response, []</p> 
     <p style="line-height:1.5;"># No response, queue up generator for post-processing<br> post.append(gen)</p> 
     <p style="line-height:1.5;">else:<br> # Regular functions only perform post-processing<br> post.append(ext)&nbsp;<span style="color:rgb(0,0,255);line-height:1.5;">#等待执行post-processing</span></p> 
     <p style="line-height:1.5;"># Run post-processing in the reverse order</p> 
     <p style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;">#将所有不是generatorfunciton 的 ext 放进 post， 比如&nbsp;[&lt;bound method VolumeTenantAttributeController.detail of &lt;cinder.api.contrib.volume_tenant_attribute.VolumeTenantAttributeController object at 0x7f2fd885ac50&gt;&gt;, &lt;bound method VolumeReplicationController.detail of &lt;cinder.api.contrib.volume_replication.VolumeReplicationController object at 0x7f2fd86eacd0&gt;&gt;, &lt;bound method VolumeHostAttributeController.detail of &lt;cinder.api.contrib.volume_host_attribute.VolumeHostAttributeController object at 0x7f2fd87088d0&gt;&gt;, &lt;bound method VolumeMigStatusAttributeController.detail of &lt;cinder.api.contrib.volume_mig_status_attribute.VolumeMigStatusAttributeController object at 0x7f2fd870e090&gt;&gt;, &lt;bound method VolumeImageMetadataController.detail of &lt;cinder.api.contrib.volume_image_metadata.VolumeImageMetadataController object at 0x7f2fd870e790&gt;&gt;]</span><br> return None, reversed(post)</p> 
     <p style="line-height:1.5;">}</p> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <pre><span style="line-height:1.5;"><br><span style="color:rgb(0,0,255);line-height:1.5;"><span style="color:rgb(0,0,0);line-height:1.5;">if not response:</span> #response 为 null，调用 method 方法，比如 &lt;bound method VolumeController.detail of &lt;cinder.api.v1.volumes.VolumeController object at 0x7fa137be8650&gt;&gt;<br></span>    action_result = self.dispatch(meth, request, action_args) </span><span style="color:rgb(0,0,255);line-height:1.5;">#执行Resource Controller 的基本方法，得到其返回值    </span></pre> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre><span style="line-height:1.5;">def dispatch(self, method, request, action_args):
        </span><span style="color:rgb(128,0,0);line-height:1.5;">"""</span><span style="color:rgb(128,0,0);line-height:1.5;">Dispatch a call to the action-specific method.</span><span style="color:rgb(128,0,0);line-height:1.5;">"""</span>
        <span style="color:rgb(0,0,255);line-height:1.5;">#method: &lt;bound method VolumeController.detail of &lt;cinder.api.v2.volumes.VolumeController object at 0x7f2fd96863d0&gt;&gt;<br>
#action_args: {}<br>
#method执行结果为： {'volumes': [{'status': u'error', 'user_id': u'1dc0db32a936496ebfc50be54924a7cc', 'attachments': [], 'links': [{'href': u'http://controller:8776/v2/43f66bb82e684bbe9eb9ef6892bd7fd6/volumes/42ddb30e-8a36-4301-99e4-9547ce4e860d', 'rel': 'self'}, {'href': u'http://controller:8776/43f66bb82e684bbe9eb9ef6892bd7fd6/volumes/42ddb30e-8a36-4301-99e4-9547ce4e860d', 'rel': 'bookmark'}], 'availability_zone': u'nova', 'bootable': 'false', 'encrypted': False, 'created_at': datetime.datetime(2015, 1, 3, 2, 47, 52), 'description': None, 'volume_type': None, 'name': None, 'replication_status': u'disabled', 'consistencygroup_id': None, 'source_volid': None, 'snapshot_id': None, 'metadata': {}, 'id': u'42ddb30e-8a36-4301-99e4-9547ce4e860d', 'size': 1L}]}</span>
        <span style="line-height:1.5;">return </span>method(req=request, **action_args)</pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <pre><span style="line-height:1.5;">resp_obj = ResponseObject(action_result) </span><span style="color:rgb(0,0,255);line-height:1.5;">#初始化其返回值为一个ResponseObject对象</span></pre> 
    <pre>_set_request_id_header(request, resp_obj) <span style="color:rgb(0,0,255);line-height:1.5;">#设置 headers['x-compute-request-id'] = req.environ.get('cinder.context').request_id</span><br>
serializers = getattr(meth, 'wsgi_serializers', {}) <span style="color:rgb(0,0,255);line-height:1.5;">#获取Controller的 action 方法使用的serializers。detail 方法的serizlizer 是 {'xml': &lt;class 'cinder.api.v2.volumes.VolumesTemplate'&gt;}</span><br>
resp_obj._bind_method_serializers(serializers) <span style="color:rgb(0,0,255);line-height:1.5;">#设置 resp_obj 的序列化方法</span><br>
resp_obj.preserialize(accept, self.default_serializers) <span style="color:rgb(0,0,255);line-height:1.5;"># resp_obj 做序列化准备</span></pre> 
    <p style="line-height:1.5;">&nbsp; response = self.post_process_extensions(post, resp_obj,&nbsp;request, action_args)&nbsp;<span style="color:rgb(0,0,255);line-height:1.5;font-size:12px;"># 对每个 extension 执行操作，获取response：&nbsp; response = ext(req=request, resp_obj=resp_obj,&nbsp;**action_args)<em>&nbsp; &nbsp;</em></span><span style="color:rgb(0,0,255);line-height:1.5;font-size:12px;"><em>&nbsp;&nbsp;</em></span></p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre>def post_process_extensions(self, extensions, resp_obj, request,action_args):</pre> 
     <p style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;">&nbsp; &nbsp; for</span>&nbsp;ext&nbsp;<span style="color:rgb(0,0,255);line-height:1.5;">in</span><span style="line-height:1.5;">&nbsp;extensions:</span></p> 
     <p style="line-height:1.5;"><span style="line-height:1.5;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color:rgb(0,0,255);line-height:1.5;">#遍历 Resource extension。以&nbsp;&lt;bound method VolumeImageMetadataController.detail of &lt;cinder.api.contrib.volume_image_metadata.VolumeImageMetadataController object at 0x7f2fd870e790&gt;&gt; 为例。</span></span></p> 
     <p style="line-height:1.5;"><span style="line-height:1.5;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; response&nbsp;</span>=<span style="line-height:1.5;">&nbsp;None</span></p> 
     <p style="line-height:1.5;"><span style="line-height:1.5;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;">&nbsp;inspect.isgenerator(ext):&nbsp;</span><span style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;">#Return true if the object is a generator. 这里返回 false</span></span></p> 
     <pre><span style="line-height:1.5;">                # If it</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">s a generator, run the second half of</span>
<span style="line-height:1.5;">                # processing
                </span><span style="color:rgb(0,0,255);line-height:1.5;">try</span><span style="line-height:1.5;">:
                    with ResourceExceptionHandler():
                        response </span>=<span style="line-height:1.5;"> ext.send(resp_obj)
                    except StopIteration:
                    # Normal exit of generator
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">continue</span><span style="line-height:1.5;">
                except Fault </span><span style="color:rgb(0,0,255);line-height:1.5;">as</span><span style="line-height:1.5;"> ex:
                    response </span>=<span style="line-height:1.5;"> ex
            </span><span style="color:rgb(0,0,255);line-height:1.5;">else</span><span style="line-height:1.5;">:
                # Regular functions </span><span style="color:rgb(0,0,255);line-height:1.5;">get</span> post-<span style="line-height:1.5;">processing...
                </span><span style="color:rgb(0,0,255);line-height:1.5;">try</span><span style="line-height:1.5;">:
                    with ResourceExceptionHandler():
                        response </span>= ext(req=request, resp_obj=<span style="line-height:1.5;">resp_obj, </span>**<span style="line-height:1.5;">action_args) </span><span style="color:rgb(0,0,255);line-height:1.5;">#调用 extension method 的方法，它会把 reponse 插进 resp_obj。本例子中将返回none。<br></span></pre> 
     <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);"> 
      <div class="cnblogs_code_toolbar">
       <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
      </div> 
      <pre><span style="line-height:1.5;">@wsgi.extends
    def detail(self, req, resp_obj):
        context </span>= req.environ[<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">cinder.context</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">]
        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> authorize(context):
            resp_obj.attach(xml</span>=<span style="line-height:1.5;">VolumesImageMetadataTemplate())
            all_meta </span>=<span style="line-height:1.5;"> self._get_all_images_metadata(context)
            </span><span style="color:rgb(0,0,255);line-height:1.5;">for</span> vol <span style="color:rgb(0,0,255);line-height:1.5;">in</span> list(resp_obj.obj.<span style="color:rgb(0,0,255);line-height:1.5;">get</span>(<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">volumes</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">, [])):
                image_meta </span>= all_meta.<span style="color:rgb(0,0,255);line-height:1.5;">get</span>(vol[<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">id</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">], {})
                self._add_image_metadata(context, vol, image_meta)</span></pre> 
      <div class="cnblogs_code_toolbar">
       <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
      </div> 
     </div> 
     <pre><span style="line-height:1.5;">
                except Fault </span><span style="color:rgb(0,0,255);line-height:1.5;">as</span><span style="line-height:1.5;"> ex:
                    response </span>=<span style="line-height:1.5;"> ex

            # We had a response...
            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> response:
                </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> response
        </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> None <span style="color:rgb(0,0,255);line-height:1.5;">#返回none</span></pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="line-height:1.5;"><span style="line-height:1.5;font-size:12px;">&nbsp; if resp_obj and not response:</span></p> 
    <p style="line-height:1.5;">&nbsp; &nbsp; &nbsp; response = resp_obj.serialize(request, accept,&nbsp;self.default_serializers)&nbsp;<span style="color:rgb(0,0,255);line-height:1.5;font-size:12px;">#执行序列化，得到 response string</span></p> 
    <p style="line-height:1.5;">&nbsp;&nbsp;return response&nbsp;<span style="color:rgb(0,0,255);line-height:1.5;font-size:12px;">#返回response，后续需要改response的middleware的__call__方法将得到继续执行，指导回到 WSGI Server，它会将 response 返回给cinderclient</span></p> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.2 cinder&nbsp;quota-update 的简要过程 （os-quota-set &nbsp;是Extension resource）</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><strong>Request:</strong></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">PUT /43f66bb82e684bbe9eb9ef6892bd7fd6/os-quota-sets/43f66bb82e684bbe9eb9ef6892bd7fd6</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">body: {"quota_set": {"gigabytes": 1000, "tenant_id": "43f66bb82e684bbe9eb9ef6892bd7fd6", "snapshots": 20, "volumes": 10}}</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><strong>Route:</strong></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">Route path: '/{project_id}/os-quota-sets/:(id)', defaults: {'action': u'update', 'controller': &lt;cinder.api.openstack.wsgi.Resource object at 0x7f1662934c90&gt;}</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><strong>Dispatch:</strong></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">method: &lt;bound method QuotaSetsController.update of &lt;cinder.api.contrib.quotas.QuotaSetsController object at 0x7f1662983c50&gt;&gt;&nbsp;</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">body: {"quota_set": {"gigabytes": 1000, "tenant_id": "43f66bb82e684bbe9eb9ef6892bd7fd6", "snapshots": 20, "volumes": 10}}</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">action_args: {'body': {u'quota_set': {u'gigabytes': 1000, u'tenant_id': u'43f66bb82e684bbe9eb9ef6892bd7fd6', u'volumes': 10, u'snapshots': 20}}, 'project_id': u'43f66bb82e684bbe9eb9ef6892bd7fd6', 'id': u'43f66bb82e684bbe9eb9ef6892bd7fd6'}</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">action_result: {'quota_set': {'snapshots': 20L, u'gigabytes_type-network': -1, u'snapshots_type-network': -1, u'volumes_newtype': -1, 'backups': 10, u'snapshots_typelvm': -1, u'volumes_type-b1': -1, u'volumes_type-b2': -1, u'snapshots_lvmtype': -1, u'volumes_lvmtype': -1, u'gigabytes_lvmtype': -1, u'volumes_typelvm': -1, u'snapshots_newtype': -1, 'gigabytes': 1000L, 'backup_gigabytes': 1000, u'gigabytes_type-b2': -1, u'snapshots_type-b1': -1, u'snapshots_type-b2': -1, u'gigabytes_type-b1': -1, u'gigabytes_newtype': -1, u'volumes_type-network': -1, u'gigabytes_typelvm': -1, 'volumes': 10L}}</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><strong>Response:</strong></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">serializers: {'xml': &lt;class 'cinder.api.contrib.quotas.QuotaTemplate'&gt;}</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">response = ['{"quota_set": {"snapshots": 20, "gigabytes_type-network": -1, "snapshots_type-network": -1, "volumes_newtype": -1, "backups": 10, "snapshots_typelvm": -1, "volumes_type-b1": -1, "volumes_type-b2": -1, "snapshots_lvmtype": -1, "volumes_lvmtype": -1, "gigabytes_lvmtype": -1, "volumes_typelvm": -1, "snapshots_newtype": -1, "gigabytes": 1000, "backup_gigabytes": 1000, "gigabytes_type-b2": -1, "snapshots_type-b1": -1, "snapshots_type-b2": -1, "gigabytes_type-b1": -1, "gigabytes_newtype": -1, "volumes_type-network": -1, "gigabytes_typelvm": -1, "volumes": 10}}']</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.3 以 cinder extend 的简要过程 （os-extend 是 volumes 资源扩展的 wsgi.action）</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><strong>Request</strong>：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">POST http://9.123.245.88:8776/v2/2f07ad0f1beb4b629e42e1113196c04b/volumes/8ec62cc2-2f88-409c-a249-bfc1614eb8ab/action</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">{"os-extend": {"new_size": 2}}</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><strong>Route：</strong></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">Route path: '/{project_id}/volumes/:(id)/action', defaults: {'action': u'action', 'controller': &lt;cinder.api.openstack.wsgi.Resource object at 0x7f459d3d4d90&gt;}</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">match： {'action': u'action', 'controller': &lt;cinder.api.openstack.wsgi.Resource object at 0x7f459d3d4d90&gt;, 'project_id': u'2f07ad0f1beb4b629e42e1113196c04b', 'id': u'8ec62cc2-2f88-409c-a249-bfc1614eb8ab'}</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><strong>Dispatch：</strong></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">method：&lt;bound method VolumeActionsController._extend of &lt;cinder.api.contrib.volume_actions.VolumeActionsController object at 0x7f459d254d10&gt;&gt;</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">action_args: {'body': {u'os-extend': {u'new_size': 2}}, 'id': u'42ddb30e-8a36-4301-99e4-9547ce4e860d'}</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">Result：Invalid volume: Volume status must be available to extend. （因为此volume 的状态为 error）</p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">3. 小结</h2> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">小结 osapi-volume 处理 HTTP Request 的全过程：：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">1. Middleware filters 处理 HTTP Request header 的子过程，这其中主要是用户校验。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">2. APIRouter 生成 HTTP Request 的 response 的子过程。依次： RoutesMiddleware 产生 route -&gt; Resource 的 request body 反序列化、消息派发给 Resource Controller 的具体方法、Resource controller 的具体方法执行、结果的序列化等。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">3. 个别 Middleware 还要处理一下 response，包括 RoutesMiddleware。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">4. 最终的 response 发还给客户端。</p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">&nbsp;</h4> 
   <div>
    <br>
   </div> 
   <div>
    <br>
   </div> 
   <div> 
    <div>
     &nbsp; &nbsp;本文转自SammyLiu博客园博客，原文链接http://www.cnblogs.com/sammyliu/p/4271239.html：，如需转载请自行联系原作者
    </div> 
   </div> 
   <div>
    <br>
   </div> 
   <div>
    <br>
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
