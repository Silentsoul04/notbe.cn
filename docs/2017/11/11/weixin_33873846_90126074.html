<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Silverlight实用窍门系列：50.InkPresenter涂鸦板的基本使用，以及将效果保存为Png图片【附带源码实例】... « NotBeCN</title>
  <meta name="description" content="             &nbsp; 在Silverlight中我们有时候需要手工绘制线条或者直线等，在这里我们认识一下InkPresenter控件，它将支持用户使用鼠标、手写板等工具来绘制图形或者笔迹，用途为涂鸦、笔迹确认等等。    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/11/weixin_33873846_90126074.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">Silverlight实用窍门系列：50.InkPresenter涂鸦板的基本使用，以及将效果保存为Png图片【附带源码实例】...</h1>
    <p class="post-meta">Nov 11, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="font-family:verdana, 'ms song', '宋体', Arial, '微软雅黑', Helvetica, sans-serif;font-size:15px;">&nbsp; 在Silverlight中我们有时候需要手工绘制线条或者直线等，在这里我们认识一下InkPresenter控件，它将支持用户使用鼠标、手写板等工具来绘制图形或者笔迹，用途为涂鸦、笔迹确认等等。</p> 
   <p style="font-family:verdana, 'ms song', '宋体', Arial, '微软雅黑', Helvetica, sans-serif;font-size:15px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InkPresenter是继承于Canvas控件的支持所有的Canvas属性，并且其内部还可以嵌套显示其他控件。InkPresenter控件的显示分为三层：底层是InkPresenter的Background、中间层是InkPresenter的Children属性的控件、最后才是Strokes属性中的笔画层。</p> 
   <p style="font-family:verdana, 'ms song', '宋体', Arial, '微软雅黑', Helvetica, sans-serif;font-size:15px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于Strokes属性中的笔画Stroke我们可以设置它的颜色、粗细、外边框颜色等等属性以获得满意的笔画类型。下面我们来看看如何使用InkPresenter控件，首先我们来看Xaml代码如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="line-height:1.5;">    </span><span style="line-height:1.5;">&lt;</span><span style="line-height:1.5;">Grid x:Name</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">LayoutRoot1</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> Background</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">White</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">&gt;</span><span style="line-height:1.5;"><br></span><span style="line-height:1.5;">&lt;</span><span style="line-height:1.5;">Canvas</span><span style="line-height:1.5;">&gt;</span><span style="line-height:1.5;"><br></span><span style="line-height:1.5;">&lt;</span><span style="line-height:1.5;">Border BorderThickness</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">1</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> Margin</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">50 10 0 0</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> BorderBrush</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">CadetBlue</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> <br>
HorizontalAlignment</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Center</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> VerticalAlignment</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Center</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">&gt;</span><span style="line-height:1.5;"><br></span><span style="line-height:1.5;">&lt;</span><span style="line-height:1.5;">InkPresenter x:Name</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">iPresenter</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> Height</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">500</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> Width</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">500</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"><br>
MouseLeftButtonDown</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">iPresenter_MouseLeftButtonDown</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> <br>
LostMouseCapture</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">iPresenter_LostMouseCapture</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> <br>
MouseMove</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">iPresenter_MouseMove</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> <br>
Background</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Transparent</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> Opacity</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">1</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> </span><span style="line-height:1.5;">&gt;</span><span style="line-height:1.5;"><br></span><span style="line-height:1.5;">&lt;</span><span style="line-height:1.5;">TextBox Width</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">138</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> Canvas.Left</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">58</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> Canvas.Top</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">105</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">&gt;&lt;/</span><span style="line-height:1.5;">TextBox</span><span style="line-height:1.5;">&gt;</span><span style="line-height:1.5;"><br></span><span style="line-height:1.5;">&lt;/</span><span style="line-height:1.5;">InkPresenter</span><span style="line-height:1.5;">&gt;</span><span style="line-height:1.5;"><br></span><span style="line-height:1.5;">&lt;/</span><span style="line-height:1.5;">Border</span><span style="line-height:1.5;">&gt;</span><span style="line-height:1.5;"><br></span><span style="line-height:1.5;">&lt;</span><span style="line-height:1.5;">Button Canvas.Left</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">560</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> Canvas.Top</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">11</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> Content</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">将涂鸦保存为图片</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> Height</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">23</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"><br>
Name</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">button1</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> Width</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">104</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> Click</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">button1_Click</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> </span><span style="line-height:1.5;">/&gt;</span><span style="line-height:1.5;"><br></span><span style="line-height:1.5;">&lt;</span><span style="line-height:1.5;">Image Name</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">showIP</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> Width</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">400</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> Height</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">400</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> Canvas.Left</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">560</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> Canvas.Top</span><span style="line-height:1.5;">=</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">60</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">&gt;&lt;/</span><span style="line-height:1.5;">Image</span><span style="line-height:1.5;">&gt;</span><span style="line-height:1.5;"><br></span><span style="line-height:1.5;">&lt;/</span><span style="line-height:1.5;">Canvas</span><span style="line-height:1.5;">&gt;</span><span style="line-height:1.5;"><br></span><span style="line-height:1.5;">&lt;/</span><span style="line-height:1.5;">Grid</span><span style="line-height:1.5;">&gt;</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:verdana, 'ms song', '宋体', Arial, '微软雅黑', Helvetica, sans-serif;font-size:15px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 然后我们来看看Xaml.cs代码如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="line-height:1.5;">    </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">partial</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> MainPage : UserControl<br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> MainPage()<br>
{<br>
InitializeComponent();<br>
SetPresenterClip();<br>
}<br>
Stroke myStroke;<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> iPresenter_MouseLeftButtonDown(</span><span style="color:rgb(0,0,255);line-height:1.5;">object</span><span style="line-height:1.5;"> sender, MouseEventArgs e)<br>
{<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">让鼠标捕获数据</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">            iPresenter.CaptureMouse();<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">收集笔触数据点保存值StylusPointCollection集合中</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">            StylusPointCollection stylusPointCollection </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> StylusPointCollection();<br>
stylusPointCollection.Add(e.StylusDevice.GetStylusPoints(iPresenter));<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">将数据点的结合保存为一个笔画</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">            myStroke </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> Stroke(stylusPointCollection);<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">设置笔画的绘画效果，如颜色，大小等。</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">            myStroke.DrawingAttributes.Color </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> Colors.Gray;<br>
myStroke.DrawingAttributes.Width </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">;<br>
myStroke.DrawingAttributes.Height </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">;<br>
iPresenter.Strokes.Add(myStroke);<br>
}<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> iPresenter_MouseMove(</span><span style="color:rgb(0,0,255);line-height:1.5;">object</span><span style="line-height:1.5;"> sender, MouseEventArgs e)<br>
{<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">在鼠标移动的过程中将数据点加入到笔画中去。</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> (myStroke </span><span style="line-height:1.5;">!=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">)<br>
myStroke.StylusPoints.Add(e.StylusDevice.GetStylusPoints(iPresenter));<br>
}<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> iPresenter_LostMouseCapture(</span><span style="color:rgb(0,0,255);line-height:1.5;">object</span><span style="line-height:1.5;"> sender, MouseEventArgs e)<br>
{<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">将笔画清空</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">            myStroke </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">;<br>
iPresenter.ReleaseMouseCapture();</span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">释放鼠标坐标</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">        }<br><br></span><span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> </span><span style="color:rgb(128,128,128);line-height:1.5;">&lt;summary&gt;</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> 设置绘画区域为InkPresenter的大小<br></span><span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> </span><span style="color:rgb(128,128,128);line-height:1.5;">&lt;/summary&gt;</span><span style="color:rgb(128,128,128);line-height:1.5;"><br></span><span style="line-height:1.5;">        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> SetPresenterClip()<br>
{<br>
RectangleGeometry MyRectangleGeometry </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> RectangleGeometry();<br>
MyRectangleGeometry.Rect </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> Rect(</span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, iPresenter.ActualWidth, iPresenter.ActualHeight);<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">设置获取绘画内容的有效区域</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">            iPresenter.Clip </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> MyRectangleGeometry;<br>
}<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> button1_Click(</span><span style="color:rgb(0,0,255);line-height:1.5;">object</span><span style="line-height:1.5;"> sender, RoutedEventArgs e)<br>
{<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">保存InkPresenter涂鸦板内绘画的图</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">            WriteableBitmap _bitmap </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> WriteableBitmap(iPresenter, </span><span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">);<br></span><span style="color:rgb(0,0,255);line-height:1.5;">this</span><span style="line-height:1.5;">.showIP.Source </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> _bitmap;<br>
SaveFileDialog sfd </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> SaveFileDialog();<br>
sfd.Filter </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">PNG Files (*.png)|*.png|All Files (*.*)|*.*</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">;<br>
sfd.DefaultExt </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">.png</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">;<br>
sfd.FilterIndex </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">;<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> ((</span><span style="color:rgb(0,0,255);line-height:1.5;">bool</span><span style="line-height:1.5;">)sfd.ShowDialog())<br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">using</span><span style="line-height:1.5;"> (Stream fs </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> sfd.OpenFile())<br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> width </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> _bitmap.PixelWidth;<br></span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> height </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> _bitmap.PixelHeight;<br><br>
EditableImage ei </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> EditableImage(width, height);<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">for</span><span style="line-height:1.5;"> (</span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> i </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">; i </span><span style="line-height:1.5;">&lt;</span><span style="line-height:1.5;"> height; i</span><span style="line-height:1.5;">++</span><span style="line-height:1.5;">)<br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">for</span><span style="line-height:1.5;"> (</span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> j </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">; j </span><span style="line-height:1.5;">&lt;</span><span style="line-height:1.5;"> width; j</span><span style="line-height:1.5;">++</span><span style="line-height:1.5;">)<br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> pixel </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> _bitmap.Pixels[(i </span><span style="line-height:1.5;">*</span><span style="line-height:1.5;"> width) </span><span style="line-height:1.5;">+</span><span style="line-height:1.5;"> j];<br>
ei.SetPixel(j, i,<br>
(</span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">)((pixel </span><span style="line-height:1.5;">&gt;&gt;</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">16</span><span style="line-height:1.5;">) </span><span style="line-height:1.5;">&amp;</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0xFF</span><span style="line-height:1.5;">),<br>
(</span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">)((pixel </span><span style="line-height:1.5;">&gt;&gt;</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">8</span><span style="line-height:1.5;">) </span><span style="line-height:1.5;">&amp;</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0xFF</span><span style="line-height:1.5;">),<br>
(</span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">)(pixel </span><span style="line-height:1.5;">&amp;</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0xFF</span><span style="line-height:1.5;">),<br>
(</span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">)((pixel </span><span style="line-height:1.5;">&gt;&gt;</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">24</span><span style="line-height:1.5;">) </span><span style="line-height:1.5;">&amp;</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0xFF</span><span style="line-height:1.5;">)<br>
);<br>
}<br>
}<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">获取流</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">                    Stream png </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> ei.GetStream();<br></span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> len </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> (</span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;">)png.Length;<br></span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[] bytes </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[len];<br>
png.Read(bytes, </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, len);<br>
fs.Write(bytes, </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, len);<br>
MessageBox.Show(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">图片保存成功！</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);<br>
}<br>
}<br><br>
}<br>
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:verdana, 'ms song', '宋体', Arial, '微软雅黑', Helvetica, sans-serif;font-size:15px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 对于将InkPresenter中绘画出来的图片保存为Png图片得处理，我们在这里借鉴了园子中<a href="http://www.cnblogs.com/salam/archive/2010/09/02/1815943.html" rel="nofollow" style="color:#000000;"><span style="color:rgb(70,70,70);">永恒的记忆</span></a>兄弟的将元素转为Png图片的方法，在这里贴出两个辅助转Png格式的类。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="line-height:1.5;">    </span><span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> </span><span style="color:rgb(128,128,128);line-height:1.5;">&lt;summary&gt;</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> 编辑图片<br></span><span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> </span><span style="color:rgb(128,128,128);line-height:1.5;">&lt;/summary&gt;</span><span style="color:rgb(128,128,128);line-height:1.5;"><br></span><span style="line-height:1.5;">    </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> EditableImage<br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> _width </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">;<br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> _height </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">;<br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">bool</span><span style="line-height:1.5;"> _init </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">false</span><span style="line-height:1.5;">;<br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[] _buffer;<br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> _rowLength;<br><br></span><span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> </span><span style="color:rgb(128,128,128);line-height:1.5;">&lt;summary&gt;</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> 当图片错误时引发<br></span><span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> </span><span style="color:rgb(128,128,128);line-height:1.5;">&lt;/summary&gt;</span><span style="color:rgb(128,128,128);line-height:1.5;"><br></span><span style="line-height:1.5;">        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">event</span><span style="line-height:1.5;"> EventHandler</span><span style="line-height:1.5;">&lt;</span><span style="line-height:1.5;">EditableImageErrorEventArgs</span><span style="line-height:1.5;">&gt;</span><span style="line-height:1.5;"> ImageError;<br><br></span><span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> </span><span style="color:rgb(128,128,128);line-height:1.5;">&lt;summary&gt;</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> 实例化<br></span><span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> </span><span style="color:rgb(128,128,128);line-height:1.5;">&lt;/summary&gt;</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> </span><span style="color:rgb(128,128,128);line-height:1.5;">&lt;param name="width"&gt;&lt;/param&gt;</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> </span><span style="color:rgb(128,128,128);line-height:1.5;">&lt;param name="height"&gt;&lt;/param&gt;</span><span style="color:rgb(128,128,128);line-height:1.5;"><br></span><span style="line-height:1.5;">        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> EditableImage(</span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> width, </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> height)<br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">this</span><span style="line-height:1.5;">.Width </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> width;<br></span><span style="color:rgb(0,0,255);line-height:1.5;">this</span><span style="line-height:1.5;">.Height </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> height;<br>
}<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> Width<br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">get</span><span style="line-height:1.5;"><br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> _width;<br>
}<br></span><span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;"><br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> (_init)<br>
{<br>
OnImageError(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">错误: 图片初始化后不可以改变宽度</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);<br>
}<br></span><span style="color:rgb(0,0,255);line-height:1.5;">else</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> ((value </span><span style="line-height:1.5;">&lt;=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">) </span><span style="line-height:1.5;">||</span><span style="line-height:1.5;"> (value </span><span style="line-height:1.5;">&gt;</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">2047</span><span style="line-height:1.5;">))<br>
{<br>
OnImageError(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">错误: 宽度必须在 0 到 2047</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);<br>
}<br></span><span style="color:rgb(0,0,255);line-height:1.5;">else</span><span style="line-height:1.5;"><br>
{<br>
_width </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> value;<br>
}<br>
}<br>
}<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> Height<br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">get</span><span style="line-height:1.5;"><br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> _height;<br>
}<br></span><span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;"><br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> (_init)<br>
{<br>
OnImageError(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">错误: 图片初始化后不可以改变高度</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);<br>
}<br></span><span style="color:rgb(0,0,255);line-height:1.5;">else</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> ((value </span><span style="line-height:1.5;">&lt;=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">) </span><span style="line-height:1.5;">||</span><span style="line-height:1.5;"> (value </span><span style="line-height:1.5;">&gt;</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">2047</span><span style="line-height:1.5;">))<br>
{<br>
OnImageError(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">错误: 高度必须在 0 到 2047</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);<br>
}<br></span><span style="color:rgb(0,0,255);line-height:1.5;">else</span><span style="line-height:1.5;"><br>
{<br>
_height </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> value;<br>
}<br>
}<br>
}<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> SetPixel(</span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> col, </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> row, Color color)<br>
{<br>
SetPixel(col, row, color.R, color.G, color.B, color.A);<br>
}<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> SetPixel(</span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> col, </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> row, </span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;"> red, </span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;"> green, </span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;"> blue, </span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;"> alpha)<br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> (</span><span style="line-height:1.5;">!</span><span style="line-height:1.5;">_init)<br>
{<br>
_rowLength </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> _width </span><span style="line-height:1.5;">*</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">4</span><span style="line-height:1.5;"> </span><span style="line-height:1.5;">+</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">;<br>
_buffer </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[_rowLength </span><span style="line-height:1.5;">*</span><span style="line-height:1.5;"> _height];<br><br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> Initialize</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">                </span><span style="color:rgb(0,0,255);line-height:1.5;">for</span><span style="line-height:1.5;"> (</span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> idx </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">; idx </span><span style="line-height:1.5;">&lt;</span><span style="line-height:1.5;"> _height; idx</span><span style="line-height:1.5;">++</span><span style="line-height:1.5;">)<br>
{<br>
_buffer[idx </span><span style="line-height:1.5;">*</span><span style="line-height:1.5;"> _rowLength] </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">;      </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> Filter bit</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">                }<br><br>
_init </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">;<br>
}<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> ((col </span><span style="line-height:1.5;">&gt;</span><span style="line-height:1.5;"> _width) </span><span style="line-height:1.5;">||</span><span style="line-height:1.5;"> (col </span><span style="line-height:1.5;">&lt;</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">))<br>
{<br>
OnImageError(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Error: Column must be greater than 0 and less than the Width</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);<br>
}<br></span><span style="color:rgb(0,0,255);line-height:1.5;">else</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> ((row </span><span style="line-height:1.5;">&gt;</span><span style="line-height:1.5;"> _height) </span><span style="line-height:1.5;">||</span><span style="line-height:1.5;"> (row </span><span style="line-height:1.5;">&lt;</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">))<br>
{<br>
OnImageError(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Error: Row must be greater than 0 and less than the Height</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);<br>
}<br><br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> Set the pixel</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">            </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> start </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> _rowLength </span><span style="line-height:1.5;">*</span><span style="line-height:1.5;"> row </span><span style="line-height:1.5;">+</span><span style="line-height:1.5;"> col </span><span style="line-height:1.5;">*</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">4</span><span style="line-height:1.5;"> </span><span style="line-height:1.5;">+</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">;<br>
_buffer[start] </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> red;<br>
_buffer[start </span><span style="line-height:1.5;">+</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">] </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> green;<br>
_buffer[start </span><span style="line-height:1.5;">+</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">] </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> blue;<br>
_buffer[start </span><span style="line-height:1.5;">+</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">3</span><span style="line-height:1.5;">] </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> alpha;<br>
}<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> Color GetPixel(</span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> col, </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> row)<br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> ((col </span><span style="line-height:1.5;">&gt;</span><span style="line-height:1.5;"> _width) </span><span style="line-height:1.5;">||</span><span style="line-height:1.5;"> (col </span><span style="line-height:1.5;">&lt;</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">))<br>
{<br>
OnImageError(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Error: Column must be greater than 0 and less than the Width</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);<br>
}<br></span><span style="color:rgb(0,0,255);line-height:1.5;">else</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> ((row </span><span style="line-height:1.5;">&gt;</span><span style="line-height:1.5;"> _height) </span><span style="line-height:1.5;">||</span><span style="line-height:1.5;"> (row </span><span style="line-height:1.5;">&lt;</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">))<br>
{<br>
OnImageError(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Error: Row must be greater than 0 and less than the Height</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);<br>
}<br><br>
Color color </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> Color();<br></span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> _base </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> _rowLength </span><span style="line-height:1.5;">*</span><span style="line-height:1.5;"> row </span><span style="line-height:1.5;">+</span><span style="line-height:1.5;"> col </span><span style="line-height:1.5;">+</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">;<br><br>
color.R </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> _buffer[_base];<br>
color.G </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> _buffer[_base </span><span style="line-height:1.5;">+</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">];<br>
color.B </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> _buffer[_base </span><span style="line-height:1.5;">+</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">];<br>
color.A </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> _buffer[_base </span><span style="line-height:1.5;">+</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">3</span><span style="line-height:1.5;">];<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> color;<br>
}<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> Stream GetStream()<br>
{<br>
Stream stream;<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> (</span><span style="line-height:1.5;">!</span><span style="line-height:1.5;">_init)<br>
{<br>
OnImageError(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Error: Image has not been initialized</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);<br>
stream </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">;<br>
}<br></span><span style="color:rgb(0,0,255);line-height:1.5;">else</span><span style="line-height:1.5;"><br>
{<br>
stream </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> PngEncoder.Encode(_buffer, _width, _height);<br>
}<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> stream;<br>
}<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> OnImageError(</span><span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> msg)<br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> (</span><span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;"> </span><span style="line-height:1.5;">!=</span><span style="line-height:1.5;"> ImageError)<br>
{<br>
EditableImageErrorEventArgs args </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> EditableImageErrorEventArgs();<br>
args.ErrorMessage </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> msg;<br>
ImageError(</span><span style="color:rgb(0,0,255);line-height:1.5;">this</span><span style="line-height:1.5;">, args);<br>
}<br>
}<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> EditableImageErrorEventArgs : EventArgs<br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> _errorMessage </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;">.Empty;<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> ErrorMessage<br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">get</span><span style="line-height:1.5;"> { </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> _errorMessage; }<br></span><span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;"> { _errorMessage </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> value; }<br>
}<br>
}<br><br>
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:verdana, 'ms song', '宋体', Arial, '微软雅黑', Helvetica, sans-serif;font-size:15px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 这是Png操作类：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="line-height:1.5;">    </span><span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> </span><span style="color:rgb(128,128,128);line-height:1.5;">&lt;summary&gt;</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> PNG格式操作类<br></span><span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> </span><span style="color:rgb(128,128,128);line-height:1.5;">&lt;/summary&gt;</span><span style="color:rgb(128,128,128);line-height:1.5;"><br></span><span style="line-height:1.5;">    </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> PngEncoder<br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">const</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> _ADLER32_BASE </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">65521</span><span style="line-height:1.5;">;<br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">const</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> _MAXBLOCK </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0xFFFF</span><span style="line-height:1.5;">;<br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">static</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[] _HEADER </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> { </span><span style="color:rgb(128,0,128);line-height:1.5;">0x89</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">0x50</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">0x4E</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">0x47</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">0x0D</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">0x0A</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">0x1A</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">0x0A</span><span style="line-height:1.5;"> };<br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">static</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[] _IHDR </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> { (</span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">)</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">I</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">, (</span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">)</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">H</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">, (</span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">)</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">D</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">, (</span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">)</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">R</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;"> };<br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">static</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[] _GAMA </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> { (</span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">)</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">g</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">, (</span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">)</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">A</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">, (</span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">)</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">M</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">, (</span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">)</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">A</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;"> };<br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">static</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[] _IDAT </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> { (</span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">)</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">I</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">, (</span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">)</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">D</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">, (</span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">)</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">A</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">, (</span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">)</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">T</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;"> };<br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">static</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[] _IEND </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> { (</span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">)</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">I</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">, (</span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">)</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">E</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">, (</span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">)</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">N</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">, (</span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">)</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">D</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;"> };<br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">static</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[] _4BYTEDATA </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> { </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;"> };<br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">static</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[] _ARGB </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> { </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">8</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">6</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;"> };<br><br></span><span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> </span><span style="color:rgb(128,128,128);line-height:1.5;">&lt;summary&gt;</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> 编码<br></span><span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> </span><span style="color:rgb(128,128,128);line-height:1.5;">&lt;/summary&gt;</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> </span><span style="color:rgb(128,128,128);line-height:1.5;">&lt;param name="data"&gt;&lt;/param&gt;</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> </span><span style="color:rgb(128,128,128);line-height:1.5;">&lt;param name="width"&gt;&lt;/param&gt;</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> </span><span style="color:rgb(128,128,128);line-height:1.5;">&lt;param name="height"&gt;&lt;/param&gt;</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;"> </span><span style="color:rgb(128,128,128);line-height:1.5;">&lt;returns&gt;&lt;/returns&gt;</span><span style="color:rgb(128,128,128);line-height:1.5;"><br></span><span style="line-height:1.5;">        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">static</span><span style="line-height:1.5;"> Stream Encode(</span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[] data, </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> width, </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> height)<br>
{<br>
MemoryStream ms </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> MemoryStream();<br></span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[] size;<br><br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> Write PNG header</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">            ms.Write(_HEADER, </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, _HEADER.Length);<br><br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> Write IHDR<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">  Width:              4 bytes<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">  Height:             4 bytes<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">  Bit depth:          1 byte<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">  Color type:         1 byte<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">  Compression method: 1 byte<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">  Filter method:      1 byte<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">  Interlace method:   1 byte</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;"><br>
size </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> BitConverter.GetBytes(width);<br>
_ARGB[</span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">] </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> size[</span><span style="color:rgb(128,0,128);line-height:1.5;">3</span><span style="line-height:1.5;">]; _ARGB[</span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">] </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> size[</span><span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">]; _ARGB[</span><span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">] </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> size[</span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">]; _ARGB[</span><span style="color:rgb(128,0,128);line-height:1.5;">3</span><span style="line-height:1.5;">] </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> size[</span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">];<br><br>
size </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> BitConverter.GetBytes(height);<br>
_ARGB[</span><span style="color:rgb(128,0,128);line-height:1.5;">4</span><span style="line-height:1.5;">] </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> size[</span><span style="color:rgb(128,0,128);line-height:1.5;">3</span><span style="line-height:1.5;">]; _ARGB[</span><span style="color:rgb(128,0,128);line-height:1.5;">5</span><span style="line-height:1.5;">] </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> size[</span><span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">]; _ARGB[</span><span style="color:rgb(128,0,128);line-height:1.5;">6</span><span style="line-height:1.5;">] </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> size[</span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">]; _ARGB[</span><span style="color:rgb(128,0,128);line-height:1.5;">7</span><span style="line-height:1.5;">] </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> size[</span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">];<br><br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> Write IHDR chunk</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">            WriteChunk(ms, _IHDR, _ARGB);<br><br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> Set gamma = 1</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">            size </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> BitConverter.GetBytes(</span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;"> </span><span style="line-height:1.5;">*</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">100000</span><span style="line-height:1.5;">);<br>
_4BYTEDATA[</span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">] </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> size[</span><span style="color:rgb(128,0,128);line-height:1.5;">3</span><span style="line-height:1.5;">]; _4BYTEDATA[</span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">] </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> size[</span><span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">]; _4BYTEDATA[</span><span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">] </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> size[</span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">]; _4BYTEDATA[</span><span style="color:rgb(128,0,128);line-height:1.5;">3</span><span style="line-height:1.5;">] </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> size[</span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">];<br><br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> Write gAMA chunk</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">            WriteChunk(ms, _GAMA, _4BYTEDATA);<br><br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> Write IDAT chunk</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">            </span><span style="color:rgb(0,0,255);line-height:1.5;">uint</span><span style="line-height:1.5;"> widthLength </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> (</span><span style="color:rgb(0,0,255);line-height:1.5;">uint</span><span style="line-height:1.5;">)(width </span><span style="line-height:1.5;">*</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">4</span><span style="line-height:1.5;">) </span><span style="line-height:1.5;">+</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">;<br></span><span style="color:rgb(0,0,255);line-height:1.5;">uint</span><span style="line-height:1.5;"> dcSize </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> widthLength </span><span style="line-height:1.5;">*</span><span style="line-height:1.5;"> (</span><span style="color:rgb(0,0,255);line-height:1.5;">uint</span><span style="line-height:1.5;">)height;<br><br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> First part of ZLIB header is 78 1101 1010 (DA) 0000 00001 (01)<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> ZLIB info<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> CMF Byte: 78<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">  CINFO = 7 (32K window size)<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">  CM = 8 = (deflate compression)<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> FLG Byte: DA<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">  FLEVEL = 3 (bits 6 and 7 - ignored but signifies max compression)<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">  FDICT = 0 (bit 5, 0 - no preset dictionary)<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">  FCHCK = 26 (bits 0-4 - ensure CMF*256+FLG / 31 has no remainder)<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> Compressed data<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">  FLAGS: 0 or 1<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">    00000 00 (no compression) X (X=1 for last block, 0=not the last block)<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">    LEN = length in bytes (equal to ((width*4)+1)*height<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">    NLEN = one's compliment of LEN<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">    Example: 1111 1011 1111 1111 (FB), 0000 0100 0000 0000 (40)<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">    Data for each line: 0 [RGBA] [RGBA] [RGBA] ...<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">    ADLER32</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;"><br></span><span style="color:rgb(0,0,255);line-height:1.5;">uint</span><span style="line-height:1.5;"> adler </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> ComputeAdler32(data);<br>
MemoryStream comp </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> MemoryStream();<br><br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> 64K的块数计算</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">            </span><span style="color:rgb(0,0,255);line-height:1.5;">uint</span><span style="line-height:1.5;"> rowsPerBlock </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> _MAXBLOCK </span><span style="line-height:1.5;">/</span><span style="line-height:1.5;"> widthLength;<br></span><span style="color:rgb(0,0,255);line-height:1.5;">uint</span><span style="line-height:1.5;"> blockSize </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> rowsPerBlock </span><span style="line-height:1.5;">*</span><span style="line-height:1.5;"> widthLength;<br></span><span style="color:rgb(0,0,255);line-height:1.5;">uint</span><span style="line-height:1.5;"> blockCount;<br></span><span style="color:rgb(0,0,255);line-height:1.5;">ushort</span><span style="line-height:1.5;"> length;<br></span><span style="color:rgb(0,0,255);line-height:1.5;">uint</span><span style="line-height:1.5;"> remainder </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> dcSize;<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> ((dcSize </span><span style="line-height:1.5;">%</span><span style="line-height:1.5;"> blockSize) </span><span style="line-height:1.5;">==</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">)<br>
{<br>
blockCount </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> dcSize </span><span style="line-height:1.5;">/</span><span style="line-height:1.5;"> blockSize;<br>
}<br></span><span style="color:rgb(0,0,255);line-height:1.5;">else</span><span style="line-height:1.5;"><br>
{<br>
blockCount </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> (dcSize </span><span style="line-height:1.5;">/</span><span style="line-height:1.5;"> blockSize) </span><span style="line-height:1.5;">+</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">;<br>
}<br><br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> 头部</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">            comp.WriteByte(</span><span style="color:rgb(128,0,128);line-height:1.5;">0x78</span><span style="line-height:1.5;">);<br>
comp.WriteByte(</span><span style="color:rgb(128,0,128);line-height:1.5;">0xDA</span><span style="line-height:1.5;">);<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">for</span><span style="line-height:1.5;"> (</span><span style="color:rgb(0,0,255);line-height:1.5;">uint</span><span style="line-height:1.5;"> blocks </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">; blocks </span><span style="line-height:1.5;">&lt;</span><span style="line-height:1.5;"> blockCount; blocks</span><span style="line-height:1.5;">++</span><span style="line-height:1.5;">)<br>
{<br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> 长度</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">                length </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> (</span><span style="color:rgb(0,0,255);line-height:1.5;">ushort</span><span style="line-height:1.5;">)((remainder </span><span style="line-height:1.5;">&lt;</span><span style="line-height:1.5;"> blockSize) </span><span style="line-height:1.5;">?</span><span style="line-height:1.5;"> remainder : blockSize);<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> (length </span><span style="line-height:1.5;">==</span><span style="line-height:1.5;"> remainder)<br>
{<br>
comp.WriteByte(</span><span style="color:rgb(128,0,128);line-height:1.5;">0x01</span><span style="line-height:1.5;">);<br>
}<br></span><span style="color:rgb(0,0,255);line-height:1.5;">else</span><span style="line-height:1.5;"><br>
{<br>
comp.WriteByte(</span><span style="color:rgb(128,0,128);line-height:1.5;">0x00</span><span style="line-height:1.5;">);<br>
}<br><br>
comp.Write(BitConverter.GetBytes(length), </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">);<br><br>
comp.Write(BitConverter.GetBytes((</span><span style="color:rgb(0,0,255);line-height:1.5;">ushort</span><span style="line-height:1.5;">)</span><span style="line-height:1.5;">~</span><span style="line-height:1.5;">length), </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, </span><span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">);<br><br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> Write 块</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">                comp.Write(data, (</span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;">)(blocks </span><span style="line-height:1.5;">*</span><span style="line-height:1.5;"> blockSize), length);<br><br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">下一块</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">                remainder </span><span style="line-height:1.5;">-=</span><span style="line-height:1.5;"> blockSize;<br>
}<br><br>
WriteReversedBuffer(comp, BitConverter.GetBytes(adler));<br>
comp.Seek(</span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, SeekOrigin.Begin);<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[] dat </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[comp.Length];<br>
comp.Read(dat, </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, (</span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;">)comp.Length);<br><br>
WriteChunk(ms, _IDAT, dat);<br><br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> Write IEND chunk</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">            WriteChunk(ms, _IEND, </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[</span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">]);<br><br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> Reset stream</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">            ms.Seek(</span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, SeekOrigin.Begin);<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> ms;<br>
}<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">static</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> WriteReversedBuffer(Stream stream, </span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[] data)<br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> size </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> data.Length;<br></span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[] reorder </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[size];<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">for</span><span style="line-height:1.5;"> (</span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> idx </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">; idx </span><span style="line-height:1.5;">&lt;</span><span style="line-height:1.5;"> size; idx</span><span style="line-height:1.5;">++</span><span style="line-height:1.5;">)<br>
{<br>
reorder[idx] </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> data[size </span><span style="line-height:1.5;">-</span><span style="line-height:1.5;"> idx </span><span style="line-height:1.5;">-</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">];<br>
}<br>
stream.Write(reorder, </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, size);<br>
}<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">static</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> WriteChunk(Stream stream, </span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[] type, </span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[] data)<br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> idx;<br></span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> size </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> type.Length;<br></span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[] buffer </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[type.Length </span><span style="line-height:1.5;">+</span><span style="line-height:1.5;"> data.Length];<br><br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> 初始化缓冲</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">            </span><span style="color:rgb(0,0,255);line-height:1.5;">for</span><span style="line-height:1.5;"> (idx </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">; idx </span><span style="line-height:1.5;">&lt;</span><span style="line-height:1.5;"> type.Length; idx</span><span style="line-height:1.5;">++</span><span style="line-height:1.5;">)<br>
{<br>
buffer[idx] </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> type[idx];<br>
}<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">for</span><span style="line-height:1.5;"> (idx </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">; idx </span><span style="line-height:1.5;">&lt;</span><span style="line-height:1.5;"> data.Length; idx</span><span style="line-height:1.5;">++</span><span style="line-height:1.5;">)<br>
{<br>
buffer[idx </span><span style="line-height:1.5;">+</span><span style="line-height:1.5;"> size] </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> data[idx];<br>
}<br><br>
WriteReversedBuffer(stream, BitConverter.GetBytes(data.Length));<br><br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> Write 类型和数据</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">            stream.Write(buffer, </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">, buffer.Length);   </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> Should always be 4 bytes<br><br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> 计算和书写的CRC</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;"><br>
WriteReversedBuffer(stream, BitConverter.GetBytes(GetCRC(buffer)));<br>
}<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">static</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">uint</span><span style="line-height:1.5;">[] _crcTable </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">uint</span><span style="line-height:1.5;">[</span><span style="color:rgb(128,0,128);line-height:1.5;">256</span><span style="line-height:1.5;">];<br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">static</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">bool</span><span style="line-height:1.5;"> _crcTableComputed </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">false</span><span style="line-height:1.5;">;<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">static</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> MakeCRCTable()<br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">uint</span><span style="line-height:1.5;"> c;<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">for</span><span style="line-height:1.5;"> (</span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> n </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">; n </span><span style="line-height:1.5;">&lt;</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">256</span><span style="line-height:1.5;">; n</span><span style="line-height:1.5;">++</span><span style="line-height:1.5;">)<br>
{<br>
c </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> (</span><span style="color:rgb(0,0,255);line-height:1.5;">uint</span><span style="line-height:1.5;">)n;<br></span><span style="color:rgb(0,0,255);line-height:1.5;">for</span><span style="line-height:1.5;"> (</span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> k </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">; k </span><span style="line-height:1.5;">&lt;</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">8</span><span style="line-height:1.5;">; k</span><span style="line-height:1.5;">++</span><span style="line-height:1.5;">)<br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> ((c </span><span style="line-height:1.5;">&amp;</span><span style="line-height:1.5;"> (</span><span style="color:rgb(128,0,128);line-height:1.5;">0x00000001</span><span style="line-height:1.5;">)) </span><span style="line-height:1.5;">&gt;</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">)<br>
c </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0xEDB88320</span><span style="line-height:1.5;"> </span><span style="line-height:1.5;">^</span><span style="line-height:1.5;"> (c </span><span style="line-height:1.5;">&gt;&gt;</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">);<br></span><span style="color:rgb(0,0,255);line-height:1.5;">else</span><span style="line-height:1.5;"><br>
c </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> c </span><span style="line-height:1.5;">&gt;&gt;</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">;<br>
}<br>
_crcTable[n] </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> c;<br>
}<br><br>
_crcTableComputed </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">;<br>
}<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">static</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">uint</span><span style="line-height:1.5;"> UpdateCRC(</span><span style="color:rgb(0,0,255);line-height:1.5;">uint</span><span style="line-height:1.5;"> crc, </span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[] buf, </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> len)<br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">uint</span><span style="line-height:1.5;"> c </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> crc;<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> (</span><span style="line-height:1.5;">!</span><span style="line-height:1.5;">_crcTableComputed)<br>
{<br>
MakeCRCTable();<br>
}<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">for</span><span style="line-height:1.5;"> (</span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> n </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">; n </span><span style="line-height:1.5;">&lt;</span><span style="line-height:1.5;"> len; n</span><span style="line-height:1.5;">++</span><span style="line-height:1.5;">)<br>
{<br>
c </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> _crcTable[(c </span><span style="line-height:1.5;">^</span><span style="line-height:1.5;"> buf[n]) </span><span style="line-height:1.5;">&amp;</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0xFF</span><span style="line-height:1.5;">] </span><span style="line-height:1.5;">^</span><span style="line-height:1.5;"> (c </span><span style="line-height:1.5;">&gt;&gt;</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">8</span><span style="line-height:1.5;">);<br>
}<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> c;<br>
}<br><br></span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">返回的字节的CRC缓冲区</span><span style="color:rgb(0,128,0);line-height:1.5;"><br></span><span style="line-height:1.5;">        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">static</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">uint</span><span style="line-height:1.5;"> GetCRC(</span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[] buf)<br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> UpdateCRC(</span><span style="color:rgb(128,0,128);line-height:1.5;">0xFFFFFFFF</span><span style="line-height:1.5;">, buf, buf.Length) </span><span style="line-height:1.5;">^</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0xFFFFFFFF</span><span style="line-height:1.5;">;<br>
}<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">static</span><span style="line-height:1.5;"> </span><span style="color:rgb(0,0,255);line-height:1.5;">uint</span><span style="line-height:1.5;"> ComputeAdler32(</span><span style="color:rgb(0,0,255);line-height:1.5;">byte</span><span style="line-height:1.5;">[] buf)<br>
{<br></span><span style="color:rgb(0,0,255);line-height:1.5;">uint</span><span style="line-height:1.5;"> s1 </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">;<br></span><span style="color:rgb(0,0,255);line-height:1.5;">uint</span><span style="line-height:1.5;"> s2 </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">;<br></span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> length </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> buf.Length;<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">for</span><span style="line-height:1.5;"> (</span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> idx </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">; idx </span><span style="line-height:1.5;">&lt;</span><span style="line-height:1.5;"> length; idx</span><span style="line-height:1.5;">++</span><span style="line-height:1.5;">)<br>
{<br>
s1 </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> (s1 </span><span style="line-height:1.5;">+</span><span style="line-height:1.5;"> (</span><span style="color:rgb(0,0,255);line-height:1.5;">uint</span><span style="line-height:1.5;">)buf[idx]) </span><span style="line-height:1.5;">%</span><span style="line-height:1.5;"> _ADLER32_BASE;<br>
s2 </span><span style="line-height:1.5;">=</span><span style="line-height:1.5;"> (s2 </span><span style="line-height:1.5;">+</span><span style="line-height:1.5;"> s1) </span><span style="line-height:1.5;">%</span><span style="line-height:1.5;"> _ADLER32_BASE;<br>
}<br><br></span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> (s2 </span><span style="line-height:1.5;">&lt;&lt;</span><span style="line-height:1.5;"> </span><span style="color:rgb(128,0,128);line-height:1.5;">16</span><span style="line-height:1.5;">) </span><span style="line-height:1.5;">+</span><span style="line-height:1.5;"> s1;<br>
}<br>
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:verdana, 'ms song', '宋体', Arial, '微软雅黑', Helvetica, sans-serif;font-size:15px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 最后我们来看看运行的效果如下，如需源码请点击&nbsp;<a href="http://files.cnblogs.com/chengxingliang/SLInkPresenter.zip" rel="nofollow" style="color:#000000;">SLInkPresenter.zip</a>下载：</p> 
   <p style="font-family:verdana, 'ms song', '宋体', Arial, '微软雅黑', Helvetica, sans-serif;font-size:15px;"><img alt="" src="https://pic002.cnblogs.com/images/2011/140041/2011072715180082.jpg" width="973" height="577" style="border:0px;"></p> 
   <p style="font-family:verdana, 'ms song', '宋体', Arial, '微软雅黑', Helvetica, sans-serif;font-size:15px;"><br></p> 
   <p style="font-family:verdana, 'ms song', '宋体', Arial, '微软雅黑', Helvetica, sans-serif;font-size:15px;"><br></p> 
   <p><font><span style="font-size:15px;">本文转自程兴亮博客园博客，原文链接：http://www.cnblogs.com/chengxingliang/archive/2011/07/28/2118404.html</span></font><span style="font-size:15px;font-family:verdana, 'ms song', '宋体', Arial, '微软雅黑', Helvetica, sans-serif;">，如需转载请自行联系原作者</span></p> 
   <div>
    <br>
   </div> 
   <p style="font-family:verdana, 'ms song', '宋体', Arial, '微软雅黑', Helvetica, sans-serif;font-size:15px;"><br></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
