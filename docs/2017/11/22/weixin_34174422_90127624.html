<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>云与备份之（1）：VMware虚机备份和恢复 « NotBeCN</title>
  <meta name="description" content="             本系列文章会介绍云与备份之间的关系，包括：    （1）VMware 虚机备份和恢复    （2）KVM 虚机备份和恢复    （3）云与备份    （4）OpenStack 与备份    （5）公有云与备份    &nbsp;    1. 与备份有关的VMWare基础知识    1.1...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/22/weixin_34174422_90127624.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">云与备份之（1）：VMware虚机备份和恢复</h1>
    <p class="post-meta">Nov 22, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">本系列文章会介绍云与备份之间的关系，包括：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）<a href="http://www.cnblogs.com/sammyliu/p/5661085.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">VMware 虚机备份和恢复</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）KVM 虚机备份和恢复</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（3）云与备份</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（4）OpenStack 与备份</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（5）公有云与备份</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1. 与备份有关的VMWare基础知识</h2> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.1 VMware 虚机磁盘在 ESXi 宿主机上的文件</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">简单来说，虚机的每个虚拟磁盘由ESXi 宿主机上的三个文件组成（这里的虚机名字是 sammy-target-win-small，下面是其第一个磁盘对应的三个文件）：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">sammy-target-win-small.vmdk （配置文件，大小 633 字节）</li> 
    <li style="list-style-type:disc;">sammy-target-win-small-flat.vmdk （二进制文件，大小 12884901888 字节）</li> 
    <li style="list-style-type:disc;">sammy-target-win-small-ctk.vmdk （二进制文件，大小 78694 字节）</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">其中，</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">第一个文件保存的是该磁盘的元数据，其中包括另外两个文件的信息</li>
   </ul>
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre><span style="line-height:1.5;"># Extent description
RW </span><span style="color:rgb(128,0,128);line-height:1.5;">25165824</span> VMFS <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">sammy-target-win-small-flat.vmdk</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">

# Change Tracking File
changeTrackPath</span>=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">sammy-target-win-small-ctk.vmdk</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span></pre>
   </div> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">第二个文件是 Extent description 文件，二进制数据保存在这个文件中。下面会介绍使用API获取该文件中数据的方法。</li> 
    <li style="list-style-type:disc;">第三个文件是 CTK 文件。下面讲到 CTK 的时候再说。</li> 
   </ul>
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.2 快照（Snapshot）</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">虚机的快照是虚机在某个时间点的状态和数据，其中，状态是指虚机的状态，包括运行状态，配置等；数据是指虚机的虚拟磁盘中的数据。快照的基本操作包括：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">创建快照（create）</li> 
    <li style="list-style-type:disc;">删除快照（delete）</li> 
    <li style="list-style-type:disc;">快照合并（consolidate）</li> 
    <li style="list-style-type:disc;">恢复到快照（revert）</li> 
   </ul>
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1.2.1 创建快照</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">对上面的虚机创建一个快照，除了快照定义文件以外，对该磁盘，新增了三个文件：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>-rw-------    <span style="color:rgb(128,0,128);line-height:1.5;">1</span> root     root        <span style="color:rgb(128,0,128);line-height:1.5;">786944</span> Jul <span style="color:rgb(128,0,128);line-height:1.5;">11</span> <span style="color:rgb(128,0,128);line-height:1.5;">10</span>:<span style="color:rgb(128,0,128);line-height:1.5;">55</span> sammy-target-win-small-<span style="color:rgb(128,0,128);line-height:1.5;">000001</span>-<span style="line-height:1.5;">ctk.vmdk
</span>-rw-------    <span style="color:rgb(128,0,128);line-height:1.5;">1</span> root     root         <span style="color:rgb(128,0,128);line-height:1.5;">28672</span> Jul <span style="color:rgb(128,0,128);line-height:1.5;">11</span> <span style="color:rgb(128,0,128);line-height:1.5;">10</span>:<span style="color:rgb(128,0,128);line-height:1.5;">55</span> sammy-target-win-small-<span style="color:rgb(128,0,128);line-height:1.5;">000001</span>-<span style="line-height:1.5;">delta.vmdk
</span>-rw-------    <span style="color:rgb(128,0,128);line-height:1.5;">1</span> root     root           <span style="color:rgb(128,0,128);line-height:1.5;">428</span> Jul <span style="color:rgb(128,0,128);line-height:1.5;">11</span> <span style="color:rgb(128,0,128);line-height:1.5;">10</span>:<span style="color:rgb(128,0,128);line-height:1.5;">55</span> sammy-target-win-small-<span style="color:rgb(128,0,128);line-height:1.5;">000001</span>.vmdk</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">第一个依然是 ctk 文件，第二个是 delta 文件，第三个是非二进制文件。然后再创建第二个快照，就成了这样子：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/697113/201607/697113-20160712161702811-741540723.jpg" alt="" style="border:0px;">（RW = 读写，RO = 只读）</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">从数据的角度看：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/697113/201607/697113-20160711191628201-156447856.jpg" alt="" width="530" height="385" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（绿色部分是从虚机视角看数据；最下面的红框是 base vmdk 中的数据；中间的红框是 delta vmdk 中的数据）</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/697113/201607/697113-20160711191815076-1831214204.jpg" alt="" width="512" height="344" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">现在可以简单总结一下 VMware 快照的特点：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">快照保存虚机在某一个时间点的状态和数据</li> 
    <li style="list-style-type:disc;">对一个虚机做快照，相当于将虚机当前的磁盘设为只读模式，然后创建 delta vmdk 文件，它将会接受新的数据写操作。在存在<span style="line-height:1.5;">多个快照的情况下，之前的快照磁盘变为只读。</span> </li> 
    <li style="list-style-type:disc;">写损失：写的时候，遵循 Copy-on-write 机制，按照数据分块，当需要修改某一块中的数据时，先将它从父vmdk 中拷贝到 delta vmdk，然后再对它修改。</li> 
    <li style="list-style-type:disc;"><span style="line-height:1.5;">读损失：当读取某一块数据时，ESXi 需要判断从哪里去读：对于没有修改的数据块，从父 vmdk 读；对已经修改了的数据块，从 delta vmdk 读。可见，客户端的一次读操作，可能需要从不同的 vmdk 上读取数据。</span></li> 
    <li style="list-style-type:disc;"><span style="line-height:1.5;">delta vmdk 的大小不会超过 base vmdk 的大小，因为极限情况是所有的数据都被拷贝到delta vmdk 并且都没修改了。</span></li> 
    <li style="list-style-type:disc;"><span style="line-height:1.5;">因为快照会带来读和写损失，因此一个虚机不能有太多的快照。vSphere 限定一个虚机最多有 32 个快照，但是建议最多只有 2-3 个，而且快照的保留时间不超过一天。</span></li> 
   </ul>
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1.2.2 删除快照</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">显然，快照只是内部数据，保存的是过去某时间点虚机的状态，对外部不可见，因此，删除快照不能影响虚机当前的状态和数据。因此，这里有三种可能：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）快照是基于原始虚机的：delta vmdk 中的数据会向 base vmdk 合并，然后 delta vmdk 被删除。（如下图中的s1）</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）待删除快照在虚机的数据路径上：delta vmdk 中的数据会想父快照的 vmdk 合并，然后delta vmdk 被删除。（如下图中的s2）</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（3）待删除快照不再虚机的数据路径上：不需要合并，直接删除。（如下图中的 s3）</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/697113/201607/697113-20160711192602607-1856474896.jpg" alt="" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">现在可以简单总结一下删除快照的特点：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">删除快照意味着快照之后的改变会被合并进快照之前的数据，因此，虚机再也无法回到所做快照之时的状态了。</li> 
    <li style="list-style-type:disc;">删除快照过程包括两个异步的操作：从 Snapshot manager 中将快照删除，vmdk 数据合并。如果第一步成功而第二步失败，那么将有残留的 delta 文件被保留下来，这是就需要下面将介绍的手工合并操作。</li> 
    <li style="list-style-type:disc;">删除快照可能会打来大量的数据写操作，这期间，虚机的性能会受到负面影响</li> 
    <li style="list-style-type:disc;">删除快照有时候要花费很长的时间，特别是对于长时间存在的大容量磁盘的快照。 VMware 专门出了一个KB来让用户估计所需要的时间：<a href="https://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;cmd=displayKC&amp;externalId=2053758" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">Estimating the time required to consolidate snapshots during the snapshot removal for VMware ESX and VMware ESXi (2053758)</a> </li> 
    <li style="list-style-type:disc;">当删除所有快照时，自从 vSphere 4 Update 2 开始起过程有了优化，不再是重定向下一层一层地合并，而是各层都直接合并到 base disk。</li> 
   </ul>
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1.2.3 快照合并（consolidation）</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">上面谈到了快照删除操作的数据合并可能会失败。这种失败会带来很多问题，包括不必要的磁盘空间占用，以及虚机性能下降。因此，当出现这种情况时，vCenter 会向用户提示需要做 consolidation 了。该操作会检查虚机当前所有的 vmdk 分层，将冗余的 delta 文件先合并再删除。</p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1.2.4 恢复到快照</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">恢复到快照操作也比较好理解，就是将虚机的 base vmdk 指向目标快照的 vmdk，其结果是自从目标快照创建后的一切改动都没有了。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;<img src="https://images2015.cnblogs.com/blog/697113/201607/697113-20160712162235201-657170702.jpg" alt="" width="237" height="374" style="border:0px;"></p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;"><span style="line-height:1.5;font-size:1.17em;">1.3 VMware API</span></h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">VMware 提供非常丰富的 API：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/697113/201607/697113-20160714220854076-1154150949.jpg" alt="" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">其中，我们可以将与与备份相关的API分为两类，一类是控制平面的API，它们主要用做管理 vSphere 虚拟化环境；另一类是数据平面API，它们用于操作虚机的虚拟磁盘。</p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1.3.1 VMware API 和 SDK</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">VMware 通过 Web Service 向客户端提供访问接口，这些接口可用于管理虚机和其他虚拟设施，包括数据中心（datacenter），数据存储（datastore）, 网络（network）等。它还提供了包括Java, .NET, Python, Perl, REST, 以及 Ruby 等几种语言在内的 SDK。对于其他语言，则需要通过 SOAP 协议访问其 web service，<a href="http://www.genivia.com/doc/soapdoc2.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">gSoap&nbsp;</a>是一种比较常见的用于C/C++语言编写 web service 客户端程序的套件。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">详细情况请阅读&nbsp;<a href="https://www.vmware.com/support/pubs/sdk_pubs.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">https://www.vmware.com/support/pubs/sdk_pubs.html</a></p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1.3.2 VDDK 和 VADP</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">VDDK 全称是 Virtual Disk Development Kit（虚拟磁盘开发包），它能帮助开发人员创建访问虚机存储的应用。VDDK 基于 Virtual disk API。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">Virtual disk API，即 &nbsp;VixDiskLib，是一组操作 VMDK 格式的虚拟磁盘文件的函数。它的主要功能包括：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">create, convert, expand, defragment, shrink, and rename 虚拟磁盘文件</li> 
    <li style="list-style-type:disc;">创建 redo logs 和删除 vmdk 文件</li> 
    <li style="list-style-type:disc;">访问 vmdk 文件中任意数据，以及读取元数据</li> 
    <li style="list-style-type:disc;">连接到远端 vSphe 存储，使用高级的传输方式，包括 SAN （备份程序所在的服务器能够直接通过 FC 或者 iSCSI 和虚机磁盘所在的存储连接），hotadd （虚拟磁盘附加到备份程序所在虚机成为其一个磁盘） 和 LAN （备份程序通过 LAN 访问虚拟磁盘）。</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">VADP 全称是 VMware Storage APIs - Data Protection（VMware 存储API-数据保护），它使用 virtual disk API 和部分 vSphre API 来创建和管理虚机的快照，支持全量和增量备份。&nbsp;</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.4 CBT (Changed Block Tracking 块修改跟踪)</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;CBT 是 VMware 在 vSphere 4.0 版本引入的为了实现增量备份的一个功能。VDAP 使用该功能，使得基于它开发的各种虚机备份应用能够做到增量备份。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/697113/201607/697113-20160713173818998-759713679.jpg" alt="" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">相对于全量备份时将vmdk 的全部数据块都保存下来（左图），基于 CBT 的增量备份只保存自从上次备份以来的发生了变化了的数据块（右图）。ESXi 为每个开启了 CBT 的虚机的虚拟磁盘都创建了一个 ctk 文件，它用于保存变化块的元数据。该功能将会对磁盘带来一点性能损失，因为，不使用的时候，可以关闭它，但是它对备份带来的好处是显而易见的。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">获取 CBT 变化块的函数的定义为：QueryChangedDiskAreas(snapshot, deviceKey, startOffSet, changeID)。其中，</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">snapshot 代表当前的快照，也就是“变化”时间段的后端点；</li> 
    <li style="list-style-type:disc;">deviceKey 是目标虚拟磁盘的 device ID；</li> 
    <li style="list-style-type:disc;">startOffSet 是开始获取变化块的offset；</li> 
    <li style="list-style-type:disc;">changeID 是指“变化”时间段的前端点，即老的快照的 changeID。</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">其结果类似 “(117768192, 65536),(132120576, 65536),(145096704, 43122688),(265289728, 65536),(958398464, 65536)”，每项的格式为 （offset，length），表示一个发生变化的数据块。</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.5 Quiseced Snapshot 和 VMware Tools</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;虚机快照按照不同的一致性可以分为三种：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">崩溃一致快照（crash-consistent snapshot）：当虚机上的应用还在运行，IO 还在进行时进行快照会得到这种快照。它相当于电脑突然断电了磁盘时的状态。</li> 
    <li style="list-style-type:disc;">文件系统一致快照（file-system-consistent snapshot）: 在做快照之前，虚机的文件系统被暂时冻结，内存中的脏数据都被刷进磁盘；在快照做完之后，文件系统被解冻。此时的快照是文件系统一致的。</li> 
    <li style="list-style-type:disc;">应用一致性（application-consistent snapshot）：在做快照之前，应用被暂时冻结，内存中应用的所有数据都被刷到磁盘，在快照做完之后，应用被解冻。</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">默认的快照是第一种，要得到后两种快照，需要增加相应的步骤。其实现方式主要可以分为两种：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">在较新的 Windows 客户机上，Windows 提供了 VSS（Volume Shadow Copy Service） 服务，它可以通过 requester-writer 方式来实现有冻结需求的应用和文件系统在快照之前进行冻结和快照之前进行解冻。Microsoft VSS 服务能够通过协调商务应用（比如SQL Server，Exchange server 以及 Oracle 等），文件系统，备份应用，快速恢复应用，以及存储硬件等来提供一致的阴影复制（shadow copies）。</li> 
    <li style="list-style-type:disc;">在老的 Windows， VMWare 提供了 SYNC 驱动； 在 Linux 系统上，VMware 提供了 vmsync 内核模块来实现文件系统一致性快照。</li> 
    <li style="list-style-type:disc;">在非 Windows 客户机上要实现应用一致性快照的话，需要编写具体应用对应的脚本，在调用后对应用进行冻结或者解冻。</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">那 VSS 服务，SYNC driver， vmsync 内核模块以及自定义脚本由谁来调用呢？VMware 提供了 VMware Tools，它是一个独立的程序，有不同的操作系统版本，它需要被安装在客户机内。以 VSS 为例，VMware tools 承担 VSS Requester 的角色，在做这种快照之前和之后，它调用 VSS 服务，VSS 服务又调用已经注册的 VSS Writer 来执行相应的操作。下图是个简单示例：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/697113/201607/697113-20160713180243998-852243911.jpg" alt="" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">后面两种类型的快照被称为 quiseced snapshot，包括 filesytem-quiseced snapshot 和 applicaiton-quiseced snapshot。其完整的流程大概为：</p> 
   <ol style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;">用户发出 quiesced snapshot 创建请求给 vCenter，vCenter 给虚机所在的 ESXi 的 hostd 服务发出指令</li> 
    <li style="list-style-type:decimal;">ESXi 上的 Hostd 将请求传给客户机内的 VMware tools</li> 
    <li style="list-style-type:decimal;">VMware tools 以 VSS Requester 的身份通知 VSS，VSS 再通知已经注册的文件系统以及各应用的 VSS writer 执行各自的数据下刷和冻结操作（应用的暂时冻结不能超过60秒）</li> 
    <li style="list-style-type:decimal;">一旦完成，VMware tools 将就结果告诉 hostd</li> 
    <li style="list-style-type:decimal;">Hostd 再执行快照操作</li> 
    <li style="list-style-type:decimal;">操作结束，按照前面的顺序再对文件系统和应用进行解冻</li> 
   </ol>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">再说一下 VMware tools。在 Windows 系统上，它的安装包里面包括了很多的驱动，这些驱动能增强虚机的用户体验，比如鼠标更加平滑，分辨率更高，声音效果更好等等；除了这些驱动以外，还有VSS support，它是 VMware tools 和 Windows VSS 之间交互的桥梁。要创建 quiseced snapshots，这项必须被安装。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/697113/201607/697113-20160714095153389-1811477909.jpg" alt="" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">注意安装 VMware tools 的时候，现在 VWC 里面选择 Guest-&gt;Install/Upgrade VMware Tools，然后登录虚机，找到前面步骤所挂接的磁盘，再双击安装程序开始安装过程。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">在 vCenter 客户端中，用户可以选择是否创建 quiesced snapshot：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/697113/201607/697113-20160719104729888-588449800.jpg" alt="" width="270" height="227" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">不同的情况下，有如下几种可能结果：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">没选择，或者选择了但是客户机内没有安装 VMware tools：创建 crash-consistent snapshot</li> 
    <li style="list-style-type:disc;">选择了，客户机安装了 VMware tools，有 MS VSS 但没有应用 vss writers，或者安装了 vmware vmsync driver：创建 filesystem-consistent snapshot</li> 
    <li style="list-style-type:disc;">选择了，客户机安装了 VMware tools，有 MS VSS，也有应用 vss writers，或者编写了应用一致性操作脚本：创建 application-consistent snapshot</li> 
   </ul>
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.6 虚拟磁盘传输模式（Tranport modes)</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">这个传输模式是指虚机或者虚机快照的虚拟磁盘中的数据被传送到备份程序的传输方式。VMware 在不同的环境中支持使用不同的传输模式，好的传输模式能大大增强传输传输效率。</p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1.6.1 SAN 模式</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">这种模式要求 VMware 备份程序所在的物理服务器能够通过 FC/iSCSI/SAS SAN 网络访问到虚拟磁盘。对备份来说，这是效率最高的传输模式。这种传输模式下，VADP API 从vCenter 或者 ESXi 上获取 VMFS LUN 的信息，然后再基于这些信息从 VMDK 所在的 FC/iSCSI/SAS LUN 中直接读取数据。下图是一个示例：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp;&nbsp;<img src="https://images2015.cnblogs.com/blog/697113/201607/697113-20160715143405764-1090827819.jpg" alt="" width="355" height="319" style="border:0px;">&nbsp; &nbsp; &nbsp;<img src="https://images2015.cnblogs.com/blog/697113/201607/697113-20160715141558639-1361252926.jpg" alt="" width="356" height="273" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">要使用这种模式：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">备份程序需要运行在物理服务器之内，该服务器必须能够通过SAN网络访问到VMFS LUN。</li> 
    <li style="list-style-type:disc;">SAN 模式对备份来说是最佳选择，但是对恢复来说却不是。</li> 
   </ul>
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1.6.2 LAN(NBD) 模式</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">这种模式下，ESX/ESXi 主机从其存储中读取数据，再通过 LAN 网络发到备份程序所在的主机。这种模式支持任何类型的存储。备份程序可以运行在一个虚机之内。需要的时候，可以使用 SSL 加密（NBDSSL）。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;<img src="https://images2015.cnblogs.com/blog/697113/201607/697113-20160715143801498-913230389.jpg" alt="" width="367" height="266" style="border:0px;">&nbsp;&nbsp;<img src="https://images2015.cnblogs.com/blog/697113/201607/697113-20160715142057842-1711109948.jpg" alt="" width="371" height="274" style="border:0px;"></p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1.6.3 HotAdd 模式</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">当备份存储运行在虚机之内时，可以利用 ESXi 的 SCSI HotAdd 特性来将虚拟磁盘直接挂在到该虚机上成为其一个本地磁盘。这种模式只能用于 SCSI 模式的虚拟磁盘，而不适用于 IDE 类型的。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/697113/201607/697113-20160715143128857-927132758.jpg" alt="" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">如果虚机的快照有两个虚拟磁盘，当备份程序在其所在的虚机（proxy）上使用 hotadd 模式连接到第一个磁盘后，你可以在 proxy 上看到该磁盘以及它的两个分区：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>Disk /dev/sdc: <span style="color:rgb(128,0,128);line-height:1.5;">12.9</span> GB, <span style="color:rgb(128,0,128);line-height:1.5;">12884901888</span><span style="line-height:1.5;"> bytes
</span><span style="color:rgb(128,0,128);line-height:1.5;">255</span> heads, <span style="color:rgb(128,0,128);line-height:1.5;">63</span> sectors/track, <span style="color:rgb(128,0,128);line-height:1.5;">1566</span> cylinders, total <span style="color:rgb(128,0,128);line-height:1.5;">25165824</span><span style="line-height:1.5;"> sectors
Units </span>= sectors of <span style="color:rgb(128,0,128);line-height:1.5;">1</span> * <span style="color:rgb(128,0,128);line-height:1.5;">512</span> = <span style="color:rgb(128,0,128);line-height:1.5;">512</span><span style="line-height:1.5;"> bytes
Sector size (logical</span>/physical): <span style="color:rgb(128,0,128);line-height:1.5;">512</span> bytes / <span style="color:rgb(128,0,128);line-height:1.5;">512</span><span style="line-height:1.5;"> bytes
I</span>/O size (minimum/optimal): <span style="color:rgb(128,0,128);line-height:1.5;">512</span> bytes / <span style="color:rgb(128,0,128);line-height:1.5;">512</span><span style="line-height:1.5;"> bytes
Disk identifier: </span><span style="color:rgb(128,0,128);line-height:1.5;">0x836df02a</span><span style="line-height:1.5;">

   Device Boot      Start         End      Blocks   Id  System
</span>/dev/sdc1   *        <span style="color:rgb(128,0,128);line-height:1.5;">2048</span>      <span style="color:rgb(128,0,128);line-height:1.5;">206847</span>      <span style="color:rgb(128,0,128);line-height:1.5;">102400</span>    <span style="color:rgb(128,0,128);line-height:1.5;">7</span>  HPFS/NTFS/<span style="line-height:1.5;">exFAT
</span>/dev/sdc2          <span style="color:rgb(128,0,128);line-height:1.5;">206848</span>    <span style="color:rgb(128,0,128);line-height:1.5;">25163775</span>    <span style="color:rgb(128,0,128);line-height:1.5;">12478464</span>    <span style="color:rgb(128,0,128);line-height:1.5;">7</span>  HPFS/NTFS/exFAT</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">然后 proxy 就可以象读取自己的磁盘一样从该磁盘读取文件了。简单来说，hotadd 和你手工把一个快照的某个vmdk 挂接到另一个运行着的虚机的原理和要求是一样的。你也可以通过手工的方式来确定hotadd是否能成功。hotadd 和 nbd(ssl)都走的是以太网，但是区别在于，nbd 走的是管理网络，而这种网络的带宽往往有限；而 hotadd 走的是数据/存储网络，而这种网络往往被单独出来，而且带宽往往比较大。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">关于各种传输模式的概念，使用，要求和最佳实践等，请阅读 MVware 的相关文档。</p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1.6.4 传输模式的选择</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp;备份程序都是调用 VDAP 的 Connect/ConnectEx 接口来建立和 vmdk 的连接的。如果不指定传输模式的话，在这个过程中，VADP API 会按照顺序，依次尝试 san，hotadd 和 nbd 三种模式，直到有一种成功或者全部失败。当有成功时，客户端程序可以调用 GetTransportMode() API 返回该连接所使用的传输模式。当然，客户端程序也可以指定特定的传输模式。在操作结束后，客户端程序需要调用 Disconnect API 来断开已经建立的连接。</p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">2. 传统VMware环境的备份软件的基本架构</h2> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/697113/201607/697113-20160714144633607-167245495.jpg" alt="" width="663" height="462" style="border:0px;"></p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">3. 简要 VMware 虚机镜像备份和恢复流程</h2> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">3.1 备份流程</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/697113/201607/697113-20160714221958654-1778704851.jpg" alt="" width="785" height="348" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">简要过程：</p> 
   <ol style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;">备份程序使用 vSphere API 建立和虚机的连接，并备份虚机的配置信息</li> 
    <li style="list-style-type:decimal;">使用 vSphere API 创建快照，往往会创建 Quiseced 类型的快照，来保证应用或者文件系统一致性</li> 
    <li style="list-style-type:decimal;">使用 VDDK API 建立和快照的第一个磁盘的连接，连接的传输模式将会是 san/hotadd/nbdssl/nbd 中的一种。</li> 
    <li style="list-style-type:decimal;">&nbsp;对该磁盘，调用&nbsp;QueryChangedDiskAreas 接口，获取它与上次备份时磁盘之间发生了变化的数据块列表</li> 
    <li style="list-style-type:decimal;">调用 VDDK API，读取发生了变化的数据块的内容并写入存储中的备份</li> 
    <li style="list-style-type:decimal;">依次处理其它磁盘</li> 
    <li style="list-style-type:decimal;">所有磁盘处理完毕后，删除快照，并断开与虚机的连接</li> 
   </ol>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">特点：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">利用快照功能，保存虚机在某个时间点上的状态和快照，很短时间之后虚机就可以照常运行。备份结束，快照会被删除，这样虚机的性能也就不受到影响了。</li> 
    <li style="list-style-type:disc;">利用 VADP API，只读取两次备份之间磁盘上发生了变化的数据块。当然了，第一次是必须做全备份。</li> 
    <li style="list-style-type:disc;">只将变化的数据块写入后端存储，也就是说后端存储必须负责维护第一次全备份和以后每次delta备份之间的关系。其实相当于将 VMware 的 Snapshot manger 功能挪到了备份软件的后端存储。</li> 
   </ul>
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">3.2 恢复流程</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/697113/201607/697113-20160714222719279-924295756.jpg" alt="" width="833" height="398" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">简要过程：</p> 
   <ol style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;">备份程序使用 vSphere API 建立和待恢复虚机的连接，并恢复虚机的配置信息</li> 
    <li style="list-style-type:decimal;">使用 vSphere API 创建快照，往往会创建 Quiseced 类型的快照，来保证应用或者文件系统一致性</li> 
    <li style="list-style-type:decimal;">使用 VDDK API 建立和快照的第一个磁盘的连接</li> 
    <li style="list-style-type:decimal;">&nbsp;对该磁盘，调用&nbsp;QueryChangedDiskAreas 接口，获取它与上次备份时磁盘之间发生了变化的数据块列表</li> 
    <li style="list-style-type:decimal;">调用 VDDK API，从所存备份中读取变化块的数据，再写入快照磁盘的相应位置。该磁盘的所有变化块写入完成后，关闭与磁盘的连接。</li> 
    <li style="list-style-type:decimal;">依次处理其它磁盘</li> 
    <li style="list-style-type:decimal;">将虚机revert到已恢复快照</li> 
    <li style="list-style-type:decimal;">删除快照，并断开与虚机的连接</li> 
   </ol>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">特点：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">在操作前，需要确保虚机处于关机状态</li> 
    <li style="list-style-type:disc;">同样也利用快照，然后再利用 API 获取本次快照和上次备份所对应快照之间发生变化了的数据块，再使用已保存的备份中的数据将发生了变化的快照磁盘中相应的数据块覆盖掉</li> 
    <li style="list-style-type:disc;">快照的磁盘 vmdk 文件都被恢复后，执行快照恢复</li> 
    <li style="list-style-type:disc;">结束后，删除快照</li> 
    <li style="list-style-type:disc;">虽然备份时上传的是 delta 数据块，但是在做恢复时，需要读取全部的数据块。</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">参考资料：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;"><a href="https://www.ibm.com/developerworks/community/blogs/pcclm/entry/how_do_virtual_machine_snapshots_work_in_vmware1?lang=en" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">How do Virtual Machine Snapshots work in VMware</a></li> 
    <li style="list-style-type:disc;"><a href="http://cormachogan.com/2015/03/10/virtual-volumes-a-new-way-of-doing-snapshots/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;"><span style="line-height:1.5;">Virtual Volumes – A new way of doing snapshots</span></a></li> 
    <li style="list-style-type:disc;"><a href="https://www.veritas.com/support/en_US/article.TECH183072" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">VMware Transport Modes: Best practices and troubleshooting</a></li> 
    <li style="list-style-type:disc;"><a href="https://pubs.vmware.com/vsphere-51/index.jsp?topic=%2Fcom.vmware.vddk.pg.doc%2FvddkDataStruct.5.5.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">Virtual Disk Transport Methods</a></li> 
    <li style="list-style-type:disc;"><a href="https://technet.microsoft.com/en-us/library/cc785914(WS.10).aspx" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">How Volume Shadow Copy Service Works</a></li> 
   </ul>
   <div>
    <font color="#4b4b4b"><span style="font-size:15px;"><br></span></font>
   </div> 
   <div>
    <font color="#4b4b4b"><span style="font-size:15px;"><br></span></font>
   </div> 
   <div> 
    <font color="#4b4b4b"><span style="font-size:15px;">&nbsp; &nbsp; 本文转自SammyLiu博客园博客，原文链接：http://www.cnblogs.com/sammyliu/p/5661085.html</span></font>
    <span style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">，如需转载请自行联系原作者</span> 
   </div> 
   <div>
    <font color="#4b4b4b"><span style="font-size:15px;"><br></span></font>
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
