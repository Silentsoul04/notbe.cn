<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>使用Memory Analyzer tool(MAT)分析内存泄漏（二） « NotBeCN</title>
  <meta name="description" content="             转载自：http://www.blogjava.net/rosen/archive/2010/06/13/323522.html    前言的前言 写blog就是好，在大前提下可以想说什么写什么，不像投稿那么字字斟酌。上周末回了趟成都办事，所以本文来迟了。K117从达州经由达成线往成都方...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/22/weixin_33720956_90129957.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">使用Memory Analyzer tool(MAT)分析内存泄漏（二）</h1>
    <p class="post-meta">Nov 22, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="color:rgb(73,73,73);font-family:Arial, Helvetica, sans-serif;font-size:14px;line-height:22.4px;">转载自：http://www.blogjava.net/rosen/archive/2010/06/13/323522.html</p> 
   <p style="color:rgb(73,73,73);font-family:Arial, Helvetica, sans-serif;font-size:14px;line-height:22.4px;"><strong><span style="font-size:12pt;"><span style="font-size:14pt;">前言的前言</span></span></strong><br><br> 写blog就是好，在大前提下可以想说什么写什么，不像投稿那么字字斟酌。上周末回了趟成都办事，所以本文来迟了。K117从达州经由达成线往成都方向走 的时候，发现铁路边有条河，尽管我现在也不知道其名字，但已被其深深的陶醉。河很宽且水流平缓，河边山丘森林密布，民房星星点点的分布在河边，河里偶尔些 小船。当时我就在想，在这里生活是多么的惬意，夏天还可以下去畅游一番，闲来无事也可垂钓。唉，越来越讨厌北漂了。<br><br><strong><span style="font-size:14pt;">前言</span></strong><br><br> 在<a href="http://www.blogjava.net/rosen/archive/2010/05/21/321575.html" rel="nofollow" style="color:rgb(73,73,73);line-height:normal;">使用Memory Analyzer tool(MAT)分析内存泄漏（一）</a>中，我介绍了内存泄漏的前因后果。在本文中，将介绍MAT如何根据heap dump分析泄漏根源。由于测试范例可能过于简单，很容易找出问题，但我期待借此举一反三。<br> 一开始不得不说说ClassLoader，本质上，它的工作就是把磁盘上的类文件读入内存，然后调用 java.lang.ClassLoader.defineClass方法告诉系统把内存镜像处理成合法的字节码。Java提供了抽象类 ClassLoader，所有用户自定义类装载器都实例化自ClassLoader的子类。system class loader在没有指定装载器的情况下默认装载用户类，在Sun Java 1.5中既sun.misc.Launcher$AppClassLoader。更详细的内容请参看下面的资料。<br><br><br><strong><span style="font-size:14pt;">准</span><span style="font-size:14pt;">备heap dump</span></strong><br><br> 请看下面的Pilot类，没啥特殊的。<br></p> 
   <div style="color:rgb(73,73,73);font-family:Arial, Helvetica, sans-serif;font-size:13px;border:1px solid rgb(204,204,204);width:676.188px;line-height:1.6;"> 
    <span style="color:rgb(0,128,0);">/**</span>
    <span style="color:rgb(0,128,0);"><br> &nbsp;*&nbsp;Pilot&nbsp;class<br> &nbsp;*&nbsp;</span>
    <span style="color:rgb(128,128,128);">@author</span>
    <span style="color:rgb(0,128,0);">&nbsp;rosen&nbsp;jiang<br> &nbsp;</span>
    <span style="color:rgb(0,128,0);">*/</span>
    <span style="color:rgb(0,0,0);"><br></span>
    <span style="color:rgb(0,0,255);">package</span>
    <span style="color:rgb(0,0,0);">&nbsp;org.rosenjiang.bo;<br><br></span>
    <span style="color:rgb(0,0,255);">public</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">class</span>
    <span style="color:rgb(0,0,0);">&nbsp;Pilot{<br> &nbsp;&nbsp;&nbsp;&nbsp;<br> &nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;name;<br> &nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">int</span>
    <span style="color:rgb(0,0,0);">&nbsp;age;<br> &nbsp;&nbsp;&nbsp;&nbsp;<br> &nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">public</span>
    <span style="color:rgb(0,0,0);">&nbsp;Pilot(String&nbsp;a,&nbsp;</span>
    <span style="color:rgb(0,0,255);">int</span>
    <span style="color:rgb(0,0,0);">&nbsp;b){<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>
    <span style="color:rgb(0,0,0);">&nbsp;a;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;age&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>
    <span style="color:rgb(0,0,0);">&nbsp;b;<br> &nbsp;&nbsp;&nbsp;&nbsp;}<br> }</span> 
   </div> 
   <p style="color:rgb(73,73,73);font-family:Arial, Helvetica, sans-serif;font-size:14px;line-height:22.4px;"><br> 然后再看OOMHeapTest类，它是如何撑破heap dump的。<br></p> 
   <div style="color:rgb(73,73,73);font-family:Arial, Helvetica, sans-serif;font-size:13px;border:1px solid rgb(204,204,204);width:676.188px;line-height:1.6;"> 
    <span style="color:rgb(0,128,0);">/**</span>
    <span style="color:rgb(0,128,0);"><br> &nbsp;*&nbsp;OOMHeapTest&nbsp;class<br> &nbsp;*&nbsp;</span>
    <span style="color:rgb(128,128,128);">@author</span>
    <span style="color:rgb(0,128,0);">&nbsp;rosen&nbsp;jiang<br> &nbsp;</span>
    <span style="color:rgb(0,128,0);">*/</span>
    <span style="color:rgb(0,0,0);"><br></span>
    <span style="color:rgb(0,0,255);">package</span>
    <span style="color:rgb(0,0,0);">&nbsp;org.rosenjiang.test;<br><br></span>
    <span style="color:rgb(0,0,255);">import</span>
    <span style="color:rgb(0,0,0);">&nbsp;java.util.Date;<br></span>
    <span style="color:rgb(0,0,255);">import</span>
    <span style="color:rgb(0,0,0);">&nbsp;java.util.HashMap;<br></span>
    <span style="color:rgb(0,0,255);">import</span>
    <span style="color:rgb(0,0,0);">&nbsp;java.util.Map;<br></span>
    <span style="color:rgb(0,0,255);">import</span>
    <span style="color:rgb(0,0,0);">&nbsp;org.rosenjiang.bo.Pilot;<br><br></span>
    <span style="color:rgb(0,0,255);">public</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">class</span>
    <span style="color:rgb(0,0,0);">&nbsp;OOMHeapTest&nbsp;{<br> &nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">public</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">static</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">void</span>
    <span style="color:rgb(0,0,0);">&nbsp;main(String[]&nbsp;args){<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oom();<br> &nbsp;&nbsp;&nbsp;&nbsp;}<br> &nbsp;&nbsp;&nbsp;&nbsp;<br> &nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">private</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">static</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">void</span>
    <span style="color:rgb(0,0,0);">&nbsp;oom(){<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map</span>
    <span style="color:rgb(0,0,0);">&lt;</span>
    <span style="color:rgb(0,0,0);">String,&nbsp;Pilot</span>
    <span style="color:rgb(0,0,0);">&gt;</span>
    <span style="color:rgb(0,0,0);">&nbsp;map&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">new</span>
    <span style="color:rgb(0,0,0);">&nbsp;HashMap</span>
    <span style="color:rgb(0,0,0);">&lt;</span>
    <span style="color:rgb(0,0,0);">String,&nbsp;Pilot</span>
    <span style="color:rgb(0,0,0);">&gt;</span>
    <span style="color:rgb(0,0,0);">();<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object[]&nbsp;array&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">new</span>
    <span style="color:rgb(0,0,0);">&nbsp;Object[</span>
    <span style="color:rgb(0,0,0);">1000000</span>
    <span style="color:rgb(0,0,0);">];<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">for</span>
    <span style="color:rgb(0,0,0);">(</span>
    <span style="color:rgb(0,0,255);">int</span>
    <span style="color:rgb(0,0,0);">&nbsp;i</span>
    <span style="color:rgb(0,0,0);">=</span>
    <span style="color:rgb(0,0,0);">0</span>
    <span style="color:rgb(0,0,0);">;&nbsp;i</span>
    <span style="color:rgb(0,0,0);">&lt;</span>
    <span style="color:rgb(0,0,0);">1000000</span>
    <span style="color:rgb(0,0,0);">;&nbsp;i</span>
    <span style="color:rgb(0,0,0);">++</span>
    <span style="color:rgb(0,0,0);">){<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;d&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">new</span>
    <span style="color:rgb(0,0,0);">&nbsp;Date().toString();<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Pilot&nbsp;p&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">new</span>
    <span style="color:rgb(0,0,0);">&nbsp;Pilot(d,&nbsp;i);<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;map.put(i</span>
    <span style="color:rgb(0,0,0);">+</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">rosen&nbsp;jiang</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">,&nbsp;p);<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;array[i]</span>
    <span style="color:rgb(0,0,0);">=</span>
    <span style="color:rgb(0,0,0);">p;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br> &nbsp;&nbsp;&nbsp;&nbsp;}<br> }</span> 
   </div> 
   <p style="color:rgb(73,73,73);font-family:Arial, Helvetica, sans-serif;font-size:14px;line-height:22.4px;"><br> 是的，上面构造了很多的Pilot类实例，向数组和map中放。由于是Strong Ref，GC自然不会回收这些对象，一直放在heap中直到溢出。当然在运行前，先要在Eclipse中配置VM参数 -XX:+HeapDumpOnOutOfMemoryError。好了，一会儿功夫内存溢出，控制台打出如下信息。<br></p> 
   <div style="color:rgb(73,73,73);font-family:Arial, Helvetica, sans-serif;font-size:13px;border:1px solid rgb(204,204,204);width:676.188px;line-height:1.6;"> 
    <span style="color:rgb(0,0,0);">java.lang.OutOfMemoryError:&nbsp;Java&nbsp;heap&nbsp;space<br> Dumping&nbsp;heap&nbsp;to&nbsp;java_pid3600.hprof&nbsp;<img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"><br> Heap&nbsp;dump&nbsp;file&nbsp;created&nbsp;</span>
    <span style="color:rgb(128,0,0);font-weight:bold;">[</span>
    <span style="color:rgb(128,0,0);">78233961&nbsp;bytes&nbsp;in&nbsp;1.995&nbsp;secs</span>
    <span style="color:rgb(128,0,0);font-weight:bold;">]</span>
    <span style="color:rgb(0,0,0);"><br> Exception&nbsp;in&nbsp;thread&nbsp;</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">main</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">&nbsp;java.lang.OutOfMemoryError:&nbsp;Java&nbsp;heap&nbsp;space<br><img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"><img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"><img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"><img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"><img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"><br><img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"><img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"><img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"><br><img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"><img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"></span> 
   </div> 
   <p style="color:rgb(73,73,73);font-family:Arial, Helvetica, sans-serif;font-size:14px;line-height:22.4px;"><br> java_pid3600.hprof既是heap dump，可以在OOMHeapTest类所在的工程根目录下找到。<br><br><strong><span style="font-size:14pt;">MAT安装</span></strong><br><br> 话分两头说，有了heap dump还得安装MAT。可以在http://www.eclipse.org/mat/downloads.php选择合适的方式安装。安装完成后切换 到Memory Analyzer视图。在Eclipse的左上角有Open Heap Dump按钮，按照刚才说的路径找到java_pid3600.hprof文件并打开。解析hprof文件会花些时间，然后会弹出向导，直接Finish 即可。稍后会看到下图所示的界面。<br><br><img src="http://www.blogjava.net/images/blogjava_net/rosen/20105251.png" alt="" width="851" height="875" style="border:0px;"><br><br> MAT工具分析了heap dump后在界面上非常直观的展示了一个饼图，该图深色区域被怀疑有内存泄漏，可以发现整个heap才64M内存，深色区域就占了99.5%。接下来是一 个简短的描述，告诉我们main线程占用了大量内存，并且明确指出system class loader加载的"java.lang.Thread"实例有内存聚集，并建议用关键字"java.lang.Thread"进行检查。所以，MAT通 过简单的两句话就说明了问题所在，就算使用者没什么处理内存问题的经验。在下面还有一个"Details"链接，在点开之前不妨考虑一个问题：为何对象实 例会聚集在内存中，为何存活（而未被GC）？是的——Strong Ref，那么再走近一些吧。<br><br><img src="http://www.blogjava.net/images/blogjava_net/rosen/20105252.png" alt="" width="813" height="519" style="border:0px;"><br><br> 点击了"Details"链接之后，除了在上一页看到的描述外，还有Shortest Paths To the Accumulation Point和Accumulated Objects部分，这里说明了从GC root到聚集点的最短路径，以及完整的reference chain。观察Accumulated Objects部分，java.util.HashMap和java.lang.Object[1000000]实例的retained heap(size)最大，在上一篇文章中我们知道retained heap代表从该类实例沿着reference chain往下所能收集到的其他类实例的shallow heap(size)总和，所以明显类实例都聚集在HashMap和Object数组中了。这里我们发现一个有趣的现象，既Object数组的 shallow heap和retained heap竟然一样，通过<a href="http://www.yourkit.com/docs/90/help/sizes.jsp" rel="nofollow" style="color:rgb(73,73,73);line-height:normal;">Shallow and retained sizes</a>一 文可知，数组的shallow heap和一般对象（非数组）不同，依赖于数组的长度和里面的元素的类型，对数组求shallow heap，也就是求数组集合内所有对象的shallow heap之和。好，再来看org.rosenjiang.bo.Pilot对象实例的shallow heap为何是16，因为对象头是8字节，成员变量int是4字节、String引用是4字节，故总共16字节。<br><br><img src="http://www.blogjava.net/images/blogjava_net/rosen/20105253.png" alt="" width="678" height="351" style="border:0px;"><br><br> 接着往下看，来到了Accumulated Objects by Class区域，顾名思义，这里能找到被聚集的对象实例的类名。org.rosenjiang.bo.Pilot类上头条了，被实例化了290,325 次，再返回去看程序，我承认是故意这么干的。还有很多有用的报告可用来协助分析问题，只是本文中的例子太简单，也用不上。以后如有用到，一定撰文详细叙 述。<br><br><strong><span style="font-size:14pt;">又是</span><span style="font-size:14pt;">perm gen</span></strong><br><br> 我们在上一篇文章中知道，perm gen是个异类，里面存储了类和方法数据（与class loader有关）以及interned strings（字符串驻留）。在heap dump中没有包含太多的perm gen信息。那么我们就用这些少量的信息来解决问题吧。<br><br> 看下面的代码，利用interned strings把perm gen撑破了。<br></p> 
   <div style="color:rgb(73,73,73);font-family:Arial, Helvetica, sans-serif;font-size:13px;border:1px solid rgb(204,204,204);width:676.188px;line-height:1.6;"> 
    <span style="color:rgb(0,128,0);">/**</span>
    <span style="color:rgb(0,128,0);"><br> &nbsp;*&nbsp;OOMPermTest&nbsp;class<br> &nbsp;*&nbsp;</span>
    <span style="color:rgb(128,128,128);">@author</span>
    <span style="color:rgb(0,128,0);">&nbsp;rosen&nbsp;jiang<br> &nbsp;</span>
    <span style="color:rgb(0,128,0);">*/</span>
    <span style="color:rgb(0,0,0);"><br></span>
    <span style="color:rgb(0,0,255);">package</span>
    <span style="color:rgb(0,0,0);">&nbsp;org.rosenjiang.test;<br><br></span>
    <span style="color:rgb(0,0,255);">public</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">class</span>
    <span style="color:rgb(0,0,0);">&nbsp;OOMPermTest&nbsp;{<br> &nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">public</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">static</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">void</span>
    <span style="color:rgb(0,0,0);">&nbsp;main(String[]&nbsp;args){<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oom();<br> &nbsp;&nbsp;&nbsp;&nbsp;}<br> &nbsp;&nbsp;&nbsp;&nbsp;<br> &nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">private</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">static</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">void</span>
    <span style="color:rgb(0,0,0);">&nbsp;oom(){<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object[]&nbsp;array&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">new</span>
    <span style="color:rgb(0,0,0);">&nbsp;Object[</span>
    <span style="color:rgb(0,0,0);">10000000</span>
    <span style="color:rgb(0,0,0);">];<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">for</span>
    <span style="color:rgb(0,0,0);">(</span>
    <span style="color:rgb(0,0,255);">int</span>
    <span style="color:rgb(0,0,0);">&nbsp;i</span>
    <span style="color:rgb(0,0,0);">=</span>
    <span style="color:rgb(0,0,0);">0</span>
    <span style="color:rgb(0,0,0);">;&nbsp;i</span>
    <span style="color:rgb(0,0,0);">&lt;</span>
    <span style="color:rgb(0,0,0);">10000000</span>
    <span style="color:rgb(0,0,0);">;&nbsp;i</span>
    <span style="color:rgb(0,0,0);">++</span>
    <span style="color:rgb(0,0,0);">){<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;d&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>
    <span style="color:rgb(0,0,0);">&nbsp;String.valueOf(i).intern();<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;array[i]</span>
    <span style="color:rgb(0,0,0);">=</span>
    <span style="color:rgb(0,0,0);">d;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br> &nbsp;&nbsp;&nbsp;&nbsp;}<br> }</span> 
   </div> 
   <p style="color:rgb(73,73,73);font-family:Arial, Helvetica, sans-serif;font-size:14px;line-height:22.4px;"><br> 控制台打印如下的信息，然后把java_pid1824.hprof文件导入到MAT。其实在MAT里，看到的状况应该和 “OutOfMemoryError: Java heap space”差不多（用了数组），因为heap dump并没有包含interned strings方面的任何信息。只是在这里需要强调，使用intern()方法的时候应该多加注意。<br></p> 
   <div style="color:rgb(73,73,73);font-family:Arial, Helvetica, sans-serif;font-size:13px;border:1px solid rgb(204,204,204);width:676.188px;line-height:1.6;"> 
    <span style="color:rgb(0,0,0);">java.lang.OutOfMemoryError:&nbsp;PermGen&nbsp;space<br> Dumping&nbsp;heap&nbsp;to&nbsp;java_pid1824.hprof&nbsp;<img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"><br> Heap&nbsp;dump&nbsp;file&nbsp;created&nbsp;</span>
    <span style="color:rgb(128,0,0);font-weight:bold;">[</span>
    <span style="color:rgb(128,0,0);">121273334&nbsp;bytes&nbsp;in&nbsp;2.845&nbsp;secs</span>
    <span style="color:rgb(128,0,0);font-weight:bold;">]</span>
    <span style="color:rgb(0,0,0);"><br> Exception&nbsp;in&nbsp;thread&nbsp;</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">main</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">&nbsp;java.lang.OutOfMemoryError:&nbsp;PermGen&nbsp;space<br><img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"><img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"><img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"><img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"><img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"><br><img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"><img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"><img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"><br><img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"><img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"></span> 
   </div> 
   <p style="color:rgb(73,73,73);font-family:Arial, Helvetica, sans-serif;font-size:14px;line-height:22.4px;"><br> 倒是在思考如何把class loader撑破废了些心思。经过尝试，发现使用ASM来动态生成类才能达到目的。ASM(http://asm.objectweb.org)的主要作 用是处理已编译类(compiled class)，能对已编译类进行生成、转换、分析（功能之一是实现动态代理），而且它运行起来足够的快和小巧，文档也全面，实属居家必备之良品。ASM提 供了core API和tree API，前者是基于事件的方式，后者是基于对象的方式，类似于XML的SAX、DOM解析，但是使用tree API性能会有损失。既然下面要用到ASM，这里不得不啰嗦下已编译类的结构，包括：<br> &nbsp;&nbsp;&nbsp; 1、修饰符（例如public、private）、类名、父类名、接口和annotation部分。<br> &nbsp;&nbsp;&nbsp; 2、类成员变量声明，包括每个成员的修饰符、名字、类型和annotation。<br> &nbsp;&nbsp;&nbsp; 3、方法和构造函数描述，包括修饰符、名字、返回和传入参数类型，以及annotation。当然还包括这些方法或构造函数的具体Java字节码。<br> &nbsp;&nbsp;&nbsp; 4、常量池(constant pool)部分，constant pool是一个包含类中出现的数字、字符串、类型常量的数组。<br><br><img src="http://www.blogjava.net/images/blogjava_net/rosen/20105257.jpg" alt="" width="459" height="298" style="border:0px;"><br><br> 已编译类和原来的类源码区别在于，已编译类只包含类本身，内部类不会在已编译类中出现，而是生成另外一个已编译类文件；其二，已编译类中没有注释；其三，已编译类没有package和import部分。<br> 这里还得说说已编译类对Java类型的描述，对于原始类型由单个大写字母表示，Z代表boolean、C代表char、B代表byte、S代表 short、I代表int、F代表float、J代表long、D代表double；而对类类型的描述使用内部名(internal name)外加前缀L和后面的分号共同表示来表示，所谓内部名就是带全包路径的表示法，例如String的内部名是java/lang/String；对 于数组类型，使用单方括号加上数据元素类型的方式描述。最后对于方法的描述，用圆括号来表示，如果返回是void用V表示，具体参考下图。<br><br><img src="http://www.blogjava.net/images/blogjava_net/rosen/20105259.jpg" alt="" width="303" height="263" style="border:0px;"><img src="http://www.blogjava.net/images/blogjava_net/rosen/20105258.jpg" alt="" width="482" height="112" style="border:0px;"><br><br> 下面的代码中会使用ASM core API，注意接口ClassVisitor是核心，FieldVisitor、MethodVisitor都是辅助接口。ClassVisitor应该按 照这样的方式来调用：visit visitSource? visitOuterClass? ( visitAnnotation | visitAttribute )*( visitInnerClass | visitField | visitMethod )* visitEnd。就是说visit方法必须首先调用，再调用最多一次的visitSource，再调用最多一次的visitOuterClass方法， 接下来再多次调用visitAnnotation和visitAttribute方法，最后是多次调用visitInnerClass、 visitField和visitMethod方法。调用完后再调用visitEnd方法作为结尾。<br><br> 注意ClassWriter类，该类实现了ClassVisitor接口，通过toByteArray方法可以把已编译类直接构建成二进制形式。由于我们要动态生成子类，所以这里只对ClassWriter感兴趣。首先是抽象类原型：<br></p> 
   <div style="color:rgb(73,73,73);font-family:Arial, Helvetica, sans-serif;font-size:13px;border:1px solid rgb(204,204,204);width:676.188px;line-height:1.6;"> 
    <span style="color:rgb(0,128,0);">/**</span>
    <span style="color:rgb(0,128,0);"><br> &nbsp;*&nbsp;</span>
    <span style="color:rgb(128,128,128);">@author</span>
    <span style="color:rgb(0,128,0);">&nbsp;rosen&nbsp;jiang<br> &nbsp;*&nbsp;MyAbsClass&nbsp;class<br> &nbsp;</span>
    <span style="color:rgb(0,128,0);">*/</span>
    <span style="color:rgb(0,0,0);"><br></span>
    <span style="color:rgb(0,0,255);">package</span>
    <span style="color:rgb(0,0,0);">&nbsp;org.rosenjiang.test;<br><br></span>
    <span style="color:rgb(0,0,255);">public</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">abstract</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">class</span>
    <span style="color:rgb(0,0,0);">&nbsp;MyAbsClass&nbsp;{<br> &nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">int</span>
    <span style="color:rgb(0,0,0);">&nbsp;LESS&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,0);">-</span>
    <span style="color:rgb(0,0,0);">1</span>
    <span style="color:rgb(0,0,0);">;<br> &nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">int</span>
    <span style="color:rgb(0,0,0);">&nbsp;EQUAL&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,0);">0</span>
    <span style="color:rgb(0,0,0);">;<br> &nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">int</span>
    <span style="color:rgb(0,0,0);">&nbsp;GREATER&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,0);">1</span>
    <span style="color:rgb(0,0,0);">;<br> &nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">abstract</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">int</span>
    <span style="color:rgb(0,0,0);">&nbsp;absTo(Object&nbsp;o);<br> }</span> 
   </div> 
   <p style="color:rgb(73,73,73);font-family:Arial, Helvetica, sans-serif;font-size:14px;line-height:22.4px;"><br> 其次是自定义类加载器，实在没法，ClassLoader的defineClass方法都是protected的，要加载字节数组形式（因为toByteArray了）的类只有继承一下自己再实现。<br></p> 
   <div style="color:rgb(73,73,73);font-family:Arial, Helvetica, sans-serif;font-size:13px;border:1px solid rgb(204,204,204);width:676.188px;line-height:1.6;"> 
    <span style="color:rgb(0,128,0);">/**</span>
    <span style="color:rgb(0,128,0);"><br> &nbsp;*&nbsp;</span>
    <span style="color:rgb(128,128,128);">@author</span>
    <span style="color:rgb(0,128,0);">&nbsp;rosen&nbsp;jiang<br> &nbsp;*&nbsp;MyClassLoader&nbsp;class<br> &nbsp;</span>
    <span style="color:rgb(0,128,0);">*/</span>
    <span style="color:rgb(0,0,0);"><br></span>
    <span style="color:rgb(0,0,255);">package</span>
    <span style="color:rgb(0,0,0);">&nbsp;org.rosenjiang.test;<br><br></span>
    <span style="color:rgb(0,0,255);">public</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">class</span>
    <span style="color:rgb(0,0,0);">&nbsp;MyClassLoader&nbsp;</span>
    <span style="color:rgb(0,0,255);">extends</span>
    <span style="color:rgb(0,0,0);">&nbsp;ClassLoader&nbsp;{<br> &nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">public</span>
    <span style="color:rgb(0,0,0);">&nbsp;Class&nbsp;defineClass(String&nbsp;name,&nbsp;</span>
    <span style="color:rgb(0,0,255);">byte</span>
    <span style="color:rgb(0,0,0);">[]&nbsp;b)&nbsp;{<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">return</span>
    <span style="color:rgb(0,0,0);">&nbsp;defineClass(name,&nbsp;b,&nbsp;</span>
    <span style="color:rgb(0,0,0);">0</span>
    <span style="color:rgb(0,0,0);">,&nbsp;b.length);<br> &nbsp;&nbsp;&nbsp;&nbsp;}<br> }</span> 
   </div> 
   <p style="color:rgb(73,73,73);font-family:Arial, Helvetica, sans-serif;font-size:14px;line-height:22.4px;"><br> 最后是测试类。<br></p> 
   <div style="color:rgb(73,73,73);font-family:Arial, Helvetica, sans-serif;font-size:13px;border:1px solid rgb(204,204,204);width:676.188px;line-height:1.6;"> 
    <span style="color:rgb(0,128,0);">/**</span>
    <span style="color:rgb(0,128,0);"><br> &nbsp;*&nbsp;</span>
    <span style="color:rgb(128,128,128);">@author</span>
    <span style="color:rgb(0,128,0);">&nbsp;rosen&nbsp;jiang<br> &nbsp;*&nbsp;OOMPermTest&nbsp;class<br> &nbsp;</span>
    <span style="color:rgb(0,128,0);">*/</span>
    <span style="color:rgb(0,0,0);"><br></span>
    <span style="color:rgb(0,0,255);">package</span>
    <span style="color:rgb(0,0,0);">&nbsp;org.rosenjiang.test;<br><br></span>
    <span style="color:rgb(0,0,255);">import</span>
    <span style="color:rgb(0,0,0);">&nbsp;java.util.ArrayList;<br></span>
    <span style="color:rgb(0,0,255);">import</span>
    <span style="color:rgb(0,0,0);">&nbsp;java.util.List;<br></span>
    <span style="color:rgb(0,0,255);">import</span>
    <span style="color:rgb(0,0,0);">&nbsp;org.objectweb.asm.ClassWriter;<br></span>
    <span style="color:rgb(0,0,255);">import</span>
    <span style="color:rgb(0,0,0);">&nbsp;org.objectweb.asm.Opcodes;<br><br></span>
    <span style="color:rgb(0,0,255);">public</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">class</span>
    <span style="color:rgb(0,0,0);">&nbsp;OOMPermTest&nbsp;{<br> &nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">public</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">static</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">void</span>
    <span style="color:rgb(0,0,0);">&nbsp;main(String[]&nbsp;args)&nbsp;</span>
    <span style="color:rgb(0,0,0);">{<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OOMPermTest&nbsp;o&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">new</span>
    <span style="color:rgb(0,0,0);">&nbsp;OOMPermTest();<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o.oom();<br> &nbsp;&nbsp;&nbsp;&nbsp;}<br><br> &nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">private</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">void</span>
    <span style="color:rgb(0,0,0);">&nbsp;oom()&nbsp;</span>
    <span style="color:rgb(0,0,0);">{<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">try</span>
    <span style="color:rgb(0,0,0);">&nbsp;{<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClassWriter&nbsp;cw&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">new</span>
    <span style="color:rgb(0,0,0);">&nbsp;ClassWriter(</span>
    <span style="color:rgb(0,0,0);">0</span>
    <span style="color:rgb(0,0,0);">);<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cw.visit(Opcodes.V1_5,&nbsp;Opcodes.ACC_PUBLIC&nbsp;</span>
    <span style="color:rgb(0,0,0);">+</span>
    <span style="color:rgb(0,0,0);">&nbsp;Opcodes.ACC_ABSTRACT,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">org/rosenjiang/test/MyAbsClass</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">,&nbsp;</span>
    <span style="color:rgb(0,0,255);">null</span>
    <span style="color:rgb(0,0,0);">,&nbsp;</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">java/lang/Object</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">new</span>
    <span style="color:rgb(0,0,0);">&nbsp;String[]&nbsp;{});<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cw.visitField(Opcodes.ACC_PUBLIC&nbsp;</span>
    <span style="color:rgb(0,0,0);">+</span>
    <span style="color:rgb(0,0,0);">&nbsp;Opcodes.ACC_FINAL&nbsp;</span>
    <span style="color:rgb(0,0,0);">+</span>
    <span style="color:rgb(0,0,0);">&nbsp;Opcodes.ACC_STATIC,&nbsp;</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">LESS</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">,&nbsp;</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">I</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">null</span>
    <span style="color:rgb(0,0,0);">,&nbsp;</span>
    <span style="color:rgb(0,0,255);">new</span>
    <span style="color:rgb(0,0,0);">&nbsp;Integer(</span>
    <span style="color:rgb(0,0,0);">-</span>
    <span style="color:rgb(0,0,0);">1</span>
    <span style="color:rgb(0,0,0);">)).visitEnd();<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cw.visitField(Opcodes.ACC_PUBLIC&nbsp;</span>
    <span style="color:rgb(0,0,0);">+</span>
    <span style="color:rgb(0,0,0);">&nbsp;Opcodes.ACC_FINAL&nbsp;</span>
    <span style="color:rgb(0,0,0);">+</span>
    <span style="color:rgb(0,0,0);">&nbsp;Opcodes.ACC_STATIC,&nbsp;</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">EQUAL</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">,&nbsp;</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">I</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">null</span>
    <span style="color:rgb(0,0,0);">,&nbsp;</span>
    <span style="color:rgb(0,0,255);">new</span>
    <span style="color:rgb(0,0,0);">&nbsp;Integer(</span>
    <span style="color:rgb(0,0,0);">0</span>
    <span style="color:rgb(0,0,0);">)).visitEnd();<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cw.visitField(Opcodes.ACC_PUBLIC&nbsp;</span>
    <span style="color:rgb(0,0,0);">+</span>
    <span style="color:rgb(0,0,0);">&nbsp;Opcodes.ACC_FINAL&nbsp;</span>
    <span style="color:rgb(0,0,0);">+</span>
    <span style="color:rgb(0,0,0);">&nbsp;Opcodes.ACC_STATIC,&nbsp;</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">GREATER</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">,&nbsp;</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">I</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">null</span>
    <span style="color:rgb(0,0,0);">,&nbsp;</span>
    <span style="color:rgb(0,0,255);">new</span>
    <span style="color:rgb(0,0,0);">&nbsp;Integer(</span>
    <span style="color:rgb(0,0,0);">1</span>
    <span style="color:rgb(0,0,0);">)).visitEnd();<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cw.visitMethod(Opcodes.ACC_PUBLIC&nbsp;</span>
    <span style="color:rgb(0,0,0);">+</span>
    <span style="color:rgb(0,0,0);">&nbsp;Opcodes.ACC_ABSTRACT,&nbsp;</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">absTo</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">(Ljava/lang/Object;)I</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">,&nbsp;</span>
    <span style="color:rgb(0,0,255);">null</span>
    <span style="color:rgb(0,0,0);">,&nbsp;</span>
    <span style="color:rgb(0,0,255);">null</span>
    <span style="color:rgb(0,0,0);">).visitEnd();<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cw.visitEnd();<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">byte</span>
    <span style="color:rgb(0,0,0);">[]&nbsp;b&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>
    <span style="color:rgb(0,0,0);">&nbsp;cw.toByteArray();<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List</span>
    <span style="color:rgb(0,0,0);">&lt;</span>
    <span style="color:rgb(0,0,0);">ClassLoader</span>
    <span style="color:rgb(0,0,0);">&gt;</span>
    <span style="color:rgb(0,0,0);">&nbsp;classLoaders&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">new</span>
    <span style="color:rgb(0,0,0);">&nbsp;ArrayList</span>
    <span style="color:rgb(0,0,0);">&lt;</span>
    <span style="color:rgb(0,0,0);">ClassLoader</span>
    <span style="color:rgb(0,0,0);">&gt;</span>
    <span style="color:rgb(0,0,0);">();<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span style="color:rgb(0,0,255);">while</span>
    <span style="color:rgb(0,0,0);">&nbsp;(</span>
    <span style="color:rgb(0,0,255);">true</span>
    <span style="color:rgb(0,0,0);">)&nbsp;{<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyClassLoader&nbsp;classLoader&nbsp;</span>
    <span style="color:rgb(0,0,0);">=</span>
    <span style="color:rgb(0,0,0);">&nbsp;</span>
    <span style="color:rgb(0,0,255);">new</span>
    <span style="color:rgb(0,0,0);">&nbsp;MyClassLoader();<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;classLoader.defineClass(</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">org.rosenjiang.test.MyAbsClass</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">,&nbsp;b);<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;classLoaders.add(classLoader);<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span>
    <span style="color:rgb(0,0,255);">catch</span>
    <span style="color:rgb(0,0,0);">&nbsp;(Exception&nbsp;e)&nbsp;{<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.printStackTrace();<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br> &nbsp;&nbsp;&nbsp;&nbsp;}<br> }</span> 
   </div> 
   <p style="color:rgb(73,73,73);font-family:Arial, Helvetica, sans-serif;font-size:14px;line-height:22.4px;"><br> 不一会儿，控制台就报错了。<br></p> 
   <div style="color:rgb(73,73,73);font-family:Arial, Helvetica, sans-serif;font-size:13px;border:1px solid rgb(204,204,204);width:676.188px;line-height:1.6;"> 
    <span style="color:rgb(0,0,0);">java.lang.OutOfMemoryError:&nbsp;PermGen&nbsp;space<br> Dumping&nbsp;heap&nbsp;to&nbsp;java_pid3023.hprof&nbsp;<img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"><br> Heap&nbsp;dump&nbsp;file&nbsp;created&nbsp;</span>
    <span style="color:rgb(128,0,0);font-weight:bold;">[</span>
    <span style="color:rgb(128,0,0);">92593641&nbsp;bytes&nbsp;in&nbsp;2.405&nbsp;secs</span>
    <span style="color:rgb(128,0,0);font-weight:bold;">]</span>
    <span style="color:rgb(0,0,0);"><br> Exception&nbsp;in&nbsp;thread&nbsp;</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">main</span>
    <span style="color:rgb(0,0,0);">"</span>
    <span style="color:rgb(0,0,0);">&nbsp;java.lang.OutOfMemoryError:&nbsp;PermGen&nbsp;space<br><img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"><img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"><br><img src="http://www.blogjava.net/Images/dot.gif" alt="" style="border:0px;"></span> 
   </div> 
   <p style="color:rgb(73,73,73);font-family:Arial, Helvetica, sans-serif;font-size:14px;line-height:22.4px;"><br> 打开java_pid3023.hprof文件，注意看下图的Classes: 88.1k和Class Loader: 87.7k部分，从这点可看出class loader加载了大量的类。<br><br><img src="http://www.blogjava.net/images/blogjava_net/rosen/20105254.png" alt="" width="631" height="134" style="border:0px;"><br><br> 更进一步分析，点击上图中红框线圈起来的按钮，选择Java Basics——Class Loader Explorer功能。打开后能看到下图所示的界面，第一列是class loader名字；第二列是class loader已定义类(defined classes)的个数，这里要说一下已定义类和已加载类(loaded classes)了，当需要加载类的时候，相应的class loader会首先把请求委派给父class loader，只有当父class loader加载失败后，该class loader才会自己定义并加载类，这就是Java自己的“双亲委派加载链”结构；第三列是class loader所加载的类的实例数目。<br><br><img src="http://www.blogjava.net/images/blogjava_net/rosen/20105255.png" alt="" width="637" height="567" style="border:0px;"><br><br> 在Class Loader Explorer这里，能发现class loader是否加载了过多的类。另外，还有Duplicate Classes功能，也能协助分析重复加载的类，在此就不再截图了，可以肯定的是MyAbsClass被重复加载了N多次。<br><br><strong><span style="font-size:14pt;">最后</span></strong><br><br> 其实MAT工具非常的强大，上面故弄玄虚的范例代码根本用不上MAT的其他分析功能，所以就不再描述了。其实对于OOM不只我列举的两种溢出错误，还有多 种其他错误，但我想说的是，对于perm gen，如果实在找不出问题所在，建议使用JVM的-verbose参数，该参数会在后台打印出日志，可以用来查看哪个class loader加载了什么类，例：“[Loaded org.rosenjiang.test.MyAbsClass from org.rosenjiang.test.MyClassLoader]”。<br> 全文完。<br><br><br><strong><span style="font-size:14pt;">参考资料</span></strong><br><br><a href="http://dev.eclipse.org/blogs/memoryanalyzer/" rel="nofollow" style="color:rgb(73,73,73);line-height:normal;">memoryanalyzer Blog</a><br><a href="http://kenwublog.com/structure-of-java-class-loader" rel="nofollow" style="color:rgb(73,73,73);line-height:normal;">java类加载器体系结构</a><br><a href="http://mindprod.com/jgloss/classloader.html" rel="nofollow" style="color:rgb(73,73,73);line-height:normal;">ClassLoader</a></p> 
   <p style="color:rgb(73,73,73);font-family:Arial, Helvetica, sans-serif;font-size:14px;line-height:22.4px;">本文转自demoblog博客园博客，原文链接http://www.cnblogs.com/0616--ataozhijia/p/3696161.html如需转载请自行联系原作者</p> 
   <p style="color:rgb(73,73,73);font-family:Arial, Helvetica, sans-serif;font-size:14px;line-height:22.4px;"><br></p> 
   <p><font color="#494949"><span style="font-size:14px;line-height:22.4px;">demoblog</span></font><br></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
