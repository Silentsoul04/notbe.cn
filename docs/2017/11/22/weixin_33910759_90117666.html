<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>C#进阶系列——MEF实现设计上的“松耦合”（终结篇：面向接口编程） « NotBeCN</title>
  <meta name="description" content="             序：忙碌多事的八月带着些许的倦意早已步入尾声，金秋九月承载着抗战胜利70周年的喜庆扑面而来。没来得及任何准备，似乎也不需要任何准备，因为生活不需要太多将来时。每天忙着上班、加班、白加班，忘了去愤，忘了去算计所谓的价值。天津爆炸事故时刻警示着我们生命的无常，逝者安息，活着的人生活还得继续，...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/22/weixin_33910759_90117666.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">C#进阶系列——MEF实现设计上的“松耦合”（终结篇：面向接口编程）</h1>
    <p class="post-meta">Nov 22, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">序：忙碌多事的八月带着些许的倦意早已步入尾声，金秋九月承载着抗战胜利70周年的喜庆扑面而来。没来得及任何准备，似乎也不需要任何准备，因为生活不需要太多将来时。每天忙着上班、加班、白加班，忘了去愤，忘了去算计所谓的价值。天津爆炸事故时刻警示着我们生命的无常，逝者安息，活着的人生活还得继续，珍惜生命，远离伤害。武汉，这座炙热的城市，虽值金秋，却依然经受着“秋老虎”的烘烤，马路上蒸腾的热气迎面袭来，全身毛孔张开，汗流不止，在这般高温下，似乎汗水都要被榨干，其实，被榨干的何止是汗水！！！吁！吁！吁！说好的MEF呢？说好的面向接口编程呢？都快奔三张的人了，还学着小年轻玩无病呻吟，有点装嫩的味道。没办法，思想脱缰了，有点野性难驯的意思了。好啦，不扯啦，进入今天的正题吧。</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">　　前面两篇分别介绍了下MEF的简单用法和MEF与仓储模式的结合使用，这章来个终结吧。毛爷爷教导我们，做事要有始有终。本篇，博主打算通过分享一个面向接口编程的框架来说明使用MEF的灵活性。</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">1、面向接口编程：有一定编程经验的博友应该都熟悉或者了解这种编程思想，层和层之间通过接口依赖，下层不是直接给上层提供服务，而是定义一组接口供上层调用。至于具体的业务实现，那是开发中需要做的事情，在项目架构阶段，只需要定义好层与层之间的接口依赖，将框架搭起来，编译可以直接通过。为什么要有这么一种设计？既然是架构设计，当然是为了提高架构的灵活性，降低层和层之间的依赖（耦合）。这个并非一句两句讲得清楚的，更多详细可以参看：<a id="cb_post_title_url" href="http://www.cnblogs.com/leoo2sk/archive/2008/04/10/1146447.html" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">面向接口编程详解（一）——思想基础</a>。此文我觉得分析比较到位。好了，不说废话，来看代码。</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">&nbsp;</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">2、博主本着“不讲清楚誓不罢休”的原则，自己从零开始搭了一个简单的框架Demo，当然，可能对于大牛们来说是没太大价值的，但请不要笑话博主不断探索的勇气。先来看看框架大概的结构吧。</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><img src="https://images2015.cnblogs.com/blog/459756/201509/459756-20150902092753591-507930269.png" alt="" style="border:0px;"></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">首先说明下各层次的意思：</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span style="color:rgb(186,13,241);">一、ESTM.Client</span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span style="color:rgb(186,13,241);">　　ESTM.Client.Winform：Winform项目，用户UI展现，这个没什么好说的。</span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span style="color:rgb(186,13,241);">　　ESTM.Client.IBLL：客户端IBLL接口层，用于定义客户端的业务接口，记住这里仅仅是向UI层提供接口功能。</span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span style="color:rgb(186,13,241);">　　ESTM.Client.BLL：客户端BLL实现层，用于客户端IBLL接口层的实现，提供UI层真是业务逻辑。</span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span style="color:rgb(186,13,241);">二、ESTM.Common</span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span style="color:rgb(186,13,241);">　　ESTM.Common.Model：通用DTOModel层，注意，这里不是EF的实体Model，而是另外定义的一个数据转换的Model层。</span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span style="color:rgb(186,13,241);">三、ESTM.Service</span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span style="color:rgb(186,13,241);">　　ESTM.Service.WCF：WCF宿主项目，用于提供WCF的接口契约和实现。这里用WCF的目的是为了隔离客户端和服务端的代码。</span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span style="color:rgb(186,13,241);">　　ESTM.Service.IBLL：服务端IBLL接口层，用于定义WCF层的业务接口，和ESTM.Client.IBLL层的功能类似。</span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span style="color:rgb(186,13,241);">　　ESTM.Service.BLL：服务端BLL实现层，实现服务端IBLL接口层。</span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span style="color:rgb(186,13,241);">　　ESTM.Service.DAL：服务端DAL数据访问层，里面使用EF建立数据库连接。</span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">&nbsp;</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">再来看看各层次之间的调用关系：</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><img src="https://images2015.cnblogs.com/blog/459756/201509/459756-20150902094934216-738298678.png" alt="" style="border:0px;"></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">最后说说这样设计的好处：</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span style="color:rgb(140,23,232);">（1）整个框架采用面向接口编程模式，每个层次不是直接向其上层提供服务（即不是直接实例化在上层中），而是通过定义一组接口，仅向上层暴露其接口功能，上层对下层仅仅是接口依赖，而不依赖具体实现。如是说，客户端IBLL接口层仅仅提供一套接口供UI层调用，对于UI层来说，它根本感觉不到客户端BLL实现层的存在，极端点说，即使不写BLL实现层，项目也可以编译通过，因为接口的功能已经定义好了。至于具体的实现，那就是业务的问题了。当我们需要更改业务逻辑时，只需要更改BLL实现层的代码就好了，对于IBLL接口层和上层UI不用做任何的改变，更进一步说，甚至将客户端BLL实现层全部重写或者整个替换掉，IBLL和UI层都可以不做任何改变。这也正是面向接口编程最大的优势。</span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span style="color:rgb(140,23,232);">（2）上张图里面也提到了DTOModel层，为什么要有DTOModel这么一个对象，而不是直接将EF的实体Model传到前端来呢？个人觉得原因有两点：一是上文提到的安全性问题，客户端永远只能操作DTOmodel，当客户端提交数据到后台来时，永远都是先将DTOmodel转换位EF的model，然后去操作数据库，试想，如果UI表现层能直接操作EF的model，是否会造成操作数据库的入口的不唯一的问题；二是，比如数据库里面有A和B两张表，我们前端需要展示A表的A.1、A.2两字段，还需要展示B表的B.3、B.4字段，当我们使用DTOmodel的时候，只需要构造好一个DTO_Model，里面有4个字段，前端可以直接拿来用就好了，如果不用DTO，要么直接传object，要么将A、B两张表的模型传过来在前端构造，无论哪种方式应该都没有使用DTO方便吧。</span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">&nbsp;<span><span><span style="color:rgb(10,10,10);">当然这些都是博主自己的理解，如果博友们觉得有问题</span></span></span><span style="color:rgb(10,10,10);">可以指出~~</span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">&nbsp;</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span style="color:rgb(10,10,10);">好了，说了这么多框架，下面进入今天的正题。看看MEF是如何在项目中飞的吧~~</span><span style="color:rgb(10,10,10);">先来看看各层的代码：</span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span style="color:rgb(10,10,10);">（1）ESTM.Service.DAL里面通过EF建立数据库的连接 ：博主为了测试随便拖了一张用户表进来。</span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span style="color:rgb(10,10,10);"><img src="https://images2015.cnblogs.com/blog/459756/201509/459756-20150902101709466-791742968.png" alt="" style="border:0px;"></span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><strong><span style="color:rgb(171,18,236);">Base.cs里面通过MEF导入EF的上下文对象：</span></strong></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">class</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> Base
    {
        [Import]
        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> DbContext EntityFramework { <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">set</span>; <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">get</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">; }

        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> Base()
        {
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">因为这里有Import，所以需要装配MEF</span>
            regisgter().ComposeParts(<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">this</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">);
        }

        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> CompositionContainer regisgter()
        {
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> catalog = <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> AssemblyCatalog(Assembly.GetExecutingAssembly());
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> container = <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> CompositionContainer(catalog);
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">return</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> container;
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">&nbsp;</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">对应在Export在edmx文件下面的MyModel.Context.cs里面</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>　　[Export(<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">typeof</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">(DbContext))]
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">partial</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">class</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> Entities : DbContext
    {
        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> Entities()
            : </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">base</span>(<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">name=Entities</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">)
        {
        }
    
        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">protected</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">override</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> OnModelCreating(DbModelBuilder modelBuilder)
        {
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">throw</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> UnintentionalCodeFirstException();
        }
    
        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> DbSet&lt;TB_USERS&gt; TB_USERS { <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">get</span>; <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">set</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">; }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">&nbsp;</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">（2）ESTM.Service.IBLL服务端IBLL接口层定义服务端接口：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;">
    <pre><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">　　public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">interface</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> IServiceUser
    {
        List</span>&lt;DTO_USERS&gt;<span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> GetAllUser();

        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> AddUser(DTO_USERS oUser);
    }</span></pre>
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">&nbsp;</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">（3）ESTM.Service.BLL服务端BLL实现层定义接口实现：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>　　[Export(<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">Users</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span>,<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">typeof</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">(IServiceUser))]
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">class</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> ServiceUser : IServiceUser
    {
        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">需要注意：1.添加服务引用在Client.Bll里面，所以，WCF连接的配置要拷贝到Winform项目下面的App.Config里面
        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">2.DAL里面的连接字符串也要拷贝到WCF里面，原因同上</span>
        <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> List&lt;DTO_USERS&gt;<span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> GetAllUser()
        {
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> lstRes = <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span> List&lt;DTO_USERS&gt;<span style="font-family:'Courier New';font-size:12px;line-height:1.5;">();
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> oService = <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> DAL.ServiceUser();
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> lstEFModel =<span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> oService.GetAllUsers();

            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">一般用AutoMapper将EF的Model转换成DTO的Model.z这里为了测试，我们暂且手动转换。使用反射转换</span>
            <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> lstEFModelProp = <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">typeof</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">(TB_USERS).GetProperties();
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> lstDTOModelProp = <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">typeof</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">(DTO_USERS).GetProperties();
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">foreach</span> (<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> oEFModel <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">in</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> lstEFModel)
            {
                </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> oResUser = <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> DTO_USERS();
                </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">foreach</span> (<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> oProp <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">in</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> lstEFModelProp)
                {
                    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> oDTOMOdelProp = lstDTOModelProp.FirstOrDefault(x =&gt; x.Name ==<span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> oProp.Name);
                    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">if</span> (oDTOMOdelProp == <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">null</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">)
                    {
                        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">continue</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">;
                    }

                    oDTOMOdelProp.SetValue(oResUser, oProp.GetValue(oEFModel));
                }
                lstRes.Add(oResUser);
            }


            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">return</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> lstRes;
        }

        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> AddUser(DTO_USERS oUser)
        {
            
        }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><strong><span style="color:rgb(171,18,236);">注意在BLL实现层里面有EF的Model和DTOmodel之间的转换，因为在DAL里面取到的是EF的实体模型，而需要传到前端的是DTOmodel的模型，项目中一般用AutoMapper等第三方工具转换对象，我这里为了简单自己手动通过反射转了下。</span></strong></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">&nbsp;</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">（4）ESTM.Service.WCF服务端WCF宿主层，定义WCF的接口契约。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">　　　　 static</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span> Main(<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">string</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">[] args)
        {
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> strUri = <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">http://127.0.0.1:1234/MyWCF.Server</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">;

            Uri httpAddress </span>= <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> Uri(strUri);
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">using</span> (ServiceHost host = <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span> ServiceHost(<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">typeof</span>(CSOAService)))<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">需要添加System.SystemModel这个dll。。。。CSOAService这个为实现ICSOAService的实现类，WCF真正的实现方法再这个类里面</span>
<span style="font-family:'Courier New';font-size:12px;line-height:1.5;">            {
                </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,128,128);">///////////////////////////////////////</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">添加服务节点</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,128,128);">///////////////////////////////////////////////////
</span>                host.AddServiceEndpoint(<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">typeof</span>(ICSOAService), <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span> WSHttpBinding(), httpAddress);<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">ICSOAService这个为向外暴露的接口</span>
                <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">if</span> (host.Description.Behaviors.Find&lt;ServiceMetadataBehavior&gt;() == <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">null</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">)
                {
                    ServiceMetadataBehavior behavior </span>= <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> ServiceMetadataBehavior();
                    behavior.HttpGetEnabled </span>= <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">true</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">;
                    behavior.HttpGetUrl </span>=<span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> httpAddress;
                    host.Description.Behaviors.Add(behavior);
                }
                host.Opened </span>+= <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">delegate</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">
                {
                    Console.ForegroundColor </span>=<span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> ConsoleColor.Green;
                    Console.WriteLine(</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">MyWCF.Server服务已经启动成功。</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span> +<span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> strUri);
                };

                host.Open();
                </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">while</span> (<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">true</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">)
                {
                    Console.ReadLine();
                }
            }

            
        }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;">
    <pre><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">　　[ServiceContract]
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">interface</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> ICSOAService
    {
        [OperationContract]
        List</span>&lt;DTO_USERS&gt;<span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> GetAllUsers();
    }</span></pre>
   </div> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">　　public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">class</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> CSOAService:ICSOAService
    {
        [Import(</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">Users</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">)]
        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> IServiceUser Service { <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">set</span>; <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">get</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">; }

        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> CSOAService()
        {
            regisgterAll().ComposeParts(</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">this</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">);
        }

        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> List&lt;DTO_USERS&gt;<span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> GetAllUsers()
        {
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">return</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> Service.GetAllUser();
        }

        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> CompositionContainer regisgterAll()
        {
            AggregateCatalog aggregateCatalog </span>= <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> AggregateCatalog();
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> thisAssembly = <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span> DirectoryCatalog(AppDomain.CurrentDomain.BaseDirectory, <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">*.dll</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">);
            aggregateCatalog.Catalogs.Add(thisAssembly);
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> _container = <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> CompositionContainer(aggregateCatalog);

            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">return</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> _container;
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><strong><span style="color:rgb(171,18,236);">代码没什么复杂的逻辑，就是先注册MEF实例化变量，然后取值。</span><span style="color:rgb(171,18,236);">[Import("Users")]这里有导入，根据我们前两篇的讲解，那么肯定是存在一个[Export("Users")]这样的导出，于是乎，我们可以根据</span><span style="color:rgb(171,18,236);">IServiceUser 接口往下找，最后可以找到在ESTM.Service.BLL这个里面有一个如下的导出：</span></strong></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;">
    <pre>    [Export(<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">Users</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span>,<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">typeof</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">(IServiceUser))]
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">class</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> ServiceUser : IServiceUser
    {
       </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">........  </span>
    }</pre>
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">&nbsp;</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">（5）ESTM.Client.IBLL客户端IBLL接口层</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;">
    <pre>    <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">interface</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> IManagerUser
    {
        List</span>&lt;DTO_USERS&gt;<span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> GetAllUser();
    }</span></pre>
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">&nbsp;</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">（6）ESTM.Client.BLL客户端BLL实现层</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>　　[Export(<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">Users</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span>,<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">typeof</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">(IManagerUser))]
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">class</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> ManagerUser : IManagerUser
    {

        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> List&lt;Common.Model.DTO_USERS&gt;<span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> GetAllUser()
        {<br>
//WCF服务对象
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> oWCFService = <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> ServiceReference_MyWCF.CSOAServiceClient();
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">return</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> oWCFService.GetAllUsers().ToList();
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><strong><span style="color:rgb(171,18,236);">在这个层里面是通过WCF服务去调用数据的，所以需要添加WCF的服务引用。</span></strong></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">&nbsp;</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">（7）ESTM.Client.Winform客户端UI层：定义一个DataGridView展示列表：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">partial</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">class</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> Form1 : Form
    {

        [Import(</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">Users</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">)]
        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> IManagerUser Manager { <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">set</span>; <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">get</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">; }
       
        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> Form1()
        {
            InitializeComponent();
            regisgterAll().ComposeParts(</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">this</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">);

            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">this</span>.dataGridView1.DataSource =<span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> Manager.GetAllUser();
        }

        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> CompositionContainer regisgterAll()
        {
            AggregateCatalog aggregateCatalog </span>= <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> AggregateCatalog();
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> thisAssembly = <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span> DirectoryCatalog(AppDomain.CurrentDomain.BaseDirectory, <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">*.dll</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">);
            aggregateCatalog.Catalogs.Add(thisAssembly);
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> _container = <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> CompositionContainer(aggregateCatalog);

            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">return</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> _container;
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">得到结果：</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><img src="https://images2015.cnblogs.com/blog/459756/201509/459756-20150902103219497-1904027504.png" alt="" style="border:0px;"></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">&nbsp;</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">前面MEF的第一篇中已经说过使用MEF的优势之一就是降低层与层之间的耦合，我们现在来结合框架说说它是如何作业的。首先我们来看看ESTM.Client.Winform这个项目的引用：</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><img src="https://images2015.cnblogs.com/blog/459756/201509/459756-20150902110250200-1822113158.png" alt="" style="border:0px;"></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">它是没有添加ESTM.Client.BLL这一层的引用的，可是我们在Form1.cs里面有如下代码：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">　　public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">partial</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">class</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> Form1 : Form
    {

        [Import(</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">Users</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">)]
        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> IManagerUser Manager { <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">set</span>; <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">get</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">; }
       
        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> Form1()
        {
            InitializeComponent();
            regisgterAll().ComposeParts(</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">this</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">);

            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">this</span>.dataGridView1.DataSource =<span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> Manager.GetAllUser();
        }

        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> CompositionContainer regisgterAll()
        {
            AggregateCatalog aggregateCatalog </span>= <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> AggregateCatalog();
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> thisAssembly = <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span> DirectoryCatalog(AppDomain.CurrentDomain.BaseDirectory, <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">*.dll</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">);
            aggregateCatalog.Catalogs.Add(thisAssembly);
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> _container = <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> CompositionContainer(aggregateCatalog);

            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">return</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> _container;
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span>程序运行起来，走完注册MEF以后可以看到Manager的变量值就是ESTM.Client.BLL里面的ManagerUser对象。这就是MEF的功劳，当调用regisgterAll()这个方法的时候，MEF会根据导入导出自动去寻找匹配，并且自动实例化。如果是没有MEF，我们UI层就必须要添加ESTM.Client.BLL的引用了。</span><span style="color:rgb(177,14,240);"><strong>当然有一点需要注意的地方，虽然UI层不用添加ESTM.Client.BLL的引用，但是由于在UI里面使用了ManagerUser这个对象，所以UI层bin目录下面必须要有ESTM.Client.BLL.dll这个文件以及ESTM.Client.BLL项目所必须的dll，你可以手动拷贝这些dll到UI的bin目录下面。甚至为了简单，你也可以在UI层上面添加ESTM.Client.BLL这个的引用，但是博主觉得，这样貌似违背了面向接口编程的原则，不爽，奈何没想到更好的解决方案。</strong></span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span style="color:rgb(255,0,0);font-size:18px;"><strong>对于上面UI层必须要添加BLL实现层这一问题找到解决方案了，在此记录下：</strong></span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span style="color:rgb(255,0,0);font-size:18px;"><strong>ESTM.Client.BLL项目右键→属性</strong></span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span style="color:rgb(255,0,0);font-size:18px;"><strong><img src="https://images2015.cnblogs.com/blog/459756/201509/459756-20150916141826992-50564562.png" alt="" style="border:0px;"></strong></span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">&nbsp;</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span style="color:rgb(255,0,0);font-size:18px;"><strong>输出路径改成UI层的bin目录下面即可。2015年9月16日加。</strong></span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">&nbsp;</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">&nbsp;</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span style="color:rgb(177,14,240);"><strong>在搭建这个小框架过程中，博主遇到几个问题在此和博友分享下：</strong></span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span style="color:rgb(177,14,240);"><strong>1.添加服务引用在Client.Bll里面，由于Client.BLL是一个内库，最终它会生成一个dll，所以，WCF连接的配置要拷贝到Winform项目下面的App.Config里面。</strong></span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span style="color:rgb(177,14,240);"><strong>2.DAL里面的连接字符串也要拷贝到WCF的App.Config里面，原因同上。</strong></span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span style="color:rgb(177,14,240);"><strong>3.注册MEF的方法</strong></span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">　　　　public</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> CompositionContainer regisgterAll()
        {
            AggregateCatalog aggregateCatalog </span>= <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> AggregateCatalog();
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> thisAssembly = <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span> DirectoryCatalog(AppDomain.CurrentDomain.BaseDirectory, <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">*.dll</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">);
            aggregateCatalog.Catalogs.Add(thisAssembly);
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> _container = <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> CompositionContainer(aggregateCatalog);

            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">return</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> _container;
        }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><strong><span style="color:rgb(177,14,240);">可以抽到一个公共的地方，不用每个地方都写。注意由于MEF的导入导出涉及到多个内库，所以这里要遍历bin目录下面所有的dll去寻找匹配。</span></strong></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><strong><span style="color:rgb(177,14,240);">4.DAL层可以还做一下封装，博主的项目是用的仓储模式封装EF，然后在Service.BLL里面调用仓储的服务去访问数据库。</span></strong></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><strong><span style="color:rgb(177,14,240);"><br></span></strong></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><strong><span style="color:rgb(177,14,240);"><br></span></strong></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><strong><span style="color:rgb(177,14,240);"><br></span></strong></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><strong><span style="color:rgb(177,14,240);"><br></span></strong></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><strong><span style="color:rgb(177,14,240);"><br></span></strong></p> 
   <p><strong><span><font color="#b10ef0"><span style="line-height:24px;">本文转自懒得安分博客园博客，原文链接：http://www.cnblogs.com/landeanfen/p/4770609.html，如需转载请自行联系原作者</span></font><br></span></strong></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
