<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>input上报流程分析【转】 « NotBeCN</title>
  <meta name="description" content="             转自：http://blog.chinaunix.net/uid-28320320-id-3389196.html                       1、参考文章       【Andorid】input系统的事件处理2、源码分析 linux 3.6.3    1)查看linu...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/22/weixin_34186128_90134702.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">input上报流程分析【转】</h1>
    <p class="post-meta">Nov 22, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="color:rgb(102,102,102);font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif, '宋体';font-size:14px;">转自：<a href="http://blog.chinaunix.net/uid-28320320-id-3389196.html" rel="nofollow" style="color:rgb(51,51,51);font-weight:inherit;line-height:inherit;">http://blog.chinaunix.net/uid-28320320-id-3389196.html</a></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(51,51,51);font-weight:inherit;line-height:inherit;text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1</span><span style="font-family:'Courier New';line-height:1.5;">、参考文章
       【Andorid】input系统的事件处理

</span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">2</span>、源码分析 linux <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">3.6</span>.<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">3</span>
    <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1</span>)查看linux-<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">3.6</span>.<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">3</span>/drivers/<span style="font-family:'Courier New';line-height:1.5;">input下Makefile

点击(此处)折叠或打开

    obj</span>-$(CONFIG_INPUT) += input-<span style="font-family:'Courier New';line-height:1.5;">core.o
        input</span>-core-y := input.o input-compat.o input-mt.o ff-<span style="font-family:'Courier New';line-height:1.5;">core.o


    </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">2</span><span style="font-family:'Courier New';line-height:1.5;">)查看文件input.c

点击(此处)折叠或打开

    </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> input subsystem entry </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span><span style="font-family:'Courier New';line-height:1.5;">
    subsys_initcall(input_init);
    module_exit(input_exit);


    </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">3</span><span style="font-family:'Courier New';line-height:1.5;">)input.c搞啥子

点击(此处)折叠或打开

    </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> sysfs/procfs/devfs show </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span>
        |-----------|
        |          \/
        | err = class_register(&amp;<span style="font-family:'Courier New';line-height:1.5;">input_class);
        </span>|
        |-----------|
        |          \/
        | err =<span style="font-family:'Courier New';line-height:1.5;"> input_proc_init();
        </span>|
        |-----------|
        |          \/
        | err = register_chrdev(INPUT_MAJOR, <span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">input</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span>, &amp;<span style="font-family:'Courier New';line-height:1.5;">input_fops);


根据下面的方法，发现手机的tp 对应event1

点击(此处)折叠或打开

        # getevent 
        add device </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1</span>: /dev/input/<span style="font-family:'Courier New';line-height:1.5;">event0
          name: </span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">fluid-keypad</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">
        add device </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">2</span>: /dev/input/<span style="font-family:'Courier New';line-height:1.5;">event3
          name: </span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">7k_handset</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">
        add device </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">3</span>: /dev/input/<span style="font-family:'Courier New';line-height:1.5;">event2
          name: </span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">sensors</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">
        add device </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4</span>: /dev/input/<span style="font-family:'Courier New';line-height:1.5;">event1
          name: </span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">Synaptics RMI4</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">
          
        # pwd
        </span>/sys/<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">class</span>/<span style="font-family:'Courier New';line-height:1.5;">input
        # ls
        event0 event1 event2 event3 input0 input1 input2 input3
          
        # cat </span>/proc/bus/input/<span style="font-family:'Courier New';line-height:1.5;">devices
        I: Bus</span>=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0019</span> Vendor=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0001</span> Product=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0001</span> Version=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0001</span><span style="font-family:'Courier New';line-height:1.5;">
        N: Name</span>=<span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">fluid-keypad</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">
        P: Phys</span>=fluid-keypad/<span style="font-family:'Courier New';line-height:1.5;">input0
        S: Sysfs</span>=/devices/i2c-<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">6</span>/<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">6</span>-<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0000</span>/pm8058-keypad/input/<span style="font-family:'Courier New';line-height:1.5;">input0
        U: Uniq</span>=<span style="font-family:'Courier New';line-height:1.5;">
        H: Handlers</span>=<span style="font-family:'Courier New';line-height:1.5;">kbd event0
        B: EV</span>=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">13</span><span style="font-family:'Courier New';line-height:1.5;">
        B: KEY</span>=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1200000</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span> c0000 <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">
        B: MSC</span>=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">10</span><span style="font-family:'Courier New';line-height:1.5;">
          
        I: Bus</span>=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0000</span> Vendor=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0000</span> Product=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0000</span> Version=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0000</span><span style="font-family:'Courier New';line-height:1.5;">
        N: Name</span>=<span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">Synaptics RMI4</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">
        P: Phys</span>=<span style="font-family:'Courier New';line-height:1.5;">Synaptics_rmi
        S: Sysfs</span>=/devices/<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">virtual</span>/input/<span style="font-family:'Courier New';line-height:1.5;">input1
        U: Uniq</span>=<span style="font-family:'Courier New';line-height:1.5;">
        H: Handlers</span>=<span style="font-family:'Courier New';line-height:1.5;">event1
        B: EV</span>=<span style="font-family:'Courier New';line-height:1.5;">b
        B: KEY</span>=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">400</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">2000000</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">40000800</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">40</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">
        B: ABS</span>=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">770000</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">11030003</span><span style="font-family:'Courier New';line-height:1.5;">
          
        I: Bus</span>=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0018</span> Vendor=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0003</span> Product=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0000</span> Version=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0000</span><span style="font-family:'Courier New';line-height:1.5;">
        N: Name</span>=<span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">sensors</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">
        P: Phys</span>=<span style="font-family:'Courier New';line-height:1.5;">
        S: Sysfs</span>=/devices/<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">virtual</span>/input/<span style="font-family:'Courier New';line-height:1.5;">input2
        U: Uniq</span>=<span style="font-family:'Courier New';line-height:1.5;">
        H: Handlers</span>=<span style="font-family:'Courier New';line-height:1.5;">event2
        B: EV</span>=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">9</span><span style="font-family:'Courier New';line-height:1.5;">
        B: ABS</span>=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">8000</span><span style="font-family:'Courier New';line-height:1.5;"> 20304bf
          
        I: Bus</span>=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0000</span> Vendor=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0001</span> Product=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0001</span> Version=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0001</span><span style="font-family:'Courier New';line-height:1.5;">
        N: Name</span>=<span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">7k_handset</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">
        P: Phys</span>=<span style="font-family:'Courier New';line-height:1.5;">
        S: Sysfs</span>=/devices/<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">virtual</span>/input/<span style="font-family:'Courier New';line-height:1.5;">input3
        U: Uniq</span>=<span style="font-family:'Courier New';line-height:1.5;">
        H: Handlers</span>=<span style="font-family:'Courier New';line-height:1.5;">kbd event3
        B: EV</span>=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">23</span><span style="font-family:'Courier New';line-height:1.5;">
        B: KEY</span>=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">28</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span> 1c0800 <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">
        B: SW</span>=<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4</span>


    <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4</span><span style="font-family:'Courier New';line-height:1.5;">)touch panel驱动源码

点击(此处)折叠或打开

    #include </span>&lt;linux/module.h&gt;<span style="font-family:'Courier New';line-height:1.5;">
    #include </span>&lt;linux/kernel.h&gt;<span style="font-family:'Courier New';line-height:1.5;">
    #include </span>&lt;linux/slab.h&gt;<span style="font-family:'Courier New';line-height:1.5;">
    #include </span>&lt;linux/platform_device.h&gt;<span style="font-family:'Courier New';line-height:1.5;">
    #include </span>&lt;linux/i2c.h&gt;<span style="font-family:'Courier New';line-height:1.5;">
    #include </span>&lt;linux/input.h&gt;<span style="font-family:'Courier New';line-height:1.5;">
      
    #include </span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">gsl1680.h</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span>
      
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> gsl_pr(fmt, arg...) \<span style="font-family:'Courier New';line-height:1.5;">
        printk(KERN_ERR </span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">[GSL]%s: \033[32m</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span> fmt <span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">\033[0m\n</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">, __FUNCTION__, ##arg)
      
    </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> GSL_ADAPTER_INDEX 0
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> GSL1680D0_ID 0
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> GSL_DEV_NAME "gsl"
      
    <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*
     * Description : global var
     </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span>
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> gsl_ts_data *ddata =<span style="font-family:'Courier New';line-height:1.5;"> NULL;
    </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">const</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> i2c_device_id gsl_id[] =<span style="font-family:'Courier New';line-height:1.5;"> {
        {GSL_DEV_NAME, GSL1680D0_ID},
        {},
    };
    MODULE_DEVICE_TABLE(silead, gsl_id);
      
    </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> i2c_board_info gsl_i2c_info =<span style="font-family:'Courier New';line-height:1.5;"> {
        .type </span>=<span style="font-family:'Courier New';line-height:1.5;"> GSL_DEV_NAME,
        .addr </span>= <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0x40</span><span style="font-family:'Courier New';line-height:1.5;">,
    };
      
    </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*
     * Description : gsl soc operation
     </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span>
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span> gsl_hw_init(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">void</span><span style="font-family:'Courier New';line-height:1.5;">)
    {
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">;
    }
      
    </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span> gsl_sw_init(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">void</span><span style="font-family:'Courier New';line-height:1.5;">)
    {
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">;
    }
      
    </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*
     * Description : touch panel driver
     </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span>
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">void</span> gsl_report_work(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> work_struct *<span style="font-family:'Courier New';line-height:1.5;">work)
    {
    }
      
    </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span> gsl_request_input(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">void</span><span style="font-family:'Courier New';line-height:1.5;">)
    {
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span> ret = <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">;
      
        ddata</span>-&gt;idev =<span style="font-family:'Courier New';line-height:1.5;"> input_allocate_device();
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (!ddata-&gt;<span style="font-family:'Courier New';line-height:1.5;">idev) {
            dev_err(</span>&amp;ddata-&gt;idev-&gt;dev, <span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">could not allocate device\n</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">);
            </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span> -<span style="font-family:'Courier New';line-height:1.5;">ENODEV;
        }
      
        ddata</span>-&gt;idev-&gt;name =<span style="font-family:'Courier New';line-height:1.5;"> GSL_DEV_NAME;
        ddata</span>-&gt;idev-&gt;id.bustype =<span style="font-family:'Courier New';line-height:1.5;"> BUS_I2C;
        ddata</span>-&gt;idev-&gt;dev.parent = &amp;ddata-&gt;client-&gt;<span style="font-family:'Courier New';line-height:1.5;">dev;
        input_set_drvdata(ddata</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">idev, ddata);
      
        __set_bit(EV_ABS, ddata</span>-&gt;idev-&gt;<span style="font-family:'Courier New';line-height:1.5;">evbit);
      
        input_set_abs_params(ddata</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">idev, ABS_MT_POSITION_X,
            DIS_MIN_X, DIS_MAX_X, </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span>, <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">);
        input_set_abs_params(ddata</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">idev, ABS_MT_POSITION_Y,
            DIS_MIN_Y, DIS_MAX_Y, </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span>, <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">);
        input_set_abs_params(ddata</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">idev, ABS_MT_TOUCH_MAJOR,
            MIN_TOUCH, MAX_TOUCH, </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span>, <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">);
        input_set_abs_params(ddata</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">idev, ABS_MT_WIDTH_MAJOR,
            MIN_WIDTH, MAX_WIDTH, </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span>, <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">);
        input_set_abs_params(ddata</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">idev, ABS_MT_TRACKING_ID,
            MIN_TRCKID, MAX_TRCKID, </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span>, <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">);
      
        INIT_WORK(</span>&amp;ddata-&gt;<span style="font-family:'Courier New';line-height:1.5;">work, gsl_report_work);
      
        ddata</span>-&gt;wq =<span style="font-family:'Courier New';line-height:1.5;"> create_singlethread_workqueue(GSL_DEV_NAME);
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (!ddata-&gt;<span style="font-family:'Courier New';line-height:1.5;">wq) {
            dev_err(</span>&amp;ddata-&gt;idev-&gt;dev, <span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">could not create workqueue\n</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">);
            ret </span>= -<span style="font-family:'Courier New';line-height:1.5;">ENOMEM;
            </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">goto</span><span style="font-family:'Courier New';line-height:1.5;"> error_wq_create;
        }
    </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#if</span> 0<span style="font-family:'Courier New';line-height:1.5;">
        ddata</span>-&gt;pm.suspend =<span style="font-family:'Courier New';line-height:1.5;"> gsl_suspend;
        ddata</span>-&gt;pm.resume =<span style="font-family:'Courier New';line-height:1.5;"> gsl_resume;
        register_early_suspend(</span>&amp;ddata-&gt;<span style="font-family:'Courier New';line-height:1.5;">pm);
    </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#endif</span><span style="font-family:'Courier New';line-height:1.5;">
        ret </span>= input_register_device(ddata-&gt;<span style="font-family:'Courier New';line-height:1.5;">idev);
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span><span style="font-family:'Courier New';line-height:1.5;"> (ret) {
            dev_err(</span>&amp;ddata-&gt;idev-&gt;dev, <span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">ret = %d : could not register input device\n</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">, ret);
            </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">goto</span><span style="font-family:'Courier New';line-height:1.5;"> error_unreg_device;
        }
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">;
      
    error_unreg_device:
        destroy_workqueue(ddata</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">wq);
    error_wq_create:
        input_free_device(ddata</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">idev);
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span><span style="font-family:'Courier New';line-height:1.5;"> ret;
    }
      
    </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">static</span> __devinit <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span> gsl_probe(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> i2c_client *<span style="font-family:'Courier New';line-height:1.5;">client,
            </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">const</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> i2c_device_id *<span style="font-family:'Courier New';line-height:1.5;">id)
    {
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span> ret = <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">;
      
        gsl_pr();
      
        ddata</span>-&gt;ti = kzalloc(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">sizeof</span><span style="font-family:'Courier New';line-height:1.5;">(union gsl_touch_info), GFP_KERNEL);
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (!ddata-&gt;<span style="font-family:'Courier New';line-height:1.5;">ti) {
            dev_err(</span>&amp;client-&gt;dev, <span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">failed to alloc ddata-&gt;ti memory!\n</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">);
            ret </span>= -<span style="font-family:'Courier New';line-height:1.5;">ENOMEM;
            </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">goto</span><span style="font-family:'Courier New';line-height:1.5;"> error_alloc_mem;
        }
      
        </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> regist a input dev </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span><span style="font-family:'Courier New';line-height:1.5;">
        ret </span>=<span style="font-family:'Courier New';line-height:1.5;"> gsl_request_input();
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span><span style="font-family:'Courier New';line-height:1.5;"> (ret) {
            dev_err(</span>&amp;client-&gt;dev, <span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">failed to regist input dev!\n</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">);
            </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">goto</span><span style="font-family:'Courier New';line-height:1.5;"> error_regist_input;
        }
      
        </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> setup the gpio -- irq &amp; rst </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span><span style="font-family:'Courier New';line-height:1.5;">
        ret </span>=<span style="font-family:'Courier New';line-height:1.5;"> gsl_hw_init();
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span><span style="font-family:'Courier New';line-height:1.5;"> (ret) {
            dev_err(</span>&amp;client-&gt;dev, <span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">failed to init hw!\n</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">);
            </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">goto</span><span style="font-family:'Courier New';line-height:1.5;"> error_init_hw;
        }
      
        </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> setup client data &amp; download fw </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span><span style="font-family:'Courier New';line-height:1.5;">
        ret </span>=<span style="font-family:'Courier New';line-height:1.5;"> gsl_sw_init();
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span><span style="font-family:'Courier New';line-height:1.5;"> (ret) {
            dev_err(</span>&amp;client-&gt;dev, <span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">failed to init sw!\n</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">);
            </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">goto</span><span style="font-family:'Courier New';line-height:1.5;"> error_init_sw;
        }
      
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">;
      
    error_init_sw:
    error_init_hw:
        destroy_workqueue(ddata</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">wq);
        input_free_device(ddata</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">idev);
    error_regist_input:
        kfree(ddata</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">ti);
        input_unregister_device(ddata</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">idev);
        destroy_workqueue(ddata</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">wq);
        input_free_device(ddata</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">idev);
    error_alloc_mem:
        kfree(ddata);
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span><span style="font-family:'Courier New';line-height:1.5;"> ret;
    }
      
    </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">static</span> __devexit <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span> gsl_remove(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> i2c_client *<span style="font-family:'Courier New';line-height:1.5;">client)
    {
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">;
    }
      
    </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> i2c_driver gsl_driver =<span style="font-family:'Courier New';line-height:1.5;"> {
        .driver </span>=<span style="font-family:'Courier New';line-height:1.5;"> {
            .name </span>=<span style="font-family:'Courier New';line-height:1.5;"> GSL_DEV_NAME,
            .owner </span>=<span style="font-family:'Courier New';line-height:1.5;"> THIS_MODULE,
        },
        .probe </span>=<span style="font-family:'Courier New';line-height:1.5;"> gsl_probe,
        .remove </span>=<span style="font-family:'Courier New';line-height:1.5;"> gsl_remove,
        .id_table </span>=<span style="font-family:'Courier New';line-height:1.5;"> gsl_id,
    };
      
    </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*
     * Description : module operation
     </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span>
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">static</span> __init <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span> gsl_init(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">void</span><span style="font-family:'Courier New';line-height:1.5;">)
    {
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span> ret = <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">;
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> i2c_adapter *<span style="font-family:'Courier New';line-height:1.5;">adapter;
      
        gsl_pr();
      
        ddata </span>= kzalloc(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">sizeof</span>(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span><span style="font-family:'Courier New';line-height:1.5;"> gsl_ts_data), GFP_KERNEL);
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (!<span style="font-family:'Courier New';line-height:1.5;">ddata) {
            gsl_pr(</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">alloc mem error</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">);
            </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">goto</span><span style="font-family:'Courier New';line-height:1.5;"> err_mem;
        }
      
        </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> tips : try_module_get </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span><span style="font-family:'Courier New';line-height:1.5;">
        adapter </span>=<span style="font-family:'Courier New';line-height:1.5;"> i2c_get_adapter(GSL_ADAPTER_INDEX);
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (!<span style="font-family:'Courier New';line-height:1.5;">(adapter)) {
            gsl_pr(</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">get %d adapter failed</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">, GSL_ADAPTER_INDEX);
            ret </span>= -<span style="font-family:'Courier New';line-height:1.5;">ENODEV;
            </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">goto</span><span style="font-family:'Courier New';line-height:1.5;"> err_adap;
        }
      
        ddata</span>-&gt;client = i2c_new_device(adapter, &amp;<span style="font-family:'Courier New';line-height:1.5;">gsl_i2c_info);
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (!(ddata-&gt;<span style="font-family:'Courier New';line-height:1.5;">client)) {
            gsl_pr(</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">get i2c device error</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">);
            ret </span>= -<span style="font-family:'Courier New';line-height:1.5;">ENODEV;
            </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">goto</span><span style="font-family:'Courier New';line-height:1.5;"> err_dev;
        }
      
        </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> release the module </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span><span style="font-family:'Courier New';line-height:1.5;">
        i2c_put_adapter(adapter);
      
        ret </span>= i2c_add_driver(&amp;<span style="font-family:'Courier New';line-height:1.5;">gsl_driver);
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span><span style="font-family:'Courier New';line-height:1.5;"> (ret) {
            gsl_pr(</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">i2c add driver failed</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">);
            </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">goto</span><span style="font-family:'Courier New';line-height:1.5;"> err_driver;
        }
      
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">;
      
    err_driver:
        i2c_unregister_device(ddata</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">client);
        i2c_put_adapter(adapter);
    err_dev:
    err_adap:
        kfree(ddata);
    err_mem:
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span><span style="font-family:'Courier New';line-height:1.5;"> ret;
    }
      
    </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">static</span> __exit <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">void</span> gsl_exit(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">void</span><span style="font-family:'Courier New';line-height:1.5;">)
    {
        gsl_pr();
      
        </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> reverse effect of i2c_new_device() </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span><span style="font-family:'Courier New';line-height:1.5;">
        i2c_del_driver(</span>&amp;<span style="font-family:'Courier New';line-height:1.5;">gsl_driver);
        i2c_unregister_device(ddata</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">client);
        kfree(ddata);
      
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span><span style="font-family:'Courier New';line-height:1.5;">;
    }
      
    module_init(gsl_init);
    module_exit(gsl_exit);
      
    MODULE_LICENSE(</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">GPL</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">);
    MODULE_AUTHOR(</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">mark</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">);


点击(此处)折叠或打开

    </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">touch coordinate range</span>
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> TP_WIDTH 480
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> TP_LENTH 800
          
    <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">coordinate direction</span>
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> TP_DIREC 1 <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> if 1 is (1,1), then 2(1,-1), 3(-1,-1), 4(-1,1)</span>
          
    <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">touch threshold</span>
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> MAI_TRSD 200
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> SUB_TRSD 40
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> SUM_TRSD (MAI_TRSD + SUB_TRSD + 20)
          
    <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">touch tigger condition</span>
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> TRIG_MOD 1 <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> 1 is edge, 0 is level</span>
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> VOLT_LEV 0 <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> if trig mode is edge,</span>
                                <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> 0 is IRQF_TRIGGER_RISING, 1 is IRQF_TRIGGER_FALLING
                                </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> if trig mode is level,
                                </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> 0 is IRQF_TRIGGER_HIGH, 1 is IRQF_TRIGGER_LOW
          
    </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">touch sensitivity</span>
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> TP_DACG 0x00100010 <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">9f/30</span>
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> DAC_STEP 0x8e <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">if TP_DACG=0x00180018,TP_DAC_STEP=0x61</span>
                                        <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">if TP_DACG=0x00100010,TP_DAC_STEP=0x8e
                                        </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">if TP_DACG=0x000c000c,TP_DAC_STEP=0xbb
                                        </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">if TP_DACG=0x000a000a,TP_DAC_STEP=0xdf
                                        </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">if TP_DACG=0x00080008,TP_DAC_STEP=0x114
                                        </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">if TP_DACG=0x00060006,TP_DAC_STEP=0x16e</span>
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> CHANGE_CONDITION 0x0 <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">0--use average,1--use max</span>
          
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> GSL_PAGE_REG 0xf0
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> GSL_CLOCK_REG 0xe4
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> GSL_START_REG 0xe0
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> GSL_CLOCK_REG 0xe4
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> POWE_FAIL_REG 0xbc
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> TOUCH_INFO_REG 0x80
          
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> DIS_MIN_X 0
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> DIS_MAX_X TP_WIDTH
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> DIS_MIN_Y 0
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> DIS_MAX_Y TP_LENTH
          
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> MIN_TOUCH 0
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> MAX_TOUCH 1
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> MIN_WIDTH 0
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> MAX_WIDTH 1
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> MIN_TRCKID 1
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#define</span> MAX_TRCKID 5
          
    <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> the data format of one point </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span><span style="font-family:'Courier New';line-height:1.5;">
    union gsl_point_data {
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span><span style="font-family:'Courier New';line-height:1.5;"> {
            u16 y;
            u16 x : </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">12</span><span style="font-family:'Courier New';line-height:1.5;">;
            u16 id : </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4</span><span style="font-family:'Courier New';line-height:1.5;">;
        };
        u8 all[</span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4</span><span style="font-family:'Courier New';line-height:1.5;">];
    };
          
    </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> the 24-byte data of read once </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span><span style="font-family:'Courier New';line-height:1.5;">
    union gsl_touch_info {
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span><span style="font-family:'Courier New';line-height:1.5;"> {
            u32 finger_num : </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">8</span><span style="font-family:'Courier New';line-height:1.5;">;
            u32 : </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">;
            union gsl_point_data point[</span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5</span><span style="font-family:'Courier New';line-height:1.5;">];
        };
        u8 all[</span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">24</span><span style="font-family:'Courier New';line-height:1.5;">];
    };
          
    </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span><span style="font-family:'Courier New';line-height:1.5;"> gsl_ts_data {
        union gsl_touch_info </span>*<span style="font-family:'Courier New';line-height:1.5;">ti;
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> i2c_client *<span style="font-family:'Courier New';line-height:1.5;">client;
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> input_dev *<span style="font-family:'Courier New';line-height:1.5;">idev;
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> workqueue_struct *<span style="font-family:'Courier New';line-height:1.5;">wq;
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span><span style="font-family:'Courier New';line-height:1.5;"> work_struct work;
        unsigned </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span><span style="font-family:'Courier New';line-height:1.5;"> irq;
    };
          
    </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> Fixme mem Alig </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span>
    <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span><span style="font-family:'Courier New';line-height:1.5;"> fw_data {
        u32 offset : </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">8</span><span style="font-family:'Courier New';line-height:1.5;">;
        u32 : </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">;
        u32 val;
    };
          
    </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">const</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> fw_data GSL1680_D0_FW[] =<span style="font-family:'Courier New';line-height:1.5;"> {
        </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> void </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span><span style="font-family:'Courier New';line-height:1.5;">
        { },
    };


    </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5</span><span style="font-family:'Courier New';line-height:1.5;">)input_report_abs上报流程

点击(此处)折叠或打开

    </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> 观察linux-3.6.3/drivers/input/Kconfig, 对应/dev/input/eventX </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span><span style="font-family:'Courier New';line-height:1.5;">
        config INPUT_EVDEV
            tristate </span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">Event interface</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">
            help
              Say Y here </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span><span style="font-family:'Courier New';line-height:1.5;"> you want your input device events be accessible
              under </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">char</span> device <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">13</span>:<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">64</span>+ - /dev/input/eventX <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">in</span><span style="font-family:'Courier New';line-height:1.5;"> a generic way.
          
              To compile </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">this</span> driver <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">as</span><span style="font-family:'Courier New';line-height:1.5;"> a module, choose M here: the
              module will be called evdev.

android </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4.0</span><span style="font-family:'Courier New';line-height:1.5;"> 一般报点序列:

点击(此处)折叠或打开

    input_mt_slot(ts</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">input, id);
    input_report_abs(ts</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">input, ABS_MT_TRACKING_ID, id);
    input_report_abs(ts</span>-&gt;input, ABS_MT_TOUCH_MAJOR, <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1</span><span style="font-family:'Courier New';line-height:1.5;">);
    input_report_abs(ts</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">input, ABS_MT_POSITION_X, x);
    input_report_abs(ts</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">input, ABS_MT_POSITION_Y, y);
    input_report_abs(ts</span>-&gt;input, ABS_MT_WIDTH_MAJOR, <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1</span><span style="font-family:'Courier New';line-height:1.5;">);
    input_mt_sync(ts</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">input);

点击(此处)折叠或打开

    input_sync(ts</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">input);


input_handle_event(dev, type, code, value)上报流程：

点击(此处)折叠或打开

    ...
    </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">switch</span><span style="font-family:'Courier New';line-height:1.5;"> (type) {
      
    </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">case</span><span style="font-family:'Courier New';line-height:1.5;"> EV_SYN:
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">switch</span><span style="font-family:'Courier New';line-height:1.5;"> (code) {
           ...
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">case</span><span style="font-family:'Courier New';line-height:1.5;"> SYN_REPORT:
            </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (!dev-&gt;<span style="font-family:'Courier New';line-height:1.5;">sync) {
                dev</span>-&gt;sync = <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">true</span><span style="font-family:'Courier New';line-height:1.5;">;
                disposition </span>=<span style="font-family:'Courier New';line-height:1.5;"> INPUT_PASS_TO_HANDLERS;
            }
            </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">break</span><span style="font-family:'Courier New';line-height:1.5;">;
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">case</span><span style="font-family:'Courier New';line-height:1.5;"> SYN_MT_REPORT:
            dev</span>-&gt;sync = <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">false</span><span style="font-family:'Courier New';line-height:1.5;">;
            disposition </span>=<span style="font-family:'Courier New';line-height:1.5;"> INPUT_PASS_TO_HANDLERS;
            </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">break</span><span style="font-family:'Courier New';line-height:1.5;">;
        }
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">break</span><span style="font-family:'Courier New';line-height:1.5;">;
      
    </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">case</span><span style="font-family:'Courier New';line-height:1.5;"> EV_KEY:
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (is_event_supported(code, dev-&gt;keybit, KEY_MAX) &amp;&amp;
            !!test_bit(code, dev-&gt;key) !=<span style="font-family:'Courier New';line-height:1.5;"> value) {
      
            </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (value != <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">2</span><span style="font-family:'Courier New';line-height:1.5;">) {
                __change_bit(code, dev</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">key);
                </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span><span style="font-family:'Courier New';line-height:1.5;"> (value)
                    input_start_autorepeat(dev, code);
                </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">else</span><span style="font-family:'Courier New';line-height:1.5;">
                    input_stop_autorepeat(dev);
            }
      
            disposition </span>=<span style="font-family:'Courier New';line-height:1.5;"> INPUT_PASS_TO_HANDLERS;
        }
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">break</span><span style="font-family:'Courier New';line-height:1.5;">;
       ...
    </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">case</span><span style="font-family:'Courier New';line-height:1.5;"> EV_ABS:
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (is_event_supported(code, dev-&gt;<span style="font-family:'Courier New';line-height:1.5;">absbit, ABS_MAX))
            disposition </span>= input_handle_abs_event(dev, code, &amp;<span style="font-family:'Courier New';line-height:1.5;">value);
      
        </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">break</span><span style="font-family:'Courier New';line-height:1.5;">;
       ...
    }
      
       ...
    </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (disposition &amp;<span style="font-family:'Courier New';line-height:1.5;"> INPUT_PASS_TO_HANDLERS)
        input_pass_event(dev, type, code, value);

 

点击(此处)折叠或打开

    </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">void</span> input_pass_event(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> input_dev *<span style="font-family:'Courier New';line-height:1.5;">dev,
                         unsigned </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span> type, unsigned <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span> code, <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span><span style="font-family:'Courier New';line-height:1.5;"> value)
    {
         </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> input_handler *<span style="font-family:'Courier New';line-height:1.5;">handler;
         </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> input_handle *<span style="font-family:'Courier New';line-height:1.5;">handle;
          
         rcu_read_lock();
          
         </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> 获得一个被RCU保护的指针 </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span><span style="font-family:'Courier New';line-height:1.5;">
         handle </span>= rcu_dereference(dev-&gt;<span style="font-family:'Courier New';line-height:1.5;">grab);
         </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> (1) 如果是设备专有handle, 仅将事件传给该handler. </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span>
         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span><span style="font-family:'Courier New';line-height:1.5;"> (handle)
             handle</span>-&gt;handler-&gt;<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">event</span><span style="font-family:'Courier New';line-height:1.5;">(handle, type, code, value);
         </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">else</span><span style="font-family:'Courier New';line-height:1.5;"> {
             </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">bool</span> filtered = <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">false</span><span style="font-family:'Courier New';line-height:1.5;">;
          
             </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> (2)遍历与此设备连接的每一个handle. </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span><span style="font-family:'Courier New';line-height:1.5;">
             list_for_each_entry_rcu(handle, </span>&amp;dev-&gt;<span style="font-family:'Courier New';line-height:1.5;">h_list, d_node) {
                </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> (3)如果hnadle已经被打开. </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span>
                <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (!handle-&gt;<span style="font-family:'Courier New';line-height:1.5;">open)
                    </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">continue</span><span style="font-family:'Courier New';line-height:1.5;">;
          
                handler </span>= handle-&gt;<span style="font-family:'Courier New';line-height:1.5;">handler;
                </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (!handler-&gt;<span style="font-family:'Courier New';line-height:1.5;">filter) {
                     </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span><span style="font-family:'Courier New';line-height:1.5;"> (filtered)
                         </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">break</span><span style="font-family:'Courier New';line-height:1.5;">;
                     </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> (4)将事件分发给handler的事件处理函数. </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span><span style="font-family:'Courier New';line-height:1.5;">
                     handler</span>-&gt;<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">event</span><span style="font-family:'Courier New';line-height:1.5;">(handle, type, code, value);
          
                } </span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">else</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (handler-&gt;<span style="font-family:'Courier New';line-height:1.5;">filter(handle, type, code, value))
                   filtered </span>= <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">true</span><span style="font-family:'Courier New';line-height:1.5;">;
             }
       }
          
       rcu_read_unlock(); 
    }


附上android </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4</span>.0上报方式（linux必须2.<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">6</span><span style="font-family:'Courier New';line-height:1.5;">.38以上）

点击(此处)折叠或打开

    #include </span>&lt;linux/input/mt.h&gt;<span style="font-family:'Courier New';line-height:1.5;">



点击(此处)折叠或打开

    </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">down</span>
        input_mt_slot(ts-&gt;<span style="font-family:'Courier New';line-height:1.5;">input_dev, id);
        </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">input_report_abs(ts-&gt;input_dev, ABS_MT_TRACKING_ID, id);</span>
        input_mt_report_slot_state(data-&gt;input_dev, MT_TOOL_FINGER, <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">true</span><span style="font-family:'Courier New';line-height:1.5;">);
        input_report_abs(ts</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">input_dev, ABS_MT_TOUCH_MAJOR, w);
        input_report_abs(ts</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">input_dev, ABS_MT_POSITION_X, x);
        input_report_abs(ts</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">input_dev, ABS_MT_POSITION_Y, y);



点击(此处)折叠或打开

    </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">up</span>
        input_mt_slot(ts-&gt;<span style="font-family:'Courier New';line-height:1.5;">input_dev, id);
        </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">input_report_abs(ts-&gt;input_dev, ABS_MT_TRACKING_ID, -1);</span>
        input_mt_report_slot_state(ts-&gt;input_dev, MT_TOOL_FINGER, <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">false</span><span style="font-family:'Courier New';line-height:1.5;">);



点击(此处)折叠或打开

    </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">init
        </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">__set_bit(INPUT_PROP_DIRECT, ts-&gt;input_dev-&gt;propbit);</span>
        input_mt_init_slots(ts-&gt;input_dev, <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">255</span>);</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(51,51,51);font-weight:inherit;line-height:inherit;text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(102,102,102);font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif, '宋体';font-size:14px;">&nbsp;</p> 
   <p style="color:rgb(102,102,102);font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif, '宋体';font-size:14px;"><br></p> 
   <p style="color:rgb(102,102,102);font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif, '宋体';font-size:14px;"><br></p> 
   <p style="color:rgb(102,102,102);font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif, '宋体';font-size:14px;"><br></p> 
   <p style="color:rgb(102,102,102);font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif, '宋体';font-size:14px;"><br></p> 
   <p style="color:rgb(102,102,102);font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif, '宋体';font-size:14px;"><br></p> 
   <p style="color:rgb(102,102,102);font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif, '宋体';font-size:14px;"><br></p> 
   <p><font color="#666666"><span style="font-size:14px;"><br></span></font></p> 
   <p><font color="#666666"><span style="font-size:14px;">本文转自张昺华-sky博客园博客，原文链接：http://www.cnblogs.com/sky-heaven/p/6768361.html</span></font><span style="font-size:14px;color:rgb(102,102,102);font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif, '宋体';">，如需转载请自行联系原作者</span></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
