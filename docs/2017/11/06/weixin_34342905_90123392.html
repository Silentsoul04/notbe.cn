<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>KVM 介绍（8）：使用 libvirt 迁移 QEMU/KVM 虚机和 Nova 虚机 [Nova Libvirt QEMU/KVM Live Migration]... « NotBeCN</title>
  <meta name="description" content="             &nbsp;学习 KVM 的系列文章：        （1）介绍和安装     （2）CPU 和 内存虚拟化     （3）I/O QEMU 全虚拟化和准虚拟化（Para-virtulizaiton）     （4）I/O PCI/PCIe设备直接分配和 SR-IOV     （5）li...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/06/weixin_34342905_90123392.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">KVM 介绍（8）：使用 libvirt 迁移 QEMU/KVM 虚机和 Nova 虚机 [Nova Libvirt QEMU/KVM Live Migration]...</h1>
    <p class="post-meta">Nov 6, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;学习 KVM 的系列文章：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;"><a href="http://www.cnblogs.com/sammyliu/p/4543110.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">（1）介绍和安装</a></li> 
    <li style="list-style-type:disc;"><a href="http://www.cnblogs.com/sammyliu/p/4543597.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">（2）CPU 和 内存虚拟化</a></li> 
    <li style="list-style-type:disc;"><a href="http://www.cnblogs.com/sammyliu/p/4543657.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">（3）I/O QEMU 全虚拟化和准虚拟化（Para-virtulizaiton）</a></li> 
    <li style="list-style-type:disc;"><a href="http://www.cnblogs.com/sammyliu/p/4548194.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">（4）I/O PCI/PCIe设备直接分配和 SR-IOV</a></li> 
    <li style="list-style-type:disc;"><a href="http://www.cnblogs.com/sammyliu/p/4558638.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">（5）libvirt 介绍</a></li> 
    <li style="list-style-type:disc;"><a href="http://www.cnblogs.com/sammyliu/p/4568188.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">（6）Nova 通过 libvirt 管理 QEMU/KVM 虚机</a></li> 
    <li style="list-style-type:disc;"><a href="http://www.cnblogs.com/sammyliu/p/4468757.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">（7）快照 （snapshot）</a></li> 
    <li style="list-style-type:disc;"><a href="http://www.cnblogs.com/sammyliu/p/4572287.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">（8）迁移 （migration）</a></li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1. QEMU/KVM 迁移的概念</h2> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp; &nbsp;<strong>迁移（migration）</strong>包括系统整体的迁移和某个工作负载的迁移。系统整理迁移，是将系统上所有软件包括操作系统完全复制到另一个物理机硬件机器上。虚拟化环境中的迁移，可分为静态迁移（static migration，或者 冷迁移 cold migration，或者离线迁移 offline migration） 和 动态迁移 （live migration，或者 热迁移 hot migration 或者 在线迁移 online migration）。静态迁移和动态迁移的最大区别是，静态迁移有明显一段时间客户机中的服务不可用，而动态迁移则没有明显的服务暂停时间。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp; 虚拟化环境中的静态迁移也可以分为两种，一种是关闭客户机后，将其硬盘镜像复制到另一台宿主机上然后恢复启动起来，这种迁移不能保留客户机中运行的工作负载；另一种是两台宿主机共享存储系统，这时候的迁移可以保持客户机迁移前的内存状态和系统运行的工作负载。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp; 动态迁移，是指在保证客户机上应用服务正常运行的同时，让客户机在不同的宿主机之间进行迁移，其逻辑步骤和前面的静态迁移几乎一直，有硬盘存储和内存都复制的动态迁移，也有仅复制内存镜像的动态迁移。不同的是，为了保证迁移过程中客户机服务的可用性，迁移过程只能有非常短暂的停机时间。动态迁移允许系统管理员将客户机在不同物理机上迁移，同时不会断开访问客户机中服务的客户端或者应用程序的连接。一个成功的迁移，需要保证客户机的内存、硬盘存储和网络连接在迁移到目的主机后任然保持不变，而且迁移的过程的服务暂停时间较短。</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.1 迁移效率的衡量</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）整体迁移时间</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）服务器停机时间：这时间是指源主机上的客户机已经暂停服务，而目的主机上客户机尚未恢复服务的时间。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（3）对服务性能的影响：客户机迁移前后性能的影响，以及目的主机上其它服务的性能影响。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; 其中，整体迁移时间受很多因素的影响，比如 Hypervisor 和迁移工具的种类、磁盘存储的大小（是否需要复制磁盘镜像）、内存大小及使用率、CPU 的性能和利用率、网络带宽大小及是否拥塞等，整体迁移时间一般分为几秒钟到几十分钟不等。动态迁移的服务停机时间，也有这些因素的影响，往往在几毫秒到几百毫秒。而静态迁移，其暂停时间较长。因此，静态迁移一般适合于对服务可用性要求不高的场景，而动态迁移适合于对可用性要求高的场景。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">动态迁移的应用场景包括：负载均衡、解除硬件依赖、节约能源 和异地迁移。</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.2 KVM 迁移的原理</h3> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1.2.1 静态迁移</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp; 对于静态迁移，你可以在宿主机上某客户机的 QEMU monitor 中，用 savevm my_tag 命令保存一个完整的客户机镜像快照，然后在宿主机中关闭或者暂停该客户机，然后将该客户机的镜像文件复制到另一台宿主机中，使用在源主机中启动该客户机时的命令来启动复制过来的镜像，在其 QEMU monitor 中 loadvm my_tag 命令恢复刚才保存的快照即可完全加载保存快照时的客户机状态。savevm 命令可以保证完整的客户机状态，包括 CPU 状态、内存、设备状态、科协磁盘中的内存等。注意，这种方式需要 qcow2、qed 等格式的磁盘镜像文件的支持。</p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1.2.2 动态迁移</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp; 如果源宿主机和目的宿主机共享存储系统，则只需要通过网络发送客户机的 vCPU 执行状态、内存中的内容、虚机设备的状态到目的主机上。否则，还需要将客户机的磁盘存储发到目的主机上。共享存储系统指的是源和目的虚机的镜像文件目录是在一个共享的存储上的。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp; 在基于<span style="line-height:1.5;text-decoration:underline;">共享存储系统</span>时，KVM 动态迁移的具体过程为：</p> 
   <ol style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;">迁移开始时，客户机依然在宿主机上运行，与此同时，客户机的内存页被传输到目的主机上。</li> 
    <li style="list-style-type:decimal;">QEMU/KVM 会监控并记录下迁移过程中所有已被传输的内存页的任何修改，并在所有内存页都传输完成后即开始传输在前面过程中内存页的更改内容。</li> 
    <li style="list-style-type:decimal;">QEMU/KVM 会估计迁移过程中的传输速度，当剩余的内存数据量能够在一个可以设定的时间周期（默认 30 毫秒）内传输完成时，QEMU/KVM 会关闭源宿主机上的客户机，再将剩余的数据量传输到目的主机上，最后传输过来的内存内容在目的宿主机上恢复客户机的运行状态。</li> 
    <li style="list-style-type:decimal;">至此，KVM 的动态迁移操作就完成了。迁移后的客户机尽可能与迁移前一直，除非目的主机上缺少一些配置，比如网桥等。</li> 
   </ol>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">注意，当客户机中内存使用率非常大而且修改频繁时，内存中数据不断被修改的速度大于KVM能够传输的内存速度时，动态迁移的过程是完成不了的，这时候只能静态迁移。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">关于实时迁移的效率，业界不少人提出了改进的建议，比如通过使用内存压缩技术，减少需要传输的内存的大小。<a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.402.2198&amp;rep=rep1&amp;type=pdf" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这篇文章</a>比较了各种方法，还是值得一读。</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.3 使用命令行的方式做动态迁移</h3> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1.3.1 使用 NFS 共享存储</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）在源宿主机上挂载 NFS 上的客户机镜像，并启动客户机</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>mount my-nfs:/raw-images/ /mnt/<span style="line-height:1.5;">

kvm </span>/mnt/rh1.img -smp <span style="color:rgb(128,0,128);line-height:1.5;">2</span> -m <span style="color:rgb(128,0,128);line-height:1.5;">2048</span> -net nic -net tap</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）在目的宿主机上也挂载镜像目录，并启动一个客户机用于接收动态迁移过来的内存内容</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>mount my-nfs:/raw-images/ /mnt/<span style="line-height:1.5;">

kvm </span>/mnt/rh1.img -smp <span style="color:rgb(128,0,128);line-height:1.5;">2</span> -m <span style="color:rgb(128,0,128);line-height:1.5;">2048</span> -net nic -net tap -incoming tcp:<span style="color:rgb(128,0,128);line-height:1.5;">0</span>:<span style="color:rgb(128,0,128);line-height:1.5;">6666</span></pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">注意：（1）NFS 挂载目录必须一致 （2）“-incoming tcp:0:6666” 参数表示在 6666 端口建立一个 TCP socket 连接用于接收来自源主机的动态迁移的内容，其中 0 表示运行来自任何主机的连接。“-incoming“ 使 qemu-kvm 进程进入到监听模式，而不是真正以命令行中的文件运行客户机。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（3）在源宿主机的客户机的 QEMU monitor 中，使用命令 ” migrate tcp:host2:6666" 即可进入动态迁移的流程。</p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1.3.2 不使用共享存储的动态迁移</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">过程类似，包括使用相同backing file 的镜像的客户机迁移，以及完全不同镜像文件的客户机的迁移。唯一的区别是，migrate 命令中添加 “-b” 参数，它意味着传输块设备。</p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1.3.3 其它 QEMU monitor migrate 命令</h4> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">migrate_cancel：取消迁移</li> 
    <li style="list-style-type:disc;">migrate_set_speed：设置最大迁移速度，单位是 bytes</li> 
    <li style="list-style-type:disc;">migrate_set_downtime：设置最大允许的服务暂停时间，单位是 秒</li> 
    <li style="list-style-type:disc;">info migrate：显示迁移进度</li> 
   </ul>
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">2. OpenStack Nova QEMU/KVM 实例动态迁移的环境配置</h2> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">除了直接拷贝磁盘镜像文件的冷迁移，OpenStack 还支持下面几种虚机热迁移模式：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">不使用共享存储时的块实时迁移（Block live migration without shared storage）。这种模式不支持使用只读设备比如 CD-ROM 和 Config Drive。块实时迁移不需要 nova compute 节点都使用共享存储。它使用 TCP 来将虚机的镜像文件通过网络拷贝到目的主机上，因此和共享存储式的实时迁移相比，这种方式需要更长的时间。而且在迁移过程中，主机的性能包括网络和 CPU 会下降。</li> 
    <li style="list-style-type:disc;">基于共享存储的实时迁移 （Shared storage based live&nbsp;migration）：两个主机可以访问共享的存储。</li> 
    <li style="list-style-type:disc;">从卷启动的虚机的实时迁移（Volume backed VM live migration）。这种迁移也是一种块拷贝迁移。</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">实时迁移的过程并不复杂，复杂在于环境配置。</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.1 基础环境配置</h3> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">2.1.1 SSH 权限配置</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">这种方式需要配置源(compute1)和目的主机(compute2)之间能够通过 SSH 相互访问，以确保能通过 TCP 拷贝文件，已经可以通过 SSH 在目的主机建立目录。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">使用 nova 用户在compute1 上执行操作：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>usermod -s /bin/<span style="line-height:1.5;">bash nova
su nova
mkdir </span>-p -m <span style="color:rgb(128,0,128);line-height:1.5;">700</span><span style="line-height:1.5;"> .ssh

#创建 config 文件如下
nova@compute2:</span>~/<span style="line-height:1.5;">.ssh$ cat config
Host </span>*<span style="line-height:1.5;">
StrictHostKeyChecking no
UserKnownHostsFile</span>=/dev/<span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">

#产生 key
ssh</span>-keygen -f id_rsa -b <span style="color:rgb(128,0,128);line-height:1.5;">1024</span> -P <span style="color:rgb(128,0,0);line-height:1.5;">""</span><span style="line-height:1.5;">
cat id_rsa.pub </span>&gt;&gt;<span style="line-height:1.5;"> authorized_keys

#将 id_rsa id_rsa.pub 拷贝到 compute2 上面
cat id_rsa.pub </span>&gt;&gt; authorized_keys</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;">使用 root 用户在每个主机上进行操作：</span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>root@compute1:/<span style="color:rgb(0,0,255);line-height:1.5;">var</span>/lib/nova/.ssh# chown -R nova:nova /<span style="color:rgb(0,0,255);line-height:1.5;">var</span>/lib/<span style="line-height:1.5;">nova
root@compute1:</span>/<span style="color:rgb(0,0,255);line-height:1.5;">var</span>/lib/nova/.ssh# chmod <span style="color:rgb(128,0,128);line-height:1.5;">700</span> /<span style="color:rgb(0,0,255);line-height:1.5;">var</span>/lib/nova/<span style="line-height:1.5;">.ssh
root@compute1:</span>/<span style="color:rgb(0,0,255);line-height:1.5;">var</span>/lib/nova/.ssh# chmod <span style="color:rgb(128,0,128);line-height:1.5;">600</span> /<span style="color:rgb(0,0,255);line-height:1.5;">var</span>/lib/nova/.ssh/authorized_keys</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;">测试 SSH 无密码访问：</span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>nova@compute1:~/<span style="line-height:1.5;">.ssh$ ssh nova@compute2 ls
Warning: Permanently added </span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">compute2,192.168.1.29</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;"> (ECDSA) to the list of known hosts.
...

nova@compute2:</span>~/<span style="line-height:1.5;">.ssh$ ssh nova@compute1 ls
Warning: Permanently added </span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">compute1,192.168.1.15</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;"> (ECDSA) to the list of known hosts.
...</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">2.1.2 其它配置</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;每个node 上的 DNS 或者&nbsp;/etc/hosts，确保互联互通。</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.2 Live migration 环境配置</h3> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">2.2.1 libvirtd 配置</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">在 compute1 和 compute2 上做如下配置：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>-&gt;Edit /etc/libvirt/<span style="line-height:1.5;">libvirtd.conf
listen_tls </span>= <span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">
listen_tcp </span>= <span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">
auth_tcp </span>=<span style="line-height:1.5;"> “none”

</span>-&gt;Edit /etc/init/libvirt-bin.conf<span style="line-height:1.5;"><br>
env libvirtd_opts="-d <span style="color:rgb(0,0,255);line-height:1.5;">-l</span>"<br></span></pre> 
    <pre>-&gt;Edit /etc/default/libvirt-bin</pre> 
    <p style="line-height:1.5;">&nbsp; # options passed to libvirtd, add "-l" to listen on tcp<br> &nbsp; libvirtd_opts="-d&nbsp;<span style="color:rgb(0,0,255);line-height:1.5;font-size:12px;">-l</span>"</p> 
    <pre>-&gt;<span style="line-height:1.5;">Restart libvirtd
service libvirt-bin restart<br><br>
root &nbsp; &nbsp; 12088 &nbsp; &nbsp; 1 &nbsp;2 07:48 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 /usr/sbin/libvirtd -d -l</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">做完上述操作后，可以使用如下命令来检查是否设置正确：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>root@compute2:~# virsh -c qemu+tcp:<span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">compute1/system list  --all</span>
<span style="line-height:1.5;"> Id    Name                           State
</span>----------------------------------------------------
 <span style="color:rgb(128,0,128);line-height:1.5;">4</span>     instance-<span style="line-height:1.5;">0000000d              running
 </span><span style="color:rgb(128,0,128);line-height:1.5;">5</span>     instance-<span style="color:rgb(128,0,128);line-height:1.5;">00000006</span><span style="line-height:1.5;">              running
 </span>-     instance-<span style="color:rgb(128,0,128);line-height:1.5;">00000005</span><span style="line-height:1.5;">              shut off

root@compute1:</span>~# virsh -c qemu+tcp:<span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">compute2/system list  --all</span>
<span style="line-height:1.5;"> Id    Name                           State
</span>----------------------------------------------------</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;">Nova 设置：</span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>-&gt;Edit /etc/nova/<span style="line-height:1.5;">nova.conf, add following line:  
  [libvirt]
  block_migration_flag </span>=<span style="line-height:1.5;"> VIR_MIGRATE_UNDEFINE_SOURCE,VIR_MIGRATE_PEER2PEER, VIR_MIGRATE_LIVE,VIR_MIGRATE_TUNNELLED,VIR_MIGRATE_NON_SHARED_INC
  live_migration_flag </span>=<span style="line-height:1.5;"> VIR_MIGRATE_UNDEFINE_SOURCE, VIR_MIGRATE_PEER2PEER, VIR_MIGRATE_LIVE,VIR_MIGRATE_TUNNELLED
  live_migration_uri </span>= qemu+tcp:<span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">%s/system</span></pre>
   </div> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">2.2.2 共享存储 Live migration 环境配置</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">其实共享存储的实时迁移配置的要求和块拷贝的实时迁移的配置差不多，除了下面几点：</p> 
   <ol style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;">Hypervisor 要求：目前只有部分 Hypervisor 支持 live migraiton，可查询<a href="http://docs.openstack.org/developer/nova/support-matrix.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">该表</a>。</li> 
    <li style="list-style-type:decimal;">共享存储：存放虚机文件的文件夹&nbsp;<code class="filename"><em><code>NOVA-INST-DIR</code></em>/instances/</code>&nbsp;(比如&nbsp;<code class="filename">/var/lib/nova/instances，该路径可以由 state_path 配置变量来配置</code>) 必须是挂载到共享存储上的。当Nova 使用 RBD 作为镜像的backend时，这个要求不是必须的，具体见下面的说明。</li> 
    <li style="list-style-type:decimal;">必须在 nova.conf 中配置&nbsp;vncserver_listen=0.0.0.0 (关于这个，社区认为这个配置具有安全风险，会通过这个&nbsp;<a href="https://bugs.launchpad.net/nova/+bug/1262450" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">ticket&nbsp;</a>来解决)</li> 
    <li style="list-style-type:decimal;">不使用默认配置的话，必须在每个 nova compute 上的 nova.conf 中配置相同的&nbsp;<code class="literal">instances_path</code>&nbsp;和&nbsp;<code class="literal">state_path</code>&nbsp;。</li> 
    <li style="list-style-type:decimal;">在 Kilo 版本之前，Nova 是默认不支持 live migriation 的。在做实时迁移之前，需要在 nova.conf 中做如下配置</li> 
   </ol>
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>live_migration_flag=VIR_MIGRATE_UNDEFINE_SOURCE,VIR_MIGRATE_PEER2PEER,VIR_MIGRATE_LIVE,VIR_MIGRATE_TUNNELLED</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;">&nbsp;</span>注意：对于上面第二点，在 Kilo 版本中（前面版本的情况未知），当 Nova 使用 RBD 作为 image backend 时，Nova 会认为是在共享存储上：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre><span style="line-height:1.5;">def check_instance_shared_storage_local(self, context, instance):
        </span><span style="color:rgb(128,0,0);line-height:1.5;">"""</span><span style="color:rgb(128,0,0);line-height:1.5;">Check if instance files located on shared storage.</span><span style="color:rgb(128,0,0);line-height:1.5;">"""
</span>        <span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> self.image_backend.backend().is_shared_block_storage():
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> None</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">在&nbsp;class Rbd(Image): 类中：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre><span style="line-height:1.5;"> @staticmethod
    def is_shared_block_storage():<br>
"""True if the backend puts images on a shared block storage."""
        </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> True</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">目前，只有 RBD 作为 image backend 时，该函数才返回 true。对于其它类型的 backend，Nova 会在目的 host 上的 instance folder 创建一个临时文件，再在源 host 上查看该文件，通过判断是否该文件在共享存储上来判断是否在使用共享存储。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">常见问题：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）在源 host 上，出现 &nbsp;”live Migration failure: operation failed: Failed to connect to remote libvirt URI qemu+tcp://compute2/system: unable to connect to server at 'compute2:16509': Connection refused“</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">其原因是 2.1.1 部分的 libvirt 设置不正确。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）在目的 host 上，出现 ”libvirtError: internal error: process exited while connecting to monitor: 2015-09-21T14:17:31.840109Z qemu-system-x86_64: -drive file=rbd:vms/6bef8898-85f9-429d-9250-9291a2e4e5ac_disk:id=cinder:key=AQDaoPpVEDJZHhAAu8fuMR/OxHUV90Fm1MhONQ==:auth_supported=cephx\;none:mon_host=9.115.251.194\:6789\;9.115.251.195\:6789\;9.115.251.218\:6789,if=none,id=drive-virtio-disk0,format=raw,cache=writeback,discard=unmap: could not open disk image rbd:vms/6bef8898-85f9-429d-9250-9291a2e4e5ac_disk:id=cinder:key=AQDaoPpVEDJZHhAAu8fuMR/OxHUV90Fm1MhONQ==:auth_supported=cephx\;none:mon_host=9.115.251.194\:6789\;9.115.251.195\:6789\;9.115.251.218\:6789: Could not open 'rbd:vms/6bef8898-85f9-429d-9250-9291a2e4e5ac_disk:id=cinder:key=AQDaoPpVEDJZHhAAu8fuMR/OxHUV90Fm1MhONQ==:auth_supported=cephx\;none:mon_host=9.115.251.194\:6789\;9.115.251.195\:6789\;9.115.251.218\:6789': Operation not permitted“</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">原因：目的 host 上的用户操作 RBD 的权限设置不正确，检查&nbsp;secret 设置。</p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">3. 迁移过程</h2> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">3.0 Nova 有关迁移的命令</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">Nova 有三个与迁移有关的命令：migrate，live-migrate 和 resize。</p> 
   <table border="0" style="border:1px solid #C0C0C0;border-collapse:collapse;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <tbody>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><strong>Nova CLI</strong></td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><strong>REST API Action</strong></td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><strong>行为</strong></td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">nova live-migration &nbsp;--block-migrate &nbsp;--disk_over_commit&nbsp;8352e969-0a25-4abf-978f-d9d0ec4de0cd compute2</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">os-migrateLive</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">块拷贝动态迁移</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">nova live-migration &nbsp;8352e969-0a25-4abf-978f-d9d0ec4de0cd compute2</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">os-migrateLive</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">共享存储动态迁移</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">nova migrate &nbsp;8352e969-0a25-4abf-978f-d9d0ec4de0cd</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">migrate</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">静态迁移</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">nova resize --poll 8352e969-0a25-4abf-978f-d9d0ec4de0cd 1</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">resize</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">静态迁移并且改变 flavor</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">nova resize --poll 8352e969-0a25-4abf-978f-d9d0ec4de0cd</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">resize</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">静态迁移</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">nova resize-confirm 9eee079e-0353-44cb-b76c-ecf9be61890d</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">confirmResize</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">确认 resize 使得完整操作得以完成&nbsp;</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">nova resize-revert 9eee079e-0353-44cb-b76c-ecf9be61890d</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">revertResize</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">取消 resize 使得操作被取消虚机回到原始状态&nbsp;</td> 
     </tr>
    </tbody>
   </table>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;">&nbsp;</span></p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;"><span style="line-height:1.5;">3.1 静态迁移（migrate 或者 resize 不使用新的 flavor）</span></h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>s1@controller:~$ nova migrate --poll 9eee079e-0353-44cb-b76c-<span style="line-height:1.5;">ecf9be61890d

Server migrating... 100%<span style="line-height:1.5;"> complete Finished s1@controller:~<span style="line-height:1.5;">$ nova list +--------------------------------------+-------+---------------+------------+-------------+------------------------------------------+ | ID | Name | Status | Task State | Power State | Networks | +--------------------------------------+-------+---------------+------------+-------------+------------------------------------------+ | 02699155-940f-4401-bc01-36220db80639 | vm10 | ACTIVE | - | Running | demo-net2=10.0.10.17; demo-net=10.0.0.39 | | 9eee079e-0353-44cb-b76c-ecf9be61890d | vm100 | VERIFY_RESIZE | - | Running | demo-net2=10.0.10.20 | +--------------------------------------+-------+---------------+------------+-------------+------------------------------------------+<span style="line-height:1.5;"> s1@controller:~$ nova resize-confirm 9eee079e-0353-44cb-b76c-<span style="line-height:1.5;">ecf9be61890d s1@controller:~<span style="line-height:1.5;">$ nova list +--------------------------------------+-------+--------+------------+-------------+------------------------------------------+ | ID | Name | Status | Task State | Power State | Networks | +--------------------------------------+-------+--------+------------+-------------+------------------------------------------+ | 02699155-940f-4401-bc01-36220db80639 | vm10 | ACTIVE | - | Running | demo-net2=10.0.10.17; demo-net=10.0.0.39 | | 9eee079e-0353-44cb-b76c-ecf9be61890d | vm100 | ACTIVE | - | Running | demo-net2=10.0.10.20 | +--------------------------------------+-------+--------+------------+-------------+------------------------------------------+</span></span></span></span></span></span><span style="line-height:1.5;font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;"><span style="line-height:1.5;">3.1.1 迁移过程</span></h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;直接使用流程图来说明：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images0.cnblogs.com/blog2015/697113/201506/191329372631124.jpg" alt="" width="1128" height="518" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images0.cnblogs.com/blog2015/697113/201506/191330283266558.jpg" alt="" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">1. migrate 和 resize 都是执行静态迁移。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">2. 静态迁移分为三个阶段：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）调用 Scheduler 算法选择目的 node（步骤5），并通过 RPC 远程调用 prep_resize 做些迁移前的准备工作</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）在源主机上，调用 libvirt driver 做一系列操作：</p> 
   <ol style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;">使用 ssh 在目的 node 上建立虚机的镜像文件的目录</li> 
    <li style="list-style-type:decimal;">将虚机关机</li> 
    <li style="list-style-type:decimal;">断开所有 volume connections</li> 
    <li style="list-style-type:decimal;">针对每一个非 swap 分区的磁盘，如果是 qcow2 格式，则执行 qemu-img merge 操作将稀疏文件和backing 文件合并成单个文件，并通过 “rysnc” 或者 “scp”命令将文件拷贝到目的 node 上</li> 
    <li style="list-style-type:decimal;">开始迁移需要的网络工作</li> 
   </ol>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（3）通过 RPC，调用目的 node 上的 Nova 的 finish_resize 方法。该方法会在自己本机上设置网络、结束网络设置工作，并调用 libvirt driver 来：</p> 
   <ol style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;">创建 image</li> 
    <li style="list-style-type:decimal;">获取 guest xml</li> 
    <li style="list-style-type:decimal;">创建 domain 和 network</li> 
    <li style="list-style-type:decimal;">需要的话启动虚机</li> 
   </ol>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">至此，虚机已经被拷贝到目的主机上了。接下来，用户有两个选择：resize_confirm 和 resize_revert。</p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">3.1.2 确认迁移 （resize_confirm）</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">迁移确认后，在源主机上，虚机的文件会被删除，虚机被 undefine，虚机的 VIF 被从 OVS 上拔出，network filters 也会被删除。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images0.cnblogs.com/blog2015/697113/201506/191351167791615.jpg" alt="" style="border:0px;"></p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">3.1.3 取消迁移 （resize_revert）</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">取消迁移的命令首先发到目的 node 上，依次 tear down network，删除 domain，断掉 volume connections，然后调用源主机上的方法来重建 network，删除临时文件，启动 domain。这样，虚机就会需要到 resize 之前的状态。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;"><img src="https://images0.cnblogs.com/blog2015/697113/201506/191413140298321.jpg" alt="" style="border:0px;"></span></p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">&nbsp;3.2 实时迁移 （Live migration）</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">可以 Nova client 的 live-migration 命令来做实时迁移，除了要被迁移的 虚机 和 目的 node 外，它可以带两个额外的参数：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">“block-migrate“：使用的话，做 block copy live migration；不使用的话，做共享存储的 live migration；</li> 
    <li style="list-style-type:disc;">”disk_over_commit“：使用的话，计算所有磁盘的 disk_size 来计算目的 node 上所需空间的大小；不使用的话，则计算磁盘的 virtual size。在下面的例子中，<span style="line-height:1.5;">如果使用&nbsp;</span><span style="line-height:1.5;">disk_over_commit，那么计算在目的主机上需要的空间的时候，该 disk 的 size 为 324k，否则为 1G：</span> </li> 
   </ul>
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>root@compute1:/home/s1# qemu-img info /<span style="color:rgb(0,0,255);line-height:1.5;">var</span>/lib/nova/instances/8352e969-0a25-4abf-978f-d9d0ec4de0cd/<span style="line-height:1.5;">disk.local
image: </span>/<span style="color:rgb(0,0,255);line-height:1.5;">var</span>/lib/nova/instances/8352e969-0a25-4abf-978f-d9d0ec4de0cd/<span style="line-height:1.5;">disk.local
file format: qcow2
</span><span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> size: <span style="color:rgb(128,0,128);line-height:1.5;">1</span>.0G (<span style="color:rgb(128,0,128);line-height:1.5;">1073741824</span><span style="line-height:1.5;"> bytes)
disk size: 324K
cluster_size: </span><span style="color:rgb(128,0,128);line-height:1.5;">65536</span><span style="line-height:1.5;">
backing file: </span>/<span style="color:rgb(0,0,255);line-height:1.5;">var</span>/lib/nova/instances/_base/<span style="line-height:1.5;">ephemeral_1_default
Format specific information:
    compat: </span><span style="color:rgb(128,0,128);line-height:1.5;">1.1</span><span style="line-height:1.5;">
    lazy refcounts: </span><span style="color:rgb(0,0,255);line-height:1.5;">false</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">REST API request body 实例：&nbsp;{"os-migrateLive": {"disk_over_commit": false, "block_migration": true, "host": "compute2"}}</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">实时迁移的主要步骤如下：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images0.cnblogs.com/blog2015/697113/201506/191554052636734.jpg" alt="" width="720" height="486" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images0.cnblogs.com/blog2015/697113/201506/191555432167875.jpg" alt="" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">其过程也可以分为三个阶段：</p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">3.2.1 实时迁移前的准备工作 （步骤 2 - 7）</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">Nova 通过 RPC 调用目的主机上 nova comute manager 的&nbsp;pre_live_migration 方法，它依次：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）准备 instance 目录：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp; &nbsp; （1）创建 instance dir</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）如果源和目的虚机不共享 instance path：获取镜像类型，为每一个disk，如果不使用 backing file 的话则调用 “qemu-img create” 方法来创建空的磁盘镜像；否则，依次创建空的 Ephemeral disk 和 Swap disk，以及从 &nbsp;Glance 中获取 image 来创建 Root disk</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（3）如果不是 block migration 而且 不&nbsp;is_shared_instance_path，则&nbsp;_fetch_instance_kernel_ramdisk</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）调用 volumer driver api 为每一个volume 建立目的主机和 volume 的连接</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（3）调用&nbsp;plug_vifs(instance, network_info) 将每一个 vif plug 到 OVS 上</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（4）调用&nbsp;network_api.setup_networks_on_host 方法，该方法会为迁移过来的虚机准备 dhcp 和 gateway；</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（5）调用 libvirt driver 的&nbsp;ensure_filtering_rules_for_instance 方法去准备 network filters。</p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">3.2.2 调用 libvirt API 开始迁移虚机 （步骤 8 - 9）</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; 这部分的实现在 libvirt driver 代码中。因为 libvirt 的一个 bug （说明<a href="http://www.cnblogs.com/VIR_DOMAIN_XML_MIGRATABLE" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">在这里</a>），当 libvirt 带有&nbsp;VIR_DOMAIN_XML_MIGRATABLE flag 时，Nova 会调用 libvirt 的 virDomainMigrateToURI2 API，否则调用 virDomainMigrateToURI API。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">首先比较一下 block live migration 和 live migration 的 flags 的区别：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre><span style="line-height:1.5;">#nova block live migration flags：VIR_MIGRATE_UNDEFINE_SOURCE, VIR_MIGRATE_PEER2PEER, VIR_MIGRATE_LIVE, VIR_MIGRATE_TUNNELLED, <span style="color:rgb(0,0,255);line-height:1.5;">VIR_MIGRATE_NON_SHARED_INC</span>
#nova live migration flags：      VIR_MIGRATE_UNDEFINE_SOURCE, VIR_MIGRATE_PEER2PEER, VIR_MIGRATE_LIVE, VIR_MIGRATE_TUNNELLED    </span></pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">各自的含义如下：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">VIR_MIGRATE_UNDEFINE_SOURCE：&nbsp;迁移完成后，将源虚机删除掉。（If the migration is successful, undefine the domain on the source host.）</li> 
    <li style="list-style-type:disc;"> <span style="line-height:1.5;">VIR_MIGRATE_PEER2PEER 和&nbsp;</span>VIR_MIGRATE_TUNNELLED 一起使用：点对点迁移，必须指定目的 URI，QEMU在两者之间建立 TCP Tunnel 用于数据传输</li> 
    <li style="list-style-type:disc;">VIR_MIGRATE_LIVE： 执行 live migration，不要停机 （Do not pause the VM during migration）</li> 
    <li style="list-style-type:disc;">VIR_MIGRATE_NON_SHARED_INC：&nbsp;使用非共享存储式迁移即 block migration （Migration with non-shared storage with incremental disk copy）</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">再看看两个 API 的参数：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;">    virDomainMigrateToURI2        (virDomainPtr domain,
                     </span><span style="color:rgb(0,0,255);line-height:1.5;">const</span> <span style="color:rgb(0,0,255);line-height:1.5;">char</span> *<span style="line-height:1.5;"> dconnuri, <span style="color:rgb(0,0,255);line-height:1.5;"># 格式为 qemu+tcp://&lt;desthost&gt;/system </span></span><span style="color:rgb(0,0,255);line-height:1.5;">const</span> <span style="color:rgb(0,0,255);line-height:1.5;">char</span> *<span style="line-height:1.5;"> miguri, <span style="color:rgb(0,0,255);line-height:1.5;">#为 none </span></span><span style="color:rgb(0,0,255);line-height:1.5;">const</span> <span style="color:rgb(0,0,255);line-height:1.5;">char</span> *<span style="line-height:1.5;"> dxml, <span style="color:rgb(0,0,255);line-height:1.5;">#指定迁移后的虚机的 XML。Nova 对 “/devices/graphics” 部分做了一点点更改。</span>
                     unsigned </span><span style="color:rgb(0,0,255);line-height:1.5;">long</span><span style="line-height:1.5;"> flags, <span style="color:rgb(0,0,255);line-height:1.5;"># nova.conf 中的配置 </span></span><span style="color:rgb(0,0,255);line-height:1.5;">const</span> <span style="color:rgb(0,0,255);line-height:1.5;">char</span> *<span style="line-height:1.5;"> dname,<span style="color:rgb(0,0,255);line-height:1.5;"> #none</span>
                     unsigned </span><span style="color:rgb(0,0,255);line-height:1.5;">long</span> bandwidth)  <span style="color:rgb(0,0,255);line-height:1.5;"># 由 CONF.libvirt.live_migration_bandwidth 指定，默认为 0 表示由 libvirt 自己选择合适的值</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">如果 libvirt 不带&nbsp;VIR_DOMAIN_XML_MIGRATABLE flag，则调用的 API 是：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;">    virDomainMigrateToURI        (virDomainPtr domain,
                     </span><span style="color:rgb(0,0,255);line-height:1.5;">const</span> <span style="color:rgb(0,0,255);line-height:1.5;">char</span> *<span style="line-height:1.5;"> duri,
                     unsigned </span><span style="color:rgb(0,0,255);line-height:1.5;">long</span><span style="line-height:1.5;"> flags,
                     </span><span style="color:rgb(0,0,255);line-height:1.5;">const</span> <span style="color:rgb(0,0,255);line-height:1.5;">char</span> *<span style="line-height:1.5;"> dname,
                     unsigned </span><span style="color:rgb(0,0,255);line-height:1.5;">long</span> bandwidth)</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">可见，两个 API 唯一的区别是不能指定新的虚机使用的 XML 配置。这时候你必须手动配置 VNC 或者 SPICE 地址为&nbsp;0.0.0.0 or :: （接收全部）或者&nbsp;127.0.0.1 or ::1 （只限本机）。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">调用 API 后，接下来就是等待其完成。这其中的过程应该主要包括：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）根据传入的 domain xml，启动一个虚机，它处于等待 TCP incoming 状态</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）从源 node 上将 domain 的数据传过来</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（3）快完成时，关闭源 node 上的虚机，传输最后一次数据，打开目的 node 上的虚机</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（4）将源 node 上的虚机删除</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">Nova 每个0.5 秒检查源虚机的状态，直到它被删除。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">迁移完成后，需要执行后续的操作（_post_live_migration）。</p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">3.2.3 迁移完成后在源和目的主机上的后续操作（步骤 10 -29）</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">在源主机上，依次执行下面的操作：</p> 
   <ol style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;">调用 volume driver 的 disconnect_volume 方法和<span style="line-height:1.5;font-size:14px;">&nbsp;</span><span style="line-height:1.5;font-size:14px;">terminate_connection 方法，</span><span style="line-height:1.5;font-size:14px;">断开主机和所有 volume 的连接</span> </li> 
    <li style="list-style-type:decimal;"><span style="line-height:1.5;font-size:14px;">调用&nbsp;firewall driver 的 unfilter_instance 方法，删除 domain 的 iptables 中的所有&nbsp;security group ingress 规则 （self.iptables.ipv4['filter'].remove_chain(chain_name)）</span></li> 
    <li style="list-style-type:decimal;"><span style="line-height:1.5;font-size:14px;">调用&nbsp;network api 的 migrate_instance_start 方法，开始将网络从源主机上迁移到目的主机上（实际上没做什么事情，只是 pass）</span></li> 
    <li style="list-style-type:decimal;"> <span style="line-height:1.5;font-size:14px;"><span style="line-height:1.5;">调用&nbsp;vif driver 的 unplug 方法，将每个 vif 从 OVS 上删除 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></span> 
     <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
      <pre>brctl delif qbr59cfa0b8-2f qvb59cfa0b8-<span style="line-height:1.5;">2f 
ip link </span><span style="color:rgb(0,0,255);line-height:1.5;">set</span> qbr59cfa0b8-<span style="line-height:1.5;">2f down 
brctl delbr qbr59cfa0b8</span>-<span style="line-height:1.5;">2f 
ovs</span>-vsctl --timeout=<span style="color:rgb(128,0,128);line-height:1.5;">120</span> -- --<span style="color:rgb(0,0,255);line-height:1.5;">if</span>-exists del-port br-<span style="color:rgb(0,0,255);line-height:1.5;">int</span> qvo59cfa0b8-<span style="line-height:1.5;">2f 
ip link delete qvo59cfa0b8</span>-2f</pre>
     </div> </li> 
    <li style="list-style-type:decimal;">通过 RPC 调用目的主机上的 nova manager 的 post_live_migration_at_destination 方法，该方法会： 
     <ol>
      <li style="list-style-type:decimal;">调用&nbsp;network api 的 setup_networks_on_host 方法来设置网络（处理 vpn，dhcp，gateway）</li> 
      <li style="list-style-type:decimal;">调用 network api 的 migrate_instance_finish 方法</li> 
      <li style="list-style-type:decimal;">调用 libvirt driver 的&nbsp;post_live_migration_at_destination方法，它会调用 libvirt&nbsp;_conn.listDefinedDomains 方法查看迁移过来的主机的 domain是否存在；不存在的话，生成其 xml，然后调用 libvirt API &nbsp;_conn.defineXML(xml) 去定义该 domain。</li> 
      <li style="list-style-type:decimal;">将新的 domain 数据更新到数据库（包括新的 host，power_state，vm_state，node）</li> 
      <li style="list-style-type:decimal;">调用&nbsp;network api 的 setup_networks_on_host 方法 （不理解为什么重复上面第1步）</li> 
     </ol></li> 
    <li style="list-style-type:decimal;">调用 libvirt driver 的&nbsp;driver.cleanup 方法去&nbsp;_unplug_vifs （如果上面第四步失败，则再次尝试删除所有 vif 相关的 bridge 和 OVS 连接），firewall_driver.unfilter_instance （和上面第2步重复了），_disconnect_volume（断开 domain 和 所有 volume 的连接），_delete_instance_files （删除 domain 相关的文件），_undefine_domain （删除 domain）</li> 
    <li style="list-style-type:decimal;">调用&nbsp;network_api.setup_networks_on_host 去&nbsp;tear down networks on source host</li> 
    <li style="list-style-type:decimal;">至此，live migration 完全结束。</li> 
   </ol>
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">3.2.4 迁移过程中失败时的回滚</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;迁移的三个步骤中，前面第一个和第二个步骤中出现失败的话，会调用&nbsp;_rollback_live_migration 启动回滚操作。该方法</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）将虚机的状态由&nbsp;migrating 变为 running。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）调用&nbsp;network_api.setup_networks_on_host 方法重做源主机上的网络设置</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（3）通过 RPC 调用，去目的主机上将准备过程中建立的 volume 连接删除。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（4）通过 RPC 调用，去目的主机上调用&nbsp;compute_rpcapi.rollback_live_migration_at_destination 函数，该方法会</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）调用 network_api.setup_networks_on_host 方法去&nbsp;tear down networks on destination host</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）调用 libvirt driver 的&nbsp;driver.rollback_live_migration_at_destination 方法，它会将 domain 删除，并且清理它所使用的资源，包括 &nbsp;unplug vif，firewall_driver.unfilter_instance，_disconnect_volume，&nbsp;_delete_instance_files，&nbsp;_undefine_domain。</p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">3.2.5 测试</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">环境：准备两个虚机 vm1 和 vm2，操作系统为 cirros。打算将 vm1 迁移到另一个node 上。在 vm2 上查看 vm1 在迁移过程中的状态。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">迁移前：在 vm1 中运行 “ping vm2”，并在 vm2 中 ssh 连接到 vm1。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">结果：vm1 迁移过程中，vm2 上 ssh 的连接没有中断，vm1 中的 ping 命令继续执行。在另一次测试结果中，vm2 ping vm1 在整个迁移过程中 time 出现了一次 2ms 的时间增加。</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">3.3 遇到过的问题</h3> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">3.3.1&nbsp;apparmor</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">将虚机从 compute1 迁移到 compute2 成功，再从 compute2 迁移到 compute1 失败，报错如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>An error occurred trying to live migrate. Falling back to legacy live migrate flow. Error: unsupported configuration: Unable to find security driver <span style="color:rgb(0,0,255);line-height:1.5;">for</span> label apparmor</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">经比较迁移前后的虚机的 xml，发现 compute2 上的虚机的 xml 多了一项：&lt;seclabel type='none' model='apparmor'/&gt; 。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">分别在 compute 1 和 2 上运行 “virsh capabilities”，发现 compute1 没有使用&nbsp;apparmor，而 compute2 使用了 apparmor。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>#compute <span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;"> 上
    </span>&lt;secmodel&gt;
      &lt;model&gt;none&lt;/model&gt;
      &lt;doi&gt;<span style="color:rgb(128,0,128);line-height:1.5;">0</span>&lt;/doi&gt;
    &lt;/secmodel&gt;<span style="line-height:1.5;">

#compute2 上
</span>    &lt;secmodel&gt;
      &lt;model&gt;apparmor&lt;/model&gt;
      &lt;doi&gt;<span style="color:rgb(128,0,128);line-height:1.5;">0</span>&lt;/doi&gt;
    &lt;/secmodel&gt;</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp; 最简单的方法是在两个 node 上都 disable apparmor（在 /etc/libvirt/qemu.conf 中添加 ‘security_driver = “none” &nbsp;然后重启 libvirtd），然后 destroy/start 虚机后，它的 xml 配置中的 apparmor 就没有了。<a href="https://penguindroppings.wordpress.com/2009/11/03/apparmor-svirt-security-driver-for-libvirt/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这篇文章</a>&nbsp;详细介绍了 apparmor。</p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">3.3.2 当虚机是 boot from volume 时，live migration 失败。</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">报错：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>Command: iscsiadm -m node -T iqn.<span style="color:rgb(128,0,128);line-height:1.5;">2010</span>-<span style="color:rgb(128,0,128);line-height:1.5;">10</span>.org.openstack:volume-<span style="color:rgb(128,0,128);line-height:1.5;">26446902</span>-5a56-4c79-b839-a8e13a66dc7a -p <span style="color:rgb(128,0,128);line-height:1.5;">10.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">2.41</span>:<span style="color:rgb(128,0,128);line-height:1.5;">3260</span> --<span style="line-height:1.5;">rescan
Exit code: </span><span style="color:rgb(128,0,128);line-height:1.5;">21</span><span style="line-height:1.5;">
Stdout: u</span><span style="color:rgb(128,0,0);line-height:1.5;">''</span><span style="line-height:1.5;">
Stderr: u</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">iscsiadm: No session found.\n</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> to caller</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">原因是 cinder 代码中有 bug，导致目的主机无法建立和 volume 的连接。fix&nbsp;<a href="https://review.openstack.org/#/c/135405/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">在这里</a>。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><strong>参考文档：</strong></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">https://www.mirantis.com/blog/tutorial-openstack-live-migration-with-kvm-hypervisor-and-nfs-shared-storage/</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">http://www.sebastien-han.fr/blog/2015/01/06/openstack-configure-vm-migrate-nova-ssh/</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">KVM 原理技术 实战与原理解析 任永杰、单海涛著</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">OpenStack 官网</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><br></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><br></p> 
   <p style="line-height:1.5;"><font color="#4b4b4b"><span style="font-size:15px;">&nbsp; &nbsp; 本文转自SammyLiu博客园博客，原文链接：http://www.cnblogs.com/sammyliu/p/4572287.html</span></font><span style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">，如需转载请自行联系原作者</span></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
