<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>利用html 5 websocket做个山寨版web聊天室(手写C#服务器) « NotBeCN</title>
  <meta name="description" content="             在之前的博客中提到过看到html5 的websocket后很感兴趣，终于可以摆脱长轮询（websocket之前的实现方式可以看看Developer Works上的一篇文章，有简单提到，同时也说了websocket基本概念）等方式做一个山寨版的web聊天室。    什么是websocket...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/21/weixin_34198881_90122186.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">利用html 5 websocket做个山寨版web聊天室(手写C#服务器)</h1>
    <p class="post-meta">Nov 21, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">在<a href="http://www.cnblogs.com/dolphinX/p/3460545.html" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">之前的博客</a>中提到过看到html5 的websocket后很感兴趣，终于可以摆脱长轮询（websocket之前的实现方式可以看看<a href="http://www.ibm.com/developerworks/cn/web/1112_huangxa_websocket/" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">Developer Works上的一篇文章</a>，有简单提到，同时也说了websocket基本概念）等方式做一个山寨版的web聊天室。</p> 
   <h3 style="list-style-type:none;list-style-image:none;font-size:16px;line-height:1.5;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;">什么是websocket</h3> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;WebSocket 协议是html5引入的一种新的协议，其目的在于实现了浏览器与服务器全双工通信。看了上面链接的同学肯定对过去怎么低效率高消耗（轮询或comet）的做此事已经有所了解了，而在websocket API，浏览器和服务器只需要要做一个握手的动作，然后，浏览器和服务器之间就形成了一条快速通道。两者之间就直接可以数据互相传送。同时这么做有两个好处</p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">1.通信传输字节减少：比起以前使用http传输数据，websocket传输的额外信息很少，据百度说只有2k</p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">2.服务器可以主动向客户端推送消息，而不用客户端去查询</p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">关于概念和好处，网上到处都是，不再赘述，简单看看其原理，然后动手写一个web版聊天室吧</p> 
   <h3 style="list-style-type:none;list-style-image:none;font-size:16px;line-height:1.5;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;">握手</h3> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;除了TCP连接的三次握手，websocket协议中客户端与服务器想建立连接需要一次额外的握手动作，在最新版的协议中是这个样子的</p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">客户端向服务器发送请求</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(51,153,255);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="font-size:12px;line-height:1.5;">GET / HTTP/1.1
Upgrade: websocket
Connection: Upgrade
Host: 127.0.0.1:8080
Origin: http://test.com
Pragma: no-cache
Cache-Control: no-cache
Sec-WebSocket-Key: OtZtd55qBhJF2XLNDRgUMg==
Sec-WebSocket-Version: 13
Sec-WebSocket-Extensions: x-webkit-deflate-frame
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.57 Safari/537.36</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(51,153,255);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">服务器给出响应</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre><span style="font-size:12px;line-height:1.5;">HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: xsOSgr30aKL2GNZKNHKmeT1qYjA=</span></pre>
   </div> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;在请求中的“Sec-WebSocket-Key”是随机的，服务器端会用这些数据来构造出一个SHA-1的信息摘要。把“Sec-WebSocket-Key”加上一个魔幻字符串“258EAFA5-E914-47DA-95CA-C5AB0DC85B11”。使用 SHA-1 加密，之后进行 BASE-64编码，将结果做为 “Sec-WebSocket-Accept” 头的值，返回给客户端（来自<a href="http://zh.wikipedia.org/zh-cn/WebSocket" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">维基百科</a>）。</p> 
   <h3 style="list-style-type:none;list-style-image:none;font-size:16px;line-height:1.5;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;">websocket API</h3> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">经过握手之后浏览器与服务器建立连接，两者就可以互相通信了。websocket的API真心很简单，看看<a href="http://dev.w3.org/html5/websockets/" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">W3C</a>的定义</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(51,153,255);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>enum BinaryType { "blob", "arraybuffer"<span style="font-size:12px;line-height:1.5;"> };
[Constructor(DOMString url, optional (DOMString or DOMString[]) protocols)]
interface WebSocket : EventTarget {
  readonly attribute DOMString url;

  </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> ready state</span>
<span style="font-size:12px;line-height:1.5;">  const unsigned <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">short</span> CONNECTING = 0<span style="font-size:12px;line-height:1.5;">; const unsigned </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">short</span> OPEN = 1<span style="font-size:12px;line-height:1.5;">; const unsigned </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">short</span> CLOSING = 2<span style="font-size:12px;line-height:1.5;">; const unsigned </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">short</span> CLOSED = 3</span><span style="font-size:12px;line-height:1.5;"><span style="font-size:12px;line-height:1.5;">;</span>
  readonly attribute unsigned </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">short</span><span style="font-size:12px;line-height:1.5;"> readyState;
  readonly attribute unsigned </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">long</span><span style="font-size:12px;line-height:1.5;"> bufferedAmount;

  </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> networking</span>
<span style="font-size:12px;line-height:1.5;"><span style="font-size:12px;line-height:1.5;"> attribute EventHandler onopen; attribute EventHandler onerror; attribute EventHandler onclose;</span>
  readonly attribute DOMString extensions;
  readonly attribute DOMString protocol;
  </span><span style="font-size:12px;line-height:1.5;"><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> close([Clamp] optional unsigned <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">short</span></span><span style="font-size:12px;line-height:1.5;"><span style="font-size:12px;line-height:1.5;"> code, optional DOMString reason)</span>;

  </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> messaging</span>
<span style="font-size:12px;line-height:1.5;"><span style="font-size:12px;line-height:1.5;"> attribute EventHandler onmessage;</span>
           attribute BinaryType binaryType;
  </span><span style="font-size:12px;line-height:1.5;"><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span><span style="font-size:12px;line-height:1.5;"> send(DOMString data); </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span><span style="font-size:12px;line-height:1.5;"> send(Blob data); </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span><span style="font-size:12px;line-height:1.5;"> send(ArrayBuffer data); </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span></span><span style="font-size:12px;line-height:1.5;"><span style="font-size:12px;line-height:1.5;"> send(ArrayBufferView data);</span>
};</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(51,153,255);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;"><strong>创建websocket</strong></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>ws=<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> WebSocket(address); <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">ws://127.0.0.1:8080</span></pre>
   </div> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">调用其构造函数，传入地址，就可以创建一个websocket了，值得注意的是地址协议得是ws/wss</p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;"><strong>关闭socket</strong></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>ws.close();</pre>
   </div> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">调用webservice实例的close()方法就可以关闭webservice，当然也可以传入一个code和string说明为什么关了</p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;"><strong>几个回调函数句柄</strong></p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">由于其异步执行，回调函数自然少不了，有四个重要的</p> 
   <ul style="list-style:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style:disc inside;">onopen：连接创建后调用</li> 
    <li style="list-style:disc inside;">onmessage：接收到服务器消息后调用</li> 
    <li style="list-style:disc inside;">onerror：出错时调用</li> 
    <li style="list-style:disc inside;">onclose：关闭连接的时候调用</li> 
   </ul>
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">看名字就知道是干什么的了，每个回调函数都会传入一个Event对象，可以通过event.data访问消息</p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;"><strong>使用API</strong></p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">我们可以在创建socket成功后为其回调函数赋值</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(51,153,255);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>ws=<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> WebSocket(address);
            ws.onopen</span>=<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">function</span><span style="font-size:12px;line-height:1.5;">(e){
                </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">var</span> msg=document.createElement('div'<span style="font-size:12px;line-height:1.5;">);
                msg.style.color</span>='#0f0'<span style="font-size:12px;line-height:1.5;">;
                msg.innerHTML</span>="Server &gt; connection open."<span style="font-size:12px;line-height:1.5;">;
                msgContainer.appendChild(msg);
                ws.send(</span>'{&lt;'+document.getElementById('name').value+'&gt;}'<span style="font-size:12px;line-height:1.5;">);
            };</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(51,153,255);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;也可以通过事件绑定的方式</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(51,153,255);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>ws=<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> WebSocket(address);
            ws.addEventListener(</span>'open',<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">function</span><span style="font-size:12px;line-height:1.5;">(e){
                </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">var</span> msg=document.createElement('div'<span style="font-size:12px;line-height:1.5;">);
                msg.style.color</span>='#0f0'<span style="font-size:12px;line-height:1.5;">;
                msg.innerHTML</span>="Server &gt; connection open."<span style="font-size:12px;line-height:1.5;">;
                msgContainer.appendChild(msg);
                ws.send(</span>'{&lt;'+document.getElementById('name').value+'&gt;}'<span style="font-size:12px;line-height:1.5;">);
            });</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(51,153,255);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h3 style="list-style-type:none;list-style-image:none;font-size:16px;line-height:1.5;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;"><strong>&nbsp;客户端实现</strong></h3> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">其实客户端的实现比较简单，除了websocket相关的几句就是一些自动focus、回车键事件处理、消息框自动定位到底部等简单功能，不一一说明了</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <img class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" style="border:none;vertical-align:middle;">
    <span class="cnblogs_code_collapse" style="border-width:1px;border-style:solid;border-color:#808080;font-size:12px;line-height:1.5;">View Code</span> 
   </div> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <h3 style="list-style-type:none;list-style-image:none;font-size:16px;line-height:1.5;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;">服务器支持</h3> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;其实websocket的服务器实现网上可以找到很多了，向维基百科中列出的</p> 
   <ul style="list-style:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style:disc inside;">php -&nbsp;<a class="external free" href="http://code.google.com/p/phpwebsocket/" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">http://code.google.com/p/phpwebsocket/</a> </li> 
    <li style="list-style:disc inside;">jetty -&nbsp;<a class="external free" href="http://jetty.codehaus.org/jetty/" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">http://jetty.codehaus.org/jetty/</a>&nbsp;(版本7开始支持websocket)</li> 
    <li style="list-style:disc inside;">netty -&nbsp;<a class="external free" href="http://www.jboss.org/netty" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">http://www.jboss.org/netty</a> </li> 
    <li style="list-style:disc inside;">ruby -&nbsp;<a class="external free" href="http://github.com/gimite/web-socket-ruby" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">http://github.com/gimite/web-socket-ruby</a> </li> 
    <li style="list-style:disc inside;">Kaazing -&nbsp;<a class="external free" href="http://www.kaazing.org/confluence/display/KAAZING/Home" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">http://www.kaazing.org/confluence/display/KAAZING/Home</a> </li> 
    <li style="list-style:disc inside;">Tomcat -&nbsp;<a class="external free" href="http://tomcat.apache.org/" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">http://tomcat.apache.org/</a>&nbsp;(7.0.26支持websocket)</li> 
    <li style="list-style:disc inside;">WebLogic -&nbsp;<a class="external free" href="http://www.oracle.com/us/products/middleware/cloud-app-foundation/weblogic/overview/index.html" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">http://www.oracle.com/us/products/middleware/cloud-app-foundation/weblogic/overview/index.html</a>&nbsp;(12.1.2 开始支持)</li> 
    <li style="list-style:disc inside;">node.js -&nbsp;<a class="external free" href="https://github.com/Worlize/WebSocket-Node" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">https://github.com/Worlize/WebSocket-Node</a> </li> 
    <li style="list-style:disc inside;">node.js -&nbsp;<a class="external free" href="http://socket.io/" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">http://socket.io</a> </li> 
    <li style="list-style:disc inside;">nginx -&nbsp;<a class="external free" href="http://nginx.com/" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">http://nginx.com/</a> </li> 
    <li style="list-style:disc inside;">mojolicious -&nbsp;<a class="external free" href="http://mojolicio.us/" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">http://mojolicio.us/</a> </li> 
   </ul>
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;但是我希望加入一些自己特定的处理，比如用户名识别啊、广播啊什么的，所以自己实现了一个简单的C#版本</p> 
   <h3 style="list-style-type:none;list-style-image:none;font-size:16px;line-height:1.5;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;">websocket 聊天室C#服务器实现</h3> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">我上篇博客<a href="http://www.cnblogs.com/dolphinX/p/3462496.html" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">C# socket编程实践——支持广播的简单socket服务器</a>中介绍了怎么实现一个简单的C#广播服务器，在这上面扩展两个部分就能作为websocket服务器了</p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;"><strong>1.wecsocket握手处理</strong></p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;当服务器收到浏览器握手请求后，首先需要识别握手信息，我简单粗暴的使用了包含字符串处理，当然加入了是否握过手的判断</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(51,153,255);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>client.BeginReceive (buffer, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>, buffer.Length, SocketFlags.None, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> AsyncCallback (Recieve), client);
                </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">string</span> msg = Encoding.UTF8.GetString (buffer, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">, length);

                </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (!clientPool [client].IsHandShaked &amp;&amp; msg.Contains (<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Sec-WebSocket-Key</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">)) {
                    client.Send (PackageHandShakeData (buffer, length));
                    clientPool [client].IsHandShaked </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">true</span><span style="font-size:12px;line-height:1.5;">;
                    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;">;
                }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(51,153,255);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">识别成功后就可以生成服务器响应发送给客户端了</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(51,153,255);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">///</span> <span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">&lt;summary&gt;</span>
        <span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">///</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 打包服务器握手数据
        </span><span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">///</span> <span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">&lt;/summary&gt;</span>
        <span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">///</span> <span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">&lt;returns&gt;</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">The hand shake data.</span><span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">&lt;/returns&gt;</span>
        <span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">///</span> <span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">&lt;param name="handShakeBytes"&gt;</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">Hand shake bytes.</span><span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">&lt;/param&gt;</span>
        <span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">///</span> <span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">&lt;param name="length"&gt;</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">Length.</span><span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">&lt;/param&gt;</span>
        <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">byte</span>[] PackageHandShakeData (<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">byte</span>[] handShakeBytes, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> length)
        {
            </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">string</span> handShakeText = Encoding.UTF8.GetString (handShakeBytes, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">, length);
            </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">string</span> key = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">string</span><span style="font-size:12px;line-height:1.5;">.Empty;
            Regex reg </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> Regex (<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">@"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Sec\-WebSocket\-Key:(.*?)\r\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
            Match m </span>=<span style="font-size:12px;line-height:1.5;"> reg.Match (handShakeText);
            </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (m.Value != <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">""</span><span style="font-size:12px;line-height:1.5;">) {
                key </span>= Regex.Replace (m.Value, <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">@"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Sec\-WebSocket\-Key:(.*?)\r\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">$1</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">).Trim ();
            }

            </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">byte</span>[] secKeyBytes =<span style="font-size:12px;line-height:1.5;"> SHA1.Create ().ComputeHash (
                                     Encoding.ASCII.GetBytes (key </span>+ <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">258EAFA5-E914-47DA-95CA-C5AB0DC85B11</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">));
            </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">string</span> secKey =<span style="font-size:12px;line-height:1.5;"> Convert.ToBase64String (secKeyBytes);

            </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">var</span> responseBuilder = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> StringBuilder ();
            responseBuilder.Append (</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">HTTP/1.1 101 Switching Protocols</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span> + <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">\r\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
            responseBuilder.Append (</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Upgrade: websocket</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span> + <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">\r\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
            responseBuilder.Append (</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Connection: Upgrade</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span> + <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">\r\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
            responseBuilder.Append (</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Sec-WebSocket-Accept: </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span> + secKey + <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">\r\n\r\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);

            </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;"> Encoding.UTF8.GetBytes (responseBuilder.ToString ());
        }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="color:rgb(51,153,255);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;<strong>2.解析浏览器消息和处理发送给浏览器的消息</strong></p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;websocket中数据并不完全是消息本身，我们需要做一些处理</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <img class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" style="border:none;vertical-align:middle;">
    <span class="cnblogs_code_collapse" style="border-width:1px;border-style:solid;border-color:#808080;font-size:12px;line-height:1.5;">解析客户端发送来的数据</span> 
   </div> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <img class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" style="border:none;vertical-align:middle;">
    <span class="cnblogs_code_collapse" style="border-width:1px;border-style:solid;border-color:#808080;font-size:12px;line-height:1.5;">把发送给客户端消息打包处理</span> 
   </div> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">如果看不懂我在写什么，并且对C#版websocket感兴趣的同学需要看一下我上一篇博客了</p> 
   <h3 style="list-style-type:none;list-style-image:none;font-size:16px;line-height:1.5;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;">有图有真相</h3> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">看看我们写的聊天室运行效果吧</p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;服务器</p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images0.cnblogs.com/blog/349217/201312/07220216-b349f2cbff094d9f8fd4f914a574ac9e.png" alt="" width="717" height="525" style="border:none;">&nbsp;</p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;客户端——Byron</p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;<img src="https://images0.cnblogs.com/blog/349217/201312/07220316-9605c41cf7f742a189345f6bbb5b565c.png" alt="" style="border:none;"></p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">客户端——Casper</p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;<img src="https://images0.cnblogs.com/blog/349217/201312/07220405-f67d8bbaeaad4debb3452bcc626ef1e8.png" alt="" style="border:none;"></p> 
   <h3 style="list-style-type:none;list-style-image:none;font-size:16px;line-height:1.5;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;">源代码</h3> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;源代码我已经上传到了我的<a href="https://github.com/DolphinX/CSharpWebsocketDemo" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">github上</a>，对github不感冒的同学可以直接点击<a href="http://files.cnblogs.com/dolphinX/CSharpWebsocketDemo.zip" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">这里</a>下载，有兴趣的同学可以下载看看，因为我在Mac+mono+Xamarin Studio上开发的(忽然感觉自己好极品在Mac上用C#。。。)，所以代码编码和Windows可能会有些差距，改成Windows兼容的应该就可以直接运行了，不过没在Window下跑过，如果有错误还请大家多多指正。</p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;"><br></p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;"><br></p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;"><br></p> 
   <p style="list-style-type:none;list-style-image:none;"><font color="#444444"><span style="font-size:15px;">&nbsp; &nbsp; 本文转自魏琼东博客园博客，原文链接：http://www.cnblogs.com/dolphinX/p/3462898.html</span></font><span style="font-size:15px;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;">，如需转载请自行联系原作者</span></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
