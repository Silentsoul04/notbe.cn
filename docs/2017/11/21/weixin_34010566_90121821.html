<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Puppeteer: 更友好的 Headless Chrome Node API « NotBeCN</title>
  <meta name="description" content="             很早很早之前，前端就有了对 headless 浏览器的需求，最多的应用场景有两个        UI 自动化测试：摆脱手工浏览点击页面确认功能模式     爬虫：解决页面内容异步加载等问题       也就有了很多杰出的实现，前端经常使用的莫过于&nbsp;PhantomJS&nbsp;...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/21/weixin_34010566_90121821.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">Puppeteer: 更友好的 Headless Chrome Node API</h1>
    <p class="post-meta">Nov 21, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">很早很早之前，前端就有了对 headless 浏览器的需求，最多的应用场景有两个</p> 
   <ol style="list-style:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;list-style-image:none;">UI 自动化测试：摆脱手工浏览点击页面确认功能模式</li> 
    <li style="list-style-type:decimal;list-style-image:none;">爬虫：解决页面内容异步加载等问题</li> 
   </ol>
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">也就有了很多杰出的实现，前端经常使用的莫过于&nbsp;<a href="http://phantomjs.org/" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">PhantomJS</a>&nbsp;和&nbsp;<a href="http://seleniumhq.github.io/selenium/docs/api/javascript/" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">selenium-webdriver</a>，但两个库有一个共性——难用！环境安装复杂，API 调用不友好，1027 年 Chrome 团队连续放了两个大招&nbsp;<a href="https://chromium.googlesource.com/chromium/src/+/lkgr/headless/README.md" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">Headless Chrome</a>&nbsp;和对应的 NodeJS API&nbsp;<a href="https://github.com/GoogleChrome/puppeteer" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">Puppeteer</a>，直接让 PhantomJS 和 Selenium IDE for Firefox 作者悬宣布没必要继续维护其产品</p> 
   <h2 style="list-style-type:none;list-style-image:none;font-size:21px;line-height:1.5;border-bottom:1px solid rgb(221,221,221);color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;">Puppeteer</h2> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">如同其&nbsp;<a href="https://github.com/GoogleChrome/puppeteer" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">github</a>&nbsp;项目介绍：Puppeteer 是一个通过&nbsp;<a href="https://chromedevtools.github.io/devtools-protocol/" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">DevTools Protocol</a>&nbsp;控制 headless chrome 的 high-level Node 库，也可以通过设置使用 非 headless Chrome</p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">我们手工可以在浏览器上做的事情 Puppeteer 都能胜任</p> 
   <ol style="list-style:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;list-style-image:none;">生成网页截图或者 PDF</li> 
    <li style="list-style-type:decimal;list-style-image:none;">爬取大量异步渲染内容的网页，基本就是人肉爬虫</li> 
    <li style="list-style-type:decimal;list-style-image:none;">模拟键盘输入、表单自动提交、UI 自动化测试</li> 
   </ol>
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">官方提供了一个&nbsp;<a href="https://try-puppeteer.appspot.com/" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">playground</a>，可以快速体验一下。关于其具体使用不在赘述，官网的 demo 足矣让完全不了解的同学入门</p> 
   <div class="sourceCode" style="color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <pre><code class="language-javascript"><code class="sourceCode javascript hljs" style="font-family:'Courier New', sans-serif;line-height:1.5;vertical-align:middle;font-size:12px;background:rgb(255,255,255);border:1px solid rgb(204,204,204);color:rgb(0,0,0);"><span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">const</span></span> puppeteer <span class="op">=</span> <span class="at"><span class="hljs-built_in" style="color:rgb(0,0,255);">require</span></span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'puppeteer'</span></span>)<span class="op">;</span> (<span class="at"><span class="hljs-keyword" style="color:rgb(0,0,255);">async</span></span> () <span class="op">=&gt;</span> <span class="op">{</span> <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">const</span></span> browser <span class="op">=</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">puppeteer</span>.<span class="at">launch</span>()<span class="op">;</span> <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">const</span></span> page <span class="op">=</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">browser</span>.<span class="at">newPage</span>()<span class="op">;</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">page</span>.<span class="at">goto</span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'https://example.com'</span></span>)<span class="op">;</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">page</span>.<span class="at">screenshot</span>(<span class="op">{</span><span class="dt">path</span><span class="op">:</span> <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'example.png'</span></span><span class="op">}</span>)<span class="op">;</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">browser</span>.<span class="at">close</span>()<span class="op">;</span> <span class="op">}</span>)()<span class="op">;</span></code></code></pre>
   </div> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">实现网页截图就这么简单，自己也实现了一个简单的<a href="https://github.com/Samaritan89/headless-crawler/blob/master/src/mn.js" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">爬取百度图片的搜索结果的 demo</a>，代码不过 40 行，用过 selenium-webdriver 的同学看了会流泪，接下来介绍几个好玩的特性</p> 
   <h2 style="list-style-type:none;list-style-image:none;font-size:21px;line-height:1.5;border-bottom:1px solid rgb(221,221,221);color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;">哲学</h2> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">虽然 Puppeteer API 足够简单，但如果是从 webdriver 流转过来的同学会很不适应，主要是在 webdirver 中我们操作网页更多的是从程序的视角，而在 Puppeteer 中网页浏览者的视角。举个简单的例子，我们希望对一个表单的 input 做输入</p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">webdriver 流程</p> 
   <ol style="list-style:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;list-style-image:none;">通过选择器找到页面 input 元素</li> 
    <li style="list-style-type:decimal;list-style-image:none;">给元素设置值</li> 
   </ol>
   <div class="sourceCode" style="color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <pre><code class="language-javascript"><code class="sourceCode javascript hljs" style="font-family:'Courier New', sans-serif;line-height:1.5;vertical-align:middle;font-size:12px;background:rgb(255,255,255);border:1px solid rgb(204,204,204);color:rgb(0,0,0);"> <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">const</span></span> input <span class="op">=</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">driver</span>.<span class="at">findElement</span>(<span class="va">By</span>.<span class="at">id</span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'kw'</span></span>))<span class="op">;</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">input</span>.<span class="at">sendKeys</span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'test'</span></span>)<span class="op">;</span></code></code></pre>
   </div> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">Puppeteer 流程</p> 
   <ol style="list-style:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;list-style-image:none;">光标应该 focus 到元素上</li> 
    <li style="list-style-type:decimal;list-style-image:none;">键盘点击输入</li> 
   </ol>
   <div class="sourceCode" style="color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <pre><code class="language-javascript"><code class="sourceCode javascript hljs" style="font-family:'Courier New', sans-serif;line-height:1.5;vertical-align:middle;font-size:12px;background:rgb(255,255,255);border:1px solid rgb(204,204,204);color:rgb(0,0,0);"><span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">page</span>.<span class="at">focus</span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'#kw'</span></span>)<span class="op">;</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">page</span>.<span class="va">keyboard</span>.<span class="at">sendCharacter</span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'test'</span></span>)<span class="op">;</span></code></code></pre>
   </div> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">在使用中可以多感受一下区别，会发现 Puppeteer 的使用会自然很多</p> 
   <h2 style="list-style-type:none;list-style-image:none;font-size:21px;line-height:1.5;border-bottom:1px solid rgb(221,221,221);color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;">async/await</h2> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">看官方的例子就可以看出来，几乎所有的操作都是异步的，如果坚持使用回调或者 Promise.then 写出来的代码会非常丑陋且难读，Puppeteer 官方推荐的也是使用高版本 Node 用 async/await 语法</p> 
   <div class="sourceCode" style="color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <pre><code class="language-javascript"><code class="sourceCode javascript hljs" style="font-family:'Courier New', sans-serif;line-height:1.5;vertical-align:middle;font-size:12px;background:rgb(255,255,255);border:1px solid rgb(204,204,204);color:rgb(0,0,0);"><span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">const</span></span> puppeteer <span class="op">=</span> <span class="at"><span class="hljs-built_in" style="color:rgb(0,0,255);">require</span></span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'puppeteer'</span></span>)<span class="op">;</span> (<span class="at"><span class="hljs-keyword" style="color:rgb(0,0,255);">async</span></span> () <span class="op">=&gt;</span> <span class="op">{</span> <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">const</span></span> browser <span class="op">=</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">puppeteer</span>.<span class="at">launch</span>()<span class="op">;</span> <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">const</span></span> page <span class="op">=</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">browser</span>.<span class="at">newPage</span>()<span class="op">;</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">page</span>.<span class="at">goto</span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'https://news.ycombinator.com'</span></span><span class="op">,</span> <span class="op">{</span><span class="dt">waitUntil</span><span class="op">:</span> <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'networkidle'</span></span><span class="op">}</span>)<span class="op">;</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">page</span>.<span class="at">pdf</span>(<span class="op">{</span><span class="dt">path</span><span class="op">:</span> <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'hn.pdf'</span></span><span class="op">,</span> <span class="dt">format</span><span class="op">:</span> <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'A4'</span></span><span class="op">}</span>)<span class="op">;</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">browser</span>.<span class="at">close</span>()<span class="op">;</span> <span class="op">}</span>)()<span class="op">;</span></code></code></pre>
   </div> 
   <h2 style="list-style-type:none;list-style-image:none;font-size:21px;line-height:1.5;border-bottom:1px solid rgb(221,221,221);color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;">查找元素</h2> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">这是 UI 自动化测试最常用的功能了，Puppeteer 的处理也相当简单</p> 
   <ol style="list-style:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;list-style-image:none;">page.$(selector)</li> 
    <li style="list-style-type:decimal;list-style-image:none;">page.$$(selector)</li> 
   </ol>
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">这两个函数分别会在页面内执行&nbsp;<code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">document.querySelector</code>&nbsp;和&nbsp;<code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">document.querySelectorAll</code>，但返回值却不是 DOM 对象，如同 jQuery 的选择器，返回的是经过自己包装的&nbsp;<code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">Promise&lt;ElementHandle&gt;</code>，ElementHandle 帮我们封装了常用的&nbsp;<code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">click</code>&nbsp;、<code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">boundingBox</code>&nbsp;等方法</p> 
   <h2 style="list-style-type:none;list-style-image:none;font-size:21px;line-height:1.5;border-bottom:1px solid rgb(221,221,221);color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;">获取 DOM 属性</h2> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">我们写爬虫爬取页面图片列表，感觉可以通过&nbsp;<code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">page.$$(selector)</code>&nbsp;获取到页面的元素列表，然后再去转成 DOM 对象，获取 src，然后并不行，想做对获取元素对应 DOM 属性的获取，需要用专门的 API</p> 
   <ol style="list-style:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;list-style-image:none;">page.$eval(selector, pageFunction[, ...args])</li> 
    <li style="list-style-type:decimal;list-style-image:none;">page.$$eval(selector, pageFunction[, ...args])</li> 
   </ol>
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">大概用法</p> 
   <div class="sourceCode" style="color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <pre><code class="language-javascript"><code class="sourceCode javascript hljs" style="font-family:'Courier New', sans-serif;line-height:1.5;vertical-align:middle;font-size:12px;background:rgb(255,255,255);border:1px solid rgb(204,204,204);color:rgb(0,0,0);"><span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">const</span></span> searchValue <span class="op">=</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">page</span>.<span class="at">$<span class="hljs-built_in" style="color:rgb(0,0,255);">eval</span></span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'#search'</span></span><span class="op">,</span> el <span class="op">=&gt;</span> <span class="va">el</span>.<span class="at">value</span>)<span class="op">;</span> <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">const</span></span> preloadHref <span class="op">=</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">page</span>.<span class="at">$<span class="hljs-built_in" style="color:rgb(0,0,255);">eval</span></span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'link[rel=preload]'</span></span><span class="op">,</span> el <span class="op">=&gt;</span> <span class="va">el</span>.<span class="at">href</span>)<span class="op">;</span> <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">const</span></span> html <span class="op">=</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">page</span>.<span class="at">$<span class="hljs-built_in" style="color:rgb(0,0,255);">eval</span></span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'.main-container'</span></span><span class="op">,</span> e <span class="op">=&gt;</span> <span class="va">e</span>.<span class="at">outerHTML</span>)<span class="op">;</span></code></code></pre>
   </div> 
   <div class="sourceCode" style="color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <pre><code class="language-javascript"><code class="sourceCode javascript hljs" style="font-family:'Courier New', sans-serif;line-height:1.5;vertical-align:middle;font-size:12px;background:rgb(255,255,255);border:1px solid rgb(204,204,204);color:rgb(0,0,0);"><span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">const</span></span> divsCounts <span class="op">=</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">page</span>.<span class="at">$$<span class="hljs-built_in" style="color:rgb(0,0,255);">eval</span></span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'div'</span></span><span class="op">,</span> divs <span class="op">=&gt;</span> <span class="va">divs</span>.<span class="at">length</span>)<span class="op">;</span></code></code></pre>
   </div> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">值得注意的是如果&nbsp;<code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">pageFunction</code>&nbsp;返回的是 Promise，那么&nbsp;<code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">page.$eval</code>&nbsp;会等待方法 resolve</p> 
   <h2 style="list-style-type:none;list-style-image:none;font-size:21px;line-height:1.5;border-bottom:1px solid rgb(221,221,221);color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;">evaluate</h2> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">如果我们有一些及其个性的需求，无法通过 page.$() 或者 page.$eval() 实现，可以用大招——evaluate，有几个相关的 API</p> 
   <ol style="list-style:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;list-style-image:none;">page.evaluate(pageFunction, …args)</li> 
    <li style="list-style-type:decimal;list-style-image:none;">page.evaluateHandle(pageFunction, …args):</li> 
    <li style="list-style-type:decimal;list-style-image:none;">page.evaluateOnNewDocument(pageFunction, ...args)</li> 
   </ol>
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">这几个函数非常类似，都是可以在页面环境执行我们舒心的 JavaScript，区别主要在执行环境和返回值上</p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">前两个函数都是在当前页面环境内执行，的主要区别在返回值上，第一个返回一个&nbsp;<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify#Description" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">Serializable</a>&nbsp;的 Promise，第二个返回值是前面提到的 ElementHandle 对象父类型 JSHandle 的 Promise</p> 
   <div class="sourceCode" style="color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <pre><code class="language-javascript"><code class="sourceCode javascript hljs" style="font-family:'Courier New', sans-serif;line-height:1.5;vertical-align:middle;font-size:12px;background:rgb(255,255,255);border:1px solid rgb(204,204,204);color:rgb(0,0,0);"><span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">const</span></span> result <span class="op">=</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">page</span>.<span class="at">evaluate</span>(() <span class="op">=&gt;</span> <span class="op">{</span> <span class="cf"><span class="hljs-keyword" style="color:rgb(0,0,255);">return</span></span> <span class="va"><span class="hljs-built_in" style="color:rgb(0,0,255);">Promise</span></span>.<span class="at">resolve</span>(<span class="dv">8</span> <span class="op">*</span> <span class="dv">7</span>)<span class="op">;</span> <span class="op">}</span>)<span class="op">;</span> <span class="va"><span class="hljs-built_in" style="color:rgb(0,0,255);">console</span></span>.<span class="at">log</span>(result)<span class="op">;</span> <span class="co"><span class="hljs-comment" style="color:#008000;">// prints "56"</span></span> <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">const</span></span> aWindowHandle <span class="op">=</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">page</span>.<span class="at">evaluateHandle</span>(() <span class="op">=&gt;</span> <span class="va"><span class="hljs-built_in" style="color:rgb(0,0,255);">Promise</span></span>.<span class="at">resolve</span>(<span class="hljs-built_in" style="color:rgb(0,0,255);">window</span>))<span class="op">;</span> aWindowHandle<span class="op">;</span> <span class="co"><span class="hljs-comment" style="color:#008000;">// Handle for the window object. 相当于把返回对象做了一层包裹</span></span></code></code></pre>
   </div> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;"><code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">page.evaluateOnNewDocument(pageFunction, ...args)</code>&nbsp;是在 browser 环境中执行，执行时机是文档被创建完成但是 script 没有执行阶段，经常用于修改 JavaScript 环境</p> 
   <h2 style="list-style-type:none;list-style-image:none;font-size:21px;line-height:1.5;border-bottom:1px solid rgb(221,221,221);color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;">注册函数</h2> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;"><code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">page.exposeFunction(name, puppeteerFunction)</code>&nbsp;用于在 window 对象注册一个函数，我们可以添加一个&nbsp;<code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">window.readfile</code>&nbsp;函数</p> 
   <div class="sourceCode" style="color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <pre><code class="language-javascript"><code class="sourceCode javascript hljs" style="font-family:'Courier New', sans-serif;line-height:1.5;vertical-align:middle;font-size:12px;background:rgb(255,255,255);border:1px solid rgb(204,204,204);color:rgb(0,0,0);"><span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">const</span></span> puppeteer <span class="op">=</span> <span class="at"><span class="hljs-built_in" style="color:rgb(0,0,255);">require</span></span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'puppeteer'</span></span>)<span class="op">;</span> <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">const</span></span> fs <span class="op">=</span> <span class="at"><span class="hljs-built_in" style="color:rgb(0,0,255);">require</span></span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'fs'</span></span>)<span class="op">;</span> <span class="va">puppeteer</span>.<span class="at">launch</span>().<span class="at">then</span>(<span class="hljs-keyword" style="color:rgb(0,0,255);">async</span> browser <span class="op">=&gt;</span> <span class="op">{</span> <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">const</span></span> page <span class="op">=</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">browser</span>.<span class="at">newPage</span>()<span class="op">;</span> <span class="va">page</span>.<span class="at">on</span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'console'</span></span><span class="op">,</span> msg <span class="op">=&gt;</span> <span class="va"><span class="hljs-built_in" style="color:rgb(0,0,255);">console</span></span>.<span class="at">log</span>(<span class="va">msg</span>.<span class="at">text</span>))<span class="op">;</span> <span class="co"><span class="hljs-comment" style="color:#008000;">// 注册 window.readfile</span></span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">page</span>.<span class="at">exposeFunction</span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'readfile'</span></span><span class="op">,</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">async</span> filePath <span class="op">=&gt;</span> <span class="op">{</span> <span class="cf"><span class="hljs-keyword" style="color:rgb(0,0,255);">return</span></span> <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">new</span></span> <span class="at"><span class="hljs-built_in" style="color:rgb(0,0,255);">Promise</span></span>((resolve<span class="op">,</span> reject) <span class="op">=&gt;</span> <span class="op">{</span> <span class="va">fs</span>.<span class="at">readFile</span>(filePath<span class="op">,</span> <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'utf8'</span></span><span class="op">,</span> (err<span class="op">,</span> text) <span class="op">=&gt;</span> <span class="op">{</span> <span class="cf"><span class="hljs-keyword" style="color:rgb(0,0,255);">if</span></span> (err) <span class="at">reject</span>(err)<span class="op">;</span> <span class="cf"><span class="hljs-keyword" style="color:rgb(0,0,255);">else</span></span> <span class="at">resolve</span>(text)<span class="op">;</span> <span class="op">}</span>)<span class="op">;</span> <span class="op">}</span>)<span class="op">;</span> <span class="op">}</span>)<span class="op">;</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">page</span>.<span class="at">evaluate</span>(<span class="at"><span class="hljs-keyword" style="color:rgb(0,0,255);">async</span></span> () <span class="op">=&gt;</span> <span class="op">{</span> <span class="co"><span class="hljs-comment" style="color:#008000;">// use window.readfile to read contents of a file</span></span> <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">const</span></span> content <span class="op">=</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va"><span class="hljs-built_in" style="color:rgb(0,0,255);">window</span></span>.<span class="at">readfile</span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'/etc/hosts'</span></span>)<span class="op">;</span> <span class="va"><span class="hljs-built_in" style="color:rgb(0,0,255);">console</span></span>.<span class="at">log</span>(content)<span class="op">;</span> <span class="op">}</span>)<span class="op">;</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">browser</span>.<span class="at">close</span>()<span class="op">;</span> <span class="op">}</span>)<span class="op">;</span></code></code></pre>
   </div> 
   <h2 style="list-style-type:none;list-style-image:none;font-size:21px;line-height:1.5;border-bottom:1px solid rgb(221,221,221);color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;">修改终端</h2> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">Puppeteer 提供了几个有用的方法让我们可以修改设备信息</p> 
   <ol style="list-style:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;list-style-image:none;">page.setViewport(viewport)</li> 
    <li style="list-style-type:decimal;list-style-image:none;">page.setUserAgent(userAgent)</li> 
   </ol>
   <div class="sourceCode" style="color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <pre><code class="language-javascript"><code class="sourceCode javascript hljs" style="font-family:'Courier New', sans-serif;line-height:1.5;vertical-align:middle;font-size:12px;background:rgb(255,255,255);border:1px solid rgb(204,204,204);color:rgb(0,0,0);"><span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">page</span>.<span class="at">setViewport</span>(<span class="op">{</span> <span class="dt">width</span><span class="op">:</span> <span class="dv">1920</span><span class="op">,</span> <span class="dt">height</span><span class="op">:</span> <span class="dv">1080</span> <span class="op">}</span>)<span class="op">;</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">page</span>.<span class="at">setUserAgent</span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36'</span></span>)<span class="op">;</span></code></code></pre>
   </div> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">page.emulateMedia(mediaType)：可以用来修改页面访问的媒体类型，但仅仅支持</p> 
   <ol style="list-style:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;list-style-image:none;">screen</li> 
    <li style="list-style-type:decimal;list-style-image:none;">print</li> 
    <li style="list-style-type:decimal;list-style-image:none;">null：禁用 media emulation</li> 
   </ol>
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">page.emulate(options)：前面介绍的几个函数相当于这个函数的快捷方式，这个函数可以设置多个内容</p> 
   <ol style="list-style:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;list-style-image:none;">viewport</li> 
    <li style="list-style-type:decimal;list-style-image:none;">width</li> 
    <li style="list-style-type:decimal;list-style-image:none;">height</li> 
    <li style="list-style-type:decimal;list-style-image:none;">deviceScaleFactor</li> 
    <li style="list-style-type:decimal;list-style-image:none;">isMobile</li> 
    <li style="list-style-type:decimal;list-style-image:none;">hasTouch</li> 
    <li style="list-style-type:decimal;list-style-image:none;">isLandscape</li> 
    <li style="list-style-type:decimal;list-style-image:none;">userAgent</li> 
   </ol>
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;"><code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">puppeteer/DeviceDescriptors</code>&nbsp;还给我们提供了几个大礼包</p> 
   <div class="sourceCode" style="color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <pre><code class="language-javascript"><code class="sourceCode javascript hljs" style="font-family:'Courier New', sans-serif;line-height:1.5;vertical-align:middle;font-size:12px;background:rgb(255,255,255);border:1px solid rgb(204,204,204);color:rgb(0,0,0);"><span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">const</span></span> puppeteer <span class="op">=</span> <span class="at"><span class="hljs-built_in" style="color:rgb(0,0,255);">require</span></span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'puppeteer'</span></span>)<span class="op">;</span> <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">const</span></span> devices <span class="op">=</span> <span class="at"><span class="hljs-built_in" style="color:rgb(0,0,255);">require</span></span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'puppeteer/DeviceDescriptors'</span></span>)<span class="op">;</span> <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">const</span></span> iPhone <span class="op">=</span> devices[<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'iPhone 6'</span></span>]<span class="op">;</span> <span class="va">puppeteer</span>.<span class="at">launch</span>().<span class="at">then</span>(<span class="hljs-keyword" style="color:rgb(0,0,255);">async</span> browser <span class="op">=&gt;</span> <span class="op">{</span> <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">const</span></span> page <span class="op">=</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">browser</span>.<span class="at">newPage</span>()<span class="op">;</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">page</span>.<span class="at">emulate</span>(iPhone)<span class="op">;</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">page</span>.<span class="at">goto</span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'https://www.google.com'</span></span>)<span class="op">;</span> <span class="co"><span class="hljs-comment" style="color:#008000;">// other actions...</span></span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">browser</span>.<span class="at">close</span>()<span class="op">;</span> <span class="op">}</span>)<span class="op">;</span></code></code></pre>
   </div> 
   <h2 style="list-style-type:none;list-style-image:none;font-size:21px;line-height:1.5;border-bottom:1px solid rgb(221,221,221);color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;">键盘</h2> 
   <ol style="list-style:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;list-style-image:none;">keyboard.down</li> 
    <li style="list-style-type:decimal;list-style-image:none;">keyboard.up</li> 
    <li style="list-style-type:decimal;list-style-image:none;">keyboard.press</li> 
    <li style="list-style-type:decimal;list-style-image:none;">keyboard.type</li> 
    <li style="list-style-type:decimal;list-style-image:none;">keyboard.sendCharacter</li> 
   </ol>
   <div class="sourceCode" style="color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <pre><code class="language-javascript"><code class="sourceCode javascript hljs" style="font-family:'Courier New', sans-serif;line-height:1.5;vertical-align:middle;font-size:12px;background:rgb(255,255,255);border:1px solid rgb(204,204,204);color:rgb(0,0,0);"><span class="co"><span class="hljs-comment" style="color:#008000;">// 直接输入、按键</span></span> <span class="va">page</span>.<span class="va">keyboard</span>.<span class="at">type</span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'Hello World!'</span></span>)<span class="op">;</span> <span class="va">page</span>.<span class="va">keyboard</span>.<span class="at">press</span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'ArrowLeft'</span></span>)<span class="op">;</span> <span class="co"><span class="hljs-comment" style="color:#008000;">// 按住不放</span></span> <span class="va">page</span>.<span class="va">keyboard</span>.<span class="at">down</span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'Shift'</span></span>)<span class="op">;</span> <span class="cf"><span class="hljs-keyword" style="color:rgb(0,0,255);">for</span></span> (<span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">let</span></span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">' World'</span></span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="va">page</span>.<span class="va">keyboard</span>.<span class="at">press</span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'ArrowLeft'</span></span>)<span class="op">;</span> <span class="va">page</span>.<span class="va">keyboard</span>.<span class="at">up</span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'Shift'</span></span>)<span class="op">;</span> <span class="va">page</span>.<span class="va">keyboard</span>.<span class="at">press</span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'Backspace'</span></span>)<span class="op">;</span> <span class="va">page</span>.<span class="va">keyboard</span>.<span class="at">sendCharacter</span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'嗨'</span></span>)<span class="op">;</span></code></code></pre>
   </div> 
   <h2 style="list-style-type:none;list-style-image:none;font-size:21px;line-height:1.5;border-bottom:1px solid rgb(221,221,221);color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;">鼠标 &amp; 屏幕</h2> 
   <ol style="list-style:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;list-style-image:none;">mouse.click(x, y, [options]): options 可以设置</li> 
    <li style="list-style-type:decimal;list-style-image:none;">button</li> 
    <li style="list-style-type:decimal;list-style-image:none;">clickCount</li> 
    <li style="list-style-type:decimal;list-style-image:none;">mouse.move(x, y, [options]): options 可以设置</li> 
    <li style="list-style-type:decimal;list-style-image:none;">steps</li> 
    <li style="list-style-type:decimal;list-style-image:none;">mouse.down([options])</li> 
    <li style="list-style-type:decimal;list-style-image:none;">mouse.up([options])</li> 
    <li style="list-style-type:decimal;list-style-image:none;">touchscreen.tap(x, y)</li> 
   </ol>
   <h2 style="list-style-type:none;list-style-image:none;font-size:21px;line-height:1.5;border-bottom:1px solid rgb(221,221,221);color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;">页面跳转控制</h2> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">这几个 API 比较简单，不在展开介绍</p> 
   <ol style="list-style:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;list-style-image:none;">page.goto(url, options)</li> 
    <li style="list-style-type:decimal;list-style-image:none;">page.goback(options)</li> 
    <li style="list-style-type:decimal;list-style-image:none;">page.goForward(options)</li> 
   </ol>
   <h2 style="list-style-type:none;list-style-image:none;font-size:21px;line-height:1.5;border-bottom:1px solid rgb(221,221,221);color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;">事件</h2> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">Puppeteer 提供了对一些页面常见事件的监听，用法和 jQuery 很类似，常用的有</p> 
   <ol style="list-style:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;list-style-image:none;">console：调用 console API</li> 
    <li style="list-style-type:decimal;list-style-image:none;">dialog：页面出现弹窗</li> 
    <li style="list-style-type:decimal;list-style-image:none;">error：页面 crash</li> 
    <li style="list-style-type:decimal;list-style-image:none;">load</li> 
    <li style="list-style-type:decimal;list-style-image:none;">pageerror：页面内未捕获错误</li> 
   </ol>
   <div class="sourceCode" style="color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <pre><code class="language-javascript"><code class="sourceCode javascript hljs" style="font-family:'Courier New', sans-serif;line-height:1.5;vertical-align:middle;font-size:12px;background:rgb(255,255,255);border:1px solid rgb(204,204,204);color:rgb(0,0,0);"><span class="va">page</span>.<span class="at">on</span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'load'</span></span><span class="op">,</span> <span class="at"><span class="hljs-keyword" style="color:rgb(0,0,255);">async</span></span> () <span class="op">=&gt;</span> <span class="op">{</span> <span class="va"><span class="hljs-built_in" style="color:rgb(0,0,255);">console</span></span>.<span class="at">log</span>(<span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'page loading done, start fetch...'</span></span>)<span class="op">;</span> <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">const</span></span> srcs <span class="op">=</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">page</span>.<span class="at">$$<span class="hljs-built_in" style="color:rgb(0,0,255);">eval</span></span>((img) <span class="op">=&gt;</span> <span class="va">img</span>.<span class="at">src</span>)<span class="op">;</span> <span class="va"><span class="hljs-built_in" style="color:rgb(0,0,255);">console</span></span>.<span class="at">log</span>(<span class="vs"><span class="hljs-string" style="color:rgb(163,21,21);">`get </span></span><span class="sc"><span class="hljs-string" style="color:rgb(163,21,21);">${</span></span><span class="va"><span class="hljs-string" style="color:rgb(163,21,21);">srcs</span></span><span class="hljs-string" style="color:rgb(163,21,21);">.</span><span class="at"><span class="hljs-string" style="color:rgb(163,21,21);">length</span></span><span class="sc"><span class="hljs-string" style="color:rgb(163,21,21);">}</span></span><span class="vs"><span class="hljs-string" style="color:rgb(163,21,21);"> images, start download`</span></span>)<span class="op">;</span> <span class="va">srcs</span>.<span class="at">forEach</span>(<span class="at"><span class="hljs-keyword" style="color:rgb(0,0,255);">async</span></span> (src) <span class="op">=&gt;</span> <span class="op">{</span> <span class="co"><span class="hljs-comment" style="color:#008000;">// sleep</span></span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">page</span>.<span class="at">waitFor</span>(<span class="dv">200</span>)<span class="op">;</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="at">srcToImg</span>(src<span class="op">,</span> mn)<span class="op">;</span> <span class="op">}</span>)<span class="op">;</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> <span class="va">browser</span>.<span class="at">close</span>()<span class="op">;</span> <span class="op">}</span>)<span class="op">;</span></code></code></pre>
   </div> 
   <h2 style="list-style-type:none;list-style-image:none;font-size:21px;line-height:1.5;border-bottom:1px solid rgb(221,221,221);color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;">性能</h2> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">通过&nbsp;<code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">page.getMetrics()</code>&nbsp;可以得到一些页面性能数据</p> 
   <ul style="list-style:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style:disc inside;"> <code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">Timestamp</code>&nbsp;The timestamp when the metrics sample was taken.</li> 
    <li style="list-style:disc inside;"> <code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">Documents</code>&nbsp;页面文档数</li> 
    <li style="list-style:disc inside;"> <code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">Frames</code>&nbsp;页面 frame 数</li> 
    <li style="list-style:disc inside;"> <code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">JSEventListeners</code>&nbsp;页面内事件监听器数</li> 
    <li style="list-style:disc inside;"> <code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">Nodes</code>&nbsp;页面 DOM 节点数</li> 
    <li style="list-style:disc inside;"> <code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">LayoutCount</code>&nbsp;页面 layout 数</li> 
    <li style="list-style:disc inside;"> <code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">RecalcStyleCount</code>&nbsp;样式重算数</li> 
    <li style="list-style:disc inside;"> <code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">LayoutDuration</code>&nbsp;页面 layout 时间</li> 
    <li style="list-style:disc inside;"> <code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">RecalcStyleDuration</code>&nbsp;样式重算时长</li> 
    <li style="list-style:disc inside;"> <code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">ScriptDuration</code>&nbsp;script 时间</li> 
    <li style="list-style:disc inside;"> <code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">TaskDuration</code>&nbsp;所有浏览器任务时长</li> 
    <li style="list-style:disc inside;"> <code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">JSHeapUsedSize</code>&nbsp;JavaScript 占用堆大小</li> 
    <li style="list-style:disc inside;"> <code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">JSHeapTotalSize</code>&nbsp;JavaScript 堆总量</li> 
   </ul>
   <div class="sourceCode" style="color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">
    <pre><code class="language-javascript"><code class="sourceCode javascript hljs" style="font-family:'Courier New', sans-serif;line-height:1.5;vertical-align:middle;font-size:12px;background:rgb(255,255,255);border:1px solid rgb(204,204,204);color:rgb(0,0,0);"><span class="op">{</span> <span class="dt">Timestamp</span><span class="op">:</span> <span class="fl">382305.912236</span><span class="op">,</span> <span class="dt">Documents</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span> <span class="dt">Frames</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">JSEventListeners</span><span class="op">:</span> <span class="dv">129</span><span class="op">,</span> <span class="dt">Nodes</span><span class="op">:</span> <span class="dv">8810</span><span class="op">,</span> <span class="dt">LayoutCount</span><span class="op">:</span> <span class="dv">38</span><span class="op">,</span> <span class="dt">RecalcStyleCount</span><span class="op">:</span> <span class="dv">56</span><span class="op">,</span> <span class="dt">LayoutDuration</span><span class="op">:</span> <span class="fl">0.596341000346001</span><span class="op">,</span> <span class="dt">RecalcStyleDuration</span><span class="op">:</span> <span class="fl">0.180430999898817</span><span class="op">,</span> <span class="dt">ScriptDuration</span><span class="op">:</span> <span class="fl">1.24401400075294</span><span class="op">,</span> <span class="dt">TaskDuration</span><span class="op">:</span> <span class="fl">2.21657899935963</span><span class="op">,</span> <span class="dt">JSHeapUsedSize</span><span class="op">:</span> <span class="dv">15430816</span><span class="op">,</span> <span class="dt">JSHeapTotalSize</span><span class="op">:</span> <span class="dv">23449600</span> <span class="op">}</span></code></code></pre>
   </div> 
   <h2 style="list-style-type:none;list-style-image:none;font-size:21px;line-height:1.5;border-bottom:1px solid rgb(221,221,221);color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;">最后</h2> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">本文知识介绍了部分常用的 API，全部的 API 可以在&nbsp;<a href="https://github.com/GoogleChrome/puppeteer/blob/master/docs/api.md#" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">github</a>&nbsp;上查看，由于 Puppeteer 还没有发布正式版，API 迭代比较迅速，在使用中遇到问题也可以在 issue 中反馈。</p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;">在 0.11 版本中只有&nbsp;<code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">page.$eval</code>&nbsp;并没有&nbsp;<code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">page.$$eval</code>，使用的时候只能通过&nbsp;<code style="font-family:'Courier New', sans-serif;line-height:1.8;vertical-align:middle;font-size:12px;border:1px solid rgb(204,204,204);">page.evaluate</code>，通过大家的反馈，在 0.12 中已经添加了该功能，总体而言 Puppeteer 还是一个十分值得期待的 Node headless API</p> 
   <h2 style="list-style-type:none;list-style-image:none;font-size:21px;line-height:1.5;border-bottom:1px solid rgb(221,221,221);color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;">参考</h2> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;"><a href="https://developers.google.com/web/updates/2017/04/headless-chrome" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">Getting Started with Headless Chrome</a></p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;"><a href="https://juejin.im/post/59e5a86c51882578bf185dba" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">无头浏览器 Puppeteer 初探</a></p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;"><a href="https://github.com/emadehsan/thal" rel="nofollow" style="text-decoration:none;color:rgb(51,153,255);">Getting started with Puppeteer and Chrome Headless for Web Scraping</a></p> 
   <p style="list-style-type:none;list-style-image:none;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:15px;"><br></p> 
   <p style="list-style-type:none;list-style-image:none;"><font color="#444444"><span style="font-size:15px;">&nbsp; &nbsp; 本文转自魏琼东博客园博客，原文链接：http://www.cnblogs.com/dolphinX/p/7715268.html</span></font><span style="font-size:15px;color:rgb(68,68,68);font-family:Tahoma, Arial, Helvetica, sans-serif;">，如需转载请自行联系原作者</span></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
