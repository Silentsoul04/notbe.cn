<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Linux下hp打印机驱动hplip分析 « NotBeCN</title>
  <meta name="description" content="             Hplip分析    &nbsp; &nbsp; &nbsp; &nbsp; 版本号是2.14,源代码位置:http://hplipopensource.com。    图的来源：http://hplipopensource.com/node/128。    实践中使用的打印机型号:De...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/21/weixin_34128534_90127286.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">Linux下hp打印机驱动hplip分析</h1>
    <p class="post-meta">Nov 21, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;text-align:center;"><strong>Hplip<span style="line-height:1.8;font-family:'宋体';">分析</span></strong></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp; &nbsp; &nbsp; &nbsp; 版本号是<span style="line-height:1.8;font-family:'Times New Roman';">2.14,</span><span style="line-height:1.8;font-family:'宋体';">源代码位置</span><span style="line-height:1.8;font-family:'Times New Roman';">:</span><a href="http://hplipopensource.com/" rel="nofollow" style="color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);"><span style="line-height:1.8;color:rgb(0,0,255);">http://hplipopensource.com</span></a>。</p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">图的来源：<a href="http://hplipopensource.com/node/128" rel="nofollow" style="color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);"><span style="line-height:1.8;color:rgb(0,0,255);">http://hplipopensource.com/node/128</span></a>。</p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">实践中使用的打印机型号:Deskjet 1010.分析的目的就是搞清楚一个灰色地带---打印机通信.</p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;text-align:center;"><img src="https://uzshare.com/_p?https://img-blog.csdn.net/20140531134348359?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQva2FuZ2Vhcg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" style="border:0px;"><br></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"></p> 
   <h3 style="font-size:16px;line-height:1.5;font-family:verdana, Arial, Helvetica, sans-serif;">1.D-Bus<span style="line-height:1.8;font-family:'宋体';">初始化流程</span> </h3> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">D-Bus<span style="line-height:1.8;font-family:'宋体';">的初始化相同是在</span>ui4/devmgr5.py開始的。</p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong><em>ui4/devmgr5.py</em></strong></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">01&nbsp;class&nbsp;DevMgr5(QMainWindow,&nbsp;&nbsp;Ui_MainWindow):</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">02&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;TODO:&nbsp;Make&nbsp;sbus&nbsp;init&nbsp;mandatory&nbsp;success,&nbsp;else&nbsp;exit</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">04&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;initDBus(self):</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">05&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.dbus_loop&nbsp;=&nbsp;DBusQtMainLoop(set_as_default=True)</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">06&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.dbus_avail,&nbsp;self.service,&nbsp;self.session_bus&nbsp;=&nbsp;device.init_dbus(self.dbus_loop)</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">07&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">08&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Receive&nbsp;events&nbsp;from&nbsp;the&nbsp;session&nbsp;bus</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">09&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.session_bus.add_signal_receiver(self.handleSessionSignal,&nbsp;sender_keyword='sender',</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;destination_keyword='dest',&nbsp;interface_keyword='interface',</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">11&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;member_keyword='member',&nbsp;path_keyword='path')</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">这里调用了<span style="line-height:1.8;font-family:Arial;">base/device.py</span><span style="line-height:1.8;font-family:'宋体';">中的</span><span style="line-height:1.8;font-family:Arial;">init_dbus()</span><span style="line-height:1.8;font-family:'宋体';">。从第</span><span style="line-height:1.8;font-family:Arial;">9</span><span style="line-height:1.8;font-family:'宋体';">行能够看出</span><span style="line-height:1.8;font-family:Arial;">handleSessionSignal</span><span style="line-height:1.8;font-family:'宋体';">是</span><span style="line-height:1.8;font-family:Arial;">D-</span>Bus<span style="line-height:1.8;font-family:'宋体';">server端回调函数。</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong><em><span style="line-height:1.8;font-family:Arial;">base/device.py</span></em></strong></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">01&nbsp;#</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">02&nbsp;#&nbsp;DBus&nbsp;Support</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">03&nbsp;#</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">04&nbsp;</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">05&nbsp;def&nbsp;init_dbus(dbus_loop=None):</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">06&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">07&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">08&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;dbus_loop&nbsp;is&nbsp;None:</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">09&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;session_bus&nbsp;=&nbsp;dbus.SessionBus()</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">11&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;session_bus&nbsp;=&nbsp;dbus.SessionBus(dbus_loop)</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.debug("Connecting&nbsp;to&nbsp;com.hplip.StatusService&nbsp;(try&nbsp;#1)...")</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;service&nbsp;=&nbsp;session_bus.get_object('com.hplip.StatusService',&nbsp;"/com/hplip/StatusService")</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dbus_avail&nbsp;=&nbsp;True</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">17&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;dbus.exceptions.DBusException,&nbsp;e:</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">18&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">19&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;os.waitpid(-1,&nbsp;os.WNOHANG)</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">20&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;OSError:</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">21&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">22&nbsp;</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">23&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path&nbsp;=&nbsp;utils.which('hp-systray')</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">24&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.debug("Running&nbsp;hp-systray:&nbsp;%s&nbsp;--force-startup"&nbsp;%&nbsp;path)</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">26&nbsp;</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">27&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;os.spawnlp(os.P_NOWAIT,&nbsp;path,&nbsp;'hp-systray',&nbsp;'--force-startup')</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">28&nbsp;</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">29&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.debug("Waiting&nbsp;for&nbsp;hp-systray&nbsp;to&nbsp;start...")</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;time.sleep(1)</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">31&nbsp;</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t&nbsp;=&nbsp;2</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">33&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;True:</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">34&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">35&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.debug("Connecting&nbsp;to&nbsp;com.hplip.StatusService&nbsp;(try&nbsp;#%d)..."&nbsp;%&nbsp;t)</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">36&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;service&nbsp;=&nbsp;session_bus.get_object('com.hplip.StatusService',&nbsp;"/com/hplip/StatusService")</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">37&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">38&nbsp;</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">39&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;dbus_avail,&nbsp;service,&nbsp;&nbsp;session_bus</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">40&nbsp;</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">41&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">42&nbsp;</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">第<span style="line-height:1.8;font-family:Arial;">27</span><span style="line-height:1.8;font-family:'宋体';">行启动了</span><span style="line-height:1.8;font-family:Arial;">hp-systray</span><span style="line-height:1.8;font-family:'宋体';">作为</span><span style="line-height:1.8;font-family:Arial;">d-bus</span><span style="line-height:1.8;font-family:'宋体';">的server端。</span>D-bus<span style="line-height:1.8;font-family:'宋体';">server端启动完成。</span></p> 
   <h3 style="font-size:16px;line-height:1.5;font-family:verdana, Arial, Helvetica, sans-serif;">2.D-bus<span style="line-height:1.8;font-family:'宋体';">server</span><span style="line-height:1.8;font-family:'Times New Roman';">hp-systray</span><span style="line-height:1.8;font-family:'宋体';">端启动</span> </h3> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">启动命令例如以下：</p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">$&nbsp;hp-systray&nbsp;--force-startup&nbsp;-g</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">说明:-g是调试模式启动</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"></p> 
   <pre><code class="language-python">if __name__ == '__main__':
    ......
    if child_pid1:
        # parent (UI)
        os.close(w1)
        ......                
        else: # qt4
            try:
                import ui4.systemtray as systray
            except ImportError:
                log.error("Unable to load Qt4 support. Is it installed?
</code></pre> 
   <p></p> 
   <p>") mod.unlockInstance() sys.exit(1) try: systray.run(r1) finally: mod.unlockInstance() else: # child (dbus &amp; device i/o [qt4] or dbus [qt3]) os.close(r1) if ui_toolkit == 'qt4': r2, w2 = os.pipe() r3, w3 = os.pipe() child_pid2 = os.fork() if child_pid2: # parent (dbus) os.close(r2) import hpssd hpssd.run(w1, w2, r3) else: # child (device i/o) os.close(w2) import hpdio hpdio.run(r2, w3) ......</p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">启动了<span style="line-height:1.8;font-family:'Times New Roman';">hpssd</span><span style="line-height:1.8;font-family:'宋体';">和</span><span style="line-height:1.8;font-family:'Times New Roman';">hpdio</span><span style="line-height:1.8;font-family:'宋体';">。</span><span style="line-height:1.8;font-family:'Times New Roman';">hpssd</span><span style="line-height:1.8;font-family:'宋体';">前者会从</span><span style="line-height:1.8;font-family:'Times New Roman';">w3</span><span style="line-height:1.8;font-family:'宋体';">管道从读取</span><span style="line-height:1.8;font-family:'Times New Roman';">hpdio</span><span style="line-height:1.8;font-family:'宋体';">写入的打印机状态信息。</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">以下单说<span style="line-height:1.8;font-family:'Times New Roman';">hpdio</span><span style="line-height:1.8;font-family:'宋体';">怎样获取打印机状态当</span><span style="line-height:1.8;font-family:'Times New Roman';">hpdio&nbsp;run</span><span style="line-height:1.8;font-family:'宋体';">起来的时候会做以下调用</span><span style="line-height:1.8;font-family:'Times New Roman';">r</span>un(hpdio.py)-&gt;queryDevice(device.py)-&gt;status.StatusType10(status.py)-&gt;StatusType10Status(status.py)<span style="line-height:1.8;font-family:'宋体';">来获取打印机状态。</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'宋体';">&nbsp; &nbsp; 在queryDevice这个函数中出现了6种与打印机通信方式,各自是:</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"></p> 
   <ol style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style:decimal;"><span style="line-height:1.8;font-family:'宋体';">Type 1/2 (s: or VSTATUS:) status</span></li> 
    <li style="list-style:decimal;"><span style="line-height:1.8;font-family:'宋体';">Type 3/9 LaserJet PML</span></li> 
    <li style="list-style:decimal;"><span style="line-height:1.8;font-family:'宋体';">Type 6: LJ XML</span></li> 
    <li style="list-style:decimal;"><span style="line-height:1.8;font-family:'宋体';">Type 8: LJ PJL</span></li> 
    <li style="list-style:decimal;"><span style="line-height:1.8;font-family:'宋体';">Type 10: LEDM</span></li> 
    <li style="list-style:decimal;"><span style="line-height:1.8;font-family:'宋体';">Type 11: LEDM_FF_CC_0</span></li> 
   </ol>
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">而我眼下分析的这款打印机使用是第5种<strong>Type 10: LEDM通信协议&nbsp;</strong>HPMUD_S_EWS_LEDM_CHANNEL<span style="line-height:1.8;font-family:'宋体';">。每种通信通信都有关于打印机状态值的定义,另外从这款打印机的DeviceId能够看出应该同一时候也是支持PJL的,这里先仅仅说第5种LEDM通信方式.LEDM的大体通信方式是基于HTTP,通信USB传输一个HTTP的GET指令,然后再通过USB读取打印机返回的HTTP超文本,一个是XML.</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'宋体';">StatusType10Status调用流程：<br></span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"></p> 
   <ol style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style:decimal;"><span style="line-height:1.8;font-family:'宋体';">StatusType10FetchUrl &nbsp;从打印机获取状态数据</span></li> 
    <li style="list-style:decimal;"><span style="line-height:1.8;font-family:'宋体';"># Parse the product status XML 解析xml，提取状态值</span></li> 
   </ol>
   <div style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <span style="line-height:1.8;font-family:'宋体';"><span style="line-height:1.8;">StatusType10FetchUrl调用流程：</span><br></span>
   </div> 
   <div style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"> 
    <ol>
     <li style="list-style:decimal;"><span style="line-height:1.8;font-family:'宋体';">getUrl_LEDM</span></li> 
     <li style="list-style:decimal;"><span style="line-height:1.8;font-family:'宋体';">LocalOpenerEWS_LEDM().openhp()</span></li> 
    </ol>
    <div>
     <span style="line-height:1.8;font-family:'宋体';"><span style="line-height:1.8;">openhp调用流程：（进入LEDM处理流程）</span><br></span>
    </div> 
   </div> 
   <div style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"> 
    <ol>
     <li style="list-style:decimal;">writeEWS_LEDM</li> 
     <li style="list-style:decimal;">readEWS_LEDM</li> 
     <li style="list-style:decimal;">readLEDMData</li> 
    </ol>
   </div> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"></p> 
   <h3 style="font-size:16px;line-height:1.5;font-family:'宋体';">3.刷新状态的流程</h3> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong><em><span style="line-height:1.8;font-family:Arial;">toolbox.py</span></em></strong></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">01&nbsp;else:&nbsp;#&nbsp;qt4</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">02&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;ui4.devmgr5&nbsp;import&nbsp;DevMgr5</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">04&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......</span></p> 
   <p style="color:rgb(51,51,51);font-size:14px;font-family:'宋体';">第三行能够看出启动了ui4<span style="line-height:1.8;font-family:'方正书宋_GBK';">文件夹下的</span><span style="line-height:1.8;font-family:Arial;">devmgr5</span><span style="line-height:1.8;font-family:'方正书宋_GBK';">这个</span><span style="line-height:1.8;font-family:Arial;">python</span><span style="line-height:1.8;font-family:'方正书宋_GBK';">。</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:Arial;"><strong><em>ui4/devmgr5.py</em></strong></span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">01&nbsp;class&nbsp;DevMgr5(QMainWindow,&nbsp;&nbsp;Ui_MainWindow):</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">02&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;initUI(self):</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">04&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">05&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.DeviceRefreshAction.setIcon(QIcon(load_pixmap("refresh1",&nbsp;"16x16")))</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">06&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.connect(self.DeviceRefreshAction,&nbsp;SIGNAL("triggered()"),&nbsp;self.DeviceRefreshAction_activated)</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">07&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">08&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;DeviceRefreshAction_activated(self):</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">09&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.DeviceRefreshAction.setEnabled(False)</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.requestDeviceUpdate()</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">11&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.DeviceRefreshAction.setEnabled(True)</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">13&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;requestDeviceUpdate(self,&nbsp;dev=None,&nbsp;item=None):</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"""&nbsp;Submit&nbsp;device&nbsp;update&nbsp;request&nbsp;to&nbsp;update&nbsp;thread.&nbsp;"""</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">15</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;dev&nbsp;is&nbsp;None:</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">17&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dev&nbsp;=&nbsp;self.cur_device</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">18</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">19&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;dev&nbsp;is&nbsp;not&nbsp;None:</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">20&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dev.error_state&nbsp;=&nbsp;ERROR_STATE_REFRESHING</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">21&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.updateDevice(dev,&nbsp;update_tab=False)</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">22</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">23&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.sendMessage(dev.device_uri,&nbsp;'',&nbsp;EVENT_DEVICE_UPDATE_REQUESTED)</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">24&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;sendMessage(self,&nbsp;device_uri,&nbsp;printer_name,&nbsp;event_code,&nbsp;username=prop.username,</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">26&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;job_id=0,&nbsp;title=''):</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">27&nbsp;</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">28&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;device.Event(device_uri,&nbsp;printer_name,&nbsp;event_code,&nbsp;username,</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">29&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;job_id,&nbsp;title).send_via_dbus(self.session_bus)</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.....</span></p> 
   <p style="color:rgb(51,51,51);font-size:14px;font-family:'宋体';">从第<span style="line-height:1.8;font-family:Arial;">06</span><span style="line-height:1.8;">行能够看出</span><span style="line-height:1.8;font-family:Arial;">DeviceRefreshAction</span><span style="line-height:1.8;">的槽是</span><span style="line-height:1.8;font-family:Arial;">DeviceRefreshAction_activated</span><span style="line-height:1.8;">在行</span><span style="line-height:1.8;font-family:Arial;">8</span><span style="line-height:1.8;">行，接着调用了</span>requestDeviceUpdate<span style="line-height:1.8;">。然后调用了</span>sendMessage。然后调用了device.Event<span style="line-height:1.8;">。这个在</span><span style="line-height:1.8;font-family:Arial;">device.py</span><span style="line-height:1.8;">中。在</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:Arial;"><strong><em>base/device.py</em></strong></span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">01&nbsp;class&nbsp;Event(object):</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">02&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;send_via_dbus(self,&nbsp;session_bus,&nbsp;interface='com.hplip.StatusService'):</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">04&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;session_bus&nbsp;is&nbsp;not&nbsp;None&nbsp;and&nbsp;dbus_avail:</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">05&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.debug("Sending&nbsp;event&nbsp;%d&nbsp;to&nbsp;%s&nbsp;(via&nbsp;dbus)..."&nbsp;%&nbsp;(self.event_code,&nbsp;interface))</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">06&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg&nbsp;=&nbsp;lowlevel.SignalMessage('/',&nbsp;interface,&nbsp;'Event')</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">07&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg.append(signature=self.dbus_fmt,&nbsp;*self.as_tuple())</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">08&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;session_bus.send_message(msg)</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">09&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">10&nbsp;</span></p> 
   <p style="color:rgb(51,51,51);font-size:14px;font-family:'宋体';">这里调用的<span style="line-height:1.8;font-family:Arial;">send_message</span><span style="line-height:1.8;">是获取的</span><span style="line-height:1.8;font-family:Arial;">d-bus</span><span style="line-height:1.8;">实例的</span><span style="line-height:1.8;font-family:Arial;">send_message,</span><span style="line-height:1.8;">它在</span><span style="line-height:1.8;font-family:Arial;">hpdio.py</span><span style="line-height:1.8;">中。</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong><em><span style="line-height:1.8;font-family:Arial;">hpdio.py</span></em></strong></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">01&nbsp;def&nbsp;send_message(device_uri,&nbsp;event_code,&nbsp;bytes_written=0):</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">02&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;args&nbsp;=&nbsp;[device_uri,&nbsp;'',&nbsp;event_code,&nbsp;prop.username,&nbsp;0,&nbsp;'',&nbsp;'',&nbsp;bytes_written]</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg&nbsp;=&nbsp;lowlevel.SignalMessage('/',&nbsp;'com.hplip.StatusService',&nbsp;'Event')</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">04&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg.append(signature='ssisissi',&nbsp;*args)</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'Courier New';">05&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SessionBus().send_message(msg)</span></p> 
   <p style="color:rgb(51,51,51);font-size:14px;font-family:'宋体';">这里是标准的<span style="line-height:1.8;font-family:Arial;">d-bus</span><span style="line-height:1.8;">通信。</span><span style="line-height:1.8;font-family:Arial;">D-bus</span><span style="line-height:1.8;">在收到这个消息后，会怎么处理，且看以后分析。以上是向server端请求事件。server端收到事件后会调用handleSessionSignal回调。</span></p> 
   <p style="color:rgb(51,51,51);font-size:14px;font-family:'宋体';"><span style="line-height:1.8;">handleSessionSignal -&gt; handleStatusReply -&gt; updateDevice。<br></span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><br></p> 
   <h3 style="font-size:16px;line-height:1.5;font-family:verdana, Arial, Helvetica, sans-serif;">4.client与server端交互</h3> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp; &nbsp; &nbsp; &nbsp; clienthp-toolbox,server端hp-systray.他们分别启动后,怎样进行交互是一个重点,基于server端是有自己的消息通知和界面显示的,只是仅仅是一般的事件信息。</p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">hp-toolbox能够主动获取打印机信息。</p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp; &nbsp; &nbsp; &nbsp; server端会主动向打印机设备获取状态信息，client获取的要是server保存好的状态信息。这个基本属于 生产者-消费者 之间的关系。</p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</p> 
   <h3 style="font-size:16px;line-height:1.5;font-family:verdana, Arial, Helvetica, sans-serif;">5.LEDM通信协议</h3> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'宋体';">&nbsp; &nbsp; &nbsp; &nbsp;全称：&nbsp;Low End Data Model（在hplib的status.py中有介绍：def StatusType10(func): # Low End Data Model）。</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">眼下已经是HP一个专利<span style="line-height:1.8;font-family:'宋体';">：</span><a href="http://www.google.com/patents/EP2556480A1?hl=zh-CN&amp;cl=en" rel="nofollow" style="color:rgb(128,0,128);border-bottom:1px dotted rgb(51,51,51);font-family:'宋体';"><span style="line-height:1.8;">专利</span><span style="line-height:1.8;font-family:Arial;">EP2556480A1</span></a><span style="line-height:1.8;font-family:'宋体';color:rgb(0,0,255);">.</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'宋体';">打开channel调用流程：</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'宋体';">openEWS_LEDM -&gt; __openChannel -&gt; hpmudext.open_channel -&gt; hpmud处理</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'宋体';">读数据流程：</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'宋体';">readEWS_LEDM -&gt; __readChannel -&gt; hpmudext.read_channel -&gt; hpmud处理</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'宋体';">写命令流程：</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-family:'宋体';">writeEWS_LEDM -&gt; __writeChannel -&gt; hpmudext.write_channel -&gt; hpmud处理</span></p> 
   <span style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</span> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;&nbsp; &nbsp; &nbsp; 以获取ProductStatusDyn记录一下收发数据的情况。&nbsp;</p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp; &nbsp; &nbsp; &nbsp; 发送命令（报文）：</p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"></p> 
   <pre><code class="language-html">GET /DevMgmt/ProductStatusDyn.xml HTTP/1.1#015#012Accept: text/plain#015#012Host:localhost#015#012User-Agent:hplip#015#012#015#012</code></pre> 
   <span style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp; &nbsp; &nbsp; &nbsp;接收数据：</span> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"></p> 
   <pre><code class="language-html">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!-- THIS DATA SUBJECT TO DISCLAIMER(S) INCLUDED WITH THE PRODUCT OF ORIGIN. --&gt;
&lt;psdyn:ProductStatusDyn xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:dd="http://www.hp.com/schemas/imaging/con/dictionaries/1.0/" xmlns:ad="http://www.hp.com/schemas/imaging/con/ledm/alertdetails/2007/10/31" xmlns:pscat="http://www.hp.com/schemas/imaging/con/ledm/productstatuscategories/2007/10/31" xmlns:locid="http://www.hp.com/schemas/imaging/con/ledm/localizationids/2007/10/31" xmlns:psdyn="http://www.hp.com/schemas/imaging/con/ledm/productstatusdyn/2007/10/31" xsi:schemaLocation="http://www.hp.com/schemas/imaging/con/dictionaries/1.0/ ../schemas/dd/DataDictionaryMasterLEDM.xsd http://www.hp.com/schemas/imaging/con/ledm/alertdetails/2007/10/31 ../schemas/AlertDetails.xsd http://www.hp.com/schemas/imaging/con/ledm/productstatuscategories/2007/10/31 ../schemas/ProductStatusCategories.xsd http://www.hp.com/schemas/imaging/con/ledm/localizationids/2007/10/31 ../schemas/LocalizationIds.xsd http://www.hp.com/schemas/imaging/con/ledm/productstatusdyn/2007/10/31 ../schemas/ProductStatusDyn.xsd"&gt;
	&lt;dd:Version&gt;
		&lt;dd:Revision&gt;SVN-IPG-LEDM.216&lt;/dd:Revision&gt;
		&lt;dd:Date&gt;2011-02-08&lt;/dd:Date&gt;
	&lt;/dd:Version&gt;
	&lt;psdyn:Status&gt;
		&lt;pscat:StatusCategory&gt;closeDoorOrCover&lt;/pscat:StatusCategory&gt;
		&lt;locid:StringId&gt;65568&lt;/locid:StringId&gt;
	&lt;/psdyn:Status&gt;
	&lt;psdyn:AlertTable&gt;
		&lt;dd:ModificationNumber&gt;6&lt;/dd:ModificationNumber&gt;
		&lt;psdyn:Alert&gt;
			&lt;ad:ProductStatusAlertID&gt;closeDoorOrCover&lt;/ad:ProductStatusAlertID&gt;
			&lt;locid:StringId&gt;65568&lt;/locid:StringId&gt;
			&lt;dd:SequenceNumber&gt;5&lt;/dd:SequenceNumber&gt;
			&lt;ad:Severity&gt;Error&lt;/ad:Severity&gt;
			&lt;ad:AlertPriority&gt;1&lt;/ad:AlertPriority&gt;
			&lt;ad:AlertDetails&gt;
				&lt;ad:AlertDetailsDoorCoverLocation&gt;cover&lt;/ad:AlertDetailsDoorCoverLocation&gt;
			&lt;/ad:AlertDetails&gt;
			&lt;dd:ResourceURI&gt;/DevMgmt/ProductConfigDyn.xml&lt;/dd:ResourceURI&gt;
			&lt;dd:ResourceType&gt;ledm:hpLedmProductConfigDyn&lt;/dd:ResourceType&gt;
		&lt;/psdyn:Alert&gt;
		&lt;psdyn:Alert&gt;
			&lt;ad:ProductStatusAlertID&gt;cartridgeMissing&lt;/ad:ProductStatusAlertID&gt;
			&lt;locid:StringId&gt;65537&lt;/locid:StringId&gt;
			&lt;dd:SequenceNumber&gt;4&lt;/dd:SequenceNumber&gt;
			&lt;ad:Severity&gt;Error&lt;/ad:Severity&gt;
			&lt;ad:AlertPriority&gt;11&lt;/ad:AlertPriority&gt;
			&lt;ad:AlertDetails&gt;
				&lt;ad:AlertDetailsMarkerColor&gt;Black&lt;/ad:AlertDetailsMarkerColor&gt;
				&lt;ad:AlertDetailsConsumableTypeEnum&gt;inkCartridge&lt;/ad:AlertDetailsConsumableTypeEnum&gt;
				&lt;ad:AlertDetailsMarkerLocation&gt;1&lt;/ad:AlertDetailsMarkerLocation&gt;
			&lt;/ad:AlertDetails&gt;
			&lt;dd:ResourceURI&gt;/DevMgmt/ConsumableConfigDyn.xml&lt;/dd:ResourceURI&gt;
			&lt;dd:ResourceType&gt;ledm:hpLedmConsumableConfigDyn&lt;/dd:ResourceType&gt;
		&lt;/psdyn:Alert&gt;
		&lt;psdyn:Alert&gt;
			&lt;ad:ProductStatusAlertID&gt;cartridgeMissing&lt;/ad:ProductStatusAlertID&gt;
			&lt;locid:StringId&gt;65537&lt;/locid:StringId&gt;
			&lt;dd:SequenceNumber&gt;3&lt;/dd:SequenceNumber&gt;
			&lt;ad:Severity&gt;Error&lt;/ad:Severity&gt;
			&lt;ad:AlertPriority&gt;11&lt;/ad:AlertPriority&gt;
			&lt;ad:AlertDetails&gt;
				&lt;ad:AlertDetailsMarkerColor&gt;CyanMagentaYellow&lt;/ad:AlertDetailsMarkerColor&gt;
				&lt;ad:AlertDetailsConsumableTypeEnum&gt;inkCartridge&lt;/ad:AlertDetailsConsumableTypeEnum&gt;
				&lt;ad:AlertDetailsMarkerLocation&gt;0&lt;/ad:AlertDetailsMarkerLocation&gt;
			&lt;/ad:AlertDetails&gt;
			&lt;dd:ResourceURI&gt;/DevMgmt/ConsumableConfigDyn.xml&lt;/dd:ResourceURI&gt;
			&lt;dd:ResourceType&gt;ledm:hpLedmConsumableConfigDyn&lt;/dd:ResourceType&gt;
		&lt;/psdyn:Alert&gt;
	&lt;/psdyn:AlertTable&gt;
&lt;/psdyn:ProductStatusDyn&gt;</code></pre> 
   <span style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;pscat:StatusCategory字段记录的正是打印机的当前状态。</span>
   <br style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">
   <br style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">
   <h3 style="font-size:16px;line-height:1.5;font-family:verdana, Arial, Helvetica, sans-serif;"><span style="line-height:1.8;">6.hpmud分析</span></h3> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="line-height:18.2px;font-family:Arial, Verdana, Helvetica, sans-serif;font-size:12px;">MUlti-point transport Driver or&nbsp;</span><span style="line-height:18.2px;font-family:Arial, Verdana, Helvetica, sans-serif;font-size:12px;">HPMUD</span><span style="line-height:18.2px;font-family:Arial, Verdana, Helvetica, sans-serif;font-size:12px;">&nbsp;represents the I/O layer for HPLIP.&nbsp;</span><span style="line-height:18.2px;font-family:Arial, Verdana, Helvetica, sans-serif;font-size:12px;">HPMUD</span><span style="line-height:18.2px;font-family:Arial, Verdana, Helvetica, sans-serif;font-size:12px;">&nbsp;does not depend on Linux specific libusb extensions. This means any UNIX/Linux derivative that supports libusb may work with HPLIP. A public HPLIP "</span><span style="line-height:18.2px;font-family:Arial, Verdana, Helvetica, sans-serif;font-size:12px;">C</span><span style="line-height:18.2px;font-family:Arial, Verdana, Helvetica, sans-serif;font-size:12px;">" API is exposed through hpmud. See hpmud.h for documentation. A python wrapper for hpmud, called&nbsp;</span><span style="line-height:18.2px;font-family:Arial, Verdana, Helvetica, sans-serif;font-size:12px;">hpmudext</span><span style="line-height:18.2px;font-family:Arial, Verdana, Helvetica, sans-serif;font-size:12px;">, is also available.</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp; &nbsp; &nbsp; &nbsp; 以上是官网介绍，如开头图中所看到的，hpmud是负责真正和打印机设备进行通信的，它基于libusb开发，所以能够执行于所以含libusb的系统中。</p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">hpmud相同实现了多种通信方式：</p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"></p> 
   <ol style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style:decimal;">musb &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 基于眼下经常使用的libusb通信.（本次採用打印机正是用这样的方式）</li> 
    <li style="list-style:decimal;">musb_libusb01 &nbsp; &nbsp;&nbsp;基于眼下较老版本号的libusb通信.</li> 
    <li style="list-style:decimal;">jd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;基于jetdirect 的打印机通信.</li> 
    <li style="list-style:decimal;">pml &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;和python层相应。是一种打印语言</li> 
    <li style="list-style:decimal;">pp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;Parallel port 并口通信方式</li> 
   </ol>
   <div style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    &nbsp; &nbsp; &nbsp; &nbsp; 这里仅仅说musb通信方式。因为基于libusb，所以这里的musb就类似于java和c中的jni仅仅是一个接口的转接，musb会把python传送过来的指令通过libusb直接丢给打印机设备。
   </div> 
   <div style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    &nbsp; &nbsp; &nbsp; &nbsp; 另符上hpmud的调试方法，调试宏DBG的实现是syslog，把这个宏打开会将log信息输出到/var/log/syslog中。 
    <p></p> 
    <p></p> 
   </div> 
   <div style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <br>
   </div> 
   <h3 style="font-size:16px;line-height:1.5;font-family:verdana, Arial, Helvetica, sans-serif;">7.C语言实现状态获取</h3> 
   <div style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    &nbsp; &nbsp; &nbsp; &nbsp; 经过20多天的，无情的看源代码，最终有所获。最终把Device.py中获取状态的部分用C语言实现了。提取了关键部分。如今能够正常获取打印机状态。因为之前没有接触过HTTP协议，一个错误的报文格式使得我连续非常多天都处于迷茫之中，如今看来在于心智还是不全然成熟。在感觉要成功的时候就静不下心来了，不在阅读最后一段代码，然后有时那段代码才是最重要的。"Door Open"从打印机到PC屏幕的流程最终走通了。 
    <p></p> 
    <p></p> 
   </div> 
   <div style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"> 
    <pre><code class="language-cpp">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;hpmud.h&gt;
#include &lt;malloc.h&gt;

#ifdef  DEBUG
#define debug(fmt,args...)  debug (fmt ,##args)
#define debugX(level,fmt,args...) if (DEBUG&gt;=level) debug(fmt,##args);
#else
#define debug(fmt,args...)
#define debugX(level,fmt,args...)
#endif  /* DEBUG */

static HPMUD_DEVICE dd;
static HPMUD_CHANNEL cd;

#define MALLOC(type, n)  (type*)malloc(n*sizeof(type))

static int __readChannel(int bytes_to_read, int* reply, int allow_short_read, int timeout)
{
    bytes_to_read = 1024;
    char data[1024] = {0};
    int ret = 0;
    int num_bytes = 0;
    int len = 0;
    int *p = reply;
    while (1)
    {
        ret = hpmud_read_channel(dd, cd, data, 1024, timeout, &amp;num_bytes);
        debug("Result code=%d\n", ret);
        len = strlen(data);
        if(ret == HPMUD_R_IO_TIMEOUT)
        {
            debug("I/O timeout\n");
            break;
        }
        if(ret != HPMUD_R_OK)
        {
            debug("Channel read error\n");
            break;
        }

        //debug("read_buf:%s\n", data);

        if(!len)
        {
            debug("End of data\n");
            break;
        }

        memcpy(p, data, len);

        if (num_bytes == bytes_to_read)
        {
            debug("Full read complete.\n");
            break;
        }

        if (allow_short_read &amp;&amp; (num_bytes &lt; bytes_to_read))
        {
            debug("Allowed short read of %d of %d bytes complete.\n", num_bytes, bytes_to_read);
            break;
        }
    }

    debug("Saved %d total bytes to stream.\n", num_bytes);
    return num_bytes;
}

void readLEDMData()
{
    int timeout = 6;
    const char* END_OF_DATA="0\r\n\r\n";
    int bytes_read = 0;
    int bytes_requested = 1024;
    char temp_buf[1024] = {0};  //大小要一致
    int chunkedFlag = 1;
    char* result = NULL;
    char *reply = (int*)MALLOC(unsigned char, 5*1024);
    char *offset = reply;
    if(reply == NULL)
    {
        fprintf(stderr, "MALLC FAILURE!\n");
        return;
    }

    bytes_read = __readChannel(bytes_requested, reply, 1, timeout);
    offset += bytes_read;
    //debug("%s:%s\n", __func__, reply);

    // 默认chunked分块.
    chunkedFlag = 1;

    //result = strtok(reply, "\n");

    //debug("result=%s\n", result);

    while (bytes_read &gt; 0)
    {
        bytes_read = __readChannel(bytes_requested, (int*)temp_buf, 1, timeout);

        //reply.write(temp_buf.getvalue());
        memcpy(offset, temp_buf, bytes_read);
        debug("%s:%s\n", __func__, offset);
        offset += bytes_read;

        if(!chunkedFlag) // Unchunked data
        {
            // do nothing!
        }
        else // Chunked data end
        {
            //END_OF_DATA == temp_buf.getvalue();
            if(!strncmp(temp_buf, END_OF_DATA, sizeof(END_OF_DATA)))
                break;
        }
    }

    printf("%s:%s\n", __func__, reply);

    free(reply);
    reply = NULL;
}

int main(void)
{
    enum HPMUD_RESULT res;
    const char *device_uri = "hp:/usb/Deskjet_1010_series?serial=CN39I18M1805S8";
    enum HPMUD_IO_MODE io_mode = HPMUD_RAW_MODE;

    // 打开设备获得
    res = hpmud_open_device(device_uri, io_mode, &amp;dd);
    if (res != HPMUD_R_OK)
    {
        fprintf(stderr, "error opening device (code=%d)\n", res);
        return 1;
    }

    // 打开频道获得频道id
    res = hpmud_open_channel(dd, HPMUD_S_EWS_LEDM_CHANNEL, &amp;cd);
    if (res != HPMUD_R_OK)
    {
        fprintf(stderr, "error opening channel (code=%d)\n", res);
        return 1;
    }

    char buf[1024] = "GET /DevMgmt/ProductStatusDyn.xml HTTP/1.1\r\nAccept: text/plain\r\nHost:localhost\r\nUser-Agent:hplip\r\n\r\n";
    //char ConsumableConfigDyn[] = "GET /DevMgmt/ConsumableConfigDyn.xml HTTP/1.1#015#012Accept: text/plain#015#012Host:localhost#015#012User-Agent:hplip#015#012#015#012";
    int bit = 0;

    // 写入命令
    res = hpmud_write_channel(dd, cd, buf, 100, 6, &amp;bit);
    if (res != HPMUD_R_OK)
    {
        fprintf(stderr, "error hpmud_write_channel (code=%d)\n", res);
        return 1;
    }

    readLEDMData();
    return 0;

    hpmud_close_channel(dd, cd);
    hpmud_close_device(dd);

    return 0;
}</code></pre> 
    <br> &nbsp; &nbsp; &nbsp; &nbsp; 本程序会从打印出所得到状态的数据，pscat:StatusCategory字段中的就是状态值了，事实上能到了如《
    <a href="http://blog.csdn.net/kangear/article/details/26885685" rel="nofollow" style="color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">关于打印机状态的获取</a>》提到15个左右的状态，可是这个协议所规定的状态所有罗列出来：
    <br>
   </div> 
   <div style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"> 
    <p></p> 
    <table style="border:1px solid #C0C0C0;border-collapse:collapse;">
     <tbody>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>字串</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>状态</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>编号</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>processing</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_PRINTING</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1002</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>ready</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_IDLE</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1000</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>closeDoorOrCover</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_DOOR_OPEN</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1802</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>shuttingDown</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_TURNING_OFF</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1003</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>cancelJob</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_CANCELING</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1005</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>trayEmptyOrOpen</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_OUT_OF_PAPER</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1009</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>jamInPrinter</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_MEDIA_JAM</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1014</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>hardError</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_HARD_ERROR</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1018</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>outputBinFull</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_OUTPUT_BIN_FULL</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1002</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>unexpectedSizeInTray</p> <p>sizeMismatchInTray</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_MEDIA_SIZE_MISMATCH</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1023</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>insertOrCloseTray2</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_TRAY_2_MISSING</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1029</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>scannerError</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>EVENT_SCANNER_FAIL</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>2002</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>scanProcessing</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>EVENT_START_SCAN_JOB</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>2000</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>scannerAdfLoaded</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>EVENT_SCAN_ADF_LOADED</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>2004</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>scanToDestinationNotSet</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>EVENT_SCAN_TO_DESTINATION_NOTSET</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>2005</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>scanWaitingForPC</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>EVENT_SCAN_WAITING_FOR_PC</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>2006</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>scannerAdfJam</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>EVENT_SCAN_ADF_JAM</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>2007</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>scannerAdfDoorOpen</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>EVENT_SCAN_ADF_DOOR_OPEN</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>2008</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>faxProcessing</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>EVENT_START_FAX_JOB</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>3000</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>faxSending</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_FAX_TX_ACTIVE</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>3004</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>faxReceiving</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_FAX_RX_ACTIVE</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>3005</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>faxDialing</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>EVENT_FAX_DIALING</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>3006</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>faxConnecting</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>EVENT_FAX_CONNECTING</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>3007</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>faxSendError</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>EVENT_FAX_SEND_ERROR</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>3008</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>faxErrorStorageFull</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>EVENT_FAX_ERROR_STORAGE_FULL</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>3009</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>faxReceiveError</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>EVENT_FAX_RECV_ERROR</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>3010</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>faxBlocking</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>EVENT_FAX_BLOCKING</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>3011</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>inPowerSave</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_POWER_SAVE</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1046</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>incorrectCartridge</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_CARTRIDGE_WRONG</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1047</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>cartridgeMissing</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_CARTRIDGE_MISSING</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1048</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>missingPrintHead</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_PRINTHEAD_MISSING</p> <p>&nbsp;</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1049</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>scannerADFMispick</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_SCANNER_ADF_MISPICK</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1050</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>mediaTooShortToAutoDuplex</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_PAPER_TOO_SHORT_TO_AUTODUPLEX</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1051</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>insertOrCloseTray</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_TRAY_2_3_DOOR_OPEN</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1052</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>inkTooLowToPrime</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_INK_TOO_LOW_TO_PRIME</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1053</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>cartridgeVeryLow</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_VERY_LOW_ON_INK</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1054</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>wasteMarkerCollectorAlmostFull</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_SERVICE_INK_CONTAINER_ALMOST_FULL</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1055</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>wasteMarkerCollectorFull</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_SERVICE_INK_CONTAINER_FULL</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1056</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>wasteMarkerCollectorFullPrompt</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_SERVICE_INK_CONTAINER_FULL_PROMPT</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1057</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>missingDuplexer</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_DUPLEX_MODULE_MISSING</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1058</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>printBarStall</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_PRINTHEAD_JAM</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1059</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>outputBinClosed</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_CLEAR_OUTPUT_AREA</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1060</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>outputBinOpened</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_CLEAR_OUTPUT_AREA</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1060</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>reseatDuplexer</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_RESEAT_DUPLEXER</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1061</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>unexpectedTypeInTray</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_MEDIA_TYPE_MISMATCH</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1042</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>manuallyFeed</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_MANUALLY_FEED</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1062</p> </td> 
      </tr>
      <tr>
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>&nbsp;</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_UNKNOWN_CODE</p> </td> 
       <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1065</p> </td> 
      </tr>
     </tbody>
    </table>
    <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;扩展：眼下仅仅是上一个课题的总结。这之后的应用还有不少的问题，怎样应用。以及和利用设备节点打印是否冲突，以及是否能打印也基于hpmud。</p> 
    <p>。。</p> 
    <br>
   </div> 
   <h3 style="font-size:16px;line-height:1.5;font-family:verdana, Arial, Helvetica, sans-serif;">8.意外收获</h3> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp; &nbsp; &nbsp; &nbsp; 老天真的会眷恋努力的人，刚在<span style="line-height:1.8;font-family:'Times New Roman';">PC</span><span style="line-height:1.8;font-family:'宋体';">上实现基于</span><span style="line-height:1.8;font-family:'Times New Roman';">HPMUD</span><span style="line-height:1.8;font-family:'宋体';">的状态获取，考虑着进行三步走中的更为繁琐的后两步</span><span style="line-height:1.8;font-family:'Times New Roman';">(</span><span style="line-height:1.8;font-family:'宋体';">移植到嵌入式</span><span style="line-height:1.8;font-family:'Times New Roman';">Linux+</span><span style="line-height:1.8;font-family:'宋体';">移植到</span><span style="line-height:1.8;font-family:'Times New Roman';">Android)</span><span style="line-height:1.8;font-family:'宋体';">的时候，上天又送我一份大礼－－打印机状态获取的还有一种方式：通过</span><span style="line-height:1.8;font-family:'Times New Roman';">DeviceId</span><span style="line-height:1.8;font-family:'宋体';">。</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;这个可能不一定适合全部打印机。可是能够确定的是全然适应我如今正在调试的这款。</p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">关于<span style="line-height:1.8;font-family:'Times New Roman';">DeviceId</span><span style="line-height:1.8;font-family:'宋体';">从一開始看打印机相关的东西的时候最先接触到的就是这个</span><span style="line-height:1.8;font-family:'Times New Roman';">DeviceId,</span><span style="line-height:1.8;font-family:'宋体';">能够说我对它的感情也是跌宕起伏。从一喜得</span><span style="line-height:1.8;font-family:'Times New Roman';">DeviceId</span><span style="line-height:1.8;font-family:'宋体';">。到认为其作用单一。到如今的强大无比。</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;以下说点正经的，在《<a href="http://tools.ietf.org/pdf/rfc2911.pdf" rel="nofollow" style="color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);"><span style="line-height:1.8;color:rgb(0,0,255);">互联网打印协议</span><span style="line-height:1.8;color:rgb(0,0,255);">-</span><span style="line-height:1.8;color:rgb(0,0,255);">rfc2911</span></a>》的printer-state-reasons章节规定了打印机异常状态码。也就是说除了使用<span style="line-height:1.8;font-family:Arial;">HP</span><span style="line-height:1.8;font-family:'方正书宋_GBK';">自己定义的</span><span style="line-height:1.8;font-family:Arial;">LEDM</span><span style="line-height:1.8;font-family:'方正书宋_GBK';">获取的状态外，相同还能够通过标准的</span><span style="line-height:1.8;font-family:Arial;">IPP</span><span style="line-height:1.8;font-family:'方正书宋_GBK';">协议得到状态值。由此也能延伸出一个问题，</span><span style="line-height:1.8;font-family:Arial;">CUPS</span><span style="line-height:1.8;font-family:'方正书宋_GBK';">应该也能够获取打印机状态了。可是却没有做不论什么显示。至于是为什么。这个还是比較玄乎。</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;详细来看<span style="line-height:1.8;font-family:Arial;">DeviceID</span><span style="line-height:1.8;font-family:'方正书宋_GBK';">中含有状态的</span><span style="line-height:1.8;font-family:Arial;">“S”</span><span style="line-height:1.8;font-family:'方正书宋_GBK';">字段</span><span style="line-height:1.8;font-family:Arial;">:</span><span style="line-height:1.8;background:rgb(217,217,217);">S:038000C484a01021002c1f01100c2881100;</span>首先说明的是这个当中的都是<span style="line-height:1.8;font-family:'Times New Roman';">16</span><span style="line-height:1.8;font-family:'宋体';">进制的数。前两位是版本号信息，依据版本号信息不同。状态码所在的位置也不同，比方这里的版本号号为</span><span style="line-height:1.8;font-family:'Times New Roman';">03</span><span style="line-height:1.8;font-family:'宋体';">，那么状态码在第</span><span style="line-height:1.8;font-family:'Times New Roman';">16</span><span style="line-height:1.8;font-family:'宋体';">位的两位数这里为</span><span style="line-height:1.8;background:rgb(217,217,217);">00</span>转换为<span style="line-height:1.8;font-family:'Times New Roman';">10</span><span style="line-height:1.8;font-family:'宋体';">进制也是</span><span style="line-height:1.8;font-family:'Times New Roman';">0</span><span style="line-height:1.8;font-family:'宋体';">。这个状态代表空暇。有时候代码比语言更有说服力。</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">java<span style="line-height:1.8;font-family:'宋体';">版本号</span><span style="line-height:1.8;font-family:'Times New Roman';">:</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"></p> 
   <pre><code class="language-java">　　    public int getPrinterStatusCode() {
　　        String deviceId = getPrinterDeivceId();
　　        int ippStatus = -1;
　　        int pSf = 2;
　　
　　        if(deviceId == null)
　　            return ippStatus;
　　        
　　        // somthing
　　        String str[] = deviceId.split(";S:");
　　        if(str.length &gt; 1)
　　        {
　　            if(str[1] != null)
　　            {
　　                int ver=Integer.parseInt(str[1].substring(0,2), 16);
　　                       /* Position pointer to printer state subfield. */
　　                switch (ver)
　　                {
　　                  case 0:
　　                  case 1:
　　                  case 2:
　　                     pSf+=12;
　　                     break;
　　                  case 3:
　　                     pSf+=14;
　　                     break;
　　                  case 4:
　　                     pSf+=18;
　　                     break;
　　                  default:
　　                     Slog.w(LOG_TAG, "WARNING: unknown S-field version=" + ver + "\n");
　　                     pSf+=12;
　　                     break;
　　                }
　　                ippStatus = Integer.parseInt(str[1].substring(pSf, pSf + 2), 16);
　　            }
　　        }
　　        return ippStatus;
　　    }</code></pre> 
   <br style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">C<span style="line-height:1.8;font-family:'宋体';">版本号：</span></p> 
   <pre><code class="language-cpp">static int get_printer_status_code(const char* device_id)
{
	const char* id = device_id;
    char *pSf;
    int ver;
    int status = 0;

    /* Check for valid S-field in device id string. */
    if ((pSf = strstr(id, ";S:")) == NULL)
    {
    	/* No S-field, use status register instead of device id. */
    	/* do nothing */
    	goto bugout;
    }
    else
    {
       /* Valid S-field, get version number. */
       pSf+=3;
       ver = 0;
       HEX2INT(*pSf, ver);
       pSf++;
       ver = ver &lt;&lt; 4;
       HEX2INT(*pSf, ver);
       pSf++;

       /* Position pointer to printer state subfield. */
       switch (ver)
       {
          case 0:
          case 1:
          case 2:
             pSf+=12;
             break;
          case 3:
             pSf+=14;
             break;
          case 4:
             pSf+=18;
             break;
          default:
             printf("WARNING: unknown S-field version=%d\n", ver);
             pSf+=12;
             break;
       }

       /* Extract VStatus.*/
       status = 0;
       HEX2INT(*pSf, status);
       pSf++;
       status = status &lt;&lt; 4;
       HEX2INT(*pSf, status);
    }
    printf("status:%d\n", status);

bugout:
    return status;
}</code></pre> 
   <br style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">状态码相应关系：</p> 
   <pre><code class="language-cpp">   VSTATUS_IDLE = 0,
   VSTATUS_BUSY = 1,
   VSTATUS_PRNT = 2,      /* io printing */
   VSTATUS_OFFF = 3,      /* turning off */
   VSTATUS_RPRT = 4,      /* report printing */
   VSTATUS_CNCL = 5,      /* canceling */
   VSTATUS_IOST = 6,      /* io stall */
   VSTATUS_DRYW = 7,      /* dry time wait */
   VSTATUS_PENC = 8,      /* pen change */
   VSTATUS_OOPA = 9,      /* out of paper */
   VSTATUS_BNEJ = 10,      /* banner eject needed */
   VSTATUS_BNMZ = 11,      /* banner mismatch */
   VSTATUS_PHMZ = 12,      /* photo mismatch */
   VSTATUS_DPMZ = 13,      /* duplex mismatch */
   VSTATUS_PAJM = 14,      /* media jam */
   VSTATUS_CARS = 15,      /* carriage stall */
   VSTATUS_PAPS = 16,      /* paper stall */
   VSTATUS_PENF = 17,      /* pen failure */
   VSTATUS_ERRO = 18,      /* hard error */
   VSTATUS_PWDN = 19,      /* power down */
   VSTATUS_FPTS = 20,      /* front panel test */
   VSTATUS_CLNO = 21       /* clean out tray missing */</code></pre> 
   <br style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp; &nbsp; 文章至此该结束了。</p> 
   <br style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">其他：</p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">Linux<span style="line-height:1.8;font-family:'宋体';">打印驱动知识点</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">1.关于<span style="line-height:1.8;font-family:'Times New Roman';">DeviceId</span><span style="line-height:1.8;font-family:'宋体';">各段意义见《</span><a href="https://www.google.com/search?q=LEDMDIS&amp;newwindow=1&amp;safe=strict&amp;es_sm=122&amp;ei=q6KJU8_IMIb-oQTg5oKQAg&amp;start=10&amp;sa=N&amp;biw=1366&amp;bih=643" rel="nofollow" style="color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);"><span style="line-height:1.8;color:rgb(0,0,255);">ieee_1284</span></a>》</p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">2.关于<span style="line-height:1.8;font-family:'Times New Roman';">LEDM</span><span style="line-height:1.8;font-family:'宋体';">见《</span><a href="http://h10032.www1.hp.com/ctg/Manual/c01840676.pdf" rel="nofollow" style="color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);"><span style="line-height:1.8;color:rgb(0,0,255);">DISCOVERING&nbsp;PC-CONNECTED&nbsp;DEVICES</span></a>》</p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">3.Syslog<span style="line-height:1.8;font-family:'宋体';">见《</span><a href="http://www.gnu.org/software/libc/manual/html_node/Syslog-Example.html" rel="nofollow" style="color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);"><span style="line-height:1.8;color:rgb(0,0,255);">syslog-example</span></a>》经过实践输出到了<span style="line-height:1.8;font-family:'Times New Roman';">/var/log/</span>syslog.</p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">4.关于<span style="line-height:1.8;font-family:'Times New Roman';">Eclipse&nbsp;CD</span><span style="line-height:1.8;font-family:'宋体';">高版本号的</span><span style="line-height:1.8;font-family:'Times New Roman';">Memory&nbsp;View</span><span style="line-height:1.8;font-family:'宋体';">不能显示相应的</span><span style="line-height:1.8;font-family:'Times New Roman';">Text.</span><span style="line-height:1.8;font-family:'宋体';">换成</span>Helios&nbsp;Service&nbsp;Release&nbsp;2使用<span style="line-height:1.8;font-family:'Times New Roman';">New&nbsp;Rendrings-&gt;Traditional.</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">5.关于PJL(打印机控制语言)《<a href="http://h20566.www2.hp.com/portal/site/hpsc/template.BINARYPORTLET/public/kb/docDisplay/resource.process/?%3C/p%3E%3Cp%3Espf_p.tpst=kbDocDisplay_ws_BI&amp;spf_p.rid_kbDocDisplay=docDisplayResURL&amp;javax.portlet.begCacheTok=com.vignette.cachetoken&amp;spf_p.rst_kbDocDisplay=wsrp-resourceState%3DdocId%253Demr_na-bpl13208-1%257CdocLocale%253D&amp;javax.portlet.endCacheTok=com.vignette.cachetoken" rel="nofollow" style="color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">Printer Job Language Technical Reference Manual</a>》</p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">6.终于选择了基于deviceId的方法来实现。所以临时不再用hpmud的方法了。可是已经代码已经实现了printDate和基于ledm获取打印机的状态信息。</p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"></p> 
   <pre><code class="language-cpp">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;hpmud.h&gt;
#include &lt;malloc.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;pthread.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;stdarg.h&gt;


//#define DEBUG

#ifdef  DEBUG
#define debug(fmt,args...)  printf (fmt ,##args)
#define debugX(level,fmt,args...) if (DEBUG&gt;=level) debug(fmt,##args);
#else
#define debug(fmt,args...)
#define debugX(level,fmt,args...)
#endif  /* DEBUG */

// hp printer device
static HPMUD_DEVICE hd;

#define MALLOC(type, n)  (type*)malloc(n*sizeof(type))

// HPMUD_I_MAX
#define HPMUD_I_MAX  18
static int channels[HPMUD_I_MAX] = {0};

typedef HPMUD_CHANNEL(open_channel)(void);
typedef int(read_func)(int bytes_requested, char* reply, int timeout);

enum BACKEND_RESULT
{
  BACKEND_OK = 0,
  BACKEND_FAILED = 1,           /* use error-policy */
  BACKEND_HOLD = 3,             /* hold job */
  BACKEND_STOP = 4,             /* stop queue */
  BACKEND_CANCEL = 5            /* cancel job */
};

struct pjl_attributes
{
   int pjl_device;   /* 0=disabled, 1=enabled */
   int current_status;
   int eoj_pages;        /* end-of-job pages */
   int abort;         /* 0=no, 1=yes */
   int done;          /* 0=no, 1=yes */
   HPMUD_DEVICE dd;
   HPMUD_CHANNEL cd;
   pthread_t tid;
   pthread_mutex_t mutex;
   pthread_cond_t done_cond;
};

#define _STRINGIZE(x) #x
#define STRINGIZE(x) _STRINGIZE(x)

#define BUG(args...) bug(__FILE__ " " STRINGIZE(__LINE__) ": " args)

#ifdef HP_DEBUG
   #define DBG(args...) syslog(LOG_INFO, __FILE__ " " STRINGIZE(__LINE__) ": " args)
   #define DBG_DUMP(data, size) sysdump((data), (size))
   #define DBG_SZ(args...) syslog(LOG_INFO, args)
#else
   #define DBG(args...)
   #define DBG_DUMP(data, size)
   #define DBG_SZ(args...)
#endif

#define RETRY_TIMEOUT 30  /* seconds */
#define EXCEPTION_TIMEOUT 45 /* seconds */

#define NFAULT_BIT  0x08
#define PERROR_BIT  0x20

#define OOP             (NFAULT_BIT | PERROR_BIT)
#define JAMMED          (PERROR_BIT)
#define ERROR_TRAP      (0)

#define STATUS_MASK (NFAULT_BIT | PERROR_BIT)

#define DEVICE_IS_OOP(reg)  ((reg &amp; STATUS_MASK) == OOP)
#define DEVICE_PAPER_JAMMED(reg)  ((reg &amp; STATUS_MASK) == JAMMED)
#define DEVICE_IO_TRAP(reg)       ((reg &amp; STATUS_MASK) == ERROR_TRAP)

#define HEX2INT(x, i) if (x &gt;= '0' &amp;&amp; x &lt;= '9')      i |= x - '0'; \
                       else if (x &gt;= 'A' &amp;&amp; x &lt;= 'F') i |= 0xA + x - 'A'; \
                       else if (x &gt;= 'a' &amp;&amp; x &lt;= 'f') i |= 0xA + x - 'a'

/* Definitions for hpLogLevel in cupsd.conf. */
#define BASIC_LOG          1
#define SAVE_PCL_FILE      2
#define SAVE_INPUT_RASTERS 4
#define SEND_TO_PRINTER_ALSO    8

/* Actual vstatus codes are mapped to 1000+vstatus for DeviceError messages. */
typedef enum
{
   VSTATUS_IDLE = 1000,
   VSTATUS_BUSY,
   VSTATUS_PRNT,      /* io printing */
   VSTATUS_OFFF,      /* turning off */
   VSTATUS_RPRT,      /* report printing */
   VSTATUS_CNCL,      /* canceling */
   VSTATUS_IOST,      /* io stall */
   VSTATUS_DRYW,      /* dry time wait */
   VSTATUS_PENC,      /* pen change */
   VSTATUS_OOPA,      /* out of paper */
   VSTATUS_BNEJ,      /* banner eject needed */
   VSTATUS_BNMZ,      /* banner mismatch */
   VSTATUS_PHMZ,      /* photo mismatch */
   VSTATUS_DPMZ,      /* duplex mismatch */
   VSTATUS_PAJM,      /* media jam */
   VSTATUS_CARS,      /* carriage stall */
   VSTATUS_PAPS,      /* paper stall */
   VSTATUS_PENF,      /* pen failure */
   VSTATUS_ERRO,      /* hard error */
   VSTATUS_PWDN,      /* power down */
   VSTATUS_FPTS,      /* front panel test */
   VSTATUS_CLNO       /* clean out tray missing */
} VSTATUS;

#define EVENT_START_JOB 500
#define EVENT_END_JOB 501

//const char pjl_status_cmd[] = "\e%-12345X@PJL INFO STATUS \r\n\e%-12345X";
static const char pjl_ustatus_cmd[] = "\e%-12345X@PJL USTATUS DEVICE = ON \r\n@PJL USTATUS JOB = ON \r\n@PJL JOB \r\n\e%-12345X";
static const char pjl_job_end_cmd[] = "\e%-12345X@PJL EOJ \r\n\e%-12345X";
static const char pjl_ustatus_off_cmd[] = "\e%-12345X@PJL USTATUSOFF \r\n\e%-12345X";

static int bug(const char *fmt, ...)
{
   char buf[256];
   va_list args;
   int n;

   va_start(args, fmt);

   if ((n = vsnprintf(buf, 256, fmt, args)) == -1)
      buf[255] = 0;     /* output was truncated */

   fprintf(stderr, "%s", buf);
   //syslog(LOG_ERR, "%s", buf);

   fflush(stderr);
   va_end(args);
   return n;
}

/**
 * 因为使用的数组来实现python中的字典
 * 所以要将字符串转化为相应数字
 * openChannle和closeChannel中会用到
 */
static int get_service_name_num(char* service_name)
{
    int ser_name_id = 0;

    if(!strncmp(HPMUD_S_PRINT_CHANNEL, service_name, strlen(service_name)))
        ser_name_id = 1;
    else if(!strncmp(HPMUD_S_PML_CHANNEL, service_name, strlen(service_name)))
        ser_name_id = 2;
    else if(!strncmp(HPMUD_S_SCAN_CHANNEL, service_name, strlen(service_name)))
        ser_name_id = 3;
    else if(!strncmp(HPMUD_S_FAX_SEND_CHANNEL, service_name, strlen(service_name)))
        ser_name_id = 4;
    else if(!strncmp(HPMUD_S_CONFIG_UPLOAD_CHANNEL, service_name, strlen(service_name)))
        ser_name_id = 5;
    else if(!strncmp(HPMUD_S_CONFIG_DOWNLOAD_CHANNEL, service_name, strlen(service_name)))
        ser_name_id = 6;
    else if(!strncmp(HPMUD_S_MEMORY_CARD_CHANNEL, service_name, strlen(service_name)))
        ser_name_id = 7;
    else if(!strncmp(HPMUD_S_EWS_CHANNEL, service_name, strlen(service_name)))
        ser_name_id = 8;
    else if(!strncmp(HPMUD_S_EWS_LEDM_CHANNEL, service_name, strlen(service_name)))
        ser_name_id = 9;
    else if(!strncmp(HPMUD_S_SOAP_SCAN, service_name, strlen(service_name)))
        ser_name_id = 10;
    else if(!strncmp(HPMUD_S_SOAP_FAX, service_name, strlen(service_name)))
        ser_name_id = 11;
    else if(!strncmp(HPMUD_S_DEVMGMT_CHANNEL, service_name, strlen(service_name)))
        ser_name_id = 12;
    else if(!strncmp(HPMUD_S_MARVELL_SCAN_CHANNEL, service_name, strlen(service_name)))
        ser_name_id = 13;
    else if(!strncmp(HPMUD_S_MARVELL_FAX_CHANNEL, service_name, strlen(service_name)))
        ser_name_id = 14;
    else if(!strncmp(HPMUD_S_LEDM_SCAN, service_name, strlen(service_name)))
        ser_name_id = 15;
    else if(!strncmp(HPMUD_S_WIFI_CHANNEL, service_name, strlen(service_name)))
        ser_name_id = 16;
    else
        ser_name_id = 0;

    return ser_name_id;
}

static int __closeChannel(char* service_name)
{
    int result_code = 0;
    int ser_name_id = get_service_name_num(service_name);
    //if not self.mq['io-mode'] == IO_MODE_UNI and
    //  if self.io_state == IO_STATE_HP_OPEN:

//        service_name = service_name.upper();
    if(channels[ser_name_id] != 0)
    {
        printf("Closing %s channel...\n", service_name);
        result_code = hpmud_close_channel(hd, channels[ser_name_id]);
        if (result_code != HPMUD_R_OK)
        {
            fprintf(stderr, "error hpmud_close_channel (code=%d)\n", result_code);
            return 1;
        }
        else
        {
            channels[ser_name_id] = 0;
        }
    }

    return 0;
}

/*
 * open channel
 */
static int __openChannel(char* service_name)
{
    int result_code = 0;
    int channel_id  = 0;
    HPMUD_CHANNEL ret = 0;
    int ser_name_id = get_service_name_num(service_name);

    if (channels[ser_name_id] == 0)
    {
        printf("Opening %s channel...\n", service_name);

        result_code = hpmud_open_channel(hd, service_name, &amp;channel_id);
        if (result_code != HPMUD_R_OK)
        {
            fprintf(stderr, "error opening channel (code=%d)\n", result_code);
            exit(1);
        }
        else
        {
            channels[ser_name_id] = channel_id;
            debug("channel-id=%d\n", channel_id);
            ret = channel_id;
        }
    }
    else
    {
        printf("already open!\n");
        ret = channels[ser_name_id];
    }
    return ret;
}

/*
 * read channel
 */
static int __readChannel(open_channel opener, int bytes_to_read, char* reply, int allow_short_read, int timeout)
{
    bytes_to_read = 1024;
    char data[1024] = {0};
    int ret = 0;
    int num_bytes = 0;
    int len = 0;
    char *p = reply;
    HPMUD_CHANNEL channel_id = opener();

    while (1)
    {
        ret = hpmud_read_channel(hd, channel_id, data, 1024, timeout, &amp;num_bytes);
        debug("Result code=%d\n", ret);
        len = strlen(data);
        if(ret == HPMUD_R_IO_TIMEOUT)
        {
            debug("I/O timeout\n");
            break;
        }
        if(ret != HPMUD_R_OK)
        {
            debug("Channel read error\n");
            break;
        }

        //debug("read_buf:%s\n", data);

        if(!len)
        {
            debug("End of data\n");
            break;
        }

        memcpy(p, data, len);

        if (num_bytes == bytes_to_read)
        {
            debug("Full read complete.\n");
            break;
        }

        if (allow_short_read &amp;&amp; (num_bytes &lt; bytes_to_read))
        {
            debug("Allowed short read of %d of %d bytes complete.\n", num_bytes, bytes_to_read);
            break;
        }
    }

    debug("Saved %d total bytes to stream.\n", num_bytes);
    return num_bytes;
}

/**
 * write channel
 */
static int __writeChannel(open_channel opener, const char* data, int total_bytes_to_write)
{
    HPMUD_DEVICE  device_id  = hd;
    HPMUD_CHANNEL channel_id = opener();
    int          result_code = 0;
    int        bytes_written = 0;
    const char*             buffer = data;
    int            bytes_out = 0;
    int      max_message_len = 16384;
    int              timeout = 45;
    int       bytes_to_write = total_bytes_to_write;

    while(bytes_to_write &gt; 0)
    {
        result_code = hpmud_write_channel(device_id, channel_id, buffer, bytes_to_write &lt; max_message_len ? bytes_to_write : max_message_len, timeout, &amp;bytes_written);

        printf("Result code=%d\n", result_code);
        if (result_code != HPMUD_R_OK)
        {
            fprintf(stderr, "Channel write error\n");
            return -1;
        }

        buffer += max_message_len;
        bytes_out += bytes_written;
        bytes_to_write -= bytes_written;
    }

    if (total_bytes_to_write != bytes_out)
    {
        printf("total_bytes_to_write =%d =\\= bytes_out=%d\n", total_bytes_to_write, bytes_out);
        return -1;
    }

    //printf("%s end\n", __func__);
    return bytes_out;
}

static HPMUD_CHANNEL openEWS_LEDM()
{
    return __openChannel(HPMUD_S_EWS_LEDM_CHANNEL);
}

static HPMUD_CHANNEL openPrint()
{
    return __openChannel(HPMUD_S_PRINT_CHANNEL);
}

static int closePrint(void)
{
    return __closeChannel(HPMUD_S_PRINT_CHANNEL);
}

static int closeEWS_LEDM(void)
{
    return __closeChannel(HPMUD_S_EWS_LEDM_CHANNEL);
}

static int readEWS_LEDM(int bytes_requested, char* reply, int timeout)
{
    open_channel* opener = openEWS_LEDM;
    return __readChannel(opener, bytes_requested, reply, 1, timeout);
}

static int writePrint(const char* data, int len)
{
    open_channel* opener = openPrint;
    int ret = EXIT_FAILURE;
    int result_code = 0;
    //TODO:delect hpmud_write_channel
    /* Enable unsolicited status. */
    //ret = hpmud_write_channel(hd, channel_id, pjl_ustatus_cmd, sizeof(pjl_ustatus_cmd)-1, 5, &amp;bytes_written);

    result_code = __writeChannel(opener, data, len);
    if(result_code != len)
    {
    	printf("ret != len(%s:%u,%s)\n", __FILE__, __LINE__, __func__);
    	goto bugout;
    }
    /* Look for job end status. */

    //ret = hpmud_write_channel(hd, channel_id, pjl_ustatus_off_cmd, sizeof(pjl_ustatus_off_cmd)-1, 5, &amp;bytes_written);
    result_code = __writeChannel(opener, pjl_job_end_cmd, sizeof(pjl_job_end_cmd)-1);
    if(result_code != (sizeof(pjl_job_end_cmd)-1))
    {
    	printf("ret != len(%s:%u,%s)\n", __FILE__, __LINE__, __func__);
    	goto bugout;
    }

    ret = EXIT_SUCCESS;
bugout:
    return ret;
}

static int writeEWS_LEDM(const char* data, int len)
{
    open_channel* opener = openEWS_LEDM;
    return __writeChannel(opener, data, len);
}


static void readLEDMData(read_func* func, char *reply)
{
    int timeout = 6;
    const char* END_OF_DATA="0\r\n\r\n";
    int bytes_read = 0;
    int bytes_requested = 1024;
    char temp_buf[1024] = {0};  //大小要一致
    int chunkedFlag = 1;
    char *offset = reply;
    if(reply == NULL)
    {
        fprintf(stderr, "MALLC FAILURE!\n");
        return;
    }

    bytes_read = func(bytes_requested, reply, timeout);
    offset += bytes_read;
    //debug("%s:%s\n", __func__, reply);

    // 默认chunked分块.
    chunkedFlag = 1;

    //result = strtok(reply, "\n");

    //debug("result=%s\n", result);

    while (bytes_read &gt; 0)
    {
        bytes_read = readEWS_LEDM(bytes_requested, (char*)temp_buf, timeout);

        //reply.write(temp_buf.getvalue());
        memcpy(offset, temp_buf, bytes_read);
        debug("%s:%s\n", __func__, offset);
        offset += bytes_read;

        if(!chunkedFlag) // Unchunked data
        {
            // do nothing!
        }
        else // Chunked data end
        {
            //END_OF_DATA == temp_buf.getvalue();
            if(!strncmp(temp_buf, END_OF_DATA, sizeof(END_OF_DATA)))
                break;
        }
    }

    printf("%s:%s\n", __func__, reply);

}

static int open_hp(const char* url, char* reply)
{
    char data[512] = {0};
    debug("open_hp(%s)\n", url);

//    match_obj = http_pat_url.search(url)
//    loc = url.split("=")[url.count("=")]

    openEWS_LEDM();

    sprintf(data, "GET %s HTTP/1.1\r\nAccept: text/plain\r\nHost:localhost\r\nUser-Agent:hplip\r\n\r\n", url);
    writeEWS_LEDM(data, strlen(data));

    //while dev.readEWS_LEDM(512, reply, timeout=3):
        //pass

    read_func* func = readEWS_LEDM;

    readLEDMData(func, reply);

    //reply.seek(0);

    //return reply.getvalue();
    return 0;

}
void getEWSUrl_LEDM(const char* url, char* reply)
{
//    int self, url, stream, footer;
//    url2 = "%s&amp;loc=%s" % (self.device_uri.replace('hpfax:', 'hp:'), url);
//    data = self;
//    opener = LocalOpenerEWS_LEDM({});
//    opener.open_hp(url2, data);
    open_hp(url, reply);
    closeEWS_LEDM();
}

void printData()
{
    char *buf = (char*)MALLOC(unsigned char, 107968);
    if(buf == NULL)
    {
        fprintf(stderr, "MALLC FAILURE!\n");
        return;
    }

    int fd = open("/home/kangear/bin.bin", O_RDONLY);
    if(fd == -1)
    {
        fprintf(stderr, "open file error!\n");
        return;
    }

    int num = read(fd, buf, 107968);
    if(num == -1)
    {
        fprintf(stderr, "read file error!\n");
        return;
    }

    writePrint(buf, num);

    close(fd);
    free(buf);
    buf = NULL;
}

/**
 * device discovery
 * if there is hp device return EXIT_SUCCESS, but EXIT_FAILURE.
 */
static int device_discovery()
{
   char buf[HPMUD_LINE_SIZE*64];
   int cnt=0, bytes_read, r=EXIT_FAILURE;
   enum HPMUD_RESULT stat;

   stat = hpmud_probe_devices(HPMUD_BUS_ALL, buf, sizeof(buf), &amp;cnt, &amp;bytes_read);

   if (stat != HPMUD_R_OK)
      goto bugout;

   if (cnt == 0)
   {
#ifdef HAVE_CUPS11
      fprintf(stdout, "direct hp:/no_device_found \"Unknown\" \"hp no_device_found\"\n");
#else
      fprintf(stdout, "direct hp \"Unknown\" \"HP Printer (HPLIP)\"\n");
#endif
      goto bugout;
   }
   else
      fprintf(stdout, "%s", buf);

   r = EXIT_SUCCESS;

bugout:
   return r;
}

static int open_device(const char* device_uri)
{
    //int io_mode = 0;
    HPMUD_DEVICE device_id = -1;
    int result_code = 0, r = EXIT_FAILURE;

    enum HPMUD_IO_MODE io_mode = HPMUD_RAW_MODE;

    debug("I/O mode=%d\n", io_mode);

    // 打开设备获得
    result_code = hpmud_open_device(device_uri, io_mode, &amp;device_id);
    if (result_code != HPMUD_R_OK)
    {
        fprintf(stderr, "error opening device (code=%d)\n", result_code);
        goto bugout;
    }

    hd = device_id; //TODO:delect.
    r = EXIT_SUCCESS;

bugout:
    return r;
}


/* Map printer status to IPP printer-state-reasons (see RFC-2911). */
static int map_ipp_printer_state_reason(int status, const char **state_msg)
{

   if (status &gt;= 1000 &amp;&amp; status &lt;= 1999)
   {
      /* inkjet vstatus */
      switch (status)
      {
         case VSTATUS_IDLE:
         case VSTATUS_PRNT:
            *state_msg = "none";
            break;
         case VSTATUS_OOPA:
            *state_msg = "media-empty-error";
            break;
         case(VSTATUS_PAJM):
            *state_msg = "media-jam-error";
            break;
         default:
            *state_msg = "other";
            break;
      }
   }
   else if (status &gt;= 10000 &amp;&amp; status &lt;= 55999)
   {
      /* laserjet pjl status */
      if (status &gt;= 10000 &amp;&amp; status &lt;= 10999)
         *state_msg = "none";
      else if (status &gt;= 41000 &amp;&amp; status &lt;= 41999)
         *state_msg = "media-empty-error";
      else if ((status &gt;= 42000 &amp;&amp; status &lt;= 42999) || (status &gt;= 44000 &amp;&amp; status &lt;= 44999) || (status == 40022))
         *state_msg = "media-jam-error";
      else if (status == 40021)
         *state_msg = "cover-open-error";
      else if (status == 40600)
         *state_msg = "toner-empty-error";
      else
         *state_msg = "other";      /* 40017 - cartridge E-LABEL is unreadable (ie: ljp1005) */
   }
   else
   {
      /* Assume hpmud error */
      *state_msg = "other";
   }

   return 0;
}

/*
 * get_printer_status
 *
 * inputs:
 *   dd - device descriptor
 *   pa - see pjl_attributes definition
 *
 * outputs:
 *   return - printer status, 1000 to 1999 = inkjet vstatus, 5000 to 5999 = hpmud error, 10000 to 55999 = pjl status code
 *
 */
static int get_printer_status(HPMUD_DEVICE dd, HPMUD_CHANNEL cd, struct pjl_attributes *pa)
{
   char id[1024];
   char *pSf;
   int status, ver, len;
   enum HPMUD_RESULT r;

   if (pa-&gt;pjl_device)
   {
      pthread_mutex_lock(&amp;pa-&gt;mutex);
      status = pa-&gt;current_status;
      pthread_mutex_unlock(&amp;pa-&gt;mutex);
   }
   else
   {
      status = VSTATUS_IDLE; /* set default */
      r = hpmud_get_device_id(dd, id, sizeof(id), &amp;len);
//      if (!(r == HPMUD_R_OK || r == HPMUD_R_DEVICE_BUSY))
      if (r != HPMUD_R_OK)
      {
         status = 5000+r;      /* no deviceid, return some error */
         goto bugout;
      }

      /* Check for valid S-field in device id string. */
      if ((pSf = strstr(id, ";S:")) == NULL)
      {
         /* No S-field, use status register instead of device id. */
         unsigned int bit_status;
         r = hpmud_get_device_status(dd, &amp;bit_status);
//         if (!(r == HPMUD_R_OK || r == HPMUD_R_DEVICE_BUSY))
         if (r != HPMUD_R_OK)
         {
            status = 5000+r;      /* no 8-bit status, return some error */
            goto bugout;
         }

         if (DEVICE_IS_OOP(bit_status))
            status = VSTATUS_OOPA;
         else if (DEVICE_PAPER_JAMMED(bit_status))
            status = VSTATUS_PAJM;
         else if (DEVICE_IO_TRAP(bit_status))
            status = VSTATUS_CARS;
      }
      else
      {
         /* Valid S-field, get version number. */
         pSf+=3;
         ver = 0;
         HEX2INT(*pSf, ver);
         pSf++;
         ver = ver &lt;&lt; 4;
         HEX2INT(*pSf, ver);
         pSf++;

         /* Position pointer to printer state subfield. */
         switch (ver)
         {
            case 0:
            case 1:
            case 2:
               pSf+=12;
               break;
            case 3:
               pSf+=14;
               break;
            case 4:
               pSf+=18;
               break;
            default:
               BUG("WARNING: unknown S-field version=%d\n", ver);
               pSf+=12;
               break;
         }

         /* Extract VStatus.*/
         status = 0;
         HEX2INT(*pSf, status);
         pSf++;
         status = status &lt;&lt; 4;
         HEX2INT(*pSf, status);
         status += 1000;
      }
   }

bugout:
   return status;
}


/* Check printer status, if a valid error state, loop until error condition is cleared. */
static int loop_test(HPMUD_DEVICE dd, HPMUD_CHANNEL cd, struct pjl_attributes *pa,
        const char *dev, const char *printer, const char *username, const char *jobid, const char *title)
{
   int status, stat;
   const char *pstate, *old_state=NULL;

   while (1)
   {
      status = get_printer_status(dd, cd, pa);
      map_ipp_printer_state_reason(status, &amp;pstate);

      /* Check for user intervention errors. */
      if (strstr(pstate, "error"))
      {
         if (pstate != old_state)
         {
            if (old_state)
            {
               /* Clear old error. */
//               device_event(dev, printer, status, username, jobid, title);
               fprintf(stderr, "STATE: -%s\n", old_state);
            }

            /* Display error. */
            //device_event(dev, printer, status, username, jobid, title);
            fprintf(stderr, "STATE: +%s\n", pstate);
            old_state = pstate;
         }
         BUG("ERROR: %d %s; will retry in %d seconds...\n", status, pstate, RETRY_TIMEOUT);
         sleep(RETRY_TIMEOUT);
         continue;
      }

      /* Clear any old state. */
      if (old_state)
         fprintf(stderr, "STATE: -%s\n", old_state);

      /* Check for system errors. */
      if (status &gt;= 5000 &amp;&amp; status &lt;= 5999)
      {
         /* Display error. */
         //device_event(dev, printer, status, username, jobid, title);
         BUG("ERROR: %d device communication error!\n", status);
         stat = 1;
      }
      else
         stat = 0;

      break;   /* done */
   }

   return stat;
}

int get_device_id(HPMUD_DEVICE hd)
{
    char id[1024] = {0};
    char *pSf;
    int status, ver, len;
    enum HPMUD_RESULT r;
    int ret = EXIT_FAILURE;
    r = hpmud_get_device_id(hd, id,sizeof(id), &amp;len);
    printf("device_id:%s\n", id);
    if (r != HPMUD_R_OK)
    {
       /* no deviceid, return some error */
       goto bugout;
    }
    /* Check for valid S-field in device id string. */
    if ((pSf = strstr(id, ";S:")) == NULL)
    {
       /* No S-field, use status register instead of device id. */
       unsigned int bit_status;
       r = hpmud_get_device_status(hd, &amp;bit_status);
//         if (!(r == HPMUD_R_OK || r == HPMUD_R_DEVICE_BUSY))
       if (r != HPMUD_R_OK)
       {
          status = 5000+r;      /* no 8-bit status, return some error */
          goto bugout;
       }

//       if (DEVICE_IS_OOP(bit_status))
//          status = VSTATUS_OOPA;
//       else if (DEVICE_PAPER_JAMMED(bit_status))
//          status = VSTATUS_PAJM;
//       else if (DEVICE_IO_TRAP(bit_status))
//          status = VSTATUS_CARS;
    }
    else
    {
       /* Valid S-field, get version number. */
       pSf+=3;
       ver = 0;
       HEX2INT(*pSf, ver);
       pSf++;
       ver = ver &lt;&lt; 4;
       HEX2INT(*pSf, ver);
       pSf++;

       /* Position pointer to printer state subfield. */
       switch (ver)
       {
          case 0:
          case 1:
          case 2:
             pSf+=12;
             break;
          case 3:
             pSf+=14;
             break;
          case 4:
             pSf+=18;
             break;
          default:
             printf("WARNING: unknown S-field version=%d\n", ver);
             pSf+=12;
             break;
       }

       /* Extract VStatus.*/
       status = 0;
       HEX2INT(*pSf, status);
       pSf++;
       status = status &lt;&lt; 4;
       HEX2INT(*pSf, status);
       status += 1000;
    }
    printf("status:%d\n", status);
    ret = EXIT_SUCCESS;
bugout:
    return ret;
}

static int get_printer_status_code(const char* device_id)
{
	const char* id = device_id;
    char *pSf;
    int ver;
    int status = 0;

    /* Check for valid S-field in device id string. */
    if ((pSf = strstr(id, ";S:")) == NULL)
    {
    	/* No S-field, use status register instead of device id. */
    	/* do nothing */
    	goto bugout;
    }
    else
    {
       /* Valid S-field, get version number. */
       pSf+=3;
       ver = 0;
       HEX2INT(*pSf, ver);
       pSf++;
       ver = ver &lt;&lt; 4;
       HEX2INT(*pSf, ver);
       pSf++;

       /* Position pointer to printer state subfield. */
       switch (ver)
       {
          case 0:
          case 1:
          case 2:
             pSf+=12;
             break;
          case 3:
             pSf+=14;
             break;
          case 4:
             pSf+=18;
             break;
          default:
             printf("WARNING: unknown S-field version=%d\n", ver);
             pSf+=12;
             break;
       }

       /* Extract VStatus.*/
       status = 0;
       HEX2INT(*pSf, status);
       pSf++;
       status = status &lt;&lt; 4;
       HEX2INT(*pSf, status);
       status += 1000;
    }
    printf("status:%d\n", status);

bugout:
    return status;
}

static int get_cups_uri(char* cups_uri)
{
    char buf[HPMUD_LINE_SIZE*64];
    int cnt=0, bytes_read, r=EXIT_FAILURE;
    enum HPMUD_RESULT stat;

    stat = hpmud_probe_devices(HPMUD_BUS_ALL, buf, sizeof(buf), &amp;cnt, &amp;bytes_read);

    if (stat != HPMUD_R_OK)
      goto bugout;

    if (cnt == 0)
        fprintf(stdout, "direct hp \"Unknown\" \"HP Printer (HPLIP)\"\n");
    else
        sprintf(cups_uri, buf, strlen(buf));

    r = EXIT_SUCCESS;

bugout:
    return r;
}


static int make_device_uri(char* dev_uri)
{
    int ret = EXIT_FAILURE;
    enum HPMUD_RESULT stat;
    char cups_uri[HPMUD_LINE_SIZE*64];
    char* p = NULL;

    stat = get_cups_uri(cups_uri);

    if (stat != EXIT_SUCCESS)
      goto bugout;

    p = strtok(cups_uri, " ");
    if(p == NULL)
        goto bugout;

    p = strtok(NULL, " ");
    if(p == NULL)
        goto bugout;

    // copy only one device uri and others ignore.
    sprintf(dev_uri, p, strlen(p));

    debug("dev_uri:%s\n", dev_uri);

    ret = EXIT_SUCCESS;
bugout:
    return ret;
}

int main(void)
{
    int ret = EXIT_FAILURE;
    //const char *device_uri = "hp:/usb/Deskjet_1010_series?serial=CN39I18M1805S8";
    //const char *device_uri = "hp:/usb/Deskjet_1000_J110_series?serial=CN2C818N3605YD";
    char dev_uri[HPMUD_LINE_SIZE] = {0};

    // step 1.
    if(device_discovery() != EXIT_SUCCESS)
    {
        debug("device discovery failed!\n");
        goto bugout;
    }
    printf("device discovery success!\n");

    // step 2:解析一个device uri.
    if(make_device_uri(dev_uri) !=  EXIT_SUCCESS)
    {
        debug("make device uri failed!\n");
        goto bugout;
    }

    // step 3:open hp device
    if(open_device(dev_uri) !=  EXIT_SUCCESS)
    {
        debug("open_device device failed!\n");
        goto bugout;
    }

    // step 4: get device id.
    get_device_id(hd);

    //printData();

    //readAttributeFromXml_EWS

    //StatusType10();

    char* reply = (char*)MALLOC(char, 500*1024);

    //获取状态XML
    getEWSUrl_LEDM("/DevMgmt/ProductStatusDyn.xml", reply);  // 获取状态
    //getEWSUrl_LEDM("/DevMgmt/ConsumableConfigDyn.xml", reply); // 获取耗材配置

    free(reply);
    reply = NULL;

    if (hd &gt;= 0)
       hpmud_close_device(hd);

    ret = EXIT_SUCCESS;

bugout:
    return ret;
}</code></pre> 
   <br style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">打印机异常状态：</p> 
   <table style="border:1px solid #C0C0C0;border-collapse:collapse;color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <tbody>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>N</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>Windows状态</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>宏</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>0</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>正常</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_IDLE(1000)</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>1</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>无法与打印机通信</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>x</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>2</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>出纸盒已关闭</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_OUTPUT_TRAY_CLOSED(1035)</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>3</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>门己打开</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_PEN_CHANGE(1008)</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>4</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>缺纸</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_OUT_OF_PAPER(1009)</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>5</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>卡纸</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_PAPER_STALL(1016)</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>6</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>墨盒故障<span style="line-height:1.8;font-family:Arial;">-</span><span style="line-height:1.8;font-family:'方正书宋_GBK';">黑色</span></p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_PEN_FAILURE(1017)</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>7</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>墨盒故障<span style="line-height:1.8;font-family:Arial;">-</span><span style="line-height:1.8;font-family:'方正书宋_GBK';">三色</span></p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>-</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>8</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>墨盒故障<span style="line-height:1.8;font-family:Arial;">-</span><span style="line-height:1.8;font-family:'方正书宋_GBK';">黑色</span><span style="line-height:1.8;font-family:Arial;">-</span><span style="line-height:1.8;font-family:'方正书宋_GBK';">三色</span></p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>-</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>9</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>墨盒丢失</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>-&nbsp;</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>10</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>单墨盒模式<span style="line-height:1.8;font-family:Arial;">-</span><span style="line-height:1.8;font-family:'方正书宋_GBK';">缺黑色</span></p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_IDLE(1000)</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>11</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>单墨盒模式<span style="line-height:1.8;font-family:Arial;">-</span><span style="line-height:1.8;font-family:'方正书宋_GBK';">缺彩色</span></p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>STATUS_PRINTER_IDLE(1000)</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>12</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>无墨&nbsp;&nbsp;黑色</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>x</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>13</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>无墨&nbsp;&nbsp;彩色</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>x</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>14</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>无墨&nbsp;&nbsp;黑色<span style="line-height:1.8;font-family:Arial;">-</span><span style="line-height:1.8;font-family:'方正书宋_GBK';">彩色</span></p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>x</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>15</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>已经安装<span style="line-height:1.8;font-family:Arial;">HP</span><span style="line-height:1.8;font-family:'方正书宋_GBK';">保护墨盒</span></p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>x</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>16</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>检測到使用过的或仿制墨盒</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>x</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>&nbsp;</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>...</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>&nbsp;</p> </td> 
     </tr>
     <tr>
      <td valign="top" colspan="3" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>注：<span style="line-height:1.8;font-family:Arial;">x</span><span style="line-height:1.8;font-family:'方正书宋_GBK';">代表暂无条件获取</span><span style="line-height:1.8;font-family:Arial;">,&nbsp;-</span><span style="line-height:1.8;font-family:'方正书宋_GBK';">代表和上条同样。</span></p> <p></p> <p>假设出现<span style="line-height:1.8;font-family:Arial;">6</span><span style="line-height:1.8;font-family:'方正书宋_GBK';">号状态，建议提示提示语</span><span style="line-height:1.8;font-family:Arial;">“</span><span style="line-height:1.8;font-family:'方正书宋_GBK';">墨盒故障或墨盒丢失</span><span style="line-height:1.8;font-family:Arial;">”</span><span style="line-height:1.8;font-family:'方正书宋_GBK';">。</span></p> </td>
     </tr>
    </tbody>
   </table>
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <div>
    <br>
   </div> 
   <div>
    <br>
   </div> 
   <div>
    <br>
   </div> 
   <div>
    <br>
   </div> 
   <div>
    <br>
   </div> 
   <div>
    <br>
   </div> 
   <div> 
    <div>
     本文转自mfrbuaa博客园博客，原文链接：http://www.cnblogs.com/mfrbuaa/p/5065783.html，如需转载请自行联系原作者
    </div> 
   </div> 
   <div>
    <br>
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
