<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>EntityFramework之原始查询及性能优化（六） « NotBeCN</title>
  <meta name="description" content="             前言    在EF中我们可以通过Linq来操作实体类，但是有些时候我们必须通过原始sql语句或者存储过程来进行查询数据库，所以我们可以通过EF Code First来实现，但是SQL语句和存储过程无法进行映射，于是我们只能手动通过上下文中的SqlQuery和ExecuteSqlComma...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/21/weixin_33742618_90121248.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">EntityFramework之原始查询及性能优化（六）</h1>
    <p class="post-meta">Nov 21, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <h1 style="font-size:28px;line-height:1.5;font-family:'Helvetica Neue', Arial;">前言</h1> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">在EF中我们可以通过Linq来操作实体类，但是有些时候我们必须通过原始sql语句或者存储过程来进行查询数据库，所以我们可以通过EF Code First来实现，但是SQL语句和存储过程无法进行映射，于是我们只能手动通过上下文中的SqlQuery和ExecuteSqlCommand来完成。</p> 
   <h1 style="font-size:28px;line-height:1.5;font-family:'Helvetica Neue', Arial;">SqlQuery</h1> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">sql语句查询实体</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;通过DbSet中的SqlQuery方法来写原始sql语句返回<span style="font-size:15px;color:rgb(255,0,0);">实体实例</span>，如果是通过Linq查询返回的那么返回的对象将被上下文（context）所跟踪。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">首先给出要操作的Student（学生类），对于其映射这里不再叙述，本节只讲查询。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> Student 
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">int</span> ID { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">string</span> Name { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">int</span> Age { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }

    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">如果我们要查询学生表（Student）所有数据应该如何操作呢？下面我们通过代码来进行演示：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>EntityDbContext ctx = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> EntityDbContext();

SqlParameter[] parameter </span>=<span style="line-height:1.5;"> { };

ctx.Database.SqlQuery</span>&lt;Student&gt;(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">select * from student</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, parameter).<span style="font-size:18px;color:rgb(255,0,0);line-height:1.5;">ToList()</span>;</pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">我们通过Sql Server Profiler监控其执行语句如下图，达到预期所想。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images0.cnblogs.com/blog2015/589642/201508/202129296919986.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">【注意1】上述我标注&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">实体实例</span>&nbsp;为红色的地方，返回的必须是一个实体即所有列，如果有些列未返回将报错！假设我们只查出学生表中Age和Name,我们这样写查看语句</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>ctx.Database.SqlQuery&lt;Student&gt;(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">select Name, Age from Student</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>).ToList();</pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">这样将会报错如下：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images0.cnblogs.com/blog2015/589642/201508/202156597387084.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">【注意2】上述我标注了&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">ToList()</span>&nbsp;为红色的地方，正如上述所说Linq查询一样，这个查询语句直到结果全部被枚举完也就是ToList()之后才会执行。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><span style="font-size:16px;color:rgb(255,0,0);">那问题来了，接下来我们进行如下操作，数据库会进行相应的修改？</span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">                var</span> entity = <span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;">ctx.Database.SqlQuery&lt;Student&gt;</span>(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">select * from student</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">).ToList();

                entity.Last().Name </span>= <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">0928</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">;

                ctx.SaveChanges();</span></pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">我们查询出数据，并将其最后一条数据为xpy0928的修改为0928。结果如下：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201508/589642-20150828222119937-1354844446.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">显示并未进行修改，那我们接着进行如下操作，又会如何呢？</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>                <span style="color:rgb(0,0,255);line-height:1.5;">var</span> entity =<span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;"> ctx.Set&lt;Student&gt;().SqlQuery</span>(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">select * from student</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">).ToList();

                entity.Last().Name </span>= <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">0928</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">;

                ctx.SaveChanges();</span></pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;结果如下，显示进行了相应的改变：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201508/589642-20150828222556109-1976388939.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">所以基于此我们得出结论：</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">ctx.Database.SqlQuery&lt;TEntity&gt;()：SqlQuery方法获得的实体查询是在数据库（Database）上，实体不会被上下文跟踪。</h3> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">ctx.Set&lt;TEntity&gt;().SqlQuery()：SqlQuery方法获得实体查询在上下文中的实体集合上（DbSet）上，实体会被上下文跟踪。</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><span style="font-size:16px;color:rgb(255,0,0);">那么问题来了，如果要是有参数的话该如何进行查询呢？</span></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><span style="color:rgb(0,0,0);">例如：要查询Name="xpy0928"和Age=5的学生该如何查询呢？下面我们一步一步来进行尝试和操作</span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>            <span style="color:rgb(0,0,255);line-height:1.5;">var</span> Name = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">xpy0928</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">;
            
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> Age = <span style="color:rgb(128,0,128);line-height:1.5;">5</span><span style="line-height:1.5;">;
            
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> sql = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">select Name, Age from Student where Name = <span style="font-size:15px;color:rgb(255,0,0);line-height:1.5;">@Name</span> and Age = <span style="font-size:15px;color:rgb(255,0,0);line-height:1.5;">@Age</span></span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">;

            ctx.Database.SqlQuery</span>&lt;Student&gt;(sql, Name, Age).ToList();</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">我们运行看看，结果出错如下：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images0.cnblogs.com/blog2015/589642/201508/202145263633955.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">先不管错误，我们进行第二次尝试：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">            var</span> Name = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">xpy0928</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">;
            
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> Age = <span style="color:rgb(128,0,128);line-height:1.5;">5</span><span style="line-height:1.5;">;
            
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> sql = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">select ID, Name, Age from Student where Name = <span style="font-size:15px;color:rgb(255,0,0);line-height:1.5;">{0}</span> and Age = <span style="font-size:15px;color:rgb(255,0,0);line-height:1.5;">{1}</span></span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">;

            ctx.Database.SqlQuery</span>&lt;Student&gt;(sql, Name, Age).FirstOrDefault();</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">结果查询正常进行，未出错，从下面监控中可以看到：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images0.cnblogs.com/blog2015/589642/201508/202203111751560.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;从出错的上面那个到这个正常运行的相信你看到区别了，我也已进行红色标记，既然上面的参数<span style="color:rgb(255,0,0);">@<span style="color:rgb(0,0,0);">符号不好使，我们用SqlParameter试试看：</span></span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>            <span style="color:rgb(0,0,255);line-height:1.5;">var</span> Name = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">xpy0928</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">;

            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> Age = <span style="color:rgb(128,0,128);line-height:1.5;">5</span><span style="line-height:1.5;">;

            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> sql = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">select ID, Name, Age from Student where Name = @Name and Age = @Age</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">;<br>
ctx.Database.SqlQuery</span>&lt;Student&gt;<span style="line-height:1.5;">(
                sql, 
                </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span> SqlParameter(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">@Name</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, Name),
                </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span> SqlParameter(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">@Age</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, Age));</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">结果运行正确，所以第一种出现的错误就是因为未使用SqlParameter，而该SqlParameter是继承自DbContext中的DbParameter通过下图可以看出：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images0.cnblogs.com/blog2015/589642/201508/202216019566005.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">至此我们总结出进行查询的两种方式：</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">通过使用参数如{0}语法来实现</h3> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">通过使用DbParameter子类并且使用@ParamateName语法来实现</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">&nbsp;sql语句查询非实体类型</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">通过sql语句我们能返回任意类型的实例包括类型！假设我们只查出学生表中（某一列）所有学生的Age（年龄），我们通过SqlQuery方法这样做：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>ctx.Database.SqlQuery&lt;<span style="color:rgb(0,0,255);line-height:1.5;">int</span>&gt;(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">select Age from Student</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>).ToList();</pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;我们通过快速监视查到返回Age的集合如下，如我们所期望：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images0.cnblogs.com/blog2015/589642/201508/202233185814733.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;从上述你是不是发现EF通过sql查询和ADO.NET查询数据库没什么区别呢？no，远不止于此，请继续往下看！</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);"> <span style="color:rgb(255,0,0);font-size:18pt;">*</span><span style="color:rgb(255,0,0);">通过存储过程加载实体</span> </h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">我们可以加载实体通过存储过程获得的结果。例如：我们获得所有的学生列表，可以进行如下操作:</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>ctx.Database.SqlQuery&lt;Student&gt;(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">dbo.GetList</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>).ToList();</pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">如此将执行数据库中名为&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">GetList()</span>&nbsp;的存储过程，就是这么简单！似乎没什么特别的，你会想还不如用sql语句查询了，其实远不止于此，上述给的例子是无参数，如果我们需要参数呢？<span style="font-size:16px;color:rgb(255,0,0);">假设我们要获得Age(年龄)等于5的所有人的姓名和年龄，那么该如何实现呢？</span></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;我们一步一步实现：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">先创建要调用的存储过程GetList</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;">CREATE</span> <span style="color:rgb(0,0,255);line-height:1.5;">PROCEDURE</span> [dbo].[GetList]
    @Age INT
AS
BEGIN
    <span style="color:rgb(0,0,255);line-height:1.5;">SELECT</span> ID, Name, Age <span style="color:rgb(0,0,255);line-height:1.5;">FROM</span> dbo.Student WHERE Age </span>=<span style="line-height:1.5;"> @Age
END<br><br><span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;">/*查询出的所有列必须对应返回实体中的所有字段，缺一不可，否则报错*/</span></span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">EF上下文调用存储过程：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre> <span style="color:rgb(0,0,255);line-height:1.5;">var</span> param = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> SqlParameter(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Age</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(128,0,128);line-height:1.5;">5</span><span style="line-height:1.5;">);

 </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> list = ctx.Database.SqlQuery&lt;Student&gt;(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">dbo.GetList @Age</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, param).ToList();</pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">运行结果如预期一样！【注意】在调用存储过程中，如果数据库是Sql 2005要在存储过程名称前加上&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(255,0,0);font-family:'Courier New';font-size:18px;">EXEC</span>&nbsp;<span style="color:rgb(255,0,0);">&nbsp;</span><span style="color:rgb(255,0,0);"><span style="color:rgb(0,0,0);">，否则报错。</span></span></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><span style="font-size:16px;color:rgb(255,0,0);">那么问题又来了，如果要输出参数的值，那么该如何操作呢？&nbsp;</span></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">假设要通过学生名字(Name)来进行分页，此时还要获得数据总条数。于是我们进行下面操作：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">第一步：创建要调用存储过程</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="line-height:1.5;">CREATE PROCEDURE [dbo].[Myproc]
    @Name NVARCHAR(max),
    @PageIndex </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;">,
    @PageSize INT,
    @TotalCount </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> OUTPUT
</span><span style="color:rgb(0,0,255);line-height:1.5;">as</span><span style="line-height:1.5;"> 

    declare @startRow </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;">
    declare @endRow    </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span>
    
    <span style="color:rgb(0,0,255);line-height:1.5;">set</span> @startRow = (@PageIndex - <span style="color:rgb(128,0,128);line-height:1.5;">1</span>) * @PageSize + <span style="color:rgb(128,0,128);line-height:1.5;">1</span>
    <span style="color:rgb(0,0,255);line-height:1.5;">set</span> @endRow = @startRow + @PageSize - <span style="color:rgb(128,0,128);line-height:1.5;">1</span>
    
    <span style="color:rgb(0,0,255);line-height:1.5;">select</span> *<span style="line-height:1.5;">
    FROM
    (
        </span><span style="color:rgb(0,0,255);line-height:1.5;">select</span><span style="line-height:1.5;"> top (@endRow)
           ID,
            Age,
            Name,
            row_number() over(order by [ID] desc) </span><span style="color:rgb(0,0,255);line-height:1.5;">as</span><span style="line-height:1.5;"> [RowIndex]
        </span><span style="color:rgb(0,0,255);line-height:1.5;">from</span><span style="line-height:1.5;"> dbo.Student
    ) </span><span style="color:rgb(0,0,255);line-height:1.5;">as</span><span style="line-height:1.5;"> T    
    </span><span style="color:rgb(0,0,255);line-height:1.5;">where</span> [RowIndex] &gt;= @startRow AND T.Name =<span style="line-height:1.5;"> @Name
    
    SET @TotalCount</span>=(<span style="color:rgb(0,0,255);line-height:1.5;">select</span> count(<span style="color:rgb(128,0,128);line-height:1.5;">1</span>) <span style="color:rgb(0,0,255);line-height:1.5;">as</span><span style="line-height:1.5;"> N 
    FROM dbo.Student WHERE Name </span>= @Name) </pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">EF上下文调用存储过程：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>            <span style="color:rgb(0,0,255);line-height:1.5;">var</span> name = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> SqlParameter { ParameterName = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Name</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, Value =<span style="line-height:1.5;"> Name };
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> currentpage = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> SqlParameter { ParameterName = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">PageIndex</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, Value =<span style="line-height:1.5;"> currentPage };
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> pagesize = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> SqlParameter { ParameterName = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">PageSize</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, Value =<span style="line-height:1.5;"> pageSize };
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> totalcount = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> SqlParameter { ParameterName = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">TotalCount</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, Value = <span style="color:rgb(128,0,128);line-height:1.5;">0</span>, <span style="color:rgb(255,0,0);line-height:1.5;">Direction =</span><span style="line-height:1.5;"><span style="color:rgb(255,0,0);line-height:1.5;"> ParameterDirection.Output</span> };

            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> list = ctx.Database.SqlQuery&lt;Student&gt;(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Myproc @Name, @PageIndex, @PageSize, @TotalCount <span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;">output</span></span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
        name, currentpage, pagesize, totalcount);

            totalCount </span>= (<span style="color:rgb(0,0,255);line-height:1.5;">int</span>)totalcount.Value;  <span style="color:rgb(255,0,0);line-height:1.5;">/*获得要输出参数totalcount的值*/</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">【注意】此时要在要输出的输出参数标记为output。见如图红色标记。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><span style="font-size:16px;color:rgb(255,0,0);">那么问题来了，当通过存储过程查询大量数据时，此时查询出的数据未进行跟踪（由上已知），因为我们要进行后续如删除之类的操作，所以要EF上下文来进行跟踪，我们应该如何操作来提升最大的性能呢？</span></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">我们可以对存储过程进行封装，并且可以简化调用存储过程同时提高查询的性能，请看如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>        <span style="color:rgb(0,0,255);line-height:1.5;">public</span> IList&lt;TEntity&gt; ExecuteStoredProcedureList&lt;TEntity&gt;(<span style="color:rgb(0,0,255);line-height:1.5;">string</span> commandText, <span style="color:rgb(0,0,255);line-height:1.5;">params</span> <span style="color:rgb(0,0,255);line-height:1.5;">object</span>[] parameters) <span style="color:rgb(0,0,255);line-height:1.5;">where</span> TEntity : <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;">
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (parameters != <span style="color:rgb(0,0,255);line-height:1.5;">null</span> &amp;&amp; parameters.Length &gt; <span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">)
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">for</span> (<span style="color:rgb(0,0,255);line-height:1.5;">int</span> i = <span style="color:rgb(128,0,128);line-height:1.5;">0</span>; i &lt;= parameters.Length - <span style="color:rgb(128,0,128);line-height:1.5;">1</span>; i++<span style="line-height:1.5;">)
                {
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> p = parameters[i] <span style="color:rgb(0,0,255);line-height:1.5;">as</span><span style="line-height:1.5;"> DbParameter;
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (p == <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">)
                        </span><span style="color:rgb(0,0,255);line-height:1.5;">throw</span> <span style="color:rgb(0,0,255);line-height:1.5;">new</span> Exception(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Not support parameter type</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);

                    commandText </span>+= i == <span style="color:rgb(128,0,128);line-height:1.5;">0</span> ? <span style="color:rgb(128,0,0);line-height:1.5;">"</span> <span style="color:rgb(128,0,0);line-height:1.5;">"</span> : <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">, </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">;

                    commandText </span>+= <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">@</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> +<span style="line-height:1.5;"> p.ParameterName;
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (p.Direction == ParameterDirection.InputOutput || p.Direction ==<span style="line-height:1.5;"> ParameterDirection.Output)
                    {

                        commandText </span>+= <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;"> output</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">;
                    }
                }
            }

            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> result = <span style="color:rgb(0,0,255);line-height:1.5;">this</span>.Database.SqlQuery&lt;TEntity&gt;<span style="line-height:1.5;">(commandText, parameters).ToList();

 
            </span><span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;">bool acd = this.Configuration.AutoDetectChangesEnabled;
            
            try
            {
                this.Configuration.AutoDetectChangesEnabled = false;

                <span style="color:rgb(0,0,0);font-size:12px;line-height:1.5;">for (int i = 0; i &lt; result.Count; i++) result[i] = this.Set&lt;TEntity&gt;().Attach(result[i]);</span>
            }
            finally
            {
                this.Configuration.AutoDetectChangesEnabled = acd;
            }

            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> result;
        }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">此时存储过程名称后面就无需继续填写存储过程中如@参数了，调用如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>  <span style="color:rgb(0,0,255);line-height:1.5;">var</span> list = ctx.ExecuteStoredProcedureList&lt;Student&gt;(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Myproc</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, pageindex, pagesize, totalcount);</pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">只是做了个简化而已，最关键的是性能上的提高（就是上述红色标记的地方，如果不明白可以参考我有关【我为EF正名】这篇文章），做了下实际测试，当查询10000条数据时，如果不用红色标记，直接将其附加到上下文容器中，则需要如下时间（单位是毫秒）</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images0.cnblogs.com/blog2015/589642/201508/281616262343979.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">当添加后，只需如下时间：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images0.cnblogs.com/blog2015/589642/201508/281617071566780.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">第一个和第二个我们分别按照399秒和3秒来算的话，也就是133倍，可想而知，我们仅仅只是一个小的操作，就达到如此大的性能的提升。通过实际测验，如果你现在还担心EF性能的问题，那我也默默无语了，只要你恰当的运用而不是滥用一通。</p> 
   <blockquote style="border:2px solid rgb(239,239,239);color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;background-image:none;">
    <pre><span style="font-size:16px;color:rgb(255,0,0);">对于SqlQuery无论是实体还是非实体抑或存储过程查询都存在一定的局限性。因为很容易会出现数据读取器与指定的实体类不兼容，该类型中缺少的成员在同名的数据读取器中没有对应的列，也就是说必须查出该实体中所有字段即映射到数据库中所有列。</span></pre>
   </blockquote> 
   <h1 style="font-size:28px;line-height:1.5;font-family:'Helvetica Neue', Arial;">非查询命令ExecuteSqlCommand&nbsp;</h1> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">该查询主要是针对非查询的命令如删除（delete） 、修改（update）等，其操作方式和上述SqlQuery一样。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">【注意】用此方法对数据库作出的任何的更改，直到实体从数据库中被加载或重新加载，否则此更改对于EF上下文是不透明的。</p> 
   <blockquote style="border:2px solid rgb(239,239,239);color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;background-image:none;"> 
    <p><span style="font-size:16px;color:rgb(255,0,0);">SqlQuery和ExecuteSqlCommand方法主要区别：SqlQuery返回实体数据或者集合数据，而ExecuteSqlCommand是非查询命令，所以只是返回删除（delete）和更新（update）以及插入（insert）是否成功或者失败的状态码。</span></p> 
   </blockquote> 
   <h1 style="font-size:28px;line-height:1.5;font-family:'Helvetica Neue', Arial;">为什么要使用DbContext而不使用ObjectContext</h1> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">DbContext是比较新的API，它其中简单的API被设计的是如此的巧妙，对于开发者来说无疑是一次全新的体验，但是如果你想要使用更加复杂的特性时，这时你不得不从DbContext中来获得ObjectContext并且使用旧的API。并且ADO.NET团队也建议使用越来越受欢迎的DbContext。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">EF 4.x生成器创建了更多复杂的类，但是在内部其利用了关系修正，但是此特性却被证明当和延迟加载一起使用时却是相当的低效，所以新的DbContext生成器不再使用那。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">所以基于上述描述，ObjectContext未被完全抛弃，它们完全是可以相互进行转换的。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">因此在代码上从一个API到另一个的转换也是完全支持的。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">（1）db=&gt;ob（通过IObjectContextAdapter中的Adapter从DbContext迁移至ObjectContext）</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre> <span style="color:rgb(0,0,255);line-height:1.5;">var</span> context = ((IObjectContextAdapter)ctx).ObjectContext;</pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">（2）ob=&gt;db（通过DbContext的构造器中的ObjectContext来创建一个新的DbContext上下文实例）</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre><span style="line-height:1.5;"> ObjectContext ob;
 </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> context = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> DbContext(ob, <span style="color:rgb(0,0,255);line-height:1.5;">true</span>);</pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">例如在EF 4.x版本中的ObjectContext中使用编译查询（<code>CompiledQuery</code>）来提高查询性能（因为在Linq To Entity使用Linq，EF需要解析表达式树并将其转换为SQL，所以当需要多次查询时可以使用编译查询来保存输出），该编译查询不兼容DbContext。如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>               Func&lt;EntityDbContext,<span style="color:rgb(0,0,255);line-height:1.5;">string</span>,IQueryable&lt;Student&gt;&gt; query= <br><span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;"> CompiledQuery.Compile</span>&lt;EntityDbContext,<span style="color:rgb(0,0,255);line-height:1.5;">string</span>,IQueryable&lt;Student&gt;&gt;<span style="line-height:1.5;">
                       ((EntityDbContext ctx,</span><span style="color:rgb(0,0,255);line-height:1.5;">string</span> property)=&gt;
                             <span style="color:rgb(0,0,255);line-height:1.5;">from</span> o <span style="color:rgb(0,0,255);line-height:1.5;">in</span> ctx.Set&lt;Student&gt;().ToList() <span style="color:rgb(0,0,255);line-height:1.5;">where</span> o.Name == property <span style="color:rgb(0,0,255);line-height:1.5;">select</span><span style="line-height:1.5;"> o 
                       );

               </span><span style="color:rgb(0,0,255);line-height:1.5;">foreach</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> item <span style="color:rgb(0,0,255);line-height:1.5;">in</span> query(EntityDbContext,<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">xpy0928</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">)
               {
                   Console.WriteLine(item.Name);
               }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">当然使用编译查询也有诸多限制，比如说此查询执行至少不止一次，并且仅仅是参数不同而已等等。</p> 
   <h1 style="font-size:28px;line-height:1.5;font-family:'Helvetica Neue', Arial;">性能优化</h1> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">（1）AsNoTracking</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">前几篇文章也已涉及到关于变更追踪的问题，如果当从数据库查出数据后并对其数据进行相应的更改，此时可以通过局部关闭变更追踪以及手动更改其状态达到一点点小小的优化。如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>                <span style="color:rgb(0,0,255);line-height:1.5;">var</span> list = ctx.Set&lt;Student&gt;<span style="line-height:1.5;">().<span style="font-size:16px;color:rgb(255,102,0);line-height:1.5;">AsNoTracking()</span>.ToList();

                </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> entity = list.Last(d =&gt; d.Name == <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">0928</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);<br></span><span style="line-height:1.5;">             
                ctx.Set&lt;Student&gt;().<span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;">Attach</span>(entity);<br>
entity.Name </span>= <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">xpy0928</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">;

                ctx.<span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;">Entry</span>(entity).State </span>=<span style="line-height:1.5;"><span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;"> EntityState.Modified</span>;

                ctx.SaveChanges();<br><br><span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;"> /*</span><br><span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;"> 先关闭追踪，然后对其实体数据进行修改，然后Attach附加到到上下文中，并通过Entry方法更改其为修改状态，最后调用SaveChanges检测其已被修改，更新数据到数据库 <br> */<br><br></span></span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">AsNoTracking补充</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">在此感谢园友<a href="http://www.cnblogs.com/liunianmoshi/" rel="nofollow" style="text-decoration:none;color:rgb(45,161,45);">流年莫逝</a>，经其提示，上述当关闭追踪时，进行修改后，无需利用Attach附加到上下文中，因为通过Entry方法就已经添加到上下文中（因为调用DetectChanges方法），所以上述&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">ctx.Set&lt;Student&gt;().Attach(entity);</span>&nbsp;是多此一举，此句略去。后经过尝试，总结如下：</p> 
   <blockquote style="border:2px solid rgb(239,239,239);color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;background-image:none;"> 
    <p><span style="font-size:16px;color:rgb(255,0,0);">当【修改】时无论是否关闭局部追踪，都无需利用Attach来进行附加到上下文中只需通过Entry方法修改其为修改状态（Modified）即可，但是当【删除】时如果关闭局部追踪，此时必须通过Attach来附加到上下文中并通过Entry方法标记为删除状态（Deleted），当然你也可以先将其标记为删除状态然后进行删除即可，也无需附加，而如果未关闭局部追踪则无需通过Attach附加到上下文只需通过Entry方法标记为删除状态（Deleted）。</span></p> 
   </blockquote> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">若关闭局部追踪并进行删除未利用Attach附加到上下文中，此时报错如下,，在ObjectStateManager里对象未被找到，所以无法检测到对象。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201509/589642-20150902164312763-2057118023.png" alt="" style="border:0px;"></p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">（2）AsNonUnicode</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;我们执行如下语句，并用SqlProfiler监控其SQL：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">var</span> query = ctx.Set&lt;Student&gt;().Where(d =&gt; d.Name == “Recluse_Xpy”).ToList();</pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">生成的SQL语句如下:</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201508/589642-20150829150555656-1379816454.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">接下来我们这样操作，再看看生成的SQL语句:</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre><span style="color:rgb(0,0,255);line-height:1.5;"> var</span> query = ctx.Set&lt;Student&gt;().Where(d =&gt; d.Name == <span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;">EntityFunctions.AsNonUnicode</span>("Recluse_Xpy")).ToList();</pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">其生成的SQL语句如下：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201508/589642-20150829152052906-1772605374.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">相信你也看出其中生成的SQL语句区别了，一个加了N，一个未加N，都知道N是将字符串作为Unicode格式进行存储。因为.Net字符串是Unicode格式，在上述SQL的Where子句中当一侧有N型而另一侧没有N型时，此时会进行数据转换，也就是说如果你在表中建立了索引此时会失效代替的是造成全表扫描。用&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(255,0,0);font-family:'Courier New';font-size:16px;">EntityFunctions.AsNonUnicode</span>&nbsp;方法来告诉.Net 将其作为一个非Unicode来对待，此时生成的SQL语句两侧都没有N型，就不会进行更多的数据转换，也就是说不会造成更多的全表扫描。所以当有大量数据时如果不进行转换会造成意想不到的结果，因此在进行字符串查找或者比较时建议用AsNonUnicode()方法来提高查询性能。</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">AsNonUnicode补充及注意</h2> 
   <blockquote style="border:2px solid rgb(239,239,239);color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;background-image:none;"> 
    <p><span style="color:rgb(255,0,0);"><span style="color:rgb(0,0,0);"><span>在此感谢园友<a href="http://www.cnblogs.com/mpguard/" rel="nofollow" style="text-decoration:none;color:rgb(45,161,45);">筱伯</a>，经其提示我也才发现&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(255,0,0);font-family:'Courier New';font-size:16px;">AsNonUnicode</span>&nbsp;已经被弃用，当敲代码时查看其方法便有提示此方法已经被否决，现已用&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(255,0,0);font-family:'Courier New';font-size:16px;">DbFunctions</span>&nbsp;方法来代替，请注意！</span><br></span></span></p> 
   </blockquote> 
   <h1 style="font-size:28px;line-height:1.5;font-family:'Helvetica Neue', Arial;"><span style="color:rgb(255,0,0);">*小心EF 6.1字符串尾随空格问题</span></h1> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">当比较字符串时SQL Server会自动忽略空格，但是在.NET中尤其是在EF中却不会忽略空格，例如“1234 &nbsp; ”和“1234”在SQL Server中会被认为是相等的，但是在EF中因为<span style="font-size:16px;color:rgb(255,0,0);">关系修正</span>却不会忽略空格。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">对于上述问题我们最好是通过一个示例来进行演示以此来加深理解并去解决它。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">假设场景：一朵小红花（Flower）对应多个学生(Student)，但是这个小红花肯定只会被一个学生拿走也就只对应一个学生（<span style="font-size:16px;color:rgb(255,0,0);">两个类都用字符串作为主键</span>）。鉴于此，我们给出如下类，并给出相应的映射。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">小红花类：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> Flower
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">string</span> Id { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">string</span> Remark { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> ICollection&lt;Student&gt; Students { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">学生类：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> Student
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">string</span> Id { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">string</span> Name { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">string</span> FlowerId { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> Flower Flower { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }
     
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">映射类：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">    public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span> StudentMap : EntityTypeConfiguration&lt;Student&gt;<span style="line-height:1.5;">
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> StudentMap()
        {
            ToTable(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Student</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
            HasKey(key </span>=&gt;<span style="line-height:1.5;"> key.Id);
            HasRequired(p </span>=&gt; p.Flower).WithMany(p =&gt; p.Students).HasForeignKey(p =&gt;<span style="line-height:1.5;"> p.FlowerId);

        }

    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;接下来我们插入数据进行测试：（在Flower类上的主键值Id有尾随空格但是在Student类的外键值FlowerId没有尾随空格）</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>               ctx.Set&lt;Flower&gt;().Add(<span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> Flower()
                {
                   <span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;"> Id </span></span><span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;">= "flowerId    "</span><span style="line-height:1.5;"><span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;">,</span>
                    Remark </span>= <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">so bad</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">

                });


                ctx.Set</span>&lt;Student&gt;().Add(<span style="color:rgb(0,0,255);line-height:1.5;">new</span> Student() { Id = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">xpy0928</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, FlowerId = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">flowerId</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, Name = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">xpy0928 study ef</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> });
                ctx.Set</span>&lt;Student&gt;().Add(<span style="color:rgb(0,0,255);line-height:1.5;">new</span> Student() { Id = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">xpy0929</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, FlowerId = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">flowerId</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, Name = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">xpy0929 study ef</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> });</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">接着我们进行打印插入的数据：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>                <span style="color:rgb(0,0,255);line-height:1.5;">var</span> flower = ctx.Set&lt;Flower&gt;().Include(p =&gt;<span style="line-height:1.5;"> p.Students).ToList();

                Console.WriteLine(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">小花在内存中的数量</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> + ctx.Set&lt;Flower&gt;<span style="line-height:1.5;">().Local.Count);
                Console.WriteLine(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">学生在内存中的数量</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> + ctx.Set&lt;Student&gt;<span style="line-height:1.5;">().Local.Count);
                Console.WriteLine(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">学生在小花的外键导航属性的数量</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> + flower[<span style="color:rgb(128,0,128);line-height:1.5;">0</span>].Students.Count);</pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">什么情况，结果告诉我们出错了，如下：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201508/589642-20150830214729281-1613681468.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">此时我们将上述红色标记尾随空格去掉，再进行测试，结果如下，如我们预期一样：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201508/589642-20150830220740609-365820804.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">出现有错误的结果就是我们要说的问题。当我们从数据库中查询插入的所有Student和Flower时，此时如我们预期的一样，成功的返回了数据，因为数据库此时忽略上述红色标记的空格。但是在Flower上的导航属性Student却没有成功的被填充进来，因为EF不会忽略空格所以值也就无法进行匹配。我们简单的将此问题进行描述如下</p> 
   <blockquote style="border:2px solid rgb(239,239,239);color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;background-image:none;"> 
    <p><span style="font-size:16px;color:rgb(255,0,0);">&nbsp;EF实体框架在内存中的语义为【关系修正(Relationship FixUp)】，当进行匹配时，在关系修正的过程中EF主要着眼于主键和外键的值以及填充导航属性，但是其就在处理字符串尾随空格的执行方式上与SQL Server不同。</span></p> 
   </blockquote> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;既然问题已经很明显了，我们接下来的工作就是去解决。之前系列文章中讲过监听者，我们可以在查询之前利用监听者（或者说叫拦截者）来进行解决。</p> 
   <blockquote style="border:2px solid rgb(239,239,239);color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;background-image:none;"> 
    <p><span style="font-size:16px;color:rgb(255,0,0);">无需对数据库或者对现有的代码进行改造，在EF 6.1中利用监听者（拦截器）和公开构造的查询树来进行解决。</span></p> 
   </blockquote> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;下面是EF在查询之前进行操作来忽略尾随空格的代码</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">    public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> EFConfiguration : DbConfiguration
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> EFConfiguration()
        {
            AddInterceptor(</span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> StringTrimmerInterceptor());
        }
    }
    </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> StringTrimmerInterceptor : IDbCommandTreeInterceptor
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> TreeCreated(DbCommandTreeInterceptionContext interceptionContext)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (interceptionContext.OriginalResult.DataSpace ==<span style="line-height:1.5;"> DataSpace.SSpace)
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> queryCommand = interceptionContext.Result <span style="color:rgb(0,0,255);line-height:1.5;">as</span><span style="line-height:1.5;"> DbQueryCommandTree;
                </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (queryCommand != <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">)
                {
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> newQuery = queryCommand.Query.Accept(<span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> StringTrimmerQueryVisitor());
                    interceptionContext.Result </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> DbQueryCommandTree(
                        queryCommand.MetadataWorkspace,
                        queryCommand.DataSpace,
                        newQuery);
                }
            }
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> StringTrimmerQueryVisitor : DefaultExpressionVisitor
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">readonly</span> <span style="color:rgb(0,0,255);line-height:1.5;">string</span>[] _typesToTrim = { <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">nvarchar</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">varchar</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">char</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">nchar</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> };

            </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">override</span><span style="line-height:1.5;"> DbExpression Visit(DbNewInstanceExpression expression)
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> arguments = expression.Arguments.Select(a =&gt;<span style="line-height:1.5;">
                {
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> propertyArg = a <span style="color:rgb(0,0,255);line-height:1.5;">as</span><span style="line-height:1.5;"> DbPropertyExpression;
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (propertyArg != <span style="color:rgb(0,0,255);line-height:1.5;">null</span>&amp;&amp;<span style="line-height:1.5;"> _typesToTrim.Contains(propertyArg.Property.TypeUsage.EdmType.Name))
                    {
                        </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> EdmFunctions.Trim(a);
                    }
 
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> a;
                });
 
                </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> DbExpressionBuilder.New(expression.ResultType, arguments);
            }
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">上述就是对根表达树进行遍历来获得其属性，再将其含有字符串的除去尾随空格，然后让其监听者去执行我们修改过的命令，最后只需将监听者（或者说是拦截器）进行注册即可。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">结果运行正常：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201508/589642-20150830225022734-2146129718.png" alt="" style="border:0px;"></p> 
   <h1 style="font-size:28px;line-height:1.5;font-family:'Helvetica Neue', Arial;">补充：实体各个状态（EntityState）以及使用</h1> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">EntityState&nbsp;</h2> 
   <ul style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">
    <li style="list-style:disc inside;">Added:实体被上下文追踪，但是在数据库中不存在</li> 
    <li style="list-style:disc inside;">Unchanged:实体被上下文追踪，在数据库中存在，并且从数据库中获取的属性值未发生改变</li> 
    <li style="list-style:disc inside;">Modified:实体被上下文追踪，在数据库中存在，并且其部分或者全部属性值已经被修改</li> 
    <li style="list-style:disc inside;">Deleted:实体被上下文追踪，在数据库中存在，但是当下一次SaveChanges被调用时，已经被标记为删除</li> 
    <li style="list-style:disc inside;">Detached:实体不会被上下文追踪</li> 
   </ul>
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">添加（Add）一个实体到上下文</h2> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">方法一</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> context = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> BloggingContext()) 
{ 
    </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> blog = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> Blog { Name = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ADO.NET Blog</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> }; 
  <span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;"> context.Blogs.Add(blog); </span>
    context.SaveChanges(); 
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">此实体通过DbSet中的Add方法被添加到上下文中，此时实体状态将为Added State，也就意味着当SaveChanges被调用的时候，该实体会插入到数据库中。</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">方法二</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> context = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> BloggingContext()) 
{ 
    </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> blog = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> Blog { Name = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ADO.NET Blog</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> }; 
    <span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;">context.Entry(blog).State </span></span><span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;">=</span><span style="line-height:1.5;"><span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;"> EntityState.Added;</span> 
    context.SaveChanges(); 
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">直接通过Entry方法来设置其状态为Added状态。&nbsp;</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">附加（Attach&nbsp;）已存在实体到上下文</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">如果一个实体总是存在数据库中，但是没有被上下文所追踪，所以此时需要通过DbSet上的Attach方法来跟踪该实体，然后该实体的状态为UnChanged。如下：</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">方法一</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">var</span> existingBlog = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> Blog { BlogId = <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, Name = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ADO.NET Blog</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> }; 
 
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> context = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> BloggingContext()) 
{ 
   <span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;"> context.Blogs.Attach(existingBlog); </span>
 
    context.SaveChanges(); 
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">【注意】当调用SaveChanges时如果没有对实体做任何操作，此时数据库数据不会有任何改变，因为此时实体状态为UnChanged。</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">方法二</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">直接通过Entry方法来更改其状态为UnChanged</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">var</span> existingBlog = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> Blog { BlogId = <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, Name = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ADO.NET Blog</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> }; 
 
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> context = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> BloggingContext()) 
{ 
   <span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;"> context.Entry(existingBlog).State </span></span><span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;">=</span><span style="line-height:1.5;"><span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;"> EntityState.Unchanged; </span>
 
    context.SaveChanges(); 
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">【注意】如果附加到上文容器中的实体的引用到了其他实体没有被追踪，那么此时这些新的实体将也会被附加到上下文中，并且其状态为UnChanged</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">附加（Attach）一个已存在但是修改的实体到上下文</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">如果一个实体总是存在数据库中并且此时对该实体作了相应的修改，那么此时应该修改它的状态为Modified</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">var</span> existingBlog = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> Blog { BlogId = <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, Name = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ADO.NET Blog</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> }; 
 
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> context = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> BloggingContext()) 
{ 
   <span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;"> context.Entry(existingBlog).State </span></span><span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;">=</span><span style="line-height:1.5;"><span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;"> EntityState.Modified; </span>
 
    context.SaveChanges(); 
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">更改被追踪实体的状态&nbsp;</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">如果一个实体一直被上下文所追踪，可以改变其状态通过Entry来设置状态属性。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">var</span> existingBlog = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> Blog { BlogId = <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, Name = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ADO.NET Blog</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> }; 
 
</span><span style="color:rgb(0,0,255);line-height:1.5;">using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> context = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> BloggingContext()) 
{ 
   <span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;"> context.Blogs.Attach(existingBlog);</span>

    <span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;">context.Entry(existingBlog).State </span></span><span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;">=</span><span style="line-height:1.5;"><span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;"> EntityState.Unchanged; </span>
 
    context.SaveChanges(); 
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">【注意】虽然Add和Attach方法是用来追踪一个实体，但是也可以被用来改变实体的状态。例如，上述通过调用Attach方法将当前处于Added状态的实体更改为UnChanged状态</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p><font color="#111111"><span style="font-size:13px;line-height:23.4px;">本文转自Jeffcky博客园博客，原文链接：http://www.cnblogs.com/CreateMyself/p/4746258.html，如需转载请自行联系原作者</span></font></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
