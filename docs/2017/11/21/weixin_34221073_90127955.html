<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Spark MLlib协同过滤算法 « NotBeCN</title>
  <meta name="description" content="             算法说明    　　协同过滤（Collaborative Filtering，简称CF，WIKI上的定义是：简单来说是利用某个兴趣相投、拥有共同经验之群体的喜好来推荐感兴趣的资讯给使用者，个人透过合作的机制给予资讯相当程度的回应（如评分）并记录下来以达到过滤的目的，进而帮助别人筛选资讯，...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/21/weixin_34221073_90127955.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">Spark MLlib协同过滤算法</h1>
    <p class="post-meta">Nov 21, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <h3 style="font-size:16px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;"><span style="font-size:18pt;">算法说明</span></h3> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　协同过滤（Collaborative Filtering，简称CF，WIKI上的定义是：简单来说是利用某个兴趣相投、拥有共同经验之群体的喜好来推荐感兴趣的资讯给使用者，个人透过合作的机制给予资讯相当程度的回应（如评分）并记录下来以达到过滤的目的，进而帮助别人筛选资讯，回应不一定局限于特别感兴趣的，特别不感兴趣资讯的纪录也相当重要。</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　协同过滤常被应用于推荐系统。这些技术旨在补充用户—商品关联矩阵中所缺失的部分。</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　MLlib&nbsp;当前支持基于模型的协同过滤，其中用户和商品通过一小组隐性因子进行表达，并且这些因子也用于预测缺失的元素。MLLib&nbsp;使用交替最小二乘法（ALS） 来学习这些隐性因子。</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　用户对物品或者信息的偏好，根据应用本身的不同，可能包括用户对物品的评分、用户查看物品的记录、用户的购买记录等。其实这些用户的偏好信息可以分为两类：</p> 
   <ul style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style:disc;"> <strong>显式的用户反馈</strong>：这类是用户在网站上自然浏览或者使用网站以外，显式地提供反馈信息，例如用户对物品的评分或者对物品的评论。</li> 
    <li style="list-style:disc;"> <strong>隐式的用户反馈</strong>：这类是用户在使用网站是产生的数据，隐式地反映了用户对物品的喜好，例如用户购买了某物品，用户查看了某物品的信息，等等。</li> 
   </ul>
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　显式的用户反馈能准确地反映用户对物品的真实喜好，但需要用户付出额外的代价；而隐式的用户行为，通过一些分析和处理，也能反映用户的喜好，只是数据不是很精确，有些行为的分析存在较大的噪音。但只要选择正确的行为特征，隐式的用户反馈也能得到很好的效果，只是行为特征的选择可能在不同的应用中有很大的不同，例如在电子商务的网站上，购买行为其实就是一个能很好表现用户喜好的隐式反馈。</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　推荐引擎根据不同的推荐机制可能用到数据源中的一部分，然后根据这些数据，分析出一定的规则或者直接对用户对其他物品的喜好进行预测计算。这样推荐引擎可以在用户进入时给他推荐他可能感兴趣的物品。</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　MLlib目前支持基于协同过滤的模型，在这个模型里，用户和产品被一组可以用来预测缺失项目的潜在因子来描述。特别是我们实现交替最小二乘（ALS）算法来学习这些潜在的因子，在&nbsp;MLlib&nbsp;中的实现有如下参数：</p> 
   <ul style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style:disc;"> <strong>numBlocks</strong>是用于并行化计算的分块个数（设置为-1时 为自动配置）；</li> 
    <li style="list-style:disc;"> <strong>rank</strong>是模型中隐性因子的个数；</li> 
    <li style="list-style:disc;"> <strong>iterations</strong>是迭代的次数；</li> 
    <li style="list-style:disc;"> <strong>lambda</strong>是ALS&nbsp;的正则化参数；</li> 
    <li style="list-style:disc;"> <strong>implicitPrefs</strong>决定了是用显性反馈ALS&nbsp;的版本还是用隐性反馈数据集的版本；</li> 
    <li style="list-style:disc;"> <strong>alpha</strong>是一个针对于隐性反馈&nbsp;ALS&nbsp;版本的参数，这个参数决定了偏好行为强度的基准。</li> 
   </ul>
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　　　&nbsp;<img src="https://images2015.cnblogs.com/blog/855959/201704/855959-20170429200816225-620955892.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <h3 style="font-size:16px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;"><span style="font-size:18pt;">实例介绍</span></h3> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　在本实例中将使用协同过滤算法对GroupLens Research（http://grouplens.org/datasets/movielens/）提供的数据进行分析，该数据为一组从20世纪90年末到21世纪初由MovieLens用户提供的电影评分数据，这些数据中包括电影评分、电影元数据（风格类型和年代）以及关于用户的人口统计学数据（年龄、邮编、性别和职业等）。根据不同需求该组织提供了不同大小的样本数据，不同样本信息中包含三种数据：评分、用户信息和电影信息。</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　对这些数据分析进行如下步骤：</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　1.&nbsp;装载如下两种数据：</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　a)装载样本评分数据，其中最后一列时间戳除10的余数作为key，Rating为值；</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　b)装载电影目录对照表（电影ID-&gt;电影标题）</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　2.将样本评分表以key值切分成3个部分，分别用于训练&nbsp;(60%，并加入用户评分),&nbsp;校验&nbsp;(20%), and&nbsp;测试&nbsp;(20%)</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　3.训练不同参数下的模型，并再校验集中验证，获取最佳参数下的模型</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　4.用最佳模型预测测试集的评分，计算和实际评分之间的均方根误差</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　5.根据用户评分的数据，推荐前十部最感兴趣的电影（注意要剔除用户已经评分的电影）</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <h3 style="font-size:16px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;"><span style="font-size:18pt;">测试数据说明</span></h3> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　在MovieLens提供的电影评分数据分为三个表：评分、用户信息和电影信息，在该系列提供的附属数据提供大概6000位读者和100万个评分数据，具体位置为/data/class8/movielens/data目录下，对三个表数据说明可以参考该目录下README文档。</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong>　　1.</strong><strong>评分数据说明（ratings.data)</strong></p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　该评分数据总共四个字段，格式为UserID::MovieID::Rating::Timestamp，分为为用户编号：：电影编号：：评分：：评分时间戳，其中各个字段说明如下：</p> 
   <ul style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style:disc;">用户编号范围1~6040</li> 
    <li style="list-style:disc;">电影编号1~3952</li> 
    <li style="list-style:disc;">电影评分为五星评分，范围0~5</li> 
    <li style="list-style:disc;">评分时间戳单位秒</li> 
    <li style="list-style:disc;">每个用户至少有20个电影评分</li> 
   </ul>
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">使用的<strong><span style="color:rgb(255,0,0);">ratings.dat</span></strong>的数据样本如下所示：</p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>1::1193::5::978300760</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>1::661::3::978302109</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>1::914::3::978301968</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>1::3408::4::978300275</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>1::2355::5::978824291</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>1::1197::3::978302268</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>1::1287::5::978302039</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>1::2804::5::978300719</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong>　　2.</strong><strong>用户信息(users.dat)</strong></p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　用户信息五个字段，格式为UserID::Gender::Age::Occupation::Zip-code，分为为用户编号：：性别：：年龄：：职业::邮编，其中各个字段说明如下：</p> 
   <ul style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style:disc;">用户编号范围1~6040</li> 
    <li style="list-style:disc;">性别，其中M为男性，F为女性</li> 
    <li style="list-style:disc;">不同的数字代表不同的年龄范围，如：25代表25~34岁范围</li> 
    <li style="list-style:disc;">职业信息，在测试数据中提供了21中职业分类</li> 
    <li style="list-style:disc;">地区邮编</li> 
   </ul>
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">使用的<strong><span style="color:rgb(255,0,0);">users.dat</span></strong>的数据样本如下所示：</p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>1::F::1::10::48067</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>2::M::56::16::70072</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>3::M::25::15::55117</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>4::M::45::7::02460</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>5::M::25::20::55455</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>6::F::50::9::55117</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>7::M::35::1::06810</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>8::M::25::12::11413</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong>3.</strong><strong>电影信息(movies.dat)</strong></p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　电影数据分为三个字段，格式为MovieID::Title::Genres，分为为电影编号：：电影名：：电影类别，其中各个字段说明如下：</p> 
   <ul style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style:disc;">电影编号1~3952</li> 
    <li style="list-style:disc;">由IMDB提供电影名称，其中包括电影上映年份</li> 
    <li style="list-style:disc;">电影分类，这里使用实际分类名非编号，如：Action、Crime等</li> 
   </ul>
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">使用的movies.dat的数据样本如下所示：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>::Toy Story (<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1995</span>)::Animation|Children<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">s|Comedy</span>
<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">2</span>::Jumanji (<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1995</span>)::Adventure|Children<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">s|Fantasy</span>
<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">3</span>::Grumpier Old Men (<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1995</span>)::Comedy|<span style="font-size:12px;line-height:1.5;">Romance
</span><span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">4</span>::Waiting to Exhale (<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1995</span>)::Comedy|<span style="font-size:12px;line-height:1.5;">Drama
</span><span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">5</span>::Father of the Bride Part II (<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1995</span><span style="font-size:12px;line-height:1.5;">)::Comedy
</span><span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">6</span>::Heat (<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1995</span>)::Action|Crime|<span style="font-size:12px;line-height:1.5;">Thriller
</span><span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">7</span>::Sabrina (<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1995</span>)::Comedy|<span style="font-size:12px;line-height:1.5;">Romance
</span><span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">8</span>::Tom and Huck (<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1995</span>)::Adventure|Children<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">s</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　程序代码</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="font-size:12px;line-height:1.5;">import java.io.File
import scala.io.Source
import org.apache.log4j.{Level, Logger}
import org.apache.spark.SparkConf
import org.apache.spark.SparkContext
import org.apache.spark.SparkContext._
import org.apache.spark.rdd._
import org.apache.spark.mllib.recommendation.{ALS, Rating, MatrixFactorizationModel}

 

</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">object</span><span style="font-size:12px;line-height:1.5;"> MovieLensALS {
  def main(args: Array[String]) {<br></span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 屏蔽不必要的日志显示在终端上</span><span style="font-size:12px;line-height:1.5;">
    Logger.getLogger(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">org.apache.spark</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">).setLevel(Level.WARN)
    Logger.getLogger(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">org.eclipse.jetty.server</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">).setLevel(Level.OFF)

 
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (args.length != <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">2</span><span style="font-size:12px;line-height:1.5;">) {
      println(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Usage: /path/to/spark/bin/spark-submit --driver-memory 2g --class week7.MovieLensALS </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span> +
        <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">week7.jar movieLensHomeDir personalRatingsFile</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">)
      sys.exit(</span><span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">)

    }

 

    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 设置运行环境</span><span style="font-size:12px;line-height:1.5;">
    val conf </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> SparkConf().setAppName(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">MovieLensALS</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>).setMaster(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">local[4]</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">)
    val sc </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> SparkContext(conf)

 

    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 装载用户评分，该评分由评分器生成</span><span style="font-size:12px;line-height:1.5;">
    val myRatings </span>= loadRatings(args(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">))
    val myRatingsRDD </span>= sc.parallelize(myRatings, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">)

 

    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 样本数据目录</span><span style="font-size:12px;line-height:1.5;">
    val movieLensHomeDir </span>= args(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">)

 

    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 装载样本评分数据，其中最后一列Timestamp取除10的余数作为key，Rating为值,即(Int,Rating)</span><span style="font-size:12px;line-height:1.5;">
    val ratings </span>= sc.textFile(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> File(movieLensHomeDir, <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">ratings.dat</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>).toString).map { line =&gt;<span style="font-size:12px;line-height:1.5;">
      val fields </span>= line.split(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">::</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">)
      (fields(</span><span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">3</span>).toLong % <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">10</span>, Rating(fields(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>).toInt, fields(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>).toInt, fields(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">2</span><span style="font-size:12px;line-height:1.5;">).toDouble))
    }

 

    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 装载电影目录对照表（电影ID-&gt;电影标题）</span><span style="font-size:12px;line-height:1.5;">
    val movies </span>= sc.textFile(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> File(movieLensHomeDir, <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">movies.dat</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>).toString).map { line =&gt;<span style="font-size:12px;line-height:1.5;">
      val fields </span>= line.split(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">::</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">)
      (fields(</span><span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>).toInt, fields(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">))
    }.collect().toMap

 

    val numRatings </span>=<span style="font-size:12px;line-height:1.5;"> ratings.count()
    val numUsers </span>=<span style="font-size:12px;line-height:1.5;"> ratings.map(_._2.user).distinct().count()
    val numMovies </span>=<span style="font-size:12px;line-height:1.5;"> ratings.map(_._2.product).distinct().count()

 

    println(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Got </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span> + numRatings + <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;"> ratings from </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span> + numUsers + <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;"> users on </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span> + numMovies + <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;"> movies.</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">)

 

    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 将样本评分表以key值切分成3个部分，分别用于训练 (60%，并加入用户评分), 校验 (20%), and 测试 (20%)
    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 该数据在计算过程中要多次应用到，所以cache到内存</span><span style="font-size:12px;line-height:1.5;">
    val numPartitions </span>= <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">4</span><span style="font-size:12px;line-height:1.5;">
    val training </span>= ratings.filter(x =&gt; x._1 &lt; <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">6</span><span style="font-size:12px;line-height:1.5;">)
      .values
      .union(myRatingsRDD) </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">注意ratings是(Int,Rating)，取value即可</span><span style="font-size:12px;line-height:1.5;">
      .repartition(numPartitions)
      .cache()

    val validation </span>= ratings.filter(x =&gt; x._1 &gt;= <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">6</span> &amp;&amp; x._1 &lt; <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">8</span><span style="font-size:12px;line-height:1.5;">)
      .values
      .repartition(numPartitions)
      .cache()

    val test </span>= ratings.filter(x =&gt; x._1 &gt;= <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">8</span><span style="font-size:12px;line-height:1.5;">).values.cache()

 

    val numTraining </span>=<span style="font-size:12px;line-height:1.5;"> training.count()
    val numValidation </span>=<span style="font-size:12px;line-height:1.5;"> validation.count()
    val numTest </span>=<span style="font-size:12px;line-height:1.5;"> test.count()

 

    println(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Training: </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span> + numTraining + <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">, validation: </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span> + numValidation + <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">, test: </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span> +<span style="font-size:12px;line-height:1.5;"> numTest)<br></span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 训练不同参数下的模型，并在校验集中验证，获取最佳参数下的模型</span><span style="font-size:12px;line-height:1.5;">
    val ranks </span>= List(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">8</span>, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">12</span><span style="font-size:12px;line-height:1.5;">)
    val lambdas </span>= List(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0.1</span>, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">10.0</span><span style="font-size:12px;line-height:1.5;">)
    val numIters </span>= List(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">10</span>, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">20</span><span style="font-size:12px;line-height:1.5;">)

    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">var</span> bestModel: Option[MatrixFactorizationModel] =<span style="font-size:12px;line-height:1.5;"> None
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">var</span> bestValidationRmse =<span style="font-size:12px;line-height:1.5;"> Double.MaxValue
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">var</span> bestRank = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>
    <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">var</span> bestLambda = -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1.0</span>
    <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">var</span> bestNumIter = -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>
    <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span> (rank &lt;- ranks; lambda &lt;- lambdas; numIter &lt;-<span style="font-size:12px;line-height:1.5;"> numIters) {
      val model </span>=<span style="font-size:12px;line-height:1.5;"> ALS.train(training, rank, numIter, lambda)
      val validationRmse </span>=<span style="font-size:12px;line-height:1.5;"> computeRmse(model, validation, numValidation)
      println(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">RMSE (validation) = </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span> + validationRmse + <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;"> for the model trained with rank = </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>
        + rank + <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">, lambda = </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span> + lambda + <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">, and numIter = </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span> + numIter + <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">.</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">)
      </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (validationRmse &lt;<span style="font-size:12px;line-height:1.5;"> bestValidationRmse) {
        bestModel </span>=<span style="font-size:12px;line-height:1.5;"> Some(model)
        bestValidationRmse </span>=<span style="font-size:12px;line-height:1.5;"> validationRmse
        bestRank </span>=<span style="font-size:12px;line-height:1.5;"> rank
        bestLambda </span>=<span style="font-size:12px;line-height:1.5;"> lambda
        bestNumIter </span>=<span style="font-size:12px;line-height:1.5;"> numIter
      }
    }

 

    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 用最佳模型预测测试集的评分，并计算和实际评分之间的均方根误差</span><span style="font-size:12px;line-height:1.5;">
    val testRmse </span>= computeRmse(bestModel.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">get</span><span style="font-size:12px;line-height:1.5;">, test, numTest)

 

    println(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">The best model was trained with rank = </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span> + bestRank + <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;"> and lambda = </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span> + bestLambda  + <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">, and numIter = </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span> + bestNumIter + <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">, and its RMSE on the test set is </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span> + testRmse + <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">.</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">)

 

    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> create a naive baseline and compare it with the best model</span><span style="font-size:12px;line-height:1.5;">
    val meanRating </span>=<span style="font-size:12px;line-height:1.5;"> training.union(validation).map(_.rating).mean

    val baselineRmse </span>=<span style="font-size:12px;line-height:1.5;">

      math.sqrt(test.map(x </span>=&gt; (meanRating - x.rating) * (meanRating -<span style="font-size:12px;line-height:1.5;"> x.rating)).mean)

    val improvement </span>= (baselineRmse - testRmse) / baselineRmse * <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">100</span><span style="font-size:12px;line-height:1.5;">

    println(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">The best model improves the baseline by </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span> + <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">%1.2f</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>.format(improvement) + <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">%.</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">)

 

    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 推荐前十部最感兴趣的电影，注意要剔除用户已经评分的电影</span><span style="font-size:12px;line-height:1.5;">
    val myRatedMovieIds </span>=<span style="font-size:12px;line-height:1.5;"> myRatings.map(_.product).toSet
    val candidates </span>= sc.parallelize(movies.keys.filter(!<span style="font-size:12px;line-height:1.5;">myRatedMovieIds.contains(_)).toSeq)
    val recommendations </span>= bestModel.<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">get</span><span style="font-size:12px;line-height:1.5;">
      .predict(candidates.map((</span><span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">, _)))
      .collect()
      .sortBy(</span>-<span style="font-size:12px;line-height:1.5;">_.rating)
      .take(</span><span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">10</span><span style="font-size:12px;line-height:1.5;">)

 

    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">var</span> i = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">
    println(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Movies recommended for you:</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">)
    recommendations.</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">foreach</span> { r =&gt;<span style="font-size:12px;line-height:1.5;">
      println(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">%2d</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>.format(i) + <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">: </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span> +<span style="font-size:12px;line-height:1.5;"> movies(r.product))
      i </span>+= <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">
    }

 

  sc.stop()
  }

 

  </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">* 校验集预测数据和实际数据之间的均方根误差 *</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span><span style="font-size:12px;line-height:1.5;">
  def computeRmse(model: MatrixFactorizationModel, data: RDD[Rating], n: Long): Double </span>=<span style="font-size:12px;line-height:1.5;"> {
    val predictions: RDD[Rating] </span>= model.predict(data.map(x =&gt;<span style="font-size:12px;line-height:1.5;"> (x.user, x.product)))
    val predictionsAndRatings </span>= predictions.map(x =&gt;<span style="font-size:12px;line-height:1.5;"> ((x.user, x.product), x.rating))
      .join(data.map(x </span>=&gt;<span style="font-size:12px;line-height:1.5;"> ((x.user, x.product), x.rating)))
      .values
    math.sqrt(predictionsAndRatings.map(x </span>=&gt; (x._1 - x._2) * (x._1 - x._2)).reduce(_ + _) /<span style="font-size:12px;line-height:1.5;"> n)
  }

 

  </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">* 装载用户评分文件 *</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span><span style="font-size:12px;line-height:1.5;">
  def loadRatings(path: String): Seq[Rating] </span>=<span style="font-size:12px;line-height:1.5;"> {
    val lines </span>=<span style="font-size:12px;line-height:1.5;"> Source.fromFile(path).getLines()
    val ratings </span>= lines.map { line =&gt;<span style="font-size:12px;line-height:1.5;">
      val fields </span>= line.split(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">::</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">)
      Rating(fields(</span><span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>).toInt, fields(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>).toInt, fields(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">2</span><span style="font-size:12px;line-height:1.5;">).toDouble)
    }.filter(_.rating </span>&gt; <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0.0</span><span style="font-size:12px;line-height:1.5;">)
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span><span style="font-size:12px;line-height:1.5;"> (ratings.isEmpty) {
      sys.error(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">No ratings provided.</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">)
    } </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">else</span><span style="font-size:12px;line-height:1.5;"> {
      ratings.toSeq
    }
  }
}<br></span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　　　　　<img src="https://images2015.cnblogs.com/blog/855959/201704/855959-20170429201920819-9570322.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <h3 style="font-size:16px;line-height:1.5;font-family:Verdana, Arial, Helvetica, sans-serif;"><span style="font-size:18pt;">IDEA执行情况</span></h3> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　<span style="font-size:18px;"><strong>第一步&nbsp;&nbsp;&nbsp;使用如下命令启动Spark集群</strong></span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>$cd /app/hadoop/spark-<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1.1</span>.<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">
$sbin</span>/start-all.sh</pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong><span style="font-size:18px;">　　第二步&nbsp;&nbsp;&nbsp;进行用户评分，生成用户样本数据</span></strong></p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">　　由于该程序中最终推荐给用户十部电影，这需要用户提供对样本电影数据的评分，然后根据生成的最佳模型获取当前用户推荐电影。用户可以使用/home/hadoop/upload/class8/movielens/bin/rateMovies程序进行评分，最终生成personalRatings.txt文件：</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><img src="https://images2015.cnblogs.com/blog/855959/201704/855959-20170429202002631-895088219.png" alt="" style="border:0px;"></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong><span style="font-size:18pt;">第三步&nbsp;&nbsp;&nbsp;在IDEA中设置运行环境</span></strong></p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">在IDEA运行配置中设置MovieLensALS运行配置，需要设置输入数据所在文件夹和用户的评分文件路径：</p> 
   <ul style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style:disc;">输入数据所在目录：输入数据文件目录，在该目录中包含了评分信息、用户信息和电影信息，这里设置为/home/hadoop/upload/class8/movielens/data/</li> 
    <li style="list-style:disc;">&nbsp;用户的评分文件路径：前一步骤中用户对十部电影评分结果文件路径，在这里设置为/home/hadoop/upload/class8/movielens/personalRatings.txt</li> 
   </ul>
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="justify" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">第四步&nbsp;&nbsp;&nbsp;执行并观察输出</p> 
   <ul style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style:disc;">输出<em>Got 1000209 ratings from 6040 users on 3706 movies</em>，表示本算法中计算数据包括大概100万评分数据、6000多用户和3706部电影；</li> 
    <li style="list-style:disc;">输出Training: 602252, validation: 198919, test: 199049，表示对评分数据进行拆分为训练数据、校验数据和测试数据，大致占比为6:2:2；</li> 
    <li style="list-style:disc;">在计算过程中选择8种不同模型对数据进行训练，然后从中选择最佳模型，其中最佳模型比基准模型提供22.30%</li> 
   </ul>
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>RMSE (validation) = 0.8680885498009973 for the model trained with rank = 8, lambda = 0.1, and numIter = 10.</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>RMSE (validation) = 0.868882967482595 for the model trained with rank = 8, lambda = 0.1, and numIter = 20.</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>RMSE (validation) = 3.7558695311242833 for the model trained with rank = 8, lambda = 10.0, and numIter = 10.</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>RMSE (validation) = 3.7558695311242833 for the model trained with rank = 8, lambda = 10.0, and numIter = 20.</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>RMSE (validation) = 0.8663942501841964 for the model trained with rank = 12, lambda = 0.1, and numIter = 10.</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>RMSE (validation) = 0.8674684744165418 for the model trained with rank = 12, lambda = 0.1, and numIter = 20.</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>RMSE (validation) = 3.7558695311242833 for the model trained with rank = 12, lambda = 10.0, and numIter = 10.</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>RMSE (validation) = 3.7558695311242833 for the model trained with rank = 12, lambda = 10.0, and numIter = 20.</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>The best model was trained with rank = 12 and lambda = 0.1, and numIter = 10, and its RMSE on the test set is 0.8652326018300565.</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>The best model improves the baseline by 22.30%.</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <ul style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style:disc;">利用前面获取的最佳模型，结合用户提供的样本数据，最终推荐给用户如下影片：</li>
   </ul>
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>Movies recommended for you:</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>&nbsp;1: Bewegte Mann, Der (1994)</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>&nbsp;2: Chushingura (1962)</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>&nbsp;3: Love Serenade (1996)</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>&nbsp;4: For All Mankind (1989)</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>&nbsp;5: Vie est belle, La (Life is Rosey) (1987)</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>&nbsp;6: Bandits (1997)</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>&nbsp;7: King of Masks, The (Bian Lian) (1996)</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>&nbsp;8: I'm the One That I Want (2000)</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>&nbsp;9: Big Trees, The (1952)</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>10: First Love, Last Rites (1997)</em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em>　　　　　　　　<img src="https://images2015.cnblogs.com/blog/855959/201704/855959-20170429202127662-244616212.png" alt="" style="border:0px;"></em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em><br></em></p> 
   <p align="left" style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><em><br></em></p> 
   <p align="left"><em><font><span style="font-size:14px;">本文转自大数据躺过的坑博客园博客，原文链接：http://www.cnblogs.com/zlslch/p/6786159.html，如需转载请自行联系原作者</span></font><br></em></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
