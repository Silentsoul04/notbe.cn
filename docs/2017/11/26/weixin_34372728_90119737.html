<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>WebApiThrottle限流框架使用手册 « NotBeCN</title>
  <meta name="description" content="                  阅读目录：        介绍     基于IP全局限流     基于IP的端点限流     基于IP和客户端key的端点限流     IP和客户端key的白名单     IP和客户端key自定义限制频率     端点自定义限制频率     关于被拒请求的计数器     在we...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/26/weixin_34372728_90119737.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">WebApiThrottle限流框架使用手册</h1>
    <p class="post-meta">Nov 26, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p> </p> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;"><strong>阅读目录：</strong></p> 
   <ol style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">
    <li style="list-style-type:decimal;"><a style="color:rgb(61,129,238);text-decoration:none;" href="http://www.cnblogs.com/mushroom/p/4659200.html#one" rel="nofollow"><strong>介绍</strong></a></li> 
    <li style="list-style-type:decimal;"><a style="color:rgb(61,129,238);text-decoration:none;" href="http://www.cnblogs.com/mushroom/p/4659200.html#two" rel="nofollow"><strong>基于IP全局限流</strong></a></li> 
    <li style="list-style-type:decimal;"><a style="color:rgb(61,129,238);text-decoration:none;" href="http://www.cnblogs.com/mushroom/p/4659200.html#three" rel="nofollow"><strong>基于IP的端点限流</strong></a></li> 
    <li style="list-style-type:decimal;"><a style="color:rgb(61,129,238);text-decoration:none;" href="http://www.cnblogs.com/mushroom/p/4659200.html#four" rel="nofollow"><strong>基于IP和客户端key的端点限流</strong></a></li> 
    <li style="list-style-type:decimal;"><a style="color:rgb(61,129,238);text-decoration:none;" href="http://www.cnblogs.com/mushroom/p/4659200.html#five" rel="nofollow"><strong>IP和客户端key的白名单</strong></a></li> 
    <li style="list-style-type:decimal;"><a style="color:rgb(61,129,238);text-decoration:none;" href="http://www.cnblogs.com/mushroom/p/4659200.html#six" rel="nofollow"><strong>IP和客户端key自定义限制频率</strong></a></li> 
    <li style="list-style-type:decimal;"><a style="color:rgb(61,129,238);text-decoration:none;" href="http://www.cnblogs.com/mushroom/p/4659200.html#seven" rel="nofollow"><strong>端点自定义限制频率</strong></a></li> 
    <li style="list-style-type:decimal;"><a style="color:rgb(61,129,238);text-decoration:none;" href="http://www.cnblogs.com/mushroom/p/4659200.html#eight" rel="nofollow"><strong>关于被拒请求的计数器</strong></a></li> 
    <li style="list-style-type:decimal;"><a style="color:rgb(61,129,238);text-decoration:none;" href="http://www.cnblogs.com/mushroom/p/4659200.html#nine" rel="nofollow"><strong>在web.config或app.config中定义限制策略</strong></a></li> 
    <li style="list-style-type:decimal;"><a style="color:rgb(61,129,238);text-decoration:none;" href="http://www.cnblogs.com/mushroom/p/4659200.html#ten" rel="nofollow"><strong>获取API的客户端key</strong></a></li> 
    <li style="list-style-type:decimal;"><a style="color:rgb(61,129,238);text-decoration:none;" href="http://www.cnblogs.com/mushroom/p/4659200.html#eleven" rel="nofollow"><strong>存储限流的数据</strong></a></li> 
    <li style="list-style-type:decimal;"><a style="color:rgb(61,129,238);text-decoration:none;" href="http://www.cnblogs.com/mushroom/p/4659200.html#twelve" rel="nofollow"><strong>运行期间更新限制频率</strong></a></li> 
    <li style="list-style-type:decimal;"><a style="color:rgb(61,129,238);text-decoration:none;" href="http://www.cnblogs.com/mushroom/p/4659200.html#thirteen" rel="nofollow"><strong>限流的请求日志</strong></a></li> 
    <li style="list-style-type:decimal;"><a style="color:rgb(61,129,238);text-decoration:none;" href="http://www.cnblogs.com/mushroom/p/4659200.html#fourteen" rel="nofollow"><strong>用ThrottlingFilter、EnableThrottlingAttribute特性配置限制频率</strong></a></li> 
    <li style="list-style-type:decimal;"><a style="color:rgb(61,129,238);text-decoration:none;" href="http://www.cnblogs.com/mushroom/p/4659200.html#fifteen" rel="nofollow"><strong>关于ThrottlingMiddleware限制频率</strong></a></li> 
   </ol>
   <h2> <a name="one"></a>介绍</h2> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">为了防止网站意外暴增的流量比如活动、秒杀、攻击等，导致整个系统瘫痪，在前后端接口服务处进行流量限制是非常有必要的。本篇主要介绍下Net限流框架WebApiThrottle的使用。</p> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">WebApiThrottle是一个专门为webApi限制请求频率而设计的，支持寄宿OWIN上的中间件的限制过滤。服务端接口可以基于客户端请求IP地址、客户端请求key、及请求路由去限制webapi接口的访问频率。</p> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">使用nuget命令安装WebApiThrottle：</p> 
   <div style="font-size:12px;">
    <pre>PM&gt; Install-Package WebApiThrottle</pre>
   </div> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">Nuget地址：</p> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;"><a style="color:rgb(61,129,238);text-decoration:none;border-bottom-width:1px;border-bottom-style:dashed;" title="https://www.nuget.org/packages/WebApiThrottle/" href="https://www.nuget.org/packages/WebApiThrottle/" rel="nofollow">https://www.nuget.org/packages/WebApiThrottle/</a></p> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">WebApiThrottle支持自定义配置各种限流策略。可以根据不同场景配置多个不同的限制，比如授权某个IP每秒、每分钟、每小时、每天、每周的最大调用次数。 这些限制策略可以配置在所有请求上，也可以单独给每个API接口去配置。</p> 
   <h2> <a name="two"></a>基于IP全局限流</h2> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">下面的代码是限制来自同IP请求的最大次数。如果在一分钟内，同样IP的客户端分别调用api/values和api/values/1两个接口， 那么调用api/values/1的请求会被拒绝掉。</p> 
   <div style="font-size:12px;"> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> WebApiConfig {     </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> Register(HttpConfiguration config)     {         config.MessageHandlers.Add(</span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> ThrottlingHandler()         {             Policy </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> ThrottlePolicy(perSecond: <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, perMinute: <span style="color:rgb(128,0,128);line-height:1.5;">20</span>, perHour: <span style="color:rgb(128,0,128);line-height:1.5;">200</span>, perDay: <span style="color:rgb(128,0,128);line-height:1.5;">1500</span>, perWeek: <span style="color:rgb(128,0,128);line-height:1.5;">3000</span><span style="line-height:1.5;">)             {                 IpThrottling </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">             },             Repository </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> CacheRepository()         });     } }</span></pre> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">如果是自寄宿在Owin上的WebApi，上面的CacheRepository必须替换成运行时的MemoryCacheRepository类，因为CacheRepository使用的是Asp.net版本的缓存。</p> 
   <div style="font-size:12px;"> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> Startup {     </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> Configuration(IAppBuilder appBuilder)     {         </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;"> Configure Web API for self-host. </span>         HttpConfiguration config = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> HttpConfiguration();          </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">Register throttling handler</span>         config.MessageHandlers.Add(<span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> ThrottlingHandler()         {             Policy </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> ThrottlePolicy(perSecond: <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, perMinute: <span style="color:rgb(128,0,128);line-height:1.5;">20</span>, perHour: <span style="color:rgb(128,0,128);line-height:1.5;">200</span>, perDay: <span style="color:rgb(128,0,128);line-height:1.5;">1500</span>, perWeek: <span style="color:rgb(128,0,128);line-height:1.5;">3000</span><span style="line-height:1.5;">)             {                 IpThrottling </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">             },             Repository </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> MemoryCacheRepository()         });          appBuilder.UseWebApi(config);     } }</span></pre> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
   </div> 
   <h2> <a name="three"></a>基于IP的端点限流</h2> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">上面的api/values限流配置会对整个api/values开头的API限流，同一秒内、同一ip访问api/values后，所有后续访问api/values/xxx的请求都会被拒绝掉。 如果配置了端点限流，同一秒内你也访问api/values/1了，请求将不会被拒绝，因为它们走的是不同的路由。</p> 
   <div style="font-size:12px;"> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
    <pre>config.MessageHandlers.Add(<span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> ThrottlingHandler() {     Policy </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> ThrottlePolicy(perSecond: <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, perMinute: <span style="color:rgb(128,0,128);line-height:1.5;">30</span><span style="line-height:1.5;">)     {         IpThrottling </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">,         EndpointThrottling </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">     },     Repository </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> CacheRepository() });</span></pre> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
   </div> 
   <h2> <a name="four"></a>基于IP和客户端key的端点限流</h2> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">如果同一个ip的客户端，在同一秒内，调用了2次api/values，其最后一次的调用将会被拒绝掉。</p> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">如果想接口通过唯一key去识别限制客户端，忽略客户端的ip地址限制，应该配置IpThrottling为false。</p> 
   <div style="font-size:12px;"> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
    <pre>config.MessageHandlers.Add(<span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> ThrottlingHandler() {     Policy </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> ThrottlePolicy(perSecond: <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, perMinute: <span style="color:rgb(128,0,128);line-height:1.5;">30</span><span style="line-height:1.5;">)     {         IpThrottling </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">,         ClientThrottling </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">,         EndpointThrottling </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">     },     Repository </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> CacheRepository() });</span></pre> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
   </div> 
   <h2> <a name="five"></a>IP和客户端key的白名单</h2> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">如果请求是从一个白名单中的IP或客户端key发起的，那么限流策略将不会生效，这个请求的所有信息也不会被存储。 其IP白名单列表支持IP v4和v6的范围配置，比如"192.168.0.0/24", "fe80::/10" 和 "192.168.0.0-192.168.0.255"，关于IP范围的更多信息请查看<a style="color:rgb(61,129,238);text-decoration:none;border-bottom-width:1px;border-bottom-style:dashed;" title="https://github.com/jsakamoto/ipaddressrange" href="http://www.cnblogs.com/mushroom/p/4659200.html#five" rel="nofollow">https://github.com/jsakamoto/ipaddressrange</a></p> 
   <div style="font-size:12px;"> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
    <pre>config.MessageHandlers.Add(<span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> ThrottlingHandler() {     Policy </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> ThrottlePolicy(perSecond: <span style="color:rgb(128,0,128);line-height:1.5;">2</span>, perMinute: <span style="color:rgb(128,0,128);line-height:1.5;">60</span><span style="line-height:1.5;">)     {         IpThrottling </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">,         IpWhitelist </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> List&lt;<span style="color:rgb(0,0,255);line-height:1.5;">string</span>&gt; { <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">::1</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">192.168.0.0/24</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> },          ClientThrottling </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">,         ClientWhitelist </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> List&lt;<span style="color:rgb(0,0,255);line-height:1.5;">string</span>&gt; { <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">admin-key</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> }     },     Repository </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> CacheRepository() });</span></pre> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
   </div> 
   <h2> <a name="six"></a>IP和客户端key自定义限制频率</h2> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">你可以自定义基于ip或客户端key的请求频率限制，这些限制会重写WebApiThrottle的默认配置。</p> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">需要注意的是，这些自定义策略需要写到全局配置里才会生效，策略里可以单独给某个ip或某个key配置限流策略。</p> 
   <div style="font-size:12px;"> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
    <pre>config.MessageHandlers.Add(<span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> ThrottlingHandler() {     Policy </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> ThrottlePolicy(perSecond: <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, perMinute: <span style="color:rgb(128,0,128);line-height:1.5;">20</span>, perHour: <span style="color:rgb(128,0,128);line-height:1.5;">200</span>, perDay: <span style="color:rgb(128,0,128);line-height:1.5;">1500</span><span style="line-height:1.5;">)     {         IpThrottling </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">,         IpRules </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> Dictionary&lt;<span style="color:rgb(0,0,255);line-height:1.5;">string</span>, RateLimits&gt;<span style="line-height:1.5;">         {              { </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">192.168.1.1</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(0,0,255);line-height:1.5;">new</span> RateLimits { PerSecond = <span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;"> } },             { </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">192.168.2.0/24</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(0,0,255);line-height:1.5;">new</span> RateLimits { PerMinute = <span style="color:rgb(128,0,128);line-height:1.5;">30</span>, PerHour = <span style="color:rgb(128,0,128);line-height:1.5;">30</span>*<span style="color:rgb(128,0,128);line-height:1.5;">60</span>, PerDay = <span style="color:rgb(128,0,128);line-height:1.5;">30</span>*<span style="color:rgb(128,0,128);line-height:1.5;">60</span>*<span style="color:rgb(128,0,128);line-height:1.5;">24</span><span style="line-height:1.5;"> } }         },          ClientThrottling </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">,         ClientRules </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> Dictionary&lt;<span style="color:rgb(0,0,255);line-height:1.5;">string</span>, RateLimits&gt;<span style="line-height:1.5;">         {              { </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">api-client-key-1</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(0,0,255);line-height:1.5;">new</span> RateLimits { PerMinute = <span style="color:rgb(128,0,128);line-height:1.5;">40</span>, PerHour = <span style="color:rgb(128,0,128);line-height:1.5;">400</span><span style="line-height:1.5;"> } },             { </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">api-client-key-9</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(0,0,255);line-height:1.5;">new</span> RateLimits { PerDay = <span style="color:rgb(128,0,128);line-height:1.5;">2000</span><span style="line-height:1.5;"> } }         }     },     Repository </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> CacheRepository() });</span></pre> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
   </div> 
   <h2> <a name="seven"></a>端点自定义限制频率</h2> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">你也可以为明确的路由地址去自定义限制频率，这些限制配置会重写WebApiThrottle的默认配置。也可以通过相关联的路由地址去定义端点的限制规则，比如api/entry/1端点的请求仅仅是/entry/整个路由地址请求的一部分。 配置后，端点限制引擎会在请求的绝对URI中去搜索这个表达式(api/entry/1)，如果这个表达式在请求路由策略中被找到，那么这个限制规则将会被应用。如果有两个或更多的限制规则匹配到同一个URL，更近一级的限制策略将会被应用。</p> 
   <div style="font-size:12px;"> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
    <pre>config.MessageHandlers.Add(<span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> ThrottlingHandler() {     Policy </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> ThrottlePolicy(perSecond: <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, perMinute: <span style="color:rgb(128,0,128);line-height:1.5;">20</span>, perHour: <span style="color:rgb(128,0,128);line-height:1.5;">200</span><span style="line-height:1.5;">)     {         IpThrottling </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">,         ClientThrottling </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">,         EndpointThrottling </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">,         EndpointRules </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> Dictionary&lt;<span style="color:rgb(0,0,255);line-height:1.5;">string</span>, RateLimits&gt;<span style="line-height:1.5;">         {              { </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">api/search</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(0,0,255);line-height:1.5;">new</span> RateLimits { PerSecond = <span style="color:rgb(128,0,128);line-height:1.5;">10</span>, PerMinute = <span style="color:rgb(128,0,128);line-height:1.5;">100</span>, PerHour = <span style="color:rgb(128,0,128);line-height:1.5;">1000</span><span style="line-height:1.5;"> } }         }     },     Repository </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> CacheRepository() });</span></pre> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
   </div> 
   <h2> <a name="eight"></a>关于被拒请求的计数器</h2> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">默认情况下，被拒绝的请求不会累加到WebApiThrottle的计数器里。 比如一个客户端在同一秒中请求了3次，而你配置的限制策略是每秒1次，那么分钟、小时、天的计数器只会记录第一次调用，因为第一次请求不会被拒绝。如果你想把被拒绝的请求也计算到其他的计数器里(分钟、小时、天)，你可以设置StackBlockedRequests为true。</p> 
   <div style="font-size:12px;"> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
    <pre>config.MessageHandlers.Add(<span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> ThrottlingHandler() {     Policy </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> ThrottlePolicy(perSecond: <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, perMinute: <span style="color:rgb(128,0,128);line-height:1.5;">30</span><span style="line-height:1.5;">)     {         IpThrottling </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">,         ClientThrottling </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">,         EndpointThrottling </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">,         StackBlockedRequests </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">     },     Repository </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> CacheRepository() });</span></pre> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
   </div> 
   <h2> <a name="nine"></a>在web.config或app.config中定义限制策略</h2> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">在web.config或app.config中配置限制策略，通过ThrottlePolicy.FromStore加装配置项。</p> 
   <div style="font-size:12px;">
    <pre>config.MessageHandlers.Add(<span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> ThrottlingHandler() {     Policy </span>= ThrottlePolicy.FromStore(<span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> PolicyConfigurationProvider()),     Repository </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> CacheRepository() });</span></pre>
   </div> 
   <h3>配置示例(policyType的值1代表ip、2代表clientkey、3代表端点)</h3> 
   <div style="font-size:12px;"> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);line-height:1.5;">configuration</span><span style="color:rgb(0,0,255);line-height:1.5;">&gt;</span>    <span style="color:rgb(0,0,255);line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);line-height:1.5;">configSections</span><span style="color:rgb(0,0,255);line-height:1.5;">&gt;</span>     <span style="color:rgb(0,0,255);line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);line-height:1.5;">section </span><span style="color:rgb(255,0,0);line-height:1.5;">name</span><span style="color:rgb(0,0,255);line-height:1.5;">="throttlePolicy"</span><span style="color:rgb(255,0,0);line-height:1.5;">               type</span><span style="color:rgb(0,0,255);line-height:1.5;">="WebApiThrottle.ThrottlePolicyConfiguration, WebApiThrottle"</span> <span style="color:rgb(0,0,255);line-height:1.5;">/&gt;</span>   <span style="color:rgb(0,0,255);line-height:1.5;">&lt;/</span><span style="color:rgb(128,0,0);line-height:1.5;">configSections</span><span style="color:rgb(0,0,255);line-height:1.5;">&gt;</span>    <span style="color:rgb(0,0,255);line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);line-height:1.5;">throttlePolicy </span><span style="color:rgb(255,0,0);line-height:1.5;">limitPerSecond</span><span style="color:rgb(0,0,255);line-height:1.5;">="1"</span><span style="color:rgb(255,0,0);line-height:1.5;">                   limitPerMinute</span><span style="color:rgb(0,0,255);line-height:1.5;">="10"</span><span style="color:rgb(255,0,0);line-height:1.5;">                   limitPerHour</span><span style="color:rgb(0,0,255);line-height:1.5;">="30"</span><span style="color:rgb(255,0,0);line-height:1.5;">                   limitPerDay</span><span style="color:rgb(0,0,255);line-height:1.5;">="300"</span><span style="color:rgb(255,0,0);line-height:1.5;">                   limitPerWeek </span><span style="color:rgb(0,0,255);line-height:1.5;">="1500"</span><span style="color:rgb(255,0,0);line-height:1.5;">                   ipThrottling</span><span style="color:rgb(0,0,255);line-height:1.5;">="true"</span><span style="color:rgb(255,0,0);line-height:1.5;">                   clientThrottling</span><span style="color:rgb(0,0,255);line-height:1.5;">="true"</span><span style="color:rgb(255,0,0);line-height:1.5;">                   endpointThrottling</span><span style="color:rgb(0,0,255);line-height:1.5;">="true"</span><span style="color:rgb(0,0,255);line-height:1.5;">&gt;</span>     <span style="color:rgb(0,0,255);line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);line-height:1.5;">rules</span><span style="color:rgb(0,0,255);line-height:1.5;">&gt;</span>       <span style="color:rgb(0,128,0);line-height:1.5;">&lt;!--</span><span style="color:rgb(0,128,0);line-height:1.5;">Ip 规则</span><span style="color:rgb(0,128,0);line-height:1.5;">--&gt;</span>       <span style="color:rgb(0,0,255);line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);line-height:1.5;">add </span><span style="color:rgb(255,0,0);line-height:1.5;">policyType</span><span style="color:rgb(0,0,255);line-height:1.5;">="1"</span><span style="color:rgb(255,0,0);line-height:1.5;"> entry</span><span style="color:rgb(0,0,255);line-height:1.5;">="::1/10"</span><span style="color:rgb(255,0,0);line-height:1.5;">            limitPerSecond</span><span style="color:rgb(0,0,255);line-height:1.5;">="2"</span><span style="color:rgb(255,0,0);line-height:1.5;">            limitPerMinute</span><span style="color:rgb(0,0,255);line-height:1.5;">="15"</span><span style="color:rgb(0,0,255);line-height:1.5;">/&gt;</span>       <span style="color:rgb(0,0,255);line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);line-height:1.5;">add </span><span style="color:rgb(255,0,0);line-height:1.5;">policyType</span><span style="color:rgb(0,0,255);line-height:1.5;">="1"</span><span style="color:rgb(255,0,0);line-height:1.5;"> entry</span><span style="color:rgb(0,0,255);line-height:1.5;">="192.168.2.1"</span><span style="color:rgb(255,0,0);line-height:1.5;">            limitPerMinute</span><span style="color:rgb(0,0,255);line-height:1.5;">="12"</span> <span style="color:rgb(0,0,255);line-height:1.5;">/&gt;</span>       <span style="color:rgb(0,128,0);line-height:1.5;">&lt;!--</span><span style="color:rgb(0,128,0);line-height:1.5;">Client 规则</span><span style="color:rgb(0,128,0);line-height:1.5;">--&gt;</span>       <span style="color:rgb(0,0,255);line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);line-height:1.5;">add </span><span style="color:rgb(255,0,0);line-height:1.5;">policyType</span><span style="color:rgb(0,0,255);line-height:1.5;">="2"</span><span style="color:rgb(255,0,0);line-height:1.5;"> entry</span><span style="color:rgb(0,0,255);line-height:1.5;">="api-client-key-1"</span><span style="color:rgb(255,0,0);line-height:1.5;">            limitPerHour</span><span style="color:rgb(0,0,255);line-height:1.5;">="60"</span> <span style="color:rgb(0,0,255);line-height:1.5;">/&gt;</span>       <span style="color:rgb(0,128,0);line-height:1.5;">&lt;!--</span><span style="color:rgb(0,128,0);line-height:1.5;">Endpoint 规则</span><span style="color:rgb(0,128,0);line-height:1.5;">--&gt;</span>       <span style="color:rgb(0,0,255);line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);line-height:1.5;">add </span><span style="color:rgb(255,0,0);line-height:1.5;">policyType</span><span style="color:rgb(0,0,255);line-height:1.5;">="3"</span><span style="color:rgb(255,0,0);line-height:1.5;"> entry</span><span style="color:rgb(0,0,255);line-height:1.5;">="api/values"</span><span style="color:rgb(255,0,0);line-height:1.5;">            limitPerDay</span><span style="color:rgb(0,0,255);line-height:1.5;">="120"</span> <span style="color:rgb(0,0,255);line-height:1.5;">/&gt;</span>     <span style="color:rgb(0,0,255);line-height:1.5;">&lt;/</span><span style="color:rgb(128,0,0);line-height:1.5;">rules</span><span style="color:rgb(0,0,255);line-height:1.5;">&gt;</span>     <span style="color:rgb(0,0,255);line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);line-height:1.5;">whitelists</span><span style="color:rgb(0,0,255);line-height:1.5;">&gt;</span>       <span style="color:rgb(0,128,0);line-height:1.5;">&lt;!--</span><span style="color:rgb(0,128,0);line-height:1.5;">Ip 白名单</span><span style="color:rgb(0,128,0);line-height:1.5;">--&gt;</span>       <span style="color:rgb(0,0,255);line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);line-height:1.5;">add </span><span style="color:rgb(255,0,0);line-height:1.5;">policyType</span><span style="color:rgb(0,0,255);line-height:1.5;">="1"</span><span style="color:rgb(255,0,0);line-height:1.5;"> entry</span><span style="color:rgb(0,0,255);line-height:1.5;">="127.0.0.1"</span> <span style="color:rgb(0,0,255);line-height:1.5;">/&gt;</span>       <span style="color:rgb(0,0,255);line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);line-height:1.5;">add </span><span style="color:rgb(255,0,0);line-height:1.5;">policyType</span><span style="color:rgb(0,0,255);line-height:1.5;">="1"</span><span style="color:rgb(255,0,0);line-height:1.5;"> entry</span><span style="color:rgb(0,0,255);line-height:1.5;">="192.168.0.0/24"</span> <span style="color:rgb(0,0,255);line-height:1.5;">/&gt;</span>       <span style="color:rgb(0,128,0);line-height:1.5;">&lt;!--</span><span style="color:rgb(0,128,0);line-height:1.5;">Client 白名单</span><span style="color:rgb(0,128,0);line-height:1.5;">--&gt;</span>       <span style="color:rgb(0,0,255);line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);line-height:1.5;">add </span><span style="color:rgb(255,0,0);line-height:1.5;">policyType</span><span style="color:rgb(0,0,255);line-height:1.5;">="2"</span><span style="color:rgb(255,0,0);line-height:1.5;"> entry</span><span style="color:rgb(0,0,255);line-height:1.5;">="api-admin-key"</span> <span style="color:rgb(0,0,255);line-height:1.5;">/&gt;</span>     <span style="color:rgb(0,0,255);line-height:1.5;">&lt;/</span><span style="color:rgb(128,0,0);line-height:1.5;">whitelists</span><span style="color:rgb(0,0,255);line-height:1.5;">&gt;</span>   <span style="color:rgb(0,0,255);line-height:1.5;">&lt;/</span><span style="color:rgb(128,0,0);line-height:1.5;">throttlePolicy</span><span style="color:rgb(0,0,255);line-height:1.5;">&gt;</span> <span style="color:rgb(0,0,255);line-height:1.5;">&lt;/</span><span style="color:rgb(128,0,0);line-height:1.5;">configuration</span><span style="color:rgb(0,0,255);line-height:1.5;">&gt;</span></pre> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
   </div> 
   <h2> <a name="ten"></a>获取API的客户端key</h2> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">默认情况下，WebApiThrottle的ThrottlingHandler(限流处理器)会从客户端请求head里通过Authorization-Token key取值。如果你的API key存储在不同的地方，你可以重写ThrottlingHandler.SetIndentity方法，指定你自己的取值策略。</p> 
   <div style="font-size:12px;"> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> CustomThrottlingHandler : ThrottlingHandler {     </span><span style="color:rgb(0,0,255);line-height:1.5;">protected</span> <span style="color:rgb(0,0,255);line-height:1.5;">override</span><span style="line-height:1.5;"> RequestIdentity SetIndentity(HttpRequestMessage request)     {         </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> RequestIdentity()         {             ClientKey </span>= request.Headers.Contains(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Authorization-Key</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>) ? request.Headers.GetValues(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Authorization-Key</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>).First() : <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">anon</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,             ClientIp </span>= <span style="color:rgb(0,0,255);line-height:1.5;">base</span><span style="line-height:1.5;">.GetClientIp(request).ToString(),             Endpoint </span>=<span style="line-height:1.5;"> request.RequestUri.AbsolutePath.ToLowerInvariant()         };     } }</span></pre> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
   </div> 
   <h2> <a name="eleven"></a>存储限流的数据</h2> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">WebApiThrottle会在内存中存储所有的请求数据，寄宿在IIS里使用ASP.NET版本的cache、自寄宿在Owin上使用运行时版本的缓存MemoryCache。如果你想改变请求数据存储的策略，框架是支持redis、nosql、数据库存储的，这种情况下必须创建自己的存储引擎，可以通过实现IThrottleRepository接口完成。</p> 
   <div style="font-size:12px;"> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">interface</span> IThrottleRepository { <span style="color:rgb(0,0,255);line-height:1.5;">bool</span> Any(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> id);  ThrottleCounter</span>? FirstOrDefault(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> id);  </span><span style="color:rgb(0,0,255);line-height:1.5;">void</span> Save(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> id, ThrottleCounter throttleCounter, TimeSpan expirationTime);  </span><span style="color:rgb(0,0,255);line-height:1.5;">void</span> Remove(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> id);  </span><span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> Clear(); }</span></pre> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">自从1.2版本后有IPolicyRepository的接口可以实现存储、获取限制策略对象，意味着可以持久化限流策略，同时也可以被用于在运行期间动态更新限制策略对象。</p> 
   <div style="font-size:12px;"> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">interface</span><span style="line-height:1.5;"> IPolicyRepository {     ThrottlePolicy FirstOrDefault(</span><span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> id);      </span><span style="color:rgb(0,0,255);line-height:1.5;">void</span> Remove(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> id);      </span><span style="color:rgb(0,0,255);line-height:1.5;">void</span> Save(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> id, ThrottlePolicy policy); }</span></pre> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
   </div> 
   <h2> <a name="twelve"></a>运行期间更新限制频率</h2> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">为了更新限制策略对象，并在运行时使用新的ThrottlingHandler对象，需要引入WebApiThrottle 1.2版本后支持的ThrottleManager.UpdatePolicy函数。</p> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">在启动时注册ThrottlingHandler对象，并在构造函数中传入PolicyCacheRepository ，如果你是通过Owin自寄宿的webapi，需要使用PolicyMemoryCacheRepository对象。</p> 
   <div style="font-size:12px;"> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> Register(HttpConfiguration config) {     </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">trace provider</span>     <span style="color:rgb(0,0,255);line-height:1.5;">var</span> traceWriter = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> SystemDiagnosticsTraceWriter()     {         IsVerbose </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">     };     config.Services.Replace(</span><span style="color:rgb(0,0,255);line-height:1.5;">typeof</span><span style="line-height:1.5;">(ITraceWriter), traceWriter);     config.EnableSystemDiagnosticsTracing();      </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">添加限流处理者到Web API消息处理集合里</span>     config.MessageHandlers.Add(<span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> ThrottlingHandler(         policy: </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span> ThrottlePolicy(perMinute: <span style="color:rgb(128,0,128);line-height:1.5;">20</span>, perHour: <span style="color:rgb(128,0,128);line-height:1.5;">30</span>, perDay: <span style="color:rgb(128,0,128);line-height:1.5;">35</span>, perWeek: <span style="color:rgb(128,0,128);line-height:1.5;">3000</span><span style="line-height:1.5;">)         {             </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">启用ip限制策略</span>             IpThrottling = <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">,              </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">启用客户端key限制策略</span>             ClientThrottling = <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">,             ClientRules </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> Dictionary&lt;<span style="color:rgb(0,0,255);line-height:1.5;">string</span>, RateLimits&gt;<span style="line-height:1.5;">             {                  { </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">api-client-key-1</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(0,0,255);line-height:1.5;">new</span> RateLimits { PerMinute = <span style="color:rgb(128,0,128);line-height:1.5;">60</span>, PerHour = <span style="color:rgb(128,0,128);line-height:1.5;">600</span><span style="line-height:1.5;"> } },                 { </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">api-client-key-2</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(0,0,255);line-height:1.5;">new</span> RateLimits { PerDay = <span style="color:rgb(128,0,128);line-height:1.5;">5000</span><span style="line-height:1.5;"> } }             },              </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">启用端点限制策略</span>             EndpointThrottling = <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">         },          </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">如果是owin寄宿，替换成PolicyMemoryCacheRepository</span>         policyRepository: <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> PolicyCacheRepository(),          </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">如果是owin寄宿，替换成MemoryCacheRepository </span>         repository: <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> CacheRepository(),          logger: </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> TracingThrottleLogger(traceWriter))); }</span></pre> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">当你想更新限制策略对象时，可以在任何你的代码里调用静态方法ThrottleManager.UpdatePolicy去刷新内存中的策略数据。</p> 
   <div style="font-size:12px;"> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> UpdateRateLimits() {     </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">初始化策略仓库</span>     <span style="color:rgb(0,0,255);line-height:1.5;">var</span> policyRepository = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> PolicyCacheRepository();      </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">从缓存中获取策略对象</span>     <span style="color:rgb(0,0,255);line-height:1.5;">var</span> policy =<span style="line-height:1.5;"> policyRepository.FirstOrDefault(ThrottleManager.GetPolicyKey());      </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">更新客户端限制频率</span>     policy.ClientRules[<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">api-client-key-1</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>] =         <span style="color:rgb(0,0,255);line-height:1.5;">new</span> RateLimits { PerMinute = <span style="color:rgb(128,0,128);line-height:1.5;">80</span>, PerHour = <span style="color:rgb(128,0,128);line-height:1.5;">800</span><span style="line-height:1.5;"> };      </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">添加新的客户端限制频率</span>     policy.ClientRules.Add(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">api-client-key-3</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,         </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span> RateLimits { PerMinute = <span style="color:rgb(128,0,128);line-height:1.5;">60</span>, PerHour = <span style="color:rgb(128,0,128);line-height:1.5;">600</span><span style="line-height:1.5;"> });      </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">应用策略更新</span> <span style="line-height:1.5;">    ThrottleManager.UpdatePolicy(policy, policyRepository);  }</span></pre> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
   </div> 
   <h2> <a name="thirteen"></a>限流的请求日志</h2> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">如果你想记录限流后的请求日志，可以实现IThrottleLogger接口，添加到ThrottlingHandler里。</p> 
   <div style="font-size:12px;">
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">interface</span><span style="line-height:1.5;"> IThrottleLogger {     </span><span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> Log(ThrottleLogEntry entry); }</span></pre>
   </div> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">实现ITraceWriter日志记录接口的例子</p> 
   <div style="font-size:12px;"> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> TracingThrottleLogger : IThrottleLogger {     </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">readonly</span><span style="line-height:1.5;"> ITraceWriter traceWriter;      </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> TracingThrottleLogger(ITraceWriter traceWriter)     {         </span><span style="color:rgb(0,0,255);line-height:1.5;">this</span>.traceWriter =<span style="line-height:1.5;"> traceWriter;     }      </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> Log(ThrottleLogEntry entry)     {         </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (<span style="color:rgb(0,0,255);line-height:1.5;">null</span> !=<span style="line-height:1.5;"> traceWriter)         {             traceWriter.Info(entry.Request, </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">WebApiThrottle</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,                 </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">{0} Request {1} from {2} has been throttled (blocked), quota {3}/{4} exceeded by {5}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,                 entry.LogDate, entry.RequestId, entry.ClientIp, entry.RateLimit, entry.RateLimitPeriod, entry.TotalRequests);         }     } }</span></pre> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">用SystemDiagnosticsTraceWriter和ThrottlingHandler记录日志的使用例子：</p> 
   <div style="font-size:12px;"> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">var</span> traceWriter = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> SystemDiagnosticsTraceWriter() {     IsVerbose </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;"> }; config.Services.Replace(</span><span style="color:rgb(0,0,255);line-height:1.5;">typeof</span><span style="line-height:1.5;">(ITraceWriter), traceWriter); config.EnableSystemDiagnosticsTracing();  config.MessageHandlers.Add(</span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> ThrottlingHandler() {     Policy </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> ThrottlePolicy(perSecond: <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, perMinute: <span style="color:rgb(128,0,128);line-height:1.5;">30</span><span style="line-height:1.5;">)     {         IpThrottling </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">,         ClientThrottling </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">,         EndpointThrottling </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">     },     Repository </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> CacheRepository(),     Logger </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> TracingThrottleLogger(traceWriter) });</span></pre> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
   </div> 
   <h2> <a name="fourteen"></a>用ThrottlingFilter、EnableThrottlingAttribute特性配置限制频率</h2> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">EnableThrottling与ThrottlingHandler是一个二选一的策略配置方案，二者会做同样的事情，但ThrottlingHandler可以通过EnableThrottlingAttribute特性指定某个webapi的controllers和actions去自定义频率限制。需要注意的是，在webapi请求管道中，ThrottlingHandler是在controller前面执行，因此在你不需要ThrottlingFilter提供的功能时，可以用ThrottlingHandler去直接替代它。</p> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">设置ThrottlingFilter过滤器的步骤，跟ThrottlingHandler类似:</p> 
   <div style="font-size:12px;"> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
    <pre>config.Filters.Add(<span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> ThrottlingFilter() {     Policy </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> ThrottlePolicy(perSecond: <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, perMinute: <span style="color:rgb(128,0,128);line-height:1.5;">20</span><span style="line-height:1.5;">,      perHour: </span><span style="color:rgb(128,0,128);line-height:1.5;">200</span>, perDay: <span style="color:rgb(128,0,128);line-height:1.5;">2000</span>, perWeek: <span style="color:rgb(128,0,128);line-height:1.5;">10000</span><span style="line-height:1.5;">)     {         </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">ip配置区域</span>         IpThrottling = <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">,         IpRules </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> Dictionary&lt;<span style="color:rgb(0,0,255);line-height:1.5;">string</span>, RateLimits&gt;<span style="line-height:1.5;">         {              { </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">::1/10</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(0,0,255);line-height:1.5;">new</span> RateLimits { PerSecond = <span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;"> } },             { </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">192.168.2.1</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(0,0,255);line-height:1.5;">new</span> RateLimits { PerMinute = <span style="color:rgb(128,0,128);line-height:1.5;">30</span>, PerHour = <span style="color:rgb(128,0,128);line-height:1.5;">30</span>*<span style="color:rgb(128,0,128);line-height:1.5;">60</span>, PerDay = <span style="color:rgb(128,0,128);line-height:1.5;">30</span>*<span style="color:rgb(128,0,128);line-height:1.5;">60</span>*<span style="color:rgb(128,0,128);line-height:1.5;">24</span><span style="line-height:1.5;"> } }         },         </span><span style="color:rgb(0,128,0);line-height:1.5;">//添加127.0.0.1到白名单，本地地址不启用限流策略</span>         IpWhitelist = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> List&lt;<span style="color:rgb(0,0,255);line-height:1.5;">string</span>&gt; { <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">127.0.0.1</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">192.168.0.0/24</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> },          </span><span style="color:rgb(0,128,0);line-height:1.5;">//客户端配置区域，如果ip限制也是启动的，那么客户端限制策略会与ip限制策略组合使用。</span><span style="line-height:1.5;">         ClientRules </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> Dictionary&lt;<span style="color:rgb(0,0,255);line-height:1.5;">string</span>, RateLimits&gt;<span style="line-height:1.5;">         {              { </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">api-client-key-demo</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(0,0,255);line-height:1.5;">new</span> RateLimits { PerDay = <span style="color:rgb(128,0,128);line-height:1.5;">5000</span><span style="line-height:1.5;"> } }         },         </span><span style="color:rgb(0,128,0);line-height:1.5;">//白名单中的客户端key不会进行限流。</span>         ClientWhitelist = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> List&lt;<span style="color:rgb(0,0,255);line-height:1.5;">string</span>&gt; { <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">admin-key</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> },          </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">端点限制策略配置会从EnableThrottling特性中获取。</span>         EndpointThrottling = <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">     } });</span></pre> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">使用特性开启限流并配置限制频率：</p> 
   <div style="font-size:12px;"> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
    <pre>[EnableThrottling(PerSecond = <span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">)] </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> ValuesController : ApiController {     [EnableThrottling(PerSecond </span>= <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, PerMinute = <span style="color:rgb(128,0,128);line-height:1.5;">30</span>, PerHour = <span style="color:rgb(128,0,128);line-height:1.5;">100</span><span style="line-height:1.5;">)]     </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> IEnumerable&lt;<span style="color:rgb(0,0,255);line-height:1.5;">string</span>&gt;<span style="line-height:1.5;"> Get()     {         </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(0,0,255);line-height:1.5;">new</span> <span style="color:rgb(0,0,255);line-height:1.5;">string</span>[] { <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">value1</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">value2</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> };     }      [DisableThrotting]     </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">string</span> Get(<span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> id)     {         </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">value</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">;     } }</span></pre> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
   </div> 
   <h2> <a name="fifteen"></a>关于ThrottlingMiddleware限制频率</h2> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">ThrottlingMiddleware是一个OWIN中间件部分，它的作用跟ThrottlingHandler一样。使用ThrottlingMiddleware 你可以在webapi作用域范围外配置限制策略，跟使用OAuth中间件或SignalR端点类似。</p> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">自寄宿配置例子：</p> 
   <div style="font-size:12px;"> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> Startup {     </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> Configuration(IAppBuilder appBuilder)     {         ...          </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">从app.config加载限流策略</span>         appBuilder.Use(<span style="color:rgb(0,0,255);line-height:1.5;">typeof</span><span style="line-height:1.5;">(ThrottlingMiddleware),             ThrottlePolicy.FromStore(</span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> PolicyConfigurationProvider()),             </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> PolicyMemoryCacheRepository(),             </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> MemoryCacheRepository(),             </span><span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">);          ...     } }</span></pre> 
    <div>
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);line-height:25.2px;font-family:Georgia, 'Times New Roman', Times, sans-serif;">IIS寄宿配置例子：</p> 
   <div> 
    <div style="font-size:12px;">
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> Startup {     </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> Configuration(IAppBuilder appBuilder)     {         ...      </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">从web.config加载限流策略</span>     appBuilder.Use(<span style="color:rgb(0,0,255);line-height:1.5;">typeof</span><span style="line-height:1.5;">(ThrottlingMiddleware),         ThrottlePolicy.FromStore(</span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> PolicyConfigurationProvider()),         </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> PolicyCacheRepository(),         </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> CacheRepository(),         </span><span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">);          ...     } }</span></pre> 
    <div style="font-size:12px;">
     <span style="line-height:1.5;"><a style="border:;color:rgb(61,129,238);" title="复制代码"><img alt="复制代码" src="https://common.cnblogs.com/images/copycode.gif"></a></span>
    </div> 
    <div>
     <font color="#3d81ee"><span style="font-size:12px;"><br></span></font>
    </div> 
    <div>
     <font color="#3d81ee"><span style="font-size:12px;"><br></span></font>
    </div> 
    <div>
     <font color="#3d81ee"><span style="font-size:12px;"><br></span></font>
    </div> 
    <div>
     <font color="#3d81ee"><span style="font-size:12px;">本文转自94cool博客园博客，原文链接：http://www.cnblogs.com/94cool/p/5969511.html，如需转载请自行联系原作者</span></font>
    </div> 
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
