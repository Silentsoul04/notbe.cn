<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>C# 实现屏幕键盘 (ScreenKeyboard) « NotBeCN</title>
  <meta name="description" content="              要实现一个屏幕键盘，需要监听所有键盘事件，无论窗体是否被激活。因此需要一个全局的钩子，也就  是系统范围的钩子。    什么是钩子（Hook）     钩子（Hook）是Windows提供的一种消息处理机制平台，是指在程序正常运行中接受信息之前预先  启动的函数，用来检查和修改传给该程...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/26/weixin_34288121_90127595.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">C# 实现屏幕键盘 (ScreenKeyboard)</h1>
    <p class="post-meta">Nov 26, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p><br> 要实现一个屏幕键盘，需要监听所有键盘事件，无论窗体是否被激活。因此需要一个全局的钩子，也就 <br> 是系统范围的钩子。</p> 
   <p>什么是钩子（Hook）</p> 
   <p> 钩子（Hook）是Windows提供的一种消息处理机制平台，是指在程序正常运行中接受信息之前预先 <br> 启动的函数，用来检查和修改传给该程序的信息，（钩子）实际上是一个处理消息的程序段，通 <br> 过系统调用，把它挂入系统。每当特定的消息发出，在没有到达目的窗口前，钩子程序就先捕获 <br> 该消息，亦即钩子函数先得到控制权。这时钩子函数即可以加工处理（改变）该消息，也可以不 <br> 作处理而继续传递该消息，还可以强制结束消息的传递。注意：安装钩子函数将会影响系统的性 <br> 能。监测“系统范围事件”的系统钩子特别明显。因为系统在处理所有的相关事件时都将调用您的 <br> 钩子函数，这样您的系统将会明显的减慢。所以应谨慎使用，用完后立即卸载。还有，由于您可 <br> 以预先截获其它进程的消息，所以一旦您的钩子函数出了问题的话必将影响其它的进程。</p> 
   <p>钩子的作用范围 <br> 一共有两种范围（类型）的钩子，局部的和远程的。局部钩子仅钩挂自己进程的事件。远程的钩 <br> 子还可以将钩挂其它进程发生的事件。远程的钩子又有两种： 基于线程的钩子将捕获其它进程中 <br> 某一特定线程的事件。简言之，就是可以用来观察其它进程中的某一特定线程将发生的事件。 系 <br> 统范围的钩子将捕捉系统中所有进程将发生的事件消息。 </p> 
   <p>Hook 类型 <br> Windows共有14种Hooks，每一种类型的Hook可以使应用程序能够监视不同类型的系统消息处理机 <br> 制。下面描述所有可以利用的Hook类型的发生时机。详细内容可以查阅MSDN，这里只介绍我们将要 <br> 用到的两种类型的钩子。 <br> （1）WH_KEYBOARD_LL Hook <br> WH_KEYBOARD_LL Hook监视输入到线程消息队列中的键盘消息。</p> 
   <p> （2）WH_MOUSE_LL Hook <br> WH_MOUSE_LL Hook监视输入到线程消息队列中的鼠标消息。</p> 
   <p>下面的 class 把 API 调用封装起来以便调用。</p> 
   <p>1<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif">// NativeMethods.cs <br> 2<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif">using System; <br> 3<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif">using System.Runtime.InteropServices; <br> 4<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif">using System.Drawing; <br> 5<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif"><br> 6<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedBlock.gif">namespace CnBlogs.Youzai.ScreenKeyboard <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 7<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> [StructLayout(LayoutKind.Sequential)] <br> 8<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif"> internal struct MOUSEINPUT <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 9<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> public int dx; <br> 10<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> public int dy; <br> 11<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> public int mouseData; <br> 12<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> public int dwFlags; <br> 13<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> public int time; <br> 14<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> public IntPtr dwExtraInfo; <br> 15<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif"> } <br> 16<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 17<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> [StructLayout(LayoutKind.Sequential)] <br> 18<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif"> internal struct KEYBDINPUT <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 19<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> public short wVk; <br> 20<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> public short wScan; <br> 21<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> public int dwFlags; <br> 22<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> public int time; <br> 23<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> public IntPtr dwExtraInfo; <br> 24<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif"> } <br> 25<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 26<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> [StructLayout(LayoutKind.Explicit)] <br> 27<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif"> internal struct Input <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 28<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> [FieldOffset(0)] <br> 29<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> public int type; <br> 30<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> [FieldOffset(4)] <br> 31<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> public MOUSEINPUT mi; <br> 32<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> [FieldOffset(4)] <br> 33<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> public KEYBDINPUT ki; <br> 34<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> [FieldOffset(4)] <br> 35<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> public HARDWAREINPUT hi; <br> 36<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif"> } <br> 37<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 38<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> [StructLayout(LayoutKind.Sequential)] <br> 39<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif"> internal struct HARDWAREINPUT <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 40<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> public int uMsg; <br> 41<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> public short wParamL; <br> 42<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> public short wParamH; <br> 43<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif"> } <br> 44<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 45<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif"> internal class INPUT <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 46<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> public const int MOUSE = 0; <br> 47<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> public const int KEYBOARD = 1; <br> 48<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> public const int HARDWARE = 2; <br> 49<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif"> } <br> 50<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 51<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif"> internal static class NativeMethods <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 52<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> [DllImport("User32.dll", CharSet = CharSet.Auto, SetLastError = false)] <br> 53<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static extern IntPtr GetWindowLong(IntPtr hWnd, int nIndex); <br> 54<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 55<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> [DllImport("User32.dll", CharSet = CharSet.Auto, SetLastError = false)] <br> 56<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static extern IntPtr SetWindowLong(IntPtr hWnd, int nIndex, int dwNewLong); <br> 57<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 58<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> [DllImport("User32.dll", EntryPoint = "SendInput", CharSet = CharSet.Auto)] <br> 59<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static extern UInt32 SendInput(UInt32 nInputs, Input[] pInputs, Int32 cbSize); <br> 60<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 61<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> [DllImport("Kernel32.dll", EntryPoint = "GetTickCount", CharSet = CharSet.Auto)] <br> 62<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static extern int GetTickCount(); <br> 63<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 64<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> [DllImport("User32.dll", EntryPoint = "GetKeyState", CharSet = CharSet.Auto)] <br> 65<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static extern short GetKeyState(int nVirtKey); <br> 66<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 67<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> [DllImport("User32.dll", EntryPoint = "SendMessage", CharSet = CharSet.Auto)] <br> 68<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static extern IntPtr SendMessage(IntPtr hWnd, int msg, IntPtr wParam, IntPtr lParam); <br> 69<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif"> } <br> 70<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockEnd.gif">}</p> 
   <p>安装钩子 <br> 使用SetWindowsHookEx函数（API函数），指定一个Hook类型、自己的Hook过程是全局还是局部Hook， <br> 同时给出Hook过程的进入点，就可以轻松的安装自己的Hook过程。SetWindowsHookEx总是将你的Hook函 <br> 数放置在Hook链的顶端。你可以使用CallNextHookEx函数将系统消息传递给Hook链中的下一个函数。 <br> 对于某些类型的Hook，系统将向该类的所有Hook函数发送消息，这时， <br> Hook函数中的CallNextHookEx语句将被忽略。全局（远程钩子）Hook函数可以拦截系统中所有线程的某 <br> 个特定的消息，为了安装一个全局Hook过程，必须在应用程序外建立一个DLL并将该Hook函数封装到其中， <br> 应用程序在安装全局Hook过程时必须先得到该DLL模块的句柄。将Dll名传递给LoadLibrary 函数，就会得 <br> 到该DLL模块的句柄；得到该句柄 后，使用GetProcAddress函数可以得到Hook过程的地址。最后，使用 <br> SetWindowsHookEx将 Hook过程的首址嵌入相应的Hook链中，SetWindowsHookEx传递一个模块句柄，它为 <br> Hook过程的进入点，线程标识符置为0，该Hook过程同系统中的所有线程关联。如果是安装局部Hook此时 <br> 该Hook函数可以放置在DLL中，也可以放置在应用程序的模块段。在C#中通过平台调用（前文已经介绍过） <br> 来调用API函数。</p> 
   <p>1<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedBlock.gif"> public void Start(bool installMouseHook, bool installKeyboardHook) <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 2<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif"> if (hMouseHook == IntPtr.Zero &amp;&amp; installMouseHook) <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 3<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> MouseHookProcedure = new HookProc(MouseHookProc); <br> 4<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> hMouseHook = SetWindowsHookEx( <br> 5<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> WH_MOUSE_LL, <br> 6<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> MouseHookProcedure, <br> 7<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> Marshal.GetHINSTANCE( <br> 8<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> Assembly.GetExecutingAssembly().GetModules()[0]), <br> 9<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> 0 <br> 10<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> ); <br> 11<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 12<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif"> if (hMouseHook == IntPtr.Zero) <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 13<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> int errorCode = Marshal.GetLastWin32Error(); <br> 14<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> Stop(true, false, false); <br> 15<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 16<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> throw new Win32Exception(errorCode); <br> 17<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif"> } <br> 18<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif"> } <br> 19<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 20<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif"> if (hKeyboardHook == IntPtr.Zero &amp;&amp; installKeyboardHook) <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 21<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> KeyboardHookProcedure = new HookProc(KeyboardHookProc); <br> 22<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> //install hook <br> 23<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> hKeyboardHook = SetWindowsHookEx( <br> 24<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> WH_KEYBOARD_LL, <br> 25<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> KeyboardHookProcedure, <br> 26<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> Marshal.GetHINSTANCE( <br> 27<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> Assembly.GetExecutingAssembly().GetModules()[0]), <br> 28<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> 0); <br> 29<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> // If SetWindowsHookEx fails. <br> 30<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif"> if (hKeyboardHook == IntPtr.Zero) <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 31<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> // Returns the error code returned by the last <br> 32<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> // unmanaged function called using platform invoke <br> 33<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> // that has the DllImportAttribute.SetLastError flag set. <br> 34<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> int errorCode = Marshal.GetLastWin32Error(); <br> 35<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> //do cleanup <br> 36<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> Stop(false, true, false); <br> 37<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> //Initializes and throws a new instance of the <br> 38<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> // Win32Exception class with the specified error. <br> 39<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> throw new Win32Exception(errorCode); <br> 40<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif"> } <br> 41<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif"> } <br> 42<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockEnd.gif"> }</p> 
   <p>使用完钩子后，要进行卸载，这个可以写在析构函数中。</p> 
   <p>1<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif"><br> 2<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedBlock.gif"> public void Stop() <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 3<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> this.Stop(true, true, true); <br> 4<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockEnd.gif"> } <br> 5<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif"><br> 6<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif"> public void Stop(bool uninstallMouseHook, bool uninstallKeyboardHook, <br> 7<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedBlock.gif"> bool throwExceptions) <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 8<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> // if mouse hook set and must be uninstalled <br> 9<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif"> if (hMouseHook != IntPtr.Zero &amp;&amp; uninstallMouseHook) <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 10<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> // uninstall hook <br> 11<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> bool retMouse = UnhookWindowsHookEx(hMouseHook); <br> 12<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> // reset invalid handle <br> 13<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> hMouseHook = IntPtr.Zero; <br> 14<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> // if failed and exception must be thrown <br> 15<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif"> if (retMouse == false &amp;&amp; throwExceptions) <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 16<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> // Returns the error code returned by the last unmanaged function <br> 17<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> // called using platform invoke that has the DllImportAttribute. <br> 18<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> // SetLastError flag set. <br> 19<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> int errorCode = Marshal.GetLastWin32Error(); <br> 20<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> // Initializes and throws a new instance of the Win32Exception class <br> 21<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> // with the specified error. <br> 22<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> throw new Win32Exception(errorCode); <br> 23<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif"> } <br> 24<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif"> } <br> 25<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 26<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> // if keyboard hook set and must be uninstalled <br> 27<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif"> if (hKeyboardHook != IntPtr.Zero &amp;&amp; uninstallKeyboardHook) <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 28<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> // uninstall hook <br> 29<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> bool retKeyboard = UnhookWindowsHookEx(hKeyboardHook); <br> 30<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> // reset invalid handle <br> 31<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> hKeyboardHook = IntPtr.Zero; <br> 32<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> // if failed and exception must be thrown <br> 33<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif"> if (retKeyboard == false &amp;&amp; throwExceptions) <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 34<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> // Returns the error code returned by the last unmanaged function <br> 35<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> // called using platform invoke that has the DllImportAttribute. <br> 36<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> // SetLastError flag set. <br> 37<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> int errorCode = Marshal.GetLastWin32Error(); <br> 38<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> // Initializes and throws a new instance of the Win32Exception class <br> 39<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> // with the specified error. <br> 40<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> throw new Win32Exception(errorCode); <br> 41<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif"> } <br> 42<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif"> } <br> 43<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockEnd.gif"> } <br> 44<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif"></p> 
   <p>将这个文件编译成一个dll，即可在应用程序中调用。通过它提供的事件，便可监听所有的键盘事件。 <br> 但是，这只能监听键盘事件，没有键盘的情况下，怎么会有键盘事件？其实很简单，通过SendInput <br> API函数提供虚拟键盘代码的调用即可模拟键盘输入。下面的代码模拟一个 KeyDown 和 KeyUp 过程， <br> 把他们连接起来就是一次按键过程。</p> 
   <p>1<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedBlock.gif"> private void SendKeyDown(short key) <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 2<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> Input[] input = new Input[1]; <br> 3<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> input[0].type = INPUT.KEYBOARD; <br> 4<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> input[0].ki.wVk = key; <br> 5<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> input[0].ki.time = NativeMethods.GetTickCount(); <br> 6<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 7<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> if (NativeMethods.SendInput((uint)input.Length, input, Marshal.SizeOf(input[0])) <br> 8<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif"> &lt; input.Length) <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 9<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> throw new Win32Exception(Marshal.GetLastWin32Error()); <br> 10<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif"> } <br> 11<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockEnd.gif"> } <br> 12<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif"><br> 13<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedBlock.gif"> private void SendKeyUp(short key) <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 14<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> Input[] input = new Input[1]; <br> 15<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> input[0].type = INPUT.KEYBOARD; <br> 16<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> input[0].ki.wVk = key; <br> 17<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> input[0].ki.dwFlags = KeyboardConstaint.KEYEVENTF_KEYUP; <br> 18<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> input[0].ki.time = NativeMethods.GetTickCount(); <br> 19<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 20<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> if (NativeMethods.SendInput((uint)input.Length, input, Marshal.SizeOf(input[0])) <br> 21<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif"> &lt; input.Length) <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 22<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> throw new Win32Exception(Marshal.GetLastWin32Error()); <br> 23<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif"> } <br> 24<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockEnd.gif"> }</p> 
   <p>自己实现一个 KeyBoardButton 控件用作按钮，用 Visual Studio 或者 SharpDevelop 为屏幕键盘设计 UI，然后 <br> 在这些 Button 的 Click 事件里面模拟一个按键过程。</p> 
   <p>1<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif"><br> 2<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedBlock.gif"> private void ButtonOnClick(object sender, EventArgs e) <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 3<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> KeyboardButton btnKey = sender as KeyboardButton; <br> 4<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif"> if (btnKey == null) <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 5<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> return; <br> 6<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif"> } <br> 7<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 8<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> SendKeyCommand(btnKey); <br> 9<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockEnd.gif"> } <br> 10<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif"><br> 11<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedBlock.gif"> private void SendKeyCommand(KeyboardButton keyButton) <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 12<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> short key = keyButton.VKCode; <br> 13<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif"> if (combinationVKButtonsMap.ContainsKey(key)) <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 14<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif"> if (keyButton.Checked) <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 15<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> SendKeyUp(key); <br> 16<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif"> } else <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 17<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> SendKeyDown(key); <br> 18<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif"> } <br> 19<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif"> } else <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 20<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> SendKeyDown(key); <br> 21<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> SendKeyUp(key); <br> 22<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif"> } <br> 23<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockEnd.gif"> }</p> 
   <p>其中 combinationVKButtonsMap 是一个 IDictionary&lt;short, IList&lt;KeyboardButton&gt;&gt;, key 存储的是 <br> VK_SHIFT, VK_CONTROL 等组合键的键盘码。左右两个按钮对应同一个键盘码，因此需要放在一个 List 里。 <br> 标准键盘上的每一个键都有虚拟键码( VK_CODE)与之对应。还有一些其他的常量， <br> 把它写在一个静态 class 里吧。</p> 
   <p>1<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif"> // KeyboardConstaint.cs <br> 2<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedBlock.gif"> internal static class KeyboardConstaint <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 3<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_F1 = 0x70; <br> 4<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_F2 = 0x71; <br> 5<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_F3 = 0x72; <br> 6<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_F4 = 0x73; <br> 7<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_F5 = 0x74; <br> 8<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_F6 = 0x75; <br> 9<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_F7 = 0x76; <br> 10<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_F8 = 0x77; <br> 11<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_F9 = 0x78; <br> 12<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_F10 = 0x79; <br> 13<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_F11 = 0x7A; <br> 14<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_F12 = 0x7B; <br> 15<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 16<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_LEFT = 0x25; <br> 17<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_UP = 0x26; <br> 18<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_RIGHT = 0x27; <br> 19<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_DOWN = 0x28; <br> 20<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 21<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_NONE = 0x00; <br> 22<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_ESCAPE = 0x1B; <br> 23<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_EXECUTE = 0x2B; <br> 24<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_CANCEL = 0x03; <br> 25<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_RETURN = 0x0D; <br> 26<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_ACCEPT = 0x1E; <br> 27<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_BACK = 0x08; <br> 28<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_TAB = 0x09; <br> 29<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_DELETE = 0x2E; <br> 30<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_CAPITAL = 0x14; <br> 31<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_NUMLOCK = 0x90; <br> 32<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_SPACE = 0x20; <br> 33<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_DECIMAL = 0x6E; <br> 34<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_SUBTRACT = 0x6D; <br> 35<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 36<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_ADD = 0x6B; <br> 37<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_DIVIDE = 0x6F; <br> 38<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_MULTIPLY = 0x6A; <br> 39<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_INSERT = 0x2D; <br> 40<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 41<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_OEM_1 = 0xBA; // ';:' for US <br> 42<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_OEM_PLUS = 0xBB; // '+' any country <br> 43<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 44<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_OEM_MINUS = 0xBD; // '-' any country <br> 45<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 46<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_OEM_2 = 0xBF; // '/?' for US <br> 47<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_OEM_3 = 0xC0; // '`~' for US <br> 48<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_OEM_4 = 0xDB; // '[{' for US <br> 49<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_OEM_5 = 0xDC; // '\|' for US <br> 50<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_OEM_6 = 0xDD; // ']}' for US <br> 51<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_OEM_7 = 0xDE; // ''"' for US <br> 52<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_OEM_PERIOD = 0xBE; // '.&gt;' any country <br> 53<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_OEM_COMMA = 0xBC; // ',&lt;' any country <br> 54<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_SHIFT = 0x10; <br> 55<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_CONTROL = 0x11; <br> 56<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_MENU = 0x12; <br> 57<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_LWIN = 0x5B; <br> 58<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_RWIN = 0x5C; <br> 59<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_APPS = 0x5D; <br> 60<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 61<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_LSHIFT = 0xA0; <br> 62<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_RSHIFT = 0xA1; <br> 63<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_LCONTROL = 0xA2; <br> 64<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_RCONTROL = 0xA3; <br> 65<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_LMENU = 0xA4; <br> 66<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_RMENU = 0xA5; <br> 67<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 68<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_SNAPSHOT = 0x2C; <br> 69<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_SCROLL = 0x91; <br> 70<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_PAUSE = 0x13; <br> 71<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_HOME = 0x24; <br> 72<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 73<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_NEXT = 0x22; <br> 74<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_PRIOR = 0x21; <br> 75<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_END = 0x23; <br> 76<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 77<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_NUMPAD0 = 0x60; <br> 78<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_NUMPAD1 = 0x61; <br> 79<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_NUMPAD2 = 0x62; <br> 80<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_NUMPAD3 = 0x63; <br> 81<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_NUMPAD4 = 0x64; <br> 82<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_NUMPAD5 = 0x65; <br> 83<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_NUMPAD5NOTHING = 0x0C; <br> 84<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_NUMPAD6 = 0x66; <br> 85<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_NUMPAD7 = 0x67; <br> 86<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_NUMPAD8 = 0x68; <br> 87<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short VK_NUMPAD9 = 0x69; <br> 88<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 89<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short KEYEVENTF_EXTENDEDKEY = 0x0001; <br> 90<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly short KEYEVENTF_KEYUP = 0x0002; <br> 91<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 92<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly int GWL_EXSTYLE = -20; <br> 93<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly int WS_DISABLED = 0X8000000; <br> 94<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> internal static readonly int WM_SETFOCUS = 0X0007; <br> 95<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockEnd.gif"> }</p> 
   <p>屏幕键盘必须是一个不能获得输入焦点的窗体，在这个窗体的构造函数里，可以安装 <br> 一个全局鼠标钩子，再通过调用 SetWindowLong API 函数完成。</p> 
   <p>1<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif">UserActivityHook hook = new UserActivityHook(true, true); <br> 2<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif">hook.MouseActivity += HookOnMouseActivity; <br> 3<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/None.gif"><br> 4<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedBlock.gif">private void HookOnMouseActivity(object sener, HookEx.MouseExEventArgs e) <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 5<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> Point location = e.Location; <br> 6<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"><br> 7<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif"> if (e.Button == MouseButtons.Left) <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 8<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> Rectangle captionRect = new Rectangle(this.Location, new Size(this.Width, <br> 9<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> SystemInformation.CaptionHeight)); <br> 10<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif"> if (captionRect.Contains(location)) <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 11<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> NativeMethods.SetWindowLong(this.Handle, KeyboardConstaint.GWL_EXSTYLE, <br> 12<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> (int)NativeMethods.GetWindowLong(this.Handle, KeyboardConstaint.GWL_EXSTYLE) <br> 13<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> &amp; (~KeyboardConstaint.WS_DISABLED)); <br> 14<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> NativeMethods.SendMessage(this.Handle, KeyboardConstaint.WM_SETFOCUS, IntPtr.Zero, IntPtr.Zero); <br> 15<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif"><img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif"> } else <img alt="" src="https://www.cnblogs.com/Images/dot.gif">{ <br> 16<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> NativeMethods.SetWindowLong(this.Handle, KeyboardConstaint.GWL_EXSTYLE, <br> 17<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> (int)NativeMethods.GetWindowLong(this.Handle, KeyboardConstaint.GWL_EXSTYLE) | <br> 18<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif"> KeyboardConstaint.WS_DISABLED); <br> 19<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif"> } <br> 20<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif"> } <br> 21<img alt="" align="top" src="https://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockEnd.gif">}</p> 
   <p>鼠标单击标题栏，让屏幕键盘可以接收焦点，并激活，单击其他部分则不激活窗体（如果激活了，其他程序必然取消激活， <br> 输入就无法进行了），这样才可以进行输入，并且保证了可以拖动窗体到其他位置。</p> 
   <p>至此，一个屏幕键盘程序差不多完成了，能够实现与实际键盘完全同步。至于窗体，按键重绘，以及 Num Lock, Caps Lock,</p> 
   <p><br></p> 
   <p><br></p> 
   <p><br></p> 
   <p>本文转自94cool博客园博客，原文链接：http://www.cnblogs.com/94cool/archive/2009/09/04/1560008.html，如需转载请自行联系原作者&nbsp;</p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
