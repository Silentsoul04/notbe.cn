<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Entity Framework 4.1 Code-First 学习笔记 « NotBeCN</title>
  <meta name="description" content="                             　　CodeFirst提供了一种先从代码开始工作，并根据代码直接生成数据库的工作方式。Entity Framework 4.1在你的实体不派生自任何基类、不添加任何特性的时候正常的附加数据库。另外呢，实体的属性也可以添加一些标签，但这些标签不是必须的。下面...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/26/weixin_34198797_90118652.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">Entity Framework 4.1 Code-First 学习笔记</h1>
    <p class="post-meta">Nov 26, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <div>
    <br>
   </div> 
   <div> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">　　CodeFirst提供了一种先从代码开始工作，并根据代码直接生成数据库的工作方式。Entity Framework 4.1在你的实体不派生自任何基类、不添加任何特性的时候正常的附加数据库。另外呢，实体的属性也可以添加一些标签，但这些标签不是必须的。下面是一个简单的示例：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <div> 
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">class</span>
      <span style="line-height:1.5;">&nbsp;Order&nbsp;<br> {&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">int</span>
      <span style="line-height:1.5;">&nbsp;OrderID {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">string</span>
      <span style="line-height:1.5;">&nbsp;OrderTitle {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">string</span>
      <span style="line-height:1.5;">&nbsp;CustomerName {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="line-height:1.5;">&nbsp;DateTime TransactionDate {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br><br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="line-height:1.5;">&nbsp;List</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">OrderDetail</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">&nbsp;OrderDetails {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br> }&nbsp;<br><br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">class</span>
      <span style="line-height:1.5;">&nbsp;OrderDetail&nbsp;<br> {&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">int</span>
      <span style="line-height:1.5;">&nbsp;OrderDetailID {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">int</span>
      <span style="line-height:1.5;">&nbsp;OrderID {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">decimal</span>
      <span style="line-height:1.5;">&nbsp;Cost {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">string</span>
      <span style="line-height:1.5;">&nbsp;ItemName {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br><br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="line-height:1.5;">&nbsp;Order Order {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br> }<br><br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">class</span>
      <span style="line-height:1.5;">&nbsp;MyDomainContext : DbContext&nbsp;<br> {&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="line-height:1.5;">&nbsp;DbSet</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">Order</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">&nbsp;Orders {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="line-height:1.5;">&nbsp;DbSet</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">OrderDetail</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">&nbsp;OrderDetails {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br><br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">static</span>
      <span style="line-height:1.5;">&nbsp;MyDomainContext()&nbsp;<br> {&nbsp;<br> Database.SetInitializer</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">MyDomainContext</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">(<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">new</span>
      <span style="line-height:1.5;">&nbsp;DropCreateDatabaseIfModelChanges</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">MyDomainContext</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">());&nbsp;<br> }&nbsp;<br> }</span> 
     </div> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">　　上面的示例可以看出，Order类和OrderDetail类没有派生自任何基类，也没有附加EF特性，在将它们添加到上下文（上下文需要派生自DbContext）中时，会自动生成相应的数据表。唯一与EF相关的类MyDomainContext是必须的，它用来提供数据的上下文支持，它可以和Order、OrderDetail类不在同一个应用程序集中。</p> 
    <div style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">
     context 必须满足下面的要求：
    </div> 
    <ul style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">
     <li style="list-style:disc;">派生自 System.Data.Entity.DbContext</li> 
     <li style="list-style:disc;">对于你希望使用的每一个实体集定义一个属性</li> 
     <li style="list-style:disc;">每一个属性的类型是 System.Data.Entity.DbSet&lt;T&gt;，T 就是实体的类型</li> 
     <li style="list-style:disc;">每一个属性都是读写属性 read/write ( get/set )</li> 
    </ul>
    <div style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">
     　　在这里，DbContext 基类通过反射来获取映射到数据库的实体。这遵循一系列的约定。
    </div> 
    <div style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">
     例如，对于 Order 来说，他的属性 OrderID 必须是主键，其它的约定将用来推断列名和列的类型，默认数据库中的列名是属性名，使用 string 类型来影射数据库中的 nvarchar(128), 如果属性的类型是可空的，那么，影射到数据库中的允许 NULL 等等。以后我们可以看到如果覆盖这些约定。
    </div> 
    <div style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">
     　　我们将增加一个静态的构造函数，这个静态的构造函数对于整个应用程序域来说建立一个标准，当数据库的上下文初始化的时候，检查数据库的架构是否与模型相符，如果不是的话，将删除数据库然后重新创建它。EF 将会创建一个名为 dbo.EdmMetadata 的表，然后将模型结构的 Hash 保存到其中来实现。
    </div> 
    <div style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">
     　　如果数据库不存在，EF 将会创建它，创建什么数据库呢？默认情况下，将在你的本地机器上，使用上下文对象名称，有许多方式来覆盖这个行为，最简单的方式是在配置文件中增加一个名字为上下文对象名称的数据库连接串，在我这里，叫做 MyDomainContext，还可以通过实现一个构造函数，然后调用非默认的基类构造函数来实现。
    </div> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">----------------------------------------------------------------------------</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">覆盖默认约定有两种方式：</p> 
    <ul style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">
     <li style="list-style:disc;">拦截模型的构建器，使用Fluent API 来修改模型</li> 
     <li style="list-style:disc;">为我们的模型增加标签</li> 
    </ul>
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;"><strong>通过构建器来覆盖默认约定</strong>，我们需要重写&nbsp;DbContext 的一个方法 OnModelCreating：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <div> 
      <span style="color:rgb(0,0,255);line-height:1.5;">protected</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">override</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">void</span>
      <span style="line-height:1.5;">&nbsp;OnModelCreating(DbModelBuilder modelBuilder)&nbsp;<br> {&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">base</span>
      <span style="line-height:1.5;">.OnModelCreating(modelBuilder);&nbsp;<br></span>
      <span style="color:rgb(0,128,0);line-height:1.5;">//</span>
      <span style="color:rgb(0,128,0);line-height:1.5;">Map schemas&nbsp;</span>
      <span style="color:rgb(0,128,0);line-height:1.5;"><br></span>
      <span style="line-height:1.5;">modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">Order</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">().ToTable(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">efdemo.Order</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">);&nbsp;<br> modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">Order</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">().Property(x&nbsp;</span>
      <span style="line-height:1.5;">=&gt;</span>
      <span style="line-height:1.5;">&nbsp;x.OrderID)&nbsp;<br> .HasDatabaseGeneratedOption(DatabaseGeneratedOption.Identity)&nbsp;<br> .IsRequired()&nbsp;<br> .HasColumnName(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">TheOrderID</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">);<br></span>
      <span style="color:rgb(0,128,0);line-height:1.5;">//</span>
      <span style="color:rgb(0,128,0);line-height:1.5;">String columns&nbsp;</span>
      <span style="color:rgb(0,128,0);line-height:1.5;"><br></span>
      <span style="line-height:1.5;">modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">Order</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">().Property(x&nbsp;</span>
      <span style="line-height:1.5;">=&gt;</span>
      <span style="line-height:1.5;">&nbsp;x.OrderTitle)&nbsp;<br> .IsRequired()&nbsp;<br> .HasMaxLength(</span>
      <span style="color:rgb(128,0,128);line-height:1.5;">64</span>
      <span style="line-height:1.5;">);&nbsp;<br> }</span> 
     </div> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">　　这段代码先执行父类的OnModelCreating方法，然后将Order类映射到efdemo架构Order表中，再然后为OrderID设置规则，规定它为标识列，自增，不能为空，且映射到表中的TheOrderID列上面。对于String类型的数据列，还可以指定数据的长度。</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;"><strong>使用标注来覆盖默认约定</strong>，这种方式需要的代码量比较小，且表现的更加自然：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <div> 
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">class</span>
      <span style="line-height:1.5;">&nbsp;Order&nbsp;<br> {&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">int</span>
      <span style="line-height:1.5;">&nbsp;OrderID {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br> [Key]&nbsp;<br> [DatabaseGenerated(DatabaseGeneratedOption.Identity)]&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">int</span>
      <span style="line-height:1.5;">&nbsp;OrderNumber {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br><br> [Required]&nbsp;<br> [StringLength(</span>
      <span style="color:rgb(128,0,128);line-height:1.5;">32</span>
      <span style="line-height:1.5;">, MinimumLength&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(128,0,128);line-height:1.5;">2</span>
      <span style="line-height:1.5;">)]&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">string</span>
      <span style="line-height:1.5;">&nbsp;OrderTitle {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br><br> [Required]&nbsp;<br> [StringLength(</span>
      <span style="color:rgb(128,0,128);line-height:1.5;">64</span>
      <span style="line-height:1.5;">, MinimumLength&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(128,0,128);line-height:1.5;">5</span>
      <span style="line-height:1.5;">)]&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">string</span>
      <span style="line-height:1.5;">&nbsp;CustomerName {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br><br> [Required]&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="line-height:1.5;">&nbsp;DateTime TransactionDate {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br> }</span> 
     </div> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">在上面的这段代码中，我们强制了OrderNumber为主键列，且为自增；OrderTitle为不能为空且最大长度为32，最小长度为2，尽管我们如此规定，但最小长度是不会被映射到数据表中的，这一点可以理解，最小长度会在数据存储时进行验证，如果小于2将会抛出异常，无法完成保存。</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">　　如何在两种覆盖默认约定的方法中进行选择呢？<strong>我们的原则是：使用标注来丰富模型的验证规则；使用 OnModelCreated 来完成数据库的约束（主键，自增长，表名，列类型等等）。</strong></p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">----------------------------------------------------------------------------</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">　　关于数据的加载，在默认情况下，&nbsp;EF4.1 仅仅加载查询中涉及的实体，但是它支持两种特性来帮助你控制加载：<strong>贪婪加载和延迟加载</strong>。</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">　　使用贪婪加载方式获取数据集的代码如下：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
     <div> 
      <span style="line-height:1.5;">var orders&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="line-height:1.5;">&nbsp;from o&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">in</span>
      <span style="line-height:1.5;">&nbsp;context.Orders.Include(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">OrderDetails</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">).Include(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">Businesses</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">)&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">where</span>
      <span style="line-height:1.5;">&nbsp;o.CustomerName&nbsp;</span>
      <span style="line-height:1.5;">==</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">Mac</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">&nbsp;<br> select o;</span> 
     </div> 
    </div> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">　　这段代码在加载Orders的时候，会将OrderDetails信息和Business信息也加载到orders中。这样的查询会引起效率问题，容易使程序性能变差。鉴于性能问题，EF4.1还支持一种延迟加载的数据加载方式，默认情况下，延迟加载是被支持的，如果你希望禁用它，必须显式声明，最好的位置是在 DbContext 的构造器中：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
     <div> 
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="line-height:1.5;">&nbsp;MyDomainContext()&nbsp;<br> {&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">this</span>
      <span style="line-height:1.5;">.Configuration.LazyLoadingEnabled&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">false</span>
      <span style="line-height:1.5;">;&nbsp;<br> }</span> 
     </div> 
    </div> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">当禁用了延迟加载以后，当查询一个实体集的时候，相关的子实体也一并加载。当 EF 访问实体的子实体的时候是如何工作的呢？你的集合是 POCO 的集合，所以，在访问的时候没有事件发生，EF 通过从你定义的实体派生一个动态的对象，然后覆盖你的子实体集合访问属性来实现。这就是为什么需要标记你的子实体集合属性为 virtual 的原因。</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <div> 
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">class</span>
      <span style="line-height:1.5;">&nbsp;Order&nbsp;<br> {&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">int</span>
      <span style="line-height:1.5;">&nbsp;OrderID {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">string</span>
      <span style="line-height:1.5;">&nbsp;OrderTitle {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">string</span>
      <span style="line-height:1.5;">&nbsp;CustomerName {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="line-height:1.5;">&nbsp;DateTime TransactionDate {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span>
      <span style="line-height:1.5;">&nbsp;List</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">OrderDetail</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">&nbsp;OrderDetails {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span>
      <span style="line-height:1.5;">&nbsp;List</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">Business</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">&nbsp;Businesses {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br> }</span> 
     </div> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;"><strong>　　贪婪加载</strong>：减少数据访问的延迟，在一次数据库的访问中返回所有的数据；你需要知道你将作什么，并且显式声明。<strong>延迟加载</strong>：非常宽容，因为只在需要的时候加载数据，不需要预先计划；可能因为数据访问的延迟而降低性能，考虑到每访问父实体的子实体时，就需要访问数据库。两种方式各有优缺点，该怎么选择呢？除非需要循环中加载数据，我使用延迟加载。这样的话，可能会造成2-3 次服务器的查询，但是仍然是可以接受的，特别是考虑到贪婪加载的效率问题</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">----------------------------------------------------------------------------</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">　　默认情况下，EF4.1 将类映射到表，这是约定，但是有时候，我们需要模型比表的粒度更细一些。地址是一个典型的例子，看一下下面的客户类：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <div> 
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">class</span>
      <span style="line-height:1.5;">&nbsp;Client&nbsp;<br> {&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">int</span>
      <span style="line-height:1.5;">&nbsp;ClientID {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br> [Required]&nbsp;<br> [StringLength(</span>
      <span style="color:rgb(128,0,128);line-height:1.5;">32</span>
      <span style="line-height:1.5;">, MinimumLength</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(128,0,128);line-height:1.5;">2</span>
      <span style="line-height:1.5;">)]&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">string</span>
      <span style="line-height:1.5;">&nbsp;ClientName {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="line-height:1.5;">&nbsp;Address ResidentialAddress {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="line-height:1.5;">&nbsp;Address DeliveryAddress {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br> }&nbsp;<br><br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">class</span>
      <span style="line-height:1.5;">&nbsp;Address&nbsp;<br> {&nbsp;<br> [Required]&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">int</span>
      <span style="line-height:1.5;">&nbsp;StreetNumber {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br> [Required]&nbsp;<br> [StringLength(</span>
      <span style="color:rgb(128,0,128);line-height:1.5;">32</span>
      <span style="line-height:1.5;">, MinimumLength</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(128,0,128);line-height:1.5;">2</span>
      <span style="line-height:1.5;">)]&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">string</span>
      <span style="line-height:1.5;">&nbsp;StreetName {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br> }</span> 
     </div> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">　　在上面的例子代码中，Client类的两个Address属性会被映射到表Address中，如果我们希望将Address都映射到一个表中，将地址展开，这需要使用复杂类型，通过构造器来覆盖默认约定，代码如下：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <div> 
      <span style="color:rgb(0,0,255);line-height:1.5;">protected</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">override</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">void</span>
      <span style="line-height:1.5;">&nbsp;OnModelCreating(DbModelBuilder modelBuilder)&nbsp;<br> {&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">base</span>
      <span style="line-height:1.5;">.OnModelCreating(modelBuilder);&nbsp;<br><br> modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">Client</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">().Property(x&nbsp;</span>
      <span style="line-height:1.5;">=&gt;</span>
      <span style="line-height:1.5;">&nbsp;x.ClientID)&nbsp;<br> .HasDatabaseGeneratedOption(DatabaseGeneratedOption.Identity);&nbsp;<br> modelBuilder.ComplexType</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">Address</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">();&nbsp;<br> modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">Client</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">().Property(i&nbsp;</span>
      <span style="line-height:1.5;">=&gt;</span>
      <span style="line-height:1.5;">&nbsp;i.ResidentialAddress.StreetNumber).HasColumnName(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">ResStreetNumber</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">);&nbsp;<br> modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">Client</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">().Property(i&nbsp;</span>
      <span style="line-height:1.5;">=&gt;</span>
      <span style="line-height:1.5;">&nbsp;i.ResidentialAddress.StreetName).HasColumnName(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">ResStreetName</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">);&nbsp;<br> modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">Client</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">().Property(i&nbsp;</span>
      <span style="line-height:1.5;">=&gt;</span>
      <span style="line-height:1.5;">&nbsp;i.DeliveryAddress.StreetNumber).HasColumnName(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">DelStreetNumber</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">);&nbsp;<br> modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">Client</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">().Property(i&nbsp;</span>
      <span style="line-height:1.5;">=&gt;</span>
      <span style="line-height:1.5;">&nbsp;i.DeliveryAddress.StreetName).HasColumnName(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">DelStreetName</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">);&nbsp;<br><br> }</span> 
     </div> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">　　首先，我指定 client-id 作为自动增长的标识列。然后，指定 Address 是复杂类型。如果愿意的话，也可以将 [ComplexType] 标签加到类上来说明。然后，使用 Lambda 表达式将每一个子属性映射到列上，这将会生成如下的表。模型的使用：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <div> 
      <span style="color:rgb(0,0,255);line-height:1.5;">using</span>
      <span style="line-height:1.5;">&nbsp;(var context1&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">new</span>
      <span style="line-height:1.5;">&nbsp;MyDomainContext())&nbsp;<br> {&nbsp;<br> var client&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">new</span>
      <span style="line-height:1.5;">&nbsp;Client&nbsp;<br> {&nbsp;<br> ClientName&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">Joe</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">,&nbsp;<br> ResidentialAddress&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">new</span>
      <span style="line-height:1.5;">&nbsp;Address&nbsp;<br> {&nbsp;<br> StreetNumber&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(128,0,128);line-height:1.5;">15</span>
      <span style="line-height:1.5;">,&nbsp;<br> StreetName&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">Oxford</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">&nbsp;<br> },&nbsp;<br> DeliveryAddress&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">new</span>
      <span style="line-height:1.5;">&nbsp;Address&nbsp;<br> {&nbsp;<br> StreetNumber&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(128,0,128);line-height:1.5;">514</span>
      <span style="line-height:1.5;">,&nbsp;<br> StreetName&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">Nolif</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">&nbsp;<br> }&nbsp;<br> };&nbsp;<br> context1.Clients.Add(client);&nbsp;<br><br> context1.SaveChanges();&nbsp;<br> }&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">using</span>
      <span style="line-height:1.5;">&nbsp;(var context2&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">new</span>
      <span style="line-height:1.5;">&nbsp;MyDomainContext())&nbsp;<br> {&nbsp;<br> var clients&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="line-height:1.5;">&nbsp;from w&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">in</span>
      <span style="line-height:1.5;">&nbsp;context2.Clients&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">where</span>
      <span style="line-height:1.5;">&nbsp;w.ClientName&nbsp;</span>
      <span style="line-height:1.5;">==</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">Joe</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">&nbsp;<br> select w;&nbsp;<br><br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">foreach</span>
      <span style="line-height:1.5;">&nbsp;(var client&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">in</span>
      <span style="line-height:1.5;">&nbsp;clients)&nbsp;<br> {&nbsp;<br> Console.WriteLine(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">client residential StreetNumber:&nbsp;</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">+</span>
      <span style="line-height:1.5;">&nbsp;client.ResidentialAddress.StreetNumber);&nbsp;<br> Console.WriteLine(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">client residential StreetName:&nbsp;</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">+</span>
      <span style="line-height:1.5;">&nbsp;client.ResidentialAddress.StreetName);&nbsp;<br> Console.WriteLine(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">client delivery StreetNumber:&nbsp;</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">+</span>
      <span style="line-height:1.5;">&nbsp;client.DeliveryAddress.StreetNumber);&nbsp;<br> Console.WriteLine(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">client delivery StreetName:&nbsp;</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">+</span>
      <span style="line-height:1.5;">&nbsp;client.DeliveryAddress.StreetName);&nbsp;<br> }&nbsp;<br> }</span> 
     </div> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">对于复杂类型，最值得注意的是空的管理。即使复杂类型的所有属性都是可空的，你也不能将整个复杂类型的对象设为 null, 例如，在这种情况下，即使街道的名称和街道的号码不是必填的，也不能有一个住宅的地址为 null，需要创建一个所有属性都是 null 的地址对象来表示。同样的道理，当你获取一个实体的时候，即使所有的属性都是 null ，EF4.1 也将会创建一个复杂类型的对象。</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">----------------------------------------------------------------------------</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">　　在通常的业务环境中，我们需要处理多对多的关系，例如，一个订单都有哪些员工参与，一个员工参与过哪些订单，这就需要在原有的订单类中加入员工的实体列表，并在员工实体中加入订单的实体列表。相应的实体代码如下：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <div> 
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">class</span>
      <span style="line-height:1.5;">&nbsp;Order&nbsp;<br> {&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">int</span>
      <span style="line-height:1.5;">&nbsp;OrderID {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br> [Required]&nbsp;<br> [StringLength(</span>
      <span style="color:rgb(128,0,128);line-height:1.5;">32</span>
      <span style="line-height:1.5;">, MinimumLength&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(128,0,128);line-height:1.5;">2</span>
      <span style="line-height:1.5;">)]&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">string</span>
      <span style="line-height:1.5;">&nbsp;OrderTitle {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br> [Required]&nbsp;<br> [StringLength(</span>
      <span style="color:rgb(128,0,128);line-height:1.5;">64</span>
      <span style="line-height:1.5;">, MinimumLength</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(128,0,128);line-height:1.5;">5</span>
      <span style="line-height:1.5;">)]&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">string</span>
      <span style="line-height:1.5;">&nbsp;CustomerName {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="line-height:1.5;">&nbsp;DateTime TransactionDate {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">byte</span>
      <span style="line-height:1.5;">[] TimeStamp {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br><br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span>
      <span style="line-height:1.5;">&nbsp;List</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">OrderDetail</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">&nbsp;OrderDetails {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span>
      <span style="line-height:1.5;">&nbsp;List</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">Employee</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">&nbsp;InvolvedEmployees {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br> }&nbsp;<br><br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">class</span>
      <span style="line-height:1.5;">&nbsp;Employee&nbsp;<br> {&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">int</span>
      <span style="line-height:1.5;">&nbsp;EmployeeID {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">string</span>
      <span style="line-height:1.5;">&nbsp;EmployeeName {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br><br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span>
      <span style="line-height:1.5;">&nbsp;List</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">Order</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">&nbsp;Orders {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br> }</span> 
     </div> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">　　有了这段代码，EF就会为我们创建一个订单与员工的对应关系表(OrderEmployee)，这张表中有两个字段：员工ID(Employee_EmployeeID)与订单ID（Order_OrderID)。这是EF的默认约定，如果要修改关系表的名称，并修改对应的字段的名称，我们可以使用下面的代码来完成：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <div> 
      <span style="line-height:1.5;">modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">Employee</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">()&nbsp;<br> .HasMany(e&nbsp;</span>
      <span style="line-height:1.5;">=&gt;</span>
      <span style="line-height:1.5;">&nbsp;e.Orders)&nbsp;<br> .WithMany(e&nbsp;</span>
      <span style="line-height:1.5;">=&gt;</span>
      <span style="line-height:1.5;">&nbsp;e.InvolvedEmployees)&nbsp;<br> .Map(m&nbsp;</span>
      <span style="line-height:1.5;">=&gt;</span>
      <span style="line-height:1.5;">&nbsp;<br> {&nbsp;<br> m.ToTable(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">EmployeeOrder</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">);&nbsp;<br> m.MapLeftKey(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">EmployeeID</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">);&nbsp;<br> m.MapRightKey(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">OrderID</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">);&nbsp;<br> });</span> 
     </div> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">通过这段代码，还可以控制没有映射到表的类。下面我们来测试这个模型：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <div> 
      <span style="color:rgb(0,0,255);line-height:1.5;">using</span>
      <span style="line-height:1.5;">&nbsp;(var context&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">new</span>
      <span style="line-height:1.5;">&nbsp;MyDomainContext())&nbsp;<br> {&nbsp;<br> var order&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">new</span>
      <span style="line-height:1.5;">&nbsp;Order&nbsp;<br> {&nbsp;<br> OrderTitle&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">Pens</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">,&nbsp;<br> CustomerName&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">Mcdo’s</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">,&nbsp;<br> TransactionDate&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="line-height:1.5;">&nbsp;DateTime.Now,&nbsp;<br> InvolvedEmployees&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">new</span>
      <span style="line-height:1.5;">&nbsp;List</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">Employee</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">()&nbsp;<br> };&nbsp;<br> var employee1&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">new</span>
      <span style="line-height:1.5;">&nbsp;Employee { EmployeeName&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">Joe</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">, Orders&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">new</span>
      <span style="line-height:1.5;">&nbsp;List</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">Order</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">() };&nbsp;<br> var employee2&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">new</span>
      <span style="line-height:1.5;">&nbsp;Employee { EmployeeName&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">Black</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">, Orders&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">new</span>
      <span style="line-height:1.5;">&nbsp;List</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">Order</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">() };&nbsp;<br><br> context.Orders.Add(order);&nbsp;<br><br> order.InvolvedEmployees.Add(employee1);&nbsp;<br> order.InvolvedEmployees.Add(employee2);&nbsp;<br><br> context.SaveChanges();&nbsp;<br> }</span> 
     </div> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">在这个例子中，我甚至都没有在数据上下文中将雇员加入到雇员的集合中，因为他们被引用到订单的集合中，EF 帮我们完成了。</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">----------------------------------------------------------------------------</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">　　通常情况下，我们的业务环境需要有并发的处理。对于悲观的并发处理，需要加入记录锁的机制，随之而来带来一些问题，例如，在自动释放锁之前，系统应该锁定多长的时间；乐观并发要简单一些，乐观并发假定用户的修改很少冲突，我们要在记录中加入数据行的版本号，当用户保存记录的时候，通过验证版本号，如果版本号一致，则验证通过，进行保存，如果版本号不一致，则拒绝保存。</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">　　在 EF 中，这被称为<strong>并发标识 concurrenty token</strong>，在这篇文章中，我使用 SQL Server 的 time-stamp 特性，这需要在表中增加一个 time-stamp 类型的列，我们通过它来实现乐观并发。由 SQL Server 在每次记录被更新的时候维护这个列。为了告诉 EF 在实体中有一个属性表示并发标识，你可以通过标签 [ConcurrencyCheck] 来标识这个属性，或者使用模型构建器。我认为并发标识定义了业务规则，应该是模型的一部分。所以这里使用标签。相应的模型代码如下：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <div> 
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">class</span>
      <span style="line-height:1.5;">&nbsp;Order&nbsp;<br> {&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">int</span>
      <span style="line-height:1.5;">&nbsp;OrderID {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br> [Required]&nbsp;<br> [StringLength(</span>
      <span style="color:rgb(128,0,128);line-height:1.5;">32</span>
      <span style="line-height:1.5;">, MinimumLength&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(128,0,128);line-height:1.5;">2</span>
      <span style="line-height:1.5;">)]&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">string</span>
      <span style="line-height:1.5;">&nbsp;OrderTitle {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br> [Required]&nbsp;<br> [StringLength(</span>
      <span style="color:rgb(128,0,128);line-height:1.5;">64</span>
      <span style="line-height:1.5;">, MinimumLength</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(128,0,128);line-height:1.5;">5</span>
      <span style="line-height:1.5;">)]&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">string</span>
      <span style="line-height:1.5;">&nbsp;CustomerName {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="line-height:1.5;">&nbsp;DateTime TransactionDate {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br><span style="color:rgb(255,102,0);line-height:1.5;">[ConcurrencyCheck]&nbsp;</span><br><span style="color:rgb(255,102,0);line-height:1.5;">[Timestamp]&nbsp;</span><br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">byte</span>
      <span style="line-height:1.5;">[] TimeStamp {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br><br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span>
      <span style="line-height:1.5;">&nbsp;List</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">OrderDetail</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">&nbsp;OrderDetails {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span>
      <span style="line-height:1.5;">&nbsp;List</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">Employee</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">&nbsp;InvolvedEmployees {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br> }</span> 
     </div> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">　　在这段代码中，当我们通过 DbContext 调用 SaveChanges 的时候，将会使用乐观并发。Timestamp 属性的类型是 byte[], 通过标签 Timestamp ，将这个属性映射到 SQL Server 的 time-stamp 类型的列。</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">----------------------------------------------------------------------------</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">在 ORM 文献中，有三种方式将对象的继承关系映射到表中。</p> 
    <ul style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">
     <li style="list-style:disc;">每个类型一张表 TPT: 在继承层次中的每个类都分别映射到数据库中的一张表，彼此之间通过外键关联。</li> 
     <li style="list-style:disc;">继承层次中所有的类型一张表 TPH：对于继承层次中的所有类型都映射到一张表中，所有的数据都在这张表中。</li> 
     <li style="list-style:disc;">每种实现类型一张表 TPC: 有点像其他两个的混合，对于每种实现类型映射到一张表，抽象类型像 TPH 一样展开到表中。</li> 
    </ul>
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">这里我将讨论 TPT 和 TPH，EF 的好处是可以混合使用这些方式。</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">为了模拟实际的业务需求，我定义了一个简单的继承层次，一个抽象基类和两个派生类，代码如下：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <div> 
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">abstract</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">class</span>
      <span style="line-height:1.5;">&nbsp;PersonBase&nbsp;<br> {&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">int</span>
      <span style="line-height:1.5;">&nbsp;PersonID {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br> [Required]&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">string</span>
      <span style="line-height:1.5;">&nbsp;FirstName {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br> [Required]&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">string</span>
      <span style="line-height:1.5;">&nbsp;LastName {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">int</span>
      <span style="line-height:1.5;">&nbsp;Age {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br> }<br><br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">class</span>
      <span style="line-height:1.5;">&nbsp;Worker : PersonBase&nbsp;<br> {&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">decimal</span>
      <span style="line-height:1.5;">&nbsp;AnnualSalary {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br> }<br><br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">class</span>
      <span style="line-height:1.5;">&nbsp;Retired : PersonBase&nbsp;<br> {&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">decimal</span>
      <span style="line-height:1.5;">&nbsp;MonthlyPension {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br> }</span> 
     </div> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;"><strong>使用TPT方式</strong>：我们需要告诉构造器如何创建表：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <div> 
      <span style="color:rgb(0,0,255);line-height:1.5;">protected</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">override</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">void</span>
      <span style="line-height:1.5;">&nbsp;OnModelCreating(DbModelBuilder modelBuilder)&nbsp;<br> {&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">base</span>
      <span style="line-height:1.5;">.OnModelCreating(modelBuilder);&nbsp;<br><br> modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">PersonBase</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">().HasKey(x&nbsp;</span>
      <span style="line-height:1.5;">=&gt;</span>
      <span style="line-height:1.5;">&nbsp;x.PersonID);&nbsp;<br> modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">PersonBase</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">().Property(x&nbsp;</span>
      <span style="line-height:1.5;">=&gt;</span>
      <span style="line-height:1.5;">&nbsp;x.PersonID)&nbsp;<br> .HasDatabaseGeneratedOption(DatabaseGeneratedOption.Identity);&nbsp;<br></span>
      <span style="color:rgb(0,128,0);line-height:1.5;">//</span>
      <span style="color:rgb(0,128,0);line-height:1.5;">&nbsp;TPT mapping&nbsp;</span>
      <span style="color:rgb(0,128,0);line-height:1.5;"><br></span>
      <span style="line-height:1.5;">modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">PersonBase</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">().ToTable(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">tpt.Person</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">);&nbsp;<br> modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">Worker</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">().ToTable(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">tpt.Worker</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">);&nbsp;<br> modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">Retired</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">().ToTable(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">tpt.Retired</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">);&nbsp;<br> }</span> 
     </div> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;"><strong>使用TPH方式</strong>：TPH 是 EF 实际上默认支持的。我们可以简单地注释到前面例子中的对表的映射来使用默认的机制。</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <div> 
      <span style="color:rgb(0,0,255);line-height:1.5;">protected</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">override</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">void</span>
      <span style="line-height:1.5;">&nbsp;OnModelCreating(DbModelBuilder modelBuilder)&nbsp;<br> {&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">base</span>
      <span style="line-height:1.5;">.OnModelCreating(modelBuilder);&nbsp;<br><br> modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">PersonBase</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">().HasKey(x&nbsp;</span>
      <span style="line-height:1.5;">=&gt;</span>
      <span style="line-height:1.5;">&nbsp;x.PersonID);&nbsp;<br> modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">PersonBase</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">().Property(x&nbsp;</span>
      <span style="line-height:1.5;">=&gt;</span>
      <span style="line-height:1.5;">&nbsp;x.PersonID)&nbsp;<br> .HasDatabaseGeneratedOption(DatabaseGeneratedOption.Identity);&nbsp;<br></span>
      <span style="color:rgb(0,128,0);line-height:1.5;">//</span>
      <span style="color:rgb(0,128,0);line-height:1.5;">&nbsp;TPT mapping&nbsp;<br></span>
      <span style="color:rgb(0,128,0);line-height:1.5;">//</span>
      <span style="color:rgb(0,128,0);line-height:1.5;">modelBuilder.Entity&lt;PersonBase&gt;().ToTable("tpt.Person");&nbsp;<br></span>
      <span style="color:rgb(0,128,0);line-height:1.5;">//</span>
      <span style="color:rgb(0,128,0);line-height:1.5;">modelBuilder.Entity&lt;Worker&gt;().ToTable("tpt.Worker");&nbsp;<br></span>
      <span style="color:rgb(0,128,0);line-height:1.5;">//</span>
      <span style="color:rgb(0,128,0);line-height:1.5;">modelBuilder.Entity&lt;Retired&gt;().ToTable("tpt.Retired");&nbsp;</span>
      <span style="color:rgb(0,128,0);line-height:1.5;"><br></span>
      <span style="line-height:1.5;">}</span> 
     </div> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">结果是现在使用一张表来影射整个的继承层次。整个的层次被展开到一张表中，基类中没有的属性被自动标记为可空。还有一个额外的区分列，用来保存数据是属于哪一个类，当 EF 读取一行的时候，区分列被 EF 用来知道应该创建实例的类型，因为现在所有的类都被映射到了一张表中。</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;"><strong>混合使用 TPH 和 TPT</strong>：我定义了 Worker 的两个子类，我希望将这两个类和 Worker 基类映射到一张表：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <div> 
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">class</span>
      <span style="line-height:1.5;">&nbsp;Manager : Worker&nbsp;<br> {&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">int</span>
      <span style="line-height:1.5;">?</span>
      <span style="line-height:1.5;">&nbsp;ManagedEmployeesCount {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br> }&nbsp;<br><br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">class</span>
      <span style="line-height:1.5;">&nbsp;FreeLancer : Worker&nbsp;<br> {&nbsp;<br> [Required]&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">string</span>
      <span style="line-height:1.5;">&nbsp;IncCompanyName {&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">get</span>
      <span style="line-height:1.5;">;&nbsp;</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">set</span>
      <span style="line-height:1.5;">; }&nbsp;<br> }</span> 
     </div> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">注意：每一个属性都必须是可空的。这在 TPH 中非常不方便，现在我们使用模型构建器来完成。</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <div> 
      <span style="color:rgb(0,0,255);line-height:1.5;">protected</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">override</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">void</span>
      <span style="line-height:1.5;">&nbsp;OnModelCreating(DbModelBuilder modelBuilder)&nbsp;<br> {&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">base</span>
      <span style="line-height:1.5;">.OnModelCreating(modelBuilder);&nbsp;<br><br> modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">PersonBase</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">().HasKey(x&nbsp;</span>
      <span style="line-height:1.5;">=&gt;</span>
      <span style="line-height:1.5;">&nbsp;x.PersonID);&nbsp;<br> modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">PersonBase</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">().Property(x&nbsp;</span>
      <span style="line-height:1.5;">=&gt;</span>
      <span style="line-height:1.5;">&nbsp;x.PersonID)&nbsp;<br> .HasDatabaseGeneratedOption(DatabaseGeneratedOption.Identity);&nbsp;<br></span>
      <span style="color:rgb(0,128,0);line-height:1.5;">//</span>
      <span style="color:rgb(0,128,0);line-height:1.5;">&nbsp;TPT mapping&nbsp;</span>
      <span style="color:rgb(0,128,0);line-height:1.5;"><br></span>
      <span style="line-height:1.5;">modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">PersonBase</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">().ToTable(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">tpt.Person</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">);&nbsp;<br> modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">Retired</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">().ToTable(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">tpt.Retired</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">);&nbsp;<br></span>
      <span style="color:rgb(0,128,0);line-height:1.5;">//</span>
      <span style="color:rgb(0,128,0);line-height:1.5;">&nbsp;TPH mapping&nbsp;</span>
      <span style="color:rgb(0,128,0);line-height:1.5;"><br></span>
      <span style="line-height:1.5;">modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">Worker</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">()&nbsp;<br> .Map</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">FreeLancer</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">(m&nbsp;</span>
      <span style="line-height:1.5;">=&gt;</span>
      <span style="line-height:1.5;">&nbsp;m.Requires(f&nbsp;</span>
      <span style="line-height:1.5;">=&gt;</span>
      <span style="line-height:1.5;">&nbsp;f.IncCompanyName).HasValue())&nbsp;<br> .Map</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">Manager</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">(m&nbsp;</span>
      <span style="line-height:1.5;">=&gt;</span>
      <span style="line-height:1.5;">&nbsp;m.Requires(ma&nbsp;</span>
      <span style="line-height:1.5;">=&gt;</span>
      <span style="line-height:1.5;">&nbsp;ma.ManagedEmployeesCount).HasValue())&nbsp;<br> .ToTable(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">tph.Worker</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">);&nbsp;<br> }</span> 
     </div> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">&nbsp;</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">----------------------------------------------------------------------------</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">像所有优秀的框架一样，EF 知道它并不能优秀到覆盖所有的角落，通过允许直接访问数据库，EF 支持开放底层的 ADO.NET 框架。EF开放了三个API支持直接查询：</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;"><strong>　　DbContext.Database.ExecuteSqlCommand</strong>：这是一个典型的ADO.NET的Command对象，不做解释。</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;"><strong>　　DbContext.Database.SqlQuery</strong>：这个方法将返回的数据集映射到相应的对象，而不去管这个对象是不是实体。重要的是 EF 不会跟踪返回的对象，即使他们是真正的实体对象。</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;"><strong>　　DbSet.SqlQuery</strong>：这个方法返回的实体将会被 EF 跟踪修改，所以，如果你在这些返回的实体上做了修改，当 DbContext.SaveChanges 被调用的时候，将会被处理。从另一个方面来说，也不能覆盖列的映射。</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">　　另外一个 EF 映射管理的方法是使用 Entity SQL，这种方式是 EF 将实体模型转换为物理模型，然后将Linq查询添加到物理模型中，最后将物理模型转换为数据库存储的查询。举例来说，我们可以不在DbContext中定义，而获得我们需要的实体集：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <div> 
      <span style="color:rgb(0,0,255);line-height:1.5;">protected</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">override</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">void</span>
      <span style="line-height:1.5;">&nbsp;OnModelCreating(DbModelBuilder modelBuilder)&nbsp;<br> {&nbsp;<br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">base</span>
      <span style="line-height:1.5;">.OnModelCreating(modelBuilder);&nbsp;<br><br> modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">SimpleEntry</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">().HasEntitySetName(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">MyEntry</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">);&nbsp;<br> modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">SimpleEntry</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">().ToTable(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">MyEntry</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">,&nbsp;</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">man</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">);&nbsp;<br> modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">SimpleEntry</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">()&nbsp;<br> .Property(s&nbsp;</span>
      <span style="line-height:1.5;">=&gt;</span>
      <span style="line-height:1.5;">&nbsp;s.ID)&nbsp;<br> .HasColumnName(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">SimpleEntryID</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">);&nbsp;<br> modelBuilder.Entity</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">SimpleEntry</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">()&nbsp;<br> .Property(s&nbsp;</span>
      <span style="line-height:1.5;">=&gt;</span>
      <span style="line-height:1.5;">&nbsp;s.Name)&nbsp;<br> .HasColumnName(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">SimpleEntryName</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">);&nbsp;<br> }</span> 
     </div> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">然后，我们将查询方法暴漏出来：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <div> 
      <span style="color:rgb(0,0,255);line-height:1.5;">public</span>
      <span style="line-height:1.5;">&nbsp;IEnumerable</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">SimpleEntry</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">&nbsp;GetSimpleEntries()&nbsp;<br> {&nbsp;<br> IObjectContextAdapter adapter&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="color:rgb(0,0,255);line-height:1.5;">this</span>
      <span style="line-height:1.5;">;&nbsp;<br> var entries&nbsp;</span>
      <span style="line-height:1.5;">=</span>
      <span style="line-height:1.5;">&nbsp;adapter.ObjectContext.CreateQuery</span>
      <span style="line-height:1.5;">&lt;</span>
      <span style="line-height:1.5;">SimpleEntry</span>
      <span style="line-height:1.5;">&gt;</span>
      <span style="line-height:1.5;">(</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">SELECT VALUE MyEntry FROM MyEntry</span>
      <span style="color:rgb(128,0,0);line-height:1.5;">"</span>
      <span style="line-height:1.5;">);&nbsp;<br><br></span>
      <span style="color:rgb(0,0,255);line-height:1.5;">return</span>
      <span style="line-height:1.5;">&nbsp;entries;&nbsp;<br> }</span> 
     </div> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">　　这里使用了ObjectContext进行查询，和直接使用Sql进行查询的优势在于，我们可以在 LINQ 之上进行查询，最终进行查询的 SQL 是经过合并的。因此，我们可以通过从一个返回任何结果的简单查询开始，然后在其上应用 LINQ来得到有效的查询，而不需要在使用方查询整个表。</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">　　现在，如果你希望能够截获实体的 Insert, Update, 和 Delete 操作，就要靠你自己了。你需要重写 DbContext.SaveChanges ，获取特定状态的实体，实现自己的数据操作逻辑来保存修改，然后在调用 base.SaveChanges 之前将这些实体的状态切换到 Unmodified 。这可以用，但这是一种特殊的技巧。</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">----------------------------------------------------------------------------</p> 
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">参考文档：<a href="http://www.cnblogs.com/haogj/" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">冠军</a>的博客</p> 
    <ol style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">
     <li style="list-style:decimal;"><a id="ctl08_TitleUrl" href="http://www.cnblogs.com/haogj/archive/2011/05/06/2038965.html" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">Entity Framework 4.1 之一 : 基础</a></li> 
     <li style="list-style:decimal;"><a href="http://www.cnblogs.com/haogj/archive/2011/05/06/2039149.html" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">Entity Framework 4.1 之二 : 覆盖默认的约定</a></li> 
     <li style="list-style:decimal;"><a href="http://www.cnblogs.com/haogj/archive/2011/05/07/2039620.html" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">Entity Framework 4.1 之三 : 贪婪加载和延迟加载</a></li> 
     <li style="list-style:decimal;"><a href="http://www.cnblogs.com/haogj/archive/2011/05/07/2040093.html" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">Entity Framework 4.1 之四：复杂类型</a></li> 
     <li style="list-style:decimal;"><a href="http://www.cnblogs.com/haogj/archive/2011/05/07/2040106.html" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">Entity Framework 4.1 之五：多对多的关系</a></li> 
     <li style="list-style:decimal;"><a href="http://www.cnblogs.com/haogj/archive/2011/05/08/2040190.html" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">Entity Framework 4.1 之六：乐观并发</a></li> 
     <li style="list-style:decimal;"><a href="http://www.cnblogs.com/haogj/archive/2011/05/08/2040193.html" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">Entity Framework 4.1 之七：继承</a></li> 
     <li style="list-style:decimal;"><a href="http://www.cnblogs.com/haogj/archive/2011/05/08/2040196.html" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">Entity Framework 4.1 之八：绕过 EF 查询映射</a></li> 
    </ol>
    <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;">英文原文地址：</p> 
    <ul>
     <li style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;list-style:disc;"><a href="http://vincentlauzon.wordpress.com/2011/04/03/entity-framework-4-1-basics-1/" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">Basics (1)</a></li> 
     <li style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;list-style:disc;"><a href="http://vincentlauzon.wordpress.com/2011/04/06/entity-framework-4-1-override-conventions-2/" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">Override conventions (2)</a></li> 
     <li style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;list-style:disc;"><a href="http://vincentlauzon.wordpress.com/2011/04/11/entity-framework-4-1-deep-fetch-vs-lazy-load-3/" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">Deep Fetch vs Lazy Load (3)</a></li> 
     <li style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;list-style:disc;"><a href="http://vincentlauzon.wordpress.com/2011/04/13/entity-framework-4-1-complex-types-4/" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">Complex Types (4)</a></li> 
     <li style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;list-style:disc;"><a href="http://vincentlauzon.wordpress.com/2011/04/15/entity-framework-4-1-many-to-many-relationships-5/" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">Many to Many Relationships (5)</a></li> 
     <li style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;list-style:disc;"><a href="http://vincentlauzon.wordpress.com/2011/04/17/entity-framework-4-1-optimistic-concurrency-6/" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">Optimistic Concurrency (6)</a></li> 
     <li style="list-style:disc;"> <a href="http://vincentlauzon.wordpress.com/2011/04/19/entity-framework-4-1-inheritance-7/" rel="nofollow" style="color:rgb(0,0,0);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:13.3333px;text-decoration:none;border-bottom:1px dotted rgb(51,51,51);">Inheritance (7)</a> </li> 
     <li style="list-style:disc;"><font><span style="font-size:13.3333px;"><br></span></font></li> 
     <li style="list-style:disc;"><font><span style="font-size:13.3333px;"><br></span></font></li> 
     <li style="list-style:disc;"><font><span style="font-size:13.3333px;"><br></span></font></li> 
     <li style="list-style:disc;"><font><span style="font-size:13.3333px;">本文转自齐师傅博客园博客，原文链接：http://www.cnblogs.com/youring2/archive/2011/06/26/2090424.html，如需转载请自行联系原作者</span></font></li> 
    </ul>
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
