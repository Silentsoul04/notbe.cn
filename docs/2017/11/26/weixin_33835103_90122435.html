<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>ASP.NET MVC 5 学习教程：数据迁移之添加字段 « NotBeCN</title>
  <meta name="description" content="                                起飞网 ASP.NET MVC 5 学习教程目录：            添加控制器       添加视图       修改视图和布局页       控制器传递数据给视图       添加模型       创建连接字符串       通过控制器访问模...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/26/weixin_33835103_90122435.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">ASP.NET MVC 5 学习教程：数据迁移之添加字段</h1>
    <p class="post-meta">Nov 26, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <h1></h1> 
   <div class="clear"></div> 
   <div class="postBody"> 
    <div class="blogpost-body"> 
     <p><a href="http://www.qeefee.com/" rel="nofollow">起飞网</a> ASP.NET MVC 5 学习教程目录：</p> 
     <ul>
      <li><a href="http://www.qeefee.com/mvc/mvc-5-adding-a-controller" rel="nofollow">添加控制器</a></li> 
      <li><a href="http://www.qeefee.com/mvc/mvc-5-adding-a-view" rel="nofollow">添加视图</a></li> 
      <li><a href="http://www.qeefee.com/mvc/mvc-5-changing-views-and-layout-pages" rel="nofollow">修改视图和布局页</a></li> 
      <li><a href="http://www.qeefee.com/mvc/mvc-5-passing-data-from-the-controller-to-the-view" rel="nofollow">控制器传递数据给视图</a></li> 
      <li><a href="http://www.qeefee.com/mvc/mvc-5-adding-a-model" rel="nofollow">添加模型</a></li> 
      <li><a href="http://www.qeefee.com/mvc/mvc-5-creating-a-connection-string" rel="nofollow">创建连接字符串</a></li> 
      <li><a href="http://www.qeefee.com/mvc/mvc-5-accessing-your-models-data-from-a-controller" rel="nofollow">通过控制器访问模型的数据</a></li> 
      <li><a href="http://www.qeefee.com/mvc/mvc-5-examining-the-generated-code" rel="nofollow">生成的代码详解</a></li> 
      <li><a href="http://www.qeefee.com/mvc/mvc-5-working-with-localdb" rel="nofollow">使用 SQL Server LocalDB</a></li> 
      <li><a href="http://www.qeefee.com/mvc/mvc-5-examining-the-edit-methods-and-edit-view" rel="nofollow">Edit方法和Edit视图详解</a></li> 
      <li><a href="http://www.qeefee.com/mvc/mvc-5-adding-search" rel="nofollow">添加查询</a></li> 
      <li><a href="http://www.qeefee.com/mvc/mvc-5-adding-a-new-field" rel="nofollow">Entity Framework 数据迁移之添加字段</a></li> 
      <li><a href="http://www.qeefee.com/mvc/mvc-5-adding-validation" rel="nofollow">添加验证</a></li> 
      <li><a href="http://www.qeefee.com/mvc/mvc-5-examining-the-details-and-delete-methods" rel="nofollow">Details 和 Delete 方法详解</a></li> 
     </ul>
     <p>在本节中，我们将使用Entity Framework Code First 数据迁移功能将模型类的改变应用到数据库中。</p> 
     <p>默认情况下，当我们使用Entity Framework Code First 自动创建一个数据库，像我们之前教程中讲的那样，Code First 添加一个table帮我们跟踪数据库结构是否与模型类同步。如果不同步，Entity Framework 将抛出一个错误，这样更方便我们在开发的时候发现问题，否则只能在运行时通过晦涩的错误来查找了。</p> 
     <h2>为模型更改设置 Code First 数据迁移</h2> 
     <p>在解决方案资源管理器中，删除自动创建的 Movies.mdf 文件。</p> 
     <p>在工具菜单中，选择“库程序包管理器”&gt;“程序包管理器控制台”：</p> 
     <p><strong>图1：打开“程序包管理器控制台”菜单项</strong></p> 
     <p><a href="https://images0.cnblogs.com/blog/44814/201307/24112019-959f1ee942d646a3950cbd0f75443112.png" rel="nofollow"><img style="border-width:0px;background-image:none;" title="image" alt="image" src="https://images0.cnblogs.com/blog/44814/201307/24112020-40b57c909a9d47f293b6647d1ca3f937.png" width="599" height="314"></a></p> 
     <p>在“程序包管理器控制台”窗口中输入：<span style="font-family:'Courier New';">Enable-Migrations -ContextTypeName MvcMovie.Models.MovieDBContext</span></p> 
     <p><strong>图2：运行命令</strong></p> 
     <p><a href="https://images0.cnblogs.com/blog/44814/201307/24112021-9db7aae367d74ad48ceb5fc3f1df8a72.png" rel="nofollow"><img style="border-width:0px;background-image:none;" title="image" alt="image" src="https://images0.cnblogs.com/blog/44814/201307/24112021-173019030de644bca73079ef20a9817c.png" width="640" height="273"></a></p> 
     <p><span style="font-family:'Courier New';">Enable-Migrations</span> 命令创建了一个<span style="font-family:'Courier New';">Migrations</span>文件夹和<span style="font-family:'Courier New';">Configuration.cs</span>文件。</p> 
     <p><strong>图3：新添加的文件</strong></p> 
     <p><a href="https://images0.cnblogs.com/blog/44814/201307/24112022-47083e627a274bee84430ad0008967ba.png" rel="nofollow"><img style="border-width:0px;background-image:none;" title="image" alt="image" src="https://images0.cnblogs.com/blog/44814/201307/24112022-2ec4c4a4f5a345deaff1dea8c5784467.png" width="308" height="436"></a></p> 
     <p>打开 Configuration.cs 文件，使用以下代码替换 Seed 方法：</p> 
     <p><strong>代码清单1：Seed 方法 - Configruation.cs</strong></p> 
     <pre class="code"><span style="color:#0000FF;">protected override void </span>Seed(MvcMovie.Models.<span style="color:rgb(43,145,175);">MovieDBContext </span>context)
{
    context.Movies.AddOrUpdate(i =&gt; i.Title,
        <span style="color:#0000FF;">new </span><span style="color:rgb(43,145,175);">Movie
        </span>{
            Title = <span style="color:rgb(163,21,21);">"When Harry Met Sally"</span>,
            ReleaseDate = <span style="color:rgb(43,145,175);">DateTime</span>.Parse(<span style="color:rgb(163,21,21);">"1989-1-11"</span>),
            Genre = <span style="color:rgb(163,21,21);">"Romantic Comedy"</span>,
            Price = 7.99M
        },

         <span style="color:#0000FF;">new </span><span style="color:rgb(43,145,175);">Movie
         </span>{
             Title = <span style="color:rgb(163,21,21);">"Ghostbusters "</span>,
             ReleaseDate = <span style="color:rgb(43,145,175);">DateTime</span>.Parse(<span style="color:rgb(163,21,21);">"1984-3-13"</span>),
             Genre = <span style="color:rgb(163,21,21);">"Comedy"</span>,
             Price = 8.99M
         },

         <span style="color:#0000FF;">new </span><span style="color:rgb(43,145,175);">Movie
         </span>{
             Title = <span style="color:rgb(163,21,21);">"Ghostbusters 2"</span>,
             ReleaseDate = <span style="color:rgb(43,145,175);">DateTime</span>.Parse(<span style="color:rgb(163,21,21);">"1986-2-23"</span>),
             Genre = <span style="color:rgb(163,21,21);">"Comedy"</span>,
             Price = 9.99M
         },

       <span style="color:#0000FF;">new </span><span style="color:rgb(43,145,175);">Movie
       </span>{
           Title = <span style="color:rgb(163,21,21);">"Rio Bravo"</span>,
           ReleaseDate = <span style="color:rgb(43,145,175);">DateTime</span>.Parse(<span style="color:rgb(163,21,21);">"1959-4-15"</span>),
           Genre = <span style="color:rgb(163,21,21);">"Western"</span>,
           Price = 3.99M
       }
   );
}</pre> 
     <p>使用这段代码的时候，需要添加 using MvcMovie.Models 的引用。</p> 
     <p>Code First 数据迁移在每次迁移（在程序包管理器控制台中调用 update-database）的时候都会调用Seed方法。</p> 
     <p>在进行下一步之前，先编译解决方案，否则下一步会出错误。</p> 
     <p>下一步，为初始化迁移创建一个 DbMigration 类。这次迁移创建一个新数据库，这也是我们为什么要删除之前的数据库的原因。</p> 
     <p>在“程序包管理器控制台”窗口，输入命令 <code>add-migration Initial</code> 创建初始化迁移。名称“Initial”是随意命名的，它用来命名创建好的迁移文件。</p> 
     <p><strong>图4：创建初始化迁移</strong></p> 
     <p><a href="https://images0.cnblogs.com/blog/44814/201307/24112023-3e44582103af4837af4c89e2a97035ec.png" rel="nofollow"><img style="border-width:0px;background-image:none;" title="image" alt="image" src="https://images0.cnblogs.com/blog/44814/201307/24112024-9252e46ff2ab410e97e4e2f623bac861.png" width="640" height="156"></a></p> 
     <p>Code First Migrations 创建在Migrations文件夹中创建了一个文件（文件名是 <em>{DateStamp}_Initial.cs</em> ），这个类包含了创建数据库结构的代码。迁移文件的文件名以DateStamp开头是为了更好的排序，打开 <em>{DateStamp}_Initial.cs</em> 文件，它包含了为数据库MovieDB创建Movies表的指令。当你使用下面的命令更新数据库时，<em>{DateStamp}_Initial.cs</em> 文件将会运行并创建数据库结构，然后将执行 Seed 方法将测试数据插入数据库中。</p> 
     <p>在“程序包管理器控制台”中输入命令 <code>update-database</code> ：</p> 
     <p><strong>图5：执行更新数据库命令</strong></p> 
     <p><a href="https://images0.cnblogs.com/blog/44814/201307/24112024-bee550a35c9d4691b33d6fd576e12fcc.png" rel="nofollow"><img style="border-width:0px;background-image:none;" title="image" alt="image" src="https://images0.cnblogs.com/blog/44814/201307/24112025-12ad63abb66649d08a3190d94dbbe1c2.png" width="640" height="156"></a></p> 
     <p>运行应用程序，浏览/Movies 地址，我们在Seed方法中添加的数据如下：</p> 
     <p><strong>图6：浏览程序</strong></p> 
     <p><a href="https://images0.cnblogs.com/blog/44814/201307/24112026-1b6ad821fcdc4ff2962aef1c996b52a7.png" rel="nofollow"><img style="border-width:0px;background-image:none;" title="image" alt="image" src="https://images0.cnblogs.com/blog/44814/201307/24112026-d6e84a0be95a4e00be57e8b5f83844ca.png" width="541" height="480"></a></p> 
     <h2>为Movie模型添加Rating字段</h2> 
     <p>上面的内容一直在介绍如何进行数据迁移，现在开始为Movie类添加Rating字段，打开Movie.cs 文件，为它添加一个Rating字段，添加后的代码如下：</p> 
     <p><strong>代码清单2：添加Rating字段后的Movie类</strong></p> 
     <pre class="code"><span style="color:#0000FF;">public class </span><span style="color:rgb(43,145,175);">Movie
</span>{
    <span style="color:#0000FF;">public int </span>ID { <span style="color:#0000FF;">get</span>; <span style="color:#0000FF;">set</span>; }
    <span style="color:#0000FF;">public string </span>Title { <span style="color:#0000FF;">get</span>; <span style="color:#0000FF;">set</span>; }
    [<span style="color:rgb(43,145,175);">Display</span>(Name = <span style="color:rgb(163,21,21);">"Release Date"</span>)]
    [<span style="color:rgb(43,145,175);">DataType</span>(<span style="color:rgb(43,145,175);">DataType</span>.Date)]
    <span style="color:#0000FF;">public </span><span style="color:rgb(43,145,175);">DateTime </span>ReleaseDate { <span style="color:#0000FF;">get</span>; <span style="color:#0000FF;">set</span>; }
    <span style="color:#0000FF;">public string </span>Genre { <span style="color:#0000FF;">get</span>; <span style="color:#0000FF;">set</span>; }
    <span style="color:#0000FF;">public decimal </span>Price { <span style="color:#0000FF;">get</span>; <span style="color:#0000FF;">set</span>; }
    </pre> 
     <p><span><span style="color:#0000FF;">public string </span>Rating { <span style="color:#0000FF;">get</span>; <span style="color:#0000FF;">set</span></span></p> 
     <pre class="code"><span>; }</span>
}</pre> 
     <p>编译解决方案。</p> 
     <p>现在我们已经更新了Movie类，你还需要修改<em>\Views\Movies\Index.cshtml</em> 和 <em>\Views\Movies\Create.cshtml</em> 视图。修改后的代码如下：</p> 
     <p><strong>代码清单3：修改后的Index.cshtml</strong></p> 
     <pre class="code">@model <span style="color:rgb(43,145,175);">IEnumerable</span>&lt;MvcMovie.Models.<span style="color:rgb(43,145,175);">Movie</span>&gt;

@{
    ViewBag.Title = <span style="color:rgb(163,21,21);">"Index"</span>;
}

<span style="color:#0000FF;">&lt;</span><span style="color:#800000;">h2</span><span style="color:#0000FF;">&gt;</span>Index<span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">h2</span><span style="color:#0000FF;">&gt;

&lt;</span><span style="color:#800000;">p</span><span style="color:#0000FF;">&gt;
    </span>@Html.ActionLink(<span style="color:rgb(163,21,21);">"Create New"</span>, <span style="color:rgb(163,21,21);">"Create"</span>)
<span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">p</span><span style="color:#0000FF;">&gt;
</span>@<span style="color:#0000FF;">using </span>(Html.BeginForm(<span style="color:rgb(163,21,21);">"Index"</span>, <span style="color:rgb(163,21,21);">"Movies"</span>, <span style="color:rgb(43,145,175);">FormMethod</span>.Get))
{
    <span style="color:#0000FF;">&lt;</span><span style="color:#800000;">p</span><span style="color:#0000FF;">&gt;
        </span>Genre: @Html.DropDownList(<span style="color:rgb(163,21,21);">"movieGenre"</span>, <span style="color:rgb(163,21,21);">"All"</span>)
        Title: @Html.TextBox(<span style="color:rgb(163,21,21);">"SearchString"</span>) <span style="color:#0000FF;">&lt;</span><span style="color:#800000;">br </span><span style="color:#0000FF;">/&gt;
        &lt;</span><span style="color:#800000;">input </span><span style="color:#FF0000;">type</span><span style="color:#0000FF;">="submit" </span><span style="color:#FF0000;">value</span><span style="color:#0000FF;">="Filter" /&gt;
    &lt;/</span><span style="color:#800000;">p</span><span style="color:#0000FF;">&gt;
</span>}

<span style="color:#0000FF;">&lt;</span><span style="color:#800000;">table </span><span style="color:#FF0000;">class</span><span style="color:#0000FF;">="table"&gt;
    &lt;</span><span style="color:#800000;">tr</span><span style="color:#0000FF;">&gt;
        &lt;</span><span style="color:#800000;">th</span><span style="color:#0000FF;">&gt;
            </span>@Html.DisplayNameFor(model =&gt; model.Title)
        <span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">th</span><span style="color:#0000FF;">&gt;
        &lt;</span><span style="color:#800000;">th</span><span style="color:#0000FF;">&gt;
            </span>@Html.DisplayNameFor(model =&gt; model.ReleaseDate)
        <span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">th</span><span style="color:#0000FF;">&gt;
        &lt;</span><span style="color:#800000;">th</span><span style="color:#0000FF;">&gt;
            </span>@Html.DisplayNameFor(model =&gt; model.Genre)
        <span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">th</span><span style="color:#0000FF;">&gt;
        &lt;</span><span style="color:#800000;">th</span><span style="color:#0000FF;">&gt;
            </span>@Html.DisplayNameFor(model =&gt; model.Price)
        <span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">th</span><span style="color:#0000FF;">&gt;
<span> &lt;</span></span><span style="color:#800000;"><span>th</span></span></pre> 
     <p><span><span style="color:#0000FF;">&gt; </span>@</span><span>Html.DisplayNameFor(model =&gt; model.Rating) <span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">th</span></span></p> 
     <pre class="code"><span style="color:#0000FF;"><span>&gt;</span>
        &lt;</span><span style="color:#800000;">th</span><span style="color:#0000FF;">&gt;&lt;/</span><span style="color:#800000;">th</span><span style="color:#0000FF;">&gt;
    &lt;/</span><span style="color:#800000;">tr</span><span style="color:#0000FF;">&gt;

    </span>@<span style="color:#0000FF;">foreach </span>(<span style="color:#0000FF;">var </span>item <span style="color:#0000FF;">in </span>Model)
    {
        <span style="color:#0000FF;">&lt;</span><span style="color:#800000;">tr</span><span style="color:#0000FF;">&gt;
            &lt;</span><span style="color:#800000;">td</span><span style="color:#0000FF;">&gt;
                </span>@Html.DisplayFor(modelItem =&gt; item.Title)
            <span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">td</span><span style="color:#0000FF;">&gt;
            &lt;</span><span style="color:#800000;">td</span><span style="color:#0000FF;">&gt;
                </span>@Html.DisplayFor(modelItem =&gt; item.ReleaseDate)
            <span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">td</span><span style="color:#0000FF;">&gt;
            &lt;</span><span style="color:#800000;">td</span><span style="color:#0000FF;">&gt;
                </span>@Html.DisplayFor(modelItem =&gt; item.Genre)
            <span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">td</span><span style="color:#0000FF;">&gt;
            &lt;</span><span style="color:#800000;">td</span><span style="color:#0000FF;">&gt;
                </span>@Html.DisplayFor(modelItem =&gt; item.Price)
            <span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">td</span><span style="color:#0000FF;">&gt;
<span> &lt;</span></span><span style="color:#800000;"><span>td</span></span></pre> 
     <p><span><span style="color:#0000FF;">&gt; </span>@</span><span>Html.DisplayFor(modelItem =&gt; item.Rating) <span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">td</span></span></p> 
     <pre class="code"><span style="color:#0000FF;"><span>&gt;</span>
            &lt;</span><span style="color:#800000;">td</span><span style="color:#0000FF;">&gt;
                </span>@Html.ActionLink(<span style="color:rgb(163,21,21);">"Edit"</span>, <span style="color:rgb(163,21,21);">"Edit"</span>, <span style="color:#0000FF;">new </span>{ id = item.ID }) |
                @Html.ActionLink(<span style="color:rgb(163,21,21);">"Details"</span>, <span style="color:rgb(163,21,21);">"Details"</span>, <span style="color:#0000FF;">new </span>{ id = item.ID }) |
                @Html.ActionLink(<span style="color:rgb(163,21,21);">"Delete"</span>, <span style="color:rgb(163,21,21);">"Delete"</span>, <span style="color:#0000FF;">new </span>{ id = item.ID })
            <span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">td</span><span style="color:#0000FF;">&gt;
        &lt;/</span><span style="color:#800000;">tr</span><span style="color:#0000FF;">&gt;
    </span>}

<span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">table</span><span style="color:#0000FF;">&gt;</span></pre> 
     <p><strong>代码清单3：修改后的Create.cshtml</strong></p> 
     <pre class="code">@model MvcMovie.Models.<span style="color:rgb(43,145,175);">Movie

</span>@{
    ViewBag.Title = <span style="color:rgb(163,21,21);">"Create"</span>;
}

<span style="color:#0000FF;">&lt;</span><span style="color:#800000;">h2</span><span style="color:#0000FF;">&gt;</span>Create<span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">h2</span><span style="color:#0000FF;">&gt;

</span>@<span style="color:#0000FF;">using </span>(Html.BeginForm())
{
    @Html.AntiForgeryToken()
    @Html.ValidationSummary(<span style="color:#0000FF;">true</span>)

    <span style="color:#0000FF;">&lt;</span><span style="color:#800000;">fieldset </span><span style="color:#FF0000;">class</span><span style="color:#0000FF;">="form-horizontal"&gt;
        &lt;</span><span style="color:#800000;">legend</span><span style="color:#0000FF;">&gt;</span>Movie<span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">legend</span><span style="color:#0000FF;">&gt;

        &lt;</span><span style="color:#800000;">div </span><span style="color:#FF0000;">class</span><span style="color:#0000FF;">="control-group"&gt;
            </span>@Html.LabelFor(model =&gt; model.Title, <span style="color:#0000FF;">new </span>{ @class = <span style="color:rgb(163,21,21);">"control-label" </span>})
            <span style="color:#0000FF;">&lt;</span><span style="color:#800000;">div </span><span style="color:#FF0000;">class</span><span style="color:#0000FF;">="controls"&gt;
                </span>@Html.EditorFor(model =&gt; model.Title)
                @Html.ValidationMessageFor(model =&gt; model.Title, <span style="color:#0000FF;">null</span>, <span style="color:#0000FF;">new </span>{ @class = <span style="color:rgb(163,21,21);">"help-inline" </span>})
            <span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">div</span><span style="color:#0000FF;">&gt;
        &lt;/</span><span style="color:#800000;">div</span><span style="color:#0000FF;">&gt;

        &lt;</span><span style="color:#800000;">div </span><span style="color:#FF0000;">class</span><span style="color:#0000FF;">="control-group"&gt;
            </span>@Html.LabelFor(model =&gt; model.ReleaseDate, <span style="color:#0000FF;">new </span>{ @class = <span style="color:rgb(163,21,21);">"control-label" </span>})
            <span style="color:#0000FF;">&lt;</span><span style="color:#800000;">div </span><span style="color:#FF0000;">class</span><span style="color:#0000FF;">="controls"&gt;
                </span>@Html.EditorFor(model =&gt; model.ReleaseDate)
                @Html.ValidationMessageFor(model =&gt; model.ReleaseDate, <span style="color:#0000FF;">null</span>, <span style="color:#0000FF;">new </span>{ @class = <span style="color:rgb(163,21,21);">"help-inline" </span>})
            <span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">div</span><span style="color:#0000FF;">&gt;
        &lt;/</span><span style="color:#800000;">div</span><span style="color:#0000FF;">&gt;

        &lt;</span><span style="color:#800000;">div </span><span style="color:#FF0000;">class</span><span style="color:#0000FF;">="control-group"&gt;
            </span>@Html.LabelFor(model =&gt; model.Genre, <span style="color:#0000FF;">new </span>{ @class = <span style="color:rgb(163,21,21);">"control-label" </span>})
            <span style="color:#0000FF;">&lt;</span><span style="color:#800000;">div </span><span style="color:#FF0000;">class</span><span style="color:#0000FF;">="controls"&gt;
                </span>@Html.EditorFor(model =&gt; model.Genre)
                @Html.ValidationMessageFor(model =&gt; model.Genre, <span style="color:#0000FF;">null</span>, <span style="color:#0000FF;">new </span>{ @class = <span style="color:rgb(163,21,21);">"help-inline" </span>})
            <span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">div</span><span style="color:#0000FF;">&gt;
        &lt;/</span><span style="color:#800000;">div</span><span style="color:#0000FF;">&gt;

        &lt;</span><span style="color:#800000;">div </span><span style="color:#FF0000;">class</span><span style="color:#0000FF;">="control-group"&gt;
            </span>@Html.LabelFor(model =&gt; model.Price, <span style="color:#0000FF;">new </span>{ @class = <span style="color:rgb(163,21,21);">"control-label" </span>})
            <span style="color:#0000FF;">&lt;</span><span style="color:#800000;">div </span><span style="color:#FF0000;">class</span><span style="color:#0000FF;">="controls"&gt;
                </span>@Html.EditorFor(model =&gt; model.Price)
                @Html.ValidationMessageFor(model =&gt; model.Price, <span style="color:#0000FF;">null</span>, <span style="color:#0000FF;">new </span>{ @class = <span style="color:rgb(163,21,21);">"help-inline" </span>})
            <span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">div</span><span style="color:#0000FF;">&gt;
        &lt;/</span><span style="color:#800000;">div</span><span style="color:#0000FF;">&gt;

<span> &lt;</span></span></pre> 
     <p><span><span style="color:#800000;">div </span><span style="color:#FF0000;">class</span></span><span><span style="color:#0000FF;">="control-group"&gt; </span>@Html.LabelFor(model =&gt; model.Rating, <span style="color:#0000FF;">new </span>{ @class = <span style="color:rgb(163,21,21);">"control-label" </span></span><span>}) <span style="color:#0000FF;">&lt;</span><span style="color:#800000;">div </span><span style="color:#FF0000;">class</span></span><span><span style="color:#0000FF;">="controls"&gt; </span>@</span><span>Html.EditorFor(model =&gt; model.Rating) @Html.ValidationMessageFor(model =&gt; model.Rating, <span style="color:#0000FF;">null</span>, <span style="color:#0000FF;">new </span>{ @class = <span style="color:rgb(163,21,21);">"help-inline" </span></span><span>}) <span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">div</span></span><span><span style="color:#0000FF;">&gt; &lt;/</span><span style="color:#800000;">div</span></span></p> 
     <pre class="code"><span style="color:#0000FF;"><span>&gt;</span>

        &lt;</span><span style="color:#800000;">div </span><span style="color:#FF0000;">class</span><span style="color:#0000FF;">="form-actions no-color"&gt;
            &lt;</span><span style="color:#800000;">input </span><span style="color:#FF0000;">type</span><span style="color:#0000FF;">="submit" </span><span style="color:#FF0000;">value</span><span style="color:#0000FF;">="Create" </span><span style="color:#FF0000;">class</span><span style="color:#0000FF;">="btn" /&gt;
        &lt;/</span><span style="color:#800000;">div</span><span style="color:#0000FF;">&gt;
    &lt;/</span><span style="color:#800000;">fieldset</span><span style="color:#0000FF;">&gt;
</span>}

<span style="color:#0000FF;">&lt;</span><span style="color:#800000;">div</span><span style="color:#0000FF;">&gt;
    </span>@Html.ActionLink(<span style="color:rgb(163,21,21);">"Back to List"</span>, <span style="color:rgb(163,21,21);">"Index"</span>)
<span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">div</span><span style="color:#0000FF;">&gt;

</span>@section Scripts {
@<span style="color:rgb(43,145,175);">Scripts</span>.Render(<span style="color:rgb(163,21,21);">"~/bundles/jqueryval"</span>)
}</pre> 
     <p>现在我们已经在程序中为Rating字段做成了修改。再次运行程序，浏览/movies 地址，这时我们会得到一个错误：</p> 
     <p><strong>图7：错误页面</strong></p> 
     <p><a href="https://images0.cnblogs.com/blog/44814/201307/24112027-53acd2934d2a46d6a3b486380247eb2a.png" rel="nofollow"><img style="border-width:0px;background-image:none;" title="image" alt="image" src="https://images0.cnblogs.com/blog/44814/201307/24112027-ade9b3918ad04c7aa68f68da4cd48658.png" width="533" height="480"></a></p> 
     <p>出现这个错误的原因是Movie模型类发生了变化，而与它对应的数据表 Movie 中并不存在Rating字段。</p> 
     <p>There are a few approaches to resolving the error:</p> 
     <p>解决这个问题有以下几种途径：</p> 
     <ol>
      <li>让Entity Framework自动删除并根据新的模型自动创建数据库。这种方式在早起开发过程中的测试数据库中非常方便，它可以快速的修改模型和数据库结构。另一方面，这样做将会使你丢失已有的数据，因此这种方式不能用在生产环境的数据库中。</li> 
      <li>在数据库中加上Rating字段，使数据库和Model类的结构相同。这种方式的优点是能够保留数据，你可以手动修改或使用数据库脚本修改。</li> 
      <li>使用Code First 迁移来升级数据库结构。</li> 
     </ol>
     <p>在本教程中，我们使用Code First 迁移。</p> 
     <p>更新Seed 方法，使它为Rating字段提供一个值。打开 Migrations\Configuration.cs 文件，为每一个Movie对象的Rating字段赋值。</p> 
     <p><strong>代码清单4：修改后的Seek方法</strong></p> 
     <pre class="code"><span style="color:#0000FF;">protected override void </span>Seed(MvcMovie.Models.<span style="color:rgb(43,145,175);">MovieDBContext </span>context)
{
    context.Movies.AddOrUpdate(i =&gt; i.Title,
        <span style="color:#0000FF;">new </span><span style="color:rgb(43,145,175);">Movie
        </span>{
            Title = <span style="color:rgb(163,21,21);">"龙门飞甲"</span>,
            ReleaseDate = <span style="color:rgb(43,145,175);">DateTime</span>.Parse(<span style="color:rgb(163,21,21);">"2012-1-11"</span>),
            Genre = <span style="color:rgb(163,21,21);">"动作"</span>,
            Price = 30M,
            Rating = <span style="color:rgb(163,21,21);">"优"
        </span>},
        <span style="color:#0000FF;">new </span><span style="color:rgb(43,145,175);">Movie
        </span>{
            Title = <span style="color:rgb(163,21,21);">"冰河世纪"</span>,
            ReleaseDate = <span style="color:rgb(43,145,175);">DateTime</span>.Parse(<span style="color:rgb(163,21,21);">"2011-3-1"</span>),
            Genre = <span style="color:rgb(163,21,21);">"动漫"</span>,
            Price = 65M,
            Rating = <span style="color:rgb(163,21,21);">"良"
        </span>},
        <span style="color:#0000FF;">new </span><span style="color:rgb(43,145,175);">Movie
        </span>{
            Title = <span style="color:rgb(163,21,21);">"中国合伙人"</span>,
            ReleaseDate = <span style="color:rgb(43,145,175);">DateTime</span>.Parse(<span style="color:rgb(163,21,21);">"2013-6-18"</span>),
            Genre = <span style="color:rgb(163,21,21);">"励志"</span>,
            Price = 70M,
            Rating = <span style="color:rgb(163,21,21);">"良"
        </span>}
   );
}</pre> 
     <p>重新编译解决方案，然后打开“程序包管理器控制台”，执行命令：add-migration Rating</p> 
     <p>add-migration 命令告诉迁移程序去检查当前的Movie模型与当前数据库之间的差异，创建迁移数据库到最新模型的代码。名称 Rating 是可以随便命名的，此处用来命名迁移文件。</p> 
     <p>当命令执行完成之后，Visual Studio 会打开刚刚添加的继承自 DbMigration 的类文件，文件中有两个方法 Up和Down，分别用来升级和降级数据库。在Up方法中我们可以看到为数据库添加列的代码，而Down方法中的代码则是删除Rating列。</p> 
     <p><strong>代码清单5：Rating类</strong></p> 
     <pre class="code"><span style="color:#0000FF;">public partial class </span><span style="color:rgb(43,145,175);">Rating </span>: <span style="color:rgb(43,145,175);">DbMigration
</span>{
    <span style="color:#0000FF;">public override void </span>Up()
    {
        AddColumn(<span style="color:rgb(163,21,21);">"dbo.Movies"</span>, <span style="color:rgb(163,21,21);">"Rating"</span>, c =&gt; c.String());
    }
    
    <span style="color:#0000FF;">public override void </span>Down()
    {
        DropColumn(<span style="color:rgb(163,21,21);">"dbo.Movies"</span>, <span style="color:rgb(163,21,21);">"Rating"</span>);
    }
}</pre> 
     <p>编译解决方案，然后执行命令 <code>update-database</code> 。“程序包管理器控制台”窗口的输出如下图（Rating前的时间戳可能不尽相同）：</p> 
     <p><strong>图8：更新数据库</strong></p> 
     <p><a href="https://images0.cnblogs.com/blog/44814/201307/24112028-9972bf2570b74789ac899774a18dcf6e.png" rel="nofollow"><img style="border-width:0px;background-image:none;" title="image" alt="image" src="https://images0.cnblogs.com/blog/44814/201307/24112028-8072269f6ba0478d9dceff711a7bc96b.png" width="640" height="134"></a></p> 
     <p>刷新我们出错的页面，你能看到已经加入了Rating字段：</p> 
     <p><strong>图9：加入了Rating字段的界面</strong></p> 
     <p><a href="https://images0.cnblogs.com/blog/44814/201307/24112029-9c68ad7d2aa4424db7038cf19c115845.png" rel="nofollow"><img style="border-width:0px;background-image:none;" title="image" alt="image" src="https://images0.cnblogs.com/blog/44814/201307/24112029-7421ffd5a1b3478d9a44e165179c193d.png" width="533" height="480"></a></p> 
     <p>点击“Create New”链接试着添加一个电影信息，不要忘记为Rating字段赋值。</p> 
     <p><strong>图10：新增页面</strong></p> 
     <p><a href="https://images0.cnblogs.com/blog/44814/201307/24112030-0ffc7be590314ebfad07284eb1dbed42.png" rel="nofollow"><img style="border-width:0px;background-image:none;" title="image" alt="image" src="https://images0.cnblogs.com/blog/44814/201307/24112030-70a3a96facfd4503b8fcc078bbb1aabc.png" width="541" height="480"></a></p> 
     <p>输入完成之后点击“Create”按钮，保存电影信息。</p> 
     <p><strong>图11：保存后的列表</strong></p> 
     <p><a href="https://images0.cnblogs.com/blog/44814/201307/24112031-2b217fded9834169a5933969ec1a07ee.png" rel="nofollow"><img style="border-width:0px;background-image:none;" title="image" alt="image" src="https://images0.cnblogs.com/blog/44814/201307/24112031-6dedd99aa3db4acd91ed6d80938b4b85.png" width="541" height="480"></a></p> 
     <p> </p> 
     <p>你还需要在Edit、Details和Delete视图中添加Rating字段。</p> 
     <p>如果你再次执行 "update-database" 命令，将不会做出任何修改，因为数据库结构和模型的结构已经相同了。</p> 
     <p>现在，通过项目中使用数据迁移，我们在添加字段或更新模型结构的时候不用再删除数据库了。在下一节中，我们将对结构做出更多的更改，并使用数据迁移来更新数据库。</p> 
     <p>本文同时发布在<a href="http://www.qeefee.com/" rel="nofollow">起飞网</a>，原文地址：<a title="http://www.qeefee.com/mvc/mvc-5-adding-a-new-field" href="http://www.qeefee.com/mvc/mvc-5-adding-a-new-field" rel="nofollow">http://www.qeefee.com/mvc/mvc-5-adding-a-new-field</a></p> 
     <p><font color="#0000ee"><u><br></u></font></p> 
     <p><font color="#0000ee"><u><br></u></font></p> 
     <p><font color="#0000ee"><u><br></u></font></p> 
     <p><font color="#0000ee"><u>本文转自齐师傅博客园博客，原文链接：http://www.cnblogs.com/youring2/p/mvc-5-adding-a-new-field.html，如需转载请自行联系原作者</u></font></p> 
    </div> 
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
