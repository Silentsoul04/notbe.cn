<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>C#中使用DirectSound录音 « NotBeCN</title>
  <meta name="description" content="                            一．声卡录音的基本原理       为了实现一个录音的基本过程，至少需要以下对象的支持：       1． 录音设备，对我们的PC设备就是声卡。这个录音设备可以进行的操作应该有开始和关闭。       2． 缓冲区，也就是录制的声音放在哪里的问题。     ...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/26/weixin_34007020_90122459.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">C#中使用DirectSound录音</h1>
    <p class="post-meta">Nov 26, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <h1></h1> 
   <div class="postBody"> 
    <div class="blogpost-body"> 
     <p style="background:#FFFFFF;text-indent:-18pt;" align="left"><span style="font-family:'宋体';font-size:12pt;">一．</span><span style="font-family:'宋体';font-size:12pt;">声卡录音的基本原理</span><span style="font-family:'宋体';font-size:12pt;"> </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'宋体';font-size:12pt;">为了实现一个录音的基本过程，至少需要以下对象的支持：</span> </p> 
     <p style="background:#FFFFFF;text-indent:-18pt;" align="left"><span style="font-size:12pt;">1</span><span style="font-family:'宋体';font-size:12pt;">．</span><span style="font-size:7pt;"> </span><span style="font-family:'宋体';font-size:12pt;">录音设备，对我们的</span><span style="font-size:12pt;">PC</span><span style="font-family:'宋体';font-size:12pt;">设备就是声卡。这个录音设备可以进行的操作应该有开始和关闭。</span> </p> 
     <p style="background:#FFFFFF;text-indent:-18pt;" align="left"><span style="font-size:12pt;">2</span><span style="font-family:'宋体';font-size:12pt;">．</span><span style="font-size:7pt;"> </span><span style="font-family:'宋体';font-size:12pt;">缓冲区，也就是录制的声音放在哪里的问题。</span> </p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;text-indent:-18pt;" align="left"><span style="font-family:'宋体';font-size:12pt;">二．</span><span style="font-size:12pt;">DirectSound</span><span style="font-family:'宋体';font-size:12pt;">对录音的描述模型</span> </p> 
     <p style="background:#FFFFFF;text-indent:-18pt;" align="left"><span style="font-size:12pt;">1</span><span style="font-family:'宋体';font-size:12pt;">．</span><span style="font-size:7pt;"> </span><span style="font-size:12pt;">DirectSound</span><span style="font-family:'宋体';font-size:12pt;">对录音的支持类</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:Wingdings;font-size:12pt;">Ø</span><span style="font-size:7pt;"> </span><span style="font-size:12pt;">Capture</span><span style="font-family:'宋体';font-size:12pt;">，设备对象，可以看作是声卡的描述。</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:Wingdings;font-size:12pt;">Ø</span><span style="font-size:7pt;"> </span><span style="font-family:'新宋体';font-size:12pt;">CaptureBuffer</span><span style="font-family:'新宋体';font-size:12pt;">，</span><span style="font-family:'宋体';font-size:12pt;">缓冲区对象，存放录入的音频数据。</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:Wingdings;font-size:12pt;">Ø</span><span style="font-size:7pt;"> </span><span style="font-family:'新宋体';font-size:12pt;">Notify</span><span style="font-family:'新宋体';font-size:12pt;">，</span><span style="font-family:'宋体';font-size:12pt;">事件通知对象，由于录音是一个长时间的过程，因此使用一个缓冲队列（多个缓冲区）接收数据，每当一个缓冲区满的时候，系统使用这个对象通知应用程序取走这个缓冲区，并继续录音。</span></p> 
     <p style="background:#FFFFFF;text-indent:18pt;" align="left"><span style="font-family:'宋体';font-size:12pt;">以上三个对象是进行录音操作的主要对象，由于在</span><span style="font-size:12pt;">C++</span><span style="font-family:'宋体';font-size:12pt;">中对</span><span style="font-size:12pt;">DirectSound</span><span style="font-family:'宋体';font-size:12pt;">的操作</span><span style="font-size:12pt;">DirectX</span><span style="font-family:'宋体';font-size:12pt;">帮助文档中已经有很详细的说明</span><span style="font-family:'宋体';font-size:12pt;">，</span><span style="font-family:'宋体';font-size:12pt;">这里就不再赘述了。本文是针对</span><span style="font-size:12pt;">Managed Code</span><span style="font-family:'宋体';font-size:12pt;">。除了以上三个主要的</span><span style="font-size:12pt;">DirectSound</span><span style="font-family:'宋体';font-size:12pt;">类，还需要以下几个辅助类。</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:Wingdings;font-size:12pt;">Ø</span><span style="font-size:7pt;"> </span><span style="font-family:'新宋体';font-size:12pt;">WaveFormat</span><span style="font-family:'新宋体';font-size:12pt;">，描述了进行录制的声音波形的格式，例如采样率，单声道还是立体声，每个采样点的长度等等。 </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:Wingdings;font-size:12pt;">Ø</span><span style="font-size:7pt;"> </span><span style="font-family:'新宋体';font-size:12pt;">Thread</span><span style="font-family:'新宋体';font-size:12pt;">，线程类，由于录音的过程是需要不断处理缓冲区满的事件，因此新建一个线程对此进行单独处理。</span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:Wingdings;font-size:12pt;">Ø</span><span style="font-size:7pt;"> </span><span style="font-family:'新宋体';font-size:12pt;">AutoResetEvent</span><span style="font-family:'新宋体';font-size:12pt;">，通知的事件，当缓冲区满的时候，使用该事件作为通知事件。</span> </p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;text-indent:-18pt;" align="left"><span style="font-family:'宋体';font-size:12pt;">三．</span><span style="font-family:'宋体';font-size:12pt;">代码解析（</span><span style="font-size:12pt;">SoundRecord</span><span style="font-family:'宋体';font-size:12pt;">类）</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-size:12pt;">1</span><span style="font-family:'宋体';font-size:12pt;">．需要引用的程序集</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">using</span><span style="font-family:'Courier New';font-size:12pt;"> System; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">using</span><span style="font-family:'Courier New';font-size:12pt;"> System.Windows.Forms; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">using</span><span style="font-family:'Courier New';font-size:12pt;"> System.Threading; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">using</span><span style="font-family:'Courier New';font-size:12pt;"> System.IO; </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;">// </span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">对</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">DirectSound</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">的支持</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">using</span><span style="font-family:'Courier New';font-size:12pt;"> Microsoft.DirectX; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">using</span><span style="font-family:'Courier New';font-size:12pt;"> Microsoft.DirectX.DirectSound;</span> </p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;text-indent:-18pt;" align="left"><span style="font-size:12pt;">2</span><span style="font-family:'宋体';font-size:12pt;">．</span><span style="font-size:7pt;"> </span><span style="font-size:12pt;">SoundRecord</span><span style="font-family:'宋体';font-size:12pt;">的成员数据</span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">public</span><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">const</span> <span style="color:#0000FF;">int</span> cNotifyNum = 16; <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">缓冲队列的数目</span> </p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">private</span><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">int</span> mNextCaptureOffset = 0; <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">该次录音缓冲区的起始点</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">private</span><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">int</span> mSampleCount = 0; <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">录制的样本数目</span> </p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">private</span><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">int</span> mNotifySize = 0; <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">每次通知大小</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">private</span><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">int</span> mBufferSize = 0; <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">缓冲队列大小</span> </p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">private</span><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">string</span> mFileName = <span style="color:#0000FF;">string</span>.Empty; <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">文件名</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">private</span><span style="font-family:'Courier New';font-size:12pt;"> FileStream mWaveFile = <span style="color:#0000FF;">null</span>; <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">文件流</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">private</span><span style="font-family:'Courier New';font-size:12pt;"> BinaryWriter mWriter = <span style="color:#0000FF;">null</span>; <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">写文件</span> </p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">private</span><span style="font-family:'Courier New';font-size:12pt;"> Capture mCapDev = <span style="color:#0000FF;">null</span>; <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">音频捕捉设备</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">private</span><span style="font-family:'Courier New';font-size:12pt;"> CaptureBuffer mRecBuffer = <span style="color:#0000FF;">null</span>; <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">缓冲区对象</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">private</span><span style="font-family:'Courier New';font-size:12pt;"> Notify mNotify = <span style="color:#0000FF;">null</span>; <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">消息通知对象</span> </p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">private</span><span style="font-family:'Courier New';font-size:12pt;"> WaveFormat mWavFormat; <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">录音的格式</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">private</span><span style="font-family:'Courier New';font-size:12pt;"> Thread mNotifyThread = <span style="color:#0000FF;">null</span>; <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">处理缓冲区消息的线程</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">private</span><span style="font-family:'Courier New';font-size:12pt;"> AutoResetEvent mNotificationEvent = <span style="color:#0000FF;">null</span>; <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">通知事件</span> </p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;text-indent:-18pt;" align="left"><span style="font-size:12pt;">3</span><span style="font-family:'宋体';font-size:12pt;">．</span><span style="font-size:7pt;"> </span><span style="font-family:'宋体';font-size:12pt;">对外操作的函数</span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;summary&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#008000;font-family:'新宋体';font-size:12pt;">构造函数</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">,</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">设定录音设备</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">,</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">设定录音格式</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">. </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;/summary&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">public</span><span style="font-family:'Courier New';font-size:12pt;"> SoundRecord() </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">{ </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">初始化音频捕捉设备</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> InitCaptureDevice(); </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">设定录音格式</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mWavFormat = CreateWaveFormat(); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">} </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;summary&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#008000;font-family:'新宋体';font-size:12pt;">设定录音结束后保存的文件</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">,</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">包括路径</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;/summary&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;param name="filename"&gt;</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">保存</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">wav</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">文件的路径名</span><span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;/param&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">public</span><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">void</span> SetFileName(<span style="color:#0000FF;">string</span> filename) </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">{ </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mFileName = filename; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">} </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;summary&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#008000;font-family:'新宋体';font-size:12pt;">开始录音</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;/summary&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">public</span><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">void</span> RecStart() </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">{ </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">创建录音文件</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> CreateSoundFile(); </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">创建一个录音缓冲区，并开始录音</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> CreateCaptureBuffer(); </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">建立通知消息</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">,</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">当缓冲区满的时候处理方法</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> InitNotifications(); </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mRecBuffer.Start(<span style="color:#0000FF;">true</span>); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">} </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'新宋体';font-size:12pt;">///</span> <span style="color:#808080;font-family:'新宋体';font-size:12pt;">&lt;summary&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'新宋体';font-size:12pt;">///</span> <span style="color:#008000;font-family:'新宋体';font-size:12pt;">停止录音 </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'新宋体';font-size:12pt;">///</span> <span style="color:#808080;font-family:'新宋体';font-size:12pt;">&lt;/summary&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'新宋体';font-size:12pt;">public</span><span style="font-family:'新宋体';font-size:12pt;"> <span style="color:#0000FF;">void</span> RecStop() </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'新宋体';font-size:12pt;">{ </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'新宋体';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">关闭通知消息 </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'新宋体';font-size:12pt;"> <span style="color:#0000FF;">if</span> (<span style="color:#0000FF;">null</span> != mNotificationEvent) </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'新宋体';font-size:12pt;"> mNotificationEvent.Set(); </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'新宋体';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">停止录音 </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'新宋体';font-size:12pt;"> mRecBuffer.Stop(); </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'新宋体';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">写入缓冲区最后的数据 </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'新宋体';font-size:12pt;"> RecordCapturedData(); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'新宋体';font-size:12pt;"> </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'新宋体';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">回写长度信息 </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'新宋体';font-size:12pt;"> mWriter.Seek(4, SeekOrigin.Begin); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'新宋体';font-size:12pt;"> mWriter.Write((<span style="color:#0000FF;">int</span>)(mSampleCount + 36)); <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">写文件长度 </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'新宋体';font-size:12pt;"> mWriter.Seek(40, SeekOrigin.Begin); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'新宋体';font-size:12pt;"> mWriter.Write(mSampleCount); <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">写数据长度 </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'新宋体';font-size:12pt;"> </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'新宋体';font-size:12pt;"> mWriter.Close(); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'新宋体';font-size:12pt;"> mWaveFile.Close(); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'新宋体';font-size:12pt;"> mWriter = <span style="color:#0000FF;">null</span>; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'新宋体';font-size:12pt;"> mWaveFile = <span style="color:#0000FF;">null</span>; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'新宋体';font-size:12pt;">} </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-size:12pt;">4</span><span style="font-family:'宋体';font-size:12pt;">．内部调用函数</span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;summary&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#008000;font-family:'新宋体';font-size:12pt;">初始化录音设备</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">,</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">此处使用主录音设备</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">. </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;/summary&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;returns&gt;</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">调用成功返回</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">true,</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">否则返回</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">false</span><span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;/returns&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">private</span><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">bool</span> InitCaptureDevice() </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">{ </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">获取默认音频捕捉设备</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> CaptureDevicesCollection devices = <span style="color:#0000FF;">new</span> CaptureDevicesCollection(); <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">枚举音频捕捉设备</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> Guid deviceGuid = Guid.Empty; <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">音频捕捉设备的</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">ID </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">if</span> (devices.Count&gt;0) </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> deviceGuid = devices[0].DriverGuid; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">else </span></span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> { </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> MessageBox.Show("</span><span style="font-family:'新宋体';font-size:12pt;">系统中没有音频捕捉设备</span><span style="font-family:'Courier New';font-size:12pt;">"); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">return</span> <span style="color:#0000FF;">false</span>; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> } </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">用指定的捕捉设备创建</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">Capture</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">对象</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">try </span></span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> { </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mCapDev = <span style="color:#0000FF;">new</span> Capture(deviceGuid); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> } </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">catch</span> (DirectXException e) </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> { </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> MessageBox.Show(e.ToString()); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">return</span> <span style="color:#0000FF;">false</span>; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> } </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">return</span> <span style="color:#0000FF;">true</span>; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">} </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;summary&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#008000;font-family:'新宋体';font-size:12pt;">创建录音格式</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">,</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">此处使用</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">16bit,16KHz,Mono</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">的录音格式</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;/summary&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;returns&gt;</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">WaveFormat</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">结构体</span><span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;/returns&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">private</span><span style="font-family:'Courier New';font-size:12pt;"> WaveFormat CreateWaveFormat() </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">{ </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> WaveFormat format = <span style="color:#0000FF;">new</span> WaveFormat(); </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> format.FormatTag = WaveFormatTag.Pcm; <span style="color:#008000;">// PCM </span></span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> format.SamplesPerSecond = 16000; <span style="color:#008000;">// 16KHz </span></span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> format.BitsPerSample = 16; <span style="color:#008000;">// 16Bit </span></span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> format.Channels = 1; <span style="color:#008000;">// Mono </span></span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> format.BlockAlign = (<span style="color:#0000FF;">short</span>)(format.Channels * (format.BitsPerSample / 8)); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> format.AverageBytesPerSecond = format.BlockAlign * format.SamplesPerSecond; </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">return</span> format; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">} </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;summary&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#008000;font-family:'新宋体';font-size:12pt;">创建录音使用的缓冲区</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;/summary&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">private</span><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">void</span> CreateCaptureBuffer() </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">{ </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">缓冲区的描述对象</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> CaptureBufferDescription bufferdescription = <span style="color:#0000FF;">new</span> CaptureBufferDescription(); </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">if</span> (<span style="color:#0000FF;">null</span> != mNotify) </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> { </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mNotify.Dispose(); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mNotify = <span style="color:#0000FF;">null</span>; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> } </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">if</span> (<span style="color:#0000FF;">null</span> != mRecBuffer) </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> { </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mRecBuffer.Dispose(); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mRecBuffer = <span style="color:#0000FF;">null</span>; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> } </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">设定通知的大小</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">,</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">默认为</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">1s</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">钟</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mNotifySize = (1024 &gt; mWavFormat.AverageBytesPerSecond / 8) ? 1024 : (mWavFormat.AverageBytesPerSecond / 8); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mNotifySize -= mNotifySize % mWavFormat.BlockAlign; </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">设定缓冲区大小</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mBufferSize = mNotifySize * cNotifyNum; </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">创建缓冲区描述</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> bufferdescription.BufferBytes = mBufferSize; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> bufferdescription.Format = mWavFormat; <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">录音格式</span> </p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">创建缓冲区</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mRecBuffer = <span style="color:#0000FF;">new</span> CaptureBuffer(bufferdescription, mCapDev); </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mNextCaptureOffset = 0; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">} </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;summary&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#008000;font-family:'新宋体';font-size:12pt;">初始化通知事件</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">,</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">将原缓冲区分成</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">16</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">个缓冲队列</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">,</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">在每个缓冲队列的结束点设定通知点</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">. </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;/summary&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;returns&gt;</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">是否成功</span><span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;/returns&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">private</span><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">bool</span> InitNotifications() </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">{ </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">if</span> (<span style="color:#0000FF;">null</span> == mRecBuffer) </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> { </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> MessageBox.Show("</span><span style="font-family:'新宋体';font-size:12pt;">未创建录音缓冲区</span><span style="font-family:'Courier New';font-size:12pt;">"); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">return</span> <span style="color:#0000FF;">false</span>; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> } </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">创建一个通知事件</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">,</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">当缓冲队列满了就激发该事件</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">. </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mNotificationEvent = <span style="color:#0000FF;">new</span> AutoResetEvent(<span style="color:#0000FF;">false</span>); </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">创建一个线程管理缓冲区事件</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">if</span> (<span style="color:#0000FF;">null</span> == mNotifyThread) </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> { </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mNotifyThread = <span style="color:#0000FF;">new</span> Thread(<span style="color:#0000FF;">new</span> ThreadStart(WaitThread)); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mNotifyThread.Start(); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> } </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">设定通知的位置</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> BufferPositionNotify[] PositionNotify = <span style="color:#0000FF;">new</span> BufferPositionNotify[cNotifyNum + 1]; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">for</span> (<span style="color:#0000FF;">int</span> i = 0; i &lt; cNotifyNum; i++) </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> </span><span style="font-family:'Courier New';font-size:12pt;">{ </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> PositionNotify[i].Offset = (mNotifySize * i) + mNotifySize - 1; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> PositionNotify[i].EventNotifyHandle = mNotificationEvent.Handle; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> } </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mNotify = <span style="color:#0000FF;">new</span> Notify(mRecBuffer); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mNotify.SetNotificationPositions(PositionNotify, cNotifyNum); </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">return</span> <span style="color:#0000FF;">true</span>; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">} </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;summary&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#008000;font-family:'新宋体';font-size:12pt;">将录制的数据写入</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">wav</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">文件</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;/summary&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">private</span><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">void</span> RecordCapturedData() </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">{ </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">byte</span>[] CaptureData = <span style="color:#0000FF;">null</span>; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">int</span> ReadPos; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">int</span> CapturePos; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">int</span> LockSize; </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mRecBuffer.GetCurrentPosition(<span style="color:#0000FF;">out</span> CapturePos, <span style="color:#0000FF;">out</span> ReadPos); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> LockSize = ReadPos - mNextCaptureOffset; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">if</span> (LockSize &lt; 0) </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> LockSize += mBufferSize; </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">对齐缓冲区边界</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">,</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">实际上由于开始设定完整</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">,</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">这个操作是多余的</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">. </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> LockSize -= (LockSize % mNotifySize); </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">if</span> (0 == LockSize) </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">return</span>; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">读取缓冲区内的数据</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> CaptureData = (<span style="color:#0000FF;">byte</span>[])mRecBuffer.Read(mNextCaptureOffset, <span style="color:#0000FF;">typeof</span>(<span style="color:#0000FF;">byte</span>), LockFlag.None, LockSize); </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">写入</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">Wav</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">文件</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mWriter.Write(CaptureData, 0, CaptureData.Length); </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">更新已经录制的数据长度</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">. </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mSampleCount += CaptureData.Length; </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">移动录制数据的起始点</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">,</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">通知消息只负责指示产生消息的位置</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">,</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">并不记录上次录制的位置</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mNextCaptureOffset += CaptureData.Length; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mNextCaptureOffset %= mBufferSize; <span style="color:#008000;">// Circular buffer </span></span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">} </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;summary&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#008000;font-family:'新宋体';font-size:12pt;">接收缓冲区满消息的处理线程</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;/summary&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">private</span><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">void</span> WaitThread() </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">{ </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">while</span>(<span style="color:#0000FF;">true</span>) </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> { </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">等待缓冲区的通知消息</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mNotificationEvent.WaitOne(Timeout.Infinite, <span style="color:#0000FF;">true</span>); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">录制数据</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> RecordCapturedData(); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> } </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">}</span> </p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;summary&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#008000;font-family:'新宋体';font-size:12pt;">创建保存的波形文件</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">,</span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">并写入必要的文件头</span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">. </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#808080;font-family:'Courier New';font-size:12pt;">///</span> <span style="color:#808080;font-family:'Courier New';font-size:12pt;">&lt;/summary&gt; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">private</span><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">void</span> CreateSoundFile() </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">{ </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#808080;">/**</span><span style="color:#008000;">************************************************************************ </span></span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> Here is where the file will be created. A </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> wave file is a RIFF file, which has chunks </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> of data that describe what the file contains. </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> A wave RIFF file is put together like this: </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> The 12 byte RIFF chunk is constructed like this: </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> Bytes 0 - 3 : 'R' 'I' 'F' 'F' </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> Bytes 4 - 7 : Length of file, minus the first 8 bytes of the RIFF description. </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> (4 bytes for "WAVE" + 24 bytes for format chunk length + </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> 8 bytes for data chunk description + actual sample data size.) </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> Bytes 8 - 11: 'W' 'A' 'V' 'E' </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> The 24 byte FORMAT chunk is constructed like this: </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> </span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">Bytes 0 - 3 : 'f' 'm' 't' ' ' </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> </span><span style="color:#008000;font-family:'Courier New';font-size:12pt;">Bytes 4 - 7 : The format chunk length. This is always 16. </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> Bytes 8 - 9 : File padding. Always 1. </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> Bytes 10- 11: Number of channels. Either 1 for mono, or 2 for stereo. </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> Bytes 12- 15: Sample rate. </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> Bytes 16- 19: Number of bytes per second. </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> Bytes 20- 21: Bytes per sample. 1 for 8 bit mono, 2 for 8 bit stereo or </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> 16 bit mono, 4 for 16 bit stereo. </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> Bytes 22- 23: Number of bits per sample. </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> The DATA chunk is constructed like this: </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> Bytes 0 - 3 : 'd' 'a' 't' 'a' </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> Bytes 4 - 7 : Length of data, in bytes. </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#008000;font-family:'Courier New';font-size:12pt;"> Bytes 8 -...: Actual sample data. </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#808080;">*</span><span style="color:#008000;">*************************************************************************</span><span style="color:#808080;">*/ </span></span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// Open up the wave file for writing. </span></span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mWaveFile = <span style="color:#0000FF;">new</span> FileStream(mFileName, FileMode.Create); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mWriter = <span style="color:#0000FF;">new</span> BinaryWriter(mWaveFile); </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// Set up file with RIFF chunk info. </span></span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">char</span>[] ChunkRiff = {'R','I','F','F'}; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">char</span>[] ChunkType = {'W','A','V','E'}; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">char</span>[] ChunkFmt = {'f','m','t',' '}; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">char</span>[] ChunkData = {'d','a','t','a'}; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">short</span> shPad = 1; <span style="color:#008000;">// File padding </span></span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">int</span> nFormatChunkLength = 0x10; <span style="color:#008000;">// Format chunk length. </span></span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">int</span> nLength = 0; <span style="color:#008000;">// File length, minus first 8 bytes of RIFF description. This will be filled in later. </span></span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">short</span> shBytesPerSample = 0; <span style="color:#008000;">// Bytes per sample. </span></span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">一个样本点的字节数目</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">if</span> (8 == mWavFormat.BitsPerSample &amp;&amp; 1 == mWavFormat.Channels) </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> shBytesPerSample = 1; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">else</span> <span style="color:#0000FF;">if</span> ((8 == mWavFormat.BitsPerSample &amp;&amp; 2 == mWavFormat.Channels) || (16 == mWavFormat.BitsPerSample &amp;&amp; 1 == mWavFormat.Channels)) </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> shBytesPerSample = 2; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">else</span> <span style="color:#0000FF;">if</span> (16 == mWavFormat.BitsPerSample &amp;&amp; 2 == mWavFormat.Channels) </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> shBytesPerSample = 4; </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// RIFF </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">块</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mWriter.Write(ChunkRiff); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mWriter.Write(nLength); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mWriter.Write(ChunkType); </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// WAVE</span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">块</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mWriter.Write(ChunkFmt); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mWriter.Write(nFormatChunkLength); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mWriter.Write(shPad); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mWriter.Write(mWavFormat.Channels); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mWriter.Write(mWavFormat.SamplesPerSecond); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mWriter.Write(mWavFormat.AverageBytesPerSecond); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mWriter.Write(shBytesPerSample); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mWriter.Write(mWavFormat.BitsPerSample); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">数据块</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mWriter.Write(ChunkData); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> mWriter.Write((<span style="color:#0000FF;">int</span>)0); <span style="color:#008000;">// The sample length will be written in later. </span></span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">} </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-size:12pt;">5</span><span style="font-family:'宋体';font-size:12pt;">．外部窗体调用方式</span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'宋体';font-size:12pt;">声明部分：</span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">private</span><span style="font-family:'Courier New';font-size:12pt;"> SoundRecord recorder = <span style="color:#0000FF;">null</span>; <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">录音</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'宋体';font-size:12pt;">窗体构造函数：</span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">recorder = <span style="color:#0000FF;">new</span> SoundRecord();</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'宋体';font-size:12pt;">启动录音按钮：</span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">private</span><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">void</span> btnStart_Click(<span style="color:#0000FF;">object</span> sender, System.EventArgs e) </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">{ </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span><span style="color:#008000;font-family:'新宋体';font-size:12pt;">录音设置</span> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#008000;">// </span></span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">string</span> wavfile = <span style="color:#0000FF;">null</span>; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> wavfile = “test.wav”; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> recorder.SetFileName(wavfile); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> recorder.RecStart(); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">} </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'宋体';font-size:12pt;">中止录音按钮：</span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="color:#0000FF;font-family:'Courier New';font-size:12pt;">private</span><span style="font-family:'Courier New';font-size:12pt;"> <span style="color:#0000FF;">void</span> btnStop_Click(<span style="color:#0000FF;">object</span> sender, System.EventArgs e) </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">{ </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> recorder.RecStop(); </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;"> recorder = <span style="color:#0000FF;">null</span>; </span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'Courier New';font-size:12pt;">} </span></p> 
     <p style="background:#FFFFFF;" align="left"> </p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-size:12pt;">6</span><span style="font-family:'宋体';font-size:12pt;">．需要添加的外部引用文件</span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-family:'宋体';font-size:12pt;">在系统的</span><span style="font-size:12pt;">System32</span><span style="font-family:'宋体';font-size:12pt;">目录下添加以下两个引用文件，如果没有，在</span><span style="font-size:12pt;">DirectX</span><span style="font-family:'宋体';font-size:12pt;">的开发包内可以找到。</span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-size:12pt;">Microsoft.DirectX.dll</span></p> 
     <p style="background:#FFFFFF;" align="left"><span style="font-size:12pt;">Microsoft.DirectX.DirectSound.dll</span></p> 
     <p style="background:#FFFFFF;" align="left"><br></p> 
     <p style="background:#FFFFFF;" align="left"><br></p> 
     <p style="background:#FFFFFF;" align="left"><br></p> 
     <p style="background:#FFFFFF;" align="left">本文转自94cool博客园博客，原文链接：http://www.cnblogs.com/94cool/articles/1524818.html，如需转载请自行联系原作者</p> 
    </div> 
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
