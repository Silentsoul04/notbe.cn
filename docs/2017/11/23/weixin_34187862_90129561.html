<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Webwork 学习之路【07】文件上传下载 « NotBeCN</title>
  <meta name="description" content="             &nbsp; Web上传和下载应该是很普遍的一个需求，无论是小型网站还是大并发访问的交易网站。WebWork&nbsp;当然也提供了很友好的拦截器来实现对文件的上传，让我们可以专注与业务逻辑的设计和实现，在实现上传和下载时顺便关注了下框架上传下载的实现，在本篇博文中总结记录如下。&nbs...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/23/weixin_34187862_90129561.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">Webwork 学习之路【07】文件上传下载</h1>
    <p class="post-meta">Nov 23, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-size:15px;">&nbsp; Web上传和下载应该是很普遍的一个需求，无论是小型网站还是大并发访问的交易网站。</span><span style="line-height:1.8;font-size:15px;"><strong>WebWork</strong>&nbsp;当然也提供了很友好的拦截器来实现对文件的上传，让我们可以专注与业务逻辑的设计和实现，在实现上传和下载时顺便关注了下框架上传下载的实现，在本篇博文中总结记录如下。&nbsp;</span></p> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/362169/201602/362169-20160201191908210-1123653363.png" alt="" style="border:0px;"></span></p> 
   <div style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;text-align:right;"> 
    <a href="http://www.cnblogs.com/java-class/p/5175619.html#_labelTop" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">回到顶部</a>
    <a name="_label0" style="color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);"></a> 
   </div> 
   <h3 style="font-size:16px;line-height:1.5;font-family:verdana, Arial, Helvetica, sans-serif;"><span style="line-height:1.8;font-size:15px;">1. 包装 Request 请求</span></h3> 
   <ul style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style:disc;"><span style="line-height:1.8;font-size:15px;">每次客户端请求&nbsp;<strong>Action</strong>&nbsp;时，都会调用&nbsp;<strong>WebWork</strong>&nbsp;调度类&nbsp;<strong>ServletDispatcher.service()</strong>方法。</span></li>
   </ul>
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-size:15px;">&nbsp; &nbsp; &nbsp; &nbsp;具体过程请参照：&nbsp;<a href="http://www.cnblogs.com/java-class/p/5155793.html" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">http://www.cnblogs.com/java-class/p/5155793.html</a></span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="line-height:1.8;color:rgb(0,0,255);">public</span> <span style="line-height:1.8;color:rgb(0,0,255);">void</span> service(HttpServletRequest request, HttpServletResponse response) <span style="line-height:1.8;color:rgb(0,0,255);">throws</span><span style="line-height:1.8;"> ServletException {
        </span><span style="line-height:1.8;color:rgb(0,0,255);">try</span><span style="line-height:1.8;"> {
            </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (encoding != <span style="line-height:1.8;color:rgb(0,0,255);">null</span><span style="line-height:1.8;">) {
                </span><span style="line-height:1.8;color:rgb(0,0,255);">try</span><span style="line-height:1.8;"> {
                    request.setCharacterEncoding(encoding);
                } </span><span style="line-height:1.8;color:rgb(0,0,255);">catch</span><span style="line-height:1.8;"> (Exception localException) {
                }
            }
            </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (locale != <span style="line-height:1.8;color:rgb(0,0,255);">null</span><span style="line-height:1.8;">) {
                response.setLocale(locale);
            }
            </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (<span style="line-height:1.8;color:rgb(0,0,255);">this</span><span style="line-height:1.8;">.paramsWorkaroundEnabled) {
                request.getParameter(</span>"foo"<span style="line-height:1.8;">);
            }
            request </span>= wrapRequest(request); <span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">封装 request请求</span>
<span style="line-height:1.8;">            serviceAction(request, response, getNameSpace(request), getActionName(request), getRequestMap(request), getParameterMap(request), getSessionMap(request), getApplicationMap());
        } </span><span style="line-height:1.8;color:rgb(0,0,255);">catch</span><span style="line-height:1.8;"> (IOException e) {
            String message </span>= "Could not wrap servlet request with MultipartRequestWrapper!"<span style="line-height:1.8;">;
            log.error(message, e);
            sendError(request, response, </span>500, <span style="line-height:1.8;color:rgb(0,0,255);">new</span><span style="line-height:1.8;"> ServletException(message, e));
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-size:15px;">&nbsp; &nbsp; &nbsp; 先来看看&nbsp;<strong>wrapRequest&nbsp;</strong>方法做了什么：</span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="line-height:1.8;color:rgb(0,0,255);">protected</span> HttpServletRequest wrapRequest(HttpServletRequest request) <span style="line-height:1.8;color:rgb(0,0,255);">throws</span><span style="line-height:1.8;"> IOException {
        </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> ((request <span style="line-height:1.8;color:rgb(0,0,255);">instanceof</span><span style="line-height:1.8;"> MultiPartRequestWrapper)) {
            </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> request;
        }
        </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span><span style="line-height:1.8;"> (MultiPartRequest.isMultiPart(request)) {
            request </span>= <span style="line-height:1.8;color:rgb(0,0,255);">new</span><span style="line-height:1.8;"> MultiPartRequestWrapper(request, getSaveDir(), getMaxSize());
        }
        </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> request;
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <ul style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style:disc;"><span style="line-height:1.8;font-size:15px;">&nbsp;首先判断了传进来的&nbsp;<strong>request</strong>&nbsp;是不是已经被封装好的&nbsp;<strong>MultiPartRequestWrapper</strong>，如果是就直接返回。</span></li> 
    <li style="list-style:disc;"><span style="line-height:1.8;font-size:15px;">&nbsp;否则再判断&nbsp;<strong>request</strong>&nbsp;的头信息里面的&nbsp;<strong>Content­Type</strong>&nbsp;是不是多类型参数 （multipart/form­data）的请求，如果是就把&nbsp;<strong>request</strong>&nbsp;包装成&nbsp;<strong>WebWork</strong>&nbsp;自己的&nbsp;<strong>MultiPartRequestWrapper</strong>&nbsp;类型，该类型继承<strong>HttpServletRequestWrapper&nbsp;</strong>。</span></li> 
   </ul>
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-size:15px;">&nbsp; &nbsp;<strong>&nbsp;MultiPartRequest.isMultiPart()</strong>&nbsp;方法实现如下：</span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre> <span style="line-height:1.8;color:rgb(0,0,255);">public</span> <span style="line-height:1.8;color:rgb(0,0,255);">static</span> <span style="line-height:1.8;color:rgb(0,0,255);">boolean</span><span style="line-height:1.8;"> isMultiPart(HttpServletRequest request){
        String content_type </span>= request.getHeader("Content-Type"<span style="line-height:1.8;">);
        </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span> content_type != <span style="line-height:1.8;color:rgb(0,0,255);">null</span> &amp;&amp; content_type.startsWith("multipart/form-data"<span style="line-height:1.8;">);
    }</span></pre>
   </div> 
   <ul style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style:disc;"><span style="line-height:1.8;font-size:15px;">在&nbsp;<strong>webwork.properties&nbsp;</strong>里面配置文件的临时存储目录、还有最大上传大小，其实就是在这个时候起到作用的。</span></li> 
    <li style="list-style:disc;"> <span style="line-height:1.8;font-size:15px;">创建&nbsp;<strong>MultiPartRequestWrapper</strong>&nbsp;对象的时候传入的参数是由&nbsp;<strong>getSaveDir()</strong>&nbsp;和&nbsp;</span><span style="line-height:1.8;font-size:15px;"><strong>getMaxSize()&nbsp;</strong>方 法 获 得 的 。</span> </li> 
    <li style="list-style:disc;"><span style="line-height:1.8;font-size:15px;">在方法里会查找配置里面的&nbsp;<strong>webwork.multipart.saveDir、 webwork.multipart.maxSize&nbsp;</strong>属性，找到则使用该属性指定的临时目录和上传的最大内容，没找到就使用环境的临时目录。</span></li> 
   </ul>
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-size:15px;">具体实现如下：</span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="line-height:1.8;color:rgb(0,0,255);">protected</span><span style="line-height:1.8;"> String getSaveDir() {
        String saveDir </span>= Configuration.getString("webwork.multipart.saveDir"<span style="line-height:1.8;">).trim();
        </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (saveDir.equals(""<span style="line-height:1.8;">)) {
            File tempdir </span>= (File) getServletConfig().getServletContext().getAttribute("javax.servlet.context.tempdir"<span style="line-height:1.8;">);
            log.info(</span>"Unable to find 'webwork.multipart.saveDir' property setting. Defaulting to javax.servlet.context.tempdir"<span style="line-height:1.8;">);
            </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (tempdir != <span style="line-height:1.8;color:rgb(0,0,255);">null</span><span style="line-height:1.8;">) {
                saveDir </span>=<span style="line-height:1.8;"> tempdir.toString();
            }
        } </span><span style="line-height:1.8;color:rgb(0,0,255);">else</span><span style="line-height:1.8;"> {
            File multipartSaveDir </span>= <span style="line-height:1.8;color:rgb(0,0,255);">new</span><span style="line-height:1.8;"> File(saveDir);
            </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (!<span style="line-height:1.8;">multipartSaveDir.exists()) {
                multipartSaveDir.mkdir();
            }
        }
        </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span><span style="line-height:1.8;"> (log.isDebugEnabled()) {
            log.debug(</span>"saveDir=" +<span style="line-height:1.8;"> saveDir);
        }
        </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> saveDir;
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <div style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;text-align:right;"> 
    <a href="http://www.cnblogs.com/java-class/p/5175619.html#_labelTop" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">回到顶部</a>
    <a name="_label1" style="color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);"></a> 
   </div> 
   <h3 style="font-size:16px;line-height:1.5;font-family:verdana, Arial, Helvetica, sans-serif;"><span style="line-height:1.8;font-size:15px;">2. 获取文件上传的解析类 &nbsp; &nbsp;&nbsp;</span></h3> 
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span style="line-height:1.8;font-size:15px;">&nbsp; &nbsp;再来看一下&nbsp;<strong>MultiPartRequestWrapper</strong>&nbsp;的构造函数使如何包装&nbsp;<strong>request</strong>&nbsp;的：</span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="line-height:1.8;color:rgb(0,0,255);">public</span> MultiPartRequestWrapper(HttpServletRequest request, String saveDir, <span style="line-height:1.8;color:rgb(0,0,255);">int</span> maxSize) <span style="line-height:1.8;color:rgb(0,0,255);">throws</span><span style="line-height:1.8;"> IOException {
        </span><span style="line-height:1.8;color:rgb(0,0,255);">super</span><span style="line-height:1.8;">(request);
        </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> ((request <span style="line-height:1.8;color:rgb(0,0,255);">instanceof</span><span style="line-height:1.8;"> MultiPartRequest)) {
            </span><span style="line-height:1.8;color:rgb(0,0,255);">this</span>.multi =<span style="line-height:1.8;"> ((MultiPartRequest) request);
        } </span><span style="line-height:1.8;color:rgb(0,0,255);">else</span><span style="line-height:1.8;"> {
            String parser </span>= ""<span style="line-height:1.8;">;
            parser </span>= Configuration.getString("webwork.multipart.parser"<span style="line-height:1.8;">);
            </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (parser.equals(""<span style="line-height:1.8;">)) {
                log.warn(</span>"Property webwork.multipart.parser not set. Using com.opensymphony.webwork.dispatcher.multipart.PellMultiPartRequest"<span style="line-height:1.8;">);
                parser </span>= "com.opensymphony.webwork.dispatcher.multipart.PellMultiPartRequest"<span style="line-height:1.8;">;
            } </span><span style="line-height:1.8;color:rgb(0,0,255);">else</span> <span style="line-height:1.8;color:rgb(0,0,255);">if</span> (parser.equals("pell"<span style="line-height:1.8;">)) {
                parser </span>= "com.opensymphony.webwork.dispatcher.multipart.PellMultiPartRequest"<span style="line-height:1.8;">;
            } </span><span style="line-height:1.8;color:rgb(0,0,255);">else</span> <span style="line-height:1.8;color:rgb(0,0,255);">if</span> (parser.equals("cos"<span style="line-height:1.8;">)) {
                parser </span>= "com.opensymphony.webwork.dispatcher.multipart.CosMultiPartRequest"<span style="line-height:1.8;">;
            } </span><span style="line-height:1.8;color:rgb(0,0,255);">else</span> <span style="line-height:1.8;color:rgb(0,0,255);">if</span> (parser.equals("jakarta"<span style="line-height:1.8;">)) {
                parser </span>= "com.opensymphony.webwork.dispatcher.multipart.JakartaMultiPartRequest"<span style="line-height:1.8;">;
            }
            </span><span style="line-height:1.8;color:rgb(0,0,255);">try</span><span style="line-height:1.8;"> {
                Class baseClazz </span>= MultiPartRequest.<span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;">;
                Class clazz </span>=<span style="line-height:1.8;"> Class.forName(parser);
                </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (!<span style="line-height:1.8;">baseClazz.isAssignableFrom(clazz)) {
                    addError(</span>"Class '" + parser + "' does not extend MultiPartRequest"<span style="line-height:1.8;">);
                    </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;">;
                }
                Constructor ctor </span>= clazz.getDeclaredConstructor(<span style="line-height:1.8;color:rgb(0,0,255);">new</span> Class[] { Class.forName("javax.servlet.http.HttpServletRequest"), String.<span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;">, Integer.TYPE });
                Object[] parms </span>= { request, saveDir, <span style="line-height:1.8;color:rgb(0,0,255);">new</span><span style="line-height:1.8;"> Integer(maxSize) };
                </span><span style="line-height:1.8;color:rgb(0,0,255);">this</span>.multi =<span style="line-height:1.8;"> ((MultiPartRequest) ctor.newInstance(parms));
            } </span><span style="line-height:1.8;color:rgb(0,0,255);">catch</span><span style="line-height:1.8;"> (ClassNotFoundException e) {
                addError(</span>"Class: " + parser + " not found."<span style="line-height:1.8;">);
            } </span><span style="line-height:1.8;color:rgb(0,0,255);">catch</span><span style="line-height:1.8;"> (NoSuchMethodException e) {
                addError(</span>"Constructor error for " + parser + ": " +<span style="line-height:1.8;"> e);
            } </span><span style="line-height:1.8;color:rgb(0,0,255);">catch</span><span style="line-height:1.8;"> (InstantiationException e) {
                addError(</span>"Error instantiating " + parser + ": " +<span style="line-height:1.8;"> e);
            } </span><span style="line-height:1.8;color:rgb(0,0,255);">catch</span><span style="line-height:1.8;"> (IllegalAccessException e) {
                addError(</span>"Access errror for " + parser + ": " +<span style="line-height:1.8;"> e);
            } </span><span style="line-height:1.8;color:rgb(0,0,255);">catch</span><span style="line-height:1.8;"> (InvocationTargetException e) {
                addError(e.getTargetException().toString());
            }
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <ul style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style:disc;"><span style="line-height:1.8;font-size:15px;">&nbsp;首先它判断了传入的&nbsp;<strong>request</strong>&nbsp;是不是&nbsp;<strong>MultiPartRequest</strong>&nbsp;抽象类的子类，如果是就直接把自身的&nbsp;<strong>MultiPartRequest</strong>&nbsp;类型的变量引用&nbsp;<strong>request</strong>。</span></li> 
    <li style="list-style:disc;"> <span style="line-height:1.8;font-size:15px;">&nbsp;否则读取&nbsp;<strong>WebWork</strong>&nbsp;配置 的<strong>webwork.multipart.parser</strong>&nbsp;属性，该属性决定&nbsp;<strong>Webwork&nbsp;</strong></span><span style="line-height:1.8;font-size:15px;">内部用什么实现文件上传。 如果没有指定，则默认使用&nbsp;<strong>PellMultiPartRequest</strong>&nbsp;的实现。</span> </li> 
    <li style="list-style:disc;"> <span style="line-height:1.8;font-size:15px;">找到配置的类后，<strong>WebWork</strong>&nbsp;通过 Java 反射创建该类的实例。所有支持的类都是从&nbsp;<strong>MultiPartRequest</strong>&nbsp;继承而来，创建该实例后向上转型，并赋予&nbsp;</span><span style="line-height:1.8;font-size:15px;"><strong>MultiPartRequestWrapper</strong>&nbsp;的成员multi。&nbsp;</span> </li> 
    <li style="list-style:disc;"><span style="line-height:1.8;font-size:15px;">&nbsp;WebWork 的文件上传封装了几种通用的 FileUpload lib，并不是自己实现的。</span></li> 
    <li style="list-style:disc;"><span style="line-height:1.8;font-size:15px;">它包括了pell，cos，apache common 三种实现，<strong>WebWork</strong>&nbsp;对这三个包进行封装，提供了一 个通用的访问接口&nbsp;<strong>MultiPartRequest</strong>，细节实现分别是&nbsp;<strong>PellMultiPartRequest、 CosMultiPartRequest 、JakartaMultiPartRequest</strong>&nbsp;。</span></li> 
    <li style="list-style:disc;"> <span style="line-height:1.8;font-size:15px;">&nbsp;<strong>jakarta</strong>&nbsp;支持多个文件使用</span><span style="line-height:1.8;font-size:15px;">同一个HTTP参数名。如果直接使用&nbsp;<strong>WebWork</strong>&nbsp;的&nbsp;<strong>FileUpload</strong>&nbsp;拦截器，推荐使用pell，因为当你上传中文文件名称的文件的时候，只有pell 包会正确的获得中文文件名称，apache common会将文件名称改为xxx.tmp这样的文件名，而</span><span style="line-height:1.8;font-size:15px;">cos会乱码， 因此我们唯一的选择只有 pell。</span> </li> 
    <li style="list-style:disc;"> <span style="line-height:1.8;font-size:15px;">cos 的功能比较强大，WebWork 的封装却使它丧失了很多的功能，cos 需要设置 request 的character encoding。WebWork的封装没有</span><span style="line-height:1.8;font-size:15px;">设置，所以就导致了cos的乱码问题，当然如果你单独 使用cos，则会避免此类问题。</span> </li> 
   </ul>
   <div style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;text-align:right;"> 
    <a href="http://www.cnblogs.com/java-class/p/5175619.html#_labelTop" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">回到顶部</a>
    <a name="_label2" style="color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);"></a> 
   </div> 
   <h3 style="font-size:16px;line-height:1.5;font-family:verdana, Arial, Helvetica, sans-serif;"><span style="line-height:1.8;font-size:15px;">3. 项目实战配置和使用</span></h3> 
   <ul style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style:disc;">&nbsp;配置文件</li>
   </ul>
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="line-height:1.8;">action 配置：
 </span><span style="line-height:1.8;color:rgb(0,0,255);">&lt;</span><span style="line-height:1.8;color:rgb(128,0,0);">action </span><span style="line-height:1.8;color:rgb(255,0,0);">name</span><span style="line-height:1.8;color:rgb(0,0,255);">="uploadAttach"</span><span style="line-height:1.8;color:rgb(255,0,0);"> class</span><span style="line-height:1.8;color:rgb(0,0,255);">=".....attach.action.uploadAttach"</span><span style="line-height:1.8;color:rgb(255,0,0);">  caption</span><span style="line-height:1.8;color:rgb(0,0,255);">="上传附件"</span><span style="line-height:1.8;color:rgb(0,0,255);">&gt;</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">&lt;</span><span style="line-height:1.8;color:rgb(128,0,0);">result </span><span style="line-height:1.8;color:rgb(255,0,0);">name</span><span style="line-height:1.8;color:rgb(0,0,255);">="success"</span><span style="line-height:1.8;color:rgb(255,0,0);"> type</span><span style="line-height:1.8;color:rgb(0,0,255);">="dispatcher"</span><span style="line-height:1.8;color:rgb(0,0,255);">&gt;</span>
        <span style="line-height:1.8;color:rgb(0,0,255);">&lt;</span><span style="line-height:1.8;color:rgb(128,0,0);">param </span><span style="line-height:1.8;color:rgb(255,0,0);">name</span><span style="line-height:1.8;color:rgb(0,0,255);">="location"</span><span style="line-height:1.8;color:rgb(0,0,255);">&gt;</span>/result.jsp<span style="line-height:1.8;color:rgb(0,0,255);">&lt;/</span><span style="line-height:1.8;color:rgb(128,0,0);">param</span><span style="line-height:1.8;color:rgb(0,0,255);">&gt;</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">&lt;/</span><span style="line-height:1.8;color:rgb(128,0,0);">result</span><span style="line-height:1.8;color:rgb(0,0,255);">&gt;</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">&lt;</span><span style="line-height:1.8;color:rgb(128,0,0);">result </span><span style="line-height:1.8;color:rgb(255,0,0);">name</span><span style="line-height:1.8;color:rgb(0,0,255);">="error"</span><span style="line-height:1.8;color:rgb(255,0,0);"> type</span><span style="line-height:1.8;color:rgb(0,0,255);">="dispatcher"</span><span style="line-height:1.8;color:rgb(0,0,255);">&gt;</span>
        <span style="line-height:1.8;color:rgb(0,0,255);">&lt;</span><span style="line-height:1.8;color:rgb(128,0,0);">param </span><span style="line-height:1.8;color:rgb(255,0,0);">name</span><span style="line-height:1.8;color:rgb(0,0,255);">="location"</span><span style="line-height:1.8;color:rgb(0,0,255);">&gt;</span>/result.jsp<span style="line-height:1.8;color:rgb(0,0,255);">&lt;/</span><span style="line-height:1.8;color:rgb(128,0,0);">param</span><span style="line-height:1.8;color:rgb(0,0,255);">&gt;</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">&lt;/</span><span style="line-height:1.8;color:rgb(128,0,0);">result</span><span style="line-height:1.8;color:rgb(0,0,255);">&gt;</span>       
    <span style="line-height:1.8;color:rgb(0,0,255);">&lt;</span><span style="line-height:1.8;color:rgb(128,0,0);">interceptor-ref </span><span style="line-height:1.8;color:rgb(255,0,0);">name</span><span style="line-height:1.8;color:rgb(0,0,255);">="defaultStack"</span> <span style="line-height:1.8;color:rgb(0,0,255);">/&gt;</span>  
    <span style="line-height:1.8;color:rgb(0,0,255);">&lt;</span><span style="line-height:1.8;color:rgb(128,0,0);">interceptor-ref </span><span style="line-height:1.8;color:rgb(255,0,0);">name</span><span style="line-height:1.8;color:rgb(0,0,255);">="fileUploadStack"</span> <span style="line-height:1.8;color:rgb(0,0,255);">/&gt;</span><span style="line-height:1.8;"> //webwok 上传所需要的拦截栈
 </span><span style="line-height:1.8;color:rgb(0,0,255);">&lt;/</span><span style="line-height:1.8;color:rgb(128,0,0);">action</span><span style="line-height:1.8;color:rgb(0,0,255);">&gt;</span><span style="line-height:1.8;">

//拦截栈的定义
</span><span style="line-height:1.8;color:rgb(0,0,255);">&lt;</span><span style="line-height:1.8;color:rgb(128,0,0);">interceptor-stack </span><span style="line-height:1.8;color:rgb(255,0,0);">name</span><span style="line-height:1.8;color:rgb(0,0,255);">="fileUploadStack"</span><span style="line-height:1.8;color:rgb(0,0,255);">&gt;</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">&lt;</span><span style="line-height:1.8;color:rgb(128,0,0);">interceptor-ref </span><span style="line-height:1.8;color:rgb(255,0,0);">name</span><span style="line-height:1.8;color:rgb(0,0,255);">="fileUpload"</span><span style="line-height:1.8;color:rgb(0,0,255);">/&gt;</span>  
    <span style="line-height:1.8;color:rgb(0,0,255);">&lt;</span><span style="line-height:1.8;color:rgb(128,0,0);">interceptor-ref </span><span style="line-height:1.8;color:rgb(255,0,0);">name</span><span style="line-height:1.8;color:rgb(0,0,255);">="params"</span><span style="line-height:1.8;color:rgb(0,0,255);">/&gt;</span>
<span style="line-height:1.8;color:rgb(0,0,255);">&lt;/</span><span style="line-height:1.8;color:rgb(128,0,0);">interceptor-stack</span><span style="line-height:1.8;color:rgb(0,0,255);">&gt;</span><span style="line-height:1.8;">

//拦截栈对应的拦截器
</span><span style="line-height:1.8;color:rgb(0,0,255);">&lt;</span><span style="line-height:1.8;color:rgb(128,0,0);">interceptor </span><span style="line-height:1.8;color:rgb(255,0,0);">name</span><span style="line-height:1.8;color:rgb(0,0,255);">="fileUpload"</span><span style="line-height:1.8;color:rgb(255,0,0);">   class</span><span style="line-height:1.8;color:rgb(0,0,255);">="com.opensymphony.webwork.interceptor.FileUploadInterceptor"</span><span style="line-height:1.8;color:rgb(0,0,255);">/&gt;</span>
<span style="line-height:1.8;color:rgb(0,0,255);">&lt;</span><span style="line-height:1.8;color:rgb(128,0,0);">interceptor </span><span style="line-height:1.8;color:rgb(255,0,0);">name</span><span style="line-height:1.8;color:rgb(0,0,255);">="params"</span><span style="line-height:1.8;color:rgb(255,0,0);">          class</span><span style="line-height:1.8;color:rgb(0,0,255);">="com.opensymphony.xwork.interceptor.ParametersInterceptor"</span><span style="line-height:1.8;color:rgb(0,0,255);">/&gt;</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <ul style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style:disc;"> <span style="line-height:1.8;font-size:15px;">前端使用比较稳定、功能比较强大的&nbsp;Ajaxupload这里就不多说了，有官方网址:</span><span style="line-height:1.8;font-size:15px;"><a href="http://www.cnblogs.com/dabaopku/archive/2011/06/29/2092833.html" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom:1px dotted rgb(51,51,51);">http://www.cnblogs.com/dabaopku/archive/2011/06/29/2092833.html</a></span> </li> 
    <li style="list-style:disc;"><span style="line-height:1.8;font-size:15px;">通过对 Webwork 上传请求的封装和解析类的获取，所有的前戏都已经准备妥当，上传拦截器里面具体实现如下：</span></li> 
   </ul>
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="line-height:1.8;color:rgb(0,0,255);">public</span> String intercept(ActionInvocation invocation) <span style="line-height:1.8;color:rgb(0,0,255);">throws</span><span style="line-height:1.8;"> Exception {</span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (!(ServletActionContext.getRequest() <span style="line-height:1.8;color:rgb(0,0,255);">instanceof</span><span style="line-height:1.8;"> MultiPartRequestWrapper)) {
            </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span><span style="line-height:1.8;"> (log.isDebugEnabled()) {
                log.debug(</span>"bypass " + invocation.getProxy().getNamespace() + "/" +<span style="line-height:1.8;"> invocation.getProxy().getActionName());
            }
            </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> invocation.invoke();
        }
        Action action </span>=<span style="line-height:1.8;"> invocation.getAction();
        ValidationAware validation </span>= <span style="line-height:1.8;color:rgb(0,0,255);">null</span><span style="line-height:1.8;">;
        </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> ((action <span style="line-height:1.8;color:rgb(0,0,255);">instanceof</span><span style="line-height:1.8;"> ValidationAware)) {
            validation </span>=<span style="line-height:1.8;"> (ValidationAware) action;
        }
        MultiPartRequestWrapper multiWrapper </span>=<span style="line-height:1.8;"> (MultiPartRequestWrapper) ServletActionContext.getRequest();
        </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span><span style="line-height:1.8;"> (multiWrapper.hasErrors()) {
            Collection errors </span>=<span style="line-height:1.8;"> multiWrapper.getErrors();
            Iterator i </span>=<span style="line-height:1.8;"> errors.iterator();
            </span><span style="line-height:1.8;color:rgb(0,0,255);">while</span><span style="line-height:1.8;"> (i.hasNext()) {
                String error </span>=<span style="line-height:1.8;"> (String) i.next();
                </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (validation != <span style="line-height:1.8;color:rgb(0,0,255);">null</span><span style="line-height:1.8;">) {
                    validation.addActionError(error);
                }
                log.error(error);
            }
        }
        Enumeration e </span>=<span style="line-height:1.8;"> multiWrapper.getFileParameterNames();
        </span><span style="line-height:1.8;color:rgb(0,0,255);">while</span> ((e != <span style="line-height:1.8;color:rgb(0,0,255);">null</span>) &amp;&amp;<span style="line-height:1.8;"> (e.hasMoreElements())) {
            String inputName </span>=<span style="line-height:1.8;"> (String) e.nextElement();

            String[] contentType </span>=<span style="line-height:1.8;"> multiWrapper.getContentTypes(inputName);

            String[] fileName </span>=<span style="line-height:1.8;"> multiWrapper.getFileNames(inputName);

            File[] file </span>=<span style="line-height:1.8;"> multiWrapper.getFiles(inputName);
            </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (file != <span style="line-height:1.8;color:rgb(0,0,255);">null</span><span style="line-height:1.8;">) {
                </span><span style="line-height:1.8;color:rgb(0,0,255);">for</span> (<span style="line-height:1.8;color:rgb(0,0,255);">int</span> i = 0; i &lt; file.length; i++<span style="line-height:1.8;">) {
                    log.info(</span>"file " + inputName + " " + contentType[i] + " " + fileName[i] + " " +<span style="line-height:1.8;"> file[i]);
                }
            }
            </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (file == <span style="line-height:1.8;color:rgb(0,0,255);">null</span><span style="line-height:1.8;">) {
                </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (validation != <span style="line-height:1.8;color:rgb(0,0,255);">null</span><span style="line-height:1.8;">) {
                    validation.addFieldError(inputName, </span>"Could not upload file(s). Perhaps it is too large?"<span style="line-height:1.8;">);
                }
                log.error(</span>"Error uploading: " +<span style="line-height:1.8;"> fileName);
            } </span><span style="line-height:1.8;color:rgb(0,0,255);">else</span><span style="line-height:1.8;"> {
                invocation.getInvocationContext().getParameters().put(inputName, file);
                invocation.getInvocationContext().getParameters().put(inputName </span>+ "ContentType"<span style="line-height:1.8;">, contentType);
                invocation.getInvocationContext().getParameters().put(inputName </span>+ "FileName"<span style="line-height:1.8;">, fileName);
            }
        }
        String result </span>=<span style="line-height:1.8;"> invocation.invoke();
        </span><span style="line-height:1.8;color:rgb(0,0,255);">for</span> (Enumeration e1 = multiWrapper.getFileParameterNames(); e1 != <span style="line-height:1.8;color:rgb(0,0,255);">null</span> &amp;&amp;<span style="line-height:1.8;"> e1.hasMoreElements();) {
            String inputValue </span>=<span style="line-height:1.8;"> (String) e1.nextElement();
            File file[] </span>=<span style="line-height:1.8;"> multiWrapper.getFiles(inputValue);
            </span><span style="line-height:1.8;color:rgb(0,0,255);">for</span> (<span style="line-height:1.8;color:rgb(0,0,255);">int</span> i = 0; i &lt; file.length; i++<span style="line-height:1.8;">) {
                File f </span>=<span style="line-height:1.8;"> file[i];
                log.info(</span>"removing file " + inputValue + " " +<span style="line-height:1.8;"> f);
                </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (f != <span style="line-height:1.8;color:rgb(0,0,255);">null</span> &amp;&amp;<span style="line-height:1.8;"> f.isFile())
                    f.delete();
            }
        }
        </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> result;
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <ul style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style:disc;"><span style="line-height:1.8;font-size:15px;">首先判断当前请求是否为 包含多媒体请求，如果是则记录日志，并执行&nbsp;<strong>Action</strong>。</span></li> 
    <li style="list-style:disc;"><span style="line-height:1.8;font-size:15px;">然后判断在文件上传过程&nbsp;<strong>MultiPartRequestWrapper</strong>&nbsp;是否含有错误，将错误信息，返回给客户端，不在继续调用&nbsp;<strong>Action</strong>。</span></li> 
    <li style="list-style:disc;"><span style="line-height:1.8;font-size:15px;">如果上面的判断条件都没有进行，开始遍历&nbsp;<strong>MultiPartRequestWrapper &nbsp;</strong>中的上传文件的参数，并将其中的文件名、文件内容类型放入<strong>Action</strong>&nbsp;参数 map 中，供后面的业务类进行操作。</span></li> 
    <li style="list-style:disc;"><span style="line-height:1.8;font-size:15px;">在&nbsp;<strong>WebWork</strong>&nbsp;的&nbsp;<strong>fileupload</strong>&nbsp;拦截器功能中，它提供的 File只 是一个临时文件，Action 执行之后就会被自动删除，你必须在&nbsp;<strong>Action</strong>中自己处理文件的存储问题，或者写到服务器的某个目录，或者保存到数据库中。如果你准备写到服务器的某个目录下面的话，你必须自己面临着处理文件同名的问题，但是实际上cos包已经提供了 文件重名的自动重命名规则。&nbsp;</span></li> 
   </ul>
   <p style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;本文转自Orson博客园博客，原文链接：http://www.cnblogs.com/java-class/p/5175619.html，如需转载请自行联系原作者</p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
