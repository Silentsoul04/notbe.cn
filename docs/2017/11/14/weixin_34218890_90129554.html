<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>[译] libvirt 虚机的生命周期 （Libvirt Virtual Machine Lifecycle） « NotBeCN</title>
  <meta name="description" content="                 翻译自：    http://wiki.libvirt.org/page/VM_lifecycle            &nbsp;           这篇文章描述虚机生命周期的基本概念。其目的在于在一篇文章中提供完整的关于虚机创建、运行、停止、迁移和删除的基础知识。    ...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/14/weixin_34218890_90129554.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">[译] libvirt 虚机的生命周期 （Libvirt Virtual Machine Lifecycle）</h1>
    <p class="post-meta">Nov 14, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    翻译自：
    <a href="http://wiki.libvirt.org/page/VM_lifecycle" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://wiki.libvirt.org/page/VM_lifecycle</a> 
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    &nbsp;
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    这篇文章描述虚机生命周期的基本概念。其目的在于在一篇文章中提供完整的关于虚机创建、运行、停止、迁移和删除的基础知识。
   </div> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;"><span style="line-height:1.5;font-size:1.17em;">1. 概念</span></h2> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;font-size:1.17em;">先补充一下 Domain（域）、Virutal Machine（虚机）和 Guest OS （客户机操作系统）三个术语的区别。这三个概念经常被相互使用，其实它们之间还是有些区别。</span></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;font-size:1.17em;">Oracel 的解释 （<a href="http://docs.oracle.com/cd/E26996_01/E18549/html/VMUSG1194.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">资料来源</a>）：</span></p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;"><span style="line-height:1.5;font-size:1.17em;">Domain：资源的一个可配置集合，包括内存，虚拟CPU，网络设备和磁盘设备。在 Domain 中运行（多个）虚拟机。一个 Domain 被分配虚拟资源，可以独立地被启动、停止和重启。</span></li> 
    <li style="list-style-type:disc;"><span style="line-height:1.5;font-size:1.17em;">Guest OS：运行在 domain 中的虚拟操作系统。一个 Guest OS 可以是部分虚拟化或者硬件虚拟化的。一个 Hypervisor上可以运行多个 Guest OS。</span></li> 
    <li style="list-style-type:disc;"><span style="line-height:1.5;font-size:1.17em;">VM：Guest OS + 它相关的应用软件。</span></li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">libvirt 的解释 （<a href="http://libvirt.org/guide/html/Application_Development_Guide-Guest_Domains.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">资料来源</a>）：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">一个 libvirt Domain 是一个运行在虚拟机器上的操作系统的实例，它可以指一个运行着的虚拟机，或者用于启动虚拟机的配置。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">Xen 的解释（<a href="http://wiki.xen.org/wiki/Domain" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">资料来源</a>）：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">对 Xen 来说，一个 domain 就是指一个虚拟机，其 domain 概念如下：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="http://dl.iteye.com/upload/attachment/216483/b7210bc7-3c75-38ce-9ab4-abfb93b94c2b.jpg" alt="" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">好吧，这些说法还是有细微差别，下文中的 Domain 就当是虚拟机吧。其它术语：</p> 
   <table border="0" style="border:1px solid #C0C0C0;border-collapse:collapse;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <thead>
     <tr>
      <th style="border:1px solid #C0C0C0;border-collapse:collapse;"> 
       <div class="para">
        <span class="bold" style="line-height:1.5;"><strong>术语</strong></span>
       </div> </th> 
      <th style="border:1px solid #C0C0C0;border-collapse:collapse;"> 
       <div class="para">
        解释
       </div> </th> 
     </tr>
    </thead>
    <tbody>
     <tr>
      <td align="left" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> 
       <div class="para">
        <span class="application" style="line-height:1.5;"><strong>Domain 域</strong></span>
       </div> </td> 
      <td align="left" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> 
       <div class="para">
        <span style="line-height:1.5;font-size:10px;">一个运行在被虚拟化的机器上的，由 hypervisor 提供的操作系统实例</span>
       </div> </td> 
     </tr>
     <tr>
      <td align="left" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> 
       <div class="para">
        <span class="application" style="line-height:1.5;"><strong>Hypervisor 虚机管理程序</strong></span>
       </div> </td> 
      <td align="left" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> 
       <div class="para">
        <span style="line-height:1.5;font-size:10px;">一个虚拟化一个物理服务器为多个虚拟机的软件层。</span>
       </div> </td> 
     </tr>
     <tr>
      <td align="left" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> 
       <div class="para">
        <span class="application" style="line-height:1.5;"><strong>Node 节点</strong></span>
       </div> </td> 
      <td align="left" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> 
       <div class="para">
        <span style="line-height:1.5;font-size:10px;">一个物理服务器。它可能有多种类型，比如存储节点，集群节点和数据库节点等。</span>
       </div> </td> 
     </tr>
     <tr>
      <td align="left" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> 
       <div class="para">
        <span class="application" style="line-height:1.5;"><strong>Storage Pool 存储池</strong></span>
       </div> </td> 
      <td align="left" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> 
       <div class="para">
        一个存储介质的集合，比如物理硬盘驱动器的集合。一个存储池被细分为卷，卷会被分配给一个或者多个域。
       </div> </td> 
     </tr>
     <tr>
      <td align="left" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> 
       <div class="para">
        <span class="application" style="line-height:1.5;"><strong>Volume 卷</strong></span>
       </div> </td> 
      <td align="left" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> 
       <div class="para">
        一个从存储池中分配出来的存储空间。一个卷可能会分配给一个或者多个域使用，并且往往被用作域内的虚拟硬盘驱动器。
       </div> </td> 
     </tr>
    </tbody>
   </table>
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;"><span style="line-height:1.5;font-size:1.17em;">1.1 XML 描述</span></h3> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    Guest domain 是用 XML 配置来描述的。libvirt 使用 XML 文件格式来保存它的所有对象的配置，包括 domain，网络、存储和其它元素。这样，用户就可以使用任何他们喜欢使用的编辑器来编辑这些XML配置了。
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">比如，domain 中的设备使用 XML 元素 来表示其被分配的属性和子元素的一个示例如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>&lt;domain type=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">qemu</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>&gt;
   &lt;name&gt;demo&lt;/name&gt;<span style="line-height:1.5;">
   ...
   </span>&lt;devices&gt;<span style="line-height:1.5;">
      ...
      </span>&lt;disk type=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">file</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> device=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">disk</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>&gt; ... &lt;/disk&gt;
      &lt;disk type=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">file</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> device=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">cdrom</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>&gt; ... &lt;/disk&gt;
      &lt;input type=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">mouse</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> bus=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">ps2</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;<span style="line-height:1.5;">
      ...
   </span>&lt;/devices&gt;
&lt;/domain&gt;</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    libvirt 使用 XPath 技术来从XML 文档中选择node。&nbsp;
   </div> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;"><span style="line-height:1.5;font-size:14px;">1.2. 过渡性 Guest Domain VS 持久性 Guest Domain</span></h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;font-size:14px;">Libivrt 区分两种不同类型的 domain：短暂性的（</span><em style="font-size:14px;line-height:1.5;">transient</em><span style="line-height:1.5;font-size:14px;">&nbsp;）和持久性的（</span><em style="font-size:14px;line-height:1.5;">persistent</em><span style="line-height:1.5;font-size:14px;">）。</span></p> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <ul style="list-style:none;font-size:12px;">
     <li style="list-style-type:disc;">短暂性 domain 只在 domain 被关机（ shutdown） 或者所在的主机（host）被重启（restart）之前存在。</li> 
     <li style="list-style-type:disc;">持久性 domain 会一直存在，直到被删除。</li> 
    </ul>
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    &nbsp;
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    无论它是什么类型，当一个 domain 被创建后，它的状态可以被保存进一个文件。之后，只要该文件存在，这个 domain 的状态就可以从无限次从该文件中被恢复（ restored）。因此，即使是一个短暂性的domain，它也可以被反复地恢复。
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    &nbsp;
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    创建短暂性的 domain 与创建持久性 domain 有一点不同。对持久性domain来说，它必须在其启动前定义（define）好。而短暂性虚机可以被一次性被创建和启动。操作两种类型的domain的命令也有些区别。当性domain被创建和关闭时，其需要的所有部件（比如存储、网络、设备等）都必须提前被准备好。
   </div> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.3 Domain 状态</h3> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    &nbsp;一个 Guest domain 可能处于的状态：
   </div> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;"> <strong>Undified （未定义的）</strong>：这是起始状态。这时 libvirt 不会知道 domain 的任何信息，因为这时候 domain尚未被定义或者创建。</li> 
    <li style="list-style-type:disc;"> <strong>Defined （定义了的）/ Stopped （停止的）</strong>：domain 已经被定义，但是不在运行（running）。只有持久性&nbsp;domains 才能处于该状态。当一个短暂性&nbsp;domain 被停止或者关机时，它就不存在了。</li> 
    <li style="list-style-type:disc;"> <strong>Running （运行中的）</strong>：domain 被创建而且启动了，无论是短暂性domain还是持久性domain。任何处于该状态的 domain 都已经在主机的 hypervisor 中被执行了。</li> 
    <li style="list-style-type:disc;"> <strong>Paused （中止了的）</strong>：Hypervisor 上对该 domain 的运行被挂起（suspended）了。它的状态被临时保存（比如到内存中），直到它被继续（resumed）。domain 本身不知道它处于是否被中止状态。</li> 
    <li style="list-style-type:disc;"> <strong>Saved （保存了的）</strong>：类似中止（Paused） 状态，除了domain 的状态被保存在持久性存储比如硬盘上。处于该状态上的 domain 可以被恢复 （restored）。</li> 
   </ul>
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    &nbsp;
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    下图描述了 domain 的状态机。方框表示状态，箭头表示使得状态变更的命令。
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    &nbsp;
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <img src="http://wiki.libvirt.org/wiki/images/d/da/Vm_lifecycle_graph.png" alt="Image:Vm lifecycle graph.png" style="border:0px;">
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    &nbsp;
    <span style="line-height:1.5;font-size:14px;">从改图中可以看出，对持久性 domain，shtudown 命令可以将其从运行（running） 状态变为定义（defined）状态；对短暂性 domain 而言，它会从运行（running） 状态变为变为未定义（undefined） 状态。</span>&nbsp; 
    <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.4 快照</h3> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;font-size:14px;"><span style="line-height:1.5;">一个快照是虚机的操作系统和它的所有应用（applications&nbsp;）在某个时刻的视图。在虚拟化领域，提供可以被恢复的虚机快照是个非常基本的功能。快照允许用户保存虚机在某个时刻的状态，然后在将来某个时候回滚到该状态。基本的用例包括，创建快照、安装新的应用、更新或者升级，然后回滚到之前的某个时间点。显然，在快照生成之后发生的任何操作都不会包含在快照中。一个快照不会持续更新。它只表示虚机的某个时间上的状态。&nbsp;</span></span></p> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.5 迁移&nbsp;</h3> 
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <p style="line-height:1.5;">一个运行中的 domain 或者虚机可以被迁移到另一个主机上，只要虚机的存储是在主机之间共享的，并且目标主机的CPU能够支持虚机的CPU模式。根据类型和应用，虚机迁移可以不导致虚机上运行的服务的中断。<span style="line-height:1.5;font-size:14px;">&nbsp;</span></p> 
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    Libvirt 支持多种不同的迁移模式：
   </div> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;"> <strong>Standard （标准模式</strong>）：该模式下，一个 domain 的资源在从源主机迁移到目标主机时，它会处于被挂起（suspended）状态。迁移结束后，虚机在新的主机上继续运行。迁移所花的时间和 domain 的内存大小直接相关。</li> 
    <li style="list-style-type:disc;"> <strong>Live vs non-live（实时 VS 非实时模式）：</strong>当使用实时迁移模式时，domain 不会被中止，它的所有服务都继续运行。一开始，目的主机上的 domain 或者虚机会处于停止状态，而且在domain的状态在网络传输的过程中，domain 在目的主机上实际上是不可见的。实时迁移和它上面所运行的应用的类型有直接关系的。当实时迁移一个 domain 时，它已经被分配的内存会被发送到目的主机，与此同时，其内存的任何改变都会被监视（watched）然后也会被发到目的主机。原主机上的 domain 会一直保持它的状态，直到两个节点上的 domain 的内存达到完全达到一致了。这时，目的主机上的 domain 变为 active 状态，原主机上的 domain 变为 passive 或者不可见状态。</li> 
    <li class="_mce_tagged_br" style="list-style-type:disc;"> <strong>Peer-to-peer （对等模式）</strong>：该模式下，当原主机和目的主机能够直接通信。</li> 
    <li class="_mce_tagged_br" style="list-style-type:disc;"> <strong>Tunnelled （隧道模式）</strong>&nbsp;：该模式下，在原主机和目的主机之间会建立一个隧道 （tunnel），比如 SSH 隧道。两个主机之间的所有通信都会经过该隧道。</li> 
    <li style="list-style-type:disc;"> <strong>Direct</strong>&nbsp;（直接模式）：该模式下，libivrt 使用 hypervisor 来发起迁移，迁移过程完全被 hypervisor 控制。这种模式下，源主机和目的主机的&nbsp;hypervisor 往往是可以直接交互的（比如，原主机和目的主机上的&nbsp;Xen&nbsp;能够直接交互，而不需要libvirt 的干预）</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><strong>迁移要求：</strong></p> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <ul style="list-style:none;font-size:12px;">
     <li style="list-style-type:disc;">使用路径和位置相同的共享存储</li> 
     <li style="list-style-type:disc;">两个物理主机上的 hypervisor 的版本完全相同</li> 
     <li style="list-style-type:disc;">相同的网络配置</li> 
     <li style="list-style-type:disc;">目的主机上有相同的或者更好的CPU。CPU必须来自同一生产厂家，目的主机上的 CPU flags 必须是原主机上的CPU flags 的超集。</li> 
    </ul>
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    这里有个成功迁移所需要的 checklist：&nbsp;
    <a title="TodoPreMigrationChecks" href="http://wiki.libvirt.org/page/TodoPreMigrationChecks" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">here</a>.&nbsp; 
    <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.6 删除 domain 时的数据安全性</h3> &nbsp;一些应用可能会存储敏感数据，这些数据必须被安全地处理。在任何文件系统中都一样，当一个虚机从一个系统中被删除的时候，只是文件系统的指针被删除。存储介质上的数据块任然存在，只是它们在文件系统中被标识为空。当然，这取决于你的文件系统。我们希望，当一个应用处理这种敏感数据的时候，这些机器必须物理上被安全保护，而且网络防护也必须是被防护的。安全在任何时候都很重要。
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    &nbsp;
   </div> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">2. 任务 （Tasks）</h2> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.1 创建一个 domain&nbsp;&nbsp;</h3> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    为了运行一个 domain，首先必须创建一个 domain。有很多方式可以创建一个 domain。
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    （1）
    <a href="http://wiki.libvirt.org/page/CreatingNewVM_in_VirtualMachineManager%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这篇文章</a>描述了使用&nbsp;Virtual Machine Manager GUI 来创建一个domain。
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    （2）下面的代码使用 virt-install 命令来创建一个 domain：
   </div> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre># virt-<span style="line-height:1.5;">install \
             </span>--connect qemu:<span style="color:rgb(128,128,128);line-height:1.5;">///</span><span style="color:rgb(0,128,0);line-height:1.5;">system \</span>
             --virt-<span style="line-height:1.5;">type kvm \
             </span>--<span style="line-height:1.5;">name MyNewVM \
             </span>--ram <span style="color:rgb(128,0,128);line-height:1.5;">512</span><span style="line-height:1.5;"> \
             </span>--disk path=/<span style="color:rgb(0,0,255);line-height:1.5;">var</span>/lib/libvirt/images/MyNewVM.img,size=<span style="color:rgb(128,0,128);line-height:1.5;">8</span><span style="line-height:1.5;"> \
             </span>--<span style="line-height:1.5;">vnc \
             </span>--cdrom /<span style="color:rgb(0,0,255);line-height:1.5;">var</span>/lib/libvirt/images/Fedora-<span style="color:rgb(128,0,128);line-height:1.5;">14</span>-x86_64-Live-<span style="line-height:1.5;">KDE.iso \
             </span>--network network=<span style="color:rgb(0,0,255);line-height:1.5;">default</span>,mac=<span style="color:rgb(128,0,128);line-height:1.5;">52</span>:<span style="color:rgb(128,0,128);line-height:1.5;">54</span>:<span style="color:rgb(128,0,128);line-height:1.5;">00</span>:9c:<span style="color:rgb(128,0,128);line-height:1.5;">94</span><span style="line-height:1.5;">:3b \
             </span>--os-variant fedora14</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;font-size:14px;">该命令创建一个名为&nbsp;'MyNewVM' 的 domain，它有 512M 内存和8G磁盘空间，使用KVM。你可以阅读该命令的手册。</span>&nbsp;</p> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    （3）最后一种方式是创建 domain 和 卷 （volume）的 XML 定义，然后使用 virsh 的&nbsp;vol-create 和&nbsp;define&nbsp;命令。
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">卷 （volume）会被加入一个池（pool）中。默认的话，一个名为&nbsp;&nbsp;"default" 的池会存在。这是一个目录类型的池，它的意思是所有的卷都以文件形式存在于一个目录中。详细信息，你可以读&nbsp;&nbsp;<a title="http://libvirt.org/storage.html" href="http://libvirt.org/storage.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">this page</a>&nbsp;。</p> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    一个卷的 XML定义例子（new_volume.xml）：
   </div> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>&lt;volume&gt;
 &lt;name&gt;sparse.img&lt;/name&gt;
 &lt;capacity unit=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">G</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>&gt;<span style="color:rgb(128,0,128);line-height:1.5;">10</span>&lt;/capacity&gt;
&lt;/volume&gt;</pre>
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    它定义了一个容量为 10G 的卷。使用如下命令来在 'default' 池中创建该卷：
   </div> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre># virsh vol-create <span style="color:rgb(0,0,255);line-height:1.5;">default</span> new_volume.xml</pre>
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    Domain 的 XML 定义的例子&nbsp;(MyNewVM.xml) 如下：
   </div> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>&lt;domain type=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">kvm</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>&gt;
  &lt;name&gt;MyNewVM&lt;/name&gt;
  &lt;currentMemory&gt;<span style="color:rgb(128,0,128);line-height:1.5;">524288</span>&lt;/currentMemory&gt;
  &lt;memory&gt;<span style="color:rgb(128,0,128);line-height:1.5;">524288</span>&lt;/memory&gt;
  &lt;uuid&gt;30d18a08-d6d8-d5d4-f675-8c42c11d6c62&lt;/uuid&gt;
  &lt;os&gt;
    &lt;type arch=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">x86_64</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>&gt;hvm&lt;/type&gt;
    &lt;boot dev=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">hd</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;acpi/&gt;&lt;apic/&gt;&lt;pae/&gt;
  &lt;/features&gt;
  &lt;clock offset=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">utc</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;restart&lt;/on_crash&gt;
  &lt;vcpu&gt;<span style="color:rgb(128,0,128);line-height:1.5;">1</span>&lt;/vcpu&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/bin/qemu-kvm&lt;/emulator&gt;
    &lt;disk type=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">file</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> device=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">disk</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>&gt;
      &lt;driver name=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">qemu</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> type=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">raw</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
      &lt;source file=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">/var/lib/libvirt/images/MyNewVM.img</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
      &lt;target dev=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">vda</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> bus=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">virtio</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
    &lt;/disk&gt;
    &lt;disk type=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">block</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> device=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">cdrom</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>&gt;
      &lt;target dev=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">hdc</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> bus=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">ide</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
      &lt;<span style="color:rgb(0,0,255);line-height:1.5;">readonly</span>/&gt;
    &lt;/disk&gt;
    &lt;<span style="color:rgb(0,0,255);line-height:1.5;">interface</span> type=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">network</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>&gt;
      &lt;source network=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">default</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
      &lt;mac address=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">52:54:00:9c:94:3b</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
      &lt;model type=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">virtio</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
    &lt;/<span style="color:rgb(0,0,255);line-height:1.5;">interface</span>&gt;
    &lt;input type=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">tablet</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> bus=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">usb</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
    &lt;graphics type=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">vnc</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> port=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">-1</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
    &lt;console type=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">pty</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
    &lt;sound model=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">ac97</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
    &lt;video&gt;
      &lt;model type=<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">cirrus</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>/&gt;
    &lt;/video&gt;
  &lt;/devices&gt;
&lt;/domain&gt;</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;font-size:14px;">定义一个持久性的domain：</span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre># virsh define MyNewVM.xml</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;font-size:14px;">Domain 的 XML 格式有很多的可选元素你可能觉得有用。因此，可以阅读&nbsp;</span><a title="http://libvirt.org/formatdomain.html" href="http://libvirt.org/formatdomain.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;font-size:14px;line-height:1.5;">this page</a><span style="line-height:1.5;font-size:14px;">&nbsp;，它包含完整的参考。</span>&nbsp;</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.2 编辑一个 domain</h3> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    &nbsp;可以使用任何编辑器来编辑一个 domain。你需要设置&nbsp;$VISUAL or $EDITOR 环境变量来指定编辑器，然后运行：
   </div> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre># virsh edit &lt;domain&gt;</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">如果这些变量都不存在，默认会使用 vi。当编辑器关闭的时候，libvirt 会自动检查其变化并应用这些改变。你也可以在&nbsp;Virtual Machine Manager 编辑 domain。</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.3 启动一个domain</h3> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    &nbsp;
    <span style="line-height:1.5;font-size:14px;">当一个 domain 被创建后，你可以启动它。你可以使用Virtual Machine Manager，或者运行 virsh&nbsp;start &lt;domain&gt; 命令，比如：</span> 
   </div> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre># virsh start MyNewVM</pre>
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    该命令可能从零启动（boot up）一个 domain 或者从之前保存的一个状态上恢复 domain。请阅读&nbsp;virsh&nbsp;的&nbsp;managedsave 命令 。重要的是，如果它的任何部件比如 network 还没有起来的话，一个 domain 不会被启动起来。
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    &nbsp;
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    就像之前提到的那样，一个&nbsp;transient domain 可以不需要提前定义（define）而直接被启动：
   </div> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre># virsh create /path/to/MyNewVM.xml</pre>
   </div> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.4 停止或者重启（reboot）domain</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">停止一个运行中的 domain：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre># virsh shutdown &lt;domain&gt;</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">重启一个持久性的 domain：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre># virsh reboot &lt;domain&gt;</pre>
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    注意：重启一个暂时性的 domain 是不可能的，因为当它被关闭 （shutdown）后它就变成了 undefined 状态。
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">粗野的关机（inelegant shutdown），等同于直接拔电源：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre># virsh destroy &lt;domain&gt;</pre>
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    &nbsp;
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    Stopping 是指中止一个运行着的domain 的过程。包括两个方法: shutdown 和 destroy。
   </div> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">shutdown 是个优雅（graceful）的停止过程，它会发一个信号给 domain 的操作系统，通知它立刻关机。domain 只有在 OS 成功关闭后才停止。该过程类似于在物理机器上运行 shutdown 命令。</li> 
    <li style="list-style-type:disc;">destroy 是立刻中止 domain。该过程类似于拔掉物理机器的电源。<span style="line-height:1.5;font-size:14px;">&nbsp;</span> </li> 
   </ul>
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.5 中止（Pause）domain</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">使用 suspend 命令来中止一个domain：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre># virsh suspend &lt;domain&gt;</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;font-size:14px;">当一个虚机处于挂起（ suspended） 状态时，它会继续占用系统内存，但不会占用处理器资源。这时候也不会有磁盘和网络IO操作。</span>&nbsp;</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.6 继续（unpause/resume）domain</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">使用 resume 命令来继续一个domain：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre># virsh resume &lt;domain&gt;<span style="line-height:1.5;font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</span></pre>
   </div> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">Suspend and resume 是指将一个domain 临时性的保存到内存中的过程。一段时间后，可以继续该 domain 到其原始的运行状态。Suspend 不保存 domain 的内存到持久性文件。&nbsp;</li> 
    <li style="list-style-type:disc;">Save 和 restore 是指将一个运行着的 domain 的状态保存到文件，以及从文件中恢复的过程。</li> 
   </ul>
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    需要指出的是，save/restore 只会保存内存状态，不会保存存储状态。因此，当一个虚机被恢复时，其所使用的存储必须和虚机被保存时的存储状态一致。对基础性使用来说，这意味着虚机只能从被保存的文件中恢复一次。要运行多次恢复，应用需要在虚机被保存时生成一个快照，然后在恢复虚机时恢复快照。libvirt 将来的一个改进会在保存内存状态的同时进行自动化的快照。&nbsp;
   </div> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.7 对domain做快照</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">使用 snapshot-create 命令来对 domain 做快照：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre># virsh snapshot-create &lt;domain&gt;</pre>
   </div> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.8 列表domain 所有的快照</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">使用 snapshot-list 命令来获取 domain 的所有快照列表：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre># virsh snapshot-list &lt;domain&gt;</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;font-size:14px;">结果比如：</span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre><span style="line-height:1.5;"> Name                 Creation Time             State
</span>---------------------------------------------------
 <span style="color:rgb(128,0,128);line-height:1.5;">1295973577</span>           <span style="color:rgb(128,0,128);line-height:1.5;">2011</span>-<span style="color:rgb(128,0,128);line-height:1.5;">01</span>-<span style="color:rgb(128,0,128);line-height:1.5;">25</span> <span style="color:rgb(128,0,128);line-height:1.5;">17</span>:<span style="color:rgb(128,0,128);line-height:1.5;">39</span>:<span style="color:rgb(128,0,128);line-height:1.5;">37</span> +<span style="color:rgb(128,0,128);line-height:1.5;">0100</span><span style="line-height:1.5;"> running
 </span><span style="color:rgb(128,0,128);line-height:1.5;">1295978837</span>           <span style="color:rgb(128,0,128);line-height:1.5;">2011</span>-<span style="color:rgb(128,0,128);line-height:1.5;">01</span>-<span style="color:rgb(128,0,128);line-height:1.5;">25</span> <span style="color:rgb(128,0,128);line-height:1.5;">19</span>:<span style="color:rgb(128,0,128);line-height:1.5;">07</span>:<span style="color:rgb(128,0,128);line-height:1.5;">17</span> +<span style="color:rgb(128,0,128);line-height:1.5;">0100</span> running</pre>
   </div> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.9 从快照恢复一个domain</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">使用 snapshot-restore 命令来从一个快照恢复一个domain：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre># virsh snapshot-restore &lt;domain&gt; &lt;snapshotname&gt;</pre>
   </div> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.10 删除domain 的一个快照</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">使用 snapshot-delete 命令来删除一个快照：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre># virsh snapshot-delete &lt;domain&gt; &lt;snapshotname&gt;</pre>
   </div> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.11 迁移 （Migration ）</h3> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    &nbsp;Libvirt 支持 domain 的迁移。这意味着你可以把 domain 经过网络从一个主机迁移到另一个主机。迁移的两种主要模式：
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <ul style="list-style:none;font-size:12px;">
     <li style="list-style-type:disc;"> <strong>普通迁移（Plain migration）</strong>：原主机开通一个与目的主机的 TCP 连接来发送迁移的数据。如果TCP 端口没有被指定，那么 libvirt 会自己在&nbsp;49152-49215 区间内选择一个端口。因此你需要在目的主机的防火墙上开启该端口。</li> 
     <li style="list-style-type:disc;"> <strong>隧道迁移（Tunneled migration）</strong>：原主机创建一个与目的主机之间的连接隧道。它允许加密数据流。它不需要额外的防火墙操作，但是只在 qemu 0.12+ 和 libvirt 0.7.2 以后才支持。</li> 
    </ul>
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    要进行成功的迁移，很多事情要做。比如，存储设置。被迁移的 domain 的所有卷都必须保存在同样的路径上。读&nbsp;&nbsp;
    <a title="TodoPreMigrationChecks" href="http://wiki.libvirt.org/page/TodoPreMigrationChecks" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">this page</a>&nbsp;来获取完整的check list。我们建议你使用&nbsp;
    <a title="TodoSecureMigration" href="http://wiki.libvirt.org/page/TodoSecureMigration" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">secure migration</a>。当迁移前的检查都完成后，可以使用migrate 命令来进行迁移：
   </div> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre># virsh migrate &lt;domain&gt; &lt;remote host URI&gt; --migrateuri tcp:<span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">&lt;remote host&gt;:&lt;port&gt;</span></pre>
   </div> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.12 删除一个domain</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">使用virsh 的 undefine 命令来删除一个 domain：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre># virsh undefine &lt;domain&gt;</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">同样地，你也可以在 Virtual Machine Manager 中删除一个 domain。可以阅读<a href="http://wiki.libvirt.org/page/DeletingVirtualMachine_in_VirtualMachineManager" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">这篇文章</a>.</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><br></p> 
   <p style="line-height:1.5;"><font color="#4b4b4b"><span style="font-size:15px;">&nbsp; &nbsp; 本文转自SammyLiu博客园博客，原文链接：http://www.cnblogs.com/sammyliu/p/4486712.html</span></font><span style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">，如需转载请自行联系原作者</span></p> 
   <div>
    <br>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><br></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
