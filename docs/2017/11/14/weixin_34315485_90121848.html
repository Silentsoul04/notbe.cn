<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Linux设备模型(9)_device resource management ---devm申请空间【转】 « NotBeCN</title>
  <meta name="description" content="                  阅读目录          转自：http://www.wowotech.net/linux_kenrel/device_resource_management.html      &nbsp;                 回到顶部            转自：http:/...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/14/weixin_34315485_90121848.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">Linux设备模型(9)_device resource management ---devm申请空间【转】</h1>
    <p class="post-meta">Nov 14, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <div style="color:rgb(102,102,102);font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif, '宋体';font-size:14px;"> 
    <p style="font-size:18px;"><b>阅读目录</b></p> 
    <ul>
     <li style="list-style:disc;"><a href="http://www.cnblogs.com/sky-heaven/p/5702335.html#_label0" rel="nofollow" style="color:rgb(51,51,51);font-weight:inherit;line-height:inherit;">转自：http://www.wowotech.net/linux_kenrel/device_resource_management.html</a></li> 
     <li style="list-style:disc;"><a href="http://www.cnblogs.com/sky-heaven/p/5702335.html#_label1" rel="nofollow" style="color:rgb(51,51,51);font-weight:inherit;line-height:inherit;">&nbsp;</a></li> 
    </ul>
   </div> 
   <div style="color:rgb(102,102,102);font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif, '宋体';font-size:14px;text-align:right;"> 
    <a href="http://www.cnblogs.com/sky-heaven/p/5702335.html#_labelTop" rel="nofollow" style="color:rgb(51,51,51);font-weight:inherit;line-height:inherit;">回到顶部</a>
    <a name="_label0" style="color:rgb(51,51,51);font-weight:inherit;line-height:inherit;"></a> 
   </div> 
   <h4 style="font-size:14px;color:rgb(51,51,51);font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif, '宋体';">转自：<a href="http://www.wowotech.net/linux_kenrel/device_resource_management.html" rel="nofollow" style="color:rgb(51,51,51);font-weight:inherit;line-height:inherit;">http://www.wowotech.net/linux_kenrel/device_resource_management.html</a> </h4> 
   <div style="color:rgb(102,102,102);font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif, '宋体';font-size:14px;text-align:right;"> 
    <a href="http://www.cnblogs.com/sky-heaven/p/5702335.html#_labelTop" rel="nofollow" style="color:rgb(51,51,51);font-weight:inherit;line-height:inherit;">回到顶部</a>
    <a name="_label1" style="color:rgb(51,51,51);font-weight:inherit;line-height:inherit;"></a> 
   </div> 
   <h4 style="font-size:14px;color:rgb(51,51,51);font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif, '宋体';">&nbsp;</h4> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(51,51,51);font-weight:inherit;line-height:inherit;text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1</span><span style="font-family:'Courier New';line-height:1.5;">. 前言

蜗蜗建议，每一个Linux驱动工程师，都能瞄一眼本文。

之所以用“瞄”，因此它很简单，几乎不需要花费心思就能理解。之所有这建议，是因为它非常实用，可以解答一些困惑，可以使我们的代码变得简单、简洁。先看一个例子：

   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1</span>: <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> drivers/media/platform/soc_camera/mx1_camera.c, line 695 </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span>
   <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">2</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span> __init mx1_camera_probe(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> platform_device *<span style="font-family:'Courier New';line-height:1.5;">pdev)
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">3</span><span style="font-family:'Courier New';line-height:1.5;">: {
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4</span><span style="font-family:'Courier New';line-height:1.5;">:     ...
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5</span><span style="font-family:'Courier New';line-height:1.5;">:  
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">6</span>:     res = platform_get_resource(pdev, IORESOURCE_MEM, <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">);
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">7</span>:     irq = platform_get_irq(pdev, <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">);
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">8</span>:     <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (!res || (<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span>)irq &lt;= <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">) {
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">9</span>:         err = -<span style="font-family:'Courier New';line-height:1.5;">ENODEV;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">10</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">goto</span><span style="font-family:'Courier New';line-height:1.5;"> exit;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">11</span><span style="font-family:'Courier New';line-height:1.5;">:     }
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">12</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">13</span>:     clk = clk_get(&amp;pdev-&gt;dev, <span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">csi_clk</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">14</span>:     <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span><span style="font-family:'Courier New';line-height:1.5;"> (IS_ERR(clk)) {
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">15</span>:         err =<span style="font-family:'Courier New';line-height:1.5;"> PTR_ERR(clk);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">16</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">goto</span><span style="font-family:'Courier New';line-height:1.5;"> exit;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">17</span><span style="font-family:'Courier New';line-height:1.5;">:     }
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">18</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">19</span>:     pcdev = kzalloc(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">sizeof</span>(*<span style="font-family:'Courier New';line-height:1.5;">pcdev), GFP_KERNEL);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">20</span>:     <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (!<span style="font-family:'Courier New';line-height:1.5;">pcdev) {
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">21</span>:         dev_err(&amp;pdev-&gt;dev, <span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">Could not allocate pcdev\n</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">22</span>:         err = -<span style="font-family:'Courier New';line-height:1.5;">ENOMEM;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">23</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">goto</span><span style="font-family:'Courier New';line-height:1.5;"> exit_put_clk;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">24</span><span style="font-family:'Courier New';line-height:1.5;">:     }
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">25</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">26</span><span style="font-family:'Courier New';line-height:1.5;">:     ...
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">27</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">28</span>:     <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">
  29:      * Request the regions.
  30:      </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span>
  <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">31</span>:     <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (!request_mem_region(res-&gt;<span style="font-family:'Courier New';line-height:1.5;">start, resource_size(res), DRIVER_NAME)) {
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">32</span>:         err = -<span style="font-family:'Courier New';line-height:1.5;">EBUSY;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">33</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">goto</span><span style="font-family:'Courier New';line-height:1.5;"> exit_kfree;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">34</span><span style="font-family:'Courier New';line-height:1.5;">:     }
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">35</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">36</span>:     <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">base</span> = ioremap(res-&gt;<span style="font-family:'Courier New';line-height:1.5;">start, resource_size(res));
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">37</span>:     <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (!<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">base</span><span style="font-family:'Courier New';line-height:1.5;">) {
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">38</span>:         err = -<span style="font-family:'Courier New';line-height:1.5;">ENOMEM;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">39</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">goto</span><span style="font-family:'Courier New';line-height:1.5;"> exit_release;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">40</span><span style="font-family:'Courier New';line-height:1.5;">:     }
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">41</span><span style="font-family:'Courier New';line-height:1.5;">:     ...
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">42</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">43</span>:     <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> request dma </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span>
  <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">44</span>:     pcdev-&gt;dma_chan =<span style="font-family:'Courier New';line-height:1.5;"> imx_dma_request_by_prio(DRIVER_NAME, DMA_PRIO_HIGH);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">45</span>:     <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (pcdev-&gt;dma_chan &lt; <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">) {
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">46</span>:         dev_err(&amp;pdev-&gt;dev, <span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">Can't request DMA for MX1 CSI\n</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">47</span>:         err = -<span style="font-family:'Courier New';line-height:1.5;">EBUSY;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">48</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">goto</span><span style="font-family:'Courier New';line-height:1.5;"> exit_iounmap;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">49</span><span style="font-family:'Courier New';line-height:1.5;">:     }
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">50</span><span style="font-family:'Courier New';line-height:1.5;">:     ...
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">51</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">52</span>:     <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> request irq </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span>
  <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">53</span>:     err = claim_fiq(&amp;<span style="font-family:'Courier New';line-height:1.5;">fh);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">54</span>:     <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span><span style="font-family:'Courier New';line-height:1.5;"> (err) {
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">55</span>:         dev_err(&amp;pdev-&gt;dev, <span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">Camera interrupt register failed\n</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">56</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">goto</span><span style="font-family:'Courier New';line-height:1.5;"> exit_free_dma;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">57</span><span style="font-family:'Courier New';line-height:1.5;">:     }
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">58</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">59</span><span style="font-family:'Courier New';line-height:1.5;">:     ...
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">60</span>:     err = soc_camera_host_register(&amp;pcdev-&gt;<span style="font-family:'Courier New';line-height:1.5;">soc_host);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">61</span>:     <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span><span style="font-family:'Courier New';line-height:1.5;"> (err)
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">62</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">goto</span><span style="font-family:'Courier New';line-height:1.5;"> exit_free_irq;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">63</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">64</span>:     dev_info(&amp;pdev-&gt;dev, <span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">MX1 Camera driver loaded\n</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">65</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">66</span>:     <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">67</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">68</span><span style="font-family:'Courier New';line-height:1.5;">: exit_free_irq:
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">69</span><span style="font-family:'Courier New';line-height:1.5;">:     disable_fiq(irq);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">70</span>:     mxc_set_irq_fiq(irq, <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">71</span>:     release_fiq(&amp;<span style="font-family:'Courier New';line-height:1.5;">fh);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">72</span><span style="font-family:'Courier New';line-height:1.5;">: exit_free_dma:
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">73</span>:     imx_dma_free(pcdev-&gt;<span style="font-family:'Courier New';line-height:1.5;">dma_chan);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">74</span><span style="font-family:'Courier New';line-height:1.5;">: exit_iounmap:
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">75</span>:     iounmap(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">base</span><span style="font-family:'Courier New';line-height:1.5;">);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">76</span><span style="font-family:'Courier New';line-height:1.5;">: exit_release:
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">77</span>:     release_mem_region(res-&gt;<span style="font-family:'Courier New';line-height:1.5;">start, resource_size(res));
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">78</span><span style="font-family:'Courier New';line-height:1.5;">: exit_kfree:
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">79</span><span style="font-family:'Courier New';line-height:1.5;">:     kfree(pcdev);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">80</span><span style="font-family:'Courier New';line-height:1.5;">: exit_put_clk:
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">81</span><span style="font-family:'Courier New';line-height:1.5;">:     clk_put(clk);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">82</span><span style="font-family:'Courier New';line-height:1.5;">: exit:
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">83</span>:     <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span><span style="font-family:'Courier New';line-height:1.5;"> err;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">84</span><span style="font-family:'Courier New';line-height:1.5;">: }
相信每一个写过Linux driver的工程师，都在probe函数中遇到过上面的困惑：要顺序申请多种资源（IRQ、Clock、memory、regions、ioremap、dma、等等），只要任意一种资源申请失败，就要回滚释放之前申请的所有资源。于是函数的最后，一定会出现很多的goto标签（如上面的exit_free_irq、exit_free_dma、等等），并在申请资源出错时，小心翼翼的goto到正确的标签上，以便释放已申请资源。

正像上面代码一样，整个函数被大段的、重复的“</span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (condition) { err = xxx; <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">goto</span><span style="font-family:'Courier New';line-height:1.5;"> xxx; }”充斥，浪费精力，容易出错，不美观。有困惑，就有改善的余地，最终，Linux设备模型借助device resource management（设备资源管理），帮我们解决了这个问题。就是：driver你只管申请就行了，不用考虑释放，我设备模型帮你释放。最终，我们的driver可以这样写：

   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span> __init mx1_camera_probe(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> platform_device *<span style="font-family:'Courier New';line-height:1.5;">pdev)
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">2</span><span style="font-family:'Courier New';line-height:1.5;">: {
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">3</span><span style="font-family:'Courier New';line-height:1.5;">:     ...
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4</span><span style="font-family:'Courier New';line-height:1.5;">:  
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5</span>:     res = platform_get_resource(pdev, IORESOURCE_MEM, <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">);
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">6</span>:     irq = platform_get_irq(pdev, <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">);
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">7</span>:     <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (!res || (<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span>)irq &lt;= <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">) {
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">8</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span> -<span style="font-family:'Courier New';line-height:1.5;">ENODEV;
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">9</span><span style="font-family:'Courier New';line-height:1.5;">:     }
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">10</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">11</span>:     clk = devm_clk_get(&amp;pdev-&gt;dev, <span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">csi_clk</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">12</span>:     <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span><span style="font-family:'Courier New';line-height:1.5;"> (IS_ERR(clk)) {
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">13</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span><span style="font-family:'Courier New';line-height:1.5;"> PTR_ERR(clk);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">14</span><span style="font-family:'Courier New';line-height:1.5;">:     }
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">15</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">16</span>:     pcdev = devm_kzalloc(&amp;pdev-&gt;dev, <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">sizeof</span>(*<span style="font-family:'Courier New';line-height:1.5;">pcdev), GFP_KERNEL);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">17</span>:     <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (!<span style="font-family:'Courier New';line-height:1.5;">pcdev) {
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">18</span>:         dev_err(&amp;pdev-&gt;dev, <span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">Could not allocate pcdev\n</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">19</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span> -<span style="font-family:'Courier New';line-height:1.5;">ENOMEM;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">20</span><span style="font-family:'Courier New';line-height:1.5;">:     }
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">21</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">22</span><span style="font-family:'Courier New';line-height:1.5;">:     ...
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">23</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">24</span>:     <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">
  25:      * Request the regions.
  26:      </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span>
  <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">27</span>:     <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (!devm_request_mem_region(&amp;pdev-&gt;dev, res-&gt;<span style="font-family:'Courier New';line-height:1.5;">start, resource_size(res), DRIVER_NAME)) {
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">28</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span> -<span style="font-family:'Courier New';line-height:1.5;">EBUSY;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">29</span><span style="font-family:'Courier New';line-height:1.5;">:     }
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">30</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">31</span>:     <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">base</span> = devm_ioremap(&amp;pdev-&gt;dev, res-&gt;<span style="font-family:'Courier New';line-height:1.5;">start, resource_size(res));
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">32</span>:     <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (!<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">base</span><span style="font-family:'Courier New';line-height:1.5;">) {
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">33</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span> -<span style="font-family:'Courier New';line-height:1.5;">ENOMEM;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">34</span><span style="font-family:'Courier New';line-height:1.5;">:     }
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">35</span><span style="font-family:'Courier New';line-height:1.5;">:     ...
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">36</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">37</span>:     <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> request dma </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span>
  <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">38</span>:     pcdev-&gt;dma_chan =<span style="font-family:'Courier New';line-height:1.5;"> imx_dma_request_by_prio(DRIVER_NAME, DMA_PRIO_HIGH);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">39</span>:     <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (pcdev-&gt;dma_chan &lt; <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">) {
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">40</span>:         dev_err(&amp;pdev-&gt;dev, <span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">Can't request DMA for MX1 CSI\n</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">41</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span> -<span style="font-family:'Courier New';line-height:1.5;">EBUSY;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">42</span><span style="font-family:'Courier New';line-height:1.5;">:     }
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">43</span><span style="font-family:'Courier New';line-height:1.5;">:     ...
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">44</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">45</span>:     <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> request irq </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span>
  <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">46</span>:     err = claim_fiq(&amp;<span style="font-family:'Courier New';line-height:1.5;">fh);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">47</span>:     <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span><span style="font-family:'Courier New';line-height:1.5;"> (err) {
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">48</span>:         dev_err(&amp;pdev-&gt;dev, <span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">Camera interrupt register failed\n</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">49</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span><span style="font-family:'Courier New';line-height:1.5;"> err;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">50</span><span style="font-family:'Courier New';line-height:1.5;">:     }
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">51</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">52</span><span style="font-family:'Courier New';line-height:1.5;">:     ...
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">53</span>:     err = soc_camera_host_register(&amp;pcdev-&gt;<span style="font-family:'Courier New';line-height:1.5;">soc_host);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">54</span>:     <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span><span style="font-family:'Courier New';line-height:1.5;"> (err)
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">55</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span><span style="font-family:'Courier New';line-height:1.5;"> err;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">56</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">57</span>:     dev_info(&amp;pdev-&gt;dev, <span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">MX1 Camera driver loaded\n</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">58</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">59</span>:     <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">60</span><span style="font-family:'Courier New';line-height:1.5;">: }
怎么做到呢？注意上面“devm_”开头的接口，答案就在那里。不要再使用那些常规的资源申请接口，用devm_xxx的接口代替。为了保持兼容，这些新接口和旧接口的参数保持一致，只是名字前加了“devm_”，并多加一个struct device指针。

</span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">2</span><span style="font-family:'Courier New';line-height:1.5;">. devm_xxx

下面列举一些常用的资源申请接口，它们由各个framework（如clock、regulator、gpio、等等）基于device resource management实现。使用时，直接忽略“devm_”的前缀，后面剩下的部分，driver工程师都很熟悉。只需记住一点，driver可以只申请，不释放，设备模型会帮忙释放。不过如果为了严谨，在driver remove时，可以主动释放（也有相应的接口，这里没有列出）。

   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">extern</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">void</span> *devm_kzalloc(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> device *<span style="font-family:'Courier New';line-height:1.5;">dev, size_t size, gfp_t gfp);
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">2</span><span style="font-family:'Courier New';line-height:1.5;">:  
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">3</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">void</span> __iomem *devm_ioremap_resource(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> device *<span style="font-family:'Courier New';line-height:1.5;">dev, 
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4</span>:   <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> resource *<span style="font-family:'Courier New';line-height:1.5;">res);
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">void</span> __iomem *devm_ioremap(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> device *<span style="font-family:'Courier New';line-height:1.5;">dev, resource_size_t offset,
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">6</span>:   unsigned <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">long</span><span style="font-family:'Courier New';line-height:1.5;"> size);
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">7</span><span style="font-family:'Courier New';line-height:1.5;">:  
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">8</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> clk *devm_clk_get(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> device *dev, <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">const</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">char</span> *<span style="font-family:'Courier New';line-height:1.5;">id);
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">9</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">10</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span> devm_gpio_request(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> device *<span style="font-family:'Courier New';line-height:1.5;">dev, unsigned gpio,
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">11</span>:   <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">const</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">char</span> *<span style="font-family:'Courier New';line-height:1.5;">label);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">12</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">13</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">static</span> inline <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> pinctrl *<span style="font-family:'Courier New';line-height:1.5;"> devm_pinctrl_get_select(
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">14</span>:   <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> device *dev, <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">const</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">char</span> *<span style="font-family:'Courier New';line-height:1.5;">name)
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">15</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">16</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">static</span> inline <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> pwm_device *devm_pwm_get(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> device *<span style="font-family:'Courier New';line-height:1.5;">dev,
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">17</span>:   <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">const</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">char</span> *<span style="font-family:'Courier New';line-height:1.5;">consumer);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">18</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">19</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> regulator *devm_regulator_get(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> device *dev, <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">const</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">char</span> *<span style="font-family:'Courier New';line-height:1.5;">id);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">20</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">21</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">static</span> inline <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span> devm_request_irq(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> device *dev, unsigned <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span><span style="font-family:'Courier New';line-height:1.5;"> irq, 
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">22</span>:   irq_handler_t handler, unsigned <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">long</span><span style="font-family:'Courier New';line-height:1.5;"> irqflags, 
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">23</span>:   <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">const</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">char</span> *devname, <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">void</span> *<span style="font-family:'Courier New';line-height:1.5;">dev_id);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">24</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">25</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> reset_control *devm_reset_control_get(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> device *<span style="font-family:'Courier New';line-height:1.5;">dev, 
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">26</span>:   <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">const</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">char</span> *<span style="font-family:'Courier New';line-height:1.5;">id);
</span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">3</span><span style="font-family:'Courier New';line-height:1.5;">. 什么是“设备资源”

一个设备能工作，需要依赖很多的外部条件，如供电、时钟等等，这些外部条件称作设备资源（device resouce）。对于现代计算机的体系结构，可能的资源包括：

a）power，供电。 
b）clock，时钟。 
c）memory，内存，在kernel中一般使用kzalloc分配。 
d）GPIO，用户和CPU交换简单控制、状态等信息。 
e）IRQ，触发中断。 
f）DMA，无CPU参与情况下进行数据传输。 
g）虚拟地址空间，一般使用ioremap、request_region等分配。 
h）等等

而在Linux kernel的眼中，“资源”的定义更为广义，比如PWM、RTC、Reset，都可以抽象为资源，供driver使用。

在较早的kernel中，系统还不是特别复杂，且各个framework还没有成型，因此大多的资源都由driver自行维护。但随着系统复杂度的增加，driver之间共用资源的情况越来越多，同时电源管理的需求也越来越迫切。于是kernel就将各个resource的管理权收回，基于“device resource management”的框架，由各个framework统一管理，包括分配和回收。 

</span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4</span><span style="font-family:'Courier New';line-height:1.5;">. device resource management的软件框架

device resource managementdevice resource management位于“drivers</span>/<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">base</span>/<span style="font-family:'Courier New';line-height:1.5;">devres.c”中，它的实现非常简单，为什么呢？因为资源的种类有很多，表现形式也多种多样，而devres不可能一一知情，也就不能进行具体的分配和回收。因此，devres能做的（也是它的唯一功能），就是：

提供一种机制，将系统中某个设备的所有资源，以链表的形式，组织起来，以便在driver detach的时候，自动释放。

而更为具体的事情，如怎么抽象某一种设备，则由上层的framework负责。这些framework包括：regulator framework（管理power资源），clock framework（管理clock资源），interrupt framework（管理中断资源）、gpio framework（管理gpio资源），pwm framework（管理PWM），等等。

其它的driver，位于这些framework之上，使用它们提供的机制和接口，开发起来就非常方便了。

</span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5</span><span style="font-family:'Courier New';line-height:1.5;">. 代码分析

</span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5.1</span><span style="font-family:'Courier New';line-height:1.5;"> 数据结构

先从struct device开始吧！该结构中有一个名称为“devres_head”的链表头，用于保存该设备申请的所有资源，如下：

   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span><span style="font-family:'Courier New';line-height:1.5;"> device {
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">2</span><span style="font-family:'Courier New';line-height:1.5;">:         ...
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">3</span><span style="font-family:'Courier New';line-height:1.5;">:         spinlock_t              devres_lock;
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span><span style="font-family:'Courier New';line-height:1.5;"> list_head        devres_head;
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5</span><span style="font-family:'Courier New';line-height:1.5;">:         ...
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">6</span><span style="font-family:'Courier New';line-height:1.5;">: }
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">7</span><span style="font-family:'Courier New';line-height:1.5;">:  
那资源的数据结构呢？在“drivers</span>/<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">base</span>/<span style="font-family:'Courier New';line-height:1.5;">devres.c”中，名称为struct devres，如下：

   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span><span style="font-family:'Courier New';line-height:1.5;"> devres {
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">2</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span><span style="font-family:'Courier New';line-height:1.5;"> devres_node              node;
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">3</span>:         <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> -- 3 pointers </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span>
   <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4</span>:         unsigned <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">long</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">long</span>              data[]; <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> guarantee ull alignment </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span>
   <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5</span><span style="font-family:'Courier New';line-height:1.5;">: };
咋一看非常简单，一个struct devres_node的变量node，一个零长度数组data，但其中有无穷奥妙，让我们继续分析。

node用于将devres组织起来，方便插入到device结构的devres_head链表中，因此一定也有一个list_head（见下面的entry）。另外，资源的存在形式到底是什么，device resource management并不知情，因此需要上层模块提供一个release的回调函数，用于release资源，如下：

   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span><span style="font-family:'Courier New';line-height:1.5;"> devres_node {
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">2</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span><span style="font-family:'Courier New';line-height:1.5;"> list_head                entry;
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">3</span><span style="font-family:'Courier New';line-height:1.5;">:         dr_release_t                    release;
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4</span><span style="font-family:'Courier New';line-height:1.5;">: #ifdef CONFIG_DEBUG_DEVRES
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">const</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">char</span>                      *<span style="font-family:'Courier New';line-height:1.5;">name;
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">6</span><span style="font-family:'Courier New';line-height:1.5;">:         size_t                          size;
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">7</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">#endif</span>
   <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">8</span><span style="font-family:'Courier New';line-height:1.5;">: };
抛开用于debug的变量不说，也很简单，一个entry list_head，一个release回调函数。看不出怎么抽象资源啊！别急，奥妙都在data这个零长度数组上面呢。

注1：不知道您是否注意到，devres有关的数据结构，是在devres.c中定义的（是C文件哦！）。换句话说，是对其它模块透明的。这真是优雅的设计（尽量屏蔽细节）！

</span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5.2</span><span style="font-family:'Courier New';line-height:1.5;"> 一个无关话题：零长度数组

零长度数组的英文原名为Arrays of Length Zero，是GNU C的规范，主要用途是用来作为结构体的最后一个成员，然后用它来访问此结构体对象之后的一段内存（通常是动态分配的内存）。什么意思呢？

以struct devres为例，node变量的长度为3个指针的长度，而struct devres的长度也是3个指针的长度。而data只是一个标记，当有人分配了大于3个指针长度的空间并把它转换为struct devres类型的变量后，我们就可以通过data来访问多出来的memory。也就是说，有了零长度数组data，</span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span><span style="font-family:'Courier New';line-height:1.5;"> devres结构的长度可以不定，完全依赖于你分配的空间的大小。有什么用呢？

以本文的应用场景为例，多出来的、可通过data访问的空间，正是具体的device resource所占的空间。资源的类型不同，占用的空间的多少也不同，但devres模块的主要功能又是释放资源所占的资源。这是就是零长度数组的功能之一，因为整个memory空间是连续的，因此可以通过释devres指针，释放所有的空间，包括data所指的那片不定长度的、具体资源所用的空间。

零长度数组（data[</span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span>]），在不同的C版本中，有不同的实现方案，包括1长度数组（data[<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1</span><span style="font-family:'Courier New';line-height:1.5;">]）和不定长度数组（data[]，本文所描述就是这一种），具体可参考GCC的规范：

https:</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">gcc.gnu.org/onlinedocs/gcc/Zero-Length.html</span>

<span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5.3</span> 向上层framework提供的接口：devres_alloc/devres_free、devres_add/<span style="font-family:'Courier New';line-height:1.5;">devres_remove

先看一个使用device resource management的例子（IRQ模块）：

   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1</span>: <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> include/linux/interrupt.h </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span>
   <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">2</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">static</span> inline <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span><span style="font-family:'Courier New';line-height:1.5;"> __must_check
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">3</span>: devm_request_irq(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> device *dev, unsigned <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span><span style="font-family:'Courier New';line-height:1.5;"> irq, irq_handler_t handler,
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4</span>:                  unsigned <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">long</span> irqflags, <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">const</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">char</span> *devname, <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">void</span> *<span style="font-family:'Courier New';line-height:1.5;">dev_id)
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5</span><span style="font-family:'Courier New';line-height:1.5;">: {
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">6</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span><span style="font-family:'Courier New';line-height:1.5;"> devm_request_threaded_irq(dev, irq, handler, NULL, irqflags,
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">7</span><span style="font-family:'Courier New';line-height:1.5;">:                                          devname, dev_id);
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">8</span><span style="font-family:'Courier New';line-height:1.5;">: }
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">9</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">10</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">11</span>: <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> kernel/irq/devres.c </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span>
  <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">12</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span> devm_request_threaded_irq(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> device *dev, unsigned <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span><span style="font-family:'Courier New';line-height:1.5;"> irq,
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">13</span><span style="font-family:'Courier New';line-height:1.5;">:                               irq_handler_t handler, irq_handler_t thread_fn,
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">14</span>:                               unsigned <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">long</span> irqflags, <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">const</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">char</span> *<span style="font-family:'Courier New';line-height:1.5;">devname,
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">15</span>:                               <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">void</span> *<span style="font-family:'Courier New';line-height:1.5;">dev_id)
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">16</span><span style="font-family:'Courier New';line-height:1.5;">: {
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">17</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> irq_devres *<span style="font-family:'Courier New';line-height:1.5;">dr;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">18</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span><span style="font-family:'Courier New';line-height:1.5;"> rc;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">19</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">20</span>:         dr = devres_alloc(devm_irq_release, <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">sizeof</span>(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span><span style="font-family:'Courier New';line-height:1.5;"> irq_devres),
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">21</span><span style="font-family:'Courier New';line-height:1.5;">:                           GFP_KERNEL);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">22</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (!<span style="font-family:'Courier New';line-height:1.5;">dr)
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">23</span>:                 <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span> -<span style="font-family:'Courier New';line-height:1.5;">ENOMEM;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">24</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">25</span>:         rc =<span style="font-family:'Courier New';line-height:1.5;"> request_threaded_irq(irq, handler, thread_fn, irqflags, devname,
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">26</span><span style="font-family:'Courier New';line-height:1.5;">:                                   dev_id);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">27</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span><span style="font-family:'Courier New';line-height:1.5;"> (rc) {
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">28</span><span style="font-family:'Courier New';line-height:1.5;">:                 devres_free(dr);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">29</span>:                 <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span><span style="font-family:'Courier New';line-height:1.5;"> rc;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">30</span><span style="font-family:'Courier New';line-height:1.5;">:         }
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">31</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">32</span>:         dr-&gt;irq =<span style="font-family:'Courier New';line-height:1.5;"> irq;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">33</span>:         dr-&gt;dev_id =<span style="font-family:'Courier New';line-height:1.5;"> dev_id;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">34</span><span style="font-family:'Courier New';line-height:1.5;">:         devres_add(dev, dr);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">35</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">36</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">37</span><span style="font-family:'Courier New';line-height:1.5;">: }
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">38</span><span style="font-family:'Courier New';line-height:1.5;">: EXPORT_SYMBOL(devm_request_threaded_irq);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">39</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">40</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">void</span> devm_free_irq(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> device *dev, unsigned <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span> irq, <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">void</span> *<span style="font-family:'Courier New';line-height:1.5;">dev_id)
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">41</span><span style="font-family:'Courier New';line-height:1.5;">: {
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">42</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> irq_devres match_data =<span style="font-family:'Courier New';line-height:1.5;"> { irq, dev_id };
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">43</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">44</span><span style="font-family:'Courier New';line-height:1.5;">:         WARN_ON(devres_destroy(dev, devm_irq_release, devm_irq_match,
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">45</span>:                                &amp;<span style="font-family:'Courier New';line-height:1.5;">match_data));
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">46</span><span style="font-family:'Courier New';line-height:1.5;">:         free_irq(irq, dev_id);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">47</span><span style="font-family:'Courier New';line-height:1.5;">: }
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">48</span><span style="font-family:'Courier New';line-height:1.5;">: EXPORT_SYMBOL(devm_free_irq);
前面我们提过，上层的IRQ framework，会提供两个和request_irq</span>/<span style="font-family:'Courier New';line-height:1.5;">free_irq基本兼容的接口，这两个接口的实现非常简单，就是在原有的实现之上，封装一层devres的操作，如要包括：

</span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1</span>）一个自定义的数据结构（<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span><span style="font-family:'Courier New';line-height:1.5;"> irq_devres），用于保存和resource有关的信息（对中断来说，就是IRQ num），如下：

   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1</span>: <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">
   2:  * Device resource management aware IRQ request/free implementation.
   3:  </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span>
   <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span><span style="font-family:'Courier New';line-height:1.5;"> irq_devres {
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5</span>:         unsigned <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span><span style="font-family:'Courier New';line-height:1.5;"> irq;
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">6</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">void</span> *<span style="font-family:'Courier New';line-height:1.5;">dev_id;
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">7</span><span style="font-family:'Courier New';line-height:1.5;">: };
</span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">2</span><span style="font-family:'Courier New';line-height:1.5;">）一个用于release resource的回调函数（这里的release，和memory无关，例如free IRQ），如下：

   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">void</span> devm_irq_release(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> device *dev, <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">void</span> *<span style="font-family:'Courier New';line-height:1.5;">res)
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">2</span><span style="font-family:'Courier New';line-height:1.5;">: {
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">3</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> irq_devres *<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">this</span> =<span style="font-family:'Courier New';line-height:1.5;"> res;
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4</span><span style="font-family:'Courier New';line-height:1.5;">:  
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5</span>:         free_irq(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">this</span>-&gt;irq, <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">this</span>-&gt;<span style="font-family:'Courier New';line-height:1.5;">dev_id);
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">6</span><span style="font-family:'Courier New';line-height:1.5;">: }
因为回调函数是由devres模块调用的，由它的参数可知，</span><span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span><span style="font-family:'Courier New';line-height:1.5;"> irq_devres变量就是实际的“资源”，但对devres而言，它并不知道该资源的实际形态，因而是void类型指针。也只有这样，devres模块才可以统一的处理所有类型的资源。

</span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">3</span><span style="font-family:'Courier New';line-height:1.5;">）以回调函数、resource的size为参数，调用devres_alloc接口，为resource分配空间。该接口的定义如下：

   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">void</span> *<span style="font-family:'Courier New';line-height:1.5;"> devres_alloc(dr_release_t release, size_t size, gfp_t gfp)
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">2</span><span style="font-family:'Courier New';line-height:1.5;">: {
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">3</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> devres *<span style="font-family:'Courier New';line-height:1.5;">dr;
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4</span><span style="font-family:'Courier New';line-height:1.5;">:  
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5</span>:         dr =<span style="font-family:'Courier New';line-height:1.5;"> alloc_dr(release, size, gfp);
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">6</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (unlikely(!<span style="font-family:'Courier New';line-height:1.5;">dr))
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">7</span>:                 <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span><span style="font-family:'Courier New';line-height:1.5;"> NULL;
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">8</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span> dr-&gt;<span style="font-family:'Courier New';line-height:1.5;">data;
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">9</span><span style="font-family:'Courier New';line-height:1.5;">: }
调用alloc_dr，分配一个struct devres类型的变量，并返回其中的data指针（</span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5</span><span style="font-family:'Courier New';line-height:1.5;">.2小节讲过了，data变量实际上是资源的代表）。alloc_dr的定义如下：

   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">static</span> __always_inline <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> devres *<span style="font-family:'Courier New';line-height:1.5;"> alloc_dr(dr_release_t release,
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">2</span><span style="font-family:'Courier New';line-height:1.5;">:                                                 size_t size, gfp_t gfp)
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">3</span><span style="font-family:'Courier New';line-height:1.5;">: {
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4</span>:         size_t tot_size = <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">sizeof</span>(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> devres) +<span style="font-family:'Courier New';line-height:1.5;"> size;
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> devres *<span style="font-family:'Courier New';line-height:1.5;">dr;
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">6</span><span style="font-family:'Courier New';line-height:1.5;">:  
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">7</span>:         dr =<span style="font-family:'Courier New';line-height:1.5;"> kmalloc_track_caller(tot_size, gfp);
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">8</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (unlikely(!<span style="font-family:'Courier New';line-height:1.5;">dr))
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">9</span>:                 <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span><span style="font-family:'Courier New';line-height:1.5;"> NULL;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">10</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">11</span>:         memset(dr, <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">0</span><span style="font-family:'Courier New';line-height:1.5;">, tot_size);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">12</span>:         INIT_LIST_HEAD(&amp;dr-&gt;<span style="font-family:'Courier New';line-height:1.5;">node.entry);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">13</span>:         dr-&gt;node.release =<span style="font-family:'Courier New';line-height:1.5;"> release;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">14</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span><span style="font-family:'Courier New';line-height:1.5;"> dr;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">15</span><span style="font-family:'Courier New';line-height:1.5;">: }
看第一句就可以了，在资源size之前，加一个struct devres的size，就是total分配的空间。除去struct devres的，就是资源的（由data指针访问）。之后是初始化struct devres变量的node。

</span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4</span><span style="font-family:'Courier New';line-height:1.5;">）调用原来的中断注册接口（这里是request_threaded_irq），注册中断。该步骤和device resource management无关。

</span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5</span><span style="font-family:'Courier New';line-height:1.5;">）注册成功后，以设备指针（dev）和资源指针（dr）为参数，调用devres_add，将资源添加到设备的资源链表头（devres_head）中，该接口定义如下：

   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">void</span> devres_add(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> device *dev, <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">void</span> *<span style="font-family:'Courier New';line-height:1.5;">res)
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">2</span><span style="font-family:'Courier New';line-height:1.5;">: {
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">3</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> devres *dr = container_of(res, <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span><span style="font-family:'Courier New';line-height:1.5;"> devres, data);
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4</span>:         unsigned <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">long</span><span style="font-family:'Courier New';line-height:1.5;"> flags;
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5</span><span style="font-family:'Courier New';line-height:1.5;">:  
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">6</span>:         spin_lock_irqsave(&amp;dev-&gt;<span style="font-family:'Courier New';line-height:1.5;">devres_lock, flags);
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">7</span>:         add_dr(dev, &amp;dr-&gt;<span style="font-family:'Courier New';line-height:1.5;">node);
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">8</span>:         spin_unlock_irqrestore(&amp;dev-&gt;<span style="font-family:'Courier New';line-height:1.5;">devres_lock, flags);
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">9</span><span style="font-family:'Courier New';line-height:1.5;">: }
从资源指针中，取出完整的struct devres指针，调用add_dr接口。add_dr也很简单，把struct devres指针挂到设备的devres_head中即可：

   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">void</span> add_dr(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> device *dev, <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> devres_node *<span style="font-family:'Courier New';line-height:1.5;">node)
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">2</span><span style="font-family:'Courier New';line-height:1.5;">: {
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">3</span>:         devres_log(dev, node, <span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">ADD</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">);
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4</span>:         BUG_ON(!list_empty(&amp;node-&gt;<span style="font-family:'Courier New';line-height:1.5;">entry));
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5</span>:         list_add_tail(&amp;node-&gt;entry, &amp;dev-&gt;<span style="font-family:'Courier New';line-height:1.5;">devres_head);
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">6</span><span style="font-family:'Courier New';line-height:1.5;">: }
</span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">6</span><span style="font-family:'Courier New';line-height:1.5;">）如果失败，可以通过devres_free接口释放资源占用的空间，devm_free_irq接口中，会调用devres_destroy接口，将devres从devres_head中移除，并释放资源。这里就不详细描述了。

</span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5.4</span><span style="font-family:'Courier New';line-height:1.5;"> 向设备模型提供的接口：devres_release_all

这里是重点，用于自动释放资源。

先回忆一下设备模型中probe的流程（可参考“Linux设备模型(</span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5</span><span style="font-family:'Courier New';line-height:1.5;">)_device和device driver”），devres_release_all接口被调用的时机有两个：

</span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1</span><span style="font-family:'Courier New';line-height:1.5;">）probe失败时，调用过程为（就不详细的贴代码了）：

__driver_attach</span>/__device_attach--&gt;driver_probe_device—&gt;<span style="font-family:'Courier New';line-height:1.5;">really_probe，really_probe调用driver或者bus的probe接口，如果失败（返回值非零，可参考本文开头的例子），则会调用devres_release_all。

</span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">2</span><span style="font-family:'Courier New';line-height:1.5;">）deriver dettach时（就是driver remove时）

driver_detach</span>/bus_remove_device--&gt;__device_release_driver--&gt;<span style="font-family:'Courier New';line-height:1.5;">devres_release_all

devres_release_all的实现如下：

   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span> devres_release_all(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> device *<span style="font-family:'Courier New';line-height:1.5;">dev)
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">2</span><span style="font-family:'Courier New';line-height:1.5;">: {
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">3</span>:         unsigned <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">long</span><span style="font-family:'Courier New';line-height:1.5;"> flags;
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4</span><span style="font-family:'Courier New';line-height:1.5;">:  
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5</span>:         <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> Looks like an uninitialized device structure </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span>
   <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">6</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">if</span> (WARN_ON(dev-&gt;devres_head.next ==<span style="font-family:'Courier New';line-height:1.5;"> NULL))
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">7</span>:                 <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span> -<span style="font-family:'Courier New';line-height:1.5;">ENODEV;
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">8</span>:         spin_lock_irqsave(&amp;dev-&gt;<span style="font-family:'Courier New';line-height:1.5;">devres_lock, flags);
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">9</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span> release_nodes(dev, dev-&gt;devres_head.next, &amp;dev-&gt;<span style="font-family:'Courier New';line-height:1.5;">devres_head,
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">10</span><span style="font-family:'Courier New';line-height:1.5;">:                              flags);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">11</span><span style="font-family:'Courier New';line-height:1.5;">: }
以设备指针为参数，直接调用release_nodes：

   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">1</span>: <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span> release_nodes(<span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> device *dev, <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> list_head *<span style="font-family:'Courier New';line-height:1.5;">first,
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">2</span>:                          <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> list_head *end, unsigned <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">long</span><span style="font-family:'Courier New';line-height:1.5;"> flags)
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">3</span>:         __releases(&amp;dev-&gt;<span style="font-family:'Courier New';line-height:1.5;">devres_lock)
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">4</span><span style="font-family:'Courier New';line-height:1.5;">: {
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">5</span><span style="font-family:'Courier New';line-height:1.5;">:         LIST_HEAD(todo);
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">6</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">int</span><span style="font-family:'Courier New';line-height:1.5;"> cnt;
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">7</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">struct</span> devres *dr, *<span style="font-family:'Courier New';line-height:1.5;">tmp;
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">8</span><span style="font-family:'Courier New';line-height:1.5;">:  
   </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">9</span>:         cnt = remove_nodes(dev, first, end, &amp;<span style="font-family:'Courier New';line-height:1.5;">todo);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">10</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">11</span>:         spin_unlock_irqrestore(&amp;dev-&gt;<span style="font-family:'Courier New';line-height:1.5;">devres_lock, flags);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">12</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">13</span>:         <span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;"> Release.  Note that both devres and devres_group are
  14:          * handled as devres in the following loop.  This is safe.
  15:          </span><span style="color:rgb(0,128,0);font-family:'Courier New';line-height:1.5;">*/</span>
  <span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">16</span>:         list_for_each_entry_safe_reverse(dr, tmp, &amp;<span style="font-family:'Courier New';line-height:1.5;">todo, node.entry) {
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">17</span>:                 devres_log(dev, &amp;dr-&gt;node, <span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">REL</span><span style="color:rgb(128,0,0);font-family:'Courier New';line-height:1.5;">"</span><span style="font-family:'Courier New';line-height:1.5;">);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">18</span>:                 dr-&gt;node.release(dev, dr-&gt;<span style="font-family:'Courier New';line-height:1.5;">data);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">19</span><span style="font-family:'Courier New';line-height:1.5;">:                 kfree(dr);
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">20</span><span style="font-family:'Courier New';line-height:1.5;">:         }
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">21</span><span style="font-family:'Courier New';line-height:1.5;">:  
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">22</span>:         <span style="color:rgb(0,0,255);font-family:'Courier New';line-height:1.5;">return</span><span style="font-family:'Courier New';line-height:1.5;"> cnt;
  </span><span style="color:rgb(128,0,128);font-family:'Courier New';line-height:1.5;">23</span><span style="font-family:'Courier New';line-height:1.5;">: }
release_nodes会先调用remove_nodes，将设备所有的struct devres指针从设备的devres_head中移除。然后，调用所有资源的release回调函数（如5.3小节描述的devm_irq_release），回调函数会回收具体的资源（如free_irq)。最后，调用free，释放devres以及资源所占的空间。

 

原创文章，转发请注明出处。蜗窝科技，www.wowotech.net。</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(51,51,51);font-weight:inherit;line-height:inherit;text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(102,102,102);font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif, '宋体';font-size:14px;">&nbsp;</p> 
   <p style="color:rgb(102,102,102);font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif, '宋体';font-size:14px;"><br></p> 
   <p style="color:rgb(102,102,102);font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif, '宋体';font-size:14px;"><br></p> 
   <p style="color:rgb(102,102,102);font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif, '宋体';font-size:14px;"><br></p> 
   <p style="color:rgb(102,102,102);font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif, '宋体';font-size:14px;"><br></p> 
   <p style="color:rgb(102,102,102);font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif, '宋体';font-size:14px;"><br></p> 
   <p style="color:rgb(102,102,102);font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif, '宋体';font-size:14px;"><br></p> 
   <p style="color:rgb(102,102,102);font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif, '宋体';font-size:14px;"><br></p> 
   <p><font color="#666666"><span style="font-size:14px;"><br></span></font></p> 
   <p><font color="#666666"><span style="font-size:14px;">本文转自张昺华-sky博客园博客，原文链接：http://www.cnblogs.com/sky-heaven/p/5702335.html</span></font><span style="font-size:14px;color:rgb(102,102,102);font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif, '宋体';">，如需转载请自行联系原作者</span></p> 
   <div>
    <br>
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
