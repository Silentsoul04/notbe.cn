<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Web APi之认证（Authentication）两种实现方式后续【三】（十五） « NotBeCN</title>
  <meta name="description" content="             前言    之前一直在找工作中，过程也是令人着实的心塞，最后还是稳定了下来，博客也停止更新快一个月了，学如逆水行舟，不进则退，之前学的东西没怎么用，也忘记了一点，不过至少由于是切身研究，本质以及原理上的脉络还是知其所以然，所以也无关紧要，停止学习以及分享是一件很痛苦的事情，心情很忐忑也很...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/14/weixin_34092370_90134117.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">Web APi之认证（Authentication）两种实现方式后续【三】（十五）</h1>
    <p class="post-meta">Nov 14, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <h1 style="font-size:28px;line-height:1.5;font-family:'Helvetica Neue', Arial;">前言</h1> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">之前一直在找工作中，过程也是令人着实的心塞，最后还是稳定了下来，博客也停止更新快一个月了，学如逆水行舟，不进则退，之前学的东西没怎么用，也忘记了一点，不过至少由于是切身研究，本质以及原理上的脉络还是知其所以然，所以也无关紧要，停止学习以及分享是一件很痛苦的事情，心情很忐忑也很担忧，那么多牛逼的人都在无时无刻的学习更何况是略懂皮毛的我呢？好了，废话说了不少，我们接下来进入主题。</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">话题</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">看到博客也有对于我最近有关Web APi中认证这篇文章的评论和疑问，【其中就有一个是何时清除用户的信息呢】，我当时也就仅仅想想的是认证，所以对于这个问题也不知如何解答，后来还是想了想在这个地方还是略有不足，认证成功之后其信息会一直存在，我们怎样去灵活的控制呢？关于用户的信息的清除或者将问题抽离出来可以这样说：【在Web APi中如何维护Session呢？】于是乎，就诞生了这篇文章的出现。这篇文章应该值得一看，将用我浅薄的理解加上一些其他的知识，而不是仅仅停留在认证以及授权这块上。</p> 
   <blockquote style="border:2px solid rgb(239,239,239);color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;background-image:none;"> 
    <p><span style="color:rgb(255,0,0);"><strong style="font-size:16px;line-height:normal;"><span>【温馨提示】：此文你将学习到UnitOfWork、MEF、IOC之Unity、Log4Net、WebApiTestOnHelpPage、基于WebAPi认证后续。。。。。。</span></strong></span></p> 
   </blockquote> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">如何维护Session呢？</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">我们知道RESETful是基于Http无状态的协议，我们在Web APi中实现维护Session可以用基于我写过的授权的票据，一个用户当已经被认证后可以在某一个阶段时间内访问服务器上的资源，当再次发出请求时可以通过增加Session的时间来访问相同的资源或者说其他的资源，在Web应用中如果我们使用Web APi作为服务对于用户的登陆和退出时，我们需要实现【基于认证和授权的基础验证或者摘要认证】 。至于这二者验证前面文章也已经介绍，更多详细内容请参考前面内容，不再叙述。下面我们慢慢来搭建整个应用程序架构。</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">实体层（ApplicationEntity）</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">既然是维持Session，那么必然是涉及到两个实体类了，即用户实体类&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">UserEntity</span>&nbsp;和票据类&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">TokenEntity</span>&nbsp;。</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">UserEntity</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> UserEntity
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">int</span> UserId { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">string</span> UserName { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">string</span> UserPassword { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> ICollection&lt;TokenEntity&gt; Tokens { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">TokenEntity</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> TokenEntity
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">int</span> TokenId { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }   
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">string</span> AuthToken { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> System.DateTime IssuedOn { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> System.DateTime ExpiresOn { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">int</span> UserId { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> UserEntity User { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">&nbsp;实体模型层（UnitOfWork 即ApplicationDataModel）</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">在之前系列介绍过关于在WebAPi中利用EF中的仓储模式来实现其增、删等，并未涉及到这一块知识，关于UnitOfWork（工作单元）应该是属于领域驱动设计中的一种解决方案，对于领域驱动设计的详细介绍以及学习我也是只是处于了解的层次，只是看了工作单元这一部分，有关领域驱动设计可以参考园友（<a href="http://www.cnblogs.com/daxnet/category/252402.html" rel="nofollow" style="text-decoration:none;color:rgb(45,161,45);">dax.net</a>）的文章，至于关于对于UnitOfWork的最佳实践以及几种实现方式，请参考园友（<a href="http://www.cnblogs.com/xishuai/p/ddd-repository-iunitofwork-and-idbcontext-part-2.html" rel="nofollow" style="text-decoration:none;color:rgb(45,161,45);">田园里的蟋蟀</a>）的文章，对于一些基础知识就不再废话，接下来我们继续往下走。在讨论这个之前我们需要首先得看以下实现。关于以下有些内容可能之前系列文章中已经介绍，请耐心点，至于为什么还是贴上代码，是为了更好的让大家理解整个业务逻辑（已经介绍过的也已经折叠），当然你觉得你知道了，那就跳过向下看，能够吸收到知识是我的荣幸，觉得是废话一篇，就当我是对自己的一次学习。</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">（第一步）IDbContext</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">在这个接口中，我们封装了通过EF上下文来进行对数据操作常用的几个方法，具体实现如下：</p> 
   <div class="cnblogs_Highlighter sh-gutter" style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"> 
    <div> 
     <div class="syntaxhighlighter csharp" style="font-size:1em;"> 
      <table border="0" style="border:1px solid #C0C0C0;border-collapse:collapse;line-height:1.1em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-size:12px;background:none;">
       <tbody style="border:0px;line-height:1.1em;vertical-align:baseline;background:none;">
        <tr style="border:0px;line-height:1.1em;vertical-align:baseline;background:none;">
         <td class="gutter" style="border:1px solid #C0C0C0;border-collapse:collapse;line-height:1.1em;vertical-align:baseline;width:35px;color:rgb(175,175,175);background:none;"> 
          <div class="line number1 index0 alt2" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background:rgb(244,244,244) none;">
           1
          </div> 
          <div class="line number2 index1 alt1" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background-image:none;">
           2
          </div> 
          <div class="line number3 index2 alt2" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background:rgb(244,244,244) none;">
           3
          </div> 
          <div class="line number4 index3 alt1" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background-image:none;">
           4
          </div> 
          <div class="line number5 index4 alt2" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background:rgb(244,244,244) none;">
           5
          </div> 
          <div class="line number6 index5 alt1" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background-image:none;">
           6
          </div> 
          <div class="line number7 index6 alt2" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background:rgb(244,244,244) none;">
           7
          </div> 
          <div class="line number8 index7 alt1" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background-image:none;">
           8
          </div> 
          <div class="line number9 index8 alt2" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background:rgb(244,244,244) none;">
           9
          </div> 
          <div class="line number10 index9 alt1" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background-image:none;">
           10
          </div> 
          <div class="line number11 index10 alt2" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background:rgb(244,244,244) none;">
           11
          </div> 
          <div class="line number12 index11 alt1" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background-image:none;">
           12
          </div> 
          <div class="line number13 index12 alt2" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background:rgb(244,244,244) none;">
           13
          </div> 
          <div class="line number14 index13 alt1" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background-image:none;">
           14
          </div> 
          <div class="line number15 index14 alt2" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background:rgb(244,244,244) none;">
           15
          </div> 
          <div class="line number16 index15 alt1" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background-image:none;">
           16
          </div> 
          <div class="line number17 index16 alt2" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background:rgb(244,244,244) none;">
           17
          </div> 
          <div class="line number18 index17 alt1" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background-image:none;">
           18
          </div> 
          <div class="line number19 index18 alt2" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background:rgb(244,244,244) none;">
           19
          </div> 
          <div class="line number20 index19 alt1" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background-image:none;">
           20
          </div> 
          <div class="line number21 index20 alt2" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background:rgb(244,244,244) none;">
           21
          </div> 
          <div class="line number22 index21 alt1" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background-image:none;">
           22
          </div> 
          <div class="line number23 index22 alt2" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background:rgb(244,244,244) none;">
           23
          </div> 
          <div class="line number24 index23 alt1" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background-image:none;">
           24
          </div> 
          <div class="line number25 index24 alt2" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background:rgb(244,244,244) none;">
           25
          </div> 
          <div class="line number26 index25 alt1" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background-image:none;">
           26
          </div> 
          <div class="line number27 index26 alt2" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background:rgb(244,244,244) none;">
           27
          </div> 
          <div class="line number28 index27 alt1" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background-image:none;">
           28
          </div> 
          <div class="line number29 index28 alt2" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background:rgb(244,244,244) none;">
           29
          </div> 
          <div class="line number30 index29 alt1" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background-image:none;">
           30
          </div> 
          <div class="line number31 index30 alt2" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background:rgb(244,244,244) none;">
           31
          </div> 
          <div class="line number32 index31 alt1" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background-image:none;">
           32
          </div> 
          <div class="line number33 index32 alt2" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background:rgb(244,244,244) none;">
           33
          </div> 
          <div class="line number34 index33 alt1" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background-image:none;">
           34
          </div> 
          <div class="line number35 index34 alt2" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background:rgb(244,244,244) none;">
           35
          </div> 
          <div class="line number36 index35 alt1" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background-image:none;">
           36
          </div> 
          <div class="line number37 index36 alt2" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background:rgb(244,244,244) none;">
           37
          </div> 
          <div class="line number38 index37 alt1" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background-image:none;">
           38
          </div> 
          <div class="line number39 index38 alt2" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background:rgb(244,244,244) none;">
           39
          </div> 
          <div class="line number40 index39 alt1" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background-image:none;">
           40
          </div> 
          <div class="line number41 index40 alt2" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background:rgb(244,244,244) none;">
           41
          </div> 
          <div class="line number42 index41 alt1" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background-image:none;">
           42
          </div> 
          <div class="line number43 index42 alt2" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background:rgb(244,244,244) none;">
           43
          </div> 
          <div class="line number44 index43 alt1" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background-image:none;">
           44
          </div> 
          <div class="line number45 index44 alt2" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background:rgb(244,244,244) none;">
           45
          </div> 
          <div class="line number46 index45 alt1" style="border-width:0px 2px 0px 0px;border-right-style:solid;border-right-color:rgb(108,226,108);line-height:1.8em;text-align:right;vertical-align:baseline;background-image:none;">
           46
          </div> </td> 
         <td class="code" style="border:1px solid #C0C0C0;border-collapse:collapse;line-height:1.1em;vertical-align:baseline;background:none;"> 
          <div style="border:0px;line-height:1.1em;vertical-align:baseline;background:none;"> 
           <div class="line number1 index0 alt2" style="border:0px;line-height:1.8em;vertical-align:baseline;background:rgb(244,244,244) none;"> 
            <code class="csharp keyword" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,255);background:none;">public</code>&nbsp;
            <code class="csharp keyword" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,255);background:none;">interface</code>&nbsp;
            <code class="csharp plain" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,0);background:none;">IDbContext</code> 
           </div> 
           <div class="line number2 index1 alt1" style="border:0px;line-height:1.8em;vertical-align:baseline;background-image:none;">
            <code class="csharp plain" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,0);background:none;">{</code>
           </div> 
           <div class="line number3 index2 alt2" style="border:0px;line-height:1.8em;vertical-align:baseline;background:rgb(244,244,244) none;">
            &nbsp;
           </div> 
           <div class="line number4 index3 alt1" style="border:0px;line-height:1.8em;vertical-align:baseline;background-image:none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// &lt;summary&gt;</code> 
           </div> 
           <div class="line number5 index4 alt2" style="border:0px;line-height:1.8em;vertical-align:baseline;background:rgb(244,244,244) none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// 获得实体集合</code> 
           </div> 
           <div class="line number6 index5 alt1" style="border:0px;line-height:1.8em;vertical-align:baseline;background-image:none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// &lt;/summary&gt;</code> 
           </div> 
           <div class="line number7 index6 alt2" style="border:0px;line-height:1.8em;vertical-align:baseline;background:rgb(244,244,244) none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// &lt;typeparam name="TEntity"&gt;&lt;/typeparam&gt;</code> 
           </div> 
           <div class="line number8 index7 alt1" style="border:0px;line-height:1.8em;vertical-align:baseline;background-image:none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// &lt;returns&gt;&lt;/returns&gt;</code> 
           </div> 
           <div class="line number9 index8 alt2" style="border:0px;line-height:1.8em;vertical-align:baseline;background:rgb(244,244,244) none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp plain" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,0);background:none;">DbSet&lt;TEntity&gt; Set&lt;TEntity&gt;()&nbsp;</code>
            <code class="csharp keyword" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,255);background:none;">where</code>&nbsp;
            <code class="csharp plain" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,0);background:none;">TEntity :&nbsp;</code>
            <code class="csharp keyword" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,255);background:none;">class</code>
            <code class="csharp plain" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,0);background:none;">;</code> 
           </div> 
           <div class="line number10 index9 alt1" style="border:0px;line-height:1.8em;vertical-align:baseline;background-image:none;">
            &nbsp;
           </div> 
           <div class="line number11 index10 alt2" style="border:0px;line-height:1.8em;vertical-align:baseline;background:rgb(244,244,244) none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// &lt;summary&gt;</code> 
           </div> 
           <div class="line number12 index11 alt1" style="border:0px;line-height:1.8em;vertical-align:baseline;background-image:none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// 执行存储过程</code> 
           </div> 
           <div class="line number13 index12 alt2" style="border:0px;line-height:1.8em;vertical-align:baseline;background:rgb(244,244,244) none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// &lt;/summary&gt;</code> 
           </div> 
           <div class="line number14 index13 alt1" style="border:0px;line-height:1.8em;vertical-align:baseline;background-image:none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// &lt;typeparam name="TEntity"&gt;&lt;/typeparam&gt;</code> 
           </div> 
           <div class="line number15 index14 alt2" style="border:0px;line-height:1.8em;vertical-align:baseline;background:rgb(244,244,244) none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// &lt;param name="commandText"&gt;&lt;/param&gt;</code> 
           </div> 
           <div class="line number16 index15 alt1" style="border:0px;line-height:1.8em;vertical-align:baseline;background-image:none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// &lt;param name="parameters"&gt;&lt;/param&gt;</code> 
           </div> 
           <div class="line number17 index16 alt2" style="border:0px;line-height:1.8em;vertical-align:baseline;background:rgb(244,244,244) none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// &lt;returns&gt;&lt;/returns&gt;</code> 
           </div> 
           <div class="line number18 index17 alt1" style="border:0px;line-height:1.8em;vertical-align:baseline;background-image:none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp plain" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,0);background:none;">IList&lt;TEntity&gt; ExecuteStoredProcedureList&lt;TEntity&gt;(</code>
            <code class="csharp keyword" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,255);background:none;">string</code>&nbsp;
            <code class="csharp plain" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,0);background:none;">commandText,&nbsp;</code>
            <code class="csharp keyword" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,255);background:none;">params</code>&nbsp;
            <code class="csharp keyword" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,255);background:none;">object</code>
            <code class="csharp plain" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,0);background:none;">[] parameters)</code> 
           </div> 
           <div class="line number19 index18 alt2" style="border:0px;line-height:1.8em;vertical-align:baseline;background:rgb(244,244,244) none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp keyword" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,255);background:none;">where</code>&nbsp;
            <code class="csharp plain" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,0);background:none;">TEntity :&nbsp;</code>
            <code class="csharp keyword" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,255);background:none;">class</code>
            <code class="csharp plain" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,0);background:none;">;</code> 
           </div> 
           <div class="line number20 index19 alt1" style="border:0px;line-height:1.8em;vertical-align:baseline;background-image:none;">
            &nbsp;
           </div> 
           <div class="line number21 index20 alt2" style="border:0px;line-height:1.8em;vertical-align:baseline;background:rgb(244,244,244) none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// &lt;summary&gt;</code> 
           </div> 
           <div class="line number22 index21 alt1" style="border:0px;line-height:1.8em;vertical-align:baseline;background-image:none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// 执行SQL语句查询</code> 
           </div> 
           <div class="line number23 index22 alt2" style="border:0px;line-height:1.8em;vertical-align:baseline;background:rgb(244,244,244) none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// &lt;/summary&gt;</code> 
           </div> 
           <div class="line number24 index23 alt1" style="border:0px;line-height:1.8em;vertical-align:baseline;background-image:none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// &lt;typeparam name="TElement"&gt;&lt;/typeparam&gt;</code> 
           </div> 
           <div class="line number25 index24 alt2" style="border:0px;line-height:1.8em;vertical-align:baseline;background:rgb(244,244,244) none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// &lt;param name="sql"&gt;&lt;/param&gt;</code> 
           </div> 
           <div class="line number26 index25 alt1" style="border:0px;line-height:1.8em;vertical-align:baseline;background-image:none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// &lt;param name="parameters"&gt;&lt;/param&gt;</code> 
           </div> 
           <div class="line number27 index26 alt2" style="border:0px;line-height:1.8em;vertical-align:baseline;background:rgb(244,244,244) none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// &lt;returns&gt;&lt;/returns&gt;</code> 
           </div> 
           <div class="line number28 index27 alt1" style="border:0px;line-height:1.8em;vertical-align:baseline;background-image:none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp plain" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,0);background:none;">IEnumerable&lt;TElement&gt; SqlQuery&lt;TElement&gt;(</code>
            <code class="csharp keyword" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,255);background:none;">string</code>&nbsp;
            <code class="csharp plain" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,0);background:none;">sql,&nbsp;</code>
            <code class="csharp keyword" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,255);background:none;">params</code>&nbsp;
            <code class="csharp keyword" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,255);background:none;">object</code>
            <code class="csharp plain" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,0);background:none;">[] parameters);</code> 
           </div> 
           <div class="line number29 index28 alt2" style="border:0px;line-height:1.8em;vertical-align:baseline;background:rgb(244,244,244) none;">
            &nbsp;
           </div> 
           <div class="line number30 index29 alt1" style="border:0px;line-height:1.8em;vertical-align:baseline;background-image:none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp plain" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,0);background:none;">DbEntityEntry Entry&lt;TEntity&gt;(TEntity entity)&nbsp;</code>
            <code class="csharp keyword" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,255);background:none;">where</code>&nbsp;
            <code class="csharp plain" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,0);background:none;">TEntity :&nbsp;</code>
            <code class="csharp keyword" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,255);background:none;">class</code>
            <code class="csharp plain" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,0);background:none;">;</code> 
           </div> 
           <div class="line number31 index30 alt2" style="border:0px;line-height:1.8em;vertical-align:baseline;background:rgb(244,244,244) none;">
            &nbsp;
           </div> 
           <div class="line number32 index31 alt1" style="border:0px;line-height:1.8em;vertical-align:baseline;background-image:none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// &lt;summary&gt;</code> 
           </div> 
           <div class="line number33 index32 alt2" style="border:0px;line-height:1.8em;vertical-align:baseline;background:rgb(244,244,244) none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// 变更追踪代码</code> 
           </div> 
           <div class="line number34 index33 alt1" style="border:0px;line-height:1.8em;vertical-align:baseline;background-image:none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// &lt;/summary&gt;</code> 
           </div> 
           <div class="line number35 index34 alt2" style="border:0px;line-height:1.8em;vertical-align:baseline;background:rgb(244,244,244) none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp keyword" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,255);background:none;">bool</code>&nbsp;
            <code class="csharp plain" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,0);background:none;">ProxyCreationEnabled {&nbsp;</code>
            <code class="csharp keyword" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,255);background:none;">get</code>
            <code class="csharp plain" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,0);background:none;">;&nbsp;</code>
            <code class="csharp keyword" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,255);background:none;">set</code>
            <code class="csharp plain" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,0);background:none;">; }</code> 
           </div> 
           <div class="line number36 index35 alt1" style="border:0px;line-height:1.8em;vertical-align:baseline;background-image:none;">
            &nbsp;
           </div> 
           <div class="line number37 index36 alt2" style="border:0px;line-height:1.8em;vertical-align:baseline;background:rgb(244,244,244) none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// &lt;summary&gt;</code> 
           </div> 
           <div class="line number38 index37 alt1" style="border:0px;line-height:1.8em;vertical-align:baseline;background-image:none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// DetectChanges方法自动调用</code> 
           </div> 
           <div class="line number39 index38 alt2" style="border:0px;line-height:1.8em;vertical-align:baseline;background:rgb(244,244,244) none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// &lt;/summary&gt;</code> 
           </div> 
           <div class="line number40 index39 alt1" style="border:0px;line-height:1.8em;vertical-align:baseline;background-image:none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp keyword" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,255);background:none;">bool</code>&nbsp;
            <code class="csharp plain" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,0);background:none;">AutoDetectChangesEnabled {&nbsp;</code>
            <code class="csharp keyword" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,255);background:none;">get</code>
            <code class="csharp plain" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,0);background:none;">;&nbsp;</code>
            <code class="csharp keyword" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,255);background:none;">set</code>
            <code class="csharp plain" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,0);background:none;">; }</code> 
           </div> 
           <div class="line number41 index40 alt2" style="border:0px;line-height:1.8em;vertical-align:baseline;background:rgb(244,244,244) none;">
            &nbsp;
           </div> 
           <div class="line number42 index41 alt1" style="border:0px;line-height:1.8em;vertical-align:baseline;background-image:none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// &lt;summary&gt;</code> 
           </div> 
           <div class="line number43 index42 alt2" style="border:0px;line-height:1.8em;vertical-align:baseline;background:rgb(244,244,244) none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// 调用Dispose方法</code> 
           </div> 
           <div class="line number44 index43 alt1" style="border:0px;line-height:1.8em;vertical-align:baseline;background-image:none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp color1" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:#808080;background:none;">/// &lt;/summary&gt;</code> 
           </div> 
           <div class="line number45 index44 alt2" style="border:0px;line-height:1.8em;vertical-align:baseline;background:rgb(244,244,244) none;"> 
            <code class="csharp spaces" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp keyword" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,255);background:none;">void</code>&nbsp;
            <code class="csharp plain" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,0);background:none;">Dispose();</code> 
           </div> 
           <div class="line number46 index45 alt1" style="border:0px;line-height:1.8em;vertical-align:baseline;background-image:none;">
            <code class="csharp plain" style="border:0px;line-height:1.8em;vertical-align:baseline;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;color:rgb(0,0,0);background:none;">}</code>
           </div> 
          </div> </td> 
        </tr>
       </tbody>
      </table>
     </div> 
    </div> 
   </div> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">（第二步）EFDbContext（EF上下文对该接口的具体实现）　　&nbsp;</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <img class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" style="border:0px;vertical-align:middle;">&nbsp;
    <span class="cnblogs_code_collapse" style="border:1px solid #808080;line-height:1.5;">View Code</span> 
   </div> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">（第三步） 封装BaseRepository仓储实现通过EFDbContext上下文对数据的基本操作</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span> BaseRepository&lt;TEntity&gt; <span style="color:rgb(0,0,255);line-height:1.5;">where</span> TEntity : <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;">
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">internal</span><span style="line-height:1.5;"> EFDbContext Context;
        </span><span style="color:rgb(0,0,255);line-height:1.5;">internal</span> DbSet&lt;TEntity&gt;<span style="line-height:1.5;"> DbSet;
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> BaseRepository(EFDbContext context)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">this</span>.DbSet = context.Set&lt;TEntity&gt;<span style="line-height:1.5;">();
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> IEnumerable&lt;TEntity&gt;<span style="line-height:1.5;"> Get()
        {
            IQueryable</span>&lt;TEntity&gt; query =<span style="line-height:1.5;"> DbSet;
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> query.ToList();
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> TEntity GetByID(<span style="color:rgb(0,0,255);line-height:1.5;">object</span><span style="line-height:1.5;"> id)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> DbSet.Find(id);
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> Insert(TEntity entity)
        {
            DbSet.Add(entity);
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span> Delete(<span style="color:rgb(0,0,255);line-height:1.5;">object</span><span style="line-height:1.5;"> id)
        {
            TEntity entityToDelete </span>=<span style="line-height:1.5;"> DbSet.Find(id);
            Delete(entityToDelete);
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> Delete(TEntity entityToDelete)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (Context.Entry(entityToDelete).State ==<span style="line-height:1.5;"> EntityState.Detached)
            {
                DbSet.Attach(entityToDelete);
            }
            DbSet.Remove(entityToDelete);
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> Update(TEntity entityToUpdate)
        {
            DbSet.Attach(entityToUpdate);
            Context.Entry(entityToUpdate).State </span>=<span style="line-height:1.5;"> EntityState.Modified;
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> IEnumerable&lt;TEntity&gt; GetMany(Func&lt;TEntity, <span style="color:rgb(0,0,255);line-height:1.5;">bool</span>&gt; <span style="color:rgb(0,0,255);line-height:1.5;">where</span><span style="line-height:1.5;">)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> DbSet.Where(<span style="color:rgb(0,0,255);line-height:1.5;">where</span><span style="line-height:1.5;">).ToList();
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> IQueryable&lt;TEntity&gt; GetManyQueryable(Func&lt;TEntity, <span style="color:rgb(0,0,255);line-height:1.5;">bool</span>&gt; <span style="color:rgb(0,0,255);line-height:1.5;">where</span><span style="line-height:1.5;">)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> DbSet.Where(<span style="color:rgb(0,0,255);line-height:1.5;">where</span><span style="line-height:1.5;">).AsQueryable();
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> TEntity Get(Func&lt;TEntity, Boolean&gt; <span style="color:rgb(0,0,255);line-height:1.5;">where</span><span style="line-height:1.5;">)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> DbSet.Where(<span style="color:rgb(0,0,255);line-height:1.5;">where</span>).FirstOrDefault&lt;TEntity&gt;<span style="line-height:1.5;">();
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span> Delete(Func&lt;TEntity, Boolean&gt; <span style="color:rgb(0,0,255);line-height:1.5;">where</span><span style="line-height:1.5;">)
        {
            IQueryable</span>&lt;TEntity&gt; objects = DbSet.Where&lt;TEntity&gt;(<span style="color:rgb(0,0,255);line-height:1.5;">where</span><span style="line-height:1.5;">).AsQueryable();
            </span><span style="color:rgb(0,0,255);line-height:1.5;">foreach</span> (TEntity obj <span style="color:rgb(0,0,255);line-height:1.5;">in</span><span style="line-height:1.5;"> objects)
                DbSet.Remove(obj);
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> IEnumerable&lt;TEntity&gt;<span style="line-height:1.5;"> GetAll()
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> DbSet.ToList();
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> IQueryable&lt;TEntity&gt; GetWithInclude(System.Linq.Expressions.Expression&lt;Func&lt;TEntity, <span style="color:rgb(0,0,255);line-height:1.5;">bool</span>&gt;&gt; predicate, <span style="color:rgb(0,0,255);line-height:1.5;">params</span> <span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;">[] include)
        {
            IQueryable</span>&lt;TEntity&gt; query = <span style="color:rgb(0,0,255);line-height:1.5;">this</span><span style="line-height:1.5;">.DbSet;
            query </span>= include.Aggregate(query, (current, inc) =&gt;<span style="line-height:1.5;"> current.Include(inc));
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> query.Where(predicate);
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">bool</span> Exists(<span style="color:rgb(0,0,255);line-height:1.5;">object</span><span style="line-height:1.5;"> primaryKey)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> DbSet.Find(primaryKey) != <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">;
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> TEntity GetSingle(Func&lt;TEntity, <span style="color:rgb(0,0,255);line-height:1.5;">bool</span>&gt;<span style="line-height:1.5;"> predicate)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> DbSet.Single&lt;TEntity&gt;<span style="line-height:1.5;">(predicate);
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> TEntity GetFirst(Func&lt;TEntity, <span style="color:rgb(0,0,255);line-height:1.5;">bool</span>&gt;<span style="line-height:1.5;"> predicate)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> DbSet.First&lt;TEntity&gt;<span style="line-height:1.5;">(predicate);
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">（第四步）对于UnitOfWork，当然就需要IUnitOfWork接口了&nbsp;</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">interface</span><span style="line-height:1.5;"> IUnitOfWork
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> Commit();
        </span><span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> RollBack();
    }</span></pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">（个人比较倾向于该接口只有数据的提交，至于增、删等操作则是放在服务层）</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">（第五步）UnitOfWork最终登上舞台</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> UnitOfWork : IUnitOfWork, IDisposable
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">bool</span> disposed = <span style="color:rgb(0,0,255);line-height:1.5;">false</span><span style="line-height:1.5;">;

        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">readonly</span> EFDbContext _context = <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">;
        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> BaseRepository&lt;UserEntity&gt;<span style="line-height:1.5;"> _userRepository;
        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> BaseRepository&lt;TokenEntity&gt;<span style="line-height:1.5;"> _tokenRepository;

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> UnitOfWork()
        {
            _context </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> EFDbContext(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">basicAuthenticate</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
        }
      <span style="color:rgb(128,128,0);line-height:1.5;"> /**获得用户仓储**/ </span></span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> BaseRepository&lt;UserEntity&gt;<span style="line-height:1.5;"> UserRepository
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">get</span><span style="line-height:1.5;">
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (_userRepository == <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">)
                    _userRepository </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> BaseRepository&lt;UserEntity&gt;<span style="line-height:1.5;">(_context);
                </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> _userRepository;

            }
        }
      <span style="color:rgb(128,128,0);line-height:1.5;"> /**获得票据仓储**/ </span></span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> BaseRepository&lt;TokenEntity&gt;<span style="line-height:1.5;"> TokenRepository
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">get</span><span style="line-height:1.5;">
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (_tokenRepository == <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">)
                    _tokenRepository </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> BaseRepository&lt;TokenEntity&gt;<span style="line-height:1.5;">(_context);
                </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> _tokenRepository;
            }
        }<br><span style="color:rgb(128,128,0);line-height:1.5;">　/**进行数据提交持久化到数据库中**/ </span></span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> Commit()
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">try</span><span style="line-height:1.5;">
            {
                _context.SaveChanges();
            }
            </span><span style="color:rgb(0,0,255);line-height:1.5;">catch</span><span style="line-height:1.5;"> (Exception ex)
            {
                logger.LogError(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">--------EF提交数据，出现异常：</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> +<span style="line-height:1.5;"> ex.Message);
                logger.LogError(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">--------EF提交数据，堆栈消息：</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> +<span style="line-height:1.5;"> ex.StackTrace);
            }
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> RollBack()
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">throw</span> <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> Exception();
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">protected</span> <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span> Dispose(<span style="color:rgb(0,0,255);line-height:1.5;">bool</span><span style="line-height:1.5;"> disposing)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (!<span style="color:rgb(0,0,255);line-height:1.5;">this</span><span style="line-height:1.5;">.disposed)
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> (disposing)
                {
                    logger.LogInfo(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">释放UnitOfWork资源</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
                    _context.Dispose();
                }
            }
            </span><span style="color:rgb(0,0,255);line-height:1.5;">this</span>.disposed = <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">;
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> Dispose()
        {
            Dispose(</span><span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">);
            GC.SuppressFinalize(</span><span style="color:rgb(0,0,255);line-height:1.5;">this</span><span style="line-height:1.5;">);
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">服务层 (ApplicationService)</h2> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">用户服务接口（IUserService）</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">interface</span><span style="line-height:1.5;"> IUserService
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span> Authenticate(<span style="color:rgb(0,0,255);line-height:1.5;">string</span> userName, <span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> userPassword);

    }</span></pre>
   </div> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">用户服务接口实现（UserService）</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> UserService : IUserService
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">readonly</span><span style="line-height:1.5;"> UnitOfWork _unitOfWork;
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> UserService(UnitOfWork unitOfWork)
        {
            _unitOfWork </span>=<span style="line-height:1.5;"> unitOfWork;
        }<br><br><span style="color:rgb(128,128,0);line-height:1.5;">/**认证用户名和密码**/ </span></span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">int</span> Authenticate(<span style="color:rgb(0,0,255);line-height:1.5;">string</span> userName, <span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> password)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> user = _unitOfWork.UserRepository.Get(u =&gt; u.UserName == userName &amp;&amp; u.UserPassword ==<span style="line-height:1.5;"> password);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (user != <span style="color:rgb(0,0,255);line-height:1.5;">null</span> &amp;&amp; user.UserId &gt; <span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">)
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> user.UserId;
            }
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">;
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">票据服务接口（ITokenService）&nbsp;</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">interface</span><span style="line-height:1.5;"> ITokenService
    {
        TokenEntity GenerateToken(</span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> userId);<span style="color:rgb(128,128,0);line-height:1.5;"> /**认证通过自动生成票据**/ </span></span><span style="color:rgb(0,0,255);line-height:1.5;">bool</span> ValidateToken(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> tokenId);<span style="color:rgb(128,128,0);line-height:1.5;">/**下次登录认证添加到cookie中的票据是否过期**/ </span></span><span style="color:rgb(0,0,255);line-height:1.5;">bool</span> Kill(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> tokenId);<span style="color:rgb(128,128,0);line-height:1.5;">/*删除票据**/ </span></span><span style="color:rgb(0,0,255);line-height:1.5;">bool</span> DeleteByUserId(<span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> userId);<span style="color:rgb(128,128,0);line-height:1.5;">/**通过用户Id删除该用户所有票据**/</span>
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">票据服务接口实现（TokenService）</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> TokenService : ITokenService
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">readonly</span><span style="line-height:1.5;"> UnitOfWork _unitOfWork;

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> TokenService(UnitOfWork unitOfWork)
        {
            _unitOfWork </span>=<span style="line-height:1.5;"> unitOfWork;
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> TokenEntity GenerateToken(<span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> userId)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">string</span> token =<span style="line-height:1.5;"> Guid.NewGuid().ToString();
            DateTime issuedOn </span>=<span style="line-height:1.5;"> DateTime.Now;
            DateTime expiredOn </span>=<span style="line-height:1.5;"> DateTime.Now.AddSeconds(
                                              Convert.ToDouble(ConfigurationManager.AppSettings[</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">AuthTokenExpiry</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">]));
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> tokendomain = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> TokenEntity
                                  {
                                      UserId </span>=<span style="line-height:1.5;"> userId,
                                      AuthToken </span>=<span style="line-height:1.5;"> token,
                                      IssuedOn </span>=<span style="line-height:1.5;"> issuedOn,
                                      ExpiresOn </span>=<span style="line-height:1.5;"> expiredOn
                                  };

            _unitOfWork.TokenRepository.Insert(tokendomain);
            _unitOfWork.Commit();
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> tokenModel = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> TokenEntity()
                                 {
                                     UserId </span>=<span style="line-height:1.5;"> userId,
                                     IssuedOn </span>=<span style="line-height:1.5;"> issuedOn,
                                     ExpiresOn </span>=<span style="line-height:1.5;"> expiredOn,
                                     AuthToken </span>=<span style="line-height:1.5;"> token
                                 };

            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> tokenModel;
        }<br><span style="color:rgb(128,128,0);line-height:1.5;"> /**验证票据和失效时间，若未过期则继续追加失效时间，并更新并提交到数据库中**/ </span></span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">bool</span> ValidateToken(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> tokenId)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> token = _unitOfWork.TokenRepository.Get(t =&gt; t.AuthToken == tokenId &amp;&amp; t.ExpiresOn &gt;<span style="line-height:1.5;"> DateTime.Now);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (token != <span style="color:rgb(0,0,255);line-height:1.5;">null</span> &amp;&amp; !(DateTime.Now &gt;<span style="line-height:1.5;"> token.ExpiresOn))
            {
                token.ExpiresOn </span>=<span style="line-height:1.5;"> token.ExpiresOn.AddSeconds(
                                              Convert.ToDouble(ConfigurationManager.AppSettings[</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">TokenExpiry</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">]));
                _unitOfWork.TokenRepository.Update(token);
                _unitOfWork.Commit();
                </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">;
            }
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(0,0,255);line-height:1.5;">false</span><span style="line-height:1.5;">;
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">bool</span> Kill(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> tokenId)
        {
            _unitOfWork.TokenRepository.Delete(x </span>=&gt; x.AuthToken ==<span style="line-height:1.5;"> tokenId);
            _unitOfWork.Commit();
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> isNotDeleted = _unitOfWork.TokenRepository.GetMany(x =&gt; x.AuthToken ==<span style="line-height:1.5;"> tokenId).Any();
            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (isNotDeleted) { <span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(0,0,255);line-height:1.5;">false</span><span style="line-height:1.5;">; }
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">;
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">bool</span> DeleteByUserId(<span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> userId)
        {
            _unitOfWork.TokenRepository.Delete(x </span>=&gt; x.UserId ==<span style="line-height:1.5;"> userId);
            _unitOfWork.Commit();

            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> isNotDeleted = _unitOfWork.TokenRepository.GetMany(x =&gt; x.UserId ==<span style="line-height:1.5;"> userId).Any();
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> !<span style="line-height:1.5;">isNotDeleted;
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">到此为止，基本的实现都已经完成，我们就差表现层，在表现层我们就需要实现自定义认证。下面我们一起来看看表现层。</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">表现层（WebApiFllowUp）</h2> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">认证实体类（BasicAuthenticationIdentity），多添加一个字段，就是用户Id（UserId）</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> BasicAuthenticationIdentity : GenericIdentity
    {

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">int</span> UserId { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">string</span> UserName { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">string</span> UserPassword { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }     
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> BasicAuthenticationIdentity(<span style="color:rgb(0,0,255);line-height:1.5;">string</span> name, <span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> password)
            : </span><span style="color:rgb(0,0,255);line-height:1.5;">base</span>(name, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Basic</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">this</span>.UserName =<span style="line-height:1.5;"> name;
            </span><span style="color:rgb(0,0,255);line-height:1.5;">this</span>.UserPassword =<span style="line-height:1.5;"> password;
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">自定义基础认证特性</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <img class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" style="border:0px;vertical-align:middle;">&nbsp;
    <span class="cnblogs_code_collapse" style="border:1px solid #808080;line-height:1.5;">View Code</span> 
   </div> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">自定义针对于APi认证特性，重载基础认证特性中方法</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>   <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> ApiAuthenticationFilter : BasicAuthenticationFilter
    {

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> ApiAuthenticationFilter()
        {
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">protected</span> <span style="color:rgb(0,0,255);line-height:1.5;">override</span> <span style="color:rgb(0,0,255);line-height:1.5;">bool</span> OnAuthorizeUser(<span style="color:rgb(0,0,255);line-height:1.5;">string</span> username, <span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> password, HttpActionContext actionContext)
        {

            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> provider =<span style="color:rgb(128,128,0);line-height:1.5;"> actionContext.ControllerContext.Configuration
                               .DependencyResolver.GetService(typeof(IUserService)) as IUserService;
            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (provider != <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">)
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> userId =<span style="line-height:1.5;"> provider.Authenticate(username, password);
                </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (userId &gt; <span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">)
                {
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> basicAuthenticationIdentity = Thread.CurrentPrincipal.Identity <span style="color:rgb(0,0,255);line-height:1.5;">as</span><span style="line-height:1.5;"> BasicAuthenticationIdentity;
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (basicAuthenticationIdentity != <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">)
                        basicAuthenticationIdentity.UserId </span>=<span style="line-height:1.5;"> userId;
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">;
                }
            }
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(0,0,255);line-height:1.5;">false</span><span style="line-height:1.5;">;
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><strong style="font-size:16px;line-height:normal;"><span style="color:rgb(255,102,0);">想必都看到上述标记的那句代码，那么问题就来了，我们是如何通过action上下文获得其服务的呢？准确的说就是我们是如何注入这些服务的呢？这就是本文的第一大重点，依赖注入服务。</span></strong></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">在文章开头也有说过就是利用微软的Unity来实现，那么具体是怎么实现的呢？接下来我们开始一起来看看。</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">Unity&nbsp;</h2> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">安装程序包：</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201511/589642-20151122150834140-989824501.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">接下来我们通过代码实现所有需要注入的服务，无需通过配置文件来麻烦进行注册。</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">定义注册服务组件接口</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">interface</span><span style="line-height:1.5;"> IRegisterComponent
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">void</span> RegisterType&lt;TFrom, TTo&gt;() <span style="color:rgb(0,0,255);line-height:1.5;">where</span><span style="line-height:1.5;"> TTo : TFrom;

    }</span></pre>
   </div> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">实现该服务接口并通过Untity容器进行注入服务</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">internal</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> RegisterComponent : IRegisterComponent
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">readonly</span><span style="line-height:1.5;"> IUnityContainer _container;

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> RegisterComponent(IUnityContainer container)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">this</span>._container =<span style="line-height:1.5;"> container;
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span> RegisterType&lt;TFrom, TTo&gt;() <span style="color:rgb(0,0,255);line-height:1.5;">where</span><span style="line-height:1.5;"> TTo : TFrom
        {
            _container.RegisterType</span>&lt;TFrom, TTo&gt;<span style="line-height:1.5;">();
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">定义组件导入该组件接口来注册服务</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">interface</span><span style="line-height:1.5;"> IComponent
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> SetUp(IRegisterComponent registerTypeComponent);
    }</span></pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">导出IComponent组件，通过MEF中组件容器获得导出组件（有关MEF【扩展性管理框架】详情请参考园友（<a href="http://www.cnblogs.com/beniao/archive/2010/08/11/1797537.html" rel="nofollow" style="text-decoration:none;color:rgb(45,161,45);">Bēniaǒ</a>）的文章）</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">加载组件【加载实现了IComponent接口的程序集】</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> ComponentLoader
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span> LoadContainer(IUnityContainer container, <span style="color:rgb(0,0,255);line-height:1.5;">string</span> path, <span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> pattern)
        {<br><span style="color:rgb(128,128,0);line-height:1.5;"> /**获取指定路径下匹配的程序集目录**/ </span></span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> dirCat = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> DirectoryCatalog(path, pattern);<br><span style="color:rgb(128,128,0);line-height:1.5;"> /**导入IComponent的完整名称**/ </span></span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> importDef =<span style="line-height:1.5;"> BuildImportDefinition();
            </span><span style="color:rgb(0,0,255);line-height:1.5;">try</span><span style="line-height:1.5;">
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> aggregateCatalog = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> AggregateCatalog())
                {<br><span style="color:rgb(128,128,0);line-height:1.5;">　/**将指定目录添加到聚合目录**/</span>
                    aggregateCatalog.Catalogs.Add(dirCat);
　　　　　　　　　　　<span style="color:rgb(128,128,0);line-height:1.5;">　/**将组件目录添加到组件容器中**/ </span></span><span style="color:rgb(0,0,255);line-height:1.5;">using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> componsitionContainer = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> CompositionContainer(aggregateCatalog))
                    {   <span style="color:rgb(128,128,0);line-height:1.5;">/**从组件容器中获得指定类型的导入定义**/</span>
                        IEnumerable</span>&lt;Export&gt; exports =<span style="line-height:1.5;"> componsitionContainer.GetExports(importDef);
　　　　　　　　　　　　　　<span style="color:rgb(128,128,0);line-height:1.5;">/**获取其值为IComponent并且不为空**/</span>
                        IEnumerable</span>&lt;IComponent&gt; modules =<span style="line-height:1.5;">
                            exports.Select(export </span>=&gt; export.Value <span style="color:rgb(0,0,255);line-height:1.5;">as</span> IComponent).Where(m =&gt; m != <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">);
　　　　　　　　　　　　　<span style="color:rgb(128,128,0);line-height:1.5;">　/**实例化的注册组件类构造函数组件容器来注入类型**/ </span></span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> registerComponent = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> RegisterComponent(container);
                        </span><span style="color:rgb(0,0,255);line-height:1.5;">foreach</span> (IComponent module <span style="color:rgb(0,0,255);line-height:1.5;">in</span><span style="line-height:1.5;"> modules)
                        {
                            module.SetUp(registerComponent);
                        }
                    }
                }
            }
            </span><span style="color:rgb(0,0,255);line-height:1.5;">catch</span><span style="line-height:1.5;"> (ReflectionTypeLoadException typeLoadException)
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> builder = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> StringBuilder();
                </span><span style="color:rgb(0,0,255);line-height:1.5;">foreach</span> (Exception loaderException <span style="color:rgb(0,0,255);line-height:1.5;">in</span><span style="line-height:1.5;"> typeLoadException.LoaderExceptions)
                {
                    builder.AppendFormat(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">{0}\n</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, loaderException.Message);
                }

                logger.LogError(</span><span style="color:rgb(0,0,255);line-height:1.5;">string</span>.Format(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">--------通过反射注册服务，出现异常：{0}，异常信息{1}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, typeLoadException, builder));
            }
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span><span style="line-height:1.5;"> ImportDefinition BuildImportDefinition()
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> ImportDefinition(
                def </span>=&gt; <span style="color:rgb(0,0,255);line-height:1.5;">true</span>, <span style="color:rgb(0,0,255);line-height:1.5;">typeof</span>(IComponent).FullName, ImportCardinality.ZeroOrMore, <span style="color:rgb(0,0,255);line-height:1.5;">false</span>, <span style="color:rgb(0,0,255);line-height:1.5;">false</span><span style="line-height:1.5;">);
        }


    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">初始化加载组件并注入实现了IComponent接口的类型并设置到注册点上&nbsp;</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> Bootstrapper
    {
       
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> Initial()
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> container =<span style="line-height:1.5;"> BuildUnityContainer();
　　　　　　<span style="color:rgb(255,102,0);line-height:1.5;"><span style="font-size:16px;line-height:1.5;">　</span>/**注意不要添加此句，否则会报错**/</span>
            //DependencyResolver.SetResolver(</span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> UnityDependencyResolver(container));

            GlobalConfiguration.Configuration.DependencyResolver </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> UnityDependencyResolver(container);
        }


        </span><span style="color:rgb(0,128,0);line-height:1.5;">/*</span><span style="color:rgb(0,128,0);line-height:1.5;">*建立Unity容器*</span><span style="color:rgb(0,128,0);line-height:1.5;">*/</span>
        <span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span><span style="line-height:1.5;"> IUnityContainer BuildUnityContainer()
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> container = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> UnityContainer();
            RegisterTypes(container);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> container;
        }

        </span><span style="color:rgb(0,128,0);line-height:1.5;">/*</span><span style="color:rgb(0,128,0);line-height:1.5;">*通过加载如下两个程序集来注册其类型到Unity容器中*</span><span style="color:rgb(0,128,0);line-height:1.5;">*/</span>
        <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> RegisterTypes(IUnityContainer container)
        {
            ComponentLoader.LoadContainer(container, </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">.\\bin</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">WebAPiFllowUp.dll</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
            ComponentLoader.LoadContainer(container, </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">.\\bin</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">AppicationServices.dll</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">最后一步在全局配置中进行初始化加载并注入</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre> Bootstrapper.Initial();</pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">至此关于如何通过MEF和Unity来依赖注入类型就已经结束，但是到这里我们还有一个问题未解决，那就是我们在应用层写了相应的接口服务以及其实现，那么我们怎么如何去注入呢？因为我们上面说过只要实现了IComponent接口的类型都将会进行注入，接下来通过MEF中的导入接口以及其实现即可。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><strong style="font-size:16px;line-height:normal;"><span>在服务层，我们注入IUserService以及ITokenService。</span></strong></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    [Export(<span style="color:rgb(0,0,255);line-height:1.5;">typeof</span><span style="line-height:1.5;">(IComponent))]
    </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> DependencyResolver : IComponent
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> SetUp(IRegisterComponent registerComponent)
        {
            registerComponent.RegisterType</span>&lt;IUserService, UserService&gt;<span style="line-height:1.5;">();
            registerComponent.RegisterType</span>&lt;ITokenService, TokenService&gt;<span style="line-height:1.5;">();
        }

    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><strong style="font-size:16px;line-height:normal;"><span>在实体模型层注入IUnitOfWork。</span></strong></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    [Export(<span style="color:rgb(0,0,255);line-height:1.5;">typeof</span><span style="line-height:1.5;">(IComponent))]
    </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> DependencyResolver : Resolver.IComponent
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> SetUp(IRegisterComponent registerComponent)
        {
            registerComponent.RegisterType</span>&lt;IUnitOfWork, UnitOfWork&gt;<span style="line-height:1.5;">();
        }

    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">到这里关于依赖注入类型就完美结束，无需通过配置文件来进行繁琐配置，同理如果需要注入其他类型只需要如上导入IComponent并注册其类型即可，一劳永逸。接下来一切准备就绪，我们准备开始利用WebAPiTestOnHelpPage。</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">WebAPiTestOnHelpPage&nbsp;</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">关于测试WebAPi的工具也有园友给出了相应的工具，但是我找的这个无论是界面还是效果都是非常好的，所以推荐给这个测试工具给大家，这个测试WebAPi的程序包是在WebAPiTest的基础上进行了更新，WebAPiTest只能运行在MVC3或者4，在MVC5上会报错，并且版主也未及时进行更新，后有人对其进行了更新使其能在高版本上能愉快的玩耍，我也是通过看评论才发现进一步的解决方案。下载如下程序包</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201511/589642-20151122232052624-383396694.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">我是挺爱折腾的人，查资料过程中又发现居然有一个可以绑定路由特性（AttributeRouting）的程序包，于是乎我又尝试了一把，当然你也不必这么做，可以一起看看，配置起来还是非常简单的。 此时代码生成成功，我们运行下程序来试试看，妈的，竟然出错了，如下：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201511/589642-20151123000515718-988926753.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">很明显了，我们只需在Web.Config中下的WebServer节点添加如下即可，结果运行成功：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre> &lt;validation validateIntegratedModeConfiguration=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">false</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> /&gt;</pre>
   </div> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">AttributeRouting</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">我们通过程序包继续下载AttributeRouting.WebApi程序包即可，因为是以WebHost为宿主，所以SelfHost就不用下载。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201511/589642-20151122233503296-1856658344.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">安装完成后会在App_Start中自动生成一个AttributeRoutingHttpConfig文件来进行它所给出的路由请求配置。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">接下来我们定义一个关于WebAPi的认证请求控制器类即AuthenticationController，具体实现如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="line-height:1.5;">    [ApiAuthenticationFilter]
    </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> AuthenticationController : ApiController
    {

        </span><span style="color:rgb(128,128,128);line-height:1.5;">///</span> <span style="color:rgb(128,128,128);line-height:1.5;">&lt;summary&gt;</span>
        <span style="color:rgb(128,128,128);line-height:1.5;">///<span style="color:rgb(255,102,0);line-height:1.5;">注意：</span></span><span style="color:rgb(255,102,0);line-height:1.5;"> WebAPi默认必须要有无参函数，否则报错
        </span><span style="color:rgb(128,128,128);line-height:1.5;">///</span> <span style="color:rgb(128,128,128);line-height:1.5;">&lt;/summary&gt;</span>
        <span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> AuthenticationController() { }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">readonly</span><span style="line-height:1.5;"> ITokenService _tokenService;
        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">readonly</span><span style="line-height:1.5;"> IUserService _userService;

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> AuthenticationController(ITokenService tokenService,IUserService userService)
        {
            _tokenService </span>=<span style="line-height:1.5;"> tokenService;
            _userService </span>=<span style="line-height:1.5;"> userService;
        }
　　　<span style="color:rgb(128,128,0);line-height:1.5;">　　/**此请求方法特性就是利用上述我们添加的程序包来实现的**/</span>
        [POST(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Authenticate</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">)]
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> HttpResponseMessage Authenticate()
        {

            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (System.Threading.Thread.CurrentPrincipal != <span style="color:rgb(0,0,255);line-height:1.5;">null</span> &amp;&amp;<span style="line-height:1.5;"> System.Threading.Thread.CurrentPrincipal.Identity.IsAuthenticated)
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> basicAuthenticationIdentity = Thread.CurrentPrincipal.Identity <span style="color:rgb(0,0,255);line-height:1.5;">as</span><span style="line-height:1.5;"> BasicAuthenticationIdentity;
                </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (basicAuthenticationIdentity != <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">)
                {
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> userId =<span style="line-height:1.5;"> basicAuthenticationIdentity.UserId;
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> GetAuthToken(userId);
                }
            }
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">;
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> HttpResponseMessage GetAuthToken(<span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> userId)
        {

            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> token =<span style="line-height:1.5;"> _tokenService.GenerateToken(userId);

            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> response = Request.CreateResponse(HttpStatusCode.OK, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Authorized</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
            response.Headers.Add(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Token</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, token.AuthToken);
            response.Headers.Add(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">TokenExpiry</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, ConfigurationManager.AppSettings[<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">TokenExpiry</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">]);
            response.Headers.Add(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Access-Control-Expose-Headers</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Token,TokenExpiry</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> response;
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">最后我们来通过WebAPiTestOnHelpPage来测试下。通过locahost:xxx/help，得到如下界面</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201511/589642-20151122235212905-194860130.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">看到没，该测试工具会自动识别出你所添加的所有控制器类以及所有的方法，还不强大吗，我们继续看。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201511/589642-20151122235433905-396758015.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;它会自动给出相应的请求信息以及响应信息，我们点击TestAPi，即可进入测试界面，如下：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201511/589642-20151122235650796-1670989575.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">我们还可以在此基础上添加请求头，点击Add header即可，当然也可以删除，如下：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201511/589642-20151122235758936-250687558.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">我们发送点击发送Send来瞧瞧其结果，我了个去，出错了，如下</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201511/589642-20151122235957546-1019514857.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">为什么会出现这样的错误呢？因为是我们使用程序包AttributeRoutingWebAPi出现的错误，主要错误出现在App_Start中其配置文件中，添加默认的会出错，我们需要将配置文件中的如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre> routes.MapHttpAttributeRoutes();</pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">替换成如下即可：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre> routes.MapHttpAttributeRoutes(cfg =&gt;<span style="line-height:1.5;">
            {
                cfg.InMemory </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">;
                cfg.AutoGenerateRouteNames </span>= <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;">;
                cfg.AddRoutesFromAssemblyOf</span>&lt;AuthenticationController&gt;<span style="line-height:1.5;">();
            });</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">至此，关于错误的解决以及测试工具都已经处理完成，因为文章开头说的是关于如何保持Session的问题，我们最终回到这个问题上来，在认证控制器中我们添加了一个Authenticate方法来取得当前认证身份是否通过认证，没有则发起质询，有的话则通过获取到UserId来自动生成一个AuthToken并将其添加到请求报文头中以及还有失效时间。接下来我们来完整的测试整个流程。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201511/589642-20151123002021921-232803458.png" alt="" style="border:0px;">&nbsp;假设我们通过登录界面在数据库中注册了如下账号，如下：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201511/589642-20151123002318827-55839866.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">现在我们用上述账号和密码进行基础认证发出的质询进行登录试试看，此时会返回如下信息</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201511/589642-20151123002618358-650216075.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">说明授权成功，我们再来看看数据库，应该是有数据的，如我所期望的那样</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201511/589642-20151123002726921-1871308082.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">这仅仅是告诉了我们授权成功，如果我们要想访问某一个方法时，可能是需要验证是否有这个权限，所以我们接下来要做的就是验证我们上述在请求报文头中是否包含这个Token即可，接下来我们就需要自定义一个实现ActionFilterAttribute特性的特性，我们取名为ActionFilterRequiredAttribute，下面是具体实现</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> ActionFilterRequiredAttribute : ActionFilterAttribute
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">const</span> <span style="color:rgb(0,0,255);line-height:1.5;">string</span> Token = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Token</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">;

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">override</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> OnActionExecuting(HttpActionContext filterContext)
        {

            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> provider =<span style="line-height:1.5;"> filterContext.ControllerContext.Configuration
                .DependencyResolver.GetService(</span><span style="color:rgb(0,0,255);line-height:1.5;">typeof</span>(ITokenService)) <span style="color:rgb(0,0,255);line-height:1.5;">as</span><span style="line-height:1.5;"> ITokenService;

            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> (filterContext.Request.Headers.Contains(Token))
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> tokenValue =<span style="line-height:1.5;"> filterContext.Request.Headers.GetValues(Token).First();

                </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (provider != <span style="color:rgb(0,0,255);line-height:1.5;">null</span> &amp;&amp; !<span style="line-height:1.5;">provider.ValidateToken(tokenValue))
                {
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> responseMessage = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> HttpResponseMessage(HttpStatusCode.Unauthorized) { ReasonPhrase = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Invalid Request</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> };
                    filterContext.Response </span>=<span style="line-height:1.5;"> responseMessage;
                }
            }
            </span><span style="color:rgb(0,0,255);line-height:1.5;">else</span><span style="line-height:1.5;">
            {
                filterContext.Response </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> HttpResponseMessage(HttpStatusCode.Unauthorized);
            }

            </span><span style="color:rgb(0,0,255);line-height:1.5;">base</span><span style="line-height:1.5;">.OnActionExecuting(filterContext);

        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">当验证某个用户是否有这个权限访问方法时，只需验证该请求报文头中是否包含其Token即可，也就是在方法上添加ActionFilterRequiredAttribute特性即可。如果其失效时间未过期则继续添加其实现时间，这样就达到了所谓的保持Session的目的，这样做也是一个不错的方案，在WebAPi中默认是关闭Session的，当然你想去用的话只需启动它即可</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">Log4net&nbsp;</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">关于log4net的文章是数不胜数，我只是对其进行了封装并起名为logger，能满足绝大多数应用需求。关于要添加什么log4net.dll这些基础就不废话了，直接上代码：</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">第一步</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> logger
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span><span style="line-height:1.5;"> ILog Info;
        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span><span style="line-height:1.5;"> ILog Error;
        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span><span style="line-height:1.5;"> ILog Warn;
        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span><span style="line-height:1.5;"> ILog Debug;

        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">object</span> objectLock = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> <span style="color:rgb(0,0,255);line-height:1.5;">object</span><span style="line-height:1.5;">();
        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span><span style="line-height:1.5;"> logger _instance;
        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> logger()
        {
            Error </span>= LogManager.GetLogger(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">logerror</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
            Info </span>= LogManager.GetLogger(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">loginfo</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
            Warn </span>= LogManager.GetLogger(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">logwarn</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
            Debug </span>= LogManager.GetLogger(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">logdebug</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span><span style="line-height:1.5;"> logger Instance()
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (_instance == <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">)
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">lock</span><span style="line-height:1.5;"> (objectLock)
                {
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (_instance == <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">)
                    {
                        _instance </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> logger();
                    }
                }
            }
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> _instance;
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span> LogInfo(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> info)
        {
            logger.Instance();
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">需要添加操作人id</span>
            <span style="color:rgb(0,0,255);line-height:1.5;">var</span> method = Method(<span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> infoLog = <span style="color:rgb(0,0,255);line-height:1.5;">string</span>.Format(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">{0}{1}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, method, info);
            Info.Info(infoLog);
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span> LogInfo(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> info,Exception ex)
        {
            logger.Instance();
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">需要添加操作人id</span>
            <span style="color:rgb(0,0,255);line-height:1.5;">var</span> method = Method(<span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> infoLog = <span style="color:rgb(0,0,255);line-height:1.5;">string</span>.Format(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">{0}{1}{2}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, method,info, ex);
            Info.Info(infoLog);
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span> LogWarn(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> warn)
        {
            logger.Instance();
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">需要添加操作人id</span>
            <span style="color:rgb(0,0,255);line-height:1.5;">var</span> method = Method(<span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> warnLog = <span style="color:rgb(0,0,255);line-height:1.5;">string</span>.Format(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">{0}{1}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, method, warn);
            Warn.Warn(warnLog);
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span> LogWarn(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> warn,Exception ex)
        {
            logger.Instance();
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">需要添加操作人id</span>
            <span style="color:rgb(0,0,255);line-height:1.5;">var</span> method = Method(<span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> warnLog = <span style="color:rgb(0,0,255);line-height:1.5;">string</span>.Format(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">{0}{1}{2}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, method,warn, ex);
            Warn.Warn(warnLog);
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span> LogError(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> error)
        {
            logger.Instance();
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">需要添加操作人id</span>
            <span style="color:rgb(0,0,255);line-height:1.5;">var</span> method = Method(<span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> errorLog = <span style="color:rgb(0,0,255);line-height:1.5;">string</span>.Format(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">{0}{1}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, method, error);
            Error.Error(errorLog);
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span> LogError(<span style="color:rgb(0,0,255);line-height:1.5;">string</span><span style="line-height:1.5;"> error,Exception ex)
        {
            logger.Instance();
            </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">需求添加操作人id</span>
            <span style="color:rgb(0,0,255);line-height:1.5;">var</span> method = Method(<span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> errorLog = <span style="color:rgb(0,0,255);line-height:1.5;">string</span>.Format(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">{0}{1}{2}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, method, error,ex);
            Error.Error(errorLog);
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">string</span> Method(<span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> i)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> trace = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> StackTrace();
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> methodInfo =<span style="line-height:1.5;"> trace.GetFrame(i).GetMethod();
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> methodName =<span style="line-height:1.5;"> methodInfo.Name;
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> className =<span style="line-height:1.5;"> methodInfo.DeclaringType.FullName;
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(0,0,255);line-height:1.5;">string</span>.Format(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">{0}.{1}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, className, methodName).Trim(<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">.</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">);
        }

    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">第二步</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><strong style="font-size:16px;line-height:normal;"><span>将logger该类的属性中的复制到输出目录设置为始终复制</span></strong></p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">第三步</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><strong style="font-size:16px;line-height:normal;"><span>在该类所在的类库中的Properties文件夹下的AssemblyInfo类文件添加如下一句</span></strong></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>[assembly: XmlConfigurator(ConfigFile = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">log4net.config</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, Watch = <span style="color:rgb(0,0,255);line-height:1.5;">true</span>)]</pre>
   </div> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">第四步</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><strong style="font-size:16px;line-height:normal;"><span>单独建立一个log4net.config关于日志的配置文件，添加如下内容</span></strong></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>&lt;configuration&gt;
  &lt;configSections&gt;
    &lt;section name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">log4net</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">log4net.Config.Log4NetConfigurationSectionHandler,log4net</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
  &lt;/configSections&gt;
  &lt;log4net&gt;
    &lt;logger name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">loginfo</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>&gt;
      &lt;level value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">INFO</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;appender-<span style="color:rgb(0,0,255);line-height:1.5;">ref</span> <span style="color:rgb(0,0,255);line-height:1.5;">ref</span>=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">InfoAppender</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
    &lt;/logger&gt;
    &lt;logger name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">logdebug</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>&gt;
      &lt;level value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">DEBUG</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;appender-<span style="color:rgb(0,0,255);line-height:1.5;">ref</span> <span style="color:rgb(0,0,255);line-height:1.5;">ref</span>=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">DebugAppender</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
    &lt;/logger&gt;
    &lt;logger name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">logerror</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>&gt;
      &lt;level value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ERROR</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;appender-<span style="color:rgb(0,0,255);line-height:1.5;">ref</span> <span style="color:rgb(0,0,255);line-height:1.5;">ref</span>=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ErrorAppender</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
    &lt;/logger&gt;
    &lt;logger name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">logwarn</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>&gt;
      &lt;level value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">WARN</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;appender-<span style="color:rgb(0,0,255);line-height:1.5;">ref</span> <span style="color:rgb(0,0,255);line-height:1.5;">ref</span>=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">WarningAppender</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
    &lt;/logger&gt;
    &lt;appender name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ErrorAppender</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">log4net.Appender.RollingFileAppender</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">File</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">D:/log/Error/</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">AppendToFile</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">true</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">MaxSizeRollBackups</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">10000</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">MaxFileSize</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">10240</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">StaticLogFileName</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">false</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">DatePattern</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">yyyyMMdd&amp;quot;.log&amp;quot;</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">RollingStyle</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Composite</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;layout type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">log4net.Layout.PatternLayout</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>&gt;
        &lt;conversionPattern value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">%date [%thread] %-5level %logger [%property{NDC}] - %message%newline</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;/layout&gt;
      &lt;filter type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">log4net.Filter.LevelRangeFilter</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>&gt;
        &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">LevelMin</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ERROR</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
        &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">LevelMax</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ERROR</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;/filter&gt;
    &lt;/appender&gt;
    &lt;appender name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">InfoAppender</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">log4net.Appender.RollingFileAppender</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">File</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">D:/log/Info/</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">AppendToFile</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">true</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">MaxFileSize</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">10000</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">MaxSizeRollBackups</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">200</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">StaticLogFileName</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">false</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">DatePattern</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">yyyyMMdd&amp;quot;.log&amp;quot;</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">RollingStyle</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Composite</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;layout type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">log4net.Layout.PatternLayout</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>&gt;
        &lt;conversionPattern value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">%date [%thread] %-5level %logger [%property{NDC}] - %message%newline</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;/layout&gt;
    &lt;/appender&gt;
    &lt;appender name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">WarningAppender</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">log4net.Appender.RollingFileAppender</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">File</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">D:/log/Warn/</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">AppendToFile</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">true</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">MaxFileSize</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">10000</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">MaxSizeRollBackups</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">200</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">StaticLogFileName</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">false</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">DatePattern</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">yyyyMMdd&amp;quot;.log&amp;quot;</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">RollingStyle</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Composite</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;layout type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">log4net.Layout.PatternLayout</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>&gt;
        &lt;conversionPattern value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">%date [%thread] %-5level %logger [%property{NDC}] - %message%newline</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;/layout&gt;
    &lt;/appender&gt;
    &lt;appender name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">DebugAppender</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">log4net.Appender.RollingFileAppender</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">File</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">D:/log/Debug/</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">AppendToFile</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">true</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">MaxFileSize</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">10000</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">MaxSizeRollBackups</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">200</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">StaticLogFileName</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">false</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">DatePattern</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">yyyyMMdd&amp;quot;.log&amp;quot;</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;param name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">RollingStyle</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Composite</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;layout type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">log4net.Layout.PatternLayout</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>&gt;
        &lt;conversionPattern value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">%date [%thread] %-5level %logger [%property{NDC}] - %message%newline</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;/layout&gt;
    &lt;/appender&gt;
  &lt;/log4net&gt;
&lt;/configuration&gt;</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><strong style="font-size:16px;line-height:normal;"><span>至于以上log4net各个参数的含义自行查资料了解。最后生成如下文件夹</span></strong></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201511/589642-20151123005332483-1678243390.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><strong style="font-size:16px;line-height:normal;"><span>在配置文件中是按照日期来进行日志的记录，如下：</span></strong></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201511/589642-20151123005834640-1710190291.png" alt="" style="border:0px;"></p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">总结&nbsp;</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">最后的最后还是依然来个总结，本文比较详细的介绍如何去维护和保持Session，同时也涉及到了一些知识就如已经提过的Unity、Log4net、MEF、WebAPiTestOnHelpPage等，在WebAPi默认是关闭Session，如果我们想去利用Session的话还得手动去启动它，但是在本文中并未如此实现，用建立票据表的形式来管理其所谓的Session也是一种不错的解决方案。不知不觉写博客已经到一点了，终于Over，休息。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p><font color="#111111"><span style="font-size:13px;line-height:23.4px;">本文转自Jeffcky博客园博客，原文链接：http://www.cnblogs.com/CreateMyself/p/4965160.html，如需转载请自行联系原作者</span></font><br></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
