<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>EntityFramework之Log（五） « NotBeCN</title>
  <meta name="description" content="             关于日志    属性日志    &nbsp;&nbsp;DbContext.Database.Log&nbsp;属性被设置为一个委托，该委托能接受带有一个字符串参数的任何方法，最主要的是，通过设置它到&nbsp;TextWriter&nbsp;的&nbsp;Write&nbsp;方法将能...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/14/weixin_34190136_90120639.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">EntityFramework之Log（五）</h1>
    <p class="post-meta">Nov 14, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <h1 style="font-size:28px;line-height:1.5;font-family:'Helvetica Neue', Arial;">关于日志</h1> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">属性日志</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">&nbsp;DbContext.Database.Log</span>&nbsp;属性被设置为一个委托，该委托能接受带有一个字符串参数的任何方法，最主要的是，通过设置它到&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">TextWriter</span>&nbsp;的&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">Write</span>&nbsp;方法将能应用于任何的TextWriter，通过上下文自动生成的所有SQL语句将被记录到Writer中。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">例如，如下代码将记录SQL在控制台上：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>              <span style="color:rgb(0,0,255);line-height:1.5;">using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> ctx = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> EntityDbContext())
              {
                 <span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;">ctx.Database.Log </span></span><span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;">=</span><span style="line-height:1.5;"><span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;"> Console.WriteLine;</span>
              }</span></pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">【注意】上下文中的日志被设置到&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">Console.WriteLine</span>&nbsp;;则其所有SQL代码都将会输出在控制台上。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">下面我们进行一些简单的查询、修改利用日志属性来演示在控制台上进行输出（依然利用前一篇文章所给出个三给类，如若不知其关系，请参考前一篇文章）：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>            <span style="color:rgb(0,0,255);line-height:1.5;">using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> ctx = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> EntityDbContext())
            {
               <span style="color:rgb(255,0,0);line-height:1.5;"> ctx.Database.Log </span></span><span style="color:rgb(255,0,0);line-height:1.5;">= Console.WriteLine;<br>
或者<br>
ctx.Database.log = s =&gt; Console.WriteLine(s);
                </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> stu = ctx.Set&lt;Student&gt;().First(p =&gt; p.Name == <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">xpy0928</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
                stu.Grades.First().Fraction </span>= <span style="color:rgb(128,0,128);line-height:1.5;">90</span><span style="line-height:1.5;">;
                stu.Grades.Add(</span><span style="color:rgb(0,0,255);line-height:1.5;">new</span> Grade() { Fraction = <span style="color:rgb(128,0,128);line-height:1.5;">40</span><span style="line-height:1.5;"> });
                ctx.SaveChangesAsync().Wait();
            }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">则在控制台打印如下SQL代码：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images0.cnblogs.com/blog2015/589642/201508/232340232853229.png" alt="" style="border:0px;"></p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">&nbsp;日志记录内容</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">（1）各种SQL命令</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">　　　　查询语句。例如：Linq查询、原始SQL查询</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">　　　　<span style="line-height:1.5;">作为SaveChanges的一部分的插入(inserted)、修改(update)以及删除(delete)</span></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">　　　　由延迟加载自动生成的关联查询</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">（2）参数</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">（3）是否正在被异步执行的命令</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">（4）当命令开始执行时，时间戳的显示</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">（5）无论命令是否被成功完成，还是通过抛出异常而失败或者是通过异步被取消</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">（6）一些显示结果的值</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">（7）执行命令所需要的时间</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">输出日志</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">依上述，将日志输出在控制台是so easy，像这种输出在控制台中只能作为一些小demo，所以应用性不广，如果你要是在window form中或者是Web应用程序中的话，完全可以将日志输出在内存、文件等中。下面演示输出到文件中，其余不予演示。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>            <span style="color:rgb(0,0,255);line-height:1.5;">using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> ctx = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> EntityDbContext())
            {<br></span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> sw = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> StreamWriter(<span style="color:rgb(128,0,0);line-height:1.5;">@"</span><span style="color:rgb(128,0,0);line-height:1.5;">d:\Data.log</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>) { AutoFlush = <span style="color:rgb(0,0,255);line-height:1.5;">true</span><span style="line-height:1.5;"> };<br>
ctx.Database.Log </span>= s =&gt;<span style="line-height:1.5;"> {
                    sw.Write(s);
                };
           }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">结果文件中输出如下：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images0.cnblogs.com/blog2015/589642/201508/251925175157589.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><span style="font-size:16px;color:rgb(255,0,0);">那么问题来了，如果我们需要将输出的内容进行格式化，那么我们应该怎样通过一种简单的方式怎来做呢？</span></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><span style="font-size:12px;color:rgb(0,0,0);">稍等，容我一一讲来。</span></p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">日志结果</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">默认的日志记录器记录sql语句文本，参数以及在命令发到数据库之前带着时间戳的“Executeing”（通过上述文本可知）。一个“Completed”（完成的）包含总的时间被记录在执行命令的下面。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">【注意】异步命令中的“Completed”是直到异步任务执行完成、失败或者被取消才被记录下来，当然，它因不同的命令和是否成功执行而产生不同的信息。</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">执行成功</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">成功完成输出的是如上述文件中的&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">执行-- 已在&nbsp;<span style="color:rgb(128,0,128);line-height:1.5;">0</span>&nbsp;毫秒内完成，结果为: SqlDataReader</span>&nbsp;</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">执行失败</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">通过异常来告知失败，输出中包含了失败的信息。</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">执行取消</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">异步命令中的任务被取消会通过异常来告知结果是失败的。因为当试图去取消时，底层的ADO.NET会这样操作，而EF是基于ADO.NET的。</p> 
   <h1 style="font-size:28px;line-height:1.5;font-family:'Helvetica Neue', Arial;">日志格式化</h1> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">在Database.log属性下我们要充分使用&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">DatabaseLogFormatter</span>&nbsp;对象，这个对象有效结合了&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">IDbCommandInterceptor</span>&nbsp;来实现，通过接受一个字符串的委托和上下文。这意味着在DatabaseLogFormatter上截取方法之前和通过EF执行命令之后被调用，这些DatabaseLogFormatter方法获取有格式的日志并将其传递给一个委托代理。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">通过从DatabaseLogFormatter上派生出一个类并且适当的重写其方法就能实现有格式的日志输出。重写最常用的方法有以下三者：</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">&nbsp;LogCommand&nbsp;</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">在命令被执行之前重写此方法来进行更改。通过默认的LogCommand来调用LogParameter的每个参数。当然你也可以进行重写或者处理参数不同。</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">&nbsp;LogResult&nbsp;</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">重写此方法来更改原有执行命令后记录下来的结果。</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">&nbsp;LogParameter</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">重写此方法来更改其格式和参数所记录的内容。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;例如，在每条命令被发送到数据库之前，我们想仅仅通过单行来进行记录。这就需要重写两个方法：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">（1）重写&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">LogCommand</span>&nbsp;来得到SQL单行的格式</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">（2）重写&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">LogResult</span>&nbsp;不需要做任何动作。（当执行时让其执行可重写的，因为这样在性能上可能会稍微高效一点，但是在功能还是等同的）</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">依据上述，下面我们来写出代码</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> SingleLineFormatter : <span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;">DatabaseLogFormatter</span>
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> SingleLineFormatter(DbContext ctx, Action&lt;<span style="color:rgb(0,0,255);line-height:1.5;">string</span>&gt;<span style="line-height:1.5;"> action)
            : </span><span style="color:rgb(0,0,255);line-height:1.5;">base</span><span style="line-height:1.5;">(ctx, action)
        {

        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">override</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span> LogCommand&lt;TResult&gt;(System.Data.Common.DbCommand command, DbCommandInterceptionContext&lt;TResult&gt;<span style="line-height:1.5;"> interceptionContext)
        {
          <span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;"> Write( </span></span><span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;">string.Format("DbContext '{0}' is Executing Command '{1}' '{2}'",
                Context.GetType().Name,
                command.CommandText.Replace(Environment.NewLine,""</span><span style="line-height:1.5;"><span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;">), Environment.NewLine));</span><br></span><span style="color:rgb(0,0,255);line-height:1.5;">base</span>.LogCommand&lt;TResult&gt;<span style="line-height:1.5;">(command, interceptionContext);
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">override</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span> LogResult&lt;TResult&gt;(System.Data.Common.DbCommand command, DbCommandInterceptionContext&lt;TResult&gt;<span style="line-height:1.5;"> interceptionContext)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">base</span>.LogResult&lt;TResult&gt;<span style="line-height:1.5;">(command, interceptionContext);
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">上述日志输出会调用&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">Write</span>&nbsp;方法，此方法将输出发送到配置的写入委托。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">【注意】上述代码只是通过一种简单的方式除去换行符，如果是在复杂的SQL语句中，上述方式可能会没有效果。</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">设置DatabaseLogFormatter</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;一旦DatabaseLogFormatter的派生类被创建，那么你需要将其注册到EF中，否则也无法进行格式化输出。通过使用<a href="https://msdn.microsoft.com/en-us/data/jj680699" rel="nofollow" style="text-decoration:none;color:rgb(45,161,45);">Code-Based Configuration</a>，这也就是说，创建一个新的继承自DbConfiguration的类与DbContext上下文类所在同一个程序集，然后会在创建的新类的构造函数中调用&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">SetDatabaseLogFormatter</span>&nbsp;方法，该方法接受的参数就是格式化类中构造函数中的两个参数。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">    public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> DbContextConfiguration : DbConfiguration
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> DbContextConfiguration()
        {
            <span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;">SetDatabaseLogFormatter</span>(
                (context, action) </span>=&gt; <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> SingleLineFormatter(context, action));
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">基于上我们新创建的&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">SingleLineFormatter</span>&nbsp;会应用在设置使用Database.log的任何时刻，所以你会看到如下结果：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;<img src="https://images0.cnblogs.com/blog2015/589642/201508/252133182191488.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;接下来我们将看&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">IDbCommandInterceptor</span>&nbsp;实现直接来控制命令的拦截，并通过集成使用NLog的例子而不使用Database.log。请继续往下看</p> 
   <h1 style="font-size:28px;line-height:1.5;font-family:'Helvetica Neue', Arial;">低级构造块监听</h1> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">接口监听</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">监听代码实际上是监听接口的概念。这些接口来继承自&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">IDbInterceptor</span>&nbsp;并且当EF有所行为时其定义的方法会被调用。其意义是在每个对象被截获时都有一个接口。例如，当EF调用ExecuteNonQuery, ExecuteScalar, ExecuteReader等相关的方法时在IDbInterceptor上定义的方法将会被调用。同样，当每个操作完成这些方法也会被调用，上述中的DatabaseLogFormatter类就实现了这个接口来记录命令。</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">接口存在的意义</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">（1）为了记录SQL命令</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">（2）为了支持并实现一些其他特性</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">处理结果</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">泛型&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">DbCommandInterceptionContext&lt;&gt;</span>&nbsp;类里面包含几个属性称之为Result, OriginalResult, Exception, and OriginalException。这些方法会被设置为空通过在操作被执行之前调用的拦截方法。如果操作被成功执行，那么&nbsp;Result and OriginalResult会被设置成操作的结果。这些值会被在操作执行完后的监听方法所监控。同理，如果操作抛出异常，那么Exception and OriginalException将会被设置。</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">禁止执行</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">如果一个监听者在命令快执行完之前设置了Result属性的话，那么EF实际上是不会试图去执行该命令，但是代替的是仅仅是使用结果集。换言之，这个监听者会禁止命令的执行，但是EF会继续，就好像命令已经被执行了。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">发生上述禁止执行的示例可能是经过包装的批处理命令，这个监听者会将其储存以便日后将用于批处理但是会装到EF中一如往常的执行该命令。注意监听者需要更多这来实现批处理。</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">执行后改变结果</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">如果一个监听者在命令执行完后设置了Result属性，那么EF将会使用改变后的结果而不是通过此操作返回实际的结果。同样，如果一个监听者在命令执行完后设置了Exception属性，那么EF将抛出设置的异常，就好像此操作已经抛出了这个异常一样。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">一个监听者也可以设置Exception属性为空来表明没有异常应该被抛出。这其实是非常有意义的，如果执行操作失败但是监听者希望EF继续运行就好像操作成功执行了一样。</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">OriginalResult 和OriginalException</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">在EF执行完一个操作后，如果该操作未失败将设置Result和OriginalResult属性，或者如果执行失败抛出异常那么将设置Exception和OrigianlException。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">在实际执行完一个操作之后，&nbsp;OriginalResult和OriginalException会被EF设置为只读的。这些属性不会被监听者所设置。这也就意味着，任何监听者能区分Exception（异常）和Result（结果），那些会通过一些其他的相对于操作被执行时发生的真实的异常（Exception）和结果（Result）的监听者所设置。</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">&nbsp;注册监听者</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;一旦创建了一个实现了一个或者多个监听接口的类需要通过&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">&nbsp;DbInterception</span>&nbsp;注册到EF中。例如：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre><span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;">DbInterception.Add(new NLogCommandInterceptor());</span></pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">监听者也能够使用基于代码的配置机制（Code-Based DbConfiguration ）被注册在应用程序域中。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">下面我们将基于以上描述通过使用&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">IDbCommandInterceptor</span>&nbsp;，来讲述一个实例：&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(255,0,0);font-family:'Courier New';font-size:18px;">Log To NLog</span>&nbsp;（通过NLog进行日志记录）（关于NLog请看这里：<a href="https://github.com/NLog/NLog/wiki/Tutorial" rel="nofollow" style="text-decoration:none;color:rgb(45,161,45);">NLog Tutorial</a>）</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">记录如下日志：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">（1）执行非异步的命令作为Warning（警告）</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">（2）执行抛出的异常作为Error（严重错误）</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">    public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> NLogCommandInterceptor : <span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;">IDbCommandInterceptor</span>
    {
        
        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">readonly</span> <span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;">Logger</span> Logger =<span style="line-height:1.5;"><span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;"> LogManager</span>.GetCurrentClassLogger();

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> NonQueryExecuting(
            DbCommand command, DbCommandInterceptionContext</span>&lt;<span style="color:rgb(0,0,255);line-height:1.5;">int</span>&gt;<span style="line-height:1.5;"> interceptionContext)
        {
            LogIfNonAsync(command, interceptionContext);
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> NonQueryExecuted(
            DbCommand command, DbCommandInterceptionContext</span>&lt;<span style="color:rgb(0,0,255);line-height:1.5;">int</span>&gt;<span style="line-height:1.5;"> interceptionContext)
        {
            LogIfError(command, interceptionContext);
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> ReaderExecuting(
            DbCommand command, DbCommandInterceptionContext</span>&lt;DbDataReader&gt;<span style="line-height:1.5;"> interceptionContext)
        {
            LogIfNonAsync(command, interceptionContext);
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> ReaderExecuted(
            DbCommand command, DbCommandInterceptionContext</span>&lt;DbDataReader&gt;<span style="line-height:1.5;"> interceptionContext)
        {
            LogIfError(command, interceptionContext);
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> ScalarExecuting(
            DbCommand command, DbCommandInterceptionContext</span>&lt;<span style="color:rgb(0,0,255);line-height:1.5;">object</span>&gt;<span style="line-height:1.5;"> interceptionContext)
        {
            LogIfNonAsync(command, interceptionContext);
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> ScalarExecuted(
            DbCommand command, DbCommandInterceptionContext</span>&lt;<span style="color:rgb(0,0,255);line-height:1.5;">object</span>&gt;<span style="line-height:1.5;"> interceptionContext)
        {
            LogIfError(command, interceptionContext);
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span> LogIfNonAsync&lt;TResult&gt;<span style="line-height:1.5;">(
            DbCommand command, DbCommandInterceptionContext</span>&lt;TResult&gt;<span style="line-height:1.5;"> interceptionContext)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (!<span style="line-height:1.5;">interceptionContext.IsAsync)
            {
               <span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;"> Logger.Warn(</span></span><span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;">"Non-async command used: {0}"</span><span style="line-height:1.5;"><span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;">, command.CommandText);</span>
            }
        }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span> LogIfError&lt;TResult&gt;<span style="line-height:1.5;">(
            DbCommand command, DbCommandInterceptionContext</span>&lt;TResult&gt;<span style="line-height:1.5;"> interceptionContext)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (interceptionContext.Exception != <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">)
            {
               <span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;"> Logger.Error(</span></span><span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;">"Command {0} failed with exception {1}"</span><span style="line-height:1.5;"><span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;">, command.CommandText, interceptionContext.Exception);</span>
            }
        }

       
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">结果如下：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images0.cnblogs.com/blog2015/589642/201508/261423183447401.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">【注意】上述NLog得安装如下程序包</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images0.cnblogs.com/blog2015/589642/201508/261425550784416.png" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">接下来在NLog.config中rules和target节点下进行简单的配置输出日志即可，如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>  &lt;rules&gt; 
    &lt;logger name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ConsoleApplication1.NLogCommandInterceptor</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> minlevel=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Info</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> writeTo=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">f</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>&gt;&lt;/logger&gt; <br><span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;"> /*name为命名空间+实现IDbCommandInterceptor接口的监控类名称，f为写到下面target中的name*/</span>
  &lt;/rules&gt;</pre>
   </div> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>  &lt;targets&gt;
    &lt;target name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">f</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> xsi:type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">File</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> fileName=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">c:\temp\log.txt</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
  &lt;/targets&gt;</pre>
   </div> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">监听中的Dispatch方法</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">除了在&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">DbInterception</span>&nbsp;中注册方法外，它也提供了Dispatch方法，此方法允许代码不是分配到监听的通知的一部分，这是以上已经提到的机制，允许提供者让监听者知道在EF的控制下，一条命令正在被执行。不过对于应用程序开发者去使用Dispatch API这是比较少见的。下面了解下这个方法如何去操作。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>DbInterception.Dispatch.Command.NonQueryAsync(myCommand, <span style="color:rgb(0,0,255);line-height:1.5;">new</span> DbCommandInterceptionContext());</pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">以上代码做了以下五件事：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">（1）确保被设置到监听上下文中的命令是否是&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">&nbsp;IsAsync&nbsp;</span>&nbsp;的</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">（2）调用所有注册在&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">IDbCommandInterceptors</span>&nbsp;中的&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">NonQueryExecuting&nbsp;</span>&nbsp;方法</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">（3）除非如以上所说这些&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">NonQueryExecuting</span>&nbsp;方法之一被设置了Result属性，否则调用&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">ExecuteNonQueryAsync&nbsp;</span>&nbsp;</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">（4）在异步任务中设置了延续，使得注册在&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">IDbCommandInterceptors</span>&nbsp;上的所有&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">NonQueryExecuted</span>&nbsp;方法都被调用</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">（5）使得任务结果中包含了可能已经被监听集合中的方法之一改变了的正确结果</p> 
   <h1 style="font-size:28px;line-height:1.5;font-family:'Helvetica Neue', Arial;">打开日志无需重新编译(EF 6.1)</h1> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">上述我们是通过手动操作来进行日志的输出，如果你嫌麻烦，大可在配置文件（web.config或App.config）中的&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">EntityFramework</span>&nbsp;节点下进行相关配置来完成日志输出工作。</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">（1）输出到控制台</h2> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>&lt;interceptors&gt;
  &lt;interceptor type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">System.Data.Entity.Infrastructure.Interception.DatabaseLogger, EntityFramework</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
&lt;/interceptors&gt;</pre>
   </div> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">（2）输出到文件</h2> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>&lt;interceptors&gt;
  &lt;interceptor type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">System.Data.Entity.Infrastructure.Interception.DatabaseLogger, EntityFramework</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>&gt;
    &lt;parameters&gt;
      &lt;parameter value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">c:\temp\log.txt</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
    &lt;/parameters&gt;
  &lt;/interceptor&gt;
&lt;/interceptors&gt;</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">如下结果：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images0.cnblogs.com/blog2015/589642/201508/261251537196850.png" alt="" style="border:0px;">&nbsp;</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">【注意】上述默认情况下，当应用程序每次启动会重新生成一个新的log.text，则此前的将被覆盖。如果该文件总是存在的话，为了追加到到日志文件中，可以进行如下操作：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>&lt;interceptors&gt;
  &lt;interceptor type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">System.Data.Entity.Infrastructure.Interception.DatabaseLogger, EntityFramework</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>&gt;
    &lt;parameters&gt;
      &lt;parameter value=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">c:\temp\log.txt</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
    <span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;">  &lt;parameter value="true" type="System.Boolean"/&gt;</span>
    &lt;/parameters&gt;
  &lt;/interceptor&gt;
&lt;/interceptors&gt;</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">上述就是通过注册监听集合下的interceptor（监听者）来进行日志输出。</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">IDbConfigurationInterceptor</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">在EF6.1中引入了此接口，它是一个当应用程序启动时允许代码检测或者修改EF configuration的监听接口。通过这个我们能够实现一个关于&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">DatabaseLogger</span>&nbsp;的简单版本</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> ExampleDatabaseLogger : IDbConfigurationInterceptor
{
    </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> Loaded(
        DbConfigurationLoadedEventArgs loadedEventArgs,
        DbConfigurationInterceptionContext interceptionContext)
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> formatterFactory =<span style="line-height:1.5;"> loadedEventArgs
                .DependencyResolver
                .GetService</span>&lt;Func&lt;DbContext, Action&lt;<span style="color:rgb(0,0,255);line-height:1.5;">string</span>&gt;, DatabaseLogFormatter&gt;&gt;<span style="line-height:1.5;">();
 
        </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> formatter = formatterFactory(<span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">, Console.Write);
 
        DbInterception.Add(formatter);
    }
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">我们来分析下上述代码：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">（1）第一行要求EF去注册&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">DatabaseLogFormatter</span>&nbsp;工厂，上述我们只是新建了一个&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">&nbsp;DatabaseLogFormatter</span>&nbsp;来代替，当然如果应用程序在此行自定义了格式化&nbsp;，那么将通过用此自定义的而不会是默认的</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">（2）第一行实际上是没有获得DatabaseLogFormatter，它只是获得一个来创建DatabaseLogFormatter实例的一个工厂，第二行调用工厂来获得一个实际意义上的formatter实例。因为我们要记录所有上下文实例，所以为空也是允许的。工厂的第二个参数是对于控制台输出流的委托，因此我们只需将指针指向Console.Write()方法即可。同理如果我们要将日志记录到文件中，则需要通过StreanWrite的实例来实现，上述已经演示。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">（3）第三行将DatabaseLogFormatter作为一个监听者来进行注册，在EF中如何就监听者来进行日志记录，上述已经描述。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p><font color="#111111"><span style="font-size:13px;line-height:23.4px;">本文转自Jeffcky博客园博客，原文链接：http://www.cnblogs.com/CreateMyself/p/4753476.html，如需转载请自行联系原作者</span></font><br></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
