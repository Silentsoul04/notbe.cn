<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>进程间通信（IPC）介绍 « NotBeCN</title>
  <meta name="description" content="             进程间通信（IPC，InterProcess Communication）是指在不同进程之间传播或交换信息。    IPC的方式通常有管道（包括无名管道和命名管道）、消息队列、信号量、共享存储、Socket、Streams等。其中 Socket和Streams支持不同主机上的两个进程IP...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/14/weixin_33938733_90122277.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">进程间通信（IPC）介绍</h1>
    <p class="post-meta">Nov 14, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong>进程间通信（IPC，InterProcess Communication）</strong>是指在不同进程之间传播或交换信息。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">IPC的方式通常有管道（包括无名管道和命名管道）、消息队列、信号量、共享存储、Socket、Streams等。其中 Socket和Streams支持不同主机上的两个进程IPC。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">以Linux中的C语言编程为例。</p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">一、管道</h2> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong>管道</strong>，通常指无名管道，是 UNIX 系统IPC最古老的形式。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">1、特点：</h3> 
   <ol style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style-type:decimal;"> <p>它是半双工的（即数据只能在一个方向上流动），具有固定的读端和写端。</p> </li> 
    <li style="list-style-type:decimal;"> <p>它只能用于具有亲缘关系的进程之间的通信（也是父子进程或者兄弟进程之间）。</p> </li> 
    <li style="list-style-type:decimal;"> <p>它可以看成是一种特殊的文件，对于它的读写也可以使用普通的read、write 等函数。但是它不是普通的文件，并不属于其他任何文件系统，并且只存在于内存中。</p> </li> 
   </ol>
   <h2 style="font-size:21px;line-height:1.5;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">一、管道</h2> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong>管道</strong>，通常指无名管道，是 UNIX 系统IPC最古老的形式。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">1、特点：</h3> 
   <ol style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style-type:decimal;"> <p>它是<span style="color:rgb(255,0,0);">半双工</span>的（即数据只能在一个方向上流动），具有固定的读端和写端。</p> </li> 
    <li style="list-style-type:decimal;"> <p>它只能用于具有<span style="color:rgb(255,0,0);">亲缘关系</span>的进程之间的通信（也是父子进程或者兄弟进程之间）。</p> </li> 
    <li style="list-style-type:decimal;"> <p>它可以看成是一种特殊的文件，对于它的读写也可以使用普通的read、write 等函数。但是它不是普通的文件，并不属于其他任何文件系统，并且<span style="color:rgb(255,0,0);">只存在于内存</span>中。</p> </li> 
   </ol>
   <h3 style="font-size:16px;line-height:1.5;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">2、原型：</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">1</span> #include &lt;unistd.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">2</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> pipe(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> fd[<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">2</span>]);    <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 返回值：若成功返回0，失败返回-1</span></pre>
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">当一个管道建立时，它会创建两个文件描述符：<code>fd[0]</code>为读而打开，<code>fd[1]</code>为写而打开。如下图：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><img src="https://images2015.cnblogs.com/blog/323808/201603/323808-20160311093936866-901519688.png" alt="" style="border:none;"></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">要关闭管道只需将这两个文件描述符关闭即可。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">3、例子</h3> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">单个进程中的管道几乎没有任何用处。所以，通常调用 pipe 的进程接着调用 fork，这样就创建了父进程与子进程之间的 IPC 通道。如下图所示：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><img src="https://images2015.cnblogs.com/blog/323808/201603/323808-20160311094030069-935122142.png" alt="" style="border:none;"></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">若要数据流从父进程流向子进程，则关闭父进程的读端（<code>fd[0]</code>）与子进程的写端（<code>fd[1]</code>）；反之，则可以使数据流从子进程流向父进程。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 1</span> #include&lt;stdio.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 2</span> #include&lt;unistd.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 3</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 4</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> main()
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 5</span> <span style="font-size:12px;line-height:1.5;">{
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 6</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> fd[<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">2</span>];  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 两个文件描述符</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 7</span> <span style="font-size:12px;line-height:1.5;">    pid_t pid;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 8</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span> buff[<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">20</span><span style="font-size:12px;line-height:1.5;">];
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 9</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">10</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(pipe(fd) &lt; <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>)  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 创建管道</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">11</span>         printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Create Pipe Error!\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">12</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">13</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>((pid = fork()) &lt; <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>)  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 创建子进程</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">14</span>         printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Fork Error!\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">15</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">else</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(pid &gt; <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>)  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 父进程</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">16</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">17</span>         close(fd[<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>]); <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 关闭读端</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">18</span>         write(fd[<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>], <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">hello world\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">12</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">19</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">20</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">else</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">21</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">22</span>         close(fd[<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>]); <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 关闭写端</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">23</span>         read(fd[<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>], buff, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">20</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">24</span>         printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">%s</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, buff);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">25</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">26</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">27</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">28</span> }</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">二、FIFO</h2> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong>FIFO</strong>，也称为命名管道，它是一种文件类型。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">1、特点</h3> 
   <ol style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style-type:decimal;"> <p>FIFO可以在<span style="color:rgb(255,0,0);">无关的进程</span>之间交换数据，与无名管道不同。</p> </li> 
    <li style="list-style-type:decimal;"> <p>FIFO有路径名与之相关联，它以一种特殊设备文件形式存在于<span style="color:rgb(255,0,0);">文件系统</span>中。</p> </li> 
   </ol>
   <h3 style="font-size:16px;line-height:1.5;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">2、原型</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">1</span> #include &lt;sys/stat.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">2</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 返回值：成功返回0，出错返回-1</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">3</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> mkfifo(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">const</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span> *pathname, mode_t mode);</pre>
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">其中的 mode 参数与<code>open</code>函数中的 mode 相同。一旦创建了一个 FIFO，就可以用一般的文件I/O函数操作它。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">当 open 一个FIFO时，是否设置非阻塞标志（<code>O_NONBLOCK</code>）的区别：</p> 
   <ul style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style-type:disc;"> <p>若没有指定<code>O_NONBLOCK</code>（默认），只读 open 要阻塞到某个其他进程为写而打开此 FIFO。类似的，只写 open 要阻塞到某个其他进程为读而打开它。</p> </li> 
    <li style="list-style-type:disc;"> <p>若指定了<code>O_NONBLOCK</code>，则只读 open 立即返回。而只写 open 将出错返回 -1 如果没有进程已经为读而打开该 FIFO，其errno置ENXIO。</p> </li> 
   </ul>
   <h3 style="font-size:16px;line-height:1.5;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">3、例子</h3> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">FIFO的通信方式类似于在进程中使用文件来传输数据，只不过FIFO类型文件同时具有管道的特性。在数据读出时，FIFO管道中同时清除数据，并且“先进先出”。下面的例子演示了使用 FIFO 进行 IPC 的过程：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">write_fifo.c</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 1</span> #include&lt;stdio.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 2</span> #include&lt;stdlib.h&gt;   <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> exit</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 3</span> #include&lt;fcntl.h&gt;    <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> O_WRONLY</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 4</span> #include&lt;sys/stat.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 5</span> #include&lt;time.h&gt;     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> time</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 6</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 7</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> main()
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 8</span> <span style="font-size:12px;line-height:1.5;">{
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 9</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> fd;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">10</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> n, i;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">11</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span> buf[<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1024</span><span style="font-size:12px;line-height:1.5;">];
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">12</span> <span style="font-size:12px;line-height:1.5;">    time_t tp;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">13</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">14</span>     printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">I am %d process.\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>, getpid()); <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 说明进程ID</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">15</span>     
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">16</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>((fd = open(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">fifo1</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>, O_WRONLY)) &lt; <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>) <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 以写打开一个FIFO </span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">17</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">18</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Open FIFO Failed</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">19</span>         exit(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">20</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">21</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">22</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span>(i=<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>; i&lt;<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">10</span>; ++<span style="font-size:12px;line-height:1.5;">i)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">23</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">24</span>         time(&amp;tp);  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 取系统当前时间</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">25</span>         n=sprintf(buf,<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Process %d's time is %s</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>,getpid(),ctime(&amp;<span style="font-size:12px;line-height:1.5;">tp));
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">26</span>         printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Send message: %s</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>, buf); <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 打印</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">27</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(write(fd, buf, n+<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>) &lt; <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>)  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 写入到FIFO中</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">28</span> <span style="font-size:12px;line-height:1.5;">        {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">29</span>             perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Write FIFO Failed</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">30</span> <span style="font-size:12px;line-height:1.5;">            close(fd);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">31</span>             exit(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">32</span> <span style="font-size:12px;line-height:1.5;">        }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">33</span>         sleep(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>);  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 休眠1秒</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">34</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">35</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">36</span>     close(fd);  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 关闭FIFO文件</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">37</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">38</span> }</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">read_fifo.c</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 1</span> #include&lt;stdio.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 2</span> #include&lt;stdlib.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 3</span> #include&lt;errno.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 4</span> #include&lt;fcntl.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 5</span> #include&lt;sys/stat.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 6</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 7</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> main()
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 8</span> <span style="font-size:12px;line-height:1.5;">{
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 9</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> fd;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">10</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> len;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">11</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span> buf[<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1024</span><span style="font-size:12px;line-height:1.5;">];
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">12</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">13</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(mkfifo(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">fifo1</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0666</span>) &lt; <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span> &amp;&amp; errno!=EEXIST) <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 创建FIFO管道</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">14</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Create FIFO Failed</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">15</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">16</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>((fd = open(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">fifo1</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>, O_RDONLY)) &lt; <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>)  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 以读打开FIFO</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">17</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">18</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Open FIFO Failed</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">19</span>         exit(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">20</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">21</span>     
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">22</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">while</span>((len = read(fd, buf, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1024</span>)) &gt; <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>) <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 读取FIFO管道</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">23</span>         printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Read message: %s</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, buf);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">24</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">25</span>     close(fd);  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 关闭FIFO文件</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">26</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">27</span> }</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">在两个终端里用 gcc 分别编译运行上面两个文件，可以看到输出结果如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 1</span> [cheesezh@localhost]$ ./<span style="font-size:12px;line-height:1.5;">write_fifo 
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 2</span> I am <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">5954</span><span style="font-size:12px;line-height:1.5;"> process.
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 3</span> Send message: Process <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">5954</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">s time is Mon Apr 20 12:37:28 2015</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 4</span> Send message: Process <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">5954</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">s time is Mon Apr 20 12:37:29 2015</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 5</span> Send message: Process <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">5954</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">s time is Mon Apr 20 12:37:30 2015</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 6</span> Send message: Process <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">5954</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">s time is Mon Apr 20 12:37:31 2015</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 7</span> Send message: Process <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">5954</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">s time is Mon Apr 20 12:37:32 2015</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 8</span> Send message: Process <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">5954</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">s time is Mon Apr 20 12:37:33 2015</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 9</span> Send message: Process <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">5954</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">s time is Mon Apr 20 12:37:34 2015</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">10</span> Send message: Process <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">5954</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">s time is Mon Apr 20 12:37:35 2015</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">11</span> Send message: Process <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">5954</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">s time is Mon Apr 20 12:37:36 2015</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">12</span> Send message: Process <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">5954</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">s time is Mon Apr 20 12:37:37 2015</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 1</span> [cheesezh@localhost]$ ./<span style="font-size:12px;line-height:1.5;">read_fifo 
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 2</span> Read message: Process <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">5954</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">s time is Mon Apr 20 12:37:28 2015</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 3</span> Read message: Process <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">5954</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">s time is Mon Apr 20 12:37:29 2015</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 4</span> Read message: Process <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">5954</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">s time is Mon Apr 20 12:37:30 2015</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 5</span> Read message: Process <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">5954</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">s time is Mon Apr 20 12:37:31 2015</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 6</span> Read message: Process <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">5954</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">s time is Mon Apr 20 12:37:32 2015</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 7</span> Read message: Process <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">5954</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">s time is Mon Apr 20 12:37:33 2015</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 8</span> Read message: Process <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">5954</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">s time is Mon Apr 20 12:37:34 2015</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 9</span> Read message: Process <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">5954</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">s time is Mon Apr 20 12:37:35 2015</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">10</span> Read message: Process <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">5954</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">s time is Mon Apr 20 12:37:36 2015</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">11</span> Read message: Process <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">5954</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">s time is Mon Apr 20 12:37:37 2015</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">上述例子可以扩展成 客户进程—服务器进程 通信的实例，<code>write_fifo</code>的作用类似于客户端，可以打开多个客户端向一个服务器发送请求信息，<code>read_fifo</code>类似于服务器，它适时监控着FIFO的读端，当有数据时，读出并进行处理，但是有一个关键的问题是，每一个客户端必须预先知道服务器提供的FIFO接口，下图显示了这种安排：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><img src="https://images2015.cnblogs.com/blog/323808/201603/323808-20160311094842257-893623615.png" alt="" style="border:none;"></p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">三、消息队列</h2> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong>消息队列</strong>，是消息的链接表，<span style="color:rgb(255,0,0);">存放在内核中</span>。一个消息队列由一个标识符（即队列ID）来标识。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">1、特点</h3> 
   <ol style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style-type:decimal;"> <p>消息队列是面向记录的，其中的消息具有特定的<span style="color:rgb(255,0,0);">格式</span>以及特定的<span style="color:rgb(255,0,0);">优先级</span>。</p> </li> 
    <li style="list-style-type:decimal;"> <p>消息队列<span style="color:rgb(255,0,0);">独立</span>于发送与接收进程。进程终止时，消息队列及其内容并不会被删除。</p> </li> 
    <li style="list-style-type:decimal;"> <p>消息队列可以实现消息的<span style="color:rgb(255,0,0);">随机查询</span>,消息不一定要以先进先出的次序读取,也可以按消息的类型读取。</p> </li> 
   </ol>
   <h3 style="font-size:16px;line-height:1.5;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">2、原型</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">1</span> #include &lt;sys/msg.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">2</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 创建或打开消息队列：成功返回队列ID，失败返回-1</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">3</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> msgget(key_t key, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> flag);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">4</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 添加消息：成功返回0，失败返回-1</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">5</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> msgsnd(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> msqid, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">const</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> *ptr, size_t size, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> flag);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">6</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 读取消息：成功返回消息数据的长度，失败返回-1</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">7</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> msgrcv(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> msqid, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> *ptr, size_t size, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">long</span> type,<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> flag);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">8</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 控制消息队列：成功返回0，失败返回-1</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">9</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> msgctl(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> msqid, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> cmd, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span> msqid_ds *buf);</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">在以下两种情况下，<code>msgget</code>将创建一个新的消息队列：</p> 
   <ul style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style-type:disc;">如果没有与键值key相对应的消息队列，并且flag中包含了<code>IPC_CREAT</code>标志位。</li> 
    <li style="list-style-type:disc;">key参数为<code>IPC_PRIVATE</code>。</li> 
   </ul>
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">函数<code>msgrcv</code>在读取消息队列时，type参数有下面几种情况：</p> 
   <ul style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style-type:disc;"> <code>type == 0</code>，返回队列中的第一个消息；</li> 
    <li style="list-style-type:disc;"> <code>type &gt; 0</code>，返回队列中消息类型为 type 的第一个消息；</li> 
    <li style="list-style-type:disc;"> <code>type &lt; 0</code>，返回队列中消息类型值小于或等于 type 绝对值的消息，如果有多个，则取类型值最小的消息。</li> 
   </ul>
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">可以看出，type值非 0 时用于以非先进先出次序读消息。也可以把 type 看做优先级的权值。（其他的参数解释，请自行Google之）</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">3、例子</h3> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">下面写了一个简单的使用消息队列进行IPC的例子，服务端程序一直在等待特定类型的消息，当收到该类型的消息以后，发送另一种特定类型的消息作为反馈，客户端读取该反馈并打印出来。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">msg_server.c</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 1</span> #include &lt;stdio.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 2</span> #include &lt;stdlib.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 3</span> #include &lt;sys/msg.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 4</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 5</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 用于创建一个唯一的key</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 6</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">#define</span> MSG_FILE "/etc/passwd"
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 7</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 8</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 消息结构</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 9</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span><span style="font-size:12px;line-height:1.5;"> msg_form {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">10</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">long</span><span style="font-size:12px;line-height:1.5;"> mtype;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">11</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span> mtext[<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">256</span><span style="font-size:12px;line-height:1.5;">];
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">12</span> <span style="font-size:12px;line-height:1.5;">};
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">13</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">14</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> main()
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">15</span> <span style="font-size:12px;line-height:1.5;">{
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">16</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> msqid;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">17</span> <span style="font-size:12px;line-height:1.5;">    key_t key;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">18</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span><span style="font-size:12px;line-height:1.5;"> msg_form msg;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">19</span>     
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">20</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 获取key值</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">21</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>((key = ftok(MSG_FILE,<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">z</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span>)) &lt; <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">22</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">23</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">ftok error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">24</span>         exit(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">25</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">26</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">27</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 打印key值</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">28</span>     printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Message Queue - Server key is: %d.\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, key);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">29</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">30</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 创建消息队列</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">31</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> ((msqid = msgget(key, IPC_CREAT|<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0777</span>)) == -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">32</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">33</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">msgget error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">34</span>         exit(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">35</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">36</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">37</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 打印消息队列ID及进程ID</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">38</span>     printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">My msqid is: %d.\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, msqid);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">39</span>     printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">My pid is: %d.\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, getpid());
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">40</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">41</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 循环读取消息</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">42</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span><span style="font-size:12px;line-height:1.5;">(;;) 
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">43</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">44</span>         msgrcv(msqid, &amp;msg, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">256</span>, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">888</span>, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>);<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 返回类型为888的第一个消息</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">45</span>         printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Server: receive msg.mtext is: %s.\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, msg.mtext);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">46</span>         printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Server: receive msg.mtype is: %d.\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, msg.mtype);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">47</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">48</span>         msg.mtype = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">999</span>; <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 客户端接收的消息类型</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">49</span>         sprintf(msg.mtext, <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">hello, I'm server %d</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, getpid());
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">50</span>         msgsnd(msqid, &amp;msg, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">sizeof</span>(msg.mtext), <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">51</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">52</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">53</span> }</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">msg_client.c</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 1</span> #include &lt;stdio.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 2</span> #include &lt;stdlib.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 3</span> #include &lt;sys/msg.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 4</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 5</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 用于创建一个唯一的key</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 6</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">#define</span> MSG_FILE "/etc/passwd"
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 7</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 8</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 消息结构</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 9</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span><span style="font-size:12px;line-height:1.5;"> msg_form {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">10</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">long</span><span style="font-size:12px;line-height:1.5;"> mtype;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">11</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span> mtext[<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">256</span><span style="font-size:12px;line-height:1.5;">];
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">12</span> <span style="font-size:12px;line-height:1.5;">};
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">13</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">14</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> main()
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">15</span> <span style="font-size:12px;line-height:1.5;">{
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">16</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> msqid;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">17</span> <span style="font-size:12px;line-height:1.5;">    key_t key;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">18</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span><span style="font-size:12px;line-height:1.5;"> msg_form msg;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">19</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">20</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 获取key值</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">21</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> ((key = ftok(MSG_FILE, <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">z</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span>)) &lt; <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">) 
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">22</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">23</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">ftok error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">24</span>         exit(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">25</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">26</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">27</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 打印key值</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">28</span>     printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Message Queue - Client key is: %d.\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, key);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">29</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">30</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 打开消息队列</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">31</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> ((msqid = msgget(key, IPC_CREAT|<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0777</span>)) == -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">) 
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">32</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">33</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">msgget error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">34</span>         exit(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">35</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">36</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">37</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 打印消息队列ID及进程ID</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">38</span>     printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">My msqid is: %d.\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, msqid);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">39</span>     printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">My pid is: %d.\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, getpid());
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">40</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">41</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 添加消息，类型为888</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">42</span>     msg.mtype = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">888</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">43</span>     sprintf(msg.mtext, <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">hello, I'm client %d</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, getpid());
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">44</span>     msgsnd(msqid, &amp;msg, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">sizeof</span>(msg.mtext), <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">45</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">46</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 读取类型为777的消息</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">47</span>     msgrcv(msqid, &amp;msg, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">256</span>, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">999</span>, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">48</span>     printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Client: receive msg.mtext is: %s.\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, msg.mtext);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">49</span>     printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Client: receive msg.mtype is: %d.\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, msg.mtype);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">50</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">51</span> }</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">四、信号量</h2> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong>信号量（semaphore）</strong>与已经介绍过的 IPC 结构不同，它是一个计数器。信号量用于实现进程间的互斥与同步，而不是用于存储进程间通信数据。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">1、特点</h3> 
   <ol style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style-type:decimal;"> <p>信号量用于进程间同步，若要在进程间传递数据需要结合<em>共享内存</em>。</p> </li> 
    <li style="list-style-type:decimal;"> <p>信号量基于操作系统的 PV 操作，程序对信号量的操作都是原子操作。</p> </li> 
    <li style="list-style-type:decimal;"> <p>每次对信号量的 PV 操作不仅限于对信号量值加 1 或减 1，而且可以加减任意正整数。</p> </li> 
    <li style="list-style-type:decimal;"> <p>支持信号量组。</p> </li> 
   </ol>
   <h3 style="font-size:16px;line-height:1.5;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">2、原型</h3> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">最简单的信号量是只能取 0 和 1 的变量，这也是信号量最常见的一种形式，叫做<strong>二值信号量（Binary Semaphore）</strong>。而可以取多个正整数的信号量被称为通用信号量。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">Linux 下的信号量函数都是在通用的信号量数组上进行操作，而不是在一个单一的二值信号量上进行操作。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">1</span> #include &lt;sys/sem.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">2</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 创建或获取一个信号量组：若成功返回信号量集ID，失败返回-1</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">3</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> semget(key_t key, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> num_sems, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> sem_flags);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">4</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 对信号量组进行操作，改变信号量的值：成功返回0，失败返回-1</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">5</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> semop(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> semid, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span><span style="font-size:12px;line-height:1.5;"> sembuf semoparray[], size_t numops);  
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">6</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 控制信号量的相关信息</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">7</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> semctl(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> semid, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> sem_num, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> cmd, ...);</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">当<code>semget</code>创建新的信号量集合时，必须指定集合中信号量的个数（即<code>num_sems</code>），通常为1； 如果是引用一个现有的集合，则将<code>num_sems</code>指定为 0 。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">在<code>semop</code>函数中，<code>sembuf</code>结构的定义如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">1</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span><span style="font-size:12px;line-height:1.5;"> sembuf 
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">2</span> <span style="font-size:12px;line-height:1.5;">{
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">3</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">short</span> sem_num; <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 信号量组中对应的序号，0～sem_nums-1</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">4</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">short</span> sem_op;  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 信号量值在一次操作中的改变量</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">5</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">short</span> sem_flg; <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> IPC_NOWAIT, SEM_UNDO</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">6</span> }</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">其中 sem_op 是一次操作中的信号量的改变量：</p> 
   <ul style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style-type:disc;"> <p>若<code>sem_op &gt; 0</code>，表示进程释放相应的资源数，将 sem_op 的值加到信号量的值上。如果有进程正在休眠等待此信号量，则换行它们。</p> </li> 
    <li style="list-style-type:disc;"> <p>若<code>sem_op &lt; 0</code>，请求 sem_op 的绝对值的资源。</p> 
     <ul>
      <li style="list-style-type:disc;">如果相应的资源数可以满足请求，则将该信号量的值减去sem_op的绝对值，函数成功返回。</li> 
      <li style="list-style-type:disc;">当相应的资源数不能满足请求时，这个操作与<code>sem_flg</code>有关。 
       <ul>
        <li style="list-style-type:disc;">sem_flg 指定<code>IPC_NOWAIT</code>，则semop函数出错返回<code>EAGAIN</code>。</li> 
        <li style="list-style-type:disc;">sem_flg 没有指定<code>IPC_NOWAIT</code>，则将该信号量的semncnt值加1，然后进程挂起直到下述情况发生： 
         <ol>
          <li style="list-style-type:disc;">当相应的资源数可以满足请求，此信号量的semncnt值减1，该信号量的值减去sem_op的绝对值。成功返回；</li> 
          <li style="list-style-type:disc;">此信号量被删除，函数smeop出错返回EIDRM；</li> 
          <li style="list-style-type:disc;">进程捕捉到信号，并从信号处理函数返回，此情况下将此信号量的semncnt值减1，函数semop出错返回EINTR</li> 
         </ol></li> 
       </ul></li> 
     </ul></li> 
    <li style="list-style-type:disc;"> <p>若<code>sem_op == 0</code>，进程阻塞直到信号量的相应值为0：</p> 
     <ul>
      <li style="list-style-type:disc;">当信号量已经为0，函数立即返回。</li> 
      <li style="list-style-type:disc;">如果信号量的值不为0，则依据<code>sem_flg</code>决定函数动作： 
       <ul>
        <li style="list-style-type:disc;">sem_flg指定<code>IPC_NOWAIT</code>，则出错返回<code>EAGAIN</code>。</li> 
        <li style="list-style-type:disc;">sem_flg没有指定<code>IPC_NOWAIT</code>，则将该信号量的semncnt值加1，然后进程挂起直到下述情况发生： 
         <ol>
          <li style="list-style-type:disc;">信号量值为0，将信号量的semzcnt的值减1，函数semop成功返回；</li> 
          <li style="list-style-type:disc;">此信号量被删除，函数smeop出错返回EIDRM；</li> 
          <li style="list-style-type:disc;">进程捕捉到信号，并从信号处理函数返回，在此情况将此信号量的semncnt值减1，函数semop出错返回EINTR</li> 
         </ol></li> 
       </ul></li> 
     </ul></li> 
   </ul>
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">在<code>semctl</code>函数中的命令有多种，这里就说两个常用的：</p> 
   <ul style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style-type:disc;"> <code>SETVAL</code>：用于初始化信号量为一个已知的值。所需要的值作为联合semun的val成员来传递。在信号量第一次使用之前需要设置信号量。</li> 
    <li style="list-style-type:disc;"> <code>IPC_RMID</code>：删除一个信号量集合。如果不删除信号量，它将继续在系统中存在，即使程序已经退出，它可能在你下次运行此程序时引发问题，而且信号量是一种有限的资源。</li> 
   </ul>
   <h3 style="font-size:16px;line-height:1.5;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">3、例子</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  1</span> #include&lt;stdio.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  2</span> #include&lt;stdlib.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  3</span> #include&lt;sys/sem.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  4</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  5</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 联合体，用于semctl初始化</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  6</span> <span style="font-size:12px;line-height:1.5;">union semun
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  7</span> <span style="font-size:12px;line-height:1.5;">{
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  8</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span>              val; <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">for SETVAL</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  9</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span> semid_ds *<span style="font-size:12px;line-height:1.5;">buf;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 10</span>     unsigned <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">short</span>  *<span style="font-size:12px;line-height:1.5;">array;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 11</span> <span style="font-size:12px;line-height:1.5;">};
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 12</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 13</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 初始化信号量</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 14</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> init_sem(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> sem_id, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> value)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 15</span> <span style="font-size:12px;line-height:1.5;">{
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 16</span> <span style="font-size:12px;line-height:1.5;">    union semun tmp;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 17</span>     tmp.val =<span style="font-size:12px;line-height:1.5;"> value;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 18</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(semctl(sem_id, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>, SETVAL, tmp) == -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 19</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 20</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Init Semaphore Error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 21</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 22</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 23</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 24</span> <span style="font-size:12px;line-height:1.5;">}
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 25</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 26</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> P操作:
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 27</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    若信号量值为1，获取资源并将信号量值-1 
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 28</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    若信号量值为0，进程挂起等待</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 29</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> sem_p(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> sem_id)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 30</span> <span style="font-size:12px;line-height:1.5;">{
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 31</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span><span style="font-size:12px;line-height:1.5;"> sembuf sbuf;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 32</span>     sbuf.sem_num = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>; <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">序号</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 33</span>     sbuf.sem_op = -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>; <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">P操作</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 34</span>     sbuf.sem_flg =<span style="font-size:12px;line-height:1.5;"> SEM_UNDO;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 35</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 36</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(semop(sem_id, &amp;sbuf, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>) == -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 37</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 38</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">P operation Error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 39</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 40</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 41</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 42</span> <span style="font-size:12px;line-height:1.5;">}
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 43</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 44</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> V操作：
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 45</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    释放资源并将信号量值+1
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 46</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    如果有进程正在挂起等待，则唤醒它们</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 47</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> sem_v(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> sem_id)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 48</span> <span style="font-size:12px;line-height:1.5;">{
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 49</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span><span style="font-size:12px;line-height:1.5;"> sembuf sbuf;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 50</span>     sbuf.sem_num = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>; <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">序号</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 51</span>     sbuf.sem_op = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>;  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">V操作</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 52</span>     sbuf.sem_flg =<span style="font-size:12px;line-height:1.5;"> SEM_UNDO;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 53</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 54</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(semop(sem_id, &amp;sbuf, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>) == -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 55</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 56</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">V operation Error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 57</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 58</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 59</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 60</span> <span style="font-size:12px;line-height:1.5;">}
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 61</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 62</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 删除信号量集</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 63</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> del_sem(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> sem_id)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 64</span> <span style="font-size:12px;line-height:1.5;">{
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 65</span> <span style="font-size:12px;line-height:1.5;">    union semun tmp;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 66</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(semctl(sem_id, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>, IPC_RMID, tmp) == -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 67</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 68</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Delete Semaphore Error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 69</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 70</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 71</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 72</span> <span style="font-size:12px;line-height:1.5;">}
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 73</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 74</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 75</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> main()
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 76</span> <span style="font-size:12px;line-height:1.5;">{
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 77</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> sem_id;  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 信号量集ID</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 78</span> <span style="font-size:12px;line-height:1.5;">    key_t key;  
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 79</span> <span style="font-size:12px;line-height:1.5;">    pid_t pid;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 80</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 81</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 获取key值</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 82</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>((key = ftok(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">.</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">z</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span>)) &lt; <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 83</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 84</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">ftok error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 85</span>         exit(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 86</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 87</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 88</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 创建信号量集，其中只有一个信号量</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 89</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>((sem_id = semget(key, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>, IPC_CREAT|<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0666</span>)) == -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 90</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 91</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">semget error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 92</span>         exit(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 93</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 94</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 95</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 初始化：初值设为0资源被占用</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 96</span>     init_sem(sem_id, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 97</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 98</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>((pid = fork()) == -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 99</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Fork Error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">100</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">else</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(pid == <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>) <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">子进程</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">101</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">102</span>         sleep(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">2</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">103</span>         printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Process child: pid=%d\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, getpid());
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">104</span>         sem_v(sem_id);  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">释放资源</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">105</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">106</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">else</span>  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">父进程</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">107</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">108</span>         sem_p(sem_id);   <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">等待资源</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">109</span>         printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Process father: pid=%d\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, getpid());
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">110</span>         sem_v(sem_id);   <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">释放资源</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">111</span>         del_sem(sem_id); <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">删除信号量集</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">112</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">113</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">114</span> }</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">上面的例子如果不加信号量，则父进程会先执行完毕。这里加了信号量让父进程等待子进程执行完以后再执行。</p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">五、共享内存</h2> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><strong>共享内存（Shared Memory）</strong>，指两个或多个进程共享一个给定的存储区。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">1、特点</h3> 
   <ol style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style-type:decimal;"> <p>共享内存是最快的一种 IPC，因为进程是直接对内存进行存取。</p> </li> 
    <li style="list-style-type:decimal;"> <p>因为多个进程可以同时操作，所以需要进行同步。</p> </li> 
    <li style="list-style-type:decimal;"> <p>信号量+共享内存通常结合在一起使用，信号量用来同步对共享内存的访问。</p> </li> 
   </ol>
   <h3 style="font-size:16px;line-height:1.5;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">2、原型</h3> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">1</span> #include &lt;sys/shm.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">2</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 创建或获取一个共享内存：成功返回共享内存ID，失败返回-1</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">3</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> shmget(key_t key, size_t size, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> flag);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">4</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 连接共享内存到当前进程的地址空间：成功返回指向共享内存的指针，失败返回-1</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">5</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> *shmat(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> shm_id, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">const</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> *addr, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> flag);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">6</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 断开与共享内存的连接：成功返回0，失败返回-1</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">7</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> shmdt(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> *<span style="font-size:12px;line-height:1.5;">addr); 
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">8</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 控制共享内存的相关信息：成功返回0，失败返回-1</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">9</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> shmctl(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> shm_id, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> cmd, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span> shmid_ds *buf);</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">当用<code>shmget</code>函数创建一段共享内存时，必须指定其 size；而如果引用一个已存在的共享内存，则将 size 指定为0 。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">当一段共享内存被创建以后，它并不能被任何进程访问。必须使用<code>shmat</code>函数连接该共享内存到当前进程的地址空间，连接成功后把共享内存区对象映射到调用进程的地址空间，随后可像本地空间一样访问。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><code>shmdt</code>函数是用来断开<code>shmat</code>建立的连接的。注意，这并不是从系统中删除该共享内存，只是当前进程不能再访问该共享内存而已。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><code>shmctl</code>函数可以对共享内存执行多种操作，根据参数 cmd 执行相应的操作。常用的是<code>IPC_RMID</code>（从系统中删除该共享内存）。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">3、例子</h3> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">下面这个例子，使用了<strong>【共享内存+信号量+消息队列】</strong>的组合来实现服务器进程与客户进程间的通信。</p> 
   <ul style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">
    <li style="list-style-type:disc;">共享内存用来传递数据；</li> 
    <li style="list-style-type:disc;">信号量用来同步；</li> 
    <li style="list-style-type:disc;">消息队列用来 在客户端修改了共享内存后 通知服务器读取。</li> 
   </ul>
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">server.c</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  1</span> #include&lt;stdio.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  2</span> #include&lt;stdlib.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  3</span> #include&lt;sys/shm.h&gt;  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> shared memory</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  4</span> #include&lt;sys/sem.h&gt;  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> semaphore</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  5</span> #include&lt;sys/msg.h&gt;  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> message queue</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  6</span> #include&lt;<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">string</span>.h&gt;   <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> memcpy
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  7</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  8</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 消息队列结构</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  9</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span><span style="font-size:12px;line-height:1.5;"> msg_form {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 10</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">long</span><span style="font-size:12px;line-height:1.5;"> mtype;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 11</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span><span style="font-size:12px;line-height:1.5;"> mtext;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 12</span> <span style="font-size:12px;line-height:1.5;">};
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 13</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 14</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 联合体，用于semctl初始化</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 15</span> <span style="font-size:12px;line-height:1.5;">union semun
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 16</span> <span style="font-size:12px;line-height:1.5;">{
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 17</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span>              val; <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">for SETVAL</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 18</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span> semid_ds *<span style="font-size:12px;line-height:1.5;">buf;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 19</span>     unsigned <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">short</span>  *<span style="font-size:12px;line-height:1.5;">array;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 20</span> <span style="font-size:12px;line-height:1.5;">};
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 21</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 22</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 初始化信号量</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 23</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> init_sem(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> sem_id, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> value)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 24</span> <span style="font-size:12px;line-height:1.5;">{
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 25</span> <span style="font-size:12px;line-height:1.5;">    union semun tmp;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 26</span>     tmp.val =<span style="font-size:12px;line-height:1.5;"> value;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 27</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(semctl(sem_id, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>, SETVAL, tmp) == -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 28</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 29</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Init Semaphore Error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 30</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 31</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 32</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 33</span> <span style="font-size:12px;line-height:1.5;">}
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 34</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 35</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> P操作:
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 36</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">  若信号量值为1，获取资源并将信号量值-1 
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 37</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">  若信号量值为0，进程挂起等待</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 38</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> sem_p(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> sem_id)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 39</span> <span style="font-size:12px;line-height:1.5;">{
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 40</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span><span style="font-size:12px;line-height:1.5;"> sembuf sbuf;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 41</span>     sbuf.sem_num = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>; <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">序号</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 42</span>     sbuf.sem_op = -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>; <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">P操作</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 43</span>     sbuf.sem_flg =<span style="font-size:12px;line-height:1.5;"> SEM_UNDO;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 44</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 45</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(semop(sem_id, &amp;sbuf, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>) == -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 46</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 47</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">P operation Error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 48</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 49</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 50</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 51</span> <span style="font-size:12px;line-height:1.5;">}
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 52</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 53</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> V操作：
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 54</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">  释放资源并将信号量值+1
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 55</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">  如果有进程正在挂起等待，则唤醒它们</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 56</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> sem_v(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> sem_id)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 57</span> <span style="font-size:12px;line-height:1.5;">{
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 58</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span><span style="font-size:12px;line-height:1.5;"> sembuf sbuf;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 59</span>     sbuf.sem_num = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>; <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">序号</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 60</span>     sbuf.sem_op = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>;  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">V操作</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 61</span>     sbuf.sem_flg =<span style="font-size:12px;line-height:1.5;"> SEM_UNDO;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 62</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 63</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(semop(sem_id, &amp;sbuf, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>) == -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 64</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 65</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">V operation Error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 66</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 67</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 68</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 69</span> <span style="font-size:12px;line-height:1.5;">}
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 70</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 71</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 删除信号量集</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 72</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> del_sem(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> sem_id)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 73</span> <span style="font-size:12px;line-height:1.5;">{
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 74</span> <span style="font-size:12px;line-height:1.5;">    union semun tmp;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 75</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(semctl(sem_id, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>, IPC_RMID, tmp) == -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 76</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 77</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Delete Semaphore Error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 78</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 79</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 80</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 81</span> <span style="font-size:12px;line-height:1.5;">}
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 82</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 83</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 创建一个信号量集</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 84</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> creat_sem(key_t key)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 85</span> <span style="font-size:12px;line-height:1.5;">{
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 86</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> sem_id;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 87</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>((sem_id = semget(key, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>, IPC_CREAT|<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0666</span>)) == -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 88</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 89</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">semget error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 90</span>         exit(-<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 91</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 92</span>     init_sem(sem_id, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>);  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">初值设为1资源未占用</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 93</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;"> sem_id;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 94</span> <span style="font-size:12px;line-height:1.5;">}
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 95</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 96</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 97</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> main()
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 98</span> <span style="font-size:12px;line-height:1.5;">{
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 99</span> <span style="font-size:12px;line-height:1.5;">    key_t key;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">100</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> shmid, semid, msqid;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">101</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span> *<span style="font-size:12px;line-height:1.5;">shm;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">102</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span> data[] = <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">this is server</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">103</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span> shmid_ds buf1;  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">用于删除共享内存</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">104</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span> msqid_ds buf2;  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">用于删除消息队列</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">105</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span> msg_form msg;  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">消息队列用于通知对方更新了共享内存</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">106</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">107</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 获取key值</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">108</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>((key = ftok(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">.</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">z</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span>)) &lt; <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">109</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">110</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">ftok error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">111</span>         exit(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">112</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">113</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">114</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 创建共享内存</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">115</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>((shmid = shmget(key, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1024</span>, IPC_CREAT|<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0666</span>)) == -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">116</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">117</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Create Shared Memory Error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">118</span>         exit(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">119</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">120</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">121</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 连接共享内存</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">122</span>     shm = (<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span>*)shmat(shmid, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">123</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>((<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span>)shm == -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">124</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">125</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Attach Shared Memory Error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">126</span>         exit(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">127</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">128</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">129</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">130</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 创建消息队列</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">131</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> ((msqid = msgget(key, IPC_CREAT|<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0777</span>)) == -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">132</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">133</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">msgget error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">134</span>         exit(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">135</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">136</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">137</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 创建信号量</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">138</span>     semid =<span style="font-size:12px;line-height:1.5;"> creat_sem(key);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">139</span>     
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">140</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 读数据</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">141</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">while</span>(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">142</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">143</span>         msgrcv(msqid, &amp;msg, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">888</span>, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>); <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">读取类型为888的消息</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">144</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(msg.mtext == <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">q</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span>)  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">quit - 跳出循环</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">145</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">break</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">146</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(msg.mtext == <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">r</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span>)  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">read - 读共享内存</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">147</span> <span style="font-size:12px;line-height:1.5;">        {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">148</span> <span style="font-size:12px;line-height:1.5;">            sem_p(semid);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">149</span>             printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">%s\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">,shm);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">150</span> <span style="font-size:12px;line-height:1.5;">            sem_v(semid);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">151</span> <span style="font-size:12px;line-height:1.5;">        }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">152</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">153</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">154</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 断开连接</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">155</span> <span style="font-size:12px;line-height:1.5;">    shmdt(shm);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">156</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">157</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">删除共享内存、消息队列、信号量</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">158</span>     shmctl(shmid, IPC_RMID, &amp;<span style="font-size:12px;line-height:1.5;">buf1);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">159</span>     msgctl(msqid, IPC_RMID, &amp;<span style="font-size:12px;line-height:1.5;">buf2);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">160</span> <span style="font-size:12px;line-height:1.5;">    del_sem(semid);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">161</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">162</span> }</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">client.c</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  1</span> #include&lt;stdio.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  2</span> #include&lt;stdlib.h&gt;
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  3</span> #include&lt;sys/shm.h&gt;  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> shared memory</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  4</span> #include&lt;sys/sem.h&gt;  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> semaphore</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  5</span> #include&lt;sys/msg.h&gt;  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> message queue</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  6</span> #include&lt;<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">string</span>.h&gt;   <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> memcpy
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  7</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  8</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 消息队列结构</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">  9</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span><span style="font-size:12px;line-height:1.5;"> msg_form {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 10</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">long</span><span style="font-size:12px;line-height:1.5;"> mtype;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 11</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span><span style="font-size:12px;line-height:1.5;"> mtext;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 12</span> <span style="font-size:12px;line-height:1.5;">};
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 13</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 14</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 联合体，用于semctl初始化</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 15</span> <span style="font-size:12px;line-height:1.5;">union semun
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 16</span> <span style="font-size:12px;line-height:1.5;">{
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 17</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span>              val; <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">for SETVAL</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 18</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span> semid_ds *<span style="font-size:12px;line-height:1.5;">buf;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 19</span>     unsigned <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">short</span>  *<span style="font-size:12px;line-height:1.5;">array;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 20</span> <span style="font-size:12px;line-height:1.5;">};
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 21</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 22</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> P操作:
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 23</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">  若信号量值为1，获取资源并将信号量值-1 
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 24</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">  若信号量值为0，进程挂起等待</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 25</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> sem_p(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> sem_id)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 26</span> <span style="font-size:12px;line-height:1.5;">{
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 27</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span><span style="font-size:12px;line-height:1.5;"> sembuf sbuf;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 28</span>     sbuf.sem_num = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>; <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">序号</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 29</span>     sbuf.sem_op = -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>; <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">P操作</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 30</span>     sbuf.sem_flg =<span style="font-size:12px;line-height:1.5;"> SEM_UNDO;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 31</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 32</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(semop(sem_id, &amp;sbuf, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>) == -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 33</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 34</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">P operation Error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 35</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 36</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 37</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 38</span> <span style="font-size:12px;line-height:1.5;">}
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 39</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 40</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> V操作：
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 41</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">  释放资源并将信号量值+1
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 42</span> <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">  如果有进程正在挂起等待，则唤醒它们</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 43</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> sem_v(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> sem_id)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 44</span> <span style="font-size:12px;line-height:1.5;">{
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 45</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span><span style="font-size:12px;line-height:1.5;"> sembuf sbuf;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 46</span>     sbuf.sem_num = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>; <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">序号</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 47</span>     sbuf.sem_op = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>;  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">V操作</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 48</span>     sbuf.sem_flg =<span style="font-size:12px;line-height:1.5;"> SEM_UNDO;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 49</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 50</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(semop(sem_id, &amp;sbuf, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>) == -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 51</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 52</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">V operation Error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 53</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 54</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 55</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 56</span> <span style="font-size:12px;line-height:1.5;">}
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 57</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 58</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 59</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> main()
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 60</span> <span style="font-size:12px;line-height:1.5;">{
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 61</span> <span style="font-size:12px;line-height:1.5;">    key_t key;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 62</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> shmid, semid, msqid;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 63</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span> *<span style="font-size:12px;line-height:1.5;">shm;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 64</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span><span style="font-size:12px;line-height:1.5;"> msg_form msg;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 65</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> flag = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>; <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">while循环条件</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 66</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 67</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 获取key值</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 68</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>((key = ftok(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">.</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">z</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span>)) &lt; <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 69</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 70</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">ftok error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 71</span>         exit(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 72</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 73</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 74</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 获取共享内存</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 75</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>((shmid = shmget(key, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1024</span>, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>)) == -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 76</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 77</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">shmget error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 78</span>         exit(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 79</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 80</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 81</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 连接共享内存</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 82</span>     shm = (<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span>*)shmat(shmid, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 83</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>((<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span>)shm == -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 84</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 85</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Attach Shared Memory Error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 86</span>         exit(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 87</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 88</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 89</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 创建消息队列</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 90</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> ((msqid = msgget(key, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>)) == -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 91</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 92</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">msgget error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 93</span>         exit(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 94</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 95</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 96</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 获取信号量</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 97</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>((semid = semget(key, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>)) == -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 98</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;"> 99</span>         perror(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">semget error</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">100</span>         exit(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">101</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">102</span>     
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">103</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 写数据</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">104</span>     printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">***************************************\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">105</span>     printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">*                 IPC                 *\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">106</span>     printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">*    Input r to send data to server.  *\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">107</span>     printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">*    Input q to quit.                 *\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">108</span>     printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">***************************************\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">109</span>     
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">110</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">while</span><span style="font-size:12px;line-height:1.5;">(flag)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">111</span> <span style="font-size:12px;line-height:1.5;">    {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">112</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span><span style="font-size:12px;line-height:1.5;"> c;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">113</span>         printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Please input command: </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">114</span>         scanf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">%c</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>, &amp;<span style="font-size:12px;line-height:1.5;">c);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">115</span>         <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">switch</span><span style="font-size:12px;line-height:1.5;">(c)
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">116</span> <span style="font-size:12px;line-height:1.5;">        {
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">117</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">case</span> <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">r</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="font-size:12px;line-height:1.5;">:
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">118</span>                 printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Data to send: </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">119</span>                 sem_p(semid);  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">访问资源</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">120</span>                 scanf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">%s</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, shm);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">121</span>                 sem_v(semid);  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">释放资源</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">122</span>                 <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">清空标准输入缓冲区</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">123</span>                 <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">while</span>((c=getchar())!=<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span> &amp;&amp; c!=<span style="font-size:12px;line-height:1.5;">EOF);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">124</span>                 msg.mtype = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">888</span><span style="font-size:12px;line-height:1.5;">;  
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">125</span>                 msg.mtext = <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">r</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span>;  <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">发送消息通知服务器读数据</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">126</span>                 msgsnd(msqid, &amp;msg, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">sizeof</span>(msg.mtext), <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">127</span>                 <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">break</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">128</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">case</span> <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">q</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="font-size:12px;line-height:1.5;">:
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">129</span>                 msg.mtype = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">888</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">130</span>                 msg.mtext = <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">q</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">131</span>                 msgsnd(msqid, &amp;msg, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">sizeof</span>(msg.mtext), <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">132</span>                 flag = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">133</span>                 <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">break</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">134</span>             <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">default</span><span style="font-size:12px;line-height:1.5;">:
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">135</span>                 printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Wrong input!\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">136</span>                 <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">/*</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">清空标准输入缓冲区</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">*/</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">137</span>                 <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">while</span>((c=getchar())!=<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span> &amp;&amp; c!=<span style="font-size:12px;line-height:1.5;">EOF);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">138</span> <span style="font-size:12px;line-height:1.5;">        }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">139</span> <span style="font-size:12px;line-height:1.5;">    }
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">140</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">141</span>     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> 断开连接</span>
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">142</span> <span style="font-size:12px;line-height:1.5;">    shmdt(shm);
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">143</span> 
<span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">144</span>     <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
</span><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">145</span> }</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">注意：当<code>scanf()</code>输入字符或字符串时，缓冲区中遗留下了<code>\n</code>，所以每次输入操作后都需要清空标准输入的缓冲区。但是由于 gcc 编译器不支持<code>fflush(stdin)</code>（它只是标准C的扩展），所以我们使用了替代方案：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre><span style="color:rgb(0,128,128);font-size:12px;line-height:1.5;">1</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">while</span>((c=getchar())!=<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span> &amp;&amp; c!=EOF);</pre>
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">本文转自ZH奶酪博客园博客，原文链接：http://www.cnblogs.com/CheeseZH/p/5264465.html，如需转载请自行联系原作者</p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
