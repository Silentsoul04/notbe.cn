<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>MVC系列——MVC源码学习：打造自己的MVC框架（一：核心原理） « NotBeCN</title>
  <meta name="description" content="                  阅读目录           一、MVC原理解析              1、MVC原理             二、HttpHandler              1、HttpHandler、IHttpHandler、MvcHandler的说明        2、IHtt...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/15/weixin_33805557_90132521.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">MVC系列——MVC源码学习：打造自己的MVC框架（一：核心原理）</h1>
    <p class="post-meta">Nov 15, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <div style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"> 
    <p style="font-size:18px;"><b>阅读目录</b></p> 
    <ul>
     <li> <a href="http://www.cnblogs.com/landeanfen/p/5989092.html#_label0" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">一、MVC原理解析</a> 
      <ul>
       <li><a href="http://www.cnblogs.com/landeanfen/p/5989092.html#_label0_0" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">1、MVC原理</a></li>
      </ul></li> 
     <li> <a href="http://www.cnblogs.com/landeanfen/p/5989092.html#_label1" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">二、HttpHandler</a> 
      <ul>
       <li><a href="http://www.cnblogs.com/landeanfen/p/5989092.html#_label1_0" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">1、HttpHandler、IHttpHandler、MvcHandler的说明</a></li> 
       <li><a href="http://www.cnblogs.com/landeanfen/p/5989092.html#_label1_1" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">2、IHttpHandler解析</a></li> 
       <li><a href="http://www.cnblogs.com/landeanfen/p/5989092.html#_label1_2" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">3、MvcHandler解析</a></li> 
      </ul></li> 
     <li> <a href="http://www.cnblogs.com/landeanfen/p/5989092.html#_label2" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">三、HttpModule</a> 
      <ul>
       <li><a href="http://www.cnblogs.com/landeanfen/p/5989092.html#_label2_0" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">1、HttpModule能干什么</a></li> 
       <li><a href="http://www.cnblogs.com/landeanfen/p/5989092.html#_label2_1" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">2、HttpModule的使用</a></li> 
       <li><a href="http://www.cnblogs.com/landeanfen/p/5989092.html#_label2_2" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">3、HttpModule和HttpHandler如何区分</a></li> 
       <li><a href="http://www.cnblogs.com/landeanfen/p/5989092.html#_label2_3" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">4、UrlRoutingModule解析</a></li> 
      </ul></li> 
     <li><a href="http://www.cnblogs.com/landeanfen/p/5989092.html#_label3" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">&nbsp;四、总结</a></li> 
    </ul>
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">&nbsp;</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;line-height:24px;font-size:18px;"><b>正文</b></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">前言：最近一段时间在学习MVC源码，说实话，研读源码真是一个痛苦的过程，好多晦涩的语法搞得人晕晕乎乎。这两天算是理解了一小部分，这里先记录下来，也给需要的园友一个参考，奈何博主技术有限，如有理解不妥之处，还希望大家斧正，博主感激不尽！</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">本文原创地址：<a href="http://www.cnblogs.com/landeanfen/p/5989092.html" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">http://www.cnblogs.com/landeanfen/p/5989092.html</a></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">MVC源码学习系列文章目录：</p> 
   <ul style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">
    <li><a href="http://www.cnblogs.com/landeanfen/p/5989092.html" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">MVC系列——MVC源码学习：打造自己的MVC框架（一）</a></li> 
    <li><a href="http://www.cnblogs.com/landeanfen/p/6000978.html" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">MVC系列——MVC源码学习：打造自己的MVC框架（二：附源码）</a></li> 
    <li><a href="http://www.cnblogs.com/landeanfen/p/6016394.html" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">MVC系列——MVC源码学习：打造自己的MVC框架（三：自定义路由规则）</a></li> 
    <li><a href="http://www.cnblogs.com/landeanfen/p/6019719.html" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">MVC系列——MVC源码学习：打造自己的MVC框架（四：自定义视图）</a></li> 
   </ul>
   <div style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;text-align:right;"> 
    <a href="http://www.cnblogs.com/landeanfen/p/5989092.html#_labelTop" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">回到顶部</a>
    <a name="_label0" style="color:rgb(39,105,192);"></a> 
   </div> 
   <h1 style="font-size:25px;line-height:31px;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(43,102,0);">一、MVC原理解析</h1> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">&nbsp;最近园子里Asp.Net Core火了一阵，不管微软的开源动作有多么迟缓，还是希望微软能够给力一次。作为Core的主要Web框架——MVC，虽然已经开源，但是读起来着实费劲，并且感觉很多核心部件都找不到。于是只能通过Reflector去反编译MVC5的组件以及参考博客园Fish Li等大神的文章去学习下MVC5的原理。</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><strong>10月26日更新：感谢园友<a id="a_comment_author_3540322" href="http://www.cnblogs.com/weapon/" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">Adming</a>在评论中提醒，原来Asp.net Core Mvc和Asp.net Mvc 5的原理已经完全不同，难怪在Core Mvc的源码里面已经找不到MvcHandler、UrlRoutingModule等核心部件了呢，此系列文章就先学习下MVC5的原理，等以后有空了再来研究Core MVC吧。</strong></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">Asp.Net Core MVC的开源地址：<a href="https://github.com/aspnet/Mvc" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">https://github.com/aspnet/Mvc</a></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">Asp.net MVC的开源地址：<a href="http://aspnetwebstack.codeplex.com/SourceControl/latest" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">http://aspnetwebstack.codeplex.com/SourceControl/latest</a></p> 
   <div style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;text-align:right;"> 
    <a href="http://www.cnblogs.com/landeanfen/p/5989092.html#_labelTop" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">回到顶部</a>
    <a name="_label0_0" style="color:rgb(39,105,192);"></a> 
   </div> 
   <h2 style="font-size:15px;line-height:23px;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(43,102,149);">1、MVC原理</h2> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">之前的文章有介绍MVC的路由机制，其实路由机制算是MVC的原理的核心之一。在此我们还是要不厌其烦再来谈谈整个过程，因为这是理解MVC原理不可逾越的鸿沟。当我们收到一个URL的请求时，服务端收到请求，主要经历以下几个步骤：</p> 
   <ol style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">
    <li style="list-style:decimal;">请求被<span style="color:rgb(255,0,0);"><strong>UrlRoutingModule</strong></span>部件拦截</li> 
    <li style="list-style:decimal;">封装请求上下文<strong>HttpContext</strong>，成为<strong>HttpContextWrapper</strong>对象。</li> 
    <li style="list-style:decimal;">根据当前的<strong>HttpContext</strong>，从<strong>Routes集合</strong>中得到与当前请求URL相符合的<strong>RouteData</strong>对象。</li> 
    <li style="list-style:decimal;">将<strong>RouteData</strong>与<strong>HttpContext</strong>请求封装成一个<strong>RequestContext</strong>对象。</li> 
    <li style="list-style:decimal;">根据<strong>RequestContext</strong>对象，从RouteData的RouteHandler中获取<strong>IHttpHandler</strong>（MVC里面会有一个IHttpHandler的实现类<span style="color:rgb(255,0,0);"><strong>MvcHandler</strong></span>）。</li> 
    <li style="list-style:decimal;">执行<strong>IHttpHandler（MvcHandler）</strong>，然后就是通过反射激活具体的controller，执行具体的action。</li> 
   </ol>
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">附上一张大致的流程图：</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><img src="https://images2015.cnblogs.com/blog/459756/201610/459756-20161024162352421-300199538.png" alt="" style="border:0px;"></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">纵观整个过程，看上去很复杂，各种对象缠绕，看得人晕晕的。其实如果你静下心来仔细研读MVC的源码你会发现其实并没有想像中的那般复杂，请有点耐心听博主慢慢道来。</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><strong>1、整个过程有两个核心的组件，文中博主用红色标记了出来：<span style="color:rgb(255,0,0);">UrlRoutingModule</span>和<span style="color:rgb(255,0,0);">MvcHandler</span>，上文提到的各个过程都和两个组件有紧密的联系。而这两个组件分别继承至IHttpModule和IHttpHandler接口，熟悉Asp.net管线事件的朋友应该会记得这两个接口，在管道事件里面这两个接口扮演着重要角色。要理解MVC的上述原理，必须要先理解这两类接口的原理以及使用。</strong></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><strong>2、UrlRoutingModule的作用可以理解为通过一系列的与路由相关的组件去<strong>解析当前请求的Controller与Action名称，其实简单点理解，比如我们请求http://localhost:8080/Home/Index这个url的时候，UrlRoutingModule拦截到这个请求，然后通过一系列的方式得到这里的“Home”和“Index”，这样理解有没有简单一点呢。</strong></strong></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><strong><strong>3、MvcHandler的作用就更加直接，上述通过拦截组件得到了请求的Controller和Action的名称，MvcHandler组件将当前请求的Controller名称反射得到对应的控制器对象，然后执行对应的Action方法。比如还是上述<strong><strong>http://localhost:8080/Home/Index这个请求，通过字符串“Home”反射成为Home这个类型的控制器对象，然后调用这个对象的Index()方法。</strong></strong></strong></strong></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><strong><strong><strong><strong>4、综上，联合这两个组件来理解，UrlRoutingMudule组件的主要作用是<strong>解析当前的Controller与Action名称，MvcHandler的作用是将得到的Controller名称激活，得到具体的Controller对象，然后执行对应的Action方法。</strong></strong></strong></strong></strong></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">所以，要理解MVC的原理，必须要了解这两个组件的基本原理以及作用。下面就根据这两个组件分别展开说明，相信理解了下面的内容，你对mvc的原理会有一个新的认识。</p> 
   <div style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;text-align:right;"> 
    <a href="http://www.cnblogs.com/landeanfen/p/5989092.html#_labelTop" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">回到顶部</a>
    <a name="_label1" style="color:rgb(39,105,192);"></a> 
   </div> 
   <h1 style="font-size:25px;line-height:31px;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(43,102,0);">二、HttpHandler</h1> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">上文说过MvcHandler是继承至IHttpHandler接口的！为什么这里大标题会用HttpHandler而不是MvcHandler呢？因为博主觉得，HttpHandler实在是太重要了，首先得理解了HttpHandler这么一个大的东西，然后再来看具体的MvcHandler才有意义。</p> 
   <div style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;text-align:right;"> 
    <a href="http://www.cnblogs.com/landeanfen/p/5989092.html#_labelTop" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">回到顶部</a>
    <a name="_label1_0" style="color:rgb(39,105,192);"></a> 
   </div> 
   <h2 style="font-size:15px;line-height:23px;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(43,102,149);">1、HttpHandler、IHttpHandler、MvcHandler的说明</h2> 
   <ul style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">
    <li>HttpHandler指所有实现IHttpHandler接口一类类型的统称，它是一个大的称谓。这些类型有一个共同的功能，那就是可以用来处理Http请求。</li> 
    <li>IHttpHandler是微软定义的一类接口，用来约束所有能够处理Http请求的类型的接口规则。</li> 
    <li>MvcHandler是Mvc里面实现IHttpHandler接口的类型，也就是说，MvcHandler是Mvc里面处理Http请求的类型。</li> 
   </ul>
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">总而言之，HttpHandler只是一个逻辑称谓，它并不具体存在。而IHttpHandler和MvcHandler是.net framework里面具体存在的接口和实现类，是前者的表现形式。</p> 
   <div style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;text-align:right;"> 
    <a href="http://www.cnblogs.com/landeanfen/p/5989092.html#_labelTop" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">回到顶部</a>
    <a name="_label1_1" style="color:rgb(39,105,192);"></a> 
   </div> 
   <h2 style="font-size:15px;line-height:23px;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(43,102,149);">2、IHttpHandler解析</h2> 
   <h3 style="font-size:16px;line-height:24px;font-family:'微软雅黑', PTSans, Arial, sans-serif;">&nbsp;2.1、Asp.net管线事件简易说明</h3> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">做过Webform开发的园友应该记得，在asp.net的页面生命周期里面，一共有24个管线事件，完整的管线事件可参考MSDN文档：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;"> 
    <img class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" style="border:0px;vertical-align:middle;">&nbsp;
    <span class="cnblogs_code_collapse" style="border:1px solid #808080;line-height:1.5;">Asp.net管线事件说明</span> 
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">这里不可能把每个管线事件将清楚，但是在整个管线事件中，有两个重要的角色就是<strong>HttpHandler</strong>和<strong>HttpModule</strong>。在这些事件中，第10个事件【<strong>根据所请求资源的文件扩展名（在应用程序的配置文件中映射），选择实现 IHttpHandler 的类，对请求进行处理</strong>】 是HttpHandler创建的地方。关于WebForm里面HttpHandler创建的详细过程，这里就不展开说了，如果有兴趣可以参考<a href="http://www.cnblogs.com/fish-li/archive/2012/01/29/2331477.html" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">http://www.cnblogs.com/fish-li/archive/2012/01/29/2331477.html</a>。</p> 
   <h3 style="font-size:16px;line-height:24px;font-family:'微软雅黑', PTSans, Arial, sans-serif;">2.2、Asp.net中常见的HttpHandler类型</h3> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">首先还是来看看IHttpHandler的定义</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">interface</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> IHttpHandler
{
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);"> 定义一个处理当前http请求的方法</span>
    <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> ProcessRequest(HttpContext context);

    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);"> 指示当前实例是否可以再次使用</span>
    <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">bool</span> IsReusable { <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">get</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">; }
}

 </span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">接口的定义很简单，ProcessRequest()方法里面传一个当前请求的上下文对象去处理当前的http请求。</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">为了处理异步请求，Framework里面还定义了一个异步的IHttpHandler接口：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;">
    <pre><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">interface</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> IHttpAsyncHandler : IHttpHandler
{
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);"> Methods</span>
    IAsyncResult BeginProcessRequest(HttpContext context, AsyncCallback cb, <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">object</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> extraData);
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> EndProcessRequest(IAsyncResult result);
}</span></pre>
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">接口的两个方法应该也不难理解。</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">我们已经说了，HttpHandler的主要作用是处理http请求，原来在做webform的时候应该都写过后缀ashx的一般处理程序吧，这个一般处理程序就是通过实现IHttpHandler接口去实现的。我们是否曾经也写过类似这样的代码，新建一个TestHttpHandler.ashx文件，代码如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">class</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> TestHttpHandler : IHttpHandler
    {

        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> ProcessRequest(HttpContext context)
        {
            context.Response.ContentType </span>= <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">text/plain</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">;

            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> username = context.Request.QueryString[<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">username</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">];
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> password = context.Request.QueryString[<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">password</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">];
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">if</span> (username == <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">admin</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span> &amp;&amp; password == <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">admin</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">)
            {
                context.Response.Write(</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">用户admin登录成功</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">);
            }
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">else</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">
            {
                context.Response.Write(</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">用户名或者密码错误</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">);
            }
        }

        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">bool</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> IsReusable
        {
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">get</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">
            {
                </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">return</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">false</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">;
            }
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">然后运行，通过http://localhost:16792/TestHttpHandler.ashx?username=admin&amp;password=admin去访问一般处理程序，即可得到正确的结果。</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">当然，除了这个，还有我们最常见的aspx页面。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">partial</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">class</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> TestPage : System.Web.UI.Page
    {
        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">protected</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span> Page_Load(<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">object</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> sender, EventArgs e)
        {

        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">将Page类转到定义：</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><img src="https://images2015.cnblogs.com/blog/459756/201610/459756-20161023204949310-1060969668.png" alt="" style="border:0px;"></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">发现原来Page类也是继承至IHttpHandler，这就是为什么我们可以通过地址http://localhost:16792/TestPage.aspx来访问这个页面的原因。当然，子类中的ProcessRequest()方法并没有显示的声明出来，因为在Page类里面已经有一个virtue的虚方法，如果需要，你也可以在TestPage这个类里面显示声明：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">partial</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">class</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> TestPage : System.Web.UI.Page
    {
        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">protected</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span> Page_Load(<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">object</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> sender, EventArgs e)
        {

        }

        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> ProcessRequest(HttpContext context)
        {
            context.Response.Write(</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">你好</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">);
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">然后你会发现这个时候请求会进到ProcessRequest()方法，而不会进到Page_Load()里面了，至于原因，这和Page类里面的封装有关系。当然这不是本文的重点，<strong>本文要说明的是所有实现了IHttpHandler接口的类型都可以在ProcessRequest()方法里面处理当前http请求。</strong></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">当然，除了ashx和aspx以外，还有一类http的服务接口处理文件asmx也和IHttpHandler有着不可分割的联系，可以说，在asp.net里面，只要是处理Http请求的地方，IHttpHandler几乎“无处不在”。</p> 
   <h3 style="font-size:16px;line-height:24px;font-family:'微软雅黑', PTSans, Arial, sans-serif;">2.3、自定义HttpHandler。</h3> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">当然，除了上述asp.net自带的HttpHandler之外，我们也可以自定义HttpHandler处理特定的请求。比如我们新建一个TestMyHandler.cs页面：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">class</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> TestMyHandler:IHttpHandler
    {
        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">bool</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> IsReusable
        {
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">get</span> { <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">return</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">false</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">; }
        }

        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> ProcessRequest(HttpContext context)
        {
            context.Response.Write(</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">从asex页面进来</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">);

            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">throw new NotImplementedException();</span>
<span style="font-family:'Courier New';font-size:12px;line-height:1.5;">        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">当然，要使用这个自定义的Handler需要在web.config里面加上配置。（PS：这部分是博主后来加上的，所以直接用正确的配置）</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;">
    <pre><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&lt;</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">system.webServer</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&gt;</span>
   <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&lt;</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">handlers</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&gt;</span>
        <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&lt;</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">add </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(255,0,0);">name</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">="asex"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(255,0,0);"> verb</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">="*"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(255,0,0);"> path</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">="*.asex"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(255,0,0);"> type</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">="MyTestMVC.TestMyHandler, MyTestMVC"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(255,0,0);"> preCondition</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">="integratedMode"</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">/&gt;</span>
    <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&lt;/</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">handlers</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&gt;</span>
<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&lt;/</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">system.webServer</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&gt;</span></pre>
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">这个配置的意思是所有的url以asex结尾的请求都交给TestMyHandler这个类去处理。得到效果：</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><img src="https://images2015.cnblogs.com/blog/459756/201610/459756-20161024150100937-1583741949.png" alt="" style="border:0px;"></p> 
   <div style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;text-align:right;"> 
    <a href="http://www.cnblogs.com/landeanfen/p/5989092.html#_labelTop" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">回到顶部</a>
    <a name="_label1_2" style="color:rgb(39,105,192);"></a> 
   </div> 
   <h2 style="font-size:15px;line-height:23px;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(43,102,149);">3、MvcHandler解析</h2> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">上文介绍了那么多IHttpHandler的用法，都是在WebForm里面的一些实现，我们知道了所有实现了IHttpHandler的类都可以处理Http请求。同样在MVC里面，也定义了一个实现IHttpHandler接口的类型——MvcHandler，用于处理当前的http请求。通过反编译工具可以看到：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">class</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> MvcHandler : IHttpAsyncHandler, IHttpHandler, IRequiresSessionState
{
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);"> 省略若干字段</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);"> 所有方法</span>
    <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">static</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> MvcHandler();
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> MvcHandler(RequestContext requestContext);
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">protected</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">internal</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">virtual</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> AddVersionHeader(HttpContextBase httpContext);
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">protected</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">virtual</span> IAsyncResult BeginProcessRequest(HttpContext httpContext, AsyncCallback callback, <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">object</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> state);
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">protected</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">internal</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">virtual</span> IAsyncResult BeginProcessRequest(HttpContextBase httpContext, AsyncCallback callback, <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">object</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> state);
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">protected</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">internal</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">virtual</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> EndProcessRequest(IAsyncResult asyncResult);
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">private</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">static</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">string</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> GetMvcVersionString();
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">protected</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">virtual</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> ProcessRequest(HttpContext httpContext);
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">protected</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">internal</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">virtual</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> ProcessRequest(HttpContextBase httpContext);
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">private</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span> ProcessRequestInit(HttpContextBase httpContext, <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">out</span> IController controller, <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">out</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> IControllerFactory factory);
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">private</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> RemoveOptionalRoutingParameters();
    IAsyncResult IHttpAsyncHandler.BeginProcessRequest(HttpContext context, AsyncCallback cb, </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">object</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> extraData);
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> IHttpAsyncHandler.EndProcessRequest(IAsyncResult result);
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> IHttpHandler.ProcessRequest(HttpContext httpContext);

    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);"> 省略若干属性</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">MvcHandler实现了IHttpHandler、 IHttpAsyncHandler两个接口，异步请求这里先不做介绍。重点还是来看看ProcessRequest()方法</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><img src="https://images2015.cnblogs.com/blog/459756/201610/459756-20161023212821060-1773249332.png" alt="" style="border:0px;"></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">将HttpContext转换为HttpContextBase对象，继续转到定义。</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><img src="https://images2015.cnblogs.com/blog/459756/201610/459756-20161023212829560-1062640550.png" alt="" style="border:0px;"></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">这里声明了一个IController和IControllerFactory对象，通过this.ProcessRequestInit()方法创建具体的Controller实例。我们将ProcessRequestInit()方法转到定义</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><img src="https://images2015.cnblogs.com/blog/459756/201610/459756-20161023212837857-495201636.png" alt="" style="border:0px;"></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">我们将代码复制出来，写入相应的注释：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">　　　　 private</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span> ProcessRequestInit(HttpContextBase httpContext, <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">out</span> IController controller, <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">out</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> IControllerFactory factory)
        {
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">1.得到当前的上下文</span>
            HttpContext current =<span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> HttpContext.Current;
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">if</span> (current != <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">null</span> &amp;&amp; ValidationUtility.IsValidationEnabled(current) == <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">true</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">) ValidationUtility.EnableDynamicValidation(current);
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">this</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">.AddVersionHeader(httpContext);
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">this</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">.RemoveOptionalRoutingParameters();

            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">2.从路由对象RouteData中获取当前请求的Controller名称</span>
            <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">string</span> requiredString = <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">this</span>.RequestContext.RouteData.GetRequiredString(<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">controller</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">);

            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">3.得到Controller工厂对象</span>
            factory = <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">this</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">.ControllerBuilder.GetControllerFactory();

            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">4.根据当前RequestContext对象，从Controller工厂创建具体的Controller对象</span>
            controller = factory.CreateController(<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">this</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">.RequestContext, requiredString);
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">if</span> (controller == <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">null</span>) <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">throw</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span> InvalidOperationException(<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">string</span>.Format(CultureInfo.CurrentCulture, MvcResources.ControllerBuilder_FactoryReturnedNull, <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">object</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">[] { factory.GetType(), requiredString }));
        }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">通过上文的注释很好理解整个控制器的实例化过程。本打算看下Controller工厂如何创建以及控制器如何实例化的，奈何这部分反编译不了。我们暂且理解为反射吧，这些实现细节并不影响我们理解整个过程。</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">创建控制器成功之后，就是执行Action方法了，这个过程在上面反编译的第二张图片的&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">controller.Execute(<span style="color:rgb(0,0,255);line-height:1.5;">this</span>.RequestContext);</span>&nbsp;方法得到体现。所以，除去细节，理解MvcHandler的ProcessRequest()方法并不是太难。</p> 
   <div style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;text-align:right;"> 
    <a href="http://www.cnblogs.com/landeanfen/p/5989092.html#_labelTop" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">回到顶部</a>
    <a name="_label2" style="color:rgb(39,105,192);"></a> 
   </div> 
   <h1 style="font-size:25px;line-height:31px;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(43,102,0);">三、HttpModule</h1> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">除了HttpHandler之外，Asp.net里面还有另外一个重要的角色——HttpModule。和HttpHandler类似，<strong>HttpModule指所有实现了IHttpModule接口的一类类型的统称</strong>。至于HttpModule、IHttpModule、UrlRoutingModule各个名称的含义和上述HttpHandler相同，在此不做重复说明。</p> 
   <div style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;text-align:right;"> 
    <a href="http://www.cnblogs.com/landeanfen/p/5989092.html#_labelTop" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">回到顶部</a>
    <a name="_label2_0" style="color:rgb(39,105,192);"></a> 
   </div> 
   <h2 style="font-size:15px;line-height:23px;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(43,102,149);">1、HttpModule能干什么</h2> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">通过上文，我们知道HttpHandler的作用非常明确：处理Http请求，生成相应结果。那么，HttpModule又是干什么的呢？</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">HttpHandler的作用是处理某一类别的请求，比如ashx、aspx、asmx等，在某些情况下，各类请求可能都需要进行某些相同的处理（比如请求拦截、身份认证、检查功能等），不可能在每个类别的HttpHandler里面都去实现这些相同的代码，这个时候怎么办呢？处理某一类通用请求，提高代码的复用率。是不是想到了我们的面向切面编程（AOP），没错，<strong>HttpModule</strong>就是负责做这个事，HttpModule通过事件订阅的方式，将某类HttpHandler都需要的功能抽取出来，这些功能可以编译成类库供各个模块调用。这种采用事件（观察者）的设计模式使得系统设计上更加灵活。</p> 
   <div style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;text-align:right;"> 
    <a href="http://www.cnblogs.com/landeanfen/p/5989092.html#_labelTop" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">回到顶部</a>
    <a name="_label2_1" style="color:rgb(39,105,192);"></a> 
   </div> 
   <h2 style="font-size:15px;line-height:23px;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(43,102,149);">2、HttpModule的使用</h2> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">先来看看IHttpModule的定义</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">interface</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> IHttpModule
{
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">初始化</span>
    <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> Init(HttpApplication context);
   
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">释放</span>
    <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> Dispose();
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">接口定义很简单，一个初始化组件的方法，一个释放对象的方法。</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">我们来写一个测试的例子具体看看HttpModule如何注册事件，我们新建一个IHttpModule的实现类：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">namespace</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> MyTestMVC
{
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">class</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> TestMyModule:IHttpModule
    {
        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> Dispose()
        {
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">throw new NotImplementedException();</span>
<span style="font-family:'Courier New';font-size:12px;line-height:1.5;">        }

        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> Init(HttpApplication app)
        {
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">事件注册</span>
            app.BeginRequest +=<span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> app_BeginRequest;
            app.EndRequest </span>+=<span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> app_EndRequest;
        }

        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span> app_EndRequest(<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">object</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> sender, EventArgs e)
        {
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> app =<span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> (HttpApplication)sender;
            app.Context.Response.Write(</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">请求结束</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">);
        }

        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span> app_BeginRequest(<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">object</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> sender, EventArgs e)
        {
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">var</span> app =<span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> (HttpApplication)sender;
            app.Context.Response.Write(</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">请求开始</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">);
        }
    }
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">在Init方法里面，通过HttpApplication对象来注册请求的事件。这样，每次发起一次http请求的时候都进到这两个方法。</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">当然，这些注册就能执行了吗？想得美，系统哪里知道你这个自定义HttpModule的存在，所以必须要在Web.config里面声明一下。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;">
    <pre> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&lt;</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">system.web</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&gt;</span>
    <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&lt;</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">httpModules</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&gt;</span>
        <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&lt;</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">add </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(255,0,0);">name</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">="TestMyModule"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(255,0,0);"> type</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">="MyTestMVC.TestMyModule, MyTestMVC"</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">/&gt;</span>
    <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&lt;/</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">httpModules</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&gt;</span>
  <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&lt;/</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">system.web</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&gt;</span></pre>
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">出现结果：</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><img src="https://images2015.cnblogs.com/blog/459756/201610/459756-20161024102009312-1983698160.png" alt="" style="border:0px;"></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">查阅资料后发现，原来IIS经典模式下必须要这样配置：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;">
    <pre><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&lt;</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">system.webServer</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&gt;</span>
    <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&lt;</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">modules</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&gt;</span>
        <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&lt;</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">add </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(255,0,0);">name</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">="TestMyModule"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(255,0,0);"> type</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">="MyTestMVC.TestMyModule, MyTestMVC"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(255,0,0);"> preCondition</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">="integratedMode"</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">/&gt;</span>
    <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&lt;/</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">modules</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&gt;</span>
<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&lt;/</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">system.webServer</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&gt;</span></pre>
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">没办法，用微软的东西就要遵守别人的游戏规则。改成这样之后得到结果：</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><img src="https://images2015.cnblogs.com/blog/459756/201610/459756-20161024102236921-210501809.png" alt="" style="border:0px;"></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">文中的“你好”来自这里：</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><img src="https://images2015.cnblogs.com/blog/459756/201610/459756-20161024102328906-1293088391.png" alt="" style="border:0px;"></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">&nbsp;既然HttpModule是事件注册机制的，那么如果需要在同一个事件里面去实现不同的功能，也就是说同一个事件注册多次是否可行呢？我们来试一把：</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">假如TestMyModule.cs这个自定义Module的作用是功能检查：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;"> 
    <img class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" style="border:0px;vertical-align:middle;">&nbsp;
    <span class="cnblogs_code_collapse" style="border:1px solid #808080;line-height:1.5;">TestMyModule.cs</span> 
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">然后新建一个TestMyModule2.cs这个自定义Module，去实现请求拦截的功能：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;"> 
    <img class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" style="border:0px;vertical-align:middle;">&nbsp;
    <span class="cnblogs_code_collapse" style="border:1px solid #808080;line-height:1.5;">TestMyModule2.cs</span> 
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">最后在Web.config里面配置两个Module：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;">
    <pre><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&lt;</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">system.webServer</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&gt;</span>
    <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&lt;</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">modules</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&gt;</span>
        <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&lt;</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">add </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(255,0,0);">name</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">="TestMyModule"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(255,0,0);"> type</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">="MyTestMVC.TestMyModule, MyTestMVC"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(255,0,0);"> preCondition</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">="integratedMode"</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">/&gt;</span>
        <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&lt;</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">add </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(255,0,0);">name</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">="TestMyModule2"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(255,0,0);"> type</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">="MyTestMVC.TestMyModule2, MyTestMVC"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(255,0,0);"> preCondition</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">="integratedMode"</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">/&gt;</span>
    <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&lt;/</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">modules</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&gt;</span>
<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&lt;/</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">system.webServer</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">&gt;</span></pre>
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">得到结果：</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><img src="https://images2015.cnblogs.com/blog/459756/201610/459756-20161024105521500-226504752.png" alt="" style="border:0px;"></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">&nbsp;</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><strong>这说明同一个事件可以注册多次，即可以在同一个事件里面做不同的事。</strong></p> 
   <div style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;text-align:right;"> 
    <a href="http://www.cnblogs.com/landeanfen/p/5989092.html#_labelTop" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">回到顶部</a>
    <a name="_label2_2" style="color:rgb(39,105,192);"></a> 
   </div> 
   <h2 style="font-size:15px;line-height:23px;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(43,102,149);">3、HttpModule和HttpHandler如何区分</h2> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">通过上文的HttpModule的应用，我们看到在Init方法里面可以拿到当前应用的HttpApplication对象，拿到这个貌似就可以拿到当前请求上下文里面的Request、Response了，是不是就可以处理当前的http请求了，从这点上来说，HttpModule也能处理http请求，或者说具有处理http请求的能力。既然HttpHandler和HttpModule都可以处理http请求，那在使用的时候如何区分呢？上文说过，HttpModule的作用类似AOP，是针对某些通用功能（请求拦截、身份认证、检查功能）的，而HttpHandler常用来处理某一类（ashx、aspx、asmx）http请求，两者的侧重点不同，至于具体在实际中如何使用，你可以自行考量。</p> 
   <div style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;text-align:right;"> 
    <a href="http://www.cnblogs.com/landeanfen/p/5989092.html#_labelTop" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">回到顶部</a>
    <a name="_label2_3" style="color:rgb(39,105,192);"></a> 
   </div> 
   <h2 style="font-size:15px;line-height:23px;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(43,102,149);">4、<strong>UrlRoutingModule解析</strong> </h2> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">好了，上面介绍那么多HttpModule的使用，都是在为了解Mvc里面的UrlRoutingModule做铺垫。上文说过UrlRoutingModule的作用是拦截请求，那么它是如何做的呢，还是来反编译看看吧。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">class</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> UrlRoutingModule : IHttpModule
{
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);"> Fields</span>
    <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">private</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">static</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">readonly</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">object</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> _contextKey;
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">private</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">static</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">readonly</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">object</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> _requestDataKey;
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">private</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> RouteCollection _routeCollection;

    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);"> Methods</span>
    <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">static</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> UrlRoutingModule();
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> UrlRoutingModule();
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">protected</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">virtual</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> Dispose();
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">protected</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">virtual</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> Init(HttpApplication application);
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">private</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span> OnApplicationPostResolveRequestCache(<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">object</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> sender, EventArgs e);
    [Obsolete(</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">This method is obsolete. Override the Init method to use the PostMapRequestHandler event.</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">)]
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">virtual</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> PostMapRequestHandler(HttpContextBase context);
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">virtual</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> PostResolveRequestCache(HttpContextBase context);
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> IHttpModule.Dispose();
    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> IHttpModule.Init(HttpApplication application);

    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);"> Properties</span>
    <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">public</span> RouteCollection RouteCollection { <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">get</span>; <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">set</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">; }
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">重点肯定在Init()方法。</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">图一：</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><img src="https://images2015.cnblogs.com/blog/459756/201610/459756-20161024111854578-112053590.png" alt="" style="border:0px;"></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">注册HttpApplication对象的PostResolveRequestCache事件。</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">图二：</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><img src="https://images2015.cnblogs.com/blog/459756/201610/459756-20161024111907015-1307941338.png" alt="" style="border:0px;"></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">封装HttpContext，成为<strong>HttpContextWrapper对象</strong></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">图三：</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><img src="https://images2015.cnblogs.com/blog/459756/201610/459756-20161024111918875-1710113314.png" alt="" style="border:0px;"></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">这部分代码是我们上述路由理论的代码实践，所以这段代码很重要，我们将代码拷贝出来：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);line-height:24px;font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">　　　　 public</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">virtual</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">void</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> PostResolveRequestCache(HttpContextBase context)
        {
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">1.传入当前上下文对象，得到与当前请求匹配的RouteData对象</span>
            RouteData routeData = <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">this</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">.RouteCollection.GetRouteData(context);
            </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">if</span> (routeData != <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">null</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">)
            {
                </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">2.从RouteData对象里面得到当前的RouteHandler对象。其实这里的RouteHandler属性对应就是一个MvcRouteHandler的对象。</span>
                IRouteHandler routeHandler =<span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> routeData.RouteHandler;
                </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">if</span> (routeHandler == <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">null</span>) <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">throw</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span> InvalidOperationException(<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">string</span>.Format(CultureInfo.CurrentCulture, SR.GetString(<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">UrlRoutingModule_NoRouteHandler</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span>), <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">object</span>[<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,128);">0</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">]));
                </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">if</span> (!(routeHandler <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">is</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> StopRoutingHandler))
                {
                    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">3.根据HttpContext和RouteData得到RequestContext对象</span>
                    RequestContext requestContext = <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> RequestContext(context, routeData);
                    context.Request.RequestContext </span>=<span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> requestContext;

                    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">4.根据RequestContext对象得到处理当前请求的HttpHandler（MvcHandler）。</span>
                    IHttpHandler httpHandler =<span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> routeHandler.GetHttpHandler(requestContext);
                    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">if</span> (httpHandler == <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">null</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">)
                    {
                        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">object</span>[] args = <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">object</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">[] { routeHandler.GetType() };
                        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">throw</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span> InvalidOperationException(<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">string</span>.Format(CultureInfo.CurrentUICulture, SR.GetString(<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">UrlRoutingModule_NoHttpHandler</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">), args));
                    }
                    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">if</span> (httpHandler <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">is</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;"> UrlAuthFailureHandler)
                    {
                        </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">if</span> (!FormsAuthenticationModule.FormsAuthRequired) <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">throw</span> <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">new</span> HttpException(<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,128);">0x191</span>, SR.GetString(<span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">Assess_Denied_Description3</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(128,0,0);">"</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">));
                        UrlAuthorizationModule.ReportUrlAuthorizationFailure(HttpContext.Current, </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">this</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;">);
                    }
                    </span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,0,255);">else</span>
                        <span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">//</span><span style="font-family:'Courier New';font-size:12px;line-height:1.5;color:rgb(0,128,0);">5.请求转到HttpHandler进行处理（进入到ProcessRequest方法）。这一步很重要，由这一步开始，请求才由UrlRoutingModule转到了MvcHandler里面</span>
<span style="font-family:'Courier New';font-size:12px;line-height:1.5;">                        context.RemapHandler(httpHandler);
                }
            }
        }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(39,105,192);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">博主在主要的地方加上了注释。</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span><strong>代码释疑：这里有几点需要说明的。</strong></span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span><strong>1、HttpApplication对象的</strong></span><span><strong>PostResolveRequestCache事件在MSDN上的解释是：在 ASP.NET 跳过当前事件处理程序的执行并允许缓存模块满足来自缓存的请求时发生。查阅相关资料发现，之所以在PostResolveRequestCache事件注册路由、匹配HttpHandler，是为了满足IIS6。可以参考Tom大叔的文章：<a href="http://www.cnblogs.com/TomXu/p/3756858.html" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">http://www.cnblogs.com/TomXu/p/3756858.html</a>。</strong></span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span><strong>2、&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">IRouteHandler routeHandler = routeData.RouteHandler;</span>&nbsp;这里的routeHandler实际上是一个MvcRouteHandler类型的对象，为什么这么说，我们来反编译下这个就会一目了然：</strong></span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span><strong>图一：</strong></span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span><strong><img src="https://images2015.cnblogs.com/blog/459756/201610/459756-20161024140033000-2136216553.png" alt="" style="border:0px;"></strong></span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">&nbsp;</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span><strong>MvcRouteHandler实现了IRouteHandler接口。然后我们重点来看GetHttpHandler()方法得到的是哪个HttpHandler。</strong></span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span><strong>图二：</strong></span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span><strong><img src="https://images2015.cnblogs.com/blog/459756/201610/459756-20161024140208125-1107739279.png" alt="" style="border:0px;"></strong></span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">&nbsp;</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span><strong>看到最后一句是不是立马就明白了。也就是说GetHttpHandler()这个方法决定了采用MvcHandler去处理当前的http请求。所以在上述&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">IHttpHandler httpHandler = routeHandler.GetHttpHandler(requestContext);</span>&nbsp;这一句得到的就是一个MvcHandler的实例。</strong></span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span><strong>3、&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">context.RemapHandler(httpHandler);</span>&nbsp;这一句可以理解为将当前的请求上下文交给httpHandler这个对象去处理。</strong></span></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><span><strong>4、到这里，我们再反过来看前面的MVC的原理就完全明朗了。</strong></span></p> 
   <ol style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">
    <li style="list-style:decimal;">请求被<strong>UrlRoutingModule</strong>部件拦截————<strong><span style="color:rgb(255,0,0);">通过注册HttpApplication对象的PostResolveRequestCache事件来实现拦截</span></strong> </li> 
    <li style="list-style:decimal;">封装请求上下文<strong>HttpContext</strong>，成为<strong>HttpContextWrapper</strong>对象。————<strong><span style="color:rgb(255,0,0);">将UrlRoutingModule的Init()方法转到定义，可以看到这么一句：&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">HttpContextBase context = new HttpContextWrapper(((HttpApplication) sender).Context);</span>&nbsp;</span></strong> </li> 
    <li style="list-style:decimal;">根据当前的<strong>HttpContext</strong>，从<strong>Routes集合</strong>中得到与当前请求URL相符合的<strong>RouteData</strong>对象。————将<span style="color:rgb(255,0,0);"><strong>UrlRoutingModule的Init()方法转到定义，最终会找到PostResolveRequestCache()方法，方法里面有一句&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">RouteData routeData = this.RouteCollection.GetRouteData(context);</span>&nbsp;</strong></span> </li> 
    <li style="list-style:decimal;">将<strong>RouteData</strong>与<strong>HttpContext</strong>请求封装成一个<strong>RequestContext</strong>对象。————<strong><span style="color:rgb(255,0,0);">同样在上述方法里面&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">RequestContext requestContext = new RequestContext(context, routeData);</span>&nbsp;</span></strong> </li> 
    <li style="list-style:decimal;">根据<strong>RequestContext</strong>对象，从RouteData的RouteHandler中获取<strong>IHttpHandler</strong>（MVC里面会有一个IHttpHandler的实现类<strong>MvcHandler</strong>）。————<span style="color:rgb(255,0,0);"><strong>同样在该方法里面&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">IHttpHandler httpHandler = routeHandler.GetHttpHandler(requestContext);</span>&nbsp;</strong></span> </li> 
    <li style="list-style:decimal;">执行<strong>IHttpHandler（MvcHandler）</strong>。————&nbsp;<strong><span style="color:rgb(255,0,0);"><span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">context.RemapHandler(httpHandler);</span>&nbsp;将请求交给MvcHandler处理。</span></strong> </li> 
    <li style="list-style:decimal;">然后就是通过反射激活具体的controller，执行具体的action。————<strong><span style="color:rgb(255,0,0);">在MvcHandler的ProcessRequest()方法里面的执行逻辑</span></strong> </li> 
   </ol>
   <div style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;text-align:right;"> 
    <a href="http://www.cnblogs.com/landeanfen/p/5989092.html#_labelTop" rel="nofollow" style="color:rgb(39,105,192);text-decoration:none;">回到顶部</a>
    <a name="_label3" style="color:rgb(39,105,192);"></a> 
   </div> 
   <h1 style="font-size:25px;line-height:31px;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(43,102,0);">&nbsp;四、总结</h1> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;">写到这里，总算把整个过程梳理了一遍，很多细节都未涉及，但是大的过程应该还是明朗的。通篇比较偏理论，所以整体上比较枯燥，但是还是希望园友们能够静下心来慢慢看，因为博主觉得这些对于理解MVC原理太重要！！！想想看，如果你也完全理解了这个过程，是不是都可以自己通过实现IHttphandler和IHttpModule去搭建一个简单的MVC框架了，不错，博主确实是这样打算的，这篇把理论搞清楚，下篇就是实现的细节了。其实写自己的MVC框架更多的在于学习MVC原理，希望自己能够坚持下去。如果你觉得本文能够帮助你，可以右边随意&nbsp;<strong>打赏&nbsp;</strong>博主，也可以&nbsp;<strong>推荐&nbsp;</strong>进行精神鼓励。你的支持是博主继续坚持的不懈动力。</p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><br></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><br></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><br></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><br></p> 
   <p style="font-family:'微软雅黑', PTSans, Arial, sans-serif;font-size:16px;line-height:24px;"><br></p> 
   <p><font><span style="line-height:24px;">本文转自懒得安分博客园博客，原文链接：http://www.cnblogs.com/landeanfen/p/5989092.html，如需转载请自行联系原作者</span></font><br></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
