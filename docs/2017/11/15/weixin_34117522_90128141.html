<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>理解Docker（2）：Docker 镜像 « NotBeCN</title>
  <meta name="description" content="             本系列文章将介绍Docker的有关知识：    （1）Docker 安装及基本用法    （2）Docker 镜像    （3）Docker 容器的隔离性 - 使用 Linux namespace 隔离容器的运行环境    （4）Docker 容器的隔离性 - 使用 cgroups 限制...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/15/weixin_34117522_90128141.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">理解Docker（2）：Docker 镜像</h1>
    <p class="post-meta">Nov 15, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">本系列文章将介绍Docker的有关知识：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）<a href="http://www.cnblogs.com/sammyliu/p/5875470.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">Docker 安装及基本用法</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）<a href="http://www.cnblogs.com/sammyliu/p/5877964.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">Docker 镜像</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（3）<a href="http://www.cnblogs.com/sammyliu/p/5878973.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">Docker 容器的隔离性 - 使用 Linux namespace 隔离容器的运行环境</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（4）<a href="http://www.cnblogs.com/sammyliu/p/5886833.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">Docker 容器的隔离性 - 使用 cgroups 限制容器使用的资源</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（5）<a href="http://www.cnblogs.com/sammyliu/p/5894191.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">Docker 网络</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; 对于每个软件，除了它自身的代码以外，它的运行还需要有一个运行环境和依赖。不管这个软件是象往常一样运行在物理机或者虚机之中，还是运行在现在的容器之中，这些都是不变的。在传统环境中，软件在运行之前也需要经过 代码开发-&gt;运行环境准备 -&gt; 安装软件 -&gt; 运行软件 等环节，在容器环境中，中间的两个环节被镜像制作过程替代了。也就是说，镜像的制作也包括运行环境准备和安装软件等两个主要环节，以及一些其他环节。因此，Docker 容器镜像其实并没有什么新的理论，只是这过程有了新的方式而已。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;&nbsp;镜像(image)是动态的容器的静态表示（specification），包括容器所要运行的应用代码以及运行时的配置。Docker 镜像包括一个或者多个只读层（ read-only layers ），因此，镜像一旦被创建就再也不能被修改了。一个运行着的Docker 容器是一个镜像的实例（ instantiation ）。从同一个镜像中运行的容器包含有相同的应用代码和运行时依赖。但是不像镜像是静态的，每个运行着的容器都有一个可写层（ writable layer ，也成为容器层 container layer），它位于底下的若干只读层之上。运行时的所有变化，包括对数据和文件的写和更新，都会保存在这个层中。因此，从同一个镜像运行的多个容器包含了不同的容器层。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;Docker&nbsp;有两种方式来创建一个容器镜像：</p> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <ul style="list-style:none;font-size:12px;">
     <li style="list-style-type:disc;">创建一个容器，运行若干命令，再使用 docker commit 来生成一个新的镜像。不建议使用这种方案。</li> 
     <li style="list-style-type:disc;">创建一个 Dockerfile 然后再使用 docker build 来创建一个镜像。<span style="line-height:1.5;">大多人会使用 Dockerfile 来创建镜像。</span> </li> 
    </ul>
   </div> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">&nbsp;1. docker build 生成镜像</h2> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.1 生成过程实例</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;在使用 Dockerfile 创建容器之前，需要先准备一个 Dockerfile 文件，然后运行 docker build 命令来创建镜像。我们通过下面的例子来看看Docker 创建容器的过程。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>FROM ubuntu:<span style="color:rgb(128,0,128);line-height:1.5;">14.04</span><span style="line-height:1.5;">

MAINTAINER sammy </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">sammy@sammy.com</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">

RUN apt</span>-<span style="color:rgb(0,0,255);line-height:1.5;">get</span><span style="line-height:1.5;"> update

RUN apt</span>-<span style="color:rgb(0,0,255);line-height:1.5;">get</span> -<span style="line-height:1.5;">y install ntp

EXPOSE </span><span style="color:rgb(128,0,128);line-height:1.5;">5555</span><span style="line-height:1.5;">

CMD [</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">/usr/sbin/ntpd</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>]</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">这是一个非常简单的Dockerfile，它的目的是基于 Ubuntu 14.04 基础镜像安装 ntp 从而生成一个新的镜像。看看其过程：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>root@devstack:/home/sammy/ntponubuntu# docker build -<span style="line-height:1.5;">t sammy_ntp2 .
Sending build context to Docker daemon </span><span style="color:rgb(128,0,128);line-height:1.5;">2.048</span><span style="line-height:1.5;"> kB
<span style="color:rgb(51,102,255);line-height:1.5;">Step </span></span><span style="color:rgb(51,102,255);line-height:1.5;">1 : FROM ubuntu:14.04</span>
 ---&gt;<span style="line-height:1.5;"> 4a725d3b3b1c
<span style="color:rgb(51,102,255);line-height:1.5;">Step </span></span><span style="color:rgb(51,102,255);line-height:1.5;">2 : MAINTAINER sammy "sammy@sammy.com"</span>
 ---&gt;<span style="line-height:1.5;"> Using cache
 </span>---&gt;<span style="line-height:1.5;"> c4299e3f774c
<span style="color:rgb(51,102,255);line-height:1.5;">Step </span></span><span style="color:rgb(51,102,255);line-height:1.5;">3 : RUN apt-get update
 </span>---&gt;<span style="line-height:1.5;"> Using cache
 </span>---&gt;<span style="line-height:1.5;"> 694a19d54103
<span style="color:rgb(51,102,255);line-height:1.5;">Step </span></span><span style="color:rgb(51,102,255);line-height:1.5;">4 : RUN apt-get -y install ntp
 </span>---&gt; Running <span style="color:rgb(0,0,255);line-height:1.5;">in</span><span style="line-height:1.5;"> 9bd153c65a76
Reading package lists...
</span><span style="line-height:1.5;">...
Fetched </span><span style="color:rgb(128,0,128);line-height:1.5;">561</span> kB <span style="color:rgb(0,0,255);line-height:1.5;">in</span> 10s (<span style="color:rgb(128,0,128);line-height:1.5;">51.1</span> kB/<span style="line-height:1.5;">s)
Selecting previously unselected package libedit2:amd64.
(Reading database ... </span><span style="color:rgb(128,0,128);line-height:1.5;">11558</span><span style="line-height:1.5;"> files and directories currently installed.)
</span><span style="line-height:1.5;">...
Processing triggers </span><span style="color:rgb(0,0,255);line-height:1.5;">for</span> libc-bin (<span style="color:rgb(128,0,128);line-height:1.5;">2.19</span>-0ubuntu6.<span style="color:rgb(128,0,128);line-height:1.5;">9</span><span style="line-height:1.5;">) ...
Processing triggers </span><span style="color:rgb(0,0,255);line-height:1.5;">for</span> ureadahead (<span style="color:rgb(128,0,128);line-height:1.5;">0.100</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0</span>-<span style="color:rgb(128,0,128);line-height:1.5;">16</span><span style="line-height:1.5;">) ...
 </span>---&gt;<span style="line-height:1.5;"> 9cc05cf6f48d
Removing intermediate container 9bd153c65a76
<span style="color:rgb(51,102,255);line-height:1.5;">Step </span></span><span style="color:rgb(51,102,255);line-height:1.5;">5 : EXPOSE 5555</span>
 ---&gt; Running <span style="color:rgb(0,0,255);line-height:1.5;">in</span><span style="line-height:1.5;"> eb4633151d98
 </span>---&gt;<span style="line-height:1.5;"> f5c96137bec9
Removing intermediate container eb4633151d98
<span style="color:rgb(51,102,255);line-height:1.5;">Step </span></span><span style="color:rgb(51,102,255);line-height:1.5;">6 : CMD /usr/sbin/ntpd
 </span>---&gt; Running <span style="color:rgb(0,0,255);line-height:1.5;">in</span><span style="line-height:1.5;"> e81b1eae3678
 </span>---&gt;<span style="line-height:1.5;"> af678df648bc
Removing intermediate container e81b1eae3678
Successfully built af678df648bc</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">Dockerfile 中的每个步骤都会对应每一个 docker build 输出中的 step。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">Step 1：FROM ubuntu:14.04</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">获取基础镜像 ubuntu：14.04. Docker 首先会在本地查找，如果找到了，则直接利用；否则从 Docker registry 中下载。在第一次使用这个基础镜像的时候，Docker 会从 Docker Hub 中下载这个镜像，并保存在本地：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>Step <span style="color:rgb(128,0,128);line-height:1.5;">1</span> : FROM ubuntu:<span style="color:rgb(128,0,128);line-height:1.5;">14.04</span>
<span style="color:rgb(128,0,128);line-height:1.5;">14.04</span>: Pulling <span style="color:rgb(0,0,255);line-height:1.5;">from</span> library/<span style="line-height:1.5;">ubuntu
862a3e9af0ae: Pull complete
6498e51874bf: Pull complete
159ebdd1959b: Pull complete
0fdbedd3771a: Pull complete
7a1f7116d1e3: Pull complete
Digest: sha256:5b5d48912298181c3c80086e7d3982029b288678fccabf2265899199c24d7f89
Status: Downloaded newer image </span><span style="color:rgb(0,0,255);line-height:1.5;">for</span> ubuntu:<span style="color:rgb(128,0,128);line-height:1.5;">14.04</span>
 ---&gt; 4a725d3b3b1c</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">以后再使用的时候就直接使用这个镜像而不再需要下载了。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">Step 2：MAINTAINER sammy "sammy@sammy.com"</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">本例中依然是从 Cache 中环境新的镜像。在第一次的时候，Docker 会创建一个临时的容器&nbsp;1be8f33c1846，然后运行 MAINTAINER 命令，再使用 docker commit 生成新的镜像</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>Step <span style="color:rgb(128,0,128);line-height:1.5;">2</span> : MAINTAINER sammy <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">sammy@sammy.com</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>
 ---&gt; Running <span style="color:rgb(0,0,255);line-height:1.5;">in</span><span style="line-height:1.5;"> 1be8f33c1846
 </span>---&gt; c4299e3f774c</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">通过这个临时容器的过程（create -&gt; commit -&gt; destroy），生成了新的镜像&nbsp;c4299e3f774c：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre><span style="color:rgb(128,0,128);line-height:1.5;">2016</span>-<span style="color:rgb(128,0,128);line-height:1.5;">09</span>-16T21:<span style="color:rgb(128,0,128);line-height:1.5;">58</span>:<span style="color:rgb(128,0,128);line-height:1.5;">09.010886393</span>+<span style="color:rgb(128,0,128);line-height:1.5;">08</span>:<span style="color:rgb(128,0,128);line-height:1.5;">00</span> container create 1be8f33c18469f089d1eee8c444dad1ff0c7309be82767092082311379245358 (image=sha256:4a725d3b3b1cc18c8cbd05358ffbbfedfe1eb947f58061e5858f08e2899731ee, name=<span style="line-height:1.5;">focused_poitras)
</span><span style="color:rgb(128,0,128);line-height:1.5;">2016</span>-<span style="color:rgb(128,0,128);line-height:1.5;">09</span>-16T21:<span style="color:rgb(128,0,128);line-height:1.5;">58</span>:<span style="color:rgb(128,0,128);line-height:1.5;">09.060071206</span>+<span style="color:rgb(128,0,128);line-height:1.5;">08</span>:<span style="color:rgb(128,0,128);line-height:1.5;">00</span> container commit 1be8f33c18469f089d1eee8c444dad1ff0c7309be82767092082311379245358 (comment=, image=sha256:4a725d3b3b1cc18c8cbd05358ffbbfedfe1eb947f58061e5858f08e2899731ee, name=<span style="line-height:1.5;">focused_poitras)
</span><span style="color:rgb(128,0,128);line-height:1.5;">2016</span>-<span style="color:rgb(128,0,128);line-height:1.5;">09</span>-16T21:<span style="color:rgb(128,0,128);line-height:1.5;">58</span>:<span style="color:rgb(128,0,128);line-height:1.5;">09.071988068</span>+<span style="color:rgb(128,0,128);line-height:1.5;">08</span>:<span style="color:rgb(128,0,128);line-height:1.5;">00</span> container destroy 1be8f33c18469f089d1eee8c444dad1ff0c7309be82767092082311379245358 (image=sha256:4a725d3b3b1cc18c8cbd05358ffbbfedfe1eb947f58061e5858f08e2899731ee, name=focused_poitras)</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">这个镜像是基于 ubuntu 14.04 基础镜像生成的，layers 没有变化，只是元数据 CMD 发生了改变：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Cmd</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">: [
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">/bin/sh</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">-c</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">#(nop) </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">MAINTAINER sammy \"sammy@sammy.com\"</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">
            ]</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">因此可以认为只是镜像的元数据发生了改变。生成的新的镜像作为中间镜像会被保存在 cache 中。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;Step 3:&nbsp;RUN apt-get update</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">本例中Docker 仍然从缓存中获取了镜像。在第一次的时候，Docker 仍然是通过创建临时容器在执行 docker commit 的方式来创建新的镜像：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>Step <span style="color:rgb(128,0,128);line-height:1.5;">3</span> : RUN apt-<span style="color:rgb(0,0,255);line-height:1.5;">get</span><span style="line-height:1.5;"> update
 </span>---&gt; Running <span style="color:rgb(0,0,255);line-height:1.5;">in</span><span style="line-height:1.5;"> 8b3b97af3bd7
Ign http:</span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">archive.ubuntu.com trusty InRelease</span>
Get:<span style="color:rgb(128,0,128);line-height:1.5;">1</span> http:<span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">archive.ubuntu.com trusty-updates InRelease [65.9 kB]</span>
<span style="line-height:1.5;">...
</span>Get:<span style="color:rgb(128,0,128);line-height:1.5;">22</span> http:<span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">archive.ubuntu.com trusty/universe amd64 Packages [7589 kB]</span><span style="line-height:1.5;">
Fetched </span><span style="color:rgb(128,0,128);line-height:1.5;">22.2</span> MB <span style="color:rgb(0,0,255);line-height:1.5;">in</span> 16min 21s (<span style="color:rgb(128,0,128);line-height:1.5;">22.6</span> kB/<span style="line-height:1.5;">s)
Reading package lists...
 </span>---&gt;<span style="line-height:1.5;"> 694a19d54103
Removing intermediate container 8b3b97af3bd7</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">通过以上步骤，生成了新的中间镜像&nbsp;694a19d54103，它也会被保存在缓存中。你可以使用 docker inspect&nbsp;694a19d54103 命令查看该中间镜像，但是无法在docker images 列表中找到它，这是因为 docker images 默认隐藏了中间状态的镜像，因此你需要使用 docker images -a 来获取它：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>root@devstack:/home/sammy# docker images -a |<span style="line-height:1.5;"> grep 694a19d54103
</span>&lt;none&gt;                  &lt;none&gt;              694a19d54103        <span style="color:rgb(128,0,128);line-height:1.5;">11</span> hours ago        <span style="color:rgb(128,0,128);line-height:1.5;">210.1</span> MB</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">该镜像和原始镜像相比，多了一个 layer，它保存的是 apt-get update 命令所带来的变化：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">RootFS</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">: {
            </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Type</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">layers</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
            </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Layers</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">: [
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">sha256:102fca64f92471ff7fca48e55807ae2471502822ba620292b0a06ebcab907cf4</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">sha256:24fe29584c046f2a88f7f566dd0bf7b08a8c0d393dfad8370633b0748bba8cbc</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">sha256:530d731d21e1b1bbe356d70d3bca4d72d76fed89e90faab271d29bd58c8ccea4</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">sha256:344f56a35ff9fc747ada7d2b88bd21c49b2ec404872662cbaf0a65201873c0c6</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">sha256:ffb6ddc7582aa7e2e73f102df3ffcd272e59b7cf3f7abefe08d11a7c85dea53a</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                </span><span style="color:rgb(51,102,255);line-height:1.5;">"sha256:a1afe95c99b39c30b5c1d3e8fda451bd3f066be304616197f1046e64cf6cda93" #这一层是新加的</span><span style="line-height:1.5;">
            ]
        }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">Step 4:&nbsp;RUN apt-get -y install ntp</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">和上面 Step 3 过程一样，这个步骤也会通过创建临时容器，执行该命令，再使用 docker commit 命令生成一个中间镜像&nbsp;9cc05cf6f48d&nbsp;。和上面步骤生成的镜像相比，它又多了一层：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>root@devstack:/home/sammy# docker images -a |<span style="line-height:1.5;"> grep 9cc05cf6f48d
</span>&lt;none&gt;                  &lt;none&gt;              9cc05cf6f48d        <span style="color:rgb(128,0,128);line-height:1.5;">10</span> hours ago        <span style="color:rgb(128,0,128);line-height:1.5;">212.8</span><span style="line-height:1.5;"> MB
root@devstack:</span>/home/sammy# docker inspect --format={{<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">.RootFS.Layers</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">}} 9cc05cf6f48d
[sha256:102fca64f92471ff7fca48e55807ae2471502822ba620292b0a06ebcab907cf4 <br>
sha256:24fe29584c046f2a88f7f566dd0bf7b08a8c0d393dfad8370633b0748bba8cbc <br>
sha256:530d731d21e1b1bbe356d70d3bca4d72d76fed89e90faab271d29bd58c8ccea4 <br>
sha256:344f56a35ff9fc747ada7d2b88bd21c49b2ec404872662cbaf0a65201873c0c6 <br>
sha256:ffb6ddc7582aa7e2e73f102df3ffcd272e59b7cf3f7abefe08d11a7c85dea53a <br>
sha256:a1afe95c99b39c30b5c1d3e8fda451bd3f066be304616197f1046e64cf6cda93 <br><span style="color:rgb(51,102,255);line-height:1.5;">sha256:a93086f33a2b7ee18eec2454b468141f95a403f5081284b6f177f83cdb3d54ba</span>]</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">Step 5:&nbsp;EXPOSE 5555</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;这一步和上面的 Step 2 一样，Docker 生成了一个临时容器，执行 EXPOSE 55 命令，再通过 docker commit 创建了中间镜像&nbsp;f5c96137bec9。该镜像的 layers 没有变化，但是元数据发生了一些变化，包括：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ExposedPorts</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">: {
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">5555/tcp</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">: {}
            }
</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Cmd</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">: [
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">/bin/sh</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">-c</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">#(nop) </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">EXPOSE 5555/tcp</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">
            ]</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">Step 6:&nbsp;CMD ["/usr/sbin/ntpd"]</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">这一步和上面的步骤相同，最终它创建了镜像&nbsp;af678df648bc，该镜像只是修改了 CMD 元数据：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre> <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Cmd</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">: [
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">/bin/sh</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">-c</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">#(nop) </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">CMD [\"/usr/sbin/ntpd\"]</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">
            ]</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">该镜像也是Docker 根据本 Dockerfile 生成的最终镜像。它也出现在了 docker images 结果中：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>root@devstack:/home/sammy# docker images |<span style="line-height:1.5;"> grep af678df648bc
sammy_ntp2              latest              af678df648bc        </span><span style="color:rgb(128,0,128);line-height:1.5;">11</span> hours ago        <span style="color:rgb(128,0,128);line-height:1.5;">212.8</span> MB</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">我们可以使用 docker history 命令查看该镜像中每一层的信息：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>root@devstack:/home/sammy/<span style="line-height:1.5;">ntponubuntu# docker history af678df648bc
IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT
af678df648bc        </span><span style="color:rgb(128,0,128);line-height:1.5;">16</span> hours ago        /bin/sh -c #(nop)  CMD [<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">/usr/sbin/ntpd</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>]       <span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;"> B
f5c96137bec9        </span><span style="color:rgb(128,0,128);line-height:1.5;">16</span> hours ago        /bin/sh -c #(nop)  EXPOSE <span style="color:rgb(128,0,128);line-height:1.5;">5555</span>/tcp              <span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;"> B
9cc05cf6f48d        </span><span style="color:rgb(128,0,128);line-height:1.5;">16</span> hours ago        /bin/sh -c apt-<span style="color:rgb(0,0,255);line-height:1.5;">get</span> -y install ntp               <span style="color:rgb(128,0,128);line-height:1.5;">2.679</span><span style="line-height:1.5;"> MB
694a19d54103        </span><span style="color:rgb(128,0,128);line-height:1.5;">16</span> hours ago        /bin/sh -c apt-<span style="color:rgb(0,0,255);line-height:1.5;">get</span> update                       <span style="color:rgb(128,0,128);line-height:1.5;">22.17</span><span style="line-height:1.5;"> MB
c4299e3f774c        </span><span style="color:rgb(128,0,128);line-height:1.5;">17</span> hours ago        /bin/sh -c #(nop)  MAINTAINER sammy <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">sammy@sa   0 B</span>
4a725d3b3b1c        <span style="color:rgb(128,0,128);line-height:1.5;">3</span> weeks ago         /bin/sh -c #(nop) CMD [<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">/bin/bash</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>]             <span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;"> B
</span>&lt;missing&gt;           <span style="color:rgb(128,0,128);line-height:1.5;">3</span> weeks ago         /bin/sh -c mkdir -p /run/systemd &amp;&amp; echo <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">doc   7 B</span>
&lt;missing&gt;           <span style="color:rgb(128,0,128);line-height:1.5;">3</span> weeks ago         /bin/sh -c sed -i <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">s/^#\s*\(deb.*universe\)$/   1.895 kB</span>
&lt;missing&gt;           <span style="color:rgb(128,0,128);line-height:1.5;">3</span> weeks ago         /bin/sh -c rm -rf /<span style="color:rgb(0,0,255);line-height:1.5;">var</span>/lib/apt/lists<span style="color:rgb(0,128,0);line-height:1.5;">/*</span><span style="color:rgb(0,128,0);line-height:1.5;">          0 B
&lt;missing&gt;           3 weeks ago         /bin/sh -c set -xe   &amp;&amp; echo '#!/bin/sh' &gt; /u   194.6 kB
&lt;missing&gt;           3 weeks ago         /bin/sh -c #(nop) ADD file:ada91758a31d8de3c7   187.8 MB</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">以上过程说明：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">容器镜像包括元数据和文件系统，其中文件系统是指对基础镜像的文件系统的修改，元数据不影响文件系统，只是会影响容器的配置</li> 
    <li style="list-style-type:disc;">每个步骤都会生成一个新的镜像，新的镜像与上一次的镜像相比，要么元数据有了变化，要么文件系统有了变化而多加了一层</li> 
    <li style="list-style-type:disc;">Docker 在需要执行指令时通过创建临时镜像，运行指定的命令，再通过 docker commit 来生成新的镜像</li> 
    <li style="list-style-type:disc;">Docker 会将中间镜像都保存在缓存中，这样将来如果能直接使用的话就不需要再从头创建了。关于镜像缓存，请搜索相关文档。</li> 
   </ul>
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.2 Docker 镜像分层,COW 和 镜像大小（size）</h3> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1.2.1 镜像分层和容器层</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/697113/201609/697113-20160917210455258-731213001.jpg" alt="" width="512" height="350" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; 从上面例子可以看出，一个 Docker 镜像是基于基础镜像的多层叠加，最终构成和容器的 rootfs （根文件系统）。当 Docker 创建一个容器时，它会在基础镜像的容器层之上添加一层新的薄薄的可写容器层。接下来，所有对容器的变化，比如写新的文件，修改已有文件和删除文件，都只会作用在这个容器层之中。因此，通过不拷贝完整的 rootfs，Docker 减少了容器所占用的空间，以及减少了容器启动所需时间。</p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1.2.2 COW 和镜像大小</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; COW，copy-on-write 技术，一方面带来了容器启动的快捷，另一方也造成了容器镜像大小的增加。每一次 RUN 命令都会在镜像上增加一层，每一层都会占用磁盘空间。举个例子，在 Ubuntu 14.04 基础镜像中运行 RUN apt-get upgrade 会在保留基础层的同时再创建一个新层来放所有新的文件，而不是修改老的文件，因此，新的镜像大小会超过直接在老的文件系统上做更新时的文件大小。因此，为了减少镜像大小起见，所有文件相关的操作，比如删除，释放和移动等，都需要尽可能地放在一个 RUN 指令中进行。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; 比如说，通过将上面的示例 Dockerfile 修改为：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>FROM ubuntu:<span style="color:rgb(128,0,128);line-height:1.5;">14.04</span><span style="line-height:1.5;">
MAINTAINER sammy </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">sammy@sammy.com</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">
RUN apt</span>-<span style="color:rgb(0,0,255);line-height:1.5;">get</span> update &amp;&amp; apt-<span style="color:rgb(0,0,255);line-height:1.5;">get</span> -<span style="line-height:1.5;">y install ntp
EXPOSE </span><span style="color:rgb(128,0,128);line-height:1.5;">5555</span><span style="line-height:1.5;">
CMD [</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">/usr/sbin/ntpd</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>]</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">结果产生的镜像，不仅层数少了一层（7 -&gt; 6），而且大小减少了 0.001M ：），因为这个例子比较特殊，文件都是添加，而没有更新，因此size 的下降非常小。</p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1.2.3 使用容器需要避免的一些做法</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">这篇文章&nbsp;<a href="http://developers.redhat.com/blog/2016/02/24/10-things-to-avoid-in-docker-containers/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">10 things to avoid in docker containers</a>&nbsp;列举了一些在使用容器时需要避免的做法，包括：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">不要在容器中保存数据（<strong>Don’t store data in containers</strong>）</li> 
    <li style="list-style-type:disc;">将应用打包到镜像再部署而不是更新到已有容器（<strong>Don’t ship your application in two pieces</strong>）</li> 
    <li style="list-style-type:disc;">不要产生过大的镜像 （<strong>Don’t create large images</strong>）</li> 
    <li style="list-style-type:disc;">不要使用单层镜像 （<strong>Don’t use a single layer&nbsp;image</strong>）</li> 
    <li style="list-style-type:disc;">不要从运行着的容器上产生镜像 （<strong>Don’t create images&nbsp;from running containers</strong>&nbsp;）</li> 
    <li style="list-style-type:disc;">不要只是使用 “latest”标签 （<strong>Don’t use only the “latest” tag</strong>）</li> 
    <li style="list-style-type:disc;">不要在容器内运行超过一个的进程 （<strong>Don’t run more than one process in a single container</strong>&nbsp;）</li> 
    <li style="list-style-type:disc;">不要在容器内保存 credentials，而是要从外面通过环境变量传入 （<strong>&nbsp;Don’t store credentials&nbsp;in the image. Use environment variables</strong>）</li> 
    <li style="list-style-type:disc;">不要使用 root 用户跑容器进程（<strong>Don’t run processes as a root user</strong>&nbsp;）</li> 
    <li style="list-style-type:disc;">不要依赖于IP地址，而是要从外面通过环境变量传入 （<strong>Don’t rely&nbsp;on IP&nbsp;addresses</strong>&nbsp;）</li> 
   </ul>
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">2. Dockerfile 语法</h2> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">上面的步骤说明了 Docker 可以通过读取 Dockerfile 的内容来生成容器镜像。Dockerfile 的每一行都是&nbsp;INSTRUCTION arguments 格式，即 “指令 参数”。关于 Dockerfile 的预防，请参考&nbsp;<a href="https://docs.docker.com/engine/reference/builder/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">https://docs.docker.com/engine/reference/builder/</a>。下面只是就一些主要的指令做一些说明。</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.1 几个主要指令</h3> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">2.1.1 ADD 和 COPY</h4> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    Add：将 host 上的文件拷贝到或者将网络上的文件下载到容器中的指定目录
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
     <pre><span style="line-height:1.5;"># Usage: ADD [source directory or URL] [destination directory]
ADD </span>/my_app_folder /my_app_folder</pre>
    </div> 
    <p style="line-height:1.5;">例子：</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
     <pre>FROM ubuntu:<span style="color:rgb(128,0,128);line-height:1.5;">14.04</span><span style="line-height:1.5;">
MAINTAINER Sammy Liu </span>&lt;sammy.liu@unknow.com&gt;<span style="line-height:1.5;">
ADD temp dockfile
ENTRYPOINT top</span></pre>
    </div> 
    <p style="line-height:1.5;">ADD 指令会将本地 temp 目录中的文件拷贝到容器的 dockfile 目录下面，从而在镜像中增加一个 layer。在未指定绝对路径的时候，会放到 WORKDIR 目录下面。</p> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
     <pre>root@cc2a5605f905:/# ls dockfile/<span style="line-height:1.5;">
dockerfile</span>-add  dockerfile-cmd  dockerfile-env  dockerfile-ports  dockerfile-user  dockerfile-user-<span style="line-height:1.5;">h
root@cc2a5605f905:</span>/<span style="line-height:1.5;"># pwd
</span>/</pre>
    </div> 
    <p style="line-height:1.5;">那两者有什么区别呢？</p> 
    <ul style="list-style:none;font-size:12px;">
     <li style="list-style-type:disc;">ADD 多了2个功能, 下载URL和对支持的压缩格式的包进行解压. &nbsp;其他都一样。比如&nbsp;<span style="line-height:1.5;font-family:'Courier New';"><span style="line-height:1.5;">ADD http://foo.com/bar.go /tmp/main.go 会将文件从因特网上方下载下来，</span></span><span style="line-height:1.5;font-family:'Courier New';">ADD /foo.tar.gz /tmp/ 会将压缩文件解压再COPY过去</span> </li> 
     <li style="list-style-type:disc;">如果你不希望压缩文件拷贝到container后会被解压的话, 那么使用COPY。</li> 
     <li style="list-style-type:disc;">如果需要自动下载URL并拷贝到container的话, 请使用ADD</li> 
    </ul>
    <h4 style="font-size:14px;">2.1.2 CMD</h4> 
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    CMD：在容器被创建后执行的命令，和 RUN 不同，它是在构造容器时候所执行的命令
   </div> 
   <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
     <pre># Usage <span style="color:rgb(128,0,128);line-height:1.5;">1</span>: CMD application <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">argument</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">argument</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, ..
CMD </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">echo</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Hello docker!</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span></pre>
    </div> 
    <p style="line-height:1.5;">CMD 有三种格式:</p> 
    <ul style="list-style:none;font-size:12px;">
     <li style="list-style-type:disc;"> <code>CMD ["executable","param1","param2"]</code>&nbsp;(like an exec, preferred form)</li> 
     <li style="list-style-type:disc;"> <code>CMD ["param1","param2"]</code>&nbsp;(作为 ENTRYPOINT 的参数)</li> 
     <li style="list-style-type:disc;"> <code>CMD command param1 param2</code>&nbsp;(作为 shell 运行)</li> 
    </ul>
    <p style="line-height:1.5;">一个Dockerfile里只能有一个<code>CMD</code>，如果有多个，只有最后一个生效。</p> 
    <h4 style="font-size:14px;">2.1.3&nbsp;ENTRYPOINT</h4> 
    <p style="line-height:1.5;">ENTRYPOINT ：设置默认应用，会保证每次容器被创建后该应用都会被执行。CMD 和 ENTRYPOINT 的关系会在下面详细解释。</p> 
   </div> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">2.1.4&nbsp;ENV：设置环境变量，可以使用多次</h4> 
   <div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
     <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
      <pre><span style="line-height:1.5;"># Usage: ENV key value
ENV SERVER_WORKS </span><span style="color:rgb(128,0,128);line-height:1.5;">4</span></pre>
     </div> 
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
     <p style="line-height:1.5;">设置了后，后续的<code>RUN</code>命令都可以使用，并且会作为容器的环境变量。举个例子，下面是 dockfile：</p> 
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
     <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
      <pre>FROM ubuntu:<span style="color:rgb(128,0,128);line-height:1.5;">14.04</span><span style="line-height:1.5;">
ENV abc</span>=<span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">
ENV def</span>=<span style="color:rgb(128,0,128);line-height:1.5;">2</span><span style="line-height:1.5;">
ENTRYPOINT top</span></pre>
     </div> 
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
     <p style="line-height:1.5;">生成镜像：docker build -t envimg4 -f dockerfile-env . 其元数据包括了这两个环境变量：</p> 
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
     <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
      <pre><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Env</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">: [
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">abc=1</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">def=2</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">
            ],</span></pre>
     </div> 
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
     <p style="line-height:1.5;">启动容器：docker run -it --name envc41 envimg4。也能看到：</p> 
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
     <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
      <pre><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Env</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">: [
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">abc=1</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">def=2</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">
            ]</span></pre>
     </div> 
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
     <p style="line-height:1.5;">进入容器：能看到定义的 abc 和 def 变量</p> 
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
     <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
      <pre>root@devstack:/home/sammy/ntponubuntu# docker exec -<span style="line-height:1.5;">it envc41 bash
root@ba460e0e9dc4:</span>/<span style="line-height:1.5;"># echo $abc
</span><span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">
root@ba460e0e9dc4:</span>/<span style="line-height:1.5;"># echo $def
</span><span style="color:rgb(128,0,128);line-height:1.5;">2</span></pre>
     </div> 
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
     <h4 style="font-size:14px;">2.1.5&nbsp;EXPOSE ：向容器外暴露一个端口</h4> 
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"> 
     <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
      <pre><span style="line-height:1.5;"># Usage: EXPOSE [port]
EXPOSE </span><span style="color:rgb(128,0,128);line-height:1.5;">8080</span></pre>
     </div> 
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;"> 
     <h4 style="font-size:14px;">2.1.6 FROM：指定进行的基础镜像，必须是第一条指令</h4> 
     <div style="font-size:15px;"> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.5;"># Usage: FROM [image name]
FROM ubuntu</span></pre>
      </div> 
      <h4 style="font-size:14px;">2.1.7&nbsp;MAINTAINER：可以在任意地方使用，设置镜像的作者</h4> 
      <div> 
       <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
        <pre><span style="line-height:1.5;"># Usage: MAINTAINER [name]
MAINTAINER authors_name</span></pre>
       </div> 
       <h4 style="font-size:14px;">2.1.8&nbsp;RUN：运行命令，结果会生成镜像中的一个新层</h4> 
       <div> 
        <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
         <pre><span style="line-height:1.5;"># Usage: RUN [command]
RUN aptitude install </span>-y ntp</pre>
        </div> 
        <h4 style="font-size:14px;">2.1.9&nbsp;USER：设置该镜像的容器的主进程所使用的用户，以及后续 RUN, CMD 和 ENTRYPOINT 指令运行所使用的用户</h4> 
        <p style="line-height:1.5;">语法：</p> 
        <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
         <pre><span style="line-height:1.5;"># Usage: USER [UID]
USER 751</span>&nbsp;</pre>
        </div> 
        <p style="line-height:1.5;">Dockerfile 中的默认用户是基础镜像中所使用的用户。比如，你的镜像是从一个使用非 root 用户 sammy 的镜像继承而来的，那么你的 Dockerfile 中 RUN 指定运行的命令的用户就会使用 sammy 用户。</p> 
        <p style="line-height:1.5;">举例：</p> 
        <p style="line-height:1.5;">（1）创建 dockerfile 文件</p> 
        <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
         <pre>root@devstack:/home/sammy/dockerfile# cat dockerfile-<span style="line-height:1.5;">user
FROM ubuntu:</span><span style="color:rgb(128,0,128);line-height:1.5;">14.04</span><span style="line-height:1.5;">
USER </span><span style="color:rgb(128,0,128);line-height:1.5;">1000</span><span style="line-height:1.5;">
ENTRYPOINT top</span></pre>
        </div> 
        <p style="line-height:1.5;"><span style="line-height:1.5;font-size:1em;">（2）创建镜像：docker build -t dockerfile-user-1000 -f dockerfile-user .</span></p> 
        <p style="line-height:1.5;"><span style="line-height:1.5;font-size:1em;">（3）启动容器：docker run -it --name c-user-1000-3 dockerfile-user-1000 top</span></p> 
        <p style="line-height:1.5;"><span style="line-height:1.5;font-size:1em;">能看出来当前用户ID 为 1000：</span>&nbsp;</p> 
        <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
         <pre>PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+<span style="line-height:1.5;"> COMMAND
    </span><span style="color:rgb(128,0,128);line-height:1.5;">1</span> <span style="color:rgb(128,0,128);line-height:1.5;">1000</span>      <span style="color:rgb(128,0,128);line-height:1.5;">20</span>   <span style="color:rgb(128,0,128);line-height:1.5;">0</span>    <span style="color:rgb(128,0,128);line-height:1.5;">4440</span>    <span style="color:rgb(128,0,128);line-height:1.5;">648</span>    <span style="color:rgb(128,0,128);line-height:1.5;">548</span> S  <span style="color:rgb(128,0,128);line-height:1.5;">0.0</span>  <span style="color:rgb(128,0,128);line-height:1.5;">0.0</span>   <span style="color:rgb(128,0,128);line-height:1.5;">0</span>:<span style="color:rgb(128,0,128);line-height:1.5;">00.00</span><span style="line-height:1.5;"> sh
    </span><span style="color:rgb(128,0,128);line-height:1.5;">5</span> <span style="color:rgb(128,0,128);line-height:1.5;">1000</span>      <span style="color:rgb(128,0,128);line-height:1.5;">20</span>   <span style="color:rgb(128,0,128);line-height:1.5;">0</span>   <span style="color:rgb(128,0,128);line-height:1.5;">19840</span>   <span style="color:rgb(128,0,128);line-height:1.5;">1296</span>    <span style="color:rgb(128,0,128);line-height:1.5;">984</span> R  <span style="color:rgb(128,0,128);line-height:1.5;">0.0</span>  <span style="color:rgb(128,0,128);line-height:1.5;">0.1</span>   <span style="color:rgb(128,0,128);line-height:1.5;">0</span>:<span style="color:rgb(128,0,128);line-height:1.5;">00.00</span> top<span style="line-height:1.5;font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</span></pre>
        </div> 
        <p style="line-height:1.5;">（4）基于该镜像再创造一个镜像，然后再启动一个容器，可以发现容器中进程所使用的用户ID 同样为 1000.&nbsp;</p> 
        <h4 style="font-size:14px;"><span style="line-height:1.5;font-size:1em;">2.1.10&nbsp;VOLUME：允许容器访问host上某个目录</span></h4> 
        <div> 
         <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
          <pre># Usage: VOLUME [<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">/dir_1</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">/dir_2</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> ..]
VOLUME [</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">/my_files</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>]</pre>
         </div> 
         <h4 style="font-size:14px;">2.1.11&nbsp;WORKDIR：设置 CMD 所指定命令的执行目录</h4> 
         <div> 
          <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
           <pre># Usage: WORKDIR /<span style="line-height:1.5;">path
WORKDIR </span>~/</pre>
          </div> 
          <h4 style="font-size:14px;">2.1.12 HEALTHCHECK： 容器健康检查</h4> 
          <p style="line-height:1.5;">这是 Docker 1.12 版本中新引入的指令，其语法为 HEALTHCHECK [OPTIONS] CMD command。&nbsp;来看一个例子：</p> 
          <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
           <div class="cnblogs_code_toolbar">
            <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
           </div> 
           <pre>FROM ubuntu:<span style="color:rgb(128,0,128);line-height:1.5;">14.04</span><span style="line-height:1.5;">
MAINTAINER Sammy Liu </span>&lt;sammy.liu@unknow.com&gt;<span style="line-height:1.5;">
RUN apt</span>-<span style="color:rgb(0,0,255);line-height:1.5;">get</span><span style="line-height:1.5;"> update
RUN apt</span>-<span style="color:rgb(0,0,255);line-height:1.5;">get</span> -<span style="line-height:1.5;">y install curl
EXPOSE </span><span style="color:rgb(128,0,128);line-height:1.5;">8888</span><span style="line-height:1.5;">
CMD </span><span style="color:rgb(0,0,255);line-height:1.5;">while</span> <span style="color:rgb(0,0,255);line-height:1.5;">true</span>; <span style="color:rgb(0,0,255);line-height:1.5;">do</span> echo <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">hello world</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> | nc -l -p <span style="color:rgb(128,0,128);line-height:1.5;">8888</span><span style="line-height:1.5;">; done
HEALTHCHECK </span>--interval=10s --timeout=2s CMD curl -f http:<span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">localhost:8888/ || exit 1</span></pre> 
           <div class="cnblogs_code_toolbar">
            <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
           </div> 
          </div> 
          <p style="line-height:1.5;">在启动容器后，其health 状态首先是 starting，然后在过了10秒做了第一次健康检查成功后，变为 healthy 状态。</p> 
          <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
           <div class="cnblogs_code_toolbar">
            <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
           </div> 
           <pre>root@devstack:/home/sammy/dockerfile# docker ps | grep c-<span style="line-height:1.5;">health2
4c459eef1894        img</span>-health2         <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">/bin/sh -c 'while tr</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>   <span style="color:rgb(128,0,128);line-height:1.5;">7</span> seconds ago       Up <span style="color:rgb(128,0,128);line-height:1.5;">6</span> seconds (health: starting)   <span style="color:rgb(128,0,128);line-height:1.5;">8888</span>/tcp                  c-<span style="line-height:1.5;">health2
root@devstack:</span>/home/sammy/dockerfile# docker ps | grep c-<span style="line-height:1.5;">health2
4c459eef1894        img</span>-health2         <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">/bin/sh -c 'while tr</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>   <span style="color:rgb(128,0,128);line-height:1.5;">9</span> seconds ago       Up <span style="color:rgb(128,0,128);line-height:1.5;">8</span> seconds (health: starting)   <span style="color:rgb(128,0,128);line-height:1.5;">8888</span>/tcp                  c-<span style="line-height:1.5;">health2
root@devstack:</span>/home/sammy/dockerfile# docker ps | grep c-<span style="line-height:1.5;">health2
4c459eef1894        img</span>-health2         <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">/bin/sh -c 'while tr</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>   <span style="color:rgb(128,0,128);line-height:1.5;">11</span> seconds ago      Up <span style="color:rgb(128,0,128);line-height:1.5;">11</span> seconds (healthy)     <span style="color:rgb(128,0,128);line-height:1.5;">8888</span>/tcp                  c-health2</pre> 
           <div class="cnblogs_code_toolbar">
            <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
           </div> 
          </div> 
          <p style="line-height:1.5;">需要注意的是 CMD 是在容器之内运行的，因此，你需要确保其命令或者脚本存在于容器之内并且可以被运行。</p> 
          <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.2 几个比较绕的地方</h3> 
          <h4 style="font-size:14px;">2.2.1 EXPOSE 和 docker run -p -P 之间的关系</h4> 
          <p style="line-height:1.5;">容器的端口必须被发出（publish）出来后才能被外界使用。Dockerfile 中的 EXPOSE 只是“标记”某个端口会被暴露出来，只有在使用了 docker run -p 或者 -P 后，端口才会被“发出”出来，此时端口才能被使用。</p> 
          <p style="line-height:1.5;">举例：</p> 
          <p style="line-height:1.5;">（1）Dockerfile</p> 
          <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
           <pre>FROM ubuntu:<span style="color:rgb(128,0,128);line-height:1.5;">14.04</span><span style="line-height:1.5;">
MAINTAINER Sammy Liu </span>&lt;sammy.liu@unknow.com&gt;<span style="line-height:1.5;">
CMD </span><span style="color:rgb(0,0,255);line-height:1.5;">while</span> <span style="color:rgb(0,0,255);line-height:1.5;">true</span>; <span style="color:rgb(0,0,255);line-height:1.5;">do</span> echo <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">hello world</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> | nc -l -p <span style="color:rgb(128,0,128);line-height:1.5;">8888</span>; done</pre>
          </div> 
          <p style="line-height:1.5;">（2）创建镜像：docker build -t no-exposed-ports -f dockerfile-ports .</p> 
          <p style="line-height:1.5;">（3）启动容器1：docker run -d --name no-exposed-ports1 no-exposed-ports。此容器没有 exposed 和 published 任何端口。</p> 
          <p style="line-height:1.5;">（4）启动容器2：docker run -d --name no-exposed-ports2 -p 8888:8888 no-exposed-ports</p> 
          <p style="line-height:1.5;">此时容器的 8888 端口被发布为主机上的 8888 端口：</p> 
          <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
           <div class="cnblogs_code_toolbar">
            <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
           </div> 
           <pre><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Ports</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">: {
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">8888/tcp</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">: [
                    {
                        </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">HostIp</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">0.0.0.0</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                        </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">HostPort</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">8888</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">
                    }
                ]
            }</span></pre> 
           <div class="cnblogs_code_toolbar">
            <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
           </div> 
          </div> 
          <p style="line-height:1.5;">该端口会正确返回：</p> 
          <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
           <div class="cnblogs_code_toolbar">
            <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
           </div> 
           <pre>root@devstack:/home/sammy/dockerfile# telnet <span style="color:rgb(128,0,128);line-height:1.5;">0.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.0</span> <span style="color:rgb(128,0,128);line-height:1.5;">8888</span><span style="line-height:1.5;">
Trying </span><span style="color:rgb(128,0,128);line-height:1.5;">0.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.0</span><span style="line-height:1.5;">...
Connected to </span><span style="color:rgb(128,0,128);line-height:1.5;">0.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.0</span><span style="line-height:1.5;">.
Escape character </span><span style="color:rgb(0,0,255);line-height:1.5;">is</span> <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">^]</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="line-height:1.5;">.
hello world
Connection closed by foreign host.</span></pre> 
           <div class="cnblogs_code_toolbar">
            <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
           </div> 
          </div> 
          <p style="line-height:1.5;">（5）使用 -P 参数：docker run -d --name no-exposed-ports3 -P no-exposed-ports</p> 
          <p style="line-height:1.5;">此时没有任何端口被 published，说明 Docker 在使用了 “-P” 情形下只是自动将 exposed 的端口 published。</p> 
          <p style="line-height:1.5;">（6）使用 -p 加上一个不存在的端口：docker run -d --name no-exposed-ports4 -p 8889:8889 no-exposed-ports</p> 
          <p style="line-height:1.5;">此时，8889 端口会被暴露，但是没法使用。说明 -p 会将没有 exposed 的端口自动 exposed 出来。</p> 
          <p style="line-height:1.5;">（7）修改 dockerfile 为：</p> 
          <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
           <pre>FROM ubuntu:<span style="color:rgb(128,0,128);line-height:1.5;">14.04</span><span style="line-height:1.5;">
MAINTAINER Sammy Liu </span>&lt;sammy.liu@unknow.com&gt;<span style="line-height:1.5;">
EXPOSE </span><span style="color:rgb(128,0,128);line-height:1.5;">8888</span><span style="line-height:1.5;">
CMD </span><span style="color:rgb(0,0,255);line-height:1.5;">while</span> <span style="color:rgb(0,0,255);line-height:1.5;">true</span>; <span style="color:rgb(0,0,255);line-height:1.5;">do</span> echo <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">hello world</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> | nc -l -p <span style="color:rgb(128,0,128);line-height:1.5;">8888</span>; done</pre>
          </div> 
          <p style="line-height:1.5;">创建镜像exposed-ports， 再运行&nbsp;docker run -d --name exposed-ports1 -P exposed-ports 创建一个容器，此时 8888 端口自动被 published 为主机上的 32776 端口：</p> 
          <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
           <div class="cnblogs_code_toolbar">
            <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
           </div> 
           <pre><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Ports</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">: {
                </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">8888/tcp</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">: [
                    {
                        </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">HostIp</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">0.0.0.0</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">,
                        </span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">HostPort</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>: <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">32776</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">
                    }
                ]
            }</span></pre> 
           <div class="cnblogs_code_toolbar">
            <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
           </div> 
          </div> 
          <p style="line-height:1.5;">可见：</p> 
          <ul style="list-style:none;font-size:12px;">
           <li style="list-style-type:disc;"> <code class="prettyprint">EXPOSE</code>或者<code class="prettyprint">--expose</code>只是为其他命令提供所需信息的元数据，或者只是告诉容器操作人员有哪些已知选择。它只是作为记录机制，也就是告诉用户哪些端口会提供服务。它保存在容器的元数据中。</li> 
           <li style="list-style-type:disc;">使用 -p 发布特定端口。如果该端口已经被 exposed，则发布它；如果它还没有被 exposed，则它会被 exposed 和 published。Docker 不会检查容器端口的正确性。</li> 
           <li style="list-style-type:disc;">使用 -P 时 Docker 会自动将所有已经被 exposed 的端口发出出来。</li> 
          </ul>
          <h4 style="font-size:14px;">2.2.2 CMD 和 ENTRYPOINT</h4> 
          <p style="line-height:1.5;">这两个指令都指定了运行容器时所运行的命令。以下是它们共存的一些规则：</p> 
          <ul style="list-style:none;font-size:12px;">
           <li style="list-style-type:disc;">Dockerfile 至少需要指定一个 CMD 或者 ENTRYPOINT 指令</li> 
           <li style="list-style-type:disc;">CMD 可以用来指定 ENTRYPOINT 指令的参数</li> 
          </ul>
          <table border="0" style="border:1px solid #C0C0C0;border-collapse:collapse;">
           <tbody>
            <tr>
             <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><strong>&nbsp;</strong></td> 
             <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><strong><span style="line-height:1.5;font-size:14px;">没有 ENTRYPOINT</span></strong></td> 
             <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><strong><span style="line-height:1.5;font-size:14px;">ENTRYPOINT exec_entry p1_entry</span></strong></td> 
             <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><strong><span style="line-height:1.5;font-size:14px;">ENTRYPOINT [“exec_entry”, “p1_entry”]</span></strong></td> 
            </tr>
            <tr>
             <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><span style="line-height:1.5;font-size:14px;">没有 CMD</span></td> 
             <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><span style="line-height:1.5;font-size:14px;">错误，不允许</span></td> 
             <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><span style="line-height:1.5;font-size:14px;">/bin/sh -c exec_entry p1_entry</span></td> 
             <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><span style="line-height:1.5;font-size:14px;">&nbsp;exec_entry p1_entry</span></td> 
            </tr>
            <tr>
             <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><span style="line-height:1.5;font-size:14px;">CMD [“exec_cmd”, “p1_cmd”]</span></td> 
             <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><span style="line-height:1.5;font-size:14px;">&nbsp;exec_cmd p1_cmd</span></td> 
             <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><span style="line-height:1.5;font-size:14px;">&nbsp;/bin/sh -c exec_entry p1_entry exec_cmd p1_cmd</span></td> 
             <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><span style="line-height:1.5;font-size:14px;">&nbsp;exec_entry p1_entry exec_cmd p1_cmd</span></td> 
            </tr>
            <tr>
             <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><span style="line-height:1.5;font-size:14px;">CMD [“p1_cmd”, “p2_cmd”]</span></td> 
             <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><span style="line-height:1.5;font-size:14px;">&nbsp;p1_cmd p2_cmd</span></td> 
             <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><span style="line-height:1.5;font-size:14px;">&nbsp;/bin/sh -c exec_entry p1_entry p1_cmd p2_cmd</span></td> 
             <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><span style="line-height:1.5;font-size:14px;">&nbsp;exec_entry p1_entry p1_cmd p2_cmd</span></td> 
            </tr>
            <tr>
             <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><span style="line-height:1.5;font-size:14px;">CMD exec_cmd p1_cmd</span></td> 
             <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><span style="line-height:1.5;font-size:14px;">&nbsp;/bin/sh -c exec_cmd p1_cmd</span></td> 
             <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><span style="line-height:1.5;font-size:14px;">&nbsp;/bin/sh -c exec_entry p1_entry /bin/sh -c exec_cmd p1_cmd</span></td> 
             <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><span style="line-height:1.5;font-size:14px;">&nbsp;exec_entry p1_entry /bin/sh -c exec_cmd p1_cmd</span></td> 
            </tr>
            <tr>
             <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><span style="line-height:1.5;font-size:14px;">备注</span></td> 
             <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><span style="line-height:1.5;font-size:14px;">只有 CMD 时，执行 CMD 定义的指令</span></td> 
             <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;<span style="line-height:1.5;font-size:14px;">CMD 和 ENTRYPOINT 都存在时，CMD 的指令作为 ENTRYPOINT 的参数</span> </td> 
             <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
            </tr>
           </tbody>
          </table>
          <p style="line-height:1.5;">&nbsp;举例：</p> 
          <p style="line-height:1.5;">（1）同时有 CMD 和 ENTRYPOINT</p> 
          <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
           <pre>FROM ubuntu:<span style="color:rgb(128,0,128);line-height:1.5;">14.04</span><span style="line-height:1.5;">
MAINTAINER Sammy Liu </span>&lt;sammy.liu@unknow.com&gt;<span style="line-height:1.5;">
CMD top
ENTRYPOINT ps</span></pre>
          </div> 
          <p style="line-height:1.5;">此时会运行的指令为&nbsp;/bin/sh -c ps /bin/sh -c top</p> 
          <p style="line-height:1.5;">但是实际上只是运行了 ps：</p> 
          <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
           <div class="cnblogs_code_toolbar">
            <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
           </div> 
           <pre>root@devstack:/home/sammy/dockerfile# /bin/sh -c ps /bin/sh -<span style="line-height:1.5;">c top
  PID TTY          TIME CMD
</span><span style="color:rgb(128,0,128);line-height:1.5;">10789</span> pts/<span style="color:rgb(128,0,128);line-height:1.5;">3</span>    <span style="color:rgb(128,0,128);line-height:1.5;">00</span>:<span style="color:rgb(128,0,128);line-height:1.5;">00</span>:<span style="color:rgb(128,0,128);line-height:1.5;">00</span><span style="line-height:1.5;"> su
</span><span style="color:rgb(128,0,128);line-height:1.5;">10790</span> pts/<span style="color:rgb(128,0,128);line-height:1.5;">3</span>    <span style="color:rgb(128,0,128);line-height:1.5;">00</span>:<span style="color:rgb(128,0,128);line-height:1.5;">00</span>:<span style="color:rgb(128,0,128);line-height:1.5;">00</span><span style="line-height:1.5;"> bash
</span><span style="color:rgb(128,0,128);line-height:1.5;">18479</span> pts/<span style="color:rgb(128,0,128);line-height:1.5;">3</span>    <span style="color:rgb(128,0,128);line-height:1.5;">00</span>:<span style="color:rgb(128,0,128);line-height:1.5;">00</span>:<span style="color:rgb(128,0,128);line-height:1.5;">00</span><span style="line-height:1.5;"> sh
</span><span style="color:rgb(128,0,128);line-height:1.5;">18480</span> pts/<span style="color:rgb(128,0,128);line-height:1.5;">3</span>    <span style="color:rgb(128,0,128);line-height:1.5;">00</span>:<span style="color:rgb(128,0,128);line-height:1.5;">00</span>:<span style="color:rgb(128,0,128);line-height:1.5;">00</span><span style="line-height:1.5;"> ps
root@devstack:</span>/home/sammy/dockerfile# /bin/sh -<span style="line-height:1.5;">c ps
  PID TTY          TIME CMD
</span><span style="color:rgb(128,0,128);line-height:1.5;">10789</span> pts/<span style="color:rgb(128,0,128);line-height:1.5;">3</span>    <span style="color:rgb(128,0,128);line-height:1.5;">00</span>:<span style="color:rgb(128,0,128);line-height:1.5;">00</span>:<span style="color:rgb(128,0,128);line-height:1.5;">00</span><span style="line-height:1.5;"> su
</span><span style="color:rgb(128,0,128);line-height:1.5;">10790</span> pts/<span style="color:rgb(128,0,128);line-height:1.5;">3</span>    <span style="color:rgb(128,0,128);line-height:1.5;">00</span>:<span style="color:rgb(128,0,128);line-height:1.5;">00</span>:<span style="color:rgb(128,0,128);line-height:1.5;">00</span><span style="line-height:1.5;"> bash
</span><span style="color:rgb(128,0,128);line-height:1.5;">18481</span> pts/<span style="color:rgb(128,0,128);line-height:1.5;">3</span>    <span style="color:rgb(128,0,128);line-height:1.5;">00</span>:<span style="color:rgb(128,0,128);line-height:1.5;">00</span>:<span style="color:rgb(128,0,128);line-height:1.5;">00</span><span style="line-height:1.5;"> sh
</span><span style="color:rgb(128,0,128);line-height:1.5;">18482</span> pts/<span style="color:rgb(128,0,128);line-height:1.5;">3</span>    <span style="color:rgb(128,0,128);line-height:1.5;">00</span>:<span style="color:rgb(128,0,128);line-height:1.5;">00</span>:<span style="color:rgb(128,0,128);line-height:1.5;">00</span> ps</pre> 
           <div class="cnblogs_code_toolbar">
            <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
           </div> 
          </div> 
          <p style="line-height:1.5;">（2）CMD 作为 ENTRYPOINT 的参数</p> 
          <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
           <pre>FROM ubuntu:<span style="color:rgb(128,0,128);line-height:1.5;">14.04</span><span style="line-height:1.5;">
MAINTAINER Sammy Liu </span>&lt;sammy.liu@unknow.com&gt;<span style="line-height:1.5;">
CMD [</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">-n</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">10</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">]
ENTRYPOINT top</span></pre>
          </div> 
          <p style="line-height:1.5;">启动容器后运行的命令为&nbsp;/bin/sh -c top -n 10.</p> 
         </div> 
        </div> 
       </div> 
      </div> 
     </div> 
     <h2 style="font-size:21px;line-height:1.5;">3. 在 Docker hub 上创建自己的镜像</h2> 
     <p style="font-size:15px;line-height:1.5;">当我们从docker镜像仓库中下载的镜像不能满足我们的需求时，我们可以通过以下两种方式对镜像进行更改。</p> 
     <ul style="font-size:12px;list-style:none;">
      <li style="list-style-type:disc;">从已经创建的容器中更新镜像，并且提交这个镜像</li> 
      <li style="list-style-type:disc;">使用&nbsp;Dockerfile&nbsp;指令来创建一个新的镜像</li> 
     </ul>
     <p style="font-size:15px;line-height:1.5;">通过以下步骤，采用第一种方法，在 docker hub 上创建自己的镜像：</p> 
     <p style="font-size:15px;line-height:1.5;">（1）创建 docker hub 帐号。<a href="https://hub.docker.com/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">https://hub.docker.com/</a></p> 
     <p style="font-size:15px;line-height:1.5;">（2）基于一个镜像完成某些操作。比如基于 nginx 镜像，安装 ping ifconfig 等网络工具。首先运行&nbsp;docker run -it nginx /bin/bash&nbsp;基于 nginx:latest 创建一个容器，然后在容器中执行 apt-get 命令安装软件，然后运行 exit 退出容器。</p> 
     <p style="font-size:15px;line-height:1.5;">（3）将容器中的内容保存为一个镜像</p> 
     <div class="cnblogs_code" style="font-size:12px;border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';">
      <pre>docker commit -m=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">install net tools</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> -a=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">sammyliu8</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> 3f8a4339aadd sammyliu8/nginx:v1</pre>
     </div> 
     <p style="font-size:15px;line-height:1.5;">这里的&nbsp;3f8a4339aadd 为刚才容器的ID。此时，能在本地看到该镜像：</p> 
     <p style="font-size:15px;line-height:1.5;"><img src="https://images2017.cnblogs.com/blog/697113/201801/697113-20180107235209331-78522280.png" alt="" style="border:0px;"></p> 
     <p style="font-size:15px;line-height:1.5;">（4）运行 docker login 登录 docker hub</p> 
     <p style="font-size:15px;line-height:1.5;">（5）运行&nbsp;docker push sammyliu8/nginx 将镜像上传到 docker hub。此时在 Docker hub 界面上能看到该镜像了。</p> 
     <p style="font-size:15px;line-height:1.5;"><img src="https://images2017.cnblogs.com/blog/697113/201801/697113-20180107234853221-1628694632.png" alt="" style="border:0px;"></p> 
     <p style="font-size:15px;line-height:1.5;">&nbsp;</p> 
     <p style="font-size:15px;line-height:1.5;">（6）在其他节点上，可以运行 docker pull sammyliu8/nginx 拉该镜像了。</p> 
     <p style="font-size:15px;line-height:1.5;">（7）不过，这样做出来的新nginx有个问题，那就是nginx 服务不会自动起来。这是因为，官方的 nginx 的CMD 为 nginx -g&nbsp;"daemon off;"，但是新的镜像的CMD 为 /bin/bash。但是，运行前面命令启动的容器又无法安装软件。因此，只能先按照上面的步骤启动一个容器，制作镜像，然后基于该镜像再不带命令地再启一个容器，在另一个窗口中，使用docker commit 将其保存为新的镜像，并上传到docker hub中。问题解决。</p> 
     <p style="font-size:15px;line-height:1.5;">&nbsp;</p> 
     <p style="font-size:15px;line-height:1.5;">&nbsp;</p> 
     <p style="font-size:15px;line-height:1.5;">参考链接</p> 
     <ul style="font-size:12px;list-style:none;">
      <li style="list-style-type:disc;"> <a href="http://developers.redhat.com/blog/2016/03/09/more-about-docker-images-size/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://developers.redhat.com/blog/2016/03/09/more-about-docker-images-size/</a>&nbsp;</li> 
      <li style="list-style-type:disc;"><a href="http://developers.redhat.com/blog/2016/02/24/10-things-to-avoid-in-docker-containers/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://developers.redhat.com/blog/2016/02/24/10-things-to-avoid-in-docker-containers/</a></li> 
     </ul>
     <div>
      <span style="font-size:12px;"><br></span>
     </div> 
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
     <span style="font-size:12px;"><br></span>
    </div> 
    <div> 
     <font color="#4b4b4b"><span style="font-size:12px;">&nbsp; &nbsp; 本文转自SammyLiu博客园博客，原文链接：http://www.cnblogs.com/sammyliu/p/5877964.html</span></font>
     <span style="font-size:12px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">，如需转载请自行联系原作者</span> 
    </div> 
    <div style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
     <span style="font-size:12px;"><br></span>
    </div> 
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
