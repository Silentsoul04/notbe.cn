<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>理解 Linux 网络栈（3）：QEMU/KVM + VxLAN 环境下的 Segmentation Offloading 技术（发送端）... « NotBeCN</title>
  <meta name="description" content="             本系列文章总结 Linux 网络栈，包括：    （1）Linux 网络协议栈总结    （2）非虚拟化Linux环境中的网络分段卸载技术 GSO/TSO/UFO/LRO/GRO    （3）QEMU/KVM + VxLAN 环境下的 Segmentation Offloading 技术...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/10/weixin_34220834_90126498.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">理解 Linux 网络栈（3）：QEMU/KVM + VxLAN 环境下的 Segmentation Offloading 技术（发送端）...</h1>
    <p class="post-meta">Nov 10, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">本系列文章总结 Linux 网络栈，包括：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）<a href="http://www.cnblogs.com/sammyliu/p/5225623.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">Linux 网络协议栈总结</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）<a href="http://www.cnblogs.com/sammyliu/p/5227121.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">非虚拟化Linux环境中的网络分段卸载技术 GSO/TSO/UFO/LRO/GRO</a></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（3）<a href="http://www.cnblogs.com/sammyliu/p/5228581.html%20" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">QEMU/KVM + VxLAN 环境下的 Segmentation Offloading 技术（发送端）</a>&nbsp;</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（4）QEMU/KVM + VxLAN 环境下的 Segmentation Offloading 技术（接收端）</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;"><strong>1. 测试环境</strong></h2> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;"><strong>1.1 总体环境</strong></h3> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">宿主机：Ubuntu Linux/KVM + VxLAN + Linux bridge，网卡 MTU 9000</li> 
    <li style="list-style-type:disc;">客户机：Ubuntu Linux + Virtio-net NIC，网卡 MTU 1500，使用 OpenStack Kilo 管理虚机</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/697113/201603/697113-20160302092334705-1160635341.jpg" alt="" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;（这是发送端宿主机和客户机示意图）</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">在发送端，虚机要把一个数据包发出去，需要首先把 packet 经过 virtio 设备发到宿主机的某个 linux bridge，网桥再转发到 xvlan 的虚拟网卡，虚拟网卡把它变成 VxLAN UDP frame，然后发往UDP 层，再通过TCP/IP层再次进行路由，数据包这次会被发往物理网络，并最终抵达接收端端。</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.2 客户机中使用的 virtio-net 虚拟网卡</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;font-size:14px;">客户机的 virtio-net 超虚拟化网卡其实是一个使用中断和 DMA 技术实现的 PCI 设备，因此可以使用 lspci 命令查看它的信息：</span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre><span style="color:rgb(128,0,128);line-height:1.5;">00</span>:<span style="color:rgb(128,0,128);line-height:1.5;">03.0</span> Ethernet controller [<span style="color:rgb(128,0,128);line-height:1.5;">0200</span>]: Red Hat, Inc Virtio network device [1af4:<span style="color:rgb(128,0,128);line-height:1.5;">1000</span>]</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">默认情况下，该网卡的 Segmentation Offloading 全部是打开的：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>root@sammyubuntu1:~# ethtool -<span style="line-height:1.5;">k eth0
Features </span><span style="color:rgb(0,0,255);line-height:1.5;">for</span><span style="line-height:1.5;"> eth0:
rx</span>-checksumming: on [<span style="color:rgb(0,0,255);line-height:1.5;">fixed</span><span style="line-height:1.5;">]
tx</span>-<span style="line-height:1.5;">checksumming: on</span><span style="line-height:1.5;">
scatter</span>-<span style="line-height:1.5;">gather: on</span><span style="color:rgb(0,0,255);line-height:1.5;">
tcp-segmentation-offload: on
</span><span style="line-height:1.5;">udp</span>-fragmentation-<span style="line-height:1.5;">offload: on
<span style="color:rgb(0,0,255);line-height:1.5;">generic</span></span><span style="color:rgb(0,0,255);line-height:1.5;">-segmentation-</span><span style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;">offload: on</span>
generic</span>-receive-<span style="line-height:1.5;">offload: on
large</span>-receive-offload: off [<span style="color:rgb(0,0,255);line-height:1.5;">fixed</span>]</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">2. 发送端的实验和实现</h2> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.1 实验</h3> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">2.1.1 在客户机和宿主机网卡的 GSO/TSO/UFO 全部打开情况下的实验</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;">（1）iperf 的 MSS 是 1448 bytes</span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>root@sammyubuntu1:~# iperf -c <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.103</span> -l <span style="color:rgb(128,0,128);line-height:1.5;">65550</span> -m -M <span style="color:rgb(128,0,128);line-height:1.5;">400000</span><span style="line-height:1.5;">
WARNING: attempt to </span><span style="color:rgb(0,0,255);line-height:1.5;">set</span> TCP maxmimum segment size to <span style="color:rgb(128,0,128);line-height:1.5;">400000</span><span style="line-height:1.5;"> failed.
Setting the MSS may not be implemented on </span><span style="color:rgb(0,0,255);line-height:1.5;">this</span><span style="line-height:1.5;"> OS.
</span>------------------------------------------------------------<span style="line-height:1.5;">
Client connecting to </span><span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.103</span>, TCP port <span style="color:rgb(128,0,128);line-height:1.5;">5001</span><span style="line-height:1.5;">
TCP window size: </span><span style="color:rgb(128,0,128);line-height:1.5;">85.0</span> KByte (<span style="color:rgb(0,0,255);line-height:1.5;">default</span><span style="line-height:1.5;">)
</span>------------------------------------------------------------<span style="line-height:1.5;">
[  </span><span style="color:rgb(128,0,128);line-height:1.5;">3</span>] local <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.150</span> port <span style="color:rgb(128,0,128);line-height:1.5;">56228</span> connected with <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.103</span> port <span style="color:rgb(128,0,128);line-height:1.5;">5001</span><span style="line-height:1.5;">
[ ID] Interval       Transfer     Bandwidth
[  </span><span style="color:rgb(128,0,128);line-height:1.5;">3</span>]  <span style="color:rgb(128,0,128);line-height:1.5;">0.0</span>-<span style="color:rgb(128,0,128);line-height:1.5;">10.0</span> sec  <span style="color:rgb(128,0,128);line-height:1.5;">1.06</span> GBytes   <span style="color:rgb(128,0,128);line-height:1.5;">908</span> Mbits/<span style="line-height:1.5;">sec
[  </span><span style="color:rgb(128,0,128);line-height:1.5;">3</span>] MSS size <span style="color:rgb(128,0,128);line-height:1.5;">1448</span> bytes (MTU <span style="color:rgb(128,0,128);line-height:1.5;">1500</span> bytes, ethernet)</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;">实验表明，客户机中的TCP MSS 只和客户机网卡的 MTU 有关，和其它因素比如宿主机网卡 MTU 没有关系。而且，一个 TCP 连接的两个方向上的 MSS 是可以不同的。正是因为 MSS 的独立性，它可能会产生不同的后果，下文会有阐述。</span></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;">另外一个有趣的结果是，客户机网卡的 MTU 的大小对网络性能的影响不大。在下面的测试中，客户机网卡 MTU 由 1500 提高到 8000，性能只提高了 6.8%。</span>&nbsp;</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">&lt;客户机网卡 MTU 1500，宿主机网卡 MTU 9000&gt;</span><span style="line-height:1.5;">
root@sammyubuntu1:</span>~# iperf -c <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.103</span>   -<span style="line-height:1.5;">m
</span>------------------------------------------------------------<span style="line-height:1.5;">
Client connecting to </span><span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.103</span>, TCP port <span style="color:rgb(128,0,128);line-height:1.5;">5001</span><span style="line-height:1.5;">
TCP window size: </span><span style="color:rgb(128,0,128);line-height:1.5;">85.0</span> KByte (<span style="color:rgb(0,0,255);line-height:1.5;">default</span><span style="line-height:1.5;">)
</span>------------------------------------------------------------<span style="line-height:1.5;">
[  </span><span style="color:rgb(128,0,128);line-height:1.5;">3</span>] local <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.150</span> port <span style="color:rgb(128,0,128);line-height:1.5;">56275</span> connected with <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.103</span> port <span style="color:rgb(128,0,128);line-height:1.5;">5001</span><span style="line-height:1.5;">
[ ID] Interval       Transfer     Bandwidth
[  </span><span style="color:rgb(128,0,128);line-height:1.5;">3</span>]  <span style="color:rgb(128,0,128);line-height:1.5;">0.0</span>-<span style="color:rgb(128,0,128);line-height:1.5;">10.0</span> sec  <span style="color:rgb(128,0,128);line-height:1.5;">1.06</span> GBytes   <span style="color:rgb(0,0,255);line-height:1.5;">909</span> Mbits/<span style="line-height:1.5;">sec
[  </span><span style="color:rgb(128,0,128);line-height:1.5;">3</span>] MSS size <span style="color:rgb(128,0,128);line-height:1.5;">1448</span> bytes (MTU <span style="color:rgb(128,0,128);line-height:1.5;">1500</span><span style="line-height:1.5;"> bytes, ethernet)

</span><span style="color:rgb(0,0,255);line-height:1.5;">&lt;客户机网卡 MTU 8000，宿主机网卡 MTU 9000&gt;</span><span style="line-height:1.5;">
root@sammyubuntu1:</span>~# iperf -c <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.103</span>   -<span style="line-height:1.5;">m
</span>------------------------------------------------------------<span style="line-height:1.5;">
Client connecting to </span><span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.103</span>, TCP port <span style="color:rgb(128,0,128);line-height:1.5;">5001</span><span style="line-height:1.5;">
TCP window size:  </span><span style="color:rgb(128,0,128);line-height:1.5;">325</span> KByte (<span style="color:rgb(0,0,255);line-height:1.5;">default</span><span style="line-height:1.5;">)
</span>------------------------------------------------------------<span style="line-height:1.5;">
[  </span><span style="color:rgb(128,0,128);line-height:1.5;">3</span>] local <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.150</span> port <span style="color:rgb(128,0,128);line-height:1.5;">56274</span> connected with <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.103</span> port <span style="color:rgb(128,0,128);line-height:1.5;">5001</span><span style="line-height:1.5;">
[ ID] Interval       Transfer     Bandwidth
[  </span><span style="color:rgb(128,0,128);line-height:1.5;">3</span>]  <span style="color:rgb(128,0,128);line-height:1.5;">0.0</span>-<span style="color:rgb(128,0,128);line-height:1.5;">10.0</span> sec  <span style="color:rgb(128,0,128);line-height:1.5;">1.14</span> GBytes   <span style="color:rgb(0,0,255);line-height:1.5;">977</span> Mbits/<span style="line-height:1.5;">sec
[  </span><span style="color:rgb(128,0,128);line-height:1.5;">3</span>] MSS size <span style="color:rgb(128,0,128);line-height:1.5;">7948</span> bytes (MTU <span style="color:rgb(128,0,128);line-height:1.5;">7988</span> bytes, unknown <span style="color:rgb(0,0,255);line-height:1.5;">interface</span>)</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;">（2）客户机网卡：Frame 的 size 明显超过了 MSS，说明在启用了 GSO/TSO 的情况下，只要每个数据包不超过 IP 包的最大大小 64k，virtio-net 网卡就可以直接经过 virtqueue 发给 QEMU 中的backend。检验码报错，说明校验和计算被卸载到了网卡上，但是可能网卡计算错误。</span><span style="line-height:1.5;"><br></span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div>
     07:56:04.857427 IP (tos 0x0, ttl 64, id 43384, offset 0, flags [DF], proto TCP (6),&nbsp;
     <span style="color:rgb(255,0,0);line-height:1.5;font-size:12px;">length 1500</span>)
     <br> &nbsp;&nbsp;&nbsp; 20.0.0.150.56230 &gt; 20.0.0.103.5001: Flags [.], cksum 0x2ecb (incorrect -&gt; 0xc064), seq 438742392:438743840, ack 1, win 229, options [nop,nop,TS val 7353870 ecr 564507], length&nbsp;
     <span style="color:rgb(255,0,0);line-height:1.5;font-size:12px;">1448</span>
     <span style="color:rgb(255,0,0);line-height:1.5;font-size:12px;">&nbsp;</span> 
    </div> 
    <div>
     07:56:10.861709 IP (tos 0x0, ttl 64, id 56589, offset 0, flags [DF], proto TCP (6),&nbsp;
     <span style="color:rgb(255,0,0);line-height:1.5;font-size:12px;">length 65212</span>)
     <br> &nbsp;&nbsp;&nbsp; 20.0.0.150.56230 &gt; 20.0.0.103.5001: Flags [.], cksum 0x27ac (incorrect -&gt; 0x74c2), seq 1119980056:1120045216, ack 1, win 229, options [nop,nop,TS val 7355371 ecr 566008], length&nbsp;
     <span style="color:rgb(255,0,0);line-height:1.5;font-size:12px;">65160</span> 
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（3）宿主机上客户机网卡对应的 tap 设备：跟客户机网卡中看到的一样，说明 QEMU 中的 virtio-queue（backend）和 宿主机中的 tap 网络设备都是对这些 packets 直接发送的，没有做任何分包等操作。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre><span style="color:rgb(128,0,128);line-height:1.5;">08</span>:<span style="color:rgb(128,0,128);line-height:1.5;">12</span>:<span style="color:rgb(128,0,128);line-height:1.5;">23.443278</span> fa:<span style="color:rgb(128,0,128);line-height:1.5;">16</span>:3e:a3:a0:<span style="color:rgb(128,0,128);line-height:1.5;">55</span> &gt; fa:<span style="color:rgb(128,0,128);line-height:1.5;">16</span>:3e:1e:d9:f4, ethertype IPv4 (<span style="color:rgb(128,0,128);line-height:1.5;">0x0800</span>), length <span style="color:rgb(128,0,128);line-height:1.5;">61322</span>: (tos <span style="color:rgb(128,0,128);line-height:1.5;">0x0</span>, ttl <span style="color:rgb(128,0,128);line-height:1.5;">64</span>, id <span style="color:rgb(128,0,128);line-height:1.5;">52865</span>, offset <span style="color:rgb(128,0,128);line-height:1.5;">0</span>, flags [DF], proto TCP (<span style="color:rgb(128,0,128);line-height:1.5;">6</span>), length <span style="color:rgb(128,0,128);line-height:1.5;">61308</span><span style="line-height:1.5;">)
    </span><span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.150</span>.<span style="color:rgb(128,0,128);line-height:1.5;">56238</span> &gt; <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.103</span>.<span style="color:rgb(128,0,128);line-height:1.5;">5001</span>: Flags [.], cksum <span style="color:rgb(128,0,128);line-height:1.5;">0x186c</span> (incorrect -&gt; <span style="color:rgb(128,0,128);line-height:1.5;">0xad42</span>), seq <span style="color:rgb(128,0,128);line-height:1.5;">896238816</span>:<span style="color:rgb(128,0,128);line-height:1.5;">896300072</span>, ack <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, win <span style="color:rgb(128,0,128);line-height:1.5;">157</span>, options [nop,nop,TS val <span style="color:rgb(128,0,128);line-height:1.5;">7598521</span> ecr <span style="color:rgb(128,0,128);line-height:1.5;">809156</span>], length <span style="color:rgb(51,102,255);line-height:1.5;">61256</span>
<span style="color:rgb(128,0,128);line-height:1.5;">08</span>:<span style="color:rgb(128,0,128);line-height:1.5;">12</span>:<span style="color:rgb(128,0,128);line-height:1.5;">23.443355</span> fa:<span style="color:rgb(128,0,128);line-height:1.5;">16</span>:3e:a3:a0:<span style="color:rgb(128,0,128);line-height:1.5;">55</span> &gt; fa:<span style="color:rgb(128,0,128);line-height:1.5;">16</span>:3e:1e:d9:f4, ethertype IPv4 (<span style="color:rgb(128,0,128);line-height:1.5;">0x0800</span>), length <span style="color:rgb(128,0,128);line-height:1.5;">3030</span>: (tos <span style="color:rgb(128,0,128);line-height:1.5;">0x0</span>, ttl <span style="color:rgb(128,0,128);line-height:1.5;">64</span>, id <span style="color:rgb(128,0,128);line-height:1.5;">52927</span>, offset <span style="color:rgb(128,0,128);line-height:1.5;">0</span>, flags [DF], proto TCP (<span style="color:rgb(128,0,128);line-height:1.5;">6</span>), length <span style="color:rgb(128,0,128);line-height:1.5;">3016</span><span style="line-height:1.5;">)
    </span><span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.150</span>.<span style="color:rgb(128,0,128);line-height:1.5;">56238</span> &gt; <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.103</span>.<span style="color:rgb(128,0,128);line-height:1.5;">5001</span>: Flags [.], cksum <span style="color:rgb(128,0,128);line-height:1.5;">0x34b7</span> (incorrect -&gt; <span style="color:rgb(128,0,128);line-height:1.5;">0x97b3</span>), seq <span style="color:rgb(128,0,128);line-height:1.5;">896300072</span>:<span style="color:rgb(128,0,128);line-height:1.5;">896303036</span>, ack <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, win <span style="color:rgb(128,0,128);line-height:1.5;">157</span>, options [nop,nop,TS val <span style="color:rgb(128,0,128);line-height:1.5;">7598521</span> ecr <span style="color:rgb(128,0,128);line-height:1.5;">809156</span>], length <span style="color:rgb(51,102,255);line-height:1.5;">2964</span></pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（4）宿主机内的连接 tap 设备和vxlan interface 的 linux bridge：帧的大小超过其 MTU，说明它直接转发经过 GSO/TSO 合并后的帧。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>oot@hkg02kvm004ccz023:~# ifconfig brq137db7ce-<span style="line-height:1.5;">a4
brq137db7ce</span>-a4 Link encap:Ethernet  HWaddr <span style="color:rgb(128,0,128);line-height:1.5;">36</span>:7e:1f:8e:<span style="color:rgb(128,0,128);line-height:1.5;">65</span><span style="line-height:1.5;">:a0
          UP BROADCAST RUNNING MULTICAST  <span style="color:rgb(51,102,255);line-height:1.5;">MTU:</span></span><span style="color:rgb(51,102,255);line-height:1.5;">8950</span>  Metric:<span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">
          RX packets:</span><span style="color:rgb(128,0,128);line-height:1.5;">594948</span> errors:<span style="color:rgb(128,0,128);line-height:1.5;">0</span> dropped:<span style="color:rgb(128,0,128);line-height:1.5;">0</span> overruns:<span style="color:rgb(128,0,128);line-height:1.5;">0</span> frame:<span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">
          TX packets:</span><span style="color:rgb(128,0,128);line-height:1.5;">0</span> errors:<span style="color:rgb(128,0,128);line-height:1.5;">0</span> dropped:<span style="color:rgb(128,0,128);line-height:1.5;">0</span> overruns:<span style="color:rgb(128,0,128);line-height:1.5;">0</span> carrier:<span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">
          collisions:</span><span style="color:rgb(128,0,128);line-height:1.5;">0</span> txqueuelen:<span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">
          RX bytes:</span><span style="color:rgb(128,0,128);line-height:1.5;">1058392082</span> (<span style="color:rgb(128,0,128);line-height:1.5;">1.0</span> GB)  TX bytes:<span style="color:rgb(128,0,128);line-height:1.5;">0</span> (<span style="color:rgb(128,0,128);line-height:1.5;">0.0</span><span style="line-height:1.5;"> B)

</span><span style="color:rgb(128,0,128);line-height:1.5;">08</span>:<span style="color:rgb(128,0,128);line-height:1.5;">18</span>:<span style="color:rgb(128,0,128);line-height:1.5;">39.574679</span> fa:<span style="color:rgb(128,0,128);line-height:1.5;">16</span>:3e:a3:a0:<span style="color:rgb(128,0,128);line-height:1.5;">55</span> &gt; fa:<span style="color:rgb(128,0,128);line-height:1.5;">16</span>:3e:1e:d9:f4, ethertype IPv4 (<span style="color:rgb(128,0,128);line-height:1.5;">0x0800</span>), length <span style="color:rgb(128,0,128);line-height:1.5;">52430</span>: (tos <span style="color:rgb(128,0,128);line-height:1.5;">0x0</span>, ttl <span style="color:rgb(128,0,128);line-height:1.5;">64</span>, id <span style="color:rgb(128,0,128);line-height:1.5;">1585</span>, offset <span style="color:rgb(128,0,128);line-height:1.5;">0</span>, flags [DF], proto TCP (<span style="color:rgb(128,0,128);line-height:1.5;">6</span>), length <span style="color:rgb(128,0,128);line-height:1.5;">52416</span><span style="line-height:1.5;">)
    </span><span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.150</span>.<span style="color:rgb(128,0,128);line-height:1.5;">56238</span> &gt; <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.103</span>.<span style="color:rgb(128,0,128);line-height:1.5;">5001</span>: Flags [.], cksum <span style="color:rgb(128,0,128);line-height:1.5;">0xf5af</span> (incorrect -&gt; <span style="color:rgb(128,0,128);line-height:1.5;">0x47b1</span>), seq <span style="color:rgb(128,0,128);line-height:1.5;">7027645</span>:<span style="color:rgb(128,0,128);line-height:1.5;">7080009</span>, ack <span style="color:rgb(128,0,128);line-height:1.5;">0</span>, win <span style="color:rgb(128,0,128);line-height:1.5;">157</span>, options [nop,nop,TS val <span style="color:rgb(128,0,128);line-height:1.5;">7692554</span> ecr <span style="color:rgb(128,0,128);line-height:1.5;">903188</span>], <span style="color:rgb(51,102,255);line-height:1.5;">length 52364</span>
<span style="color:rgb(128,0,128);line-height:1.5;">08</span>:<span style="color:rgb(128,0,128);line-height:1.5;">18</span>:<span style="color:rgb(128,0,128);line-height:1.5;">39.574784</span> fa:<span style="color:rgb(128,0,128);line-height:1.5;">16</span>:3e:a3:a0:<span style="color:rgb(128,0,128);line-height:1.5;">55</span> &gt; fa:<span style="color:rgb(128,0,128);line-height:1.5;">16</span>:3e:1e:d9:f4, ethertype IPv4 (<span style="color:rgb(128,0,128);line-height:1.5;">0x0800</span>), length <span style="color:rgb(128,0,128);line-height:1.5;">52430</span>: (tos <span style="color:rgb(128,0,128);line-height:1.5;">0x0</span>, ttl <span style="color:rgb(128,0,128);line-height:1.5;">64</span>, id <span style="color:rgb(128,0,128);line-height:1.5;">1638</span>, offset <span style="color:rgb(128,0,128);line-height:1.5;">0</span>, flags [DF], proto TCP (<span style="color:rgb(128,0,128);line-height:1.5;">6</span>), length <span style="color:rgb(128,0,128);line-height:1.5;">52416</span><span style="line-height:1.5;">)</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（5）宿主机内的 vxlan-interface：帧的大小超过其 MTU，说明它直接转发经过 GSO/TSO 合并后的帧</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="line-height:1.5;">root@hkg02kvm004ccz023:</span>~# ifconfig vxlan-<span style="color:rgb(128,0,128);line-height:1.5;">97</span><span style="line-height:1.5;">
vxlan</span>-<span style="color:rgb(128,0,128);line-height:1.5;">97</span>  Link encap:Ethernet  HWaddr d6:7e:<span style="color:rgb(128,0,128);line-height:1.5;">83</span>:<span style="color:rgb(128,0,128);line-height:1.5;">70</span>:<span style="color:rgb(128,0,128);line-height:1.5;">40</span><span style="line-height:1.5;">:b2
          UP BROADCAST RUNNING MULTICAST  <span style="color:rgb(51,102,255);line-height:1.5;">MTU:</span></span><span style="color:rgb(51,102,255);line-height:1.5;">8950</span>  Metric:<span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">
          RX packets:</span><span style="color:rgb(128,0,128);line-height:1.5;">44754025</span> errors:<span style="color:rgb(128,0,128);line-height:1.5;">0</span> dropped:<span style="color:rgb(128,0,128);line-height:1.5;">0</span> overruns:<span style="color:rgb(128,0,128);line-height:1.5;">0</span> frame:<span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">
          TX packets:</span><span style="color:rgb(128,0,128);line-height:1.5;">5179964</span> errors:<span style="color:rgb(128,0,128);line-height:1.5;">0</span> dropped:<span style="color:rgb(128,0,128);line-height:1.5;">2</span> overruns:<span style="color:rgb(128,0,128);line-height:1.5;">0</span> carrier:<span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">
          collisions:</span><span style="color:rgb(128,0,128);line-height:1.5;">0</span> txqueuelen:<span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">
          RX bytes:</span><span style="color:rgb(128,0,128);line-height:1.5;">2381558146</span> (<span style="color:rgb(128,0,128);line-height:1.5;">2.3</span> GB)  TX bytes:<span style="color:rgb(128,0,128);line-height:1.5;">89661075401</span> (<span style="color:rgb(128,0,128);line-height:1.5;">89.6</span><span style="line-height:1.5;"> GB)

</span><span style="color:rgb(128,0,128);line-height:1.5;">08</span>:<span style="color:rgb(128,0,128);line-height:1.5;">16</span>:<span style="color:rgb(128,0,128);line-height:1.5;">54.685914</span> fa:<span style="color:rgb(128,0,128);line-height:1.5;">16</span>:3e:a3:a0:<span style="color:rgb(128,0,128);line-height:1.5;">55</span> &gt; fa:<span style="color:rgb(128,0,128);line-height:1.5;">16</span>:3e:1e:d9:f4, ethertype IPv4 (<span style="color:rgb(128,0,128);line-height:1.5;">0x0800</span>), length <span style="color:rgb(128,0,128);line-height:1.5;">1054</span>: (tos <span style="color:rgb(128,0,128);line-height:1.5;">0x0</span>, ttl <span style="color:rgb(128,0,128);line-height:1.5;">64</span>, id <span style="color:rgb(128,0,128);line-height:1.5;">14493</span>, offset <span style="color:rgb(128,0,128);line-height:1.5;">0</span>, flags [DF], proto TCP (<span style="color:rgb(128,0,128);line-height:1.5;">6</span>), length <span style="color:rgb(128,0,128);line-height:1.5;">1040</span><span style="line-height:1.5;">)
    </span><span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.150</span>.<span style="color:rgb(128,0,128);line-height:1.5;">56238</span> &gt; <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.103</span>.<span style="color:rgb(128,0,128);line-height:1.5;">5001</span>: Flags [.], cksum <span style="color:rgb(128,0,128);line-height:1.5;">0x2cff</span> (incorrect -&gt; <span style="color:rgb(128,0,128);line-height:1.5;">0x3143</span>), seq <span style="color:rgb(128,0,128);line-height:1.5;">60291712</span>:<span style="color:rgb(128,0,128);line-height:1.5;">60292700</span>, ack <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, win <span style="color:rgb(128,0,128);line-height:1.5;">157</span>, options [nop,nop,TS val <span style="color:rgb(128,0,128);line-height:1.5;">7666332</span> ecr <span style="color:rgb(128,0,128);line-height:1.5;">876964</span>], length <span style="color:rgb(128,0,128);line-height:1.5;">988</span>
<span style="color:rgb(128,0,128);line-height:1.5;">08</span>:<span style="color:rgb(128,0,128);line-height:1.5;">16</span>:<span style="color:rgb(128,0,128);line-height:1.5;">54.685936</span> fa:<span style="color:rgb(128,0,128);line-height:1.5;">16</span>:3e:a3:a0:<span style="color:rgb(128,0,128);line-height:1.5;">55</span> &gt; fa:<span style="color:rgb(128,0,128);line-height:1.5;">16</span>:3e:1e:d9:f4, ethertype IPv4 (<span style="color:rgb(128,0,128);line-height:1.5;">0x0800</span>), length <span style="color:rgb(128,0,128);line-height:1.5;">24766</span>: (tos <span style="color:rgb(128,0,128);line-height:1.5;">0x0</span>, ttl <span style="color:rgb(128,0,128);line-height:1.5;">64</span>, id <span style="color:rgb(128,0,128);line-height:1.5;">14494</span>, offset <span style="color:rgb(128,0,128);line-height:1.5;">0</span>, flags [DF], proto TCP (<span style="color:rgb(128,0,128);line-height:1.5;">6</span>), <span style="color:rgb(51,102,255);line-height:1.5;">length 24752</span><span style="line-height:1.5;">)
    </span><span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.150</span>.<span style="color:rgb(128,0,128);line-height:1.5;">56238</span> &gt; <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.103</span>.<span style="color:rgb(128,0,128);line-height:1.5;">5001</span>: Flags [.], cksum <span style="color:rgb(128,0,128);line-height:1.5;">0x899f</span> (incorrect -&gt; <span style="color:rgb(128,0,128);line-height:1.5;">0xf01d</span>), seq <span style="color:rgb(128,0,128);line-height:1.5;">60292700</span>:<span style="color:rgb(128,0,128);line-height:1.5;">60317400</span>, ack <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, win <span style="color:rgb(128,0,128);line-height:1.5;">157</span>, options [nop,nop,TS val <span style="color:rgb(128,0,128);line-height:1.5;">7666332</span> ecr <span style="color:rgb(128,0,128);line-height:1.5;">876964</span>], length <span style="color:rgb(128,0,128);line-height:1.5;">24700</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（6）宿主机 VxLAN UDP socket 所绑定的物理网卡：测试了三种情况，证明了网卡是按照 MSS 进行 IP 分片的。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(51,102,255);line-height:1.5;">当 TCP 连接的 MSS 是 988 时：
</span><span style="color:rgb(128,0,128);line-height:1.5;">08</span>:<span style="color:rgb(128,0,128);line-height:1.5;">19</span>:<span style="color:rgb(128,0,128);line-height:1.5;">34.286094</span> IP <span style="color:rgb(128,0,128);line-height:1.5;">10.110</span>.<span style="color:rgb(128,0,128);line-height:1.5;">156.43</span>.<span style="color:rgb(128,0,128);line-height:1.5;">33980</span> &gt; <span style="color:rgb(128,0,128);line-height:1.5;">10.110</span>.<span style="color:rgb(128,0,128);line-height:1.5;">156.42</span>.<span style="color:rgb(128,0,128);line-height:1.5;">4789</span>: VXLAN, flags [I] (<span style="color:rgb(128,0,128);line-height:1.5;">0x08</span>), vni <span style="color:rgb(128,0,128);line-height:1.5;">97</span><span style="line-height:1.5;">
IP </span><span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.150</span>.<span style="color:rgb(128,0,128);line-height:1.5;">56238</span> &gt; <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.103</span>.<span style="color:rgb(128,0,128);line-height:1.5;">5001</span>: Flags [.], seq <span style="color:rgb(128,0,128);line-height:1.5;">96306288</span>:<span style="color:rgb(128,0,128);line-height:1.5;">96307276</span>, ack <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, win <span style="color:rgb(128,0,128);line-height:1.5;">157</span>, options [nop,nop,TS val <span style="color:rgb(128,0,128);line-height:1.5;">7706232</span> ecr <span style="color:rgb(128,0,128);line-height:1.5;">916866</span>], <span style="color:rgb(51,102,255);line-height:1.5;">length 988

当 TCP 连接的 MSS 是 1448 时：
</span><span style="color:rgb(128,0,128);line-height:1.5;">07</span>:<span style="color:rgb(128,0,128);line-height:1.5;">45</span>:<span style="color:rgb(128,0,128);line-height:1.5;">24.008510</span> IP <span style="color:rgb(128,0,128);line-height:1.5;">10.110</span>.<span style="color:rgb(128,0,128);line-height:1.5;">156.43</span>.<span style="color:rgb(128,0,128);line-height:1.5;">44429</span> &gt; <span style="color:rgb(128,0,128);line-height:1.5;">10.110</span>.<span style="color:rgb(128,0,128);line-height:1.5;">156.42</span>.<span style="color:rgb(128,0,128);line-height:1.5;">4789</span>: VXLAN, flags [I] (<span style="color:rgb(128,0,128);line-height:1.5;">0x08</span>), vni <span style="color:rgb(128,0,128);line-height:1.5;">97</span><span style="line-height:1.5;">
IP </span><span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.150</span>.<span style="color:rgb(128,0,128);line-height:1.5;">56228</span> &gt; <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.103</span>.<span style="color:rgb(128,0,128);line-height:1.5;">5001</span>: Flags [.], seq <span style="color:rgb(128,0,128);line-height:1.5;">126000</span>:<span style="color:rgb(128,0,128);line-height:1.5;">127448</span>, ack <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, win <span style="color:rgb(128,0,128);line-height:1.5;">229</span>, options [nop,nop,TS val <span style="color:rgb(128,0,128);line-height:1.5;">7193663</span> ecr <span style="color:rgb(128,0,128);line-height:1.5;">404323</span>], <span style="color:rgb(51,102,255);line-height:1.5;">length 1448

如果将网卡的 MTU 调到比 MSS （1448）还小，比如 1400，则会出现 IP 分片，说明 GSO 还是按照 MSS 分段，而不是按照 MTU 或者 [MTU, MSS] 中的较小值来分段：
</span><span style="color:rgb(128,0,128);line-height:1.5;">08</span>:<span style="color:rgb(128,0,128);line-height:1.5;">39</span>:<span style="color:rgb(128,0,128);line-height:1.5;">35.743048</span> IP <span style="color:rgb(128,0,128);line-height:1.5;">10.110</span>.<span style="color:rgb(128,0,128);line-height:1.5;">156.43</span>.<span style="color:rgb(128,0,128);line-height:1.5;">41903</span> &gt; <span style="color:rgb(128,0,128);line-height:1.5;">10.110</span>.<span style="color:rgb(128,0,128);line-height:1.5;">156.42</span>.<span style="color:rgb(128,0,128);line-height:1.5;">4789</span>: VXLAN, flags [I] (<span style="color:rgb(128,0,128);line-height:1.5;">0x08</span>), vni <span style="color:rgb(128,0,128);line-height:1.5;">97</span><span style="line-height:1.5;">
IP truncated</span>-ip - <span style="color:rgb(128,0,128);line-height:1.5;">154</span> bytes missing! <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.150</span>.<span style="color:rgb(128,0,128);line-height:1.5;">56246</span> &gt; <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.103</span>.<span style="color:rgb(128,0,128);line-height:1.5;">5001</span>: Flags [.], seq <span style="color:rgb(128,0,128);line-height:1.5;">12179152</span>:<span style="color:rgb(128,0,128);line-height:1.5;">12180600</span>, ack <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, win <span style="color:rgb(128,0,128);line-height:1.5;">188</span>, options [nop,nop,TS val <span style="color:rgb(128,0,128);line-height:1.5;">8006596</span> ecr <span style="color:rgb(128,0,128);line-height:1.5;">1217232</span>], length <span style="color:rgb(128,0,128);line-height:1.5;">1448</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">2.1.2 在客户机关闭 GSO/TSO/UFO&nbsp;</h4> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>root@sammyubuntu1:~# iperf -c <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.103</span> -l <span style="color:rgb(128,0,128);line-height:1.5;">65550</span>  -<span style="line-height:1.5;">m
</span>------------------------------------------------------------<span style="line-height:1.5;">
Client connecting to </span><span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.103</span>, TCP port <span style="color:rgb(128,0,128);line-height:1.5;">5001</span><span style="line-height:1.5;">
TCP window size:  </span><span style="color:rgb(128,0,128);line-height:1.5;">325</span> KByte (<span style="color:rgb(0,0,255);line-height:1.5;">default</span><span style="line-height:1.5;">)
</span>------------------------------------------------------------<span style="line-height:1.5;">
[  </span><span style="color:rgb(128,0,128);line-height:1.5;">3</span>] local <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.150</span> port <span style="color:rgb(128,0,128);line-height:1.5;">56269</span> connected with <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.103</span> port <span style="color:rgb(128,0,128);line-height:1.5;">5001</span><span style="line-height:1.5;">
[ ID] Interval       Transfer     Bandwidth
[  </span><span style="color:rgb(128,0,128);line-height:1.5;">3</span>]  <span style="color:rgb(128,0,128);line-height:1.5;">0.0</span>-<span style="color:rgb(128,0,128);line-height:1.5;">10.0</span> sec  <span style="color:rgb(128,0,128);line-height:1.5;">1.00</span> GBytes   <span style="color:rgb(128,0,128);line-height:1.5;">859</span> Mbits/<span style="line-height:1.5;">sec
[  </span><span style="color:rgb(128,0,128);line-height:1.5;">3</span>] MSS size <span style="color:rgb(128,0,128);line-height:1.5;">1448</span> bytes (MTU <span style="color:rgb(128,0,128);line-height:1.5;">1500</span><span style="line-height:1.5;"> bytes, ethernet)

<span style="color:rgb(0,0,255);line-height:1.5;">客户机网卡：在客户机 CPU 中进行了 TCP 分段 </span></span><span style="color:rgb(128,0,128);line-height:1.5;">10</span>:<span style="color:rgb(128,0,128);line-height:1.5;">02</span>:<span style="color:rgb(128,0,128);line-height:1.5;">41.474750</span> IP (tos <span style="color:rgb(128,0,128);line-height:1.5;">0x0</span>, ttl <span style="color:rgb(128,0,128);line-height:1.5;">64</span>, id <span style="color:rgb(128,0,128);line-height:1.5;">59282</span>, offset <span style="color:rgb(128,0,128);line-height:1.5;">0</span>, flags [DF], proto TCP (<span style="color:rgb(128,0,128);line-height:1.5;">6</span>), length <span style="color:rgb(128,0,128);line-height:1.5;">1500</span><span style="line-height:1.5;">)
    </span><span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.150</span>.<span style="color:rgb(128,0,128);line-height:1.5;">56269</span> &gt; <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.103</span>.<span style="color:rgb(128,0,128);line-height:1.5;">5001</span>: Flags [.], cksum <span style="color:rgb(128,0,128);line-height:1.5;">0x2ecb</span> (incorrect -&gt; <span style="color:rgb(128,0,128);line-height:1.5;">0x1924</span>), seq <span style="color:rgb(128,0,128);line-height:1.5;">1795544</span>:<span style="color:rgb(128,0,128);line-height:1.5;">1796992</span>, ack <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, win <span style="color:rgb(128,0,128);line-height:1.5;">229</span>, options [nop,nop,TS val <span style="color:rgb(128,0,128);line-height:1.5;">9253025</span> ecr <span style="color:rgb(128,0,128);line-height:1.5;">2463660</span>], length <span style="color:rgb(128,0,128);line-height:1.5;">1448</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">该过程说明客户机中产生了 TCP 分段；对网络性能有一定的下降。</p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">2.1.3&nbsp;虚机 TSO/GSO 打开 和宿主机的 GSO/TSO 关闭</h4> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">客户机网卡：传输 GSO 大帧
</span><span style="color:rgb(128,0,128);line-height:1.5;">09</span>:<span style="color:rgb(128,0,128);line-height:1.5;">47</span>:<span style="color:rgb(128,0,128);line-height:1.5;">35.894971</span> IP (tos <span style="color:rgb(128,0,128);line-height:1.5;">0x0</span>, ttl <span style="color:rgb(128,0,128);line-height:1.5;">64</span>, id <span style="color:rgb(128,0,128);line-height:1.5;">5902</span>, offset <span style="color:rgb(128,0,128);line-height:1.5;">0</span>, flags [DF], proto TCP (<span style="color:rgb(128,0,128);line-height:1.5;">6</span>), length <span style="color:rgb(128,0,128);line-height:1.5;">65212</span><span style="line-height:1.5;">)
    </span><span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.150</span>.<span style="color:rgb(128,0,128);line-height:1.5;">56263</span> &gt; <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.103</span>.<span style="color:rgb(128,0,128);line-height:1.5;">5001</span>: Flags [.], cksum <span style="color:rgb(128,0,128);line-height:1.5;">0x27ac</span> (incorrect -&gt; <span style="color:rgb(128,0,128);line-height:1.5;">0xdeb7</span>), seq <span style="color:rgb(128,0,128);line-height:1.5;">893020126</span>:<span style="color:rgb(128,0,128);line-height:1.5;">893085286</span>, ack <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, win <span style="color:rgb(128,0,128);line-height:1.5;">229</span>, options [nop,nop,TS val <span style="color:rgb(128,0,128);line-height:1.5;">9026630</span> ecr <span style="color:rgb(128,0,128);line-height:1.5;">2237265</span>], length <span style="color:rgb(128,0,128);line-height:1.5;">65160</span><span style="color:rgb(0,0,255);line-height:1.5;">vxlan-interface 设备：直接转发
</span><span style="color:rgb(128,0,128);line-height:1.5;">09</span>:<span style="color:rgb(128,0,128);line-height:1.5;">53</span>:<span style="color:rgb(128,0,128);line-height:1.5;">15.457088</span> fa:<span style="color:rgb(128,0,128);line-height:1.5;">16</span>:3e:a3:a0:<span style="color:rgb(128,0,128);line-height:1.5;">55</span> &gt; fa:<span style="color:rgb(128,0,128);line-height:1.5;">16</span>:3e:1e:d9:f4, ethertype IPv4 (<span style="color:rgb(128,0,128);line-height:1.5;">0x0800</span>), length <span style="color:rgb(128,0,128);line-height:1.5;">65226</span>: (tos <span style="color:rgb(128,0,128);line-height:1.5;">0x0</span>, ttl <span style="color:rgb(128,0,128);line-height:1.5;">64</span>, id <span style="color:rgb(128,0,128);line-height:1.5;">43361</span>, offset <span style="color:rgb(128,0,128);line-height:1.5;">0</span>, flags [DF], proto TCP (<span style="color:rgb(128,0,128);line-height:1.5;">6</span>), length <span style="color:rgb(128,0,128);line-height:1.5;">65212</span><span style="line-height:1.5;">)
    </span><span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.150</span>.<span style="color:rgb(128,0,128);line-height:1.5;">56267</span> &gt; <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.103</span>.<span style="color:rgb(128,0,128);line-height:1.5;">5001</span>: Flags [.], cksum <span style="color:rgb(128,0,128);line-height:1.5;">0x27ac</span> (incorrect -&gt; <span style="color:rgb(128,0,128);line-height:1.5;">0x2e18</span>), seq <span style="color:rgb(128,0,128);line-height:1.5;">1127931208</span>:<span style="color:rgb(128,0,128);line-height:1.5;">1127996368</span>, ack <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, win <span style="color:rgb(128,0,128);line-height:1.5;">229</span>, options [nop,nop,TS val <span style="color:rgb(128,0,128);line-height:1.5;">9111525</span> ecr <span style="color:rgb(128,0,128);line-height:1.5;">2322160</span>], length <span style="color:rgb(128,0,128);line-height:1.5;">65160</span><span style="line-height:1.5;">

<span style="color:rgb(0,0,255);line-height:1.5;">宿主机物理网卡：发送size 为 TCP MSS 的小帧 </span></span><span style="color:rgb(128,0,128);line-height:1.5;">09</span>:<span style="color:rgb(128,0,128);line-height:1.5;">50</span>:<span style="color:rgb(128,0,128);line-height:1.5;">41.251821</span> IP <span style="color:rgb(128,0,128);line-height:1.5;">10.110</span>.<span style="color:rgb(128,0,128);line-height:1.5;">156.43</span>.<span style="color:rgb(128,0,128);line-height:1.5;">12914</span> &gt; <span style="color:rgb(128,0,128);line-height:1.5;">10.110</span>.<span style="color:rgb(128,0,128);line-height:1.5;">156.42</span>.<span style="color:rgb(128,0,128);line-height:1.5;">4789</span>: VXLAN, flags [I] (<span style="color:rgb(128,0,128);line-height:1.5;">0x08</span>), vni <span style="color:rgb(128,0,128);line-height:1.5;">97</span><span style="line-height:1.5;">
IP </span><span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.150</span>.<span style="color:rgb(128,0,128);line-height:1.5;">56265</span> &gt; <span style="color:rgb(128,0,128);line-height:1.5;">20.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.103</span>.<span style="color:rgb(128,0,128);line-height:1.5;">5001</span>: Flags [.], seq <span style="color:rgb(128,0,128);line-height:1.5;">80044016</span>:<span style="color:rgb(128,0,128);line-height:1.5;">80045464</span>, ack <span style="color:rgb(128,0,128);line-height:1.5;">1</span>, win <span style="color:rgb(128,0,128);line-height:1.5;">229</span>, options [nop,nop,TS val <span style="color:rgb(128,0,128);line-height:1.5;">9072973</span> ecr <span style="color:rgb(128,0,128);line-height:1.5;">2283609</span>], length <span style="color:rgb(128,0,128);line-height:1.5;">1448</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">该过程说明这里产生了 UDP/IP 分片。</p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">2.1.4&nbsp;TCP 传输性能比较</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; 客户机和宿主机GSO/TSO/UFO都打开 &gt; 客户机打开宿主机关闭 &gt; 客户机关闭。</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.2 Linux 内核支持 GSO for UDP tunnels：“udp: Generalize GSO for UDP tunnels”</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">这个支持是在 2014 年才加入 Linux 内核的，更多信息请参考原文&nbsp;<a href="https://lwn.net/Articles/613999/" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">https://lwn.net/Articles/613999/</a>。这个 patch 在 GSO 中添加了对 UDP 隧道技术的支持。</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">需要在 skb 发到 UDP 协议栈之前，添加一个新的 option：inner_protocol，可以使用方法&nbsp;skb_set_inner_ipproto 或者&nbsp;skb_set_inner_protocol 来设置。vxlan driver 中的相关代码为&nbsp;<span class="pl-c1" style="line-height:1.5;">skb_set_inner_protocol(skb,&nbsp;<span class="pl-c1" style="line-height:1.5;">htons(ETH_P_TEB));</span></span> </li> 
    <li style="list-style-type:disc;"> <span class="pl-c1" style="line-height:1.5;"><span class="pl-c1" style="line-height:1.5;"><span class="pl-c1" style="line-height:1.5;">函数</span></span></span><pre>skb_udp_tunnel_segment 会检查该 option 再处理分段。</pre> </li> 
    <li style="list-style-type:disc;">支持多种类型的封装，包括&nbsp;SKB_GSO_UDP_TUNNEL{_CSUM}</li> 
   </ul>
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">2.3 VxLAN 的实现</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">代码在这里：<a href="https://github.com/torvalds/linux/blob/master/drivers/net/vxlan.c" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">https://github.com/torvalds/linux/blob/master/drivers/net/vxlan.c</a></p> 
   <h4 style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">2.3.1 VxLAN interface</h4> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp; 跟名字一样，VxLAN interface 也是当做一个 network device interface 来使用的，vxlan.c 文件中实现了其驱动的逻辑。它处于数据链路层的 device driver 层，实现了 vxlan interface 的 device driver。vxlan interface 同样可以使用 ethtool 查看其 segmentation offloading 能力：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>root@hkg02kvm004ccz023:~# ethtool -k vxlan-<span style="color:rgb(128,0,128);line-height:1.5;">4</span> |<span style="line-height:1.5;"> grep offload
tcp</span>-segmentation-<span style="line-height:1.5;">offload: on
udp</span>-fragmentation-<span style="line-height:1.5;">offload: on
generic</span>-segmentation-<span style="line-height:1.5;">offload: on
generic</span>-receive-<span style="line-height:1.5;">offload: on
large</span>-receive-offload: off [<span style="color:rgb(0,0,255);line-height:1.5;">fixed</span><span style="line-height:1.5;">]
rx</span>-vlan-offload: off [<span style="color:rgb(0,0,255);line-height:1.5;">fixed</span><span style="line-height:1.5;">]
tx</span>-vlan-<span style="line-height:1.5;">offload: on
l2</span>-fwd-offload: off [<span style="color:rgb(0,0,255);line-height:1.5;">fixed</span>]</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;">&nbsp; 其驱动设置了&nbsp;</span><span style="line-height:1.5;">net_device_ops结构体变量，&nbsp;其中定义了操作 net_device 的重要函数，vxlan在驱动程序中根据需要的操作要填充这些函数，其中主要是 packets 的接收和发送处理函数。</span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">const</span> <span style="color:rgb(0,0,255);line-height:1.5;">struct</span> net_device_ops vxlan_netdev_ops =<span style="line-height:1.5;"> {
    .ndo_init        </span>=<span style="line-height:1.5;"> vxlan_init,      
    .ndo_uninit        </span>=<span style="line-height:1.5;"> vxlan_uninit,
    .ndo_open        </span>=<span style="line-height:1.5;"> vxlan_open,
    .ndo_stop        </span>=<span style="line-height:1.5;"> vxlan_stop,
    .ndo_start_xmit        </span>=<span style="line-height:1.5;"> vxlan_xmit,  <span style="color:rgb(0,0,255);line-height:1.5;">#向 vxlan interface 发送 packet</span>
    ...</span><span style="line-height:1.5;">
};</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;">来看看代码实现：</span></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）首先看&nbsp;<span class="pl-k" style="line-height:1.5;">static&nbsp;<span class="pl-c1" style="line-height:1.5;">netdev_tx_t&nbsp;<span class="pl-smi" style="line-height:1.5;">vxlan_xmit(<span class="pl-k" style="line-height:1.5;">struct sk_buff *skb,&nbsp;<span class="pl-k" style="line-height:1.5;">struct net_device *dev) 方法，它的输入就是要传输的 packets &nbsp;所对应的 sk_buff 以及要经过的 vxlan interface dev:</span></span></span></span></span></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span class="pl-k" style="line-height:1.5;"><img src="https://images2015.cnblogs.com/blog/697113/201603/697113-20160301084054314-1032897278.jpg" alt="" style="border:0px;"></span></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span class="pl-k" style="line-height:1.5;">它的主要逻辑是获取 vxlan dev，然后为 sk_buff 中的每一个 skb 调用&nbsp;</span>vxlan_xmit_skb 方法。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">#该方法主要逻辑是，计算 tos，ttl，df，src_port，dst_port，md 以及 flags等，然后调用 vxlan_xmit_skb 方法。</span><br>
err =<span style="line-height:1.5;"> vxlan_xmit_skb(rt, sk, skb, fl4.saddr,
                     dst</span>-&gt;<span style="line-height:1.5;">sin.sin_addr.s_addr, tos, ttl, df,
                     src_port, dst_port, htonl(vni </span>&lt;&lt; <span style="color:rgb(128,0,128);line-height:1.5;">8</span><span style="line-height:1.5;">), md,
                     </span>!net_eq(vxlan-&gt;net, dev_net(vxlan-&gt;<span style="line-height:1.5;">dev)),
                     flags);</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;">（2）vxlan_xmit_skb&nbsp;函数修改了 skb，添加了 VxLAN Header，以及设置 GSO 参数。</span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">int</span> vxlan_xmit_skb(<span style="color:rgb(0,0,255);line-height:1.5;">struct</span> rtable *rt, <span style="color:rgb(0,0,255);line-height:1.5;">struct</span> sock *sk, <span style="color:rgb(0,0,255);line-height:1.5;">struct</span> sk_buff *<span style="line-height:1.5;">skb,
              __be32 src, __be32 dst, __u8 tos, __u8 ttl, __be16 df,
              __be16 src_port, __be16 dst_port, __be32 vni,
              </span><span style="color:rgb(0,0,255);line-height:1.5;">struct</span> vxlan_metadata *md, <span style="color:rgb(0,0,255);line-height:1.5;">bool</span><span style="line-height:1.5;"> xnet, u32 vxflags)
{
    </span><span style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;">...</span></span><span style="color:rgb(0,0,255);line-height:1.5;">int</span> type = udp_sum ?<span style="line-height:1.5;"> SKB_GSO_UDP_TUNNEL_CSUM : SKB_GSO_UDP_TUNNEL; <span style="color:rgb(0,0,255);line-height:1.5;">#计算 GSO UDP 相关的 offload type，使得能够利用内核 GSO for UDP Tunnel</span>
    u16 hdrlen </span>= <span style="color:rgb(0,0,255);line-height:1.5;">sizeof</span>(<span style="color:rgb(0,0,255);line-height:1.5;">struct</span><span style="line-height:1.5;"> vxlanhdr);<span style="color:rgb(0,0,255);line-height:1.5;"> #计算 vxlan header 的长度 </span></span><span style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;">...<br></span></span><span style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;"> #计算 skb 新的 headroom，其中包含了 VXLAN Header 的长度</span>
    min_headroom </span>= LL_RESERVED_SPACE(rt-&gt;dst.dev) + rt-&gt;<span style="line-height:1.5;">dst.header_len </span>+ VXLAN_HLEN + <span style="color:rgb(0,0,255);line-height:1.5;">sizeof</span>(<span style="color:rgb(0,0,255);line-height:1.5;">struct</span><span style="line-height:1.5;"> iphdr)
            </span>+ (skb_vlan_tag_present(skb) ? VLAN_HLEN : <span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">);

    </span><span style="color:rgb(0,128,0);line-height:1.5;">/*</span><span style="color:rgb(0,128,0);line-height:1.5;"> Need space for new headers (invalidates iph ptr) </span><span style="color:rgb(0,128,0);line-height:1.5;">*/</span><span style="line-height:1.5;">
    err </span>=<span style="line-height:1.5;"> skb_cow_head(skb, min_headroom); <span style="color:rgb(0,0,255);line-height:1.5;">#使得 skb head 可写 </span></span><span style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;">...</span></span><span style="line-height:1.5;">
    skb </span>=<span style="line-height:1.5;"> vlan_hwaccel_push_inside(skb); <span style="color:rgb(0,0,255);line-height:1.5;">#处理 vlan 相关事情 </span></span><span style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;">...</span></span><span style="line-height:1.5;">
    skb </span>=<span style="line-height:1.5;"> iptunnel_handle_offloads(skb, udp_sum, type); <span style="color:rgb(0,0,255);line-height:1.5;">#设置 checksum 和 type </span></span><span style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;">...</span></span><span style="line-height:1.5;">
    vxh </span>= (<span style="color:rgb(0,0,255);line-height:1.5;">struct</span> vxlanhdr *) __skb_push(skb, <span style="color:rgb(0,0,255);line-height:1.5;">sizeof</span>(*<span style="line-height:1.5;">vxh)); <span style="color:rgb(0,0,255);line-height:1.5;">#扩展 skb data area，来容纳 vxlan header</span>
    vxh</span>-&gt;vx_flags =<span style="line-height:1.5;"> htonl(VXLAN_HF_VNI);
    vxh</span>-&gt;vx_vni =<span style="line-height:1.5;"> vni;
    ... </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (vxflags &amp;<span style="line-height:1.5;"> VXLAN_F_GBP)
        vxlan_build_gbp_hdr(vxh, vxflags, md);

    skb_set_inner_protocol(skb, htons(ETH_P_TEB)); <span style="color:rgb(0,0,255);line-height:1.5;">#设置 Ethernet protocol，这是 GSO 在 UDP tunnel 中必须要的</span>

    udp_tunnel_xmit_skb(rt, sk, skb, src, dst, tos, ttl, df, <span style="color:rgb(0,0,255);line-height:1.5;">#调用 linux 网络栈接口，将 skb 传给 udp tunnel 协议栈继续处理</span>
                src_port, dst_port, xnet, </span>!(vxflags &amp;<span style="line-height:1.5;"> VXLAN_F_UDP_CSUM));
    </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">;
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;<img src="https://images2015.cnblogs.com/blog/697113/201603/697113-20160301084204142-193071440.jpg" alt="" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;（3）接下来就进入了 Linux TCP/IP 协议栈，从 UDP 进入，然后再到 IP 层。如果硬件支持，则由硬件调用 linux 内核中的 UDP GSO 函数；如果硬件不支持，则在进入 device driver queue 之前由 linux 内核调用 UDP GSO 分片函数。然后再一直往下到网卡。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">最终在这个函数&nbsp;ip_finish_output_gso 里面，先调用 GSO分段函数，如果需要的话，再进行 IP 分片：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">int</span> ip_finish_output_gso(<span style="color:rgb(0,0,255);line-height:1.5;">struct</span> net *net, <span style="color:rgb(0,0,255);line-height:1.5;">struct</span> sock *<span style="line-height:1.5;">sk,
                                 </span><span style="color:rgb(0,0,255);line-height:1.5;">struct</span> sk_buff *skb, unsigned <span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> mtu)
 {
         netdev_features_t features;
         </span><span style="color:rgb(0,0,255);line-height:1.5;">struct</span> sk_buff *<span style="line-height:1.5;">segs;
         </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span> ret = <span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">;
 
         </span><span style="color:rgb(0,128,0);line-height:1.5;">/*</span><span style="color:rgb(0,128,0);line-height:1.5;"> Slowpath -  GSO segment length is exceeding the dst MTU.
          *
          * This can happen in two cases:
          * 1) TCP GRO packet, DF bit not set
          * 2) skb arrived via virtio-net, we thus get TSO/GSO skbs directly
          * from host network stack.
          </span><span style="color:rgb(0,128,0);line-height:1.5;">*/</span><span style="line-height:1.5;">
         features </span>=<span style="line-height:1.5;"> netif_skb_features(skb);
         segs </span>= skb_gso_segment(skb, features &amp; ~<span style="line-height:1.5;">NETIF_F_GSO_MASK); <span style="color:rgb(51,102,255);line-height:1.5;">#这里最终会调用到 UDP 的 gso_segment 回调函数进行 UDP GSO 分段 </span></span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;"> (IS_ERR_OR_NULL(segs)) {
                 kfree_skb(skb);
                 </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> -<span style="line-height:1.5;">ENOMEM;
         }
 
         consume_skb(skb);
 
         </span><span style="color:rgb(0,0,255);line-height:1.5;">do</span><span style="line-height:1.5;"> {
                 </span><span style="color:rgb(0,0,255);line-height:1.5;">struct</span> sk_buff *nskb = segs-&gt;<span style="line-height:1.5;">next;
                 </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> err;
 
                 segs</span>-&gt;next =<span style="line-height:1.5;"> NULL;
                 err </span>=<span style="line-height:1.5;"> ip_fragment(net, sk, segs, mtu, ip_finish_output2); <span style="color:rgb(51,102,255);line-height:1.5;">#需要的话，再进行 IP 分片，因为 UDP GSO 是按照 MSS 进行，MSS 还是有可能超过 IP 分段所使用的宿主机物理网卡 MTU 的 </span></span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (err &amp;&amp; ret == <span style="color:rgb(128,0,128);line-height:1.5;">0</span><span style="line-height:1.5;">)
                         ret </span>=<span style="line-height:1.5;"> err;
                 segs </span>=<span style="line-height:1.5;"> nskb;
         } </span><span style="color:rgb(0,0,255);line-height:1.5;">while</span><span style="line-height:1.5;"> (segs);
 
         </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> ret;
 }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">这是 UDP 层所注册的 gso 回调函数：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">const</span> <span style="color:rgb(0,0,255);line-height:1.5;">struct</span> net_offload udpv4_offload =<span style="line-height:1.5;"> {
    .callbacks </span>=<span style="line-height:1.5;"> {
        .gso_segment </span>=<span style="line-height:1.5;"> udp4_ufo_fragment,
        .gro_receive  </span>=<span style="line-height:1.5;">    udp4_gro_receive,
        .gro_complete </span>=<span style="line-height:1.5;">    udp4_gro_complete,
    },
};</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">它的实现在这里：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">struct</span> sk_buff *__skb_udp_tunnel_segment(<span style="color:rgb(0,0,255);line-height:1.5;">struct</span> sk_buff *<span style="line-height:1.5;">skb, netdev_features_t features,
    </span><span style="color:rgb(0,0,255);line-height:1.5;">struct</span> sk_buff *(*gso_inner_segment)(<span style="color:rgb(0,0,255);line-height:1.5;">struct</span> sk_buff *<span style="line-height:1.5;">skb, netdev_features_t features), __be16 new_protocol)
{
    </span><span style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;">...</span></span><span style="color:rgb(0,128,0);line-height:1.5;">/*</span><span style="color:rgb(0,128,0);line-height:1.5;"> segment inner packet. </span><span style="color:rgb(0,128,0);line-height:1.5;">*/ <span style="color:rgb(51,102,255);line-height:1.5;">#先调用内层的 分段函数进行分段</span></span><span style="line-height:1.5;">
    enc_features </span>= skb-&gt;dev-&gt;hw_enc_features &amp;<span style="line-height:1.5;"> netif_skb_features(skb);
    segs </span>=<span style="line-height:1.5;"> gso_inner_segment(skb, enc_features);
    </span><span style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;">...</span></span><span style="line-height:1.5;">
    skb </span>=<span style="line-height:1.5;"> segs;
    </span><span style="color:rgb(0,0,255);line-height:1.5;">do</span><span style="line-height:1.5;"> { <span style="color:rgb(51,102,255);line-height:1.5;">#执行 UDP GSO 分段 </span></span><span style="color:rgb(0,0,255);line-height:1.5;">struct</span> udphdr *<span style="line-height:1.5;">uh;
        </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span><span style="line-height:1.5;"> len;

        skb_reset_inner_headers(skb);
        skb</span>-&gt;encapsulation = <span style="color:rgb(128,0,128);line-height:1.5;">1</span><span style="line-height:1.5;">;

        skb</span>-&gt;mac_len =<span style="line-height:1.5;"> mac_len;

        skb_push(skb, outer_hlen);
        skb_reset_mac_header(skb);
        skb_set_network_header(skb, mac_len);
        skb_set_transport_header(skb, udp_offset);
        len </span>= skb-&gt;len -<span style="line-height:1.5;"> udp_offset;
        uh </span>=<span style="line-height:1.5;"> udp_hdr(skb);
        uh</span>-&gt;len =<span style="line-height:1.5;"> htons(len);
        </span><span style="line-height:1.5;"><span style="color:rgb(0,0,255);line-height:1.5;">...</span></span><span style="line-height:1.5;">
        skb</span>-&gt;protocol =<span style="line-height:1.5;"> protocol;
    } </span><span style="color:rgb(0,0,255);line-height:1.5;">while</span> ((skb = skb-&gt;<span style="line-height:1.5;">next));
</span><span style="color:rgb(0,0,255);line-height:1.5;">out</span><span style="line-height:1.5;">:
    </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> segs;
}

</span><span style="color:rgb(0,0,255);line-height:1.5;">struct</span> sk_buff *skb_udp_tunnel_segment(<span style="color:rgb(0,0,255);line-height:1.5;">struct</span> sk_buff *<span style="line-height:1.5;">skb, netdev_features_t features, </span><span style="color:rgb(0,0,255);line-height:1.5;">bool</span><span style="line-height:1.5;"> is_ipv6)
{
    ...</span><span style="color:rgb(0,0,255);line-height:1.5;">switch</span> (skb-&gt;<span style="line-height:1.5;">inner_protocol_type) { <span style="color:rgb(51,102,255);line-height:1.5;">#计算内层的分片方法 </span></span><span style="color:rgb(0,0,255);line-height:1.5;">case</span><span style="line-height:1.5;"> ENCAP_TYPE_ETHER: <span style="color:rgb(0,0,255);line-height:1.5;">#感觉 vxlan 的 GSO 应该是走这个分支，相当于是将 VXLAN 所封装的二层帧当做 payload 来分段，而不是将包含 VXLAN Header 的部分来分</span>
        protocol </span>= skb-&gt;<span style="line-height:1.5;">inner_protocol;
        gso_inner_segment </span>=<span style="line-height:1.5;"> skb_mac_gso_segment;
        </span><span style="color:rgb(0,0,255);line-height:1.5;">break</span><span style="line-height:1.5;">;
    </span><span style="color:rgb(0,0,255);line-height:1.5;">case</span><span style="line-height:1.5;"> ENCAP_TYPE_IPPROTO:
        offloads </span>= is_ipv6 ?<span style="line-height:1.5;"> inet6_offloads : inet_offloads;
        ops </span>= rcu_dereference(offloads[skb-&gt;<span style="line-height:1.5;">inner_ipproto]);
        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (!ops || !ops-&gt;<span style="line-height:1.5;">callbacks.gso_segment)
            </span><span style="color:rgb(0,0,255);line-height:1.5;">goto</span><span style="line-height:1.5;"> out_unlock;
        gso_inner_segment </span>= ops-&gt;<span style="line-height:1.5;">callbacks.gso_segment;
        </span><span style="color:rgb(0,0,255);line-height:1.5;">break</span><span style="line-height:1.5;">;
    </span><span style="color:rgb(0,0,255);line-height:1.5;">default</span><span style="line-height:1.5;">:
        </span><span style="color:rgb(0,0,255);line-height:1.5;">goto</span><span style="line-height:1.5;"> out_unlock;
    }

    segs </span>=<span style="line-height:1.5;"> __skb_udp_tunnel_segment(skb, features, gso_inner_segment,
                    protocol);
    ...
    </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;"> segs; <span style="color:rgb(51,102,255);line-height:1.5;">#返回分片好的seg list</span>
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">这里比较有疑问的是，VXLAN 没有定义 gso_segment 回调函数，这导致有可能在 UDP GSO 分段里面没有完整的 VXLAN Header。。这需要进一步研究。原因可能是在 inner segment 那里，分段是将 UDP 所封装的二层帧当做 payload 来分段，因此，VXLAN Header 就会保持在每个分段中。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（4）可见，在整个过程中，有客户机上 TCP 协议层设置的&nbsp;<em>skb_shinfo(skb)-&gt;gso_size</em>&nbsp;始终保持不变为 MSS，因此，在网卡中最终所做的针对 UDP GSO 数据报的 GSO 分片所依据的分片的长度还是根据 skb_shinfo(skb)-&gt;gso_size 的值即&nbsp;TCP MSS。</p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">3. 发送端现有方案的问题和改进方法</h2> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">3.1 问题</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp; 从上面所描述的过程可以看出来，目前的 VXLAN 协议和实现中存在一个问题，那就是：最终在宿主机上所做的 IP 分片是根据客户机中 TCP 连接的 MSS 来进行的，而实际的网络环境中，宿主机的网卡的 MTU 往往采用巨帧技术设置为 9000 bytes，而客户机的网卡 MTU 往往使用默认的 1500 bytes，在接收端也是同样类型的节点的情况下，目前的分片方式存在很大的资源浪费。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp; &nbsp; 理想的情况分为几种：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">（1）如果接收端是同样的采用 VXLAN VETP 的节点，IP 分片应该按照物理网卡的 MTU 进行，到了对端做了 IP 分片重组后，直接由 VXLAN VTEP 交给虚机。</li> 
    <li style="list-style-type:disc;">（2）如果对方是将会连接外网的 VXLAN Gateway 节点，那对端 VXLAN VTEP 收到 IP 分片重组后的大网络包后，它自己或者使用 Linux 网络协议栈 segmentation offloading 技术对大包进行分片，然后再转发到外网。</li> 
    <li style="list-style-type:disc;">（3）如果对方是普通网络节点（此时发送端是 VXLAN Gateway 节点），那么走当前的模式，根据 TCP MSS 使用 UDP/IP 分片，再发出去。</li> 
   </ul>
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">3.2 一种实现方案</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;&nbsp;文章&nbsp;<a href="https://tools.ietf.org/html/draft-zhou-li-vxlan-soe-01" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">Segmentation Offloading Extension for VXLAN</a>&nbsp;提出了一种&nbsp;VXLAN Segmentation Offloading Extension (VXLAN-soe) 实现方案。该方案扩展了 VXLAN Header，添加了几个新的标志位：（S - 标志位，是否使用该技术； Overlay MSS Hi 和 Lo：对 TCP，就是 MSS；对 UDP，就是 MTU）</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/697113/201603/697113-20160301133916314-1841801983.jpg" alt="" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">发送端 VXLAN VTEP 根据配置或者别的条件</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">设置 S = 1，表示 offload segmentation 到对端节点上的 VXLAN VTEP，并设置 Overlay MSS Hi 和 Lo</li> 
    <li style="list-style-type:disc;">设置 S= 0，表示不做 remote&nbsp;segmentation offloading，做普通的处理</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">接收端 VXLAN Hypervisor VTEP 将检查 S 标志位：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">如果为 1，则不做 MTU 检查，直接将包交给虚机</li> 
    <li style="list-style-type:disc;">S 标志位，如果为 0，则走普通处理流程</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">接收端 VXLAN Gateway VTEP：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">检查 S 标志位，如果为 1，则它自己或者利用 segmentation offloading 技术做分片</li>
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">该方案的问题是当&nbsp;S = 1 时，会产生 UDP/IP 分片。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><br></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><br></p> 
   <p style="line-height:1.5;"><font color="#4b4b4b"><span style="font-size:15px;">&nbsp; &nbsp; 本文转自SammyLiu博客园博客，原文链接：http://www.cnblogs.com/sammyliu/p/5228581.html</span></font><span style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">，如需转载请自行联系原作者</span></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><br></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
