<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>RabbitMQ的几种典型使用场景 « NotBeCN</title>
  <meta name="description" content="             RabbitMQ主页：https://www.rabbitmq.com/    AMQP    AMQP协议是一个高级抽象层消息通信协议，RabbitMQ是AMQP协议的实现。它主要包括以下组件：        1.Server(broker):&nbsp;接受客户端连接，实现AMQP消...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/07/weixin_33779515_90117650.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">RabbitMQ的几种典型使用场景</h1>
    <p class="post-meta">Nov 7, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">RabbitMQ主页：https://www.rabbitmq.com/</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><strong>AMQP</strong></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><span>AMQP协议是一个高级抽象层消息通信协议，<span>RabbitMQ是<span>AMQP协议的实现。它主要包括以下组件：</span></span></span></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><span><img src="https://images2015.cnblogs.com/blog/434101/201601/434101-20160124204752953-1513084258.png" alt="" style="border:none;"></span></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><span>1.Server(broker):&nbsp;接受客户端连接，实现<span>AMQP消息队列和路由功能的进程。</span></span></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">2.Virtual Host:其实是一个虚拟概念，类似于权限控制组，一个Virtual Host里面可以有若干个Exchange和Queue，但是权限控制的最小粒度是Virtual Host</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">3.Exchange:接受生产者发送的消息，并根据Binding规则将消息路由给服务器中的队列。ExchangeType决定了Exchange路由消息的行为，例如，在RabbitMQ中，ExchangeType有direct、Fanout和Topic三种，不同类型的Exchange路由的行为是不一样的。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">4.<span>Message Queue：消息队列，用于存储还未被消费者消费的消息。</span></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><span>5.Message:&nbsp;由Header和Body组成，Header是由生产者添加的各种属性的集合，包括Message是否被持久化、由哪个Message Queue接受、优先级是多少等。而Body是真正需要传输的APP数据。</span></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">6.<span>Binding:Binding联系了<span>Exchange与<span>Message Queue。<span>Exchange在与多个<span>Message Queue发生<span>Binding后会生成一张路由表，路由表中存储着<span>Message Queue所需消息的限制条件即<span>Binding Key。当<span>Exchange收到<span>Message时会解析其<span>Header得到<span>Routing Key，<span>Exchange根据<span>Routing Key与<span>Exchange Type将<span>Message路由到<span>Message Queue。<span>Binding Key由<span>Consumer在<span>Binding Exchange与<span>Message Queue时指定，而<span>Routing Key由<span>Producer发送<span>Message时指定，两者的匹配方式由<span>Exchange Type决定。<span>&nbsp;</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">7.Connection:连接，对于RabbitMQ而言，其实就是一个位于客户端和Broker之间的TCP连接。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">8.Channel:信道，仅仅创建了客户端到Broker之间的连接后，客户端还是不能发送消息的。需要为每一个Connection创建Channel，AMQP协议规定只有通过Channel才能执行AMQP的命令。一个Connection可以包含多个Channel。之所以需要Channel，是因为TCP连接的建立和释放都是十分昂贵的，如果一个客户端每一个线程都需要与Broker交互，如果每一个线程都建立一个TCP连接，暂且不考虑TCP连接是否浪费，就算操作系统也无法承受每秒建立如此多的TCP连接。<span style="color:rgb(255,0,0);">RabbitMQ建议</span><span style="color:rgb(255,0,0);">客户端线程之间不要共用</span><span style="color:rgb(255,0,0);">Channel，至少要保证共用Channel的线程发送消息必须是串行的，但是建议尽量共用Connection</span>。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">9.Command:AMQP的命令，客户端通过Command完成与AMQP服务器的交互来实现自身的逻辑。例如在RabbitMQ中，客户端可以通过publish命令发送消息，txSelect开启一个事务，txCommit提交一个事务。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">在了解了AMQP模型以后，需要简单介绍一下AMQP的协议栈，AMQP协议本身包括三层：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/434101/201601/434101-20160124205249375-897662551.png" alt="" style="border:none;"></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><span>1.<span>Module Layer，位于协议最高层，主要定义了一些供客户端调用的命令，客户端可以利用这些命令实现自己的业务逻辑，例如，客户端可以通过<span>queue.declare声明一个队列，利用<span>consume命令获取一个队列中的消息。</span></span></span></span></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><span>2.<span>Session Layer，主要负责将客户端的命令发送给服务器，在将服务器端的应答返回给客户端，主要为客户端与服务器之间通信提供可靠性、同步机制和错误处理。</span></span></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><span>3.Transport Layer，主要传输二进制数据流，提供帧的处理、信道复用、错误检测和数据表示。</span></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><strong><span>RabbitMQ使用场景</span></strong></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">学习RabbitMQ的使用场景，来自官方教程：https://www.rabbitmq.com/getstarted.html</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><strong>场景1：单发送单接收</strong></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">使用场景：简单的发送与接收，没有特别的处理。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images0.cnblogs.com/i/434101/201408/171507104838529.png" alt="" style="border:none;"></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">Producer：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.ConnectionFactory;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.Connection;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.Channel;

</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;"> Send {
    
  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">final</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> String QUEUE_NAME = "hello"<span style="font-size:12px;line-height:1.5;">;

  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> main(String[] argv) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> Exception {
                
    ConnectionFactory factory </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> ConnectionFactory();
    factory.setHost(</span>"localhost"<span style="font-size:12px;line-height:1.5;">);
    Connection connection </span>=<span style="font-size:12px;line-height:1.5;"> factory.newConnection();
    Channel channel </span>=<span style="font-size:12px;line-height:1.5;"> connection.createChannel();

    channel.queueDeclare(QUEUE_NAME, </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">false</span>, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">false</span>, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">false</span>, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">);
    String message </span>= "Hello World!"<span style="font-size:12px;line-height:1.5;">;
    channel.basicPublish(</span>"", QUEUE_NAME, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">, message.getBytes());
    System.out.println(</span>" [x] Sent '" + message + "'"<span style="font-size:12px;line-height:1.5;">);
    
    channel.close();
    connection.close();
  }
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">Consumer：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.ConnectionFactory;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.Connection;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.Channel;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.QueueingConsumer;

</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;"> Recv {
    
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">final</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> String QUEUE_NAME = "hello"<span style="font-size:12px;line-height:1.5;">;

    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> main(String[] argv) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> Exception {

    ConnectionFactory factory </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> ConnectionFactory();
    factory.setHost(</span>"localhost"<span style="font-size:12px;line-height:1.5;">);
    Connection connection </span>=<span style="font-size:12px;line-height:1.5;"> factory.newConnection();
    Channel channel </span>=<span style="font-size:12px;line-height:1.5;"> connection.createChannel();

    channel.queueDeclare(QUEUE_NAME, </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">false</span>, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">false</span>, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">false</span>, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">);
    System.out.println(</span>" [*] Waiting for messages. To exit press CTRL+C"<span style="font-size:12px;line-height:1.5;">);
    
    QueueingConsumer consumer </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> QueueingConsumer(channel);
    channel.basicConsume(QUEUE_NAME, </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">true</span><span style="font-size:12px;line-height:1.5;">, consumer);
    
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">while</span> (<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">true</span><span style="font-size:12px;line-height:1.5;">) {
      QueueingConsumer.Delivery delivery </span>=<span style="font-size:12px;line-height:1.5;"> consumer.nextDelivery();
      String message </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> String(delivery.getBody());
      System.out.println(</span>" [x] Received '" + message + "'"<span style="font-size:12px;line-height:1.5;">);
    }
  }
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><strong>场景2：单发送多接收</strong></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">使用场景：一个发送端，多个接收端，如分布式的任务派发。为了保证消息发送的可靠性，不丢失消息，使消息持久化了。同时为了防止接收端在处理消息时down掉，只有在消息处理完成后才发送ack消息。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images0.cnblogs.com/i/434101/201408/171513043112193.png" alt="" style="border:none;"></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">Producer：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.ConnectionFactory;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.Connection;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.Channel;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.MessageProperties;

</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;"> NewTask {
  
  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">final</span> String TASK_QUEUE_NAME = "task_queue"<span style="font-size:12px;line-height:1.5;">;

  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> main(String[] argv) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> Exception {

    ConnectionFactory factory </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> ConnectionFactory();
    factory.setHost(</span>"localhost"<span style="font-size:12px;line-height:1.5;">);
    Connection connection </span>=<span style="font-size:12px;line-height:1.5;"> factory.newConnection();
    Channel channel </span>=<span style="font-size:12px;line-height:1.5;"> connection.createChannel();
    
    channel.queueDeclare(TASK_QUEUE_NAME, </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">true</span>, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">false</span>, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">false</span>, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">);
    
    String message </span>=<span style="font-size:12px;line-height:1.5;"> getMessage(argv);
    
    channel.basicPublish( </span>""<span style="font-size:12px;line-height:1.5;">, TASK_QUEUE_NAME, 
                MessageProperties.PERSISTENT_TEXT_PLAIN,
                message.getBytes());
    System.out.println(</span>" [x] Sent '" + message + "'"<span style="font-size:12px;line-height:1.5;">);
    
    channel.close();
    connection.close();
  }
    
  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span><span style="font-size:12px;line-height:1.5;"> String getMessage(String[] strings){
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (strings.length &lt; 1<span style="font-size:12px;line-height:1.5;">)
      </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> "Hello World!"<span style="font-size:12px;line-height:1.5;">;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> joinStrings(strings, " "<span style="font-size:12px;line-height:1.5;">);
  }  
  
  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span><span style="font-size:12px;line-height:1.5;"> String joinStrings(String[] strings, String delimiter) {
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> length =<span style="font-size:12px;line-height:1.5;"> strings.length;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (length == 0) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> ""<span style="font-size:12px;line-height:1.5;">;
    StringBuilder words </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> StringBuilder(strings[0<span style="font-size:12px;line-height:1.5;">]);
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span> (<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> i = 1; i &lt; length; i++<span style="font-size:12px;line-height:1.5;">) {
      words.append(delimiter).append(strings[i]);
    }
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;"> words.toString();
  }
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">发送端和场景1不同点：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">1、使用“task_queue”声明了另一个Queue，因为RabbitMQ不容许声明2个相同名称、配置不同的Queue</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">2、使"task_queue"的Queue的durable的属性为true，即使消息队列durable</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">3、使用MessageProperties.PERSISTENT_TEXT_PLAIN使消息durable</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">When RabbitMQ quits or crashes it will forget the queues and messages unless you tell it not to. Two things are required to make sure that messages aren't lost: we need to mark both the queue and messages as durable.</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">Consumer：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.ConnectionFactory;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.Connection;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.Channel;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.QueueingConsumer;
  
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;"> Worker {

  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">final</span> String TASK_QUEUE_NAME = "task_queue"<span style="font-size:12px;line-height:1.5;">;

  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> main(String[] argv) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> Exception {

    ConnectionFactory factory </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> ConnectionFactory();
    factory.setHost(</span>"localhost"<span style="font-size:12px;line-height:1.5;">);
    Connection connection </span>=<span style="font-size:12px;line-height:1.5;"> factory.newConnection();
    Channel channel </span>=<span style="font-size:12px;line-height:1.5;"> connection.createChannel();
    
    channel.queueDeclare(TASK_QUEUE_NAME, </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">true</span>, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">false</span>, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">false</span>, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">);
    System.out.println(</span>" [*] Waiting for messages. To exit press CTRL+C"<span style="font-size:12px;line-height:1.5;">);
    
    channel.basicQos(</span>1<span style="font-size:12px;line-height:1.5;">);
    
    QueueingConsumer consumer </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> QueueingConsumer(channel);
    channel.basicConsume(TASK_QUEUE_NAME, </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">false</span><span style="font-size:12px;line-height:1.5;">, consumer);
    
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">while</span> (<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">true</span><span style="font-size:12px;line-height:1.5;">) {
      QueueingConsumer.Delivery delivery </span>=<span style="font-size:12px;line-height:1.5;"> consumer.nextDelivery();
      String message </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> String(delivery.getBody());
      
      System.out.println(</span>" [x] Received '" + message + "'"<span style="font-size:12px;line-height:1.5;">);
      doWork(message);
      System.out.println(</span>" [x] Done"<span style="font-size:12px;line-height:1.5;">);

      channel.basicAck(delivery.getEnvelope().getDeliveryTag(), </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">false</span><span style="font-size:12px;line-height:1.5;">);
    }         
  }
  
  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> doWork(String task) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> InterruptedException {
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span> (<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span><span style="font-size:12px;line-height:1.5;"> ch: task.toCharArray()) {
      </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (ch == '.') Thread.sleep(1000<span style="font-size:12px;line-height:1.5;">);
    }
  }
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">接收端和场景1不同点：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">1、使用“task_queue”声明消息队列，并使消息队列durable</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">2、在使用channel.basicConsume接收消息时使autoAck为false，即不自动会发ack，由channel.basicAck()在消息处理完成后发送消息。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">3、使用了channel.basicQos(1)保证在接收端一个消息没有处理完时不会接收另一个消息，即接收端发送了ack后才会接收下一个消息。在这种情况下发送端会尝试把消息发送给下一个not busy的接收端。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">注意点：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">1）It's a common mistake to miss the&nbsp;<span class="code">basicAck. It's an easy error, but the consequences are serious. Messages will be redelivered when your client quits (which may look like random redelivery), but RabbitMQ will eat more and more memory as it won't be able to release any unacked messages.</span></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">2）Note on message persistence</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">Marking messages as persistent doesn't fully guarantee that a message won't be lost. Although it tells RabbitMQ to save the message to disk, there is still a short time window when RabbitMQ has accepted a message and hasn't saved it yet. Also, RabbitMQ doesn't do&nbsp;<span class="code">fsync(2)&nbsp;for every message -- it may be just saved to cache and not really written to the disk. The persistence guarantees aren't strong, but it's more than enough for our simple task queue. If you need a stronger guarantee you can wrap the publishing code in a<em>transaction</em>.</span></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><span class="code">3）</span>Note about queue size</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">If all the workers are busy, your queue can fill up. You will want to keep an eye on that, and maybe add more workers, or have some other strategy.</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">4）RabbitMQ allows you to set Time To Live for both messages and queues.&nbsp;https://www.rabbitmq.com/ttl.html</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><strong>场景3：Publish/Subscribe</strong></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">使用场景：发布、订阅模式，发送端发送广播消息，多个接收端接收。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images0.cnblogs.com/i/434101/201408/171657207955618.png" alt="" style="border:none;"></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">Producer：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.ConnectionFactory;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.Connection;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.Channel;

</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;"> EmitLog {

  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">final</span> String EXCHANGE_NAME = "logs"<span style="font-size:12px;line-height:1.5;">;

  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> main(String[] argv) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> Exception {

    ConnectionFactory factory </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> ConnectionFactory();
    factory.setHost(</span>"localhost"<span style="font-size:12px;line-height:1.5;">);
    Connection connection </span>=<span style="font-size:12px;line-height:1.5;"> factory.newConnection();
    Channel channel </span>=<span style="font-size:12px;line-height:1.5;"> connection.createChannel();

    channel.exchangeDeclare(EXCHANGE_NAME, </span>"fanout"<span style="font-size:12px;line-height:1.5;">);

    String message </span>=<span style="font-size:12px;line-height:1.5;"> getMessage(argv);

    channel.basicPublish(EXCHANGE_NAME, </span>"", <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">, message.getBytes());
    System.out.println(</span>" [x] Sent '" + message + "'"<span style="font-size:12px;line-height:1.5;">);

    channel.close();
    connection.close();
  }
  
  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span><span style="font-size:12px;line-height:1.5;"> String getMessage(String[] strings){
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (strings.length &lt; 1<span style="font-size:12px;line-height:1.5;">)
            </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> "info: Hello World!"<span style="font-size:12px;line-height:1.5;">;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> joinStrings(strings, " "<span style="font-size:12px;line-height:1.5;">);
  }
  
  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span><span style="font-size:12px;line-height:1.5;"> String joinStrings(String[] strings, String delimiter) {
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> length =<span style="font-size:12px;line-height:1.5;"> strings.length;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (length == 0) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> ""<span style="font-size:12px;line-height:1.5;">;
    StringBuilder words </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span> StringBuilder(strings[0<span style="font-size:12px;line-height:1.5;">]);
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span> (<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> i = 1; i &lt; length; i++<span style="font-size:12px;line-height:1.5;">) {
        words.append(delimiter).append(strings[i]);
    }
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;"> words.toString();
  }
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">发送端：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">发送消息到一个名为“logs”的exchange上，使用“fanout”方式发送，即广播消息，不需要使用queue，发送端不需要关心谁接收。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">Consumer：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.ConnectionFactory;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.Connection;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.Channel;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.QueueingConsumer;

</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;"> ReceiveLogs {

  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">final</span> String EXCHANGE_NAME = "logs"<span style="font-size:12px;line-height:1.5;">;

  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> main(String[] argv) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> Exception {

    ConnectionFactory factory </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> ConnectionFactory();
    factory.setHost(</span>"localhost"<span style="font-size:12px;line-height:1.5;">);
    Connection connection </span>=<span style="font-size:12px;line-height:1.5;"> factory.newConnection();
    Channel channel </span>=<span style="font-size:12px;line-height:1.5;"> connection.createChannel();

    channel.exchangeDeclare(EXCHANGE_NAME, </span>"fanout"<span style="font-size:12px;line-height:1.5;">);
    String queueName </span>=<span style="font-size:12px;line-height:1.5;"> channel.queueDeclare().getQueue();
    channel.queueBind(queueName, EXCHANGE_NAME, </span>""<span style="font-size:12px;line-height:1.5;">);
    
    System.out.println(</span>" [*] Waiting for messages. To exit press CTRL+C"<span style="font-size:12px;line-height:1.5;">);

    QueueingConsumer consumer </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> QueueingConsumer(channel);
    channel.basicConsume(queueName, </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">true</span><span style="font-size:12px;line-height:1.5;">, consumer);

    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">while</span> (<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">true</span><span style="font-size:12px;line-height:1.5;">) {
      QueueingConsumer.Delivery delivery </span>=<span style="font-size:12px;line-height:1.5;"> consumer.nextDelivery();
      String message </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> String(delivery.getBody());

      System.out.println(</span>" [x] Received '" + message + "'"<span style="font-size:12px;line-height:1.5;">);   
    }
  }
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">接收端：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">1、声明名为“logs”的exchange的，方式为"fanout"，和发送端一样。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">2、<span class="n">channel<span class="o">.<span class="na">queueDeclare<span class="o">().<span class="na">getQueue<span class="o">();该语句得到一个随机名称的Queue，该queue的类型为non-durable、exclusive、auto-delete的，将该queue绑定到上面的exchange上接收消息。</span></span></span></span></span></span></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><span class="n">3、注意binding queue的时候，channel.queueBind()的第三个参数Routing key为空，即所有的消息都接收。如果这个值不为空，在exchange type为“fanout”方式下该值被忽略！</span></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><strong>场景4：Routing (按路线发送接收)</strong></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">使用场景：发送端按routing key发送消息，不同的接收端按不同的routing key接收消息。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images0.cnblogs.com/i/434101/201408/171709256231158.png" alt="" style="border:none;"></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">Producer：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.ConnectionFactory;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.Connection;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.Channel;

</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;"> EmitLogDirect {

  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">final</span> String EXCHANGE_NAME = "direct_logs"<span style="font-size:12px;line-height:1.5;">;

  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> main(String[] argv) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> Exception {

    ConnectionFactory factory </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> ConnectionFactory();
    factory.setHost(</span>"localhost"<span style="font-size:12px;line-height:1.5;">);
    Connection connection </span>=<span style="font-size:12px;line-height:1.5;"> factory.newConnection();
    Channel channel </span>=<span style="font-size:12px;line-height:1.5;"> connection.createChannel();

    channel.exchangeDeclare(EXCHANGE_NAME, </span>"direct"<span style="font-size:12px;line-height:1.5;">);

    String severity </span>=<span style="font-size:12px;line-height:1.5;"> getSeverity(argv);
    String message </span>=<span style="font-size:12px;line-height:1.5;"> getMessage(argv);

    channel.basicPublish(EXCHANGE_NAME, severity, </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">, message.getBytes());
    System.out.println(</span>" [x] Sent '" + severity + "':'" + message + "'"<span style="font-size:12px;line-height:1.5;">);

    channel.close();
    connection.close();
  }
  
  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span><span style="font-size:12px;line-height:1.5;"> String getSeverity(String[] strings){
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (strings.length &lt; 1<span style="font-size:12px;line-height:1.5;">)
            </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> "info"<span style="font-size:12px;line-height:1.5;">;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> strings[0<span style="font-size:12px;line-height:1.5;">];
  }

  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span><span style="font-size:12px;line-height:1.5;"> String getMessage(String[] strings){ 
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (strings.length &lt; 2<span style="font-size:12px;line-height:1.5;">)
            </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> "Hello World!"<span style="font-size:12px;line-height:1.5;">;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> joinStrings(strings, " ", 1<span style="font-size:12px;line-height:1.5;">);
  }
  
  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> String joinStrings(String[] strings, String delimiter, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> startIndex) {
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> length =<span style="font-size:12px;line-height:1.5;"> strings.length;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (length == 0 ) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> ""<span style="font-size:12px;line-height:1.5;">;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (length &lt; startIndex ) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> ""<span style="font-size:12px;line-height:1.5;">;
    StringBuilder words </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> StringBuilder(strings[startIndex]);
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span> (<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> i = startIndex + 1; i &lt; length; i++<span style="font-size:12px;line-height:1.5;">) {
        words.append(delimiter).append(strings[i]);
    }
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;"> words.toString();
  }
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">发送端和场景3的区别：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">1、exchange的type为direct</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">2、发送消息的时候加入了routing key</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">Consumer：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.ConnectionFactory;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.Connection;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.Channel;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.QueueingConsumer;

</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;"> ReceiveLogsDirect {

  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">final</span> String EXCHANGE_NAME = "direct_logs"<span style="font-size:12px;line-height:1.5;">;

  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> main(String[] argv) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">throws</span><span style="font-size:12px;line-height:1.5;"> Exception {

    ConnectionFactory factory </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> ConnectionFactory();
    factory.setHost(</span>"localhost"<span style="font-size:12px;line-height:1.5;">);
    Connection connection </span>=<span style="font-size:12px;line-height:1.5;"> factory.newConnection();
    Channel channel </span>=<span style="font-size:12px;line-height:1.5;"> connection.createChannel();

    channel.exchangeDeclare(EXCHANGE_NAME, </span>"direct"<span style="font-size:12px;line-height:1.5;">);
    String queueName </span>=<span style="font-size:12px;line-height:1.5;"> channel.queueDeclare().getQueue();
    
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (argv.length &lt; 1<span style="font-size:12px;line-height:1.5;">){
      System.err.println(</span>"Usage: ReceiveLogsDirect [info] [warning] [error]"<span style="font-size:12px;line-height:1.5;">);
      System.exit(</span>1<span style="font-size:12px;line-height:1.5;">);
    }
    
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span><span style="font-size:12px;line-height:1.5;">(String severity : argv){    
      channel.queueBind(queueName, EXCHANGE_NAME, severity);
    }
    
    System.out.println(</span>" [*] Waiting for messages. To exit press CTRL+C"<span style="font-size:12px;line-height:1.5;">);

    QueueingConsumer consumer </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> QueueingConsumer(channel);
    channel.basicConsume(queueName, </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">true</span><span style="font-size:12px;line-height:1.5;">, consumer);

    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">while</span> (<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">true</span><span style="font-size:12px;line-height:1.5;">) {
      QueueingConsumer.Delivery delivery </span>=<span style="font-size:12px;line-height:1.5;"> consumer.nextDelivery();
      String message </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> String(delivery.getBody());
      String routingKey </span>=<span style="font-size:12px;line-height:1.5;"> delivery.getEnvelope().getRoutingKey();

      System.out.println(</span>" [x] Received '" + routingKey + "':'" + message + "'"<span style="font-size:12px;line-height:1.5;">);   
    }
  }
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">接收端和场景3的区别：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">在绑定queue和exchange的时候使用了routing key，即从该exchange上只接收routing key指定的消息。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><strong>场景5：Topics (按topic发送接收)</strong></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">使用场景：发送端不只按固定的routing key发送消息，而是按字符串“匹配”发送，接收端同样如此。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images0.cnblogs.com/i/434101/201408/171739210926049.png" alt="" style="border:none;"></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">Producer：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.ConnectionFactory;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.Connection;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.Channel;

</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;"> EmitLogTopic {

  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">final</span> String EXCHANGE_NAME = "topic_logs"<span style="font-size:12px;line-height:1.5;">;

  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span><span style="font-size:12px;line-height:1.5;"> main(String[] argv) {
    Connection connection </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">;
    Channel channel </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">try</span><span style="font-size:12px;line-height:1.5;"> {
      ConnectionFactory factory </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> ConnectionFactory();
      factory.setHost(</span>"localhost"<span style="font-size:12px;line-height:1.5;">);
  
      connection </span>=<span style="font-size:12px;line-height:1.5;"> factory.newConnection();
      channel </span>=<span style="font-size:12px;line-height:1.5;"> connection.createChannel();

      channel.exchangeDeclare(EXCHANGE_NAME, </span>"topic"<span style="font-size:12px;line-height:1.5;">);

      String routingKey </span>=<span style="font-size:12px;line-height:1.5;"> getRouting(argv);
      String message </span>=<span style="font-size:12px;line-height:1.5;"> getMessage(argv);

      channel.basicPublish(EXCHANGE_NAME, routingKey, </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">, message.getBytes());
      System.out.println(</span>" [x] Sent '" + routingKey + "':'" + message + "'"<span style="font-size:12px;line-height:1.5;">);

    }
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">catch</span><span style="font-size:12px;line-height:1.5;">  (Exception e) {
      e.printStackTrace();
    }
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">finally</span><span style="font-size:12px;line-height:1.5;"> {
      </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (connection != <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">) {
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">try</span><span style="font-size:12px;line-height:1.5;"> {
          connection.close();
        }
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">catch</span><span style="font-size:12px;line-height:1.5;"> (Exception ignore) {}
      }
    }
  }
  
  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span><span style="font-size:12px;line-height:1.5;"> String getRouting(String[] strings){
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (strings.length &lt; 1<span style="font-size:12px;line-height:1.5;">)
            </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> "anonymous.info"<span style="font-size:12px;line-height:1.5;">;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> strings[0<span style="font-size:12px;line-height:1.5;">];
  }

  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span><span style="font-size:12px;line-height:1.5;"> String getMessage(String[] strings){ 
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (strings.length &lt; 2<span style="font-size:12px;line-height:1.5;">)
            </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> "Hello World!"<span style="font-size:12px;line-height:1.5;">;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> joinStrings(strings, " ", 1<span style="font-size:12px;line-height:1.5;">);
  }
  
  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> String joinStrings(String[] strings, String delimiter, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> startIndex) {
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> length =<span style="font-size:12px;line-height:1.5;"> strings.length;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (length == 0 ) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> ""<span style="font-size:12px;line-height:1.5;">;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (length &lt; startIndex ) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> ""<span style="font-size:12px;line-height:1.5;">;
    StringBuilder words </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> StringBuilder(strings[startIndex]);
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span> (<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> i = startIndex + 1; i &lt; length; i++<span style="font-size:12px;line-height:1.5;">) {
        words.append(delimiter).append(strings[i]);
    }
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;"> words.toString();
  }
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">发送端和场景4的区别：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">1、exchange的type为topic</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">2、发送消息的routing key不是固定的单词，而是匹配字符串，如"*.lu.#"，*匹配一个单词，#匹配0个或多个单词。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">Consumer：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.ConnectionFactory;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.Connection;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.Channel;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">import</span><span style="font-size:12px;line-height:1.5;"> com.rabbitmq.client.QueueingConsumer;

</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span><span style="font-size:12px;line-height:1.5;"> ReceiveLogsTopic {

  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">private</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">final</span> String EXCHANGE_NAME = "topic_logs"<span style="font-size:12px;line-height:1.5;">;

  </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span><span style="font-size:12px;line-height:1.5;"> main(String[] argv) {
    Connection connection </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">;
    Channel channel </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">try</span><span style="font-size:12px;line-height:1.5;"> {
      ConnectionFactory factory </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> ConnectionFactory();
      factory.setHost(</span>"localhost"<span style="font-size:12px;line-height:1.5;">);
  
      connection </span>=<span style="font-size:12px;line-height:1.5;"> factory.newConnection();
      channel </span>=<span style="font-size:12px;line-height:1.5;"> connection.createChannel();

      channel.exchangeDeclare(EXCHANGE_NAME, </span>"topic"<span style="font-size:12px;line-height:1.5;">);
      String queueName </span>=<span style="font-size:12px;line-height:1.5;"> channel.queueDeclare().getQueue();
 
      </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (argv.length &lt; 1<span style="font-size:12px;line-height:1.5;">){
        System.err.println(</span>"Usage: ReceiveLogsTopic [binding_key]..."<span style="font-size:12px;line-height:1.5;">);
        System.exit(</span>1<span style="font-size:12px;line-height:1.5;">);
      }
    
      </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span><span style="font-size:12px;line-height:1.5;">(String bindingKey : argv){    
        channel.queueBind(queueName, EXCHANGE_NAME, bindingKey);
      }
    
      System.out.println(</span>" [*] Waiting for messages. To exit press CTRL+C"<span style="font-size:12px;line-height:1.5;">);

      QueueingConsumer consumer </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> QueueingConsumer(channel);
      channel.basicConsume(queueName, </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">true</span><span style="font-size:12px;line-height:1.5;">, consumer);

      </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">while</span> (<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">true</span><span style="font-size:12px;line-height:1.5;">) {
        QueueingConsumer.Delivery delivery </span>=<span style="font-size:12px;line-height:1.5;"> consumer.nextDelivery();
        String message </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> String(delivery.getBody());
        String routingKey </span>=<span style="font-size:12px;line-height:1.5;"> delivery.getEnvelope().getRoutingKey();

        System.out.println(</span>" [x] Received '" + routingKey + "':'" + message + "'"<span style="font-size:12px;line-height:1.5;">);   
      }
    }
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">catch</span><span style="font-size:12px;line-height:1.5;">  (Exception e) {
      e.printStackTrace();
    }
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">finally</span><span style="font-size:12px;line-height:1.5;"> {
      </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (connection != <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">null</span><span style="font-size:12px;line-height:1.5;">) {
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">try</span><span style="font-size:12px;line-height:1.5;"> {
          connection.close();
        }
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">catch</span><span style="font-size:12px;line-height:1.5;"> (Exception ignore) {}
      }
    }
  }
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">接收端和场景4的区别：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">1、exchange的type为topic</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">2、接收消息的routing key不是固定的单词，而是匹配字符串。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">注意点：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">Topic exchange</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">Topic exchange is powerful and can behave like other exchanges.&nbsp;When a queue is bound with "<span class="code">#" (hash) binding key - it will receive all the messages, regardless of the routing key - like in&nbsp;<span class="code">fanout&nbsp;exchange.&nbsp;</span></span>When special characters "<span class="code">*" (star) and "<span class="code">#" (hash) aren't used in bindings, the topic exchange will behave just like a&nbsp;<span class="code">direct&nbsp;one.</span></span></span></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><strong>About queue：</strong></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">1&nbsp;queue-name</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">The queue name MAY be empty, in which case the server MUST create a new queue with a unique generated name and return this to the client in the Declare-Ok method.</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">2&nbsp;<span class="field-name">passive</span></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">If set, the server will reply with Declare-Ok if the queue already exists with the same name, and raise an error if not.</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">3&nbsp;<span class="field-name">durable</span></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">If set when creating a new queue, the queue will be marked as durable. Durable queues remain active when a server restarts. Non-durable queues (transient queues) are purged if/when a server restarts. Note that durable queues do not necessarily hold persistent messages, although it does not make sense to send persistent messages to a transient queue.</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">The server MUST recreate the durable queue after a restart.</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">The server MUST support both durable and transient queues.</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><span class="field-name">4 exclusive</span></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">Exclusive queues may only be accessed by the current connection, and are deleted when that connection closes. Passive declaration of an exclusive queue by other connections are not allowed.</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">The server MUST support both exclusive (private) and non-exclusive (shared) queues.</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">The client MAY NOT attempt to use a queue that was declared as exclusive by another still-open connection.&nbsp;Error code:&nbsp;<a href="http://www.rabbitmq.com/amqp-0-9-1-reference.html#constant.resource-locked" rel="nofollow" style="color:rgb(0,0,0);">resource-locked</a></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><span class="field-name">5 auto-delete</span></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">If set, the queue is deleted when all consumers have finished using it. The last consumer can be cancelled either explicitly or because its channel is closed. If there was no consumer ever on the queue, it won't be deleted. Applications can explicitly delete auto-delete queues using the Delete method as normal.</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">The server MUST ignore the auto-delete field if the queue already exists.</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><strong>About exchange：</strong></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><span class="field-name">1 passive</span></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">If set, the server will reply with Declare-Ok if the exchange already exists with the same name, and raise an error if not.&nbsp;</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">2&nbsp;<span class="field-name">durable</span></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">If set when creating a new exchange, the exchange will be marked as durable. Durable exchanges remain active when a server restarts. Non-durable exchanges (transient exchanges) are purged if/when a server restarts.</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">3&nbsp;<span class="field-name">auto-delete</span></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">If set, the exchange is deleted when all queues have finished using it.&nbsp;</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">The server SHOULD allow for a reasonable delay between the point when it determines that an exchange is not being used (or no longer used), and the point when it deletes the exchange. At the least it must allow a client to create an exchange and then bind a queue to it, with a small but non-zero delay between these two actions.</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">The server MUST ignore the auto-delete field if the exchange already exists.</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">4 i<span class="field-name">nternal</span></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">If set, the exchange may not be used directly by publishers, but only when bound to other exchanges. Internal exchanges are used to construct wiring that is not visible to applications.</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">参考：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">https://www.rabbitmq.com/getstarted.html</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">http://www.rabbitmq.com/amqp-0-9-1-reference.html#queue.declare.exclusive</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">https://www.rabbitmq.com/ttl.html</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">http://backend.blog.163.com/blog/static/202294126201322215551999/</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><br></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><br></p> 
   <p><font color="#333333"><span style="font-size:15px;">&nbsp; &nbsp; 本文转自阿凡卢博客园博客，原文链接：http://www.cnblogs.com/luxiaoxun/p/3918054.html</span></font><span style="font-size:15px;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">，如需转载请自行联系原作者</span></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
