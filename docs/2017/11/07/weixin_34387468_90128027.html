<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>EntityFramework之异步、事务及性能优化（九） « NotBeCN</title>
  <meta name="description" content="             前言    本文开始前我将循序渐进先了解下实现EF中的异步，并将重点主要是放在EF中的事务以及性能优化上，希望通过此文能够帮助到你。    异步    既然是异步我们就得知道我们知道在什么情况下需要使用异步编程，当等待一个比较耗时的操作时，可以用异步来释放当前的托管线程而无需等待，从而在...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/07/weixin_34387468_90128027.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">EntityFramework之异步、事务及性能优化（九）</h1>
    <p class="post-meta">Nov 7, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <h1 style="font-size:28px;line-height:1.5;font-family:'Helvetica Neue', Arial;">前言</h1> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">本文开始前我将循序渐进先了解下实现EF中的异步，并将重点主要是放在EF中的事务以及性能优化上，希望通过此文能够帮助到你。</p> 
   <h1 style="font-size:28px;line-height:1.5;font-family:'Helvetica Neue', Arial;">异步</h1> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">既然是异步我们就得知道我们知道在什么情况下需要使用异步编程，当等待一个比较耗时的操作时，可以用异步来释放当前的托管线程而无需等待，从而在管理线程中不需要花费额外的时间，也就是不会阻塞当前线程的运行。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">在客户端如：Windows Form以及WPF应用程序中，当执行异步操作时，则当前线程能够保持用户界面持续响应。在服务器端如：ASP.NET应用程序中，执行异步操作可以用来处理多个请求，可以提高服务器的吞吐量等等。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">在大部分应用程序中，对于比较耗时的操作用异步来实现可能会有一些改善，但是若你不多加考虑，动不动就用异步反而会得到相反的效果以及对应用程序也是致命的。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">鉴于上述描述，我们接下来通过EF实现异步来加深理解。（想想还是把所用类及映射给出来，以免没看过前面的文章的同仁不知所云。）</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">Student（学生）类：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> Student
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">int</span> Id { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">string</span> Name { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">int</span> FlowerId { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> Flower Flower { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">Flower（小红花）类</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> Flower
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">int</span> Id { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">string</span> Remark { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }

        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> ICollection&lt;Student&gt; Students { <span style="color:rgb(0,0,255);line-height:1.5;">get</span>; <span style="color:rgb(0,0,255);line-height:1.5;">set</span><span style="line-height:1.5;">; }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">相关映射：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    <span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span> StudentMap : EntityTypeConfiguration&lt;Student&gt;<span style="line-height:1.5;">
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> StudentMap()
        {
            ToTable(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Student</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
            HasKey(key </span>=&gt;<span style="line-height:1.5;"> key.Id);
            HasRequired(p </span>=&gt; p.Flower).WithMany(p =&gt; p.Students).HasForeignKey(p =&gt;<span style="line-height:1.5;"> p.FlowerId);

        }

    }


    </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span> FlowerMap:EntityTypeConfiguration&lt;Flower&gt;<span style="line-height:1.5;">
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> FlowerMap()
        {
            ToTable(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">Flower</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
            HasKey(p </span>=&gt;<span style="line-height:1.5;"> p.Id);
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">接下来我们添加相关数据并实现异步：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>        <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">async</span><span style="line-height:1.5;"> Task AsycOperation()
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> ctx = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> EntityDbContext())
            {

                ctx.Set</span>&lt;Student&gt;().FirstOrDefault(d =&gt; d.Name == <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">xpy0928</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);


                Console.WriteLine(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">准备添加数据,当前线程Id为{0}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, Thread.CurrentThread.ManagedThreadId); <span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;">（3）</span>

                Thread.Sleep(</span><span style="color:rgb(128,0,128);line-height:1.5;">3000</span><span style="line-height:1.5;">);

                ctx.Set</span>&lt;Student&gt;().Add(<span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> Student()
                {
                    Flower </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> Flower() { Remark = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">so bad</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> },
                    Name </span>= <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">xpy0928</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">
                });

                </span><span style="color:rgb(0,0,255);line-height:1.5;">await</span><span style="line-height:1.5;"> ctx.<span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;">SaveChangesAsync()</span>;

                Console.WriteLine(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">数据保存完成,当前线程Id为{0}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, Thread.CurrentThread.ManagedThreadId); <span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;">（4）</span>
            }
        }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">接下来就是在控制台进行调用以及输出：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>            Console.WriteLine(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">执行异步操作之前,当前线程Id为{0}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, Thread.CurrentThread.ManagedThreadId); <span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;">（1） <br> AsycOperation();</span>
            <br>
Console.WriteLine(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">执行异步操作后,当前线程Id为{0}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, Thread.CurrentThread.ManagedThreadId); <span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;">（2）</span>
            <br>
Console.ReadKey();</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">这段代码不难理解，基于我们对于异步的理解，输出顺序应该是（1）（3）（2）（4），结果如我们预期一样，如下：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201509/589642-20150907141715622-398595810.gif" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">我们知道await关键字的作用是：<span style="color:rgb(255,0,0);font-size:16px;">在线程池中新起一个将被执行的工作线程Task，当要执行IO操作时则会将工作线程归还给线程池，因此await所在的方法不会被阻塞。当此任务完成后将会执行该关键字之后代码</span></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><span>所以当执行到await关键字时，会在状态机（<a href="http://www.cnblogs.com/ioexception/p/Async_Await_Asynchronous_Programming.html" rel="nofollow" style="text-decoration:none;color:rgb(45,161,45);">async/await通过状态机实现原理</a>）中执行异步方法并等待执行结果，当异步执行完成后，此时再在线程池中新开一个Id为11的工作线程，继续await之后的代码执行。此时要执行添加数据，所以此时将线程归还给主线程，不阻塞主线程的运行所以就出现先执行（2）而不是先执行（4）。</span></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">接下来看一个稍微在上述基础上经过改造的方法。如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>        <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">async</span><span style="line-height:1.5;"> Task AsycOperation()
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> ctx = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> EntityDbContext())
            {

                ctx.Set</span>&lt;Student&gt;().FirstOrDefault(d =&gt; d.Name == <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">xpy0928</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);

                Console.WriteLine(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">准备添加数据,当前线程Id为{0}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, Thread.CurrentThread.ManagedThreadId);

                Thread.Sleep(</span><span style="color:rgb(128,0,128);line-height:1.5;">3000</span><span style="line-height:1.5;">);

                ctx.Set</span>&lt;Student&gt;().Add(<span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> Student()
                {
                    Flower </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> Flower() { Remark = <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">so bad</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;"> },
                    Name </span>= <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">xpy09284</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">
                });

                </span><span style="color:rgb(0,0,255);line-height:1.5;">await</span><span style="line-height:1.5;"> ctx.SaveChangesAsync();

                Console.WriteLine(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">数据保存完成,当前线程Id为{0}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, Thread.CurrentThread.ManagedThreadId);

                Console.WriteLine(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">开始执行查询,当前线程Id为{0}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, Thread.CurrentThread.ManagedThreadId);

                </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> students = <span style="color:rgb(0,0,255);line-height:1.5;">await</span> (<span style="color:rgb(0,0,255);line-height:1.5;">from</span> stu <span style="color:rgb(0,0,255);line-height:1.5;">in</span> ctx.Set&lt;Student&gt;() <span style="color:rgb(0,0,255);line-height:1.5;">select</span><span style="line-height:1.5;"> stu).ToListAsync();

                Console.WriteLine(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">遍历获得所有学生的姓名,当前线程Id为{0}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, Thread.CurrentThread.ManagedThreadId);

                </span><span style="color:rgb(0,0,255);line-height:1.5;">foreach</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> stu <span style="color:rgb(0,0,255);line-height:1.5;">in</span><span style="line-height:1.5;"> students)
                {
                    Console.WriteLine(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">学生姓名为：{0}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, stu.Name);
                }
            }
        }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">接下来在控制台中进行如下调用：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>            Console.WriteLine(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">执行异步操作之前,当前线程Id为{0}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, Thread.CurrentThread.ManagedThreadId);
            
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> task =<span style="line-height:1.5;"> AsycOperation(); ;
            
            <span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;">task.Wait();</span>
            
            Console.WriteLine(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">执行异步操作后,当前线程Id为{0}</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">, Thread.CurrentThread.ManagedThreadId);
            
            Console.ReadKey();</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">接下我们进行打印如下：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201509/589642-20150907145642012-199286219.gif" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">上述至于为什么不是执行【执行异步操作后，当前线程Id为10】然后执行【遍历获得所有学生的姓名，当前线程Id为12】，想必大家能清楚的明白，是执行上述&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">task.Wait()</span>&nbsp;的缘故，必须进行等待当前任务执行完再执行主线程后面的输出。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">对于处理EF中的异步没有太多去探索的东西，基本就是调用EF中对应的异步方法即可，重点是EF中的事务，请继续往下看：</p> 
   <h1 style="font-size:28px;line-height:1.5;font-family:'Helvetica Neue', Arial;"><span style="color:rgb(255,0,0);">*事务&nbsp;</span></h1> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">默认情况下</h2> 
   <ul style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">
    <li style="list-style:disc inside;">可能我们未曾注意到，其实在EF的所有版本中，当我们调用SaveChanges方法来执行增、删、改时其操作内部都用一个transaction包裹着。不信，如下图，当添加数据时：</li>
   </ul>
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201509/589642-20150907152948059-1630912563.gif" alt="" style="border:0px;"></p> 
   <ul style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">
    <li style="list-style:disc inside;">对于上下文中的&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">ExecuteSqlCommand()</span>&nbsp;方法默认情况下也是用transaction包裹着命令(Command)，其有重载我们可以显示指定执行事务还是不确定执行事务。</li> 
    <li style="list-style:disc inside;">在此上两种情况下，事务的隔离级别是数据库提供者认为的默认设置的任何隔离级别，例如在SQL Server上默认是READ COMMITED（读提交）。</li> 
    <li style="list-style:disc inside;">EF对于任何查询都不会用transaction来进行包裹。</li> 
   </ul>
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">在EF 6.0版本以上，EF一直保持数据库连接打开，因为要启动一个transaction必须是在数据库连接打开的前提下，同时这也就意味着我们执行多个操作在一个transaction的唯一方式是要么使用&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">TransactionScope</span>&nbsp;要么使用&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">ObjectContext.Connection</span>&nbsp;属性并且启动调用Open()方法以及BeginTransaction()方法直接返回EntityConnection对象。如果你在底层数据库连接上启动了transaction，再调用API连接数据库可能会失败。</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">概念</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">在开始学习事务之前我们先了解两个概念：</p> 
   <ul style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">
    <li style="list-style:disc inside;"> <span style="font-size:16px;color:rgb(255,0,0);">Database.BeginTransaction()</span>：它是在一个已存在的DbContext上下文中对于我们去启动和完成transactions的一种简单方式，它允许多个操作组合存在在相同的transaction中，所以要么提交要么全部作为一体回滚，同时它也允许我们更加容易的去显示指定transaction的隔离级别。</li> 
    <li style="list-style:disc inside;"> <span style="font-size:16px;color:rgb(255,0,0);">Dtabase.UseTransaction()</span>：它允许DbContext上下文使用一个在EF实体框架之外启动的transaction。</li> 
   </ul>
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">在相同上下文中组合几个操作到一个transaction&nbsp;</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">Database.BeginTransaction有两种重载——一种是显示指定隔离级别，一种是无参数使用来自于底层数据库提供的默认隔离级别，两种都是返回一个DbContextTransaction对象，该对象提供了事务提交（Commint）以及回滚（RollBack）方法直接表现在底层数据库上的事务提交以及事务回滚上。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">DbContextTransaction一旦被提交或者回滚就会被Disposed，所以我们使用它的简单的方式就是使用using(){}语法，当using构造块完成时会自动调用Dispose()方法。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">根据上述我们现在通过两个步骤来对学生进行操作，并在同一transaction上提交。如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">            using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> ctx = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> EntityDbContext())
            {

                </span><span style="color:rgb(0,0,255);line-height:1.5;">using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> ctxTransaction =<span style="line-height:1.5;"><span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;"> ctx.Database.BeginTransaction</span>())
                {

                    </span><span style="color:rgb(0,0,255);line-height:1.5;">try</span><span style="line-height:1.5;">
                    {
                        ctx.Database.Log </span>=<span style="line-height:1.5;"> Console.WriteLine;

                        ctx.Database.ExecuteSqlCommand(</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">update student set name='xpy0929'</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);

                        </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> list = ctx.Set&lt;Student&gt;().Where(p =&gt; p.Name == <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">xpy0929</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">).ToList();

                        list.ForEach(d </span>=&gt;<span style="line-height:1.5;">
                        {

                            d.Name </span>= <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">xpy0928</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">;

                        });

                        ctx.SaveChanges();

                       <span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;"> ctxTransaction.Commit();</span>
                    }
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">catch</span><span style="line-height:1.5;"> (Exception)
                    {
                        <span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;">ctxTransaction.Rollback();</span>
                    }

                }
            }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">我们通过控制台输出SQL日志查看提交事务成功如下：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201509/589642-20150907174508903-211392149.gif" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">【注意】 要开始一个事务必须保持底层数据库连接是打开的，如果数据库不总是打开的我们可以通过&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">BeginTransaction()</span>&nbsp;方法将打开数据库连接，如果&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">DbContextTransaction</span>&nbsp;打开了数据库，当调用Disposed()方法时将会关闭数据库连接。</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">注意事项</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">当用EF上下文中的&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">Database.ExecuteSqlCommand</span>&nbsp;方法来对数据库进行如下操作时</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">            using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> ctx = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> EntityDbContext())
            {
             
                </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> sqlCommand = String.Format(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ALTER DATABASE {0} SET SINGLE_USER WITH ROLLBACK IMMEDIATE</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>, <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">DBConnectionString</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
                ctx.Database.ExecuteSqlCommand(sqlCommand);
               
            }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">此时将会报错如下：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201509/589642-20150908214942762-1200378232.gif" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">上述已经讲过此方法会被Transaction包裹着，所以导致出错，但是此方法有重载，我们进行如下设置即可</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre> ctx.Database.ExecuteSqlCommand(<span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;">TransactionalBehavior.DoNotEnsureTransaction</span>,sqlCommand);</pre>
   </div> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">将一个已存在的事务添加到上下文中</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">有时候我们可能需要事务的作用域更加广一点，当然是在同一数据库上但是是在EF之外完全进行操作。基于此，此时我们必须手动打开底层的数据库连接来启动事务，同时通知EF使用我们手动打开的连接来使现有的事务连接在此连接上，这样就达到了在EF之外使用事务的目的。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">为了实现上述在EF之外使用事务我们必须在DbContext上下文中的派生类的构造器中关闭自身的连接而使用我们传入的连接。</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">第一步</h3> 
   <h4 style="font-size:14px;font-family:'Helvetica Neue', Arial;">上下文中关闭EF连接使用底层连接。</h4> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">代码如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>  <span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> EntityDbContext(DbConnection con)
            : </span><span style="color:rgb(0,0,255);line-height:1.5;">base</span>(con, contextOwnsConnection: <span style="color:rgb(0,0,255);line-height:1.5;">false</span><span style="line-height:1.5;">)
        { }</span></pre>
   </div> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">第二步</h3> 
   <h4 style="font-size:14px;font-family:'Helvetica Neue', Arial;">启动Transcation(如果我们想避免默认设置我们可以手动设置隔离级别)，通知EF一个已存在的Transaction已经在我们手动的设置的底层连接上启动。</h4> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>            <span style="color:rgb(0,0,255);line-height:1.5;">using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> con = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> SqlConnection(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ConnectionString</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">))
            {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> SqlTransaction =<span style="line-height:1.5;"> con.BeginTransaction())
                {
                      </span><span style="color:rgb(0,0,255);line-height:1.5;">using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> ctx = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> EntityDbContext(con))
                      {<br>
}
                }
            }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">第三步</h3> 
   <h4 style="font-size:14px;font-family:'Helvetica Neue', Arial;">因为此时是在EF实体框架外部执行事务，此时则需要用到上述所讲的&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">Database.UseTransaction</span>&nbsp;将我们的事务对象传递进去。</h4> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre> ctx.Database.UseTransaction(SqlTransaction);</pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">此时我们将能通过SqlConnection实例来自由执行数据库操作或者说是在上下文中，执行的所有操作都是在一个Transaction上，而我们只负责提交和回滚事务并调用Dispose方法以及关闭数据库连接即可。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">至此给出完整代码如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>            <span style="color:rgb(0,0,255);line-height:1.5;">using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> con = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> <span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;">SqlConnection</span>(<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">ConnectionString</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">))
            {<br>
con.Open();
                </span><span style="color:rgb(0,0,255);line-height:1.5;">using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> SqlTransaction =<span style="line-height:1.5;"><span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;"> con.BeginTransaction</span>())
                {
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">try</span><span style="line-height:1.5;">
                    {
                        </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> sqlCommand = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> SqlCommand();
                        sqlCommand.Connection </span>=<span style="line-height:1.5;"> con;
                        sqlCommand.Transaction </span>=<span style="line-height:1.5;"> SqlTransaction;
                        sqlCommand.CommandText </span>=
                            <span style="color:rgb(128,0,0);line-height:1.5;">@"</span><span style="color:rgb(128,0,0);line-height:1.5;">update student set name = 'xpy0929'</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">;
                        sqlCommand.ExecuteNonQuery();

                        </span><span style="color:rgb(0,0,255);line-height:1.5;">using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> ctx = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> EntityDbContext(<span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;">con</span>))
                        {

                            <span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;">ctx.Database.UseTransaction(SqlTransaction); </span></span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> list = ctx.Set&lt;Student&gt;().Where(d =&gt; d.Name == <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">xpy0929</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">).ToList();

                            list.ForEach(d </span>=&gt;<span style="line-height:1.5;"> {
                                d.Name </span>= <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">xpy0928</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">;
                            });

                            ctx.SaveChanges();

                        }

                        <span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;">SqlTransaction.Commit();</span>
                    }
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">catch</span><span style="line-height:1.5;"> (Exception)
                    {
                       <span style="font-size:14px;color:rgb(255,0,0);line-height:1.5;"> SqlTransaction.Rollback();</span>

                    }
                }

            }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">【注意】你可以设置&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">&nbsp;ctx.Database.UseTransaction(<span style="color:rgb(0,0,255);line-height:1.5;">null</span>);</span>&nbsp;为空来清除当前EF中的事务，如果你这样做了，那么此时EF既不会提交事务也不会回滚现有的事务，除非你清楚这是你想做的&nbsp;，否则请谨慎使用。</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">TransactionScope Transactions</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">在msdn上对&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">TransactionScope</span>&nbsp;类定义为是：类中的代码称为事务性代码。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">我们将上述代码包含在如下代码中，则此作用域里的代码为事务性代码</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">            using</span> ( <span style="color:rgb(0,0,255);line-height:1.5;">var</span> scope = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> TransactionScope(TransactionScopeOption.Required))
            {
                
            }</span></pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">【注意】此时SqlConnection和EF实体框架都使用&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">TransactionScope&nbsp;</span>&nbsp;，因此此时将被会一起提交。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">&nbsp;在.NET 4.5.1中&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">TransactionScope&nbsp;</span>&nbsp;能够和异步方法一起使用通过<a href="https://msdn.microsoft.com/en-us/library/system.transactions.transactionscopeasyncflowoption.aspx" rel="nofollow" style="text-decoration:none;color:rgb(45,161,45);">TransactionScopeAsyncFlowOption</a>的枚举来启动。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">通过如下实现：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> scope = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> TransactionScope(TransactionScopeAsyncFlowOption.Enabled)) 
{}</span></pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">接着就是将数据库连接的打开方法（Open）、查询方法（ExecuteNonQuery）、以及上下文中保存的方法（SaveChanges）都换为对应的异步方法（OpenAsync）、（ExecuteNonQueryAsync）以及（SaveChangesAsync）即可</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">使用TransactionScope异步有几点限制，例如上述的必须是在.NET 4.5.1中才有异步方法等等。&nbsp;</p> 
   <h1 style="font-size:28px;line-height:1.5;font-family:'Helvetica Neue', Arial;">在EF应用程序中避免死锁建议</h1> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">事务隔离级别</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">我们知道在查询上是没有transaction的，EF只有在SaveChanges上的本地transaction（除非外界系统的transaction即System.Transaction被检测到，在此种情况下才会被用到）。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">在SQL Server上默认的隔离级别是READ COMMITTED，并且READ COMMITED默认情况下是共享锁的，尽管当每条语句完成时锁会释放但是这种情况下还是极易导致锁争用。 那是可能的我们配置数据库通过设置&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">READ_COMMITTED_SNAPSHOT&nbsp;</span>&nbsp;的选项为ON来避免完全读取甚至是READ COMMITTED隔离级别上。SQL Servert采取了Row Version以及Snapshot（<a href="https://msdn.microsoft.com/zh-CN/LIBRARY/tcbchxcb(v=VS.85).aspx" rel="nofollow" style="text-decoration:none;color:rgb(45,161,45);">Snapshot和Row Version</a>以及<a href="https://msdn.microsoft.com/en-us/library/ms173763.aspx" rel="nofollow" style="text-decoration:none;color:rgb(45,161,45);">Set Transaction Isolation Level</a>）而不是共享锁的方式来提供了同样的保障为READ COMMITED隔离。</p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">Snapshot Isolation Level（从字面意思将其理解为快照式隔离级别）</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">由于本人对隔离级别中最熟悉的是&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">READ_UNCOMMITED</span>&nbsp;、&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">READ_COMMITED</span>&nbsp;、&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">REPEATABLE_READ</span>&nbsp;以及&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">SERIALIZABLE</span>&nbsp;，而对此Snapshot隔离级别不太熟悉，就详细叙述下，以备忘。</p> 
   <ul style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">
    <li style="list-style:disc inside;"> <h4 style="color:rgb(0,0,0);font-size:14px;">在SQL Server 2005版本中引入此隔离级别，此隔离级别依赖于增强行版本（Row Version）旨在通过避免读写阻塞来提高性能，通过非阻塞行为来显著降低复杂事务死锁的可能性。</h4> </li> 
    <li style="list-style:disc inside;"> <h4 style="color:rgb(0,0,0);font-size:14px;">启动该隔离级别将激活临时数据库上的临时表存储Row Version（行版本）的机制，此时临时表将更新每个行版本，用事务序列号来标识每个事务，同时每个行版本的序列号也将被记录下来，此隔离级别的事务适用于在此事务序列号之前有一个序列号的最新行版本，在事务已经开始后创建的新的行版本会被事务所忽略。</h4> </li> 
    <li style="list-style:disc inside;"> <h4 style="color:rgb(0,0,0);font-size:14px;">该隔离级别使用乐观并发模式，如果一个Snapshot事务试图提交已经发生了修改的数据，因为此时事务已经启动，所以事务将会回滚并抛出一个错误。</h4> </li> 
    <li style="list-style:disc inside;"> <h4 style="color:rgb(0,0,0);font-size:14px;">在事务开始时，在事务中指定要读取的数据与已存在的数据是事务一致性版本，该事务只知道在该事务启动之前被提交的修改的数据而通过其他事务执行当前事务语句对数据做出的更改在当前事务启动之后是不可见的。这个作用就是好像事务中的语句获得了已经提交数据的快照，因为它存在于事务的开始。</h4> </li> 
    <li style="list-style:disc inside;"> <h4 style="color:rgb(0,0,0);font-size:14px;">当一个数据库正在恢复时，当Snapshot事务读取数据时不会要求锁定。Snapshot事务不会阻塞其他事务对其执行写的操作，同时事务也不会阻塞Snapshot对其指定读的操作。</h4> </li> 
    <li style="list-style:disc inside;"> <h4 style="color:rgb(0,0,0);font-size:14px;">在启动一个事务为Snapshot隔离级别时之前必须将ALLOW_SNAPSHOT_ISOLATION设置为ON，当使用Snapshot隔离级别在不同数据库间访问数据必须保证每个数据库上的ALLOW_SNAPSHOT_ISOLATION为ON。</h4> </li> 
   </ul>
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">考虑到SQL Server的默认值以及EF的相关行为，大部分情况下每个EF执行查询是在它自己被自动调用以及SaveChanges运行在用READ COMMITED隔离的本地事务里。也就是说EF被设计的能很好和System.Transactions.Transaction一起工作。对于&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">System.Transactions.Transaction</span>&nbsp;的默认隔离级别是&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">SERIALIZABLE</span>&nbsp;，我们知道此隔离级别是最严格的隔离级别能同时解决脏读、不可重复读以及幻影读取的问题，当然这也就意味着默认情况下使用&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">TransactionScope&nbsp;</span>&nbsp;或者&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">CommitableTransaction</span>&nbsp;的话，我们应该选择最为严格的隔离级别，同时里面也要添加许多锁。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">但是幸运的是，这种默认的情况我们能轻而易举的进行覆盖， 例如，为了配置Snapshot，我们可以通过使用TransactionSope来实现。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>     <span style="color:rgb(0,0,255);line-height:1.5;">using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> scope = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> TransactionScope(TransactionScopeOption.Required, <span style="color:rgb(0,0,255);line-height:1.5;">new</span> TransactionOptions { IsolationLevel =<span style="line-height:1.5;"> IsolationLevel.Snapshot }))
     {

        </span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">Do  Something</span>
<span style="line-height:1.5;">        scope.Complete();
     }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">上述建议通过封装此构造的方法来简化使用。&nbsp;</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">建议&nbsp;</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">鉴于上述对快照式隔离级别（Snapshot Isolation Level）以及EF相关描述，我们可以将避免EF应用程序死锁归结于以下：</p> 
   <ul style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">
    <li style="list-style:disc inside;"> <h4 style="color:rgb(0,0,0);font-size:14px;">使用快照式事务隔离级别（Snapshot Transaction Isolation Level）或者快照式 Read Committed（Snapshot Read Committed）同时也推荐利用TransactionScope来使用事务。通过使用如下代码:</h4> </li>
   </ul>
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>     <span style="color:rgb(0,0,255);line-height:1.5;">using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> scope = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> TransactionScope(TransactionScopeOption.Required, <span style="color:rgb(0,0,255);line-height:1.5;">new</span> TransactionOptions { IsolationLevel =<span style="line-height:1.5;"> IsolationLevel.Snapshot }))
     {

        </span><span style="color:rgb(0,128,0);line-height:1.5;">//You need to do something</span>
<span style="line-height:1.5;">        scope.Complete();
     }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <ul style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">
    <li style="list-style:disc inside;"> <h4 style="color:rgb(0,0,0);font-size:14px;">当然EF版本更高更好。</h4> </li> 
    <li style="list-style:disc inside;"> <h4 style="color:rgb(0,0,0);font-size:14px;">当在Transaction里查询相同的表时，尽量使用相同的顺序。</h4> </li> 
   </ul>
   <h1 style="font-size:28px;line-height:1.5;font-family:'Helvetica Neue', Arial;">&nbsp;性能优化</h1> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">貌似写EF系列以来我们从未谈论过一个东西，而这个东西却一直是我们关注的，那就是缓存，难道在EF中没有缓存吗，答案是否定的，至少个人觉得在此篇文章谈论缓存还是比较合适宜，因为与事务有关，再加上这本来就是一个需要深入去学习的地方，所以不能妄自菲薄，若有不妥之处，请指正。</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">我们谈论的是二级缓存，通过二级缓存来提高查询性能，所以一语道破天机二级缓存就是一个查询缓存，通过SQL命令将查询的结果存储在缓存中，以至于当我们下次执行相同的命令时会去缓存中去拿数据而不是一遍又一遍的执行底层的查询，这将对我们的应用程序有一个性能上的提升同时也减少了对数据库的负担，当然这也就造成了对内存的占用。</p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">EF 6.1二级缓存</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">接下来我们进入实战，我们依然借用【异步】中的两个类来进行查询。通过如下代码我们来进行查询：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>            <span style="color:rgb(0,0,255);line-height:1.5;">using</span> (<span style="color:rgb(0,0,255);line-height:1.5;">var</span> ctx = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> EntityDbContext())
            {
                ctx.Set</span>&lt;Student&gt;().FirstOrDefault(d =&gt; d.Name == <span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">xpy0928</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="line-height:1.5;">);
            }</span></pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">我们同时刷新一次，此时我们通过Sql &nbsp;Profiler进行监控，毫无疑问此时会执行两次查询对于相同的查询</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201509/589642-20150908202435309-1169591722.gif" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">接下来我们通过EF来实现二级缓存试试看，首先我们添加的在EF 6.1中没有二级缓存，此时我们需要通过NuGet手动安装最新版本的二级缓存如下：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201509/589642-20150908204522840-52268230.gif" alt="" style="border:0px;"></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">EF对于相关的配置是在&nbsp;<span class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(255,0,0);font-family:'Courier New';font-size:16px;">DbConfiguraion</span>&nbsp;<span style="color:rgb(0,0,0);">中，所以肯定是在此配置中的构造函数中进行。通过以下步骤进行：</span></p> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">第一步</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><span style="color:rgb(0,0,0);">首先要获得二级缓存实例，如下：</span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre> <span style="color:rgb(0,0,255);line-height:1.5;">var</span> transactionHandler = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> CacheTransactionHandler(<span style="color:rgb(0,0,255);line-height:1.5;">new</span> InMemoryCache());</pre>
   </div> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">第二步</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><span>因为是对于查询结果的缓存所以我们将其注册到监听，如下：</span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre> AddInterceptor(transactionHandler);</pre>
   </div> 
   <h3 style="color:rgb(111,168,51);font-size:16px;line-height:1.5;border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Helvetica Neue', Arial;">第三步</h3> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><span>因为其缓存服务肯定是在在EF初始化过程中进行加载，也就是将缓存服务添加到DbConfiguration中的Loaded事件中即可。如下：</span></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>            Loaded +=<span style="line-height:1.5;">
             (sender, args) </span>=&gt; args.ReplaceService&lt;DbProviderServices&gt;<span style="line-height:1.5;">(
             (s, _) </span>=&gt; <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> CachingProviderServices(s, transactionHandler,
              cachingPolicy));</span></pre>
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">以上是我们整个实现二级缓存的大概思路，完整代码如下【参考官方<a href="https://efcache.codeplex.com/" rel="nofollow" style="text-decoration:none;color:rgb(45,161,45);">Second Level Cace for EntityFramework</a>】</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">    public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> EFConfiguration : DbConfiguration
    {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> EFConfiguration()
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> transactionHandler = <span style="color:rgb(0,0,255);line-height:1.5;">new</span> CacheTransactionHandler(<span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> InMemoryCache());

           <span style="font-size:16px;color:rgb(255,0,0);line-height:1.5;"> AddInterceptor</span>(transactionHandler);

            </span><span style="color:rgb(0,0,255);line-height:1.5;">var</span> cachingPolicy = <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> CachingPolicy();

            Loaded </span>+=<span style="line-height:1.5;">
             (sender, args) </span>=&gt; args.ReplaceService&lt;DbProviderServices&gt;<span style="line-height:1.5;">(
             (s, _) </span>=&gt; <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> CachingProviderServices(s, transactionHandler,
              cachingPolicy));

        }

    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="color:rgb(45,161,45);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">此时我们再来执行上述查询并多刷新几次，此时将执行一次查询，说明是在缓存中获取数据，所以二级缓存设置成功，如下：</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><img src="https://images2015.cnblogs.com/blog/589642/201509/589642-20150908212029544-2062769160.gif" alt="" style="border:0px;"></p> 
   <h2 style="color:rgb(255,255,255);line-height:1.5;font-size:21px;font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">感谢</h2> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;">关于EF 6.0或者6.1大概就已介绍完，当然里面可能还有许多更深层次的知识未涉及到，但是本人也就只有这点能力了，做不到面面俱到，望谅解！非常感谢一直以来对我EF系列支持的你们，正是有你们的支持我才会很仔细的一字一句的去斟酌，以免误导了别人，所以才会更加的谨慎的去叙述，同时也感谢对这一系列中有不妥之处或是错处作出指正的园友们，正是有了你们的支持，使我才能更好的学习且收获更多！</p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p style="color:rgb(17,17,17);font-family:'Helvetica Neue', Arial;font-size:13px;line-height:23.4px;"><br></p> 
   <p><font color="#111111"><span style="font-size:13px;line-height:23.4px;">本文转自Jeffcky博客园博客，原文链接：http://www.cnblogs.com/CreateMyself/p/4787856.html,如需转载请自行联系原作者</span></font></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
