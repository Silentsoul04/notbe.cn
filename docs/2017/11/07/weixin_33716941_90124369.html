<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Nova 操作汇总（限 libvirt 虚机） [Nova Operations Summary] « NotBeCN</title>
  <meta name="description" content="             本文梳理一下 Nova 主要操作的流程。    &nbsp;0. Nova REST-CLI-Horizon 操作对照表    Nova 基本的 CRUD 操作和&nbsp;extensions：                   #       类别       Nova V2 RE...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/07/weixin_33716941_90124369.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">Nova 操作汇总（限 libvirt 虚机） [Nova Operations Summary]</h1>
    <p class="post-meta">Nov 7, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">本文梳理一下 Nova 主要操作的流程。</p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">&nbsp;0. Nova REST-CLI-Horizon 操作对照表</h2> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">Nova 基本的 CRUD 操作和&nbsp;extensions：</p> 
   <table border="0" style="border:1px solid #C0C0C0;border-collapse:collapse;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <tbody>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><strong>#</strong></td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><strong>类别</strong></td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><strong>Nova V2 REST API Action</strong></td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><strong>Nova CLI</strong></td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><strong>Horizon</strong></td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"><strong>解释</strong></td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">虚机操作</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">POST</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">boot</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">Launch Instance</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p style="line-height:1.5;">启动一个新的虚机</p> <p style="line-height:1.5;">&nbsp;<a href="http://www.cnblogs.com/sammyliu/p/4558638.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://www.cnblogs.com/sammyliu/p/4558638.html</a></p> </td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">DELETE</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">delete</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">Terminate Instance</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p style="line-height:1.5;">关闭和删除一个虚机</p> 
       <ol>
        <li style="list-style-type:decimal;">call dom.destroy</li> 
        <li style="list-style-type:decimal;">call dom.undefineFlags</li> 
       </ol></td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">confirmResize</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;resize-confirm</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;N/A</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p style="line-height:1.5;">确认 resize 操作&nbsp;</p> <p style="line-height:1.5;"><a href="http://www.cnblogs.com/sammyliu/p/4572287.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://www.cnblogs.com/sammyliu/p/4572287.html</a></p> </td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">revertResize</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;resize-revert</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">N/A&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p style="line-height:1.5;">取消 resize 操作</p> <p style="line-height:1.5;"><a href="http://www.cnblogs.com/sammyliu/p/4572287.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://www.cnblogs.com/sammyliu/p/4572287.html</a></p> </td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">reboot</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;reboot [--hard]</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p style="line-height:1.5;">Soft Reboot Instance</p> <p style="line-height:1.5;">Hard Reboot Instance&nbsp;</p> </td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p style="line-height:1.5;">重启虚机，具体分析见本文 1. 章节</p> </td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">changePassword</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;root-password</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;libvirt driver 没有实现</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">resize</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;resize</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;Resize Instance</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">迁移虚机或者改变虚机的flavor：&nbsp;<a href="http://www.cnblogs.com/sammyliu/p/4572287.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://www.cnblogs.com/sammyliu/p/4572287.html</a> </td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">rebuild</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;rebuild</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;Rebuild&nbsp;Instance</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;先调用&nbsp;<span style="line-height:1.5;font-family:'Courier New';"><span style="line-height:1.5;">driver.destroy （destroy domain，detach volume connections，plug VIF）， 然后再调用&nbsp;</span></span><span style="line-height:1.5;font-family:'Courier New';">driver.spawn</span> </td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">createImage</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;image-create</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;N/A&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;快照。<a href="http://www.cnblogs.com/sammyliu/p/4468757.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://www.cnblogs.com/sammyliu/p/4468757.html</a> </td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">os-start</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;start</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;Launch&nbsp;Instance</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;= hard reboot，见下面 1. 章节</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">os-stop</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;stop</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;Shut Off&nbsp;Instance</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;call dom.destroy</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">admin action</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">pause</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;pause</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;Pause&nbsp;Instance</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;call dom.suspend</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">unpause</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;unpause</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;Resume&nbsp;Instance</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;call dom.resume</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">suspend</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;suspend</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;N/A</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> 
       <ol>
        <li style="list-style-type:decimal;">&nbsp;_detach_pci_devices</li> 
        <li style="list-style-type:decimal;">_detach_sriov_ports</li> 
        <li style="list-style-type:decimal;">dom.managedSave(0)</li> 
       </ol></td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">resume</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;resume</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">N/A&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> 
       <ol>
        <li style="list-style-type:decimal;">&nbsp;get domain xml</li> 
        <li style="list-style-type:decimal;">_create_domain_and_network</li> 
        <li style="list-style-type:decimal;">attach pci devices</li> 
        <li style="list-style-type:decimal;">attach sriov port</li> 
       </ol></td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">migrate</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;migrate</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;N/A</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;<a href="http://www.cnblogs.com/sammyliu/p/4572287.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://www.cnblogs.com/sammyliu/p/4572287.html</a> </td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">resetNetwork</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">N/A&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;libvirt 没有实现</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">injectNetworkInfo</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">N/A&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;Set up basic filtering (MAC, IP, and ARP spoofing protection)，调用&nbsp;<span style="line-height:1.5;font-family:'Courier New';">_conn.nwfilterDefineXML(xml)</span> </td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">lock</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;lock</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;N/A</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;直接在数据库中 instance 上面设置 lock = true</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">unlock</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;unlock</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;N/A</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;直接在数据库中 instance 上面设置 lock = false</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">createBackup</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;backup</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">N/A&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p style="line-height:1.5;">&nbsp;同&nbsp;createImage，可以指定类型（daily 或者 weekly），和保存的 image 的最大数目，老的 image 会被删除</p> <p style="line-height:1.5;">{"backup_type": "daily", "rotation": "2", "name": "bk"}</p> </td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">os-migrateLive</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;live-migration</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">N/A&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;<a href="http://www.cnblogs.com/sammyliu/p/4572287.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">http://www.cnblogs.com/sammyliu/p/4572287.html</a> </td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">os-resetState</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;reset-state</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;N/A</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;传入 state 参数，直接修改数据库中 instance 的状态</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">bare metal</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">add_interface</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;baremetal-interface-add</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">TBD</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">remove_interface</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;baremetal-interface-remove</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">TBD&nbsp;</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">cloudpipe</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">update</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;cloudpipe-configure</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">TBD</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">console</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">os-getVNCConsole</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;get-vnc-console</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;Console</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p style="line-height:1.5;">见本文第四章节</p> </td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">os-getSPICEConsole</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;get-spice-console</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">TBD</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">os-getRDPConsole</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;get-rdp-console</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">TBD&nbsp;</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">os-getSerialConsole</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">TBD&nbsp;</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">os-getConsoleOutput</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">console-log</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;View Log</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;读取 虚机的 console.log 文件并返回其内容；如果没有这文件的话，则使用 “pty”，将其内容写入到 consolue文件并返回其内容。</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">delete</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">restore</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;restore</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;Terminate Instance</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;Restore a previously deleted (but not reclaimed) instance。直接修改数据库。</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">forceDelete</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;force-delete</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;N/A</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p style="line-height:1.5;">&nbsp;有 snapshot，则全部删除；然后从 DB 中删除 instance.</p> </td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">evacuate</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">evacuate</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;evacuate</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;从 DB 中读取 instance 数据，在一个新的主机上 rebuild。</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">flavor access</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">addTenantAccess</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;flavor-access-add</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;Flavor - Modify Access</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;修改 DB 中 flavor 表</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">removeTenantAccess</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;flavor-access-remove</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;Flavor -&nbsp;Modify Access</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;修改 DB 中 flavor 表</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">flavor manage</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">delete</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;flavor-delete</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;Flavor -&nbsp;Delete Flavor</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">直接 DB 操作</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">create</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;flavor-create</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;Flavor -&nbsp;Create&nbsp;Flavor</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;直接 DB 操作</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">floating ip</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">addFloatingIp</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;floating-ip-create</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;Associate Floating IP</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;调用&nbsp;<span style="line-height:1.5;font-family:'Courier New';">network_api.associate_floating_ip</span> </td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">removeFloatingIp</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;floating-ip-delete</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;Disassociate Floating IP</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;调用&nbsp;<span style="line-height:1.5;font-family:'Courier New';">network_api.disassociate_floating_ip</span> </td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">NIC</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">addFixedIp</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;fixed-ip-reserve</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p style="line-height:1.5;">&nbsp;参数 "<span style="line-height:1.5;font-family:'Courier New';"><span style="line-height:1.5;">networkId"。</span></span></p> 
       <ol>
        <li style="list-style-type:decimal;"> <span style="line-height:1.5;font-family:'Courier New';"><span style="line-height:1.5;">call&nbsp;</span></span><span style="line-height:1.5;font-family:'Courier New';"><span style="line-height:1.5;">network_api.add_fixed_ip_to_instance</span></span> </li> 
        <li style="list-style-type:decimal;"><span style="line-height:1.5;font-family:'Courier New';">call firewall_driver.setup_basic_filtering</span></li> 
       </ol></td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">removeFixedIp</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;fixed-ip-unreserve</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p style="line-height:1.5;">&nbsp;参数 "address"。</p> 
       <ol>
        <li style="list-style-type:decimal;">call&nbsp;network_api.remove_fixed_ip_from_instance</li> 
        <li style="list-style-type:decimal;">call&nbsp;firewall_driver.setup_basic_filtering(instance, nw_info)&nbsp;</li> 
       </ol></td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">network associate</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">disassociate_host</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;Associate or disassociate host or project to network。 call network_api.associate</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">disassociate_project</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;network-disassociate</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;call&nbsp;network_api.associate</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">associate_host</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;network-associate-host</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;call&nbsp;<span style="line-height:1.5;font-family:'Courier New';">network_api.associate</span> </td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">os network</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">disassociate</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;call&nbsp;<span style="line-height:1.5;font-family:'Courier New';">network_api.associate</span> </td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">rescue</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">rescue</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;rescue</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;见本文第二章节</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">unrescue</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;unrescue</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;见本文第二章节</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">security group</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">addSecurityGroup</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;add-secgroup</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;call&nbsp;<span style="line-height:1.5;font-family:'Courier New';">security_group_rpcapi.refresh_security_group_rules</span> </td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">removeSecurityGroup</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;secgroup-delete</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;call&nbsp;security_group_rpcapi.refresh_security_group_rules</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">shelve</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">shelve</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;shelve</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;见本文第三章节</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">shelveOffload</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;shelve-offload</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;见本文第三章节</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">unshelve</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;unshelve</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;见本文第三章节</td> 
     </tr>
    </tbody>
   </table>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">1. Reboot （重启）</h2> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">物理机有两种重启方式：一种从操作系统中重启，一种直接先断电然后再接通电源。虚机的重启也有类似的两种方式：Soft Reboot 和 Hard Reboot。nova reboot 命令在不使用 “-hard” 情况下，默认会 Soft Reboot，如果失败则会 Hard reboot；如果使用了 “-hard”，则直接 Hard reboot。</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.1 Soft reboot</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">Soft reboot 完全依赖于虚机的操作系统和 ACPI。其过程为：</p> 
   <ol style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;">Shutdown domain （domain.shutdown）</li> 
    <li style="list-style-type:decimal;">Launch domain (domain.createWithFlags)</li> 
   </ol>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">关于 shutdown API ，它会shutdown一个虚机，但是虚机的各种附件（object）依然可以使用，只是虚机的操作系统被停止了。注意，虚机的操作系统可能会忽略该请求。这时候，shutdown 不会成功（在&nbsp;CONF.libvirt.wait_soft_reboot_seconds 指定的时间内，nova发现虚机没有被 shutdown），得转到 hard reboot 了。（Shutdown a domain, the domain object is still usable thereafter, but the domain OS is being stopped. Note that the guest OS may ignore the request.）&nbsp;</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">1.2 Hard reboot</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">Hard reboot 比 Soft reboot 复杂、耗时长。其主要过程为：</p> 
   <ol style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;">Destroy domain （virt_dom.destroy()）。Destroy 和 Shutdown 两个 API 的区别是：shutdown domain 以后，客户机的磁盘存储处于可用状态，而且该 API 在命令发给 Guest OS 后立即返回，客户程序需要不断检查其状态来判断是否shutdown 成功；而 destroy API 执行后，客户机的所有资源都会被归还给 Hypervisor （all resources used by it are given back to the hypervisor），它的过程是首先给客户机发送一个terminate 指令比如SIGTERM，如果在一定的时间内未成功则直接发送&nbsp;SIGKILL 指令将虚机杀掉。</li> 
    <li style="list-style-type:decimal;">根据 domain 的信息（instance, network_info, disk_info,image_meta, block_device_info）重新生成 domain 的配置 xml</li> 
    <li style="list-style-type:decimal;">根据 image 重新生成各镜像文件（包括 disk，disk.local 和 disk.swap）</li> 
    <li style="list-style-type:decimal;">连接各个 volume</li> 
    <li style="list-style-type:decimal;">将各个 interface 挂到 OVS 上</li> 
    <li style="list-style-type:decimal;">重新生成和应用 iptales 规则</li> 
    <li style="list-style-type:decimal;">Define domain （conn.defineXML）</li> 
    <li style="list-style-type:decimal;">Launch domain （domain.createWithFlags）</li> 
   </ol>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">可见，hard reboot 是真正的 reboot 一个虚机。来比较一下 hard reboot 前后的虚机的磁盘和xml 文件：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">#reboot 前</span><br>
root@compute2:/<span style="line-height:1.5;">var</span>/lib/nova/instances/8352e969-0a25-4abf-978f-d9d0ec4de0cd# ls -<span style="line-height:1.5;">l
total </span><span style="color:rgb(128,0,128);line-height:1.5;">2608</span>
-rw-rw---- <span style="color:rgb(128,0,128);line-height:1.5;">1</span> root         root   <span style="color:rgb(128,0,128);line-height:1.5;">20126</span> Jun <span style="color:rgb(128,0,128);line-height:1.5;">10</span> <span style="color:rgb(128,0,128);line-height:1.5;">12</span>:<span style="color:rgb(128,0,128);line-height:1.5;">38</span><span style="line-height:1.5;"> console.log
</span>-rw-r--r-- <span style="color:rgb(128,0,128);line-height:1.5;">1</span> libvirt-qemu kvm  <span style="color:rgb(128,0,128);line-height:1.5;">2162688</span> Jun <span style="color:rgb(128,0,128);line-height:1.5;">10</span> <span style="color:rgb(128,0,128);line-height:1.5;">12</span>:<span style="color:rgb(128,0,128);line-height:1.5;">40</span><span style="line-height:1.5;"> disk
</span>-rw-r--r-- <span style="color:rgb(128,0,128);line-height:1.5;">1</span> nova         nova     <span style="color:rgb(128,0,128);line-height:1.5;">246</span> Jun <span style="color:rgb(128,0,128);line-height:1.5;">10</span> <span style="color:rgb(128,0,128);line-height:1.5;">07</span>:<span style="color:rgb(128,0,128);line-height:1.5;">54</span><span style="line-height:1.5;"> disk.info
</span>-rw-r--r-- <span style="color:rgb(128,0,128);line-height:1.5;">1</span> libvirt-qemu kvm   <span style="color:rgb(128,0,128);line-height:1.5;">393216</span> Jun <span style="color:rgb(128,0,128);line-height:1.5;">10</span> <span style="color:rgb(128,0,128);line-height:1.5;">12</span>:<span style="color:rgb(128,0,128);line-height:1.5;">39</span><span style="line-height:1.5;"> disk.local
</span>-rw-r--r-- <span style="color:rgb(128,0,128);line-height:1.5;">1</span> libvirt-qemu kvm   <span style="color:rgb(128,0,128);line-height:1.5;">197120</span> Jun <span style="color:rgb(128,0,128);line-height:1.5;">10</span> <span style="color:rgb(128,0,128);line-height:1.5;">07</span>:<span style="color:rgb(128,0,128);line-height:1.5;">54</span><span style="line-height:1.5;"> disk.swap
</span>-rw-r--r-- <span style="color:rgb(128,0,128);line-height:1.5;">1</span> nova         nova    <span style="color:rgb(128,0,128);line-height:1.5;">3452</span> Jun <span style="color:rgb(128,0,128);line-height:1.5;">10</span> <span style="color:rgb(128,0,128);line-height:1.5;">12</span>:<span style="color:rgb(128,0,128);line-height:1.5;">39</span><span style="line-height:1.5;"> libvirt.xml
</span><span style="line-height:1.5;"><br><span style="color:rgb(0,0,255);line-height:1.5;">#reboot 后</span>
root@compute2:</span>/<span style="line-height:1.5;">var</span>/lib/nova/instances/8352e969-0a25-4abf-978f-d9d0ec4de0cd# ls -<span style="line-height:1.5;">l
total </span><span style="color:rgb(128,0,128);line-height:1.5;">2608</span>
-rw-rw---- <span style="color:rgb(128,0,128);line-height:1.5;">1</span> root         root   <span style="color:rgb(128,0,128);line-height:1.5;">20126</span> Jun <span style="color:rgb(128,0,128);line-height:1.5;">10</span> <span style="color:rgb(128,0,128);line-height:1.5;">12</span>:<span style="color:rgb(128,0,128);line-height:1.5;">38</span><span style="line-height:1.5;"> console.log
</span>-rw-r--r-- <span style="color:rgb(128,0,128);line-height:1.5;">1</span> libvirt-qemu kvm  <span style="color:rgb(128,0,128);line-height:1.5;">2162688</span> Jun <span style="color:rgb(128,0,128);line-height:1.5;">10</span> <span style="color:rgb(128,0,128);line-height:1.5;">12</span>:<span style="color:rgb(128,0,128);line-height:1.5;">57</span><span style="line-height:1.5;"> disk
</span>-rw-r--r-- <span style="color:rgb(128,0,128);line-height:1.5;">1</span> nova         nova     <span style="color:rgb(128,0,128);line-height:1.5;">246</span> Jun <span style="color:rgb(128,0,128);line-height:1.5;">10</span> <span style="color:rgb(128,0,128);line-height:1.5;">07</span>:<span style="color:rgb(128,0,128);line-height:1.5;">54</span><span style="line-height:1.5;"> disk.info
</span>-rw-r--r-- <span style="color:rgb(128,0,128);line-height:1.5;">1</span> libvirt-qemu kvm   <span style="color:rgb(128,0,128);line-height:1.5;">393216</span> Jun <span style="color:rgb(128,0,128);line-height:1.5;">10</span> <span style="color:rgb(128,0,128);line-height:1.5;">12</span>:<span style="color:rgb(128,0,128);line-height:1.5;">57</span><span style="line-height:1.5;"> disk.local
</span>-rw-r--r-- <span style="color:rgb(128,0,128);line-height:1.5;">1</span> libvirt-qemu kvm   <span style="color:rgb(128,0,128);line-height:1.5;">197120</span> Jun <span style="color:rgb(128,0,128);line-height:1.5;">10</span> <span style="color:rgb(128,0,128);line-height:1.5;">07</span>:<span style="color:rgb(128,0,128);line-height:1.5;">54</span><span style="line-height:1.5;"> disk.swap
</span>-rw-r--r-- <span style="color:rgb(128,0,128);line-height:1.5;">1</span> nova         nova    <span style="color:rgb(128,0,128);line-height:1.5;">3452</span> Jun <span style="color:rgb(128,0,128);line-height:1.5;">10</span> <span style="color:rgb(128,0,128);line-height:1.5;">12</span>:<span style="color:rgb(128,0,128);line-height:1.5;">57</span><span style="line-height:1.5;"> libvirt.xml
</span><span style="line-height:1.5;">
root@compute2:</span>/<span style="color:rgb(0,0,255);line-height:1.5;">var</span>/lib/nova/instances/8352e969-0a25-4abf-978f-<span style="line-height:1.5;">d9d0ec4de0cd# diff libvirt.xml libvirt.xml.ori
10c10
</span>&lt;       &lt;nova:creationTime&gt;<span style="color:rgb(128,0,128);line-height:1.5;">2015</span>-<span style="color:rgb(128,0,128);line-height:1.5;">06</span>-<span style="color:rgb(128,0,128);line-height:1.5;">10</span> <span style="color:rgb(128,0,128);line-height:1.5;">04</span>:<span style="color:rgb(128,0,128);line-height:1.5;">57</span>:<span style="color:rgb(128,0,128);line-height:1.5;">25</span>&lt;/nova:creationTime&gt; <span style="color:rgb(0,0,255);line-height:1.5;">#domain 除了创建时间不同别的都相同</span>
---
&gt;       &lt;nova:creationTime&gt;<span style="color:rgb(128,0,128);line-height:1.5;">2015</span>-<span style="color:rgb(128,0,128);line-height:1.5;">06</span>-<span style="color:rgb(128,0,128);line-height:1.5;">10</span> <span style="color:rgb(128,0,128);line-height:1.5;">04</span>:<span style="color:rgb(128,0,128);line-height:1.5;">39</span>:<span style="color:rgb(128,0,128);line-height:1.5;">14</span>&lt;/nova:creationTime&gt;<span style="line-height:1.5;">
84c84
</span>&lt;       &lt;source host=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">127.0.0.1</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> mode=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">bind</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> service=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">10002</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
---
&gt;       &lt;source host=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">127.0.0.1</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> mode=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">bind</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> service=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">10001</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">2. Rescue （拯救）和 Unrescue</h2> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">Rescue 是个很有意思的功能。它的一个使用场景是，虚机的启动盘的一个文件被误删除了导致无法再次启动了，或者 admin 的密码忘记了。Rescue 功能提供一个解决这类问题的手段。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;">执行 nova rescue 命令后的主要过程是：</span></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;">（1）保存目前domain 的 xml 配置到&nbsp;</span>unrescue.xml 文件</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）根据 image 重新生成启动盘&nbsp;disk.swap （大小不受 falvor.root_disk_size 控制，尽可能小的一个文件）</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>root@compute2:/<span style="color:rgb(0,0,255);line-height:1.5;">var</span>/lib/nova/instances/8352e969-0a25-4abf-978f-d9d0ec4de0cd# qemu-<span style="line-height:1.5;">img info disk.rescue
image: disk.rescue
file format: qcow2
</span><span style="color:rgb(0,0,255);line-height:1.5;">virtual</span> size: 39M (<span style="color:rgb(128,0,128);line-height:1.5;">41126400</span><span style="line-height:1.5;"> bytes) <span style="color:rgb(0,0,255);line-height:1.5;">#不是 falovr 里面定义的 1G 大小</span>
disk size: </span><span style="color:rgb(128,0,128);line-height:1.5;">1.6M</span><span style="line-height:1.5;">
cluster_size: </span><span style="color:rgb(128,0,128);line-height:1.5;">65536</span><span style="line-height:1.5;">
backing file: </span>/<span style="color:rgb(0,0,255);line-height:1.5;">var</span>/lib/nova/instances/_base/<span style="line-height:1.5;">fbad3d96a1727069346073e51d5bbb1824e76e34
Format specific information:
    compat: </span><span style="color:rgb(128,0,128);line-height:1.5;">1.1</span><span style="line-height:1.5;">
    lazy refcounts: </span><span style="color:rgb(0,0,255);line-height:1.5;">false</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（3）构造一个新的 domain 的 xml 配置，使用 disk.rescue 做启动盘，将原来的 disk 挂载到该 domain，其他的盘和volume不会被挂载。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>   &lt;disk type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">file</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> device=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">disk</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>&gt;
      &lt;driver name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">qemu</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">qcow2</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> cache=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">none</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;source file=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">/var/lib/nova/instances/8352e969-0a25-4abf-978f-d9d0ec4de0cd/disk.rescue</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt; <span style="color:rgb(0,0,255);line-height:1.5;">#新构造的启动盘</span>
      &lt;target bus=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">virtio</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> dev=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">vda</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
    &lt;/disk&gt;
    &lt;disk type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">file</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> device=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">disk</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>&gt;
      &lt;driver name=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">qemu</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> type=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">qcow2</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> cache=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">none</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
      &lt;source file=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">/var/lib/nova/instances/8352e969-0a25-4abf-978f-d9d0ec4de0cd/disk</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt; <span style="color:rgb(0,0,255);line-height:1.5;">#原来的启动盘</span>
      &lt;target bus=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">virtio</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span> dev=<span style="color:rgb(128,0,0);line-height:1.5;">"</span><span style="color:rgb(128,0,0);line-height:1.5;">vdb</span><span style="color:rgb(128,0,0);line-height:1.5;">"</span>/&gt;
    &lt;/disk&gt;</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（4）将原来的 domain destroy 掉 （virt_dom.destroy）</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（5）定义新的 domain （conn.defineXML(xml)）</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（6）启动新的 domain （domain.createWithFlags）</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">至此，nova rescue 的过程完成。用户可以 ssh 到新的虚机，修改 “Vdb“分区中的受损害的文件。然后执行 ”nova unrescue“命令。其主要过程是：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）读取之前保存的&nbsp;unrescue.xml 文件</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）将 rescued domain destroy 掉</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（3）定义和启动新的domain（同上面5和6）</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（4）删除&nbsp;unrescue.xml 文件</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">注意，这时候文件夹中的&nbsp;libvirt.xml 文件和新运行的 domain 的 xml 不一致，因为代码中没有将新的 domain 的xml 写到该文件。</p> 
   <h3 style="font-size:16px;color:rgb(102,102,102);background-image:none;background-repeat:no-repeat;font-family:Verdana;line-height:1.5;">3. Shelve （搁置）和 unshelve</h3> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">当一个虚机不需要使用的时候，可以将其 shelve 起来。该操作会创建该虚机的一个快照并传到 Glance 中，然后在 Hypervisor 上将该虚机删除，从而释放其资源。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">其主要过程为：</p> 
   <ol style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;">destroy 虚机 （virt_dom.destroy()）</li> 
    <li style="list-style-type:decimal;">snapshot 该 domain</li> 
    <li style="list-style-type:decimal;">如果&nbsp;CONF.shelved_offload_time == 0 的话，将domain 的各种资源（interface，volume，实例文件等），然后将其undefine （virt_dom.undefine()）</li> 
   </ol>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">其只存在于数据库和 Glance 中。运行 nova list 能看到一条记录：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>| 8352e969-0a25-4abf-978f-d9d0ec4de0cd | vm11               | SHELVED_OFFLOADED | -          | Shutdown    | demo-net2=<span style="color:rgb(128,0,128);line-height:1.5;">10.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">10.14</span>; demo-net=<span style="color:rgb(128,0,128);line-height:1.5;">10.0</span>.<span style="color:rgb(128,0,128);line-height:1.5;">0.41</span> |</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">运行 glance image-list 能看到其image：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre>| 6ed6eb92-ce42-46d1-ab46-259e3e235304 | vm11-shelved   | qcow2       | bare             | <span style="color:rgb(128,0,128);line-height:1.5;">19988480</span> | active |</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">能看到该 image 的 instance 相关的属性：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>s1@controller:~$ glance image-show 6ed6eb92-ce42-46d1-ab46-<span style="line-height:1.5;">259e3e235304
</span>+---------------------------------------+--------------------------------------+
| Property                              | Value                                |
+---------------------------------------+--------------------------------------+
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">base_image_ref</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>             | bb9318db-<span style="color:rgb(128,0,128);line-height:1.5;">5554</span>-<span style="color:rgb(128,0,128);line-height:1.5;">4857</span>-a309-268c6653b9ff |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">image_location</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>             | snapshot                             |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">image_state</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>                | available                            |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">image_type</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>                 | snapshot                             |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">instance_type_ephemeral_gb</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span> | <span style="color:rgb(128,0,128);line-height:1.5;">1</span>                                    |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">instance_type_flavorid</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>     | 129f237e-<span style="color:rgb(128,0,128);line-height:1.5;">8825</span>-49fa-b489-0e41fb06b70e |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">instance_type_id</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>           | <span style="color:rgb(128,0,128);line-height:1.5;">8</span>                                    |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">instance_type_memory_mb</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>    | <span style="color:rgb(128,0,128);line-height:1.5;">50</span>                                   |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">instance_type_name</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>         | tiny2                                |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">instance_type_root_gb</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>      | <span style="color:rgb(128,0,128);line-height:1.5;">1</span>                                    |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">instance_type_rxtx_factor</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>  | <span style="color:rgb(128,0,128);line-height:1.5;">1.0</span>                                  |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">instance_type_swap</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>         | <span style="color:rgb(128,0,128);line-height:1.5;">30</span>                                   |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">instance_type_vcpus</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>        | <span style="color:rgb(128,0,128);line-height:1.5;">1</span>                                    |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">instance_uuid</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>              | 8352e969-0a25-4abf-978f-d9d0ec4de0cd |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">network_allocated</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>          | True                                 |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">owner_id</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>                   | 74c8ada23a3449f888d9e19b76d13aab     |
| Property <span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">user_id</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>                    | bcd37e6272184f34993b4d7686ca4479     |</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;font-size:12px;"><a title="复制代码" style="color:rgb(26,139,200);border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">Unshelve 是 shelve 的反操作。它的主要过程是：</p> 
   <ol style="color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <li style="list-style-type:decimal;">从 DB 中获取&nbsp;network_info 和&nbsp;block_device_info</li> 
    <li style="list-style-type:decimal;">从 Glance 中获取 image</li> 
    <li style="list-style-type:decimal;">象新建一个虚拟那样 spawn 新的虚机</li> 
    <li style="list-style-type:decimal;">调用 image API 将 image 删除<span style="line-height:1.5;">&nbsp;</span> </li> 
   </ol>
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;"><span style="line-height:1.5;">4. VNC （VNC 连接）</span></h2> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><span style="line-height:1.5;">VNC 操作的过程：（<a href="http://docs.openstack.org/admin-guide-cloud/content/getting-started-with-vnc-proxy.html" rel="nofollow" style="color:rgb(26,139,200);text-decoration:none;">来源</a>）</span></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images0.cnblogs.com/blog2015/697113/201508/230649144729466.jpg" alt="" style="border:0px;"></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）用户查询 VNC 的访问 URL。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">Nova CLI 对应的命令为 “nova get-vnc-console &lt;server&gt; &lt;console-type&gt;”。 REST API 的数据格式为：{"os-getVNCConsole": {"type": "novnc"}}&nbsp;</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">“type” 参数值可以是 “novnc” 或者 “xvpvnc”。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）通过 RPC 调用虚机所在的 node 上的 Nova 生成一个 UUID（长度为 4）格式的 token，以及格式为 ‘&lt;base_url&gt;?token=&lt;token&gt;' 的 Access URL。</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">base_url 从&nbsp;CONF.novncproxy_base_url （比如&nbsp;http://192.168.1.20:6080/vnc_auto.html）或者&nbsp;CONF.xvpvncproxy_base_url 读取。</li>
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（3）本地Nova 调用 libvirt driver 从 domain xml 中获取 port，比如下面例子中的 5900，以及从 confi.vncserver_proxyclient_address 获取 host。&nbsp;</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&lt;graphics type='vnc' port='5900' autoport='yes' listen='0.0.0.0' keymap='en-us'&gt;<br> &lt;listen type='address' address='0.0.0.0'/&gt;<br> &lt;/graphics&gt;</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（4）通过 RPC，调用&nbsp;consoleauth 的 authorize_console 方法，它将 Access URL， host，port 保存到 memcached。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（5）返回 Access URL 给客户端，比如&nbsp;http://192.168.1.20:6080/vnc_auto.html?token=8dc6f7cb-2e2d-4fbe-abab-3334fe3a19dc</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">在 Contoller 节点上运行着一个service “/usr/bin/python /usr/bin/nova-novncproxy --config-file=/etc/nova/nova.conf”。该 service 默认在 6080 端口（可由 CONF.novncproxy_port 配置）监听来自所有地址（可由 CONF.novncproxy_host 配置）的请求。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（6）在客户端浏览器上打开 Access URL，由 Controller 上的&nbsp;nova-novncproxy 接收并处理</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（7）nova-novncproxy 通过 RPC 调用&nbsp;consoleauth.check_token() 方法，获取 console_type&nbsp;和 port 等 connect info。期间还会到目的node上去校验这些信息。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre> {u<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">instance_uuid</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>: u<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">7c53af66-765b-48f3-b8a2-a908feb63968</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>, u<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">internal_access_path</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>: None, u<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">last_activity_at</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>: <span style="color:rgb(128,0,128);line-height:1.5;">1434670235.591856</span>, u<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">console_type</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>: u<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">novnc</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>, u<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">host</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>: u<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">192.168.1.15</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>, u<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">token</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>: u<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">10bffd07-e11c-48bb-880a-bc1a49c871d7</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>, u<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">port</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>: u<span style="color:rgb(128,0,0);line-height:1.5;">'</span><span style="color:rgb(128,0,0);line-height:1.5;">5900</span><span style="color:rgb(128,0,0);line-height:1.5;">'</span>}</pre>
   </div> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（8）连接到目的 node，握手，开始 proxying。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;与 NOVNC 有关的配置参数：</p> 
   <table border="0" style="border:1px solid #C0C0C0;border-collapse:collapse;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">
    <tbody>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">节点</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">配置文件</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">参数</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">默认配置</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">说明</td> 
     </tr>
     <tr>
      <td rowspan="2" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">Controller</td> 
      <td rowspan="2" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">/etc/nova/nova.conf</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">novncproxy_port</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">6080</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">/usr/bin/nova-novncproxy 服务所在的节点（通常是&nbsp;Controller 节点）上 该 service 所监听的端口。奇怪的是 nova 文档中没说明该配置参数。</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">novncproxy_host&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">0.0.0.0</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">nova-novncproxy service 所监听的请求来源地址。0.0.0.0 表示接收所有来源的请求。奇怪的是 nova 文档中没说明该配置参数。</td> 
     </tr>
     <tr>
      <td rowspan="4" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">nova-compute</td> 
      <td rowspan="4" style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">/etc/nova/nova.conf</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">vncserver_proxyclient_address</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">&nbsp;</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">虚机所在的 nova compute 节点的 management 网卡的 IP 地址</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">vncserver_listen</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">127.0.0.1</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">虚机所在的 nova compute 节点的 vnc service 所监听的端口，需要修改默认配置为其&nbsp;0.0.0.0</td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">novncproxy_base_url</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p style="line-height:1.5;">http://127.0.0.1:6080/<br> vnc_auto.html</p> </td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">nova 客户端通过 get_vncconsole 命令获取到的访问虚机的 VNC URL。需要修改其值为&nbsp; <p style="line-height:1.5;">http://&lt;nova-novncproxy-node-management-interface-ip&gt;:&lt;nova-novncproxy-node-nova.conf.novncproxy_port&gt;/vnc_auto.html 比如&nbsp;http://192.168.1.20:6080/<br> vnc_auto.html</p> </td> 
     </tr>
     <tr>
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">vnc_enabled</td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;"> <p style="line-height:1.5;">true</p> </td> 
      <td style="font-size:12px;color:rgb(69,69,69);border:1px solid #C0C0C0;border-collapse:collapse;">使得虚机能够对外提供 VNC 服务</td> 
     </tr>
    </tbody>
   </table>
   <h2 style="font-size:21px;line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">5. Evacuate （移机）</h2> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">作用：当一个 node down 掉后，在新的 node 上根据其 DB 中保存的信息重新 build down node 上虚机。这个往往在虚机 HA 方案中用到。它尽可能地将原来的虚机在新的主机上恢复：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">虚机的配置：从 DB 中获取，包括 image，block，network 等</li> 
    <li style="list-style-type:disc;">虚机的数据：如果使用共享存储，则使用共享存储上的虚机数据；如果不使用共享存储，则无法恢复数据</li> 
    <li style="list-style-type:disc;">内存状态：无法恢复</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">因此，HA 方案中，应该尽可能地将虚机的数据文件放在共享存储上，否则，恢复出来的虚机的价值非常有限。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">Nova CLI：usage: nova evacuate [--password &lt;password&gt;] [--on-shared-storage]&nbsp;&lt;server&gt; [&lt;host&gt;]</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">要求：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）必须指定和虚机的 host 不同的 host，否则将报错“The target host can't be the same one”。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）虚机的host 必须处于不可用状态，否则将报错 “Compute service of compute2 is still in use.”</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（3）可以指定新的 admin password，不指定的话，nova 将生成一个随机密码</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（4）参数&nbsp;on-shared-storage 表示虚机的 instance folder 是不是在共享存储上。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">主要步骤：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（1）在做完以上各种参数检查后，调用 Conductor 的 方法：</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">return self.compute_task_api.rebuild_instance(context,&nbsp;instance=instance,&nbsp;new_pass=admin_password,&nbsp;injected_files=None,&nbsp;image_ref=None,<br> orig_image_ref=None,&nbsp;orig_sys_metadata=None,&nbsp;bdms=None,&nbsp;recreate=True,&nbsp;on_shared_storage=on_shared_storage,&nbsp;host=host)</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">如果 host 为none 的话，conductor 将调用 scheduler 的方法选择一个 host。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（2）接着调用 nova compute 的 rebuild_instance 方法。该方法从系统（DB）中获取已有的数据，然后根据这些已有的 metadata 重新构造domain。“A 'rebuild' effectively purges all existing data from the system and&nbsp;remakes the VM with given 'metadata' and 'personalities'.”</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">获取 image_ref，再获取 image meta</li> 
    <li style="list-style-type:disc;">获取&nbsp;network_info 并在新的 host 上构造网络</li> 
    <li style="list-style-type:disc;">获取&nbsp;BlockDeviceMappingList</li> 
    <li style="list-style-type:disc;">获取&nbsp;block_device_info</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（3）然后调用 virt driver 的&nbsp;rebuild 方法，但是 libvirt 没有实现该方法，转而调用&nbsp;_rebuild_default_impl 方法。该方法：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">从 volume 端断开其与原来 host 的连接</li> 
    <li style="list-style-type:disc;">调用&nbsp;driver.spawn 方法构造新的 domain，依次创建 image（如果 on_shared_storage = false 的话，则重新下载 image， 构造 instance folder；如果&nbsp;on_shared_storage = true 的话，则直接使用共享存储上的 instance folder。这也可见使用共享存储的优势），network 和 domain，并设置 domain 的状态和之前一致。</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">（4）在坏了的 host 被重启后，nova-compute 服务调用&nbsp;_destroy_evacuated_instances 方法来找到 evacuated instances 并将它们删除：</p> 
   <ul style="list-style:none;font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">
    <li style="list-style-type:disc;">调用 libvirt 找到该 host 上所有&nbsp;domains，然后在 nova db 中一一查找其状态，过滤出&nbsp;“deleted” 为 false 的 domains</li> 
    <li style="list-style-type:disc;">如果instance.host 不是本机，而且 instance.task_state&nbsp;不是 {&nbsp;MIGRATING，RESIZE_MIGRATING，RESIZE_MIGRATED，RESIZE_FINISH} 之一，则删除该 domain，以及 network，block device 以及 instance folder。</li> 
   </ul>
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">总之，在使用共享存储的情况下，evacuate 出来的新的 domain 除了临时盘上的数据外，它和之前的 domain 的数据是一样的了，但是内存状态除外。</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><br></p> 
   <p style="line-height:1.5;"><font color="#4b4b4b"><span style="font-size:15px;">&nbsp; &nbsp; 本文转自SammyLiu博客园博客，原文链接：http://www.cnblogs.com/sammyliu/p/4571209.html</span></font><span style="font-size:15px;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;">，如需转载请自行联系原作者</span></p> 
   <p style="line-height:1.5;color:rgb(75,75,75);font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:15px;"><br></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
