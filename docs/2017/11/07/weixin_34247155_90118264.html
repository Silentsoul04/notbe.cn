<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>windows下ping程序实现 « NotBeCN</title>
  <meta name="description" content="             windows下ping程序的实现：使用原始套接字SOCK_RAW，基于IP协议上的ICMP协议来实现，发送的ICMP数据包type为8（请求回复），收到的回复的ICMP数据包type为0，为了判断收到是数据包是本进程发送的。将ICMP包的id设置为本进程的ID。如果使用-r选项，会记录...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/07/weixin_34247155_90118264.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">windows下ping程序实现</h1>
    <p class="post-meta">Nov 7, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">windows下ping程序的实现：使用原始套接字SOCK_RAW，基于IP协议上的ICMP协议来实现，发送的ICMP数据包type为8（请求回复），收到的回复的ICMP数据包type为0，为了判断收到是数据包是本进程发送的。将ICMP包的id设置为本进程的ID。如果使用-r选项，会记录中间经过的route。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">参考代码：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Description:
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    This sample illustrates how an ICMP ping app can be written
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    using the SOCK_RAW socket type and IPPROTO_ICMP protocol.
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    By creating a raw socket, the underlying layer does not change
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    the protocol header so that when we submit the ICMP header
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    nothing is changed so that the receiving end will see an 
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    ICMP packet. Additionally, we use the record route IP option
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    to get a round trip path to the endpoint. Note that the size
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    of the IP option header that records the route is limited to
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    nine IP addresses.
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span>
<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Compile:
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">     cl -o Ping Ping.c ws2_32.lib /Zp1
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span>
<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Command Line Options/Parameters:
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">     Ping [host] [packet-size]
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span>     
<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">     host         String name of host to ping
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">     packet-size  Integer size of packet to send 
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">                      (smaller than 1024 bytes)
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span>
<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">#pragma pack(1)</span>
<span style="font-size:12px;line-height:1.5;">
#include </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">stdafx.h</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">

#include </span>&lt;winsock2.h&gt;<span style="font-size:12px;line-height:1.5;">
#include </span>&lt;ws2tcpip.h&gt;<span style="font-size:12px;line-height:1.5;">
#include </span>&lt;stdio.h&gt;<span style="font-size:12px;line-height:1.5;">
#include </span>&lt;stdlib.h&gt;

<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">#define</span> WIN32_LEAN_AND_MEAN

<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">#pragma</span> comment(lib,"ws2_32.lib")

<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">#define</span> IP_RECORD_ROUTE  0x7

<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> IP header structure</span>
typedef <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span><span style="font-size:12px;line-height:1.5;"> _iphdr 
{
    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">Suppose the BYTE_ORDER is LITTLE_ENDIAN</span>
    unsigned <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span>   h_len:<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">4</span>;        <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Length of the header</span>
    unsigned <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span>   version:<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">4</span>;      <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Version of IP</span>
    unsigned <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span>  tos;            <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Type of service</span>
    unsigned <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">short</span> total_len;      <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Total length of the packet</span>
    unsigned <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">short</span> id;             <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Unique identification</span>
    unsigned <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">short</span> frag_offset;    <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Fragment offset</span>
    unsigned <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span>  ttl;            <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Time to live</span>
    unsigned <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span>  protocol;       <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Protocol (TCP, UDP etc)</span>
    unsigned <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">short</span> checksum;       <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> IP checksum</span>
    unsigned <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span>   sourceIP;       <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Source IP</span>
    unsigned <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span>   destIP;         <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Destination IP</span>
<span style="font-size:12px;line-height:1.5;">} IpHeader;

</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">#define</span> ICMP_ECHO        8
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">#define</span> ICMP_ECHOREPLY   0
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">#define</span> ICMP_MIN         8 <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Minimum 8-byte ICMP packet (header)</span>

<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> ICMP header structure
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> This is not the standard header, but we reserve space for time</span>
typedef <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span><span style="font-size:12px;line-height:1.5;"> _icmphdr 
{
    BYTE   i_type;
    BYTE   i_code;                 </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Type sub code</span>
<span style="font-size:12px;line-height:1.5;">    USHORT i_cksum;
    USHORT i_id;
    USHORT i_seq;
    ULONG  timestamp;
} IcmpHeader;

</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> IP option header - use with socket option IP_OPTIONS</span>
typedef <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span><span style="font-size:12px;line-height:1.5;"> _ipoptionhdr
{
    unsigned </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span> code;        <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Option type</span>
    unsigned <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span> len;         <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Length of option hdr</span>
    unsigned <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span> ptr;         <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Offset into options</span>
    unsigned <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">long</span> addr[<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">9</span>];     <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> List of IP addrs</span>
<span style="font-size:12px;line-height:1.5;">} IpOptionHeader;

</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">#define</span> DEF_PACKET_SIZE  32        <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Default packet size</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">#define</span> MAX_PACKET       1024      <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Max ICMP packet size</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">#define</span> MAX_IP_HDR_SIZE  60        <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Max IP header size w/options</span><span style="font-size:12px;line-height:1.5;">

BOOL  bRecordRoute;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;">   datasize;
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span> *<span style="font-size:12px;line-height:1.5;">lpdest;

</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Function: usage
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Description:
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    Print usage information</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> usage(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span> *<span style="font-size:12px;line-height:1.5;">progname)
{
    printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">usage: ping -r &lt;host&gt; [data size] </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
    printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">       -r           record route </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
    printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">       host         remote machine to ping </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
    printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">       datasize     can be up to 1KB </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
    ExitProcess(</span>-<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">);
}

</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Function: FillICMPData
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Description:
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    Helper function to fill in various fields for our ICMP request</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> FillICMPData(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span> *icmp_data, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> datasize)
{
    IcmpHeader </span>*icmp_hdr =<span style="font-size:12px;line-height:1.5;"> NULL;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span> *datapart =<span style="font-size:12px;line-height:1.5;"> NULL;

    icmp_hdr </span>= (IcmpHeader*<span style="font-size:12px;line-height:1.5;">)icmp_data;
    icmp_hdr</span>-&gt;i_type = ICMP_ECHO; <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Request an ICMP echo, type is 8</span>
    icmp_hdr-&gt;i_code = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>;    <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> code is 0</span>
    icmp_hdr-&gt;i_id =<span style="font-size:12px;line-height:1.5;"> (USHORT)GetCurrentProcessId();
    icmp_hdr</span>-&gt;i_cksum = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
    icmp_hdr</span>-&gt;i_seq = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;

    datapart </span>= icmp_data + <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">sizeof</span><span style="font-size:12px;line-height:1.5;">(IcmpHeader);
    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Place some junk in the buffer</span>
    memset(datapart, <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">E</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span> , datasize - <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">sizeof</span><span style="font-size:12px;line-height:1.5;">(IcmpHeader));
}


</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Function: checksum
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Description:
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    This function calculates the 16-bit one's complement sum
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    of the supplied buffer (ICMP) header</span>
USHORT checksum(USHORT *buffer, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> size) 
{
    unsigned </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">long</span> cksum=<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">while</span>(size &gt; <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">) 
    {
        cksum </span>+= *buffer++<span style="font-size:12px;line-height:1.5;">;
        size </span>-= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">sizeof</span><span style="font-size:12px;line-height:1.5;">(USHORT);
    }
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span><span style="font-size:12px;line-height:1.5;">(size) 
    {
        cksum </span>+= *(UCHAR*<span style="font-size:12px;line-height:1.5;">)buffer;
    }
    cksum </span>= (cksum &gt;&gt; <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">16</span>) + (cksum &amp; <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0xffff</span><span style="font-size:12px;line-height:1.5;">);
    cksum </span>+= (cksum &gt;&gt;<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">16</span><span style="font-size:12px;line-height:1.5;">);
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> (USHORT)(~<span style="font-size:12px;line-height:1.5;">cksum);
}

</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Function: DecodeIPOptions
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Description:
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    If the IP option header is present, find the IP options
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    within the IP header and print the record route option values</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> DecodeIPOptions(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span> *buf, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> bytes)
{
    IpOptionHeader </span>*ipopt =<span style="font-size:12px;line-height:1.5;"> NULL;
    IN_ADDR         inaddr;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;">             i;
    HOSTENT        </span>*host =<span style="font-size:12px;line-height:1.5;"> NULL;

    ipopt </span>= (IpOptionHeader *)(buf + <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">20</span><span style="font-size:12px;line-height:1.5;">);

    printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Record Route:   </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span>(i = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>; i &lt; (ipopt-&gt;ptr / <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">4</span>) - <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>; i++<span style="font-size:12px;line-height:1.5;">)
    {
        inaddr.S_un.S_addr </span>= ipopt-&gt;<span style="font-size:12px;line-height:1.5;">addr[i];
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (i != <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>) printf(<span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>   <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
        host </span>= gethostbyaddr((<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span> *)&amp;inaddr.S_un.S_addr, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">sizeof</span><span style="font-size:12px;line-height:1.5;">(inaddr.S_un.S_addr), AF_INET);
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span><span style="font-size:12px;line-height:1.5;"> (host)
            printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">(%-15s) %s </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>, inet_ntoa(inaddr), host-&gt;<span style="font-size:12px;line-height:1.5;">h_name);
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">else</span><span style="font-size:12px;line-height:1.5;">
            printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">(%-15s) </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, inet_ntoa(inaddr));
    }
    printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;">;
}

</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Function: DecodeICMPHeader
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Description:
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    The response is an IP packet. We must decode the IP header to
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    locate the ICMP data.</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> DecodeICMPHeader(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span> *buf, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> bytes, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span> sockaddr_in *<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">from</span><span style="font-size:12px;line-height:1.5;">)
{
    IpHeader       </span>*iphdr =<span style="font-size:12px;line-height:1.5;"> NULL;
    IcmpHeader     </span>*icmphdr =<span style="font-size:12px;line-height:1.5;"> NULL;
    unsigned </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">short</span><span style="font-size:12px;line-height:1.5;">  iphdrlen;
    DWORD           tick;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span>   <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span>    icmpcount = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;

    iphdr </span>= (IpHeader *<span style="font-size:12px;line-height:1.5;">)buf;
    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Number of 32-bit words * 4 = bytes</span>
    iphdrlen = iphdr-&gt;h_len * <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">4</span><span style="font-size:12px;line-height:1.5;">;
    tick </span>=<span style="font-size:12px;line-height:1.5;"> GetTickCount();

    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>((iphdrlen == MAX_IP_HDR_SIZE) &amp;&amp; (!<span style="font-size:12px;line-height:1.5;">icmpcount))
        DecodeIPOptions(buf, bytes);

    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(bytes &lt; iphdrlen +<span style="font-size:12px;line-height:1.5;"> ICMP_MIN) 
    {
        printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Too few bytes from %s \n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>, inet_ntoa(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">from</span>-&gt;<span style="font-size:12px;line-height:1.5;">sin_addr));
    }

    icmphdr </span>= (IcmpHeader*)(buf +<span style="font-size:12px;line-height:1.5;"> iphdrlen);
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(icmphdr-&gt;i_type != ICMP_ECHOREPLY) <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> echo type must be 0</span>
<span style="font-size:12px;line-height:1.5;">    {
        printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">non-echo type %d recvd \n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>, icmphdr-&gt;<span style="font-size:12px;line-height:1.5;">i_type);
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;">;
    }
    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Make sure this is an ICMP reply to something we sent!
    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> In FillICMPData function we assign the i_id is GetCurrentProcessId()</span>
    <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(icmphdr-&gt;i_id !=<span style="font-size:12px;line-height:1.5;"> (USHORT)GetCurrentProcessId()) 
    {
        printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">someone else's packet! \n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;"> ;
    }
    printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">%d bytes from %s </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>, bytes, inet_ntoa(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">from</span>-&gt;<span style="font-size:12px;line-height:1.5;">sin_addr));
    printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">icmp_seq = %d. </span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>, icmphdr-&gt;<span style="font-size:12px;line-height:1.5;">i_seq);
    printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">time: %d ms</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span>, tick - icmphdr-&gt;<span style="font-size:12px;line-height:1.5;">timestamp);
    printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">\n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);

    icmpcount</span>++<span style="font-size:12px;line-height:1.5;">;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span><span style="font-size:12px;line-height:1.5;">;
}

</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Function: ValidateArgs
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Description:
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    Check the input arguments is valid or not.</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">void</span> ValidateArgs(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> argc, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span> **<span style="font-size:12px;line-height:1.5;">argv)
{
    bRecordRoute </span>=<span style="font-size:12px;line-height:1.5;"> FALSE;
    lpdest </span>=<span style="font-size:12px;line-height:1.5;"> NULL;
    datasize </span>=<span style="font-size:12px;line-height:1.5;"> DEF_PACKET_SIZE;
    
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span>(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> i = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span>; i &lt; argc; i++<span style="font-size:12px;line-height:1.5;">)
    {
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>((argv[i][<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>] == <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">-</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span>) || (argv[i][<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>] == <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">/</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="font-size:12px;line-height:1.5;">))
        {
            </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">switch</span> (tolower(argv[i][<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">]))
            {
                </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">case</span> <span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">r</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">'</span>:        <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Record route option</span>
                    bRecordRoute =<span style="font-size:12px;line-height:1.5;"> TRUE;
                    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">break</span><span style="font-size:12px;line-height:1.5;">;
                </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">default</span><span style="font-size:12px;line-height:1.5;">:
                    usage(argv[</span><span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">]);
                    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">break</span><span style="font-size:12px;line-height:1.5;">;
            }
        }
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">else</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(isdigit(argv[i][<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">]))
            datasize </span>=<span style="font-size:12px;line-height:1.5;"> atoi(argv[i]);
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">else</span><span style="font-size:12px;line-height:1.5;">
            lpdest </span>=<span style="font-size:12px;line-height:1.5;"> argv[i];
    }
}
        
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span>
<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Function: main
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span>
<span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Description:
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    Setup the ICMP raw socket, and create the ICMP header. Add
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    the appropriate IP option header, and start sending ICMP
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    echo requests to the endpoint. For each send and receive,
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    we set a timeout value so that we don t wait forever for a 
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    response in case the endpoint is not responding. When we
</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">    receive a packet decode it.</span>

<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> main(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> argc, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span> **<span style="font-size:12px;line-height:1.5;">argv)
{
    WSADATA            wsaData;
    SOCKET             sockRaw </span>=<span style="font-size:12px;line-height:1.5;"> INVALID_SOCKET;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span> sockaddr_in dest, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">from</span><span style="font-size:12px;line-height:1.5;">;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;">                bread,
                       fromlen </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">sizeof</span>(<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">from</span><span style="font-size:12px;line-height:1.5;">),
                       timeout </span>= <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1000</span><span style="font-size:12px;line-height:1.5;">,
                       ret;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span><span style="font-size:12px;line-height:1.5;">               icmp_data[MAX_PACKET],
                       recvbuf[MAX_PACKET];
    unsigned </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span>       addr = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
    USHORT             seq_no </span>= <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span> hostent    *hp =<span style="font-size:12px;line-height:1.5;"> NULL;
    IpOptionHeader     ipopt;

    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(WSAStartup(MAKEWORD(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">2</span>, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">2</span>), &amp;wsaData) != <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">)
    {
        printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">WSAStartup() failed: %d \n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, GetLastError());
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">;
    }

    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Check the input arguments</span>
<span style="font-size:12px;line-height:1.5;">    ValidateArgs(argc, argv);

    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Create a raw socket with IPPROTO_ICMP protocol</span>
    sockRaw =<span style="font-size:12px;line-height:1.5;"> socket(AF_INET, SOCK_RAW, IPPROTO_ICMP);
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(sockRaw ==<span style="font-size:12px;line-height:1.5;"> INVALID_SOCKET) 
    {
        printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">WSASocket() failed: %d \n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, WSAGetLastError());
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">;
    }
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span><span style="font-size:12px;line-height:1.5;">(bRecordRoute)
    {
        </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Setup the IP option header to go out on every ICMP packet</span>
        memset(&amp;ipopt,<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>,<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">sizeof</span><span style="font-size:12px;line-height:1.5;">(ipopt));
        ipopt.code </span>= IP_RECORD_ROUTE; <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Record route option</span>
        ipopt.ptr  = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">4</span>;               <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Point to the first addr offset</span>
        ipopt.len  = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">39</span>;              <span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Length of option header</span>
<span style="font-size:12px;line-height:1.5;">  
        ret </span>= setsockopt(sockRaw, IPPROTO_IP, IP_OPTIONS, (<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span> *)&amp;ipopt, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">sizeof</span><span style="font-size:12px;line-height:1.5;">(ipopt));
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (ret ==<span style="font-size:12px;line-height:1.5;"> SOCKET_ERROR)
        {
            printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">setsockopt(IP_OPTIONS) failed: %d \n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, WSAGetLastError());
            </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">;
        }
    }
    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Set the send/recv timeout values</span>
    timeout = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1000</span><span style="font-size:12px;line-height:1.5;">;
    bread </span>= setsockopt(sockRaw, SOL_SOCKET, SO_RCVTIMEO, (<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span>*)&amp;timeout, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">sizeof</span><span style="font-size:12px;line-height:1.5;">(timeout));
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(bread ==<span style="font-size:12px;line-height:1.5;"> SOCKET_ERROR) 
    {
        printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">setsockopt(SO_RCVTIMEO) failed: %d \n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, WSAGetLastError());
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">;
    }
    timeout </span>= <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1000</span><span style="font-size:12px;line-height:1.5;">;
    bread </span>= setsockopt(sockRaw, SOL_SOCKET, SO_SNDTIMEO, (<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">char</span>*)&amp;timeout, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">sizeof</span><span style="font-size:12px;line-height:1.5;">(timeout));
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(bread ==<span style="font-size:12px;line-height:1.5;"> SOCKET_ERROR) 
    {
        printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">setsockopt(SO_SNDTIMEO) failed: %d \n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, WSAGetLastError());
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">;
    }
    
    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Resolve the endpoint's name if necessary</span>
    memset(&amp;dest, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">sizeof</span><span style="font-size:12px;line-height:1.5;">(dest));
    dest.sin_family </span>=<span style="font-size:12px;line-height:1.5;"> AF_INET;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>((dest.sin_addr.s_addr = inet_addr(lpdest)) ==<span style="font-size:12px;line-height:1.5;"> INADDR_NONE)
    {
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>((hp = gethostbyname(lpdest)) !=<span style="font-size:12px;line-height:1.5;"> NULL)
        {
            memcpy(</span>&amp;(dest.sin_addr), hp-&gt;h_addr, hp-&gt;<span style="font-size:12px;line-height:1.5;">h_length);
            dest.sin_family </span>= hp-&gt;<span style="font-size:12px;line-height:1.5;">h_addrtype;
            printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">dest.sin_addr = %s \n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, inet_ntoa(dest.sin_addr));
        }
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">else</span><span style="font-size:12px;line-height:1.5;">
        {
            printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">gethostbyname() failed: %d \n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, WSAGetLastError());
            </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">;
        }
    }

    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Create the ICMP packet</span>
    datasize += <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">sizeof</span><span style="font-size:12px;line-height:1.5;">(IcmpHeader);
    memset(icmp_data,</span><span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">,MAX_PACKET);
    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Fill the ICMP packet</span>
<span style="font-size:12px;line-height:1.5;">    FillICMPData(icmp_data,datasize);

    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Start sending/receiving ICMP packets</span>
    <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">while</span>(<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">) 
    {
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span> nCount = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">int</span><span style="font-size:12px;line-height:1.5;"> bwrote;
                
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(nCount++ == <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">10</span>) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">break</span><span style="font-size:12px;line-height:1.5;">;
                
        ((IcmpHeader</span>*)icmp_data)-&gt;i_cksum = <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
        ((IcmpHeader</span>*)icmp_data)-&gt;timestamp =<span style="font-size:12px;line-height:1.5;"> GetTickCount();
        ((IcmpHeader</span>*)icmp_data)-&gt;i_seq = seq_no++<span style="font-size:12px;line-height:1.5;">;
        ((IcmpHeader</span>*)icmp_data)-&gt;i_cksum = checksum((USHORT*<span style="font-size:12px;line-height:1.5;">)icmp_data, datasize);

        bwrote </span>= sendto(sockRaw, icmp_data, datasize, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>, (<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span> sockaddr*)&amp;dest, <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">sizeof</span><span style="font-size:12px;line-height:1.5;">(dest));
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(bwrote ==<span style="font-size:12px;line-height:1.5;"> SOCKET_ERROR)
        {
            </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(WSAGetLastError() ==<span style="font-size:12px;line-height:1.5;"> WSAETIMEDOUT) 
            {
                printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">timed out \n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
                </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">continue</span><span style="font-size:12px;line-height:1.5;">;
            }
            printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">sendto() failed: %d \n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, WSAGetLastError());
            </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">;
        }
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(bwrote &lt;<span style="font-size:12px;line-height:1.5;"> datasize) 
        {
            printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">Wrote %d bytes \n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, bwrote);
        }
        bread </span>= recvfrom(sockRaw, recvbuf, MAX_PACKET, <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span>, (<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">struct</span> sockaddr*)&amp;<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">from</span>, &amp;<span style="font-size:12px;line-height:1.5;">fromlen);
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(bread ==<span style="font-size:12px;line-height:1.5;"> SOCKET_ERROR)
        {
            </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span>(WSAGetLastError() ==<span style="font-size:12px;line-height:1.5;"> WSAETIMEDOUT) 
            {
                printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">timed out \n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">);
                </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">continue</span><span style="font-size:12px;line-height:1.5;">;
            }
            printf(</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">recvfrom() failed: %d \n</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">"</span><span style="font-size:12px;line-height:1.5;">, WSAGetLastError());
            </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> -<span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1</span><span style="font-size:12px;line-height:1.5;">;
        }
        DecodeICMPHeader(recvbuf, bread, </span>&amp;<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">from</span><span style="font-size:12px;line-height:1.5;">);
        Sleep(</span><span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">1000</span><span style="font-size:12px;line-height:1.5;">);
    }

    </span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">//</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;"> Cleanup</span>
    <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">if</span> (sockRaw !=<span style="font-size:12px;line-height:1.5;"> INVALID_SOCKET) 
        closesocket(sockRaw);
    WSACleanup();

    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">return</span> <span style="color:rgb(128,0,128);font-size:12px;line-height:1.5;">0</span><span style="font-size:12px;line-height:1.5;">;
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><br></a></span>
    </div> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><br></a></span>
    </div> 
    <div class="cnblogs_code_toolbar"> 
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"> </a></span>
     <div class="cnblogs_code_toolbar">
      <a title="复制代码" style="text-decoration:underline;border:none;">&nbsp; &nbsp; 本文转自阿凡卢博客园博客，原文链接：http://www.cnblogs.com/luxiaoxun/archive/2012/10/17/2728607.html，如需转载请自行联系原作者</a>
     </div> 
     <a title="复制代码" style="text-decoration:underline;border:none;"> </a>
     <div>
      <a title="复制代码" style="text-decoration:underline;border:none;"><br></a>
     </div> 
     <a title="复制代码" style="text-decoration:underline;border:none;"> </a> 
    </div> 
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
