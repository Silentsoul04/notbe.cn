<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Solr与MySQL查询性能对比 « NotBeCN</title>
  <meta name="description" content="             测试环境    本文简单对比下Solr与MySQL的查询性能速度。    测试数据量：10407608 &nbsp; &nbsp;&nbsp;Num Docs: 10407608    普通查询    这里对MySQL的查询时间都包含了从MySQL Server获取数据的时间。    在...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/07/weixin_33936401_90131705.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">Solr与MySQL查询性能对比</h1>
    <p class="post-meta">Nov 7, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><strong>测试环境</strong></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">本文简单对比下Solr与MySQL的查询性能速度。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">测试数据量：10407608 &nbsp; &nbsp;&nbsp;Num Docs: 10407608</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><strong>普通查询</strong></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">这里对MySQL的查询时间都包含了从MySQL Server获取数据的时间。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">在项目中一个最常用的查询，查询某段时间内的数据，SQL查询获取数据，30s左右</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">SELECT</span> <span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">*</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">FROM</span> `tf_hotspotdata_copy_test` <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">WHERE</span> collectTime <span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">BETWEEN</span> <span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">2014-12-06 00:00:00</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">'</span> <span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">AND</span> <span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">2014-12-10 21:31:55</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">'</span>;</pre>
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">对collectTime建立索引后，同样的查询，2s，快了很多。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">Solr索引数据：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">&lt;!--</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">Index Field for HotSpot</span><span style="color:rgb(0,128,0);font-size:12px;line-height:1.5;">--&gt;</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">field </span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">name</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="CollectTime"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> type</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="tdate"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> indexed</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="true"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> stored</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="true"</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">/&gt;</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">field </span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">name</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="IMSI"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> type</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="string"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> indexed</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="true"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> stored</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="true"</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">/&gt;</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">field </span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">name</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="IMEI"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> type</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="string"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> indexed</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="true"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> stored</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="true"</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">/&gt;</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">field </span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">name</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="DeviceID"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> type</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="string"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> indexed</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="true"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> stored</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="true"</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">/&gt;</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">Solr查询，同样的条件，72ms</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>"status": 0,
    "QTime": 72,
    "params": {
      "indent": "true",
      "q": "CollectTime:[2014-12-06T00:00:00.000Z TO 2014-12-10T21:31:55.000Z]",
      "_": "1434617215202",
      "wt": "json"
    }</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">好吧，查询性能提高的不是一点点，用Solrj代码试试：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>SolrQuery params = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> SolrQuery();
params.set(</span>"q"<span style="font-size:12px;line-height:1.5;">, timeQueryString);
params.set(</span>"fq"<span style="font-size:12px;line-height:1.5;">, queryString);
params.set(</span>"start", 0<span style="font-size:12px;line-height:1.5;">); 
params.set(</span>"rows"<span style="font-size:12px;line-height:1.5;">, Integer.MAX_VALUE);
params.setFields(retKeys);
QueryResponse response </span>= server.query(params);</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">Solrj查询并获取结果集，结果集大小为220296，返回5个字段，时间为12s左右。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">为什么需要这么长时间？上面的"QTime"只是根据索引查询的时间，如果要从solr服务端获取查询到的结果集，solr需要读取stored的字段（磁盘IO），再经过Http传输到本地（网络IO），这两者比较耗时，特别是磁盘IO。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">时间对比：</p> 
   <table border="1" style="border-collapse:collapse;border-spacing:0px;border:1px solid #C0C0C0;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">
    <tbody>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p align="center">查询条件</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p align="center">时间</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>MySQL（无索引）</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>30s</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>MySQL（有索引）</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>2s</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>Solrj（select查询）</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>12s</p> </td> 
     </tr>
    </tbody>
   </table>
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">如何优化？看看只获取ID需要的时间：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">SQL查询只返回id，没有对collectTime建索引，10s左右：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">SELECT</span> id <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">FROM</span> `tf_hotspotdata_copy_test` <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">WHERE</span> collectTime <span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">BETWEEN</span> <span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">2014-12-06 00:00:00</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">'</span> <span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">AND</span> <span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">'</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">2014-12-10 21:31:55</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">'</span>;</pre>
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">SQL查询只返回id，同样的查询条件，对collectTime建索引，0.337s，很快。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">Solrj查询只返回id，7s左右，快了一点。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;&nbsp;&nbsp; id Size: 220296</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;&nbsp;&nbsp; Time: 7340</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">时间对比：</p> 
   <table border="1" style="border-collapse:collapse;border-spacing:0px;border:1px solid #C0C0C0;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;width:580px;">
    <tbody>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p align="center">查询条件（只获取ID）</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p align="center">时间</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>MySQL（无索引）</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>10s</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>MySQL（有索引）</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>0.337s</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>Solrj（select查询）</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>7s</p> </td> 
     </tr>
    </tbody>
   </table>
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">继续优化。。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">关于Solrj获取大量结果集速度慢的一些类似问题：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">http://stackoverflow.com/questions/28181821/solr-performance#</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">http://grokbase.com/t/lucene/solr-user/11aysnde25/query-time-help</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">http://lucene.472066.n3.nabble.com/Solrj-performance-bottleneck-td2682797.html</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">这个问题没有好的解决方式，基本的建议都是做分页，但是我们需要拿到大量数据做一些比对分析，做分页没有意义。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">偶然看到一个回答，solr默认的查询使用的是"/select" request handler，可以用"/export" request handler来export结果集，看看solr对它的说明：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">It's&nbsp;possible&nbsp;to&nbsp;export&nbsp;fully&nbsp;sorted&nbsp;result&nbsp;sets&nbsp;using&nbsp;a&nbsp;special&nbsp;rank&nbsp;query&nbsp;parser&nbsp;and&nbsp;response&nbsp;writer&nbsp;&nbsp;specifically&nbsp;designed&nbsp;to work&nbsp;together&nbsp;to&nbsp;handle&nbsp;scenarios&nbsp;that&nbsp;involve&nbsp;sorting&nbsp;and&nbsp;exporting&nbsp;millions&nbsp;of&nbsp;records.&nbsp;This&nbsp;uses&nbsp;a&nbsp;stream&nbsp;sorting&nbsp;techniquethat&nbsp;begins&nbsp;to&nbsp;send&nbsp;records&nbsp;within&nbsp;milliseconds&nbsp;and&nbsp;continues&nbsp;to&nbsp;stream&nbsp;results&nbsp;until&nbsp;the&nbsp;entire&nbsp;result&nbsp;set&nbsp;has&nbsp;been&nbsp;sorted&nbsp;and exported.</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">Solr中已经定义了这个requestHandler：&nbsp;</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">requestHandler </span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">name</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="/export"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> class</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="solr.SearchHandler"</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&gt;</span>
  <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">lst </span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">name</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="invariants"</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&gt;</span>
    <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">str </span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">name</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="rq"</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&gt;</span>{!xport}<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&lt;/</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">str</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&gt;</span>
    <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">str </span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">name</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="wt"</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&gt;</span>xsort<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&lt;/</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">str</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&gt;</span>
    <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">str </span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">name</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="distrib"</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&gt;</span>false<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&lt;/</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">str</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&gt;</span>
  <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&lt;/</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">lst</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&gt;</span>
  <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">arr </span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">name</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="components"</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&gt;</span>
    <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">str</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&gt;</span>query<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&lt;/</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">str</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&gt;</span>
  <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&lt;/</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">arr</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&gt;</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&lt;/</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">requestHandler</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&gt;</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">使用/export需要字段使用docValues建立索引：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">field </span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">name</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="id"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> type</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="string"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> indexed</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="true"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> stored</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="true"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> required</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="true"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> multiValued</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="false"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> docValues</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="true"</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">/&gt;</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">field </span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">name</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="CollectTime"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> type</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="tdate"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> indexed</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="true"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> stored</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="true"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> docValues</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="true"</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">/&gt;</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">field </span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">name</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="IMSI"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> type</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="string"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> indexed</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="true"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> stored</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="true"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> docValues</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="true"</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">/&gt;</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">field </span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">name</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="IMEI"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> type</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="string"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> indexed</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="true"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> stored</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="true"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> docValues</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="true"</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">/&gt;</span>
<span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">&lt;</span><span style="color:rgb(128,0,0);font-size:12px;line-height:1.5;">field </span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;">name</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="DeviceID"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> type</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="string"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> indexed</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="true"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> stored</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="true"</span><span style="color:rgb(255,0,0);font-size:12px;line-height:1.5;"> docValues</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">="true"</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">/&gt;</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">使用docValues必须要有一个用来Sort的字段，且只支持下列类型：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">Sort fields must be one of the following types: int,float,long,double,string</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">docValues支持的返回字段：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">Export fields must either be one of the following types: int,float,long,double,string</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">使用Solrj来查询并获取数据：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>        SolrQuery params = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> SolrQuery();
        params.set(</span>"q"<span style="font-size:12px;line-height:1.5;">, timeQueryString);
        params.set(</span>"fq"<span style="font-size:12px;line-height:1.5;">, queryString);
        params.set(</span>"start", 0<span style="font-size:12px;line-height:1.5;">);
        params.set(</span>"rows"<span style="font-size:12px;line-height:1.5;">, Integer.MAX_VALUE);
        params.set(</span>"sort", "id asc"<span style="font-size:12px;line-height:1.5;">);
        params.setHighlight(</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">false</span><span style="font-size:12px;line-height:1.5;">);
        params.set(</span>"qt", "/export"<span style="font-size:12px;line-height:1.5;">);
        params.setFields(retKeys);
        QueryResponse response </span>= server.query(params);</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">一个Bug：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">org.apache.solr.client.solrj.impl.HttpSolrClient$RemoteSolrException: Error from server at http://192.8.125.30:8985/solr/hotspot: Expected mime type application/octet-stream but got application/json.&nbsp;</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">Solrj没法正确解析出结果集，看了下源码，原因是Solr server返回的ContentType和Solrj解析时检查时不一致，Solrj的BinaryResponseParser这个CONTENT_TYPE是定死的：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">class</span> BinaryResponseParser <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">extends</span><span style="font-size:12px;line-height:1.5;"> ResponseParser {
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">public</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">static</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">final</span> String BINARY_CONTENT_TYPE = "application/octet-stream";</pre>
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">一时半会也不知道怎么解决这个Bug，还是自己写个Http请求并获取结果吧，用HttpClient写了个简单的客户端请求并解析json获取数据，测试速度：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    String url = "http://192.8.125.30:8985/solr/hotspot/export?q=CollectTime%3A[2014-12-06T00%3A00%3A00.000Z+TO+2014-12-10T21%3A31%3A55.000Z]&amp;sort=id+asc&amp;fl=id&amp;wt=json&amp;indent=true"<span style="font-size:12px;line-height:1.5;">;
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">long</span> s =<span style="font-size:12px;line-height:1.5;"> System.currentTimeMillis();
    SolrHttpJsonClient client </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> SolrHttpJsonClient();
    SolrQueryResult result </span>=<span style="font-size:12px;line-height:1.5;"> client.getQueryResultByGet(url);
    System.out.println(</span>"Size: "+<span style="font-size:12px;line-height:1.5;">result.getResponse().getNumFound());
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">long</span> e =<span style="font-size:12px;line-height:1.5;"> System.currentTimeMillis();
    System.out.println(</span>"Time: "+(e-s));</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">同样的查询条件获取220296个结果集，时间为2s左右，这样的查询获取数据的效率和MySQL建立索引后的效果差不多，暂时可以接受。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">为什么使用docValues的方式获取数据速度快？</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">DocValues是一种按列组织的存储格式，这种存储方式降低了随机读的成本。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">传统的按行存储是这样的：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;<img src="https://images2015.cnblogs.com/blog/434101/201604/434101-20160426202701408-1764681529.jpg" alt="" style="border:none;"></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">1和2代表的是docid。颜色代表的是不同的字段。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">改成按列存储是这样的：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><img src="https://images2015.cnblogs.com/blog/434101/201604/434101-20160426202746330-1729623314.jpg" alt="" style="border:none;"></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">按列存储的话会把一个文件分成多个文件，每个列一个。对于每个文件，都是按照docid排序的。这样一来，只要知道docid，就可以计算出这个docid在这个文件里的偏移量。也就是对于每个docid需要一次随机读操作。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">那么这种排列是如何让随机读更快的呢？秘密在于Lucene底层读取文件的方式是基于memory mapped byte buffer的，也就是mmap。这种文件访问的方式是由操作系统去缓存这个文件到内存里。这样在内存足够的情况下，访问文件就相当于访问内存。那么随机读操作也就不再是磁盘操作了，而是对内存的随机读。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">那么为什么按行存储不能用mmap的方式呢？因为按行存储的方式一个文件里包含了很多列的数据，这个文件尺寸往往很大，超过了操作系统的文件缓存的大小。而按列存储的方式把不同列分成了很多文件，可以只缓存用到的那些列，而不让很少使用的列数据浪费内存。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">注意Export fields只支持int,float,long,double,string这几个类型，如果你的查询结果只包含这几个类型的字段，那采用这种方式查询并获取数据，速度要快很多。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">下面是Solr使用“/select”和“/export”的速度对比。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">时间对比：</p> 
   <table border="1" style="border-collapse:collapse;border-spacing:0px;border:1px solid #C0C0C0;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">
    <tbody>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p align="center">查询条件</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p align="center">时间</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>MySQL（无索引）</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>30s</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>MySQL（有索引）</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>2s</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>Solrj（select查询）</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>12s</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>Solrj（export查询）</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>2s</p> </td> 
     </tr>
    </tbody>
   </table>
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">项目中如果用分页查询，就用select方式，如果一次性要获取大量查询数据就用export方式，这里没有采用MySQL对查询字段建索引，因为数据量每天还在增加，当达到亿级的数据量的时候，索引也不能很好的解决问题，而且项目中还有其他的查询需求。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><strong>分组查询</strong></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">我们来看另一个查询需求，假设要统计每个设备（deviceID）上数据的分布情况：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">用SQL，需要33s：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';">
    <pre><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">SELECT</span> deviceID,<span style="color:rgb(255,0,255);font-size:12px;line-height:1.5;">Count</span>(<span style="color:rgb(128,128,128);font-size:12px;line-height:1.5;">*</span>) <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">FROM</span> `tf_hotspotdata_copy_test` <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">GROUP</span> <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">BY</span> deviceID;</pre>
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">同样的查询，在对CollectTime建立索引之后，只要14s了。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">看看Solr的Facet查询，只要540ms，快的不是一点点。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>SolrQuery query = <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> SolrQuery();
query.set(</span>"q", "*:*"<span style="font-size:12px;line-height:1.5;">);
query.setFacet(</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">true</span><span style="font-size:12px;line-height:1.5;">);
query.addFacetField(</span>"DeviceID"<span style="font-size:12px;line-height:1.5;">);
QueryResponse response </span>=<span style="font-size:12px;line-height:1.5;"> server.query(query);
FacetField idFacetField </span>= response.getFacetField("DeviceID"<span style="font-size:12px;line-height:1.5;">);
List</span>&lt;Count&gt; idCounts =<span style="font-size:12px;line-height:1.5;"> idFacetField.getValues();
</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span><span style="font-size:12px;line-height:1.5;"> (Count count : idCounts) {
    System.out.println(count.getName()</span>+": "+<span style="font-size:12px;line-height:1.5;">count.getCount());
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">时间对比：</p> 
   <table border="1" style="border-collapse:collapse;border-spacing:0px;border:1px solid #C0C0C0;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">
    <tbody>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p align="center">查询条件（统计）</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p align="center">时间</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>MySQL（无索引）</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>33s</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>MySQL（有索引）</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>14s</p> </td> 
     </tr>
     <tr>
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>Solrj（Facet查询）</p> </td> 
      <td valign="top" style="border:1px solid #C0C0C0;border-collapse:collapse;"> <p>0.54s</p> </td> 
     </tr>
    </tbody>
   </table>
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">如果我们要查询某台设备在某个时间段上按“时”、“周”、“月”、“年”进行数据统计，Solr也是很方便的，比如以下按天统计设备号为1013上的数据：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-size:15px;font-family:'Courier New';"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>    String startTime = "2014-12-06 00:00:00"<span style="font-size:12px;line-height:1.5;">;
    String endTime </span>= "2014-12-16 21:31:55"<span style="font-size:12px;line-height:1.5;">;   
    SolrQuery query </span>= <span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">new</span><span style="font-size:12px;line-height:1.5;"> SolrQuery();
    query.set(</span>"q", "DeviceID:1013"<span style="font-size:12px;line-height:1.5;">);
    query.setFacet(</span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">true</span><span style="font-size:12px;line-height:1.5;">);
    Date start </span>=<span style="font-size:12px;line-height:1.5;"> DateFormatHelper.ToSolrSearchDate(DateFormatHelper.StringToDate(startTime));
    Date end </span>=<span style="font-size:12px;line-height:1.5;"> DateFormatHelper.ToSolrSearchDate(DateFormatHelper.StringToDate(endTime));
    query.addDateRangeFacet(</span>"CollectTime", start, end, "+1DAY"<span style="font-size:12px;line-height:1.5;">);
    QueryResponse response </span>=<span style="font-size:12px;line-height:1.5;"> server.query(query);

    List</span>&lt;RangeFacet&gt; dateFacetFields =<span style="font-size:12px;line-height:1.5;"> response.getFacetRanges();
    </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span><span style="font-size:12px;line-height:1.5;"> (RangeFacet facetField : dateFacetFields{
        List</span>&lt;org.apache.solr.client.solrj.response.RangeFacet.Count&gt; dateCounts=<span style="font-size:12px;line-height:1.5;"> facetField.getCounts();
        </span><span style="color:rgb(0,0,255);font-size:12px;line-height:1.5;">for</span><span style="font-size:12px;line-height:1.5;"> (org.apache.solr.client.solrj.response.RangeFacet.Count count : dateCounts) {
            System.out.println(count.getValue()</span>+": "+<span style="font-size:12px;line-height:1.5;">count.getCount());
        }
    }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="font-size:12px;line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">这里为什么Solr/Lucene的Facet（聚合）查询会这么快呢？</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">想想Solr/Lucene的索引数据的方式就清楚了：倒排索引。对于某个索引字段，该字段下有哪几个值，对于每个值，对应的文档集合是建立索引的时候就清楚的，做聚合操作的时候“统计”下就知道结果了。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">如果通过docValues建立索引，对于这类Facet查询会更快，因为这时候索引已经通过字段（列）分割好了，只需要去对应文件中查询统计就行了，如上文所述，通过“内存映射”，将该索引文件映射到内存，只需要在内存里统计下结果就出来了，所以就非常快。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">水平拆分表：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">由于本系统采集到的大量数据和“时间”有很大关系，一些业务需求根据“时间”来查询也比较多，可以按“时间”字段进行拆分表，比如按每月一张表来拆分，但是这样做应用层代码就需要做更多的事情，一些跨表的查询也需要更多的工作。综合考虑了表拆分和使用Solr来做索引查询的工作量后，还是采用了Solr。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">总结：在MySQL的基础上，配合Lucene、Solr、ElasticSearch等搜索引擎，可以提高类似全文检索、分类统计等查询性能。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">参考：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">http://wiki.apache.org/solr/</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">https://lucidworks.com/blog/2013/04/02/fun-with-docvalues-in-solr-4-2/</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;">&nbsp;</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:15px;"><br></p> 
   <p><font color="#333333"><span style="font-size:15px;">&nbsp; &nbsp; 本文转自阿凡卢博客园博客，原文链接：http://www.cnblogs.com/luxiaoxun/p/4696477.html</span></font><span style="font-size:15px;color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;">，如需转载请自行联系原作者</span></p> 
   <div>
    <br>
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
