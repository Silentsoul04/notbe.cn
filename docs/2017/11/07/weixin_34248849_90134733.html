<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Dot Net下实现屏幕图像差异获取v1.0 « NotBeCN</title>
  <meta name="description" content="             &nbsp;开发平台：VS 2008,Windows xp sp2    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 效果截图：    &nbsp;                  图1 软件界面图           &nbsp;                 图...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/11/07/weixin_34248849_90134733.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">Dot Net下实现屏幕图像差异获取v1.0</h1>
    <p class="post-meta">Nov 7, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;开发平台：VS 2008,Windows xp sp2</p> 
   <p style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 效果截图：</p> 
   <p style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;</p> 
   <p style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"></p> 
   <div style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"> 
    <img alt="" src="https://images.cnblogs.com/cnblogs_com/stg609/%E5%B7%AE%E5%BC%82%E5%9B%BE%E7%89%87%E8%8E%B7%E5%8F%96v1.0.jpg" width="446" height="457" style="border:0px;">
    <br> 图1 软件界面图
   </div> 
   <div style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">
    &nbsp;
   </div> 
   <div style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"> 
    <img alt="" src="https://images.cnblogs.com/cnblogs_com/stg609/129038963504062500.JPG" width="19" height="43" style="border:0px;">
    <br> 图2 差异结果图
    <br>
   </div> 
   <p style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 图片说明：第一幅图展示的是我所实现的这个软件的最终效果图，通过菜单栏的按键可以选择两幅有差异的图片（要求是相同大小，24位或以上颜色，目的是模仿系统屏幕截图），然后对图片进行比较后，就会截取出差异部分，并将该图片保存到E盘根目录，也就是上面的差异结果图。</p> 
   <p style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;</p> 
   <p style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 最近项目中要实现屏幕传输和控制功能，其中主要的就是屏幕传输功能。“不就是屏幕传输嘛，简单呀~~建立个线程，隔一定时间截取一下屏幕的图片，然后发送给对方不就成了。”这是我最初的想法，我也按照这个办法做了，当看到屏幕从一台电脑成功传到了另一台电脑时（局域网内），我有点高兴，心里暗想“原来远程控制也不过如此”。当然，事情的发展并不如预期中那样完美，事实上，我所实现的远程控制几乎没有任何价值，因为延迟太大，一副屏幕的截图从截取到发送到再显示出来，整个过程至少要耗费2秒多的时间。这是什么概念呢？我们可以比较一下，标准的卡通片是24fps，也就是每秒24帧，这样才会流畅；如果你玩过极品飞车，会发现极品飞车一般的帧数会保持在40以上（之所以说一般，是因为帧数和具体的显卡有关）。而现在我所实现的这个帧数是0.5，极品飞车的帧数是我的80倍，当你玩极品飞车的时候，画面每2秒才刷新一次，你就会知道我的实现有多烂了。不过这些帧数都是对流畅性要求极高的环境来说的，对于远程控制这种每秒画面变化不大的情况，就没必要这么高要求了，只要能保持在6帧每秒就几乎可以达到流畅的感受了。</p> 
   <p style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;&nbsp;&nbsp;&nbsp; 屏幕传输主要分为“截图-&gt;压缩-&gt;传输-&gt;解压-&gt;显示”这几个步骤，传输、压缩、解压及显示几乎很难有明显的性能提升，因此主要能改进的就是“截图”这个过程。单纯的全屏截图，我尝试过最快每秒也就7、8帧，无法实现更高的速度。（我截屏利用的GDI+方式，而并非是用DirectX来做，DirectX更能发挥显卡的性能，但是我没有尝试过。）7、8帧的速度是不是可以了呢？这是不够的，因为这只是单纯的截图，并没有加上网络传输、压缩解压等，因此必须要有更快的速度。而且，此种方式，每秒需要传输的数据量是相当惊人的。拿我的电脑1280*800的分辨率来说，按24位颜色质量存储的话，一张图需要2.9M，按每秒7帧来算需要20.3M。每秒需要传输20.3M，这对于现有的网络带宽来说是承受不了的。</p> 
   <p style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 翻阅了很多网上达人的文章，发现通常用于屏幕传输的方法主要是传输前后两幅图片的不同之处。而查找不同之处的算法又主要有两类：隔行查找和分块比较。翻阅了很多，主要是以Delphi下的实现为主，尤其以DG老大为代表的实现方式。由于本人从未用过Delphi，对C++也有多年未用了，因此在研究DG老大的代码（DGScreenSpy_0.2c）上着实花了不少时间，现在也只能算是懂了个基本。在我自己的实现方式，并非只是简单的对DG老大代码的翻译，根据我自己的理解，我的算法思路如下：</p> 
   <p style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>首先对两张图片的数据按照从上到下从左到右的方式进行扫描，考虑到在实际的环境下，一个图标或一个窗口肯定会横向和纵向跨好几个像素，因此用了两个参数来分别表示步进值。扫描的过程中用一个矩形区域来表示当前变化的范围，这个范围在整个扫描过程中会随时进行调整以适应变化的区域。</strong></p> 
   <p style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 下面举个例子来说明区域的设置：从第0行开始扫描，没有发现该行内的像素不同，加上步进的数值后（假如是3），扫描接着从第4（3+1）行开始，在该行的扫描中发现第2个像素到第10个像素（基数为0）都不同，于是设置矩形的Top边为4，Left为2，Right为11，Bottom为5。接着扫描第8行，发现这一行中第0个像素到第8个像素不一样，则调整矩形的区域（Top:4,Left:0,Right:11,Bottom:9），依次类推直到扫描到一行全都相同或扫描完最后一行时，这个矩形的区域则正式确定。这样该区域的图形就是最小的变化范围。</strong></p> 
   <p style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 这是大概的思路，具体的大家可以参考我的代码。按照这种方式，可以获取变化的最小区域，如果变化不多，则图片数据量明显变少，如果变化很多或干脆整个屏幕都不一样，那图片数据量仍然会很大，因此还需要进一步对图片数据进行压缩或采取降低图片颜色质量的方式，QQ的远程屏幕传输就降低了图片的质量，估计其图片质量为16位每像素。</p> 
   <p style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 为了专门研究图片差异的获取，所以并没有实现其他诸如压缩、传输的功能。其中对像素的比较用的是BitmapData.Scan0来获取像素指针的方式进行比较，因为这样比较速度最快。我在测试时发现，我的这种实现方式（以我设置的步进值为基准）一次比较需要0.15秒左右（包括了存储差异部分到本地文件的时间，大约耗时0.04秒），速度上仍然有待提升。改变步进值可以适当的调节速度，但也会影响到变化区域的准确性。</p> 
   <p style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>本着合作共赢的想法，提供我的代码供大家参考，希望大家在看了我的思路和代码后，能提出宝贵的意见，我会根据您的意见思路对代码进行不断改进，每一次重大改进我都会把代码发布出来。</strong>希望能早日完成一款Dot Net下的远程控制佳作。以下是核心代码：</p> 
   <p style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <img class="code_img_closed" alt="" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" style="border:0px;vertical-align:middle;">
    <span class="cnblogs_code_collapse" style="border:1px solid #808080;line-height:1.5;">FindDifferences</span> 
   </div> 
   <p style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;项目打包下载：<a href="http://files.cnblogs.com/stg609/Pic.rar" rel="nofollow" style="color:rgb(120,175,211);">http://files.cnblogs.com/stg609/Pic.rar</a></p> 
   <p style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;">&nbsp;参考：<a href="http://iamgyg.blog.163.com/" rel="nofollow" style="color:rgb(120,175,211);">http://iamgyg.blog.163.com/</a></p> 
   <p style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><br></p> 
   <p style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><br></p> 
   <p style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><br></p> 
   <p style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><br></p> 
   <p style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><br></p> 
   <p style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><br></p> 
   <p style="font-family:'black Verdana', Arial, Helvetica, sans-serif;font-size:14px;line-height:21px;"><br></p> 
   <p><font><span style="font-size:14px;line-height:21px;">本文转自stg609博客园博客，原文链接：http://www.cnblogs.com/stg609/archive/2009/11/28/1612778.html，如需转载请自行联系原作者</span></font><br></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
