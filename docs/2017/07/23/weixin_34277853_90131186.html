<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>linux下实现在程序运行时的函数替换(热补丁)【转】 « NotBeCN</title>
  <meta name="description" content="             转自：http://www.cnblogs.com/leo0000/p/5632642.html    声明：以下的代码成果，是参考了网上的injso技术，在本文的最后会给出地址，同时非常感谢injso技术原作者的分享。    　　　但是injso文章中的代码存在一些问题，所以后面出现的...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/07/23/weixin_34277853_90131186.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">linux下实现在程序运行时的函数替换(热补丁)【转】</h1>
    <p class="post-meta">Jul 23, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p>转自：<a href="http://www.cnblogs.com/leo0000/p/5632642.html" rel="nofollow">http://www.cnblogs.com/leo0000/p/5632642.html</a></p> 
   <p>声明：以下的代码成果，是参考了网上的injso技术，在本文的最后会给出地址，同时非常感谢injso技术原作者的分享。</p> 
   <p>　　　但是injso文章中的代码存在一些问题，所以后面出现的代码是经过作者修改和检测的。也正因为这些错误，加深了我的学习深度。</p> 
   <p>&nbsp;</p> 
   <p>　　最近因为在学习一些调试的技术，但是很少有提到如何在函数运行时实现函数替换的。</p> 
   <p>　　为什么会想到这一点？因为在学习调试时，难免会看到一些内核方面的调试技术，内核中的调试有一个kprobe，很强大，可以实现运行时的函数替换。其原理就是hook，钩子，但是学习了这个kprobe之后会发现，kprobe内部有检测所要钩的函数是不是属于内核空间，必须是内核函数才能实现替换。而实际上，我的工作大部分还是在应用层的，所以想要实现应用程序的热补丁技术。</p> 
   <p>　　一些基础的知识这边的就不展开了，需要的基础有，elf文件格式，ptrace，waitpid，应用程序间通信时的信号，汇编。</p> 
   <ul>
    <li>1、elf文件加载过程</li> 
   </ul>
   <p>　　elf简单地说是由以下四部分组成的，elf文件头，program header和section header，内容。其中program header是运行时使用的，而section header并不会被加载进程序运行空间，但他们可以在编译时被指定该段的加载地址等信息，当然一般这个链接脚本.lds是由gcc默认的。</p> 
   <p>　　第一步，加载elf文件头，检验文件类型版本等，重要的是找到program header的地址和header的个数，如果连接器脚本是默认的，那么elf文件头会被加载在0x804800地址处。</p> 
   <p>　　第二步，加载program header，接着扫描program header，找到一个类型为PT_INTERP的program header，这个header里面放着的是有关解释器的地址，这时候将解释器程序的elf文件头加载进来。一般是这样：</p> 
   <p>　　　　　　INTERP 0x000134 0x08048134 0x08048134 0x00013 0x00013 R 0x1<br>　　　　　　　　[Requesting program interpreter: /lib/ld-linux.so.2]</p> 
   <p>　　第三步，扫描program header，如果类型为PT_LOAD，则将该段加载进来。</p> 
   <p>　　第四步，判断是否需要解释器程序，如果需要，把解释器程序加载进来，并把程序入口设置为解释器程序的地址。否则是应用程序本身的入口。反汇编为_start标号。</p> 
   <p>　　第五步，设置命令行传入的参数等应用程序需要的信息。</p> 
   <p>　　第六步，解释器程序开始运行，加载程序需要的库，填写重定向符号表中的地址信息。</p> 
   <ul>
    <li>2.elf文件动态链接过程</li> 
   </ul>
   <p>　　上一步，解释器程序根据program header已经将应用程序的段都加载进内存了，接下来再扫描program header，找到类型为PT_DYNAMIC，这里面包含了很多由section header描述的内容，包括重定向表，符号表，字符串表等等。解释器需要这个段描述的一些信息。</p> 
   <p>　　DT_NEEDED描述了所需要的动态库名称，DT_REL描述了重定位表地址，DT_JMPREL描述了重定位表地址(这个表是懒惰链接使用的)，DT_PLTGOT全局偏移表地址。</p> 
   <p>　　此时解释器程序就可以根据所需要的动态库，将其加载进内存。每一个被加载进来的库的相关信息会被记录在link_map结构中，这个结构是一个链表，保存了所有的动态信息。</p> 
   <p>　　其中，全局偏移表got，got[0]保存了PT_DYNAMIC的起始地址，got[1]保存link_map的地址，而link_map中就可以找到PT_DYNAMIC的起始地址，和下一个或者上一个共享文件或者可执行文件的link_map地址。</p> 
   <p>　　DT_REL这个重定向表中的符号必须在此时就被解析完成。</p> 
   <p>　　而DT_JMPREL这个重定向表中的符号可以在运行时再解析。</p> 
   <p>　　所有的库和符号全部解析完成之后，解释器程序就会把控制权交给可执行文件的_start。程序开始执行。</p> 
   <ul>
    <li>3.替换函数和被替换函数</li> 
   </ul>
   <p>　　被替换程序源码。　</p> 
   <div class="cnblogs_Highlighter sh-gutter"> 
    <div> 
     <div class="syntaxhighlighter csharp"> 
      <table border="0">
       <tbody>
        <tr>
         <td class="gutter"> 
          <div class="line number1 index0 alt2">
           1
          </div> 
          <div class="line number2 index1 alt1">
           2
          </div> 
          <div class="line number3 index2 alt2">
           3
          </div> 
          <div class="line number4 index3 alt1">
           4
          </div> 
          <div class="line number5 index4 alt2">
           5
          </div> 
          <div class="line number6 index5 alt1">
           6
          </div> 
          <div class="line number7 index6 alt2">
           7
          </div> 
          <div class="line number8 index7 alt1">
           8
          </div> 
          <div class="line number9 index8 alt2">
           9
          </div> </td> 
         <td class="code"> 
          <div> 
           <div class="line number1 index0 alt2">
            <code class="csharp preprocessor">#include &lt;stdio.h&gt;</code>
           </div> 
           <div class="line number2 index1 alt1">
            <code class="csharp preprocessor">#include &lt;time.h&gt;</code>
           </div> 
           <div class="line number3 index2 alt2"> 
            <code class="csharp keyword">int</code>&nbsp;
            <code class="csharp plain">main()</code> 
           </div> 
           <div class="line number4 index3 alt1">
            <code class="csharp plain">{</code>
           </div> 
           <div class="line number5 index4 alt2"> 
            <code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp keyword">while</code>
            <code class="csharp plain">(1){</code> 
           </div> 
           <div class="line number6 index5 alt1"> 
            <code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp plain">sleep(10);</code> 
           </div> 
           <div class="line number7 index6 alt2"> 
            <code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp plain">printf(</code>
            <code class="csharp string">"%d : original\n"</code>
            <code class="csharp plain">,time(0));</code> 
           </div> 
           <div class="line number8 index7 alt1"> 
            <code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="csharp plain">}</code> 
           </div> 
           <div class="line number9 index8 alt2">
            <code class="csharp plain">}</code>
           </div> 
          </div> </td> 
        </tr>
       </tbody>
      </table>
     </div> 
    </div> 
   </div> 
   <p>　　替换新库代码。</p> 
   <div class="cnblogs_Highlighter sh-gutter"> 
    <div> 
     <div class="syntaxhighlighter cpp"> 
      <table border="0">
       <tbody>
        <tr>
         <td class="gutter"> 
          <div class="line number1 index0 alt2">
           1
          </div> 
          <div class="line number2 index1 alt1">
           2
          </div> 
          <div class="line number3 index2 alt2">
           3
          </div> 
          <div class="line number4 index3 alt1">
           4
          </div> 
          <div class="line number5 index4 alt2">
           5
          </div> 
          <div class="line number6 index5 alt1">
           6
          </div> 
          <div class="line number7 index6 alt2">
           7
          </div> </td> 
         <td class="code"> 
          <div> 
           <div class="line number1 index0 alt2">
            <code class="cpp preprocessor">#include &lt;stdio.h&gt;</code>
           </div> 
           <div class="line number2 index1 alt1">
            &nbsp;
           </div> 
           <div class="line number3 index2 alt2"> 
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">newmyprint()</code> 
           </div> 
           <div class="line number4 index3 alt1">
            <code class="cpp plain">{</code>
           </div> 
           <div class="line number5 index4 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">write(1,</code>
            <code class="cpp string">"hahahahahahaha"</code>
            <code class="cpp plain">,14);</code> 
           </div> 
           <div class="line number6 index5 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">return</code>&nbsp;
            <code class="cpp plain">0;</code> 
           </div> 
           <div class="line number7 index6 alt2">
            <code class="cpp plain">}</code>
           </div> 
          </div> </td> 
        </tr>
       </tbody>
      </table>
     </div> 
    </div> 
   </div> 
   <p>　　够简单明了吧，如果替换成功，目标程序将会一直输出“哈哈哈哈哈哈”。</p> 
   <ul>
    <li>4.功能函数　　</li> 
   </ul>
   <p>　　ptrace相关代码：</p> 
   <div class="cnblogs_Highlighter sh-gutter"> 
    <div> 
     <div class="syntaxhighlighter cpp"> 
      <table border="0">
       <tbody>
        <tr>
         <td class="gutter"> 
          <div class="line number1 index0 alt2">
           1
          </div> 
          <div class="line number2 index1 alt1">
           2
          </div> 
          <div class="line number3 index2 alt2">
           3
          </div> 
          <div class="line number4 index3 alt1">
           4
          </div> 
          <div class="line number5 index4 alt2">
           5
          </div> 
          <div class="line number6 index5 alt1">
           6
          </div> 
          <div class="line number7 index6 alt2">
           7
          </div> 
          <div class="line number8 index7 alt1">
           8
          </div> 
          <div class="line number9 index8 alt2">
           9
          </div> 
          <div class="line number10 index9 alt1">
           10
          </div> 
          <div class="line number11 index10 alt2">
           11
          </div> 
          <div class="line number12 index11 alt1">
           12
          </div> 
          <div class="line number13 index12 alt2">
           13
          </div> 
          <div class="line number14 index13 alt1">
           14
          </div> 
          <div class="line number15 index14 alt2">
           15
          </div> 
          <div class="line number16 index15 alt1">
           16
          </div> 
          <div class="line number17 index16 alt2">
           17
          </div> 
          <div class="line number18 index17 alt1">
           18
          </div> 
          <div class="line number19 index18 alt2">
           19
          </div> 
          <div class="line number20 index19 alt1">
           20
          </div> 
          <div class="line number21 index20 alt2">
           21
          </div> 
          <div class="line number22 index21 alt1">
           22
          </div> 
          <div class="line number23 index22 alt2">
           23
          </div> 
          <div class="line number24 index23 alt1">
           24
          </div> 
          <div class="line number25 index24 alt2">
           25
          </div> 
          <div class="line number26 index25 alt1">
           26
          </div> 
          <div class="line number27 index26 alt2">
           27
          </div> 
          <div class="line number28 index27 alt1">
           28
          </div> 
          <div class="line number29 index28 alt2">
           29
          </div> 
          <div class="line number30 index29 alt1">
           30
          </div> 
          <div class="line number31 index30 alt2">
           31
          </div> 
          <div class="line number32 index31 alt1">
           32
          </div> 
          <div class="line number33 index32 alt2">
           33
          </div> 
          <div class="line number34 index33 alt1">
           34
          </div> 
          <div class="line number35 index34 alt2">
           35
          </div> 
          <div class="line number36 index35 alt1">
           36
          </div> 
          <div class="line number37 index36 alt2">
           37
          </div> 
          <div class="line number38 index37 alt1">
           38
          </div> 
          <div class="line number39 index38 alt2">
           39
          </div> 
          <div class="line number40 index39 alt1">
           40
          </div> 
          <div class="line number41 index40 alt2">
           41
          </div> 
          <div class="line number42 index41 alt1">
           42
          </div> 
          <div class="line number43 index42 alt2">
           43
          </div> 
          <div class="line number44 index43 alt1">
           44
          </div> 
          <div class="line number45 index44 alt2">
           45
          </div> 
          <div class="line number46 index45 alt1">
           46
          </div> 
          <div class="line number47 index46 alt2">
           47
          </div> 
          <div class="line number48 index47 alt1">
           48
          </div> 
          <div class="line number49 index48 alt2">
           49
          </div> 
          <div class="line number50 index49 alt1">
           50
          </div> 
          <div class="line number51 index50 alt2">
           51
          </div> 
          <div class="line number52 index51 alt1">
           52
          </div> 
          <div class="line number53 index52 alt2">
           53
          </div> 
          <div class="line number54 index53 alt1">
           54
          </div> 
          <div class="line number55 index54 alt2">
           55
          </div> 
          <div class="line number56 index55 alt1">
           56
          </div> 
          <div class="line number57 index56 alt2">
           57
          </div> 
          <div class="line number58 index57 alt1">
           58
          </div> 
          <div class="line number59 index58 alt2">
           59
          </div> 
          <div class="line number60 index59 alt1">
           60
          </div> 
          <div class="line number61 index60 alt2">
           61
          </div> 
          <div class="line number62 index61 alt1">
           62
          </div> 
          <div class="line number63 index62 alt2">
           63
          </div> 
          <div class="line number64 index63 alt1">
           64
          </div> 
          <div class="line number65 index64 alt2">
           65
          </div> 
          <div class="line number66 index65 alt1">
           66
          </div> 
          <div class="line number67 index66 alt2">
           67
          </div> 
          <div class="line number68 index67 alt1">
           68
          </div> 
          <div class="line number69 index68 alt2">
           69
          </div> 
          <div class="line number70 index69 alt1">
           70
          </div> 
          <div class="line number71 index70 alt2">
           71
          </div> 
          <div class="line number72 index71 alt1">
           72
          </div> 
          <div class="line number73 index72 alt2">
           73
          </div> 
          <div class="line number74 index73 alt1">
           74
          </div> 
          <div class="line number75 index74 alt2">
           75
          </div> 
          <div class="line number76 index75 alt1">
           76
          </div> 
          <div class="line number77 index76 alt2">
           77
          </div> 
          <div class="line number78 index77 alt1">
           78
          </div> 
          <div class="line number79 index78 alt2">
           79
          </div> 
          <div class="line number80 index79 alt1">
           80
          </div> 
          <div class="line number81 index80 alt2">
           81
          </div> 
          <div class="line number82 index81 alt1">
           82
          </div> 
          <div class="line number83 index82 alt2">
           83
          </div> 
          <div class="line number84 index83 alt1">
           84
          </div> 
          <div class="line number85 index84 alt2">
           85
          </div> 
          <div class="line number86 index85 alt1">
           86
          </div> 
          <div class="line number87 index86 alt2">
           87
          </div> 
          <div class="line number88 index87 alt1">
           88
          </div> 
          <div class="line number89 index88 alt2">
           89
          </div> 
          <div class="line number90 index89 alt1">
           90
          </div> 
          <div class="line number91 index90 alt2">
           91
          </div> 
          <div class="line number92 index91 alt1">
           92
          </div> 
          <div class="line number93 index92 alt2">
           93
          </div> 
          <div class="line number94 index93 alt1">
           94
          </div> 
          <div class="line number95 index94 alt2">
           95
          </div> 
          <div class="line number96 index95 alt1">
           96
          </div> 
          <div class="line number97 index96 alt2">
           97
          </div> 
          <div class="line number98 index97 alt1">
           98
          </div> 
          <div class="line number99 index98 alt2">
           99
          </div> 
          <div class="line number100 index99 alt1">
           100
          </div> 
          <div class="line number101 index100 alt2">
           101
          </div> 
          <div class="line number102 index101 alt1">
           102
          </div> 
          <div class="line number103 index102 alt2">
           103
          </div> 
          <div class="line number104 index103 alt1">
           104
          </div> 
          <div class="line number105 index104 alt2">
           105
          </div> 
          <div class="line number106 index105 alt1">
           106
          </div> 
          <div class="line number107 index106 alt2">
           107
          </div> 
          <div class="line number108 index107 alt1">
           108
          </div> 
          <div class="line number109 index108 alt2">
           109
          </div> 
          <div class="line number110 index109 alt1">
           110
          </div> 
          <div class="line number111 index110 alt2">
           111
          </div> 
          <div class="line number112 index111 alt1">
           112
          </div> 
          <div class="line number113 index112 alt2">
           113
          </div> 
          <div class="line number114 index113 alt1">
           114
          </div> 
          <div class="line number115 index114 alt2">
           115
          </div> 
          <div class="line number116 index115 alt1">
           116
          </div> 
          <div class="line number117 index116 alt2">
           117
          </div> 
          <div class="line number118 index117 alt1">
           118
          </div> 
          <div class="line number119 index118 alt2">
           119
          </div> 
          <div class="line number120 index119 alt1">
           120
          </div> 
          <div class="line number121 index120 alt2">
           121
          </div> 
          <div class="line number122 index121 alt1">
           122
          </div> 
          <div class="line number123 index122 alt2">
           123
          </div> 
          <div class="line number124 index123 alt1">
           124
          </div> 
          <div class="line number125 index124 alt2">
           125
          </div> 
          <div class="line number126 index125 alt1">
           126
          </div> 
          <div class="line number127 index126 alt2">
           127
          </div> 
          <div class="line number128 index127 alt1">
           128
          </div> 
          <div class="line number129 index128 alt2">
           129
          </div> 
          <div class="line number130 index129 alt1">
           130
          </div> 
          <div class="line number131 index130 alt2">
           131
          </div> 
          <div class="line number132 index131 alt1">
           132
          </div> 
          <div class="line number133 index132 alt2">
           133
          </div> 
          <div class="line number134 index133 alt1">
           134
          </div> 
          <div class="line number135 index134 alt2">
           135
          </div> 
          <div class="line number136 index135 alt1">
           136
          </div> 
          <div class="line number137 index136 alt2">
           137
          </div> 
          <div class="line number138 index137 alt1">
           138
          </div> 
          <div class="line number139 index138 alt2">
           139
          </div> 
          <div class="line number140 index139 alt1">
           140
          </div> 
          <div class="line number141 index140 alt2">
           141
          </div> 
          <div class="line number142 index141 alt1">
           142
          </div> 
          <div class="line number143 index142 alt2">
           143
          </div> 
          <div class="line number144 index143 alt1">
           144
          </div> 
          <div class="line number145 index144 alt2">
           145
          </div> 
          <div class="line number146 index145 alt1">
           146
          </div> 
          <div class="line number147 index146 alt2">
           147
          </div> 
          <div class="line number148 index147 alt1">
           148
          </div> 
          <div class="line number149 index148 alt2">
           149
          </div> 
          <div class="line number150 index149 alt1">
           150
          </div> 
          <div class="line number151 index150 alt2">
           151
          </div> 
          <div class="line number152 index151 alt1">
           152
          </div> 
          <div class="line number153 index152 alt2">
           153
          </div> 
          <div class="line number154 index153 alt1">
           154
          </div> 
          <div class="line number155 index154 alt2">
           155
          </div> 
          <div class="line number156 index155 alt1">
           156
          </div> 
          <div class="line number157 index156 alt2">
           157
          </div> 
          <div class="line number158 index157 alt1">
           158
          </div> 
          <div class="line number159 index158 alt2">
           159
          </div> 
          <div class="line number160 index159 alt1">
           160
          </div> 
          <div class="line number161 index160 alt2">
           161
          </div> 
          <div class="line number162 index161 alt1">
           162
          </div> 
          <div class="line number163 index162 alt2">
           163
          </div> 
          <div class="line number164 index163 alt1">
           164
          </div> 
          <div class="line number165 index164 alt2">
           165
          </div> 
          <div class="line number166 index165 alt1">
           166
          </div> 
          <div class="line number167 index166 alt2">
           167
          </div> 
          <div class="line number168 index167 alt1">
           168
          </div> 
          <div class="line number169 index168 alt2">
           169
          </div> 
          <div class="line number170 index169 alt1">
           170
          </div> 
          <div class="line number171 index170 alt2">
           171
          </div> 
          <div class="line number172 index171 alt1">
           172
          </div> 
          <div class="line number173 index172 alt2">
           173
          </div> 
          <div class="line number174 index173 alt1">
           174
          </div> 
          <div class="line number175 index174 alt2">
           175
          </div> 
          <div class="line number176 index175 alt1">
           176
          </div> 
          <div class="line number177 index176 alt2">
           177
          </div> 
          <div class="line number178 index177 alt1">
           178
          </div> 
          <div class="line number179 index178 alt2">
           179
          </div> 
          <div class="line number180 index179 alt1">
           180
          </div> 
          <div class="line number181 index180 alt2">
           181
          </div> 
          <div class="line number182 index181 alt1">
           182
          </div> 
          <div class="line number183 index182 alt2">
           183
          </div> 
          <div class="line number184 index183 alt1">
           184
          </div> 
          <div class="line number185 index184 alt2">
           185
          </div> 
          <div class="line number186 index185 alt1">
           186
          </div> 
          <div class="line number187 index186 alt2">
           187
          </div> 
          <div class="line number188 index187 alt1">
           188
          </div> 
          <div class="line number189 index188 alt2">
           189
          </div> 
          <div class="line number190 index189 alt1">
           190
          </div> 
          <div class="line number191 index190 alt2">
           191
          </div> 
          <div class="line number192 index191 alt1">
           192
          </div> 
          <div class="line number193 index192 alt2">
           193
          </div> 
          <div class="line number194 index193 alt1">
           194
          </div> 
          <div class="line number195 index194 alt2">
           195
          </div> 
          <div class="line number196 index195 alt1">
           196
          </div> 
          <div class="line number197 index196 alt2">
           197
          </div> 
          <div class="line number198 index197 alt1">
           198
          </div> 
          <div class="line number199 index198 alt2">
           199
          </div> 
          <div class="line number200 index199 alt1">
           200
          </div> 
          <div class="line number201 index200 alt2">
           201
          </div> 
          <div class="line number202 index201 alt1">
           202
          </div> 
          <div class="line number203 index202 alt2">
           203
          </div> 
          <div class="line number204 index203 alt1">
           204
          </div> 
          <div class="line number205 index204 alt2">
           205
          </div> 
          <div class="line number206 index205 alt1">
           206
          </div> 
          <div class="line number207 index206 alt2">
           207
          </div> 
          <div class="line number208 index207 alt1">
           208
          </div> 
          <div class="line number209 index208 alt2">
           209
          </div> 
          <div class="line number210 index209 alt1">
           210
          </div> 
          <div class="line number211 index210 alt2">
           211
          </div> 
          <div class="line number212 index211 alt1">
           212
          </div> 
          <div class="line number213 index212 alt2">
           213
          </div> 
          <div class="line number214 index213 alt1">
           214
          </div> 
          <div class="line number215 index214 alt2">
           215
          </div> 
          <div class="line number216 index215 alt1">
           216
          </div> 
          <div class="line number217 index216 alt2">
           217
          </div> 
          <div class="line number218 index217 alt1">
           218
          </div> 
          <div class="line number219 index218 alt2">
           219
          </div> 
          <div class="line number220 index219 alt1">
           220
          </div> 
          <div class="line number221 index220 alt2">
           221
          </div> 
          <div class="line number222 index221 alt1">
           222
          </div> 
          <div class="line number223 index222 alt2">
           223
          </div> 
          <div class="line number224 index223 alt1">
           224
          </div> 
          <div class="line number225 index224 alt2">
           225
          </div> 
          <div class="line number226 index225 alt1">
           226
          </div> 
          <div class="line number227 index226 alt2">
           227
          </div> </td> 
         <td class="code"> 
          <div> 
           <div class="line number1 index0 alt2">
            <code class="cpp comments">/* 读进程寄存器 */</code>
           </div> 
           <div class="line number2 index1 alt1"> 
            <code class="cpp keyword bold">void</code>&nbsp;
            <code class="cpp plain">ptrace_readreg(</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">pid,&nbsp;</code>
            <code class="cpp keyword bold">struct</code>&nbsp;
            <code class="cpp plain">user_regs_struct *regs)</code> 
           </div> 
           <div class="line number3 index2 alt2">
            <code class="cpp plain">{</code>
           </div> 
           <div class="line number4 index3 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>
            <code class="cpp plain">(ptrace(PTRACE_GETREGS, pid, NULL, regs))</code> 
           </div> 
           <div class="line number5 index4 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">printf</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"*** ptrace_readreg error ***\n"</code>
            <code class="cpp plain">);</code> 
           </div> 
           <div class="line number6 index5 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/*printf("ptrace_readreg\n");</code> 
           </div> 
           <div class="line number7 index6 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;ebx);</code> 
           </div> 
           <div class="line number8 index7 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;ecx);</code> 
           </div> 
           <div class="line number9 index8 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;edx);</code> 
           </div> 
           <div class="line number10 index9 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;esi);</code> 
           </div> 
           <div class="line number11 index10 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;edi);</code> 
           </div> 
           <div class="line number12 index11 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;ebp);</code> 
           </div> 
           <div class="line number13 index12 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;eax);</code> 
           </div> 
           <div class="line number14 index13 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;xds);</code> 
           </div> 
           <div class="line number15 index14 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;xes);</code> 
           </div> 
           <div class="line number16 index15 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;xfs);</code> 
           </div> 
           <div class="line number17 index16 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;xgs);</code> 
           </div> 
           <div class="line number18 index17 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;orig_eax);</code> 
           </div> 
           <div class="line number19 index18 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;eip);</code> 
           </div> 
           <div class="line number20 index19 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;xcs);</code> 
           </div> 
           <div class="line number21 index20 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;eflags);</code> 
           </div> 
           <div class="line number22 index21 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;esp);</code> 
           </div> 
           <div class="line number23 index22 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;xss);*/</code> 
           </div> 
           <div class="line number24 index23 alt1">
            &nbsp;
           </div> 
           <div class="line number25 index24 alt2">
            <code class="cpp plain">}</code>
           </div> 
           <div class="line number26 index25 alt1">
            &nbsp;
           </div> 
           <div class="line number27 index26 alt2">
            <code class="cpp comments">/* 写进程寄存器 */</code>
           </div> 
           <div class="line number28 index27 alt1"> 
            <code class="cpp keyword bold">void</code>&nbsp;
            <code class="cpp plain">ptrace_writereg(</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">pid,&nbsp;</code>
            <code class="cpp keyword bold">struct</code>&nbsp;
            <code class="cpp plain">user_regs_struct *regs)</code> 
           </div> 
           <div class="line number29 index28 alt2">
            <code class="cpp plain">{</code>
           </div> 
           <div class="line number30 index29 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/*printf("ptrace_writereg\n");</code> 
           </div> 
           <div class="line number31 index30 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;ebx);</code> 
           </div> 
           <div class="line number32 index31 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;ecx);</code> 
           </div> 
           <div class="line number33 index32 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;edx);</code> 
           </div> 
           <div class="line number34 index33 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;esi);</code> 
           </div> 
           <div class="line number35 index34 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;edi);</code> 
           </div> 
           <div class="line number36 index35 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;ebp);</code> 
           </div> 
           <div class="line number37 index36 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;eax);</code> 
           </div> 
           <div class="line number38 index37 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;xds);</code> 
           </div> 
           <div class="line number39 index38 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;xes);</code> 
           </div> 
           <div class="line number40 index39 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;xfs);</code> 
           </div> 
           <div class="line number41 index40 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;xgs);</code> 
           </div> 
           <div class="line number42 index41 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;orig_eax);</code> 
           </div> 
           <div class="line number43 index42 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;eip);</code> 
           </div> 
           <div class="line number44 index43 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;xcs);</code> 
           </div> 
           <div class="line number45 index44 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;eflags);</code> 
           </div> 
           <div class="line number46 index45 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;esp);</code> 
           </div> 
           <div class="line number47 index46 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("%x\n",regs-&gt;xss);*/</code> 
           </div> 
           <div class="line number48 index47 alt1">
            &nbsp;
           </div> 
           <div class="line number49 index48 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>
            <code class="cpp plain">(ptrace(PTRACE_SETREGS, pid, NULL, regs))</code> 
           </div> 
           <div class="line number50 index49 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">printf</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"*** ptrace_writereg error ***\n"</code>
            <code class="cpp plain">);</code> 
           </div> 
           <div class="line number51 index50 alt2">
            <code class="cpp plain">}</code>
           </div> 
           <div class="line number52 index51 alt1">
            &nbsp;
           </div> 
           <div class="line number53 index52 alt2">
            <code class="cpp comments">/* 关联到进程 */</code>
           </div> 
           <div class="line number54 index53 alt1"> 
            <code class="cpp keyword bold">void</code>&nbsp;
            <code class="cpp plain">ptrace_attach(</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">pid)</code> 
           </div> 
           <div class="line number55 index54 alt2">
            <code class="cpp plain">{</code>
           </div> 
           <div class="line number56 index55 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>
            <code class="cpp plain">(ptrace(PTRACE_ATTACH, pid, NULL, NULL) &lt; 0) {</code> 
           </div> 
           <div class="line number57 index56 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">perror</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"ptrace_attach"</code>
            <code class="cpp plain">);</code> 
           </div> 
           <div class="line number58 index57 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">exit</code>
            <code class="cpp plain">(-1);</code> 
           </div> 
           <div class="line number59 index58 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number60 index59 alt1">
            &nbsp;
           </div> 
           <div class="line number61 index60 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">waitpid(pid, NULL,&nbsp;</code>
            <code class="cpp comments">/*WUNTRACED*/</code>
            <code class="cpp plain">0);&nbsp;&nbsp;</code> 
           </div> 
           <div class="line number62 index61 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number63 index62 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_readreg(pid, &amp;oldregs);</code> 
           </div> 
           <div class="line number64 index63 alt1">
            <code class="cpp plain">}</code>
           </div> 
           <div class="line number65 index64 alt2">
            &nbsp;
           </div> 
           <div class="line number66 index65 alt1">
            <code class="cpp comments">/* 进程继续 */</code>
           </div> 
           <div class="line number67 index66 alt2"> 
            <code class="cpp keyword bold">void</code>&nbsp;
            <code class="cpp plain">ptrace_cont(</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">pid)</code> 
           </div> 
           <div class="line number68 index67 alt1">
            <code class="cpp plain">{</code>
           </div> 
           <div class="line number69 index68 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">stat;</code> 
           </div> 
           <div class="line number70 index69 alt1">
            &nbsp;
           </div> 
           <div class="line number71 index70 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>
            <code class="cpp plain">(ptrace(PTRACE_CONT, pid, NULL, NULL) &lt; 0) {</code> 
           </div> 
           <div class="line number72 index71 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">perror</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"ptrace_cont"</code>
            <code class="cpp plain">);</code> 
           </div> 
           <div class="line number73 index72 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">exit</code>
            <code class="cpp plain">(-1);</code> 
           </div> 
           <div class="line number74 index73 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number75 index74 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/*while(!WIFSTOPPED(stat))</code> 
           </div> 
           <div class="line number76 index75 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">waitpid(pid, &amp;stat, WNOHANG);*/</code> 
           </div> 
           <div class="line number77 index76 alt2">
            <code class="cpp plain">}</code>
           </div> 
           <div class="line number78 index77 alt1">
            &nbsp;
           </div> 
           <div class="line number79 index78 alt2">
            <code class="cpp comments">/* 脱离进程 */</code>
           </div> 
           <div class="line number80 index79 alt1"> 
            <code class="cpp keyword bold">void</code>&nbsp;
            <code class="cpp plain">ptrace_detach(</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">pid)</code> 
           </div> 
           <div class="line number81 index80 alt2">
            <code class="cpp plain">{</code>
           </div> 
           <div class="line number82 index81 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_writereg(pid, &amp;oldregs);</code> 
           </div> 
           <div class="line number83 index82 alt2">
            &nbsp;
           </div> 
           <div class="line number84 index83 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>
            <code class="cpp plain">(ptrace(PTRACE_DETACH, pid, NULL, NULL) &lt; 0) {</code> 
           </div> 
           <div class="line number85 index84 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">perror</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"ptrace_detach"</code>
            <code class="cpp plain">);</code> 
           </div> 
           <div class="line number86 index85 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">exit</code>
            <code class="cpp plain">(-1);</code> 
           </div> 
           <div class="line number87 index86 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number88 index87 alt1">
            <code class="cpp plain">}</code>
           </div> 
           <div class="line number89 index88 alt2">
            &nbsp;
           </div> 
           <div class="line number90 index89 alt1">
            <code class="cpp comments">/* 写指定进程地址 */</code>
           </div> 
           <div class="line number91 index90 alt2"> 
            <code class="cpp keyword bold">void</code>&nbsp;
            <code class="cpp plain">ptrace_write(</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">pid, unsigned&nbsp;</code>
            <code class="cpp color1 bold">long</code>&nbsp;
            <code class="cpp plain">addr,&nbsp;</code>
            <code class="cpp keyword bold">void</code>&nbsp;
            <code class="cpp plain">*vptr,&nbsp;</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">len)</code> 
           </div> 
           <div class="line number92 index91 alt1">
            <code class="cpp plain">{</code>
           </div> 
           <div class="line number93 index92 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">count;</code> 
           </div> 
           <div class="line number94 index93 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp color1 bold">long</code>&nbsp;
            <code class="cpp plain">word;</code> 
           </div> 
           <div class="line number95 index94 alt2">
            &nbsp;
           </div> 
           <div class="line number96 index95 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">count = 0;</code> 
           </div> 
           <div class="line number97 index96 alt2">
            &nbsp;
           </div> 
           <div class="line number98 index97 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">while</code>
            <code class="cpp plain">(count &lt; len) {</code> 
           </div> 
           <div class="line number99 index98 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">memcpy</code>
            <code class="cpp plain">(&amp;word, vptr + count,&nbsp;</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(word));</code> 
           </div> 
           <div class="line number100 index99 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">word = ptrace(PTRACE_POKETEXT, pid, addr + count, word);</code> 
           </div> 
           <div class="line number101 index100 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">count += 4;</code> 
           </div> 
           <div class="line number102 index101 alt1">
            &nbsp;
           </div> 
           <div class="line number103 index102 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>
            <code class="cpp plain">(</code>
            <code class="cpp functions bold">errno</code>&nbsp;
            <code class="cpp plain">!= 0)</code> 
           </div> 
           <div class="line number104 index103 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">printf</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"ptrace_write failed\t %ld\n"</code>
            <code class="cpp plain">, addr + count);</code> 
           </div> 
           <div class="line number105 index104 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number106 index105 alt1">
            <code class="cpp plain">}</code>
           </div> 
           <div class="line number107 index106 alt2">
            &nbsp;
           </div> 
           <div class="line number108 index107 alt1">
            <code class="cpp comments">/* 读指定进程 */</code>
           </div> 
           <div class="line number109 index108 alt2"> 
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">ptrace_read(</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">pid, unsigned&nbsp;</code>
            <code class="cpp color1 bold">long</code>&nbsp;
            <code class="cpp plain">addr,&nbsp;</code>
            <code class="cpp keyword bold">void</code>&nbsp;
            <code class="cpp plain">*vptr,&nbsp;</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">len)</code> 
           </div> 
           <div class="line number110 index109 alt1">
            <code class="cpp plain">{</code>
           </div> 
           <div class="line number111 index110 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">i,count;</code> 
           </div> 
           <div class="line number112 index111 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp color1 bold">long</code>&nbsp;
            <code class="cpp plain">word;</code> 
           </div> 
           <div class="line number113 index112 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">unsigned&nbsp;</code>
            <code class="cpp color1 bold">long</code>&nbsp;
            <code class="cpp plain">*ptr = (unsigned&nbsp;</code>
            <code class="cpp color1 bold">long</code>&nbsp;
            <code class="cpp plain">*)vptr;</code> 
           </div> 
           <div class="line number114 index113 alt1">
            &nbsp;
           </div> 
           <div class="line number115 index114 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">i = count = 0;</code> 
           </div> 
           <div class="line number116 index115 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("ptrace_read addr = %x\n",addr);</code> 
           </div> 
           <div class="line number117 index116 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">while</code>&nbsp;
            <code class="cpp plain">(count &lt; len) {</code> 
           </div> 
           <div class="line number118 index117 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("ptrace_read addr+count = %x\n",addr + count);</code> 
           </div> 
           <div class="line number119 index118 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">word = ptrace(PTRACE_PEEKTEXT, pid, addr + count, NULL);</code> 
           </div> 
           <div class="line number120 index119 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">while</code>
            <code class="cpp plain">(word &lt; 0)</code> 
           </div> 
           <div class="line number121 index120 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">{</code> 
           </div> 
           <div class="line number122 index121 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>
            <code class="cpp plain">(</code>
            <code class="cpp functions bold">errno</code>&nbsp;
            <code class="cpp plain">== 0)</code> 
           </div> 
           <div class="line number123 index122 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">break</code>
            <code class="cpp plain">;</code> 
           </div> 
           <div class="line number124 index123 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("ptrace_read word = %x\n",word);</code> 
           </div> 
           <div class="line number125 index124 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">perror</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"ptrace_read failed"</code>
            <code class="cpp plain">);</code> 
           </div> 
           <div class="line number126 index125 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">return</code>&nbsp;
            <code class="cpp plain">2;</code> 
           </div> 
           <div class="line number127 index126 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number128 index127 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">count += 4;</code> 
           </div> 
           <div class="line number129 index128 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptr[i++] = word;</code> 
           </div> 
           <div class="line number130 index129 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number131 index130 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">return</code>&nbsp;
            <code class="cpp plain">0;</code> 
           </div> 
           <div class="line number132 index131 alt1">
            <code class="cpp plain">}</code>
           </div> 
           <div class="line number133 index132 alt2">
            &nbsp;
           </div> 
           <div class="line number134 index133 alt1">
            <code class="cpp comments">/*</code>
           </div> 
           <div class="line number135 index134 alt2"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp comments">在进程指定地址读一个字符串</code> 
           </div> 
           <div class="line number136 index135 alt1"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp comments">*/</code> 
           </div> 
           <div class="line number137 index136 alt2"> 
            <code class="cpp color1 bold">char</code>&nbsp;
            <code class="cpp plain">* ptrace_readstr(</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">pid, unsigned&nbsp;</code>
            <code class="cpp color1 bold">long</code>&nbsp;
            <code class="cpp plain">addr)</code> 
           </div> 
           <div class="line number138 index137 alt1">
            <code class="cpp plain">{</code>
           </div> 
           <div class="line number139 index138 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp color1 bold">char</code>&nbsp;
            <code class="cpp plain">*str = (</code>
            <code class="cpp color1 bold">char</code>&nbsp;
            <code class="cpp plain">*)&nbsp;</code>
            <code class="cpp functions bold">malloc</code>
            <code class="cpp plain">(64);</code> 
           </div> 
           <div class="line number140 index139 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">i,count;</code> 
           </div> 
           <div class="line number141 index140 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp color1 bold">long</code>&nbsp;
            <code class="cpp plain">word;</code> 
           </div> 
           <div class="line number142 index141 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp color1 bold">char</code>&nbsp;
            <code class="cpp plain">*pa;</code> 
           </div> 
           <div class="line number143 index142 alt2">
            &nbsp;
           </div> 
           <div class="line number144 index143 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">i = count = 0;</code> 
           </div> 
           <div class="line number145 index144 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">pa = (</code>
            <code class="cpp color1 bold">char</code>&nbsp;
            <code class="cpp plain">*)&amp;word;</code> 
           </div> 
           <div class="line number146 index145 alt1">
            &nbsp;
           </div> 
           <div class="line number147 index146 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">while</code>
            <code class="cpp plain">(i &lt;= 60) {</code> 
           </div> 
           <div class="line number148 index147 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">word = ptrace(PTRACE_PEEKTEXT, pid, addr + count, NULL);</code> 
           </div> 
           <div class="line number149 index148 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">count += 4;</code> 
           </div> 
           <div class="line number150 index149 alt1">
            &nbsp;
           </div> 
           <div class="line number151 index150 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>&nbsp;
            <code class="cpp plain">(pa[0] == 0) {</code> 
           </div> 
           <div class="line number152 index151 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">str[i] = 0;</code> 
           </div> 
           <div class="line number153 index152 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">break</code>
            <code class="cpp plain">;</code> 
           </div> 
           <div class="line number154 index153 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number155 index154 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">else</code> 
           </div> 
           <div class="line number156 index155 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">str[i++] = pa[0];</code> 
           </div> 
           <div class="line number157 index156 alt2">
            &nbsp;
           </div> 
           <div class="line number158 index157 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>&nbsp;
            <code class="cpp plain">(pa[1] == 0) {</code> 
           </div> 
           <div class="line number159 index158 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">str[i] = 0;</code> 
           </div> 
           <div class="line number160 index159 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">break</code>
            <code class="cpp plain">;</code> 
           </div> 
           <div class="line number161 index160 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number162 index161 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">else</code> 
           </div> 
           <div class="line number163 index162 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">str[i++] = pa[1];</code> 
           </div> 
           <div class="line number164 index163 alt1">
            &nbsp;
           </div> 
           <div class="line number165 index164 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>&nbsp;
            <code class="cpp plain">(pa[2] ==0) {</code> 
           </div> 
           <div class="line number166 index165 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">str[i] = 0;</code> 
           </div> 
           <div class="line number167 index166 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">break</code>
            <code class="cpp plain">;</code> 
           </div> 
           <div class="line number168 index167 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number169 index168 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">else</code> 
           </div> 
           <div class="line number170 index169 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">str[i++] = pa[2];</code> 
           </div> 
           <div class="line number171 index170 alt2">
            &nbsp;
           </div> 
           <div class="line number172 index171 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>&nbsp;
            <code class="cpp plain">(pa[3] ==0) {</code> 
           </div> 
           <div class="line number173 index172 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">str[i] = 0;</code> 
           </div> 
           <div class="line number174 index173 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">break</code>
            <code class="cpp plain">;</code> 
           </div> 
           <div class="line number175 index174 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number176 index175 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">else</code> 
           </div> 
           <div class="line number177 index176 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">str[i++] = pa[3];</code> 
           </div> 
           <div class="line number178 index177 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number179 index178 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number180 index179 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">return</code>&nbsp;
            <code class="cpp plain">str;</code> 
           </div> 
           <div class="line number181 index180 alt2">
            <code class="cpp plain">}</code>
           </div> 
           <div class="line number182 index181 alt1">
            &nbsp;
           </div> 
           <div class="line number183 index182 alt2">
            &nbsp;
           </div> 
           <div class="line number184 index183 alt1">
            &nbsp;
           </div> 
           <div class="line number185 index184 alt2">
            &nbsp;
           </div> 
           <div class="line number186 index185 alt1">
            <code class="cpp comments">/*</code>
           </div> 
           <div class="line number187 index186 alt2"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp comments">将指定数据压入进程堆栈并返回堆栈指针</code> 
           </div> 
           <div class="line number188 index187 alt1"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp comments">*/</code> 
           </div> 
           <div class="line number189 index188 alt2"> 
            <code class="cpp keyword bold">void</code>&nbsp;
            <code class="cpp plain">* ptrace_push(</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">pid,&nbsp;</code>
            <code class="cpp keyword bold">void</code>&nbsp;
            <code class="cpp plain">*paddr,&nbsp;</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">size)</code> 
           </div> 
           <div class="line number190 index189 alt1">
            <code class="cpp plain">{</code>
           </div> 
           <div class="line number191 index190 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">unsigned&nbsp;</code>
            <code class="cpp color1 bold">long</code>&nbsp;
            <code class="cpp plain">esp;</code> 
           </div> 
           <div class="line number192 index191 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">struct</code>&nbsp;
            <code class="cpp plain">user_regs_struct regs;</code> 
           </div> 
           <div class="line number193 index192 alt2">
            &nbsp;
           </div> 
           <div class="line number194 index193 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_readreg(pid, &amp;regs);</code> 
           </div> 
           <div class="line number195 index194 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">esp = regs.esp;</code> 
           </div> 
           <div class="line number196 index195 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">esp -= size;</code> 
           </div> 
           <div class="line number197 index196 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">esp = esp - esp % 4;</code> 
           </div> 
           <div class="line number198 index197 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">regs.esp = esp;</code> 
           </div> 
           <div class="line number199 index198 alt2">
            &nbsp;
           </div> 
           <div class="line number200 index199 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_writereg(pid, &amp;regs);</code> 
           </div> 
           <div class="line number201 index200 alt2">
            &nbsp;
           </div> 
           <div class="line number202 index201 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_write(pid, esp, paddr, size);</code> 
           </div> 
           <div class="line number203 index202 alt2">
            &nbsp;
           </div> 
           <div class="line number204 index203 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">return</code>&nbsp;
            <code class="cpp plain">(</code>
            <code class="cpp keyword bold">void</code>&nbsp;
            <code class="cpp plain">*)esp;</code> 
           </div> 
           <div class="line number205 index204 alt2">
            <code class="cpp plain">}</code>
           </div> 
           <div class="line number206 index205 alt1">
            &nbsp;
           </div> 
           <div class="line number207 index206 alt2">
            <code class="cpp comments">/*</code>
           </div> 
           <div class="line number208 index207 alt1"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp comments">在进程内调用指定地址的函数</code> 
           </div> 
           <div class="line number209 index208 alt2"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp comments">*/</code> 
           </div> 
           <div class="line number210 index209 alt1"> 
            <code class="cpp keyword bold">void</code>&nbsp;
            <code class="cpp plain">ptrace_call(</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">pid, unsigned&nbsp;</code>
            <code class="cpp color1 bold">long</code>&nbsp;
            <code class="cpp plain">addr)</code> 
           </div> 
           <div class="line number211 index210 alt2">
            <code class="cpp plain">{</code>
           </div> 
           <div class="line number212 index211 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">void</code>&nbsp;
            <code class="cpp plain">*pc;</code> 
           </div> 
           <div class="line number213 index212 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">struct</code>&nbsp;
            <code class="cpp plain">user_regs_struct regs;</code> 
           </div> 
           <div class="line number214 index213 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">stat;</code> 
           </div> 
           <div class="line number215 index214 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">void</code>&nbsp;
            <code class="cpp plain">*pra;</code> 
           </div> 
           <div class="line number216 index215 alt1">
            &nbsp;
           </div> 
           <div class="line number217 index216 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">pc = (</code>
            <code class="cpp keyword bold">void</code>&nbsp;
            <code class="cpp plain">*) 0x41414140;</code> 
           </div> 
           <div class="line number218 index217 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">pra = ptrace_push(pid, &amp;pc,&nbsp;</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(pc));</code> 
           </div> 
           <div class="line number219 index218 alt2">
            &nbsp;
           </div> 
           <div class="line number220 index219 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_readreg(pid, &amp;regs);</code> 
           </div> 
           <div class="line number221 index220 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">regs.eip = addr;</code> 
           </div> 
           <div class="line number222 index221 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_writereg(pid, &amp;regs);</code> 
           </div> 
           <div class="line number223 index222 alt2">
            &nbsp;
           </div> 
           <div class="line number224 index223 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_cont(pid);</code> 
           </div> 
           <div class="line number225 index224 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//while(WIFSIGNALED(stat))</code> 
           </div> 
           <div class="line number226 index225 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">// waitpid(pid, &amp;stat, WNOHANG);</code> 
           </div> 
           <div class="line number227 index226 alt2">
            <code class="cpp plain">}</code>
           </div> 
          </div> </td> 
        </tr>
       </tbody>
      </table>
     </div> 
    </div> 
   </div> 
   <p>　　这里面的东西我就不展开了，对ptrace的学习，请自行man。</p> 
   <p>　　</p> 
   <div class="cnblogs_Highlighter sh-gutter"> 
    <div> 
     <div class="syntaxhighlighter cpp"> 
      <table border="0">
       <tbody>
        <tr>
         <td class="gutter"> 
          <div class="line number1 index0 alt2">
           1
          </div> 
          <div class="line number2 index1 alt1">
           2
          </div> 
          <div class="line number3 index2 alt2">
           3
          </div> 
          <div class="line number4 index3 alt1">
           4
          </div> 
          <div class="line number5 index4 alt2">
           5
          </div> 
          <div class="line number6 index5 alt1">
           6
          </div> 
          <div class="line number7 index6 alt2">
           7
          </div> 
          <div class="line number8 index7 alt1">
           8
          </div> 
          <div class="line number9 index8 alt2">
           9
          </div> 
          <div class="line number10 index9 alt1">
           10
          </div> 
          <div class="line number11 index10 alt2">
           11
          </div> 
          <div class="line number12 index11 alt1">
           12
          </div> 
          <div class="line number13 index12 alt2">
           13
          </div> 
          <div class="line number14 index13 alt1">
           14
          </div> 
          <div class="line number15 index14 alt2">
           15
          </div> 
          <div class="line number16 index15 alt1">
           16
          </div> 
          <div class="line number17 index16 alt2">
           17
          </div> 
          <div class="line number18 index17 alt1">
           18
          </div> 
          <div class="line number19 index18 alt2">
           19
          </div> 
          <div class="line number20 index19 alt1">
           20
          </div> 
          <div class="line number21 index20 alt2">
           21
          </div> 
          <div class="line number22 index21 alt1">
           22
          </div> 
          <div class="line number23 index22 alt2">
           23
          </div> 
          <div class="line number24 index23 alt1">
           24
          </div> 
          <div class="line number25 index24 alt2">
           25
          </div> 
          <div class="line number26 index25 alt1">
           26
          </div> 
          <div class="line number27 index26 alt2">
           27
          </div> 
          <div class="line number28 index27 alt1">
           28
          </div> 
          <div class="line number29 index28 alt2">
           29
          </div> 
          <div class="line number30 index29 alt1">
           30
          </div> 
          <div class="line number31 index30 alt2">
           31
          </div> 
          <div class="line number32 index31 alt1">
           32
          </div> 
          <div class="line number33 index32 alt2">
           33
          </div> 
          <div class="line number34 index33 alt1">
           34
          </div> 
          <div class="line number35 index34 alt2">
           35
          </div> 
          <div class="line number36 index35 alt1">
           36
          </div> 
          <div class="line number37 index36 alt2">
           37
          </div> 
          <div class="line number38 index37 alt1">
           38
          </div> 
          <div class="line number39 index38 alt2">
           39
          </div> 
          <div class="line number40 index39 alt1">
           40
          </div> 
          <div class="line number41 index40 alt2">
           41
          </div> 
          <div class="line number42 index41 alt1">
           42
          </div> 
          <div class="line number43 index42 alt2">
           43
          </div> 
          <div class="line number44 index43 alt1">
           44
          </div> 
          <div class="line number45 index44 alt2">
           45
          </div> 
          <div class="line number46 index45 alt1">
           46
          </div> 
          <div class="line number47 index46 alt2">
           47
          </div> 
          <div class="line number48 index47 alt1">
           48
          </div> 
          <div class="line number49 index48 alt2">
           49
          </div> 
          <div class="line number50 index49 alt1">
           50
          </div> 
          <div class="line number51 index50 alt2">
           51
          </div> 
          <div class="line number52 index51 alt1">
           52
          </div> 
          <div class="line number53 index52 alt2">
           53
          </div> 
          <div class="line number54 index53 alt1">
           54
          </div> 
          <div class="line number55 index54 alt2">
           55
          </div> 
          <div class="line number56 index55 alt1">
           56
          </div> 
          <div class="line number57 index56 alt2">
           57
          </div> 
          <div class="line number58 index57 alt1">
           58
          </div> 
          <div class="line number59 index58 alt2">
           59
          </div> 
          <div class="line number60 index59 alt1">
           60
          </div> 
          <div class="line number61 index60 alt2">
           61
          </div> 
          <div class="line number62 index61 alt1">
           62
          </div> 
          <div class="line number63 index62 alt2">
           63
          </div> 
          <div class="line number64 index63 alt1">
           64
          </div> 
          <div class="line number65 index64 alt2">
           65
          </div> 
          <div class="line number66 index65 alt1">
           66
          </div> 
          <div class="line number67 index66 alt2">
           67
          </div> 
          <div class="line number68 index67 alt1">
           68
          </div> 
          <div class="line number69 index68 alt2">
           69
          </div> 
          <div class="line number70 index69 alt1">
           70
          </div> 
          <div class="line number71 index70 alt2">
           71
          </div> 
          <div class="line number72 index71 alt1">
           72
          </div> 
          <div class="line number73 index72 alt2">
           73
          </div> 
          <div class="line number74 index73 alt1">
           74
          </div> 
          <div class="line number75 index74 alt2">
           75
          </div> 
          <div class="line number76 index75 alt1">
           76
          </div> 
          <div class="line number77 index76 alt2">
           77
          </div> 
          <div class="line number78 index77 alt1">
           78
          </div> 
          <div class="line number79 index78 alt2">
           79
          </div> 
          <div class="line number80 index79 alt1">
           80
          </div> 
          <div class="line number81 index80 alt2">
           81
          </div> 
          <div class="line number82 index81 alt1">
           82
          </div> 
          <div class="line number83 index82 alt2">
           83
          </div> 
          <div class="line number84 index83 alt1">
           84
          </div> 
          <div class="line number85 index84 alt2">
           85
          </div> 
          <div class="line number86 index85 alt1">
           86
          </div> 
          <div class="line number87 index86 alt2">
           87
          </div> 
          <div class="line number88 index87 alt1">
           88
          </div> 
          <div class="line number89 index88 alt2">
           89
          </div> 
          <div class="line number90 index89 alt1">
           90
          </div> 
          <div class="line number91 index90 alt2">
           91
          </div> 
          <div class="line number92 index91 alt1">
           92
          </div> 
          <div class="line number93 index92 alt2">
           93
          </div> 
          <div class="line number94 index93 alt1">
           94
          </div> 
          <div class="line number95 index94 alt2">
           95
          </div> 
          <div class="line number96 index95 alt1">
           96
          </div> 
          <div class="line number97 index96 alt2">
           97
          </div> 
          <div class="line number98 index97 alt1">
           98
          </div> 
          <div class="line number99 index98 alt2">
           99
          </div> 
          <div class="line number100 index99 alt1">
           100
          </div> 
          <div class="line number101 index100 alt2">
           101
          </div> 
          <div class="line number102 index101 alt1">
           102
          </div> 
          <div class="line number103 index102 alt2">
           103
          </div> 
          <div class="line number104 index103 alt1">
           104
          </div> 
          <div class="line number105 index104 alt2">
           105
          </div> 
          <div class="line number106 index105 alt1">
           106
          </div> 
          <div class="line number107 index106 alt2">
           107
          </div> 
          <div class="line number108 index107 alt1">
           108
          </div> 
          <div class="line number109 index108 alt2">
           109
          </div> 
          <div class="line number110 index109 alt1">
           110
          </div> 
          <div class="line number111 index110 alt2">
           111
          </div> 
          <div class="line number112 index111 alt1">
           112
          </div> 
          <div class="line number113 index112 alt2">
           113
          </div> 
          <div class="line number114 index113 alt1">
           114
          </div> 
          <div class="line number115 index114 alt2">
           115
          </div> 
          <div class="line number116 index115 alt1">
           116
          </div> 
          <div class="line number117 index116 alt2">
           117
          </div> 
          <div class="line number118 index117 alt1">
           118
          </div> 
          <div class="line number119 index118 alt2">
           119
          </div> 
          <div class="line number120 index119 alt1">
           120
          </div> 
          <div class="line number121 index120 alt2">
           121
          </div> 
          <div class="line number122 index121 alt1">
           122
          </div> 
          <div class="line number123 index122 alt2">
           123
          </div> 
          <div class="line number124 index123 alt1">
           124
          </div> 
          <div class="line number125 index124 alt2">
           125
          </div> 
          <div class="line number126 index125 alt1">
           126
          </div> 
          <div class="line number127 index126 alt2">
           127
          </div> 
          <div class="line number128 index127 alt1">
           128
          </div> 
          <div class="line number129 index128 alt2">
           129
          </div> 
          <div class="line number130 index129 alt1">
           130
          </div> 
          <div class="line number131 index130 alt2">
           131
          </div> 
          <div class="line number132 index131 alt1">
           132
          </div> 
          <div class="line number133 index132 alt2">
           133
          </div> 
          <div class="line number134 index133 alt1">
           134
          </div> 
          <div class="line number135 index134 alt2">
           135
          </div> 
          <div class="line number136 index135 alt1">
           136
          </div> 
          <div class="line number137 index136 alt2">
           137
          </div> 
          <div class="line number138 index137 alt1">
           138
          </div> 
          <div class="line number139 index138 alt2">
           139
          </div> 
          <div class="line number140 index139 alt1">
           140
          </div> 
          <div class="line number141 index140 alt2">
           141
          </div> 
          <div class="line number142 index141 alt1">
           142
          </div> 
          <div class="line number143 index142 alt2">
           143
          </div> 
          <div class="line number144 index143 alt1">
           144
          </div> 
          <div class="line number145 index144 alt2">
           145
          </div> 
          <div class="line number146 index145 alt1">
           146
          </div> 
          <div class="line number147 index146 alt2">
           147
          </div> 
          <div class="line number148 index147 alt1">
           148
          </div> 
          <div class="line number149 index148 alt2">
           149
          </div> 
          <div class="line number150 index149 alt1">
           150
          </div> 
          <div class="line number151 index150 alt2">
           151
          </div> 
          <div class="line number152 index151 alt1">
           152
          </div> 
          <div class="line number153 index152 alt2">
           153
          </div> 
          <div class="line number154 index153 alt1">
           154
          </div> 
          <div class="line number155 index154 alt2">
           155
          </div> 
          <div class="line number156 index155 alt1">
           156
          </div> 
          <div class="line number157 index156 alt2">
           157
          </div> 
          <div class="line number158 index157 alt1">
           158
          </div> 
          <div class="line number159 index158 alt2">
           159
          </div> 
          <div class="line number160 index159 alt1">
           160
          </div> 
          <div class="line number161 index160 alt2">
           161
          </div> 
          <div class="line number162 index161 alt1">
           162
          </div> 
          <div class="line number163 index162 alt2">
           163
          </div> 
          <div class="line number164 index163 alt1">
           164
          </div> 
          <div class="line number165 index164 alt2">
           165
          </div> 
          <div class="line number166 index165 alt1">
           166
          </div> 
          <div class="line number167 index166 alt2">
           167
          </div> 
          <div class="line number168 index167 alt1">
           168
          </div> 
          <div class="line number169 index168 alt2">
           169
          </div> 
          <div class="line number170 index169 alt1">
           170
          </div> 
          <div class="line number171 index170 alt2">
           171
          </div> 
          <div class="line number172 index171 alt1">
           172
          </div> 
          <div class="line number173 index172 alt2">
           173
          </div> 
          <div class="line number174 index173 alt1">
           174
          </div> 
          <div class="line number175 index174 alt2">
           175
          </div> 
          <div class="line number176 index175 alt1">
           176
          </div> 
          <div class="line number177 index176 alt2">
           177
          </div> 
          <div class="line number178 index177 alt1">
           178
          </div> 
          <div class="line number179 index178 alt2">
           179
          </div> 
          <div class="line number180 index179 alt1">
           180
          </div> 
          <div class="line number181 index180 alt2">
           181
          </div> 
          <div class="line number182 index181 alt1">
           182
          </div> 
          <div class="line number183 index182 alt2">
           183
          </div> 
          <div class="line number184 index183 alt1">
           184
          </div> 
          <div class="line number185 index184 alt2">
           185
          </div> 
          <div class="line number186 index185 alt1">
           186
          </div> 
          <div class="line number187 index186 alt2">
           187
          </div> 
          <div class="line number188 index187 alt1">
           188
          </div> 
          <div class="line number189 index188 alt2">
           189
          </div> 
          <div class="line number190 index189 alt1">
           190
          </div> 
          <div class="line number191 index190 alt2">
           191
          </div> 
          <div class="line number192 index191 alt1">
           192
          </div> 
          <div class="line number193 index192 alt2">
           193
          </div> 
          <div class="line number194 index193 alt1">
           194
          </div> 
          <div class="line number195 index194 alt2">
           195
          </div> 
          <div class="line number196 index195 alt1">
           196
          </div> 
          <div class="line number197 index196 alt2">
           197
          </div> 
          <div class="line number198 index197 alt1">
           198
          </div> 
          <div class="line number199 index198 alt2">
           199
          </div> 
          <div class="line number200 index199 alt1">
           200
          </div> 
          <div class="line number201 index200 alt2">
           201
          </div> 
          <div class="line number202 index201 alt1">
           202
          </div> 
          <div class="line number203 index202 alt2">
           203
          </div> 
          <div class="line number204 index203 alt1">
           204
          </div> 
          <div class="line number205 index204 alt2">
           205
          </div> 
          <div class="line number206 index205 alt1">
           206
          </div> 
          <div class="line number207 index206 alt2">
           207
          </div> 
          <div class="line number208 index207 alt1">
           208
          </div> 
          <div class="line number209 index208 alt2">
           209
          </div> 
          <div class="line number210 index209 alt1">
           210
          </div> 
          <div class="line number211 index210 alt2">
           211
          </div> 
          <div class="line number212 index211 alt1">
           212
          </div> 
          <div class="line number213 index212 alt2">
           213
          </div> 
          <div class="line number214 index213 alt1">
           214
          </div> 
          <div class="line number215 index214 alt2">
           215
          </div> 
          <div class="line number216 index215 alt1">
           216
          </div> 
          <div class="line number217 index216 alt2">
           217
          </div> 
          <div class="line number218 index217 alt1">
           218
          </div> 
          <div class="line number219 index218 alt2">
           219
          </div> 
          <div class="line number220 index219 alt1">
           220
          </div> 
          <div class="line number221 index220 alt2">
           221
          </div> 
          <div class="line number222 index221 alt1">
           222
          </div> 
          <div class="line number223 index222 alt2">
           223
          </div> 
          <div class="line number224 index223 alt1">
           224
          </div> 
          <div class="line number225 index224 alt2">
           225
          </div> 
          <div class="line number226 index225 alt1">
           226
          </div> 
          <div class="line number227 index226 alt2">
           227
          </div> 
          <div class="line number228 index227 alt1">
           228
          </div> 
          <div class="line number229 index228 alt2">
           229
          </div> 
          <div class="line number230 index229 alt1">
           230
          </div> 
          <div class="line number231 index230 alt2">
           231
          </div> 
          <div class="line number232 index231 alt1">
           232
          </div> 
          <div class="line number233 index232 alt2">
           233
          </div> 
          <div class="line number234 index233 alt1">
           234
          </div> 
          <div class="line number235 index234 alt2">
           235
          </div> 
          <div class="line number236 index235 alt1">
           236
          </div> 
          <div class="line number237 index236 alt2">
           237
          </div> 
          <div class="line number238 index237 alt1">
           238
          </div> 
          <div class="line number239 index238 alt2">
           239
          </div> 
          <div class="line number240 index239 alt1">
           240
          </div> 
          <div class="line number241 index240 alt2">
           241
          </div> 
          <div class="line number242 index241 alt1">
           242
          </div> 
          <div class="line number243 index242 alt2">
           243
          </div> 
          <div class="line number244 index243 alt1">
           244
          </div> 
          <div class="line number245 index244 alt2">
           245
          </div> 
          <div class="line number246 index245 alt1">
           246
          </div> 
          <div class="line number247 index246 alt2">
           247
          </div> 
          <div class="line number248 index247 alt1">
           248
          </div> 
          <div class="line number249 index248 alt2">
           249
          </div> 
          <div class="line number250 index249 alt1">
           250
          </div> 
          <div class="line number251 index250 alt2">
           251
          </div> 
          <div class="line number252 index251 alt1">
           252
          </div> 
          <div class="line number253 index252 alt2">
           253
          </div> 
          <div class="line number254 index253 alt1">
           254
          </div> 
          <div class="line number255 index254 alt2">
           255
          </div> 
          <div class="line number256 index255 alt1">
           256
          </div> 
          <div class="line number257 index256 alt2">
           257
          </div> 
          <div class="line number258 index257 alt1">
           258
          </div> 
          <div class="line number259 index258 alt2">
           259
          </div> 
          <div class="line number260 index259 alt1">
           260
          </div> 
          <div class="line number261 index260 alt2">
           261
          </div> 
          <div class="line number262 index261 alt1">
           262
          </div> 
          <div class="line number263 index262 alt2">
           263
          </div> 
          <div class="line number264 index263 alt1">
           264
          </div> 
          <div class="line number265 index264 alt2">
           265
          </div> 
          <div class="line number266 index265 alt1">
           266
          </div> 
          <div class="line number267 index266 alt2">
           267
          </div> 
          <div class="line number268 index267 alt1">
           268
          </div> 
          <div class="line number269 index268 alt2">
           269
          </div> 
          <div class="line number270 index269 alt1">
           270
          </div> 
          <div class="line number271 index270 alt2">
           271
          </div> 
          <div class="line number272 index271 alt1">
           272
          </div> 
          <div class="line number273 index272 alt2">
           273
          </div> 
          <div class="line number274 index273 alt1">
           274
          </div> 
          <div class="line number275 index274 alt2">
           275
          </div> 
          <div class="line number276 index275 alt1">
           276
          </div> 
          <div class="line number277 index276 alt2">
           277
          </div> 
          <div class="line number278 index277 alt1">
           278
          </div> 
          <div class="line number279 index278 alt2">
           279
          </div> 
          <div class="line number280 index279 alt1">
           280
          </div> 
          <div class="line number281 index280 alt2">
           281
          </div> 
          <div class="line number282 index281 alt1">
           282
          </div> 
          <div class="line number283 index282 alt2">
           283
          </div> 
          <div class="line number284 index283 alt1">
           284
          </div> 
          <div class="line number285 index284 alt2">
           285
          </div> 
          <div class="line number286 index285 alt1">
           286
          </div> 
          <div class="line number287 index286 alt2">
           287
          </div> 
          <div class="line number288 index287 alt1">
           288
          </div> 
          <div class="line number289 index288 alt2">
           289
          </div> 
          <div class="line number290 index289 alt1">
           290
          </div> 
          <div class="line number291 index290 alt2">
           291
          </div> 
          <div class="line number292 index291 alt1">
           292
          </div> 
          <div class="line number293 index292 alt2">
           293
          </div> 
          <div class="line number294 index293 alt1">
           294
          </div> 
          <div class="line number295 index294 alt2">
           295
          </div> 
          <div class="line number296 index295 alt1">
           296
          </div> 
          <div class="line number297 index296 alt2">
           297
          </div> 
          <div class="line number298 index297 alt1">
           298
          </div> 
          <div class="line number299 index298 alt2">
           299
          </div> 
          <div class="line number300 index299 alt1">
           300
          </div> 
          <div class="line number301 index300 alt2">
           301
          </div> 
          <div class="line number302 index301 alt1">
           302
          </div> 
          <div class="line number303 index302 alt2">
           303
          </div> 
          <div class="line number304 index303 alt1">
           304
          </div> 
          <div class="line number305 index304 alt2">
           305
          </div> 
          <div class="line number306 index305 alt1">
           306
          </div> 
          <div class="line number307 index306 alt2">
           307
          </div> 
          <div class="line number308 index307 alt1">
           308
          </div> 
          <div class="line number309 index308 alt2">
           309
          </div> 
          <div class="line number310 index309 alt1">
           310
          </div> 
          <div class="line number311 index310 alt2">
           311
          </div> 
          <div class="line number312 index311 alt1">
           312
          </div> 
          <div class="line number313 index312 alt2">
           313
          </div> 
          <div class="line number314 index313 alt1">
           314
          </div> 
          <div class="line number315 index314 alt2">
           315
          </div> 
          <div class="line number316 index315 alt1">
           316
          </div> 
          <div class="line number317 index316 alt2">
           317
          </div> 
          <div class="line number318 index317 alt1">
           318
          </div> 
          <div class="line number319 index318 alt2">
           319
          </div> 
          <div class="line number320 index319 alt1">
           320
          </div> 
          <div class="line number321 index320 alt2">
           321
          </div> 
          <div class="line number322 index321 alt1">
           322
          </div> 
          <div class="line number323 index322 alt2">
           323
          </div> 
          <div class="line number324 index323 alt1">
           324
          </div> 
          <div class="line number325 index324 alt2">
           325
          </div> 
          <div class="line number326 index325 alt1">
           326
          </div> 
          <div class="line number327 index326 alt2">
           327
          </div> 
          <div class="line number328 index327 alt1">
           328
          </div> 
          <div class="line number329 index328 alt2">
           329
          </div> 
          <div class="line number330 index329 alt1">
           330
          </div> 
          <div class="line number331 index330 alt2">
           331
          </div> 
          <div class="line number332 index331 alt1">
           332
          </div> 
          <div class="line number333 index332 alt2">
           333
          </div> 
          <div class="line number334 index333 alt1">
           334
          </div> 
          <div class="line number335 index334 alt2">
           335
          </div> 
          <div class="line number336 index335 alt1">
           336
          </div> 
          <div class="line number337 index336 alt2">
           337
          </div> 
          <div class="line number338 index337 alt1">
           338
          </div> 
          <div class="line number339 index338 alt2">
           339
          </div> 
          <div class="line number340 index339 alt1">
           340
          </div> 
          <div class="line number341 index340 alt2">
           341
          </div> 
          <div class="line number342 index341 alt1">
           342
          </div> 
          <div class="line number343 index342 alt2">
           343
          </div> 
          <div class="line number344 index343 alt1">
           344
          </div> 
          <div class="line number345 index344 alt2">
           345
          </div> 
          <div class="line number346 index345 alt1">
           346
          </div> 
          <div class="line number347 index346 alt2">
           347
          </div> 
          <div class="line number348 index347 alt1">
           348
          </div> 
          <div class="line number349 index348 alt2">
           349
          </div> 
          <div class="line number350 index349 alt1">
           350
          </div> 
          <div class="line number351 index350 alt2">
           351
          </div> 
          <div class="line number352 index351 alt1">
           352
          </div> 
          <div class="line number353 index352 alt2">
           353
          </div> 
          <div class="line number354 index353 alt1">
           354
          </div> 
          <div class="line number355 index354 alt2">
           355
          </div> 
          <div class="line number356 index355 alt1">
           356
          </div> 
          <div class="line number357 index356 alt2">
           357
          </div> 
          <div class="line number358 index357 alt1">
           358
          </div> 
          <div class="line number359 index358 alt2">
           359
          </div> 
          <div class="line number360 index359 alt1">
           360
          </div> 
          <div class="line number361 index360 alt2">
           361
          </div> 
          <div class="line number362 index361 alt1">
           362
          </div> 
          <div class="line number363 index362 alt2">
           363
          </div> 
          <div class="line number364 index363 alt1">
           364
          </div> 
          <div class="line number365 index364 alt2">
           365
          </div> 
          <div class="line number366 index365 alt1">
           366
          </div> 
          <div class="line number367 index366 alt2">
           367
          </div> 
          <div class="line number368 index367 alt1">
           368
          </div> 
          <div class="line number369 index368 alt2">
           369
          </div> 
          <div class="line number370 index369 alt1">
           370
          </div> 
          <div class="line number371 index370 alt2">
           371
          </div> 
          <div class="line number372 index371 alt1">
           372
          </div> 
          <div class="line number373 index372 alt2">
           373
          </div> 
          <div class="line number374 index373 alt1">
           374
          </div> 
          <div class="line number375 index374 alt2">
           375
          </div> 
          <div class="line number376 index375 alt1">
           376
          </div> 
          <div class="line number377 index376 alt2">
           377
          </div> 
          <div class="line number378 index377 alt1">
           378
          </div> 
          <div class="line number379 index378 alt2">
           379
          </div> 
          <div class="line number380 index379 alt1">
           380
          </div> 
          <div class="line number381 index380 alt2">
           381
          </div> 
          <div class="line number382 index381 alt1">
           382
          </div> 
          <div class="line number383 index382 alt2">
           383
          </div> 
          <div class="line number384 index383 alt1">
           384
          </div> 
          <div class="line number385 index384 alt2">
           385
          </div> 
          <div class="line number386 index385 alt1">
           386
          </div> 
          <div class="line number387 index386 alt2">
           387
          </div> 
          <div class="line number388 index387 alt1">
           388
          </div> 
          <div class="line number389 index388 alt2">
           389
          </div> 
          <div class="line number390 index389 alt1">
           390
          </div> 
          <div class="line number391 index390 alt2">
           391
          </div> 
          <div class="line number392 index391 alt1">
           392
          </div> 
          <div class="line number393 index392 alt2">
           393
          </div> 
          <div class="line number394 index393 alt1">
           394
          </div> 
          <div class="line number395 index394 alt2">
           395
          </div> 
          <div class="line number396 index395 alt1">
           396
          </div> 
          <div class="line number397 index396 alt2">
           397
          </div> 
          <div class="line number398 index397 alt1">
           398
          </div> 
          <div class="line number399 index398 alt2">
           399
          </div> 
          <div class="line number400 index399 alt1">
           400
          </div> 
          <div class="line number401 index400 alt2">
           401
          </div> 
          <div class="line number402 index401 alt1">
           402
          </div> 
          <div class="line number403 index402 alt2">
           403
          </div> 
          <div class="line number404 index403 alt1">
           404
          </div> 
          <div class="line number405 index404 alt2">
           405
          </div> 
          <div class="line number406 index405 alt1">
           406
          </div> 
          <div class="line number407 index406 alt2">
           407
          </div> 
          <div class="line number408 index407 alt1">
           408
          </div> 
          <div class="line number409 index408 alt2">
           409
          </div> 
          <div class="line number410 index409 alt1">
           410
          </div> 
          <div class="line number411 index410 alt2">
           411
          </div> 
          <div class="line number412 index411 alt1">
           412
          </div> 
          <div class="line number413 index412 alt2">
           413
          </div> 
          <div class="line number414 index413 alt1">
           414
          </div> 
          <div class="line number415 index414 alt2">
           415
          </div> 
          <div class="line number416 index415 alt1">
           416
          </div> 
          <div class="line number417 index416 alt2">
           417
          </div> 
          <div class="line number418 index417 alt1">
           418
          </div> 
          <div class="line number419 index418 alt2">
           419
          </div> 
          <div class="line number420 index419 alt1">
           420
          </div> 
          <div class="line number421 index420 alt2">
           421
          </div> 
          <div class="line number422 index421 alt1">
           422
          </div> 
          <div class="line number423 index422 alt2">
           423
          </div> 
          <div class="line number424 index423 alt1">
           424
          </div> 
          <div class="line number425 index424 alt2">
           425
          </div> 
          <div class="line number426 index425 alt1">
           426
          </div> 
          <div class="line number427 index426 alt2">
           427
          </div> 
          <div class="line number428 index427 alt1">
           428
          </div> 
          <div class="line number429 index428 alt2">
           429
          </div> 
          <div class="line number430 index429 alt1">
           430
          </div> 
          <div class="line number431 index430 alt2">
           431
          </div> 
          <div class="line number432 index431 alt1">
           432
          </div> 
          <div class="line number433 index432 alt2">
           433
          </div> 
          <div class="line number434 index433 alt1">
           434
          </div> 
          <div class="line number435 index434 alt2">
           435
          </div> 
          <div class="line number436 index435 alt1">
           436
          </div> 
          <div class="line number437 index436 alt2">
           437
          </div> 
          <div class="line number438 index437 alt1">
           438
          </div> 
          <div class="line number439 index438 alt2">
           439
          </div> 
          <div class="line number440 index439 alt1">
           440
          </div> 
          <div class="line number441 index440 alt2">
           441
          </div> 
          <div class="line number442 index441 alt1">
           442
          </div> 
          <div class="line number443 index442 alt2">
           443
          </div> 
          <div class="line number444 index443 alt1">
           444
          </div> 
          <div class="line number445 index444 alt2">
           445
          </div> 
          <div class="line number446 index445 alt1">
           446
          </div> 
          <div class="line number447 index446 alt2">
           447
          </div> 
          <div class="line number448 index447 alt1">
           448
          </div> 
          <div class="line number449 index448 alt2">
           449
          </div> 
          <div class="line number450 index449 alt1">
           450
          </div> 
          <div class="line number451 index450 alt2">
           451
          </div> </td> 
         <td class="code"> 
          <div> 
           <div class="line number1 index0 alt2">
            <code class="cpp comments">/*</code>
           </div> 
           <div class="line number2 index1 alt1">
            <code class="cpp comments">因为应用程序可能不存在hash表，所以通过读取源文件的section header获取符号表的入口数，</code>
           </div> 
           <div class="line number3 index2 alt2">
            <code class="cpp comments">其实是被误导了，但也学习了hash表的作用，用来快速查找符号表中的信息和字符串表中的信息</code>
           </div> 
           <div class="line number4 index3 alt1">
            <code class="cpp comments">*/</code>
           </div> 
           <div class="line number5 index4 alt2">
            <code class="cpp comments">/*int getnchains(int pid,unsigned long base_addr)</code>
           </div> 
           <div class="line number6 index5 alt1">
            <code class="cpp comments">{</code>
           </div> 
           <div class="line number7 index6 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("getnchains enter \n");</code> 
           </div> 
           <div class="line number8 index7 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">Elf32_Ehdr *ehdr = (Elf32_Ehdr *) malloc(sizeof(Elf32_Ehdr));&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code> 
           </div> 
           <div class="line number9 index8 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">Elf32_Shdr *shdr = (Elf32_Shdr *)malloc(sizeof(Elf32_Shdr));</code> 
           </div> 
           <div class="line number10 index9 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">unsigned long shdr_addr;</code> 
           </div> 
           <div class="line number11 index10 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">int i = 0;</code> 
           </div> 
           <div class="line number12 index11 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">int fd;</code> 
           </div> 
           <div class="line number13 index12 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">char filename[1024] = {0};</code> 
           </div> 
           <div class="line number14 index13 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">ptrace_read(pid, base_addr, ehdr, sizeof(Elf32_Ehdr));</code> 
           </div> 
           <div class="line number15 index14 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">shdr_addr = base_addr + ehdr-&gt;e_shoff;</code> 
           </div> 
           <div class="line number16 index15 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("getnchains ehdr-&gt;e_shoff\t %p\n", ehdr-&gt;e_shoff);</code> 
           </div> 
           <div class="line number17 index16 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number18 index17 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">snprintf(filename, sizeof(filename), "/proc/%d/exe", pid);</code> 
           </div> 
           <div class="line number19 index18 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">fd = open(filename, O_RDONLY);</code> 
           </div> 
           <div class="line number20 index19 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">if (lseek(fd, ehdr-&gt;e_shoff, SEEK_SET) &lt; 0)</code> 
           </div> 
           <div class="line number21 index20 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">exit(-1);</code> 
           </div> 
           <div class="line number22 index21 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number23 index22 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/*while(i&lt;ehdr-&gt;e_shnum)</code> 
           </div> 
           <div class="line number24 index23 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">{</code> 
           </div> 
           <div class="line number25 index24 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">read(fd, shdr, ehdr-&gt;e_shentsize);</code> 
           </div> 
           <div class="line number26 index25 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("getnchains i = %d\n",i);</code> 
           </div> 
           <div class="line number27 index26 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("getnchains shdr-&gt;sh_type = %x\n",shdr-&gt;sh_type);</code> 
           </div> 
           <div class="line number28 index27 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("getnchains shdr-&gt;sh_name = %x\n",shdr-&gt;sh_name);</code> 
           </div> 
           <div class="line number29 index28 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("getnchains shdr-&gt;sh_size = %x\n",shdr-&gt;sh_size);</code> 
           </div> 
           <div class="line number30 index29 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("getnchains shdr-&gt;sh_entsize = %x\n",shdr-&gt;sh_entsize);</code> 
           </div> 
           <div class="line number31 index30 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">i++;</code> 
           </div> 
           <div class="line number32 index31 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">}</code> 
           </div> 
           <div class="line number33 index32 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number34 index33 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">while(shdr-&gt;sh_type != SHT_SYMTAB)</code> 
           </div> 
           <div class="line number35 index34 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">read(fd, shdr, ehdr-&gt;e_shentsize);</code> 
           </div> 
           <div class="line number36 index35 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">nchains = shdr-&gt;sh_size/shdr-&gt;sh_entsize;</code> 
           </div> 
           <div class="line number37 index36 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("getnchains shdr-&gt;sh_type = %d\n",shdr-&gt;sh_type);</code> 
           </div> 
           <div class="line number38 index37 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("getnchains shdr-&gt;sh_name = %d\n",shdr-&gt;sh_name);</code> 
           </div> 
           <div class="line number39 index38 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("getnchains shdr-&gt;sh_size = %d\n",shdr-&gt;sh_size);</code> 
           </div> 
           <div class="line number40 index39 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("getnchains shdr-&gt;sh_entsize = %d\n",shdr-&gt;sh_entsize);</code> 
           </div> 
           <div class="line number41 index40 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("getnchains nchains = %x\n",nchains);&nbsp;</code> 
           </div> 
           <div class="line number42 index41 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">close(fd);</code> 
           </div> 
           <div class="line number43 index42 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">free(ehdr);</code> 
           </div> 
           <div class="line number44 index43 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">free(shdr);</code> 
           </div> 
           <div class="line number45 index44 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("getnchains exit \n");</code> 
           </div> 
           <div class="line number46 index45 alt1">
            <code class="cpp comments">}</code>
           </div> 
           <div class="line number47 index46 alt2">
            <code class="cpp comments">*/</code>
           </div> 
           <div class="line number48 index47 alt1">
            &nbsp;
           </div> 
           <div class="line number49 index48 alt2">
            &nbsp;
           </div> 
           <div class="line number50 index49 alt1">
            <code class="cpp comments">/*</code>
           </div> 
           <div class="line number51 index50 alt2"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp comments">取得指向link_map链表首项的指针</code> 
           </div> 
           <div class="line number52 index51 alt1"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp comments">*/</code> 
           </div> 
           <div class="line number53 index52 alt2"> 
            <code class="cpp keyword bold">struct</code>&nbsp;
            <code class="cpp plain">link_map * get_linkmap(</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">pid)</code> 
           </div> 
           <div class="line number54 index53 alt1">
            <code class="cpp plain">{</code>
           </div> 
           <div class="line number55 index54 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">Elf32_Ehdr *ehdr = (Elf32_Ehdr *)&nbsp;</code>
            <code class="cpp functions bold">malloc</code>
            <code class="cpp plain">(</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Ehdr));&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code> 
           </div> 
           <div class="line number56 index55 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">Elf32_Phdr *phdr = (Elf32_Phdr *)&nbsp;</code>
            <code class="cpp functions bold">malloc</code>
            <code class="cpp plain">(</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Phdr));</code> 
           </div> 
           <div class="line number57 index56 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">Elf32_Dyn&nbsp; *dyn =&nbsp; (Elf32_Dyn *)&nbsp;</code>
            <code class="cpp functions bold">malloc</code>
            <code class="cpp plain">(</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Dyn));</code> 
           </div> 
           <div class="line number58 index57 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">Elf32_Word got;</code> 
           </div> 
           <div class="line number59 index58 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">struct</code>&nbsp;
            <code class="cpp plain">link_map *map = (</code>
            <code class="cpp keyword bold">struct</code>&nbsp;
            <code class="cpp plain">link_map *)</code>
            <code class="cpp functions bold">malloc</code>
            <code class="cpp plain">(</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(</code>
            <code class="cpp keyword bold">struct</code>&nbsp;
            <code class="cpp plain">link_map));</code> 
           </div> 
           <div class="line number60 index59 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">i = 1;</code> 
           </div> 
           <div class="line number61 index60 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">unsigned&nbsp;</code>
            <code class="cpp color1 bold">long</code>&nbsp;
            <code class="cpp plain">tmpaddr;</code> 
           </div> 
           <div class="line number62 index61 alt1">
            &nbsp;
           </div> 
           <div class="line number63 index62 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_read(pid, IMAGE_ADDR, ehdr,&nbsp;</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Ehdr));</code> 
           </div> 
           <div class="line number64 index63 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">phdr_addr = IMAGE_ADDR + ehdr-&gt;e_phoff;</code> 
           </div> 
           <div class="line number65 index64 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">printf</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"phdr_addr\t %p\n"</code>
            <code class="cpp plain">, phdr_addr);</code> 
           </div> 
           <div class="line number66 index65 alt1">
            &nbsp;
           </div> 
           <div class="line number67 index66 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_read(pid, phdr_addr, phdr,&nbsp;</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Phdr));</code> 
           </div> 
           <div class="line number68 index67 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">while</code>
            <code class="cpp plain">(phdr-&gt;p_type != PT_DYNAMIC)</code> 
           </div> 
           <div class="line number69 index68 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_read(pid, phdr_addr +=&nbsp;</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Phdr), phdr,</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Phdr));</code> 
           </div> 
           <div class="line number70 index69 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">dyn_addr = phdr-&gt;p_vaddr;</code> 
           </div> 
           <div class="line number71 index70 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">printf</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"dyn_addr\t %p\n"</code>
            <code class="cpp plain">, dyn_addr);</code> 
           </div> 
           <div class="line number72 index71 alt1">
            &nbsp;
           </div> 
           <div class="line number73 index72 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_read(pid, dyn_addr, dyn,&nbsp;</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Dyn));</code> 
           </div> 
           <div class="line number74 index73 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">while</code>
            <code class="cpp plain">(dyn-&gt;d_tag != DT_PLTGOT) {</code> 
           </div> 
           <div class="line number75 index74 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">tmpaddr = dyn_addr + i *&nbsp;</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Dyn);</code> 
           </div> 
           <div class="line number76 index75 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("get_linkmap tmpaddr = %x\n",tmpaddr);</code> 
           </div> 
           <div class="line number77 index76 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_read(pid,tmpaddr, dyn,&nbsp;</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Dyn));</code> 
           </div> 
           <div class="line number78 index77 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">i++;</code> 
           </div> 
           <div class="line number79 index78 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number80 index79 alt1">
            &nbsp;
           </div> 
           <div class="line number81 index80 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">got = (Elf32_Word)dyn-&gt;d_un.d_ptr;</code> 
           </div> 
           <div class="line number82 index81 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">got += 4;</code> 
           </div> 
           <div class="line number83 index82 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("GOT\t\t %p\n", got);</code> 
           </div> 
           <div class="line number84 index83 alt1">
            &nbsp;
           </div> 
           <div class="line number85 index84 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_read(pid, got, &amp;map_addr, 4);</code> 
           </div> 
           <div class="line number86 index85 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">printf</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"map_addr\t %p\n"</code>
            <code class="cpp plain">, map_addr);</code> 
           </div> 
           <div class="line number87 index86 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">map = map_addr;</code> 
           </div> 
           <div class="line number88 index87 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//ptrace_read(pid, map_addr, map, sizeof(struct link_map));</code> 
           </div> 
           <div class="line number89 index88 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number90 index89 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">free</code>
            <code class="cpp plain">(ehdr);</code> 
           </div> 
           <div class="line number91 index90 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">free</code>
            <code class="cpp plain">(phdr);</code> 
           </div> 
           <div class="line number92 index91 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">free</code>
            <code class="cpp plain">(dyn);</code> 
           </div> 
           <div class="line number93 index92 alt2">
            &nbsp;
           </div> 
           <div class="line number94 index93 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">return</code>&nbsp;
            <code class="cpp plain">map;</code> 
           </div> 
           <div class="line number95 index94 alt2">
            <code class="cpp plain">}</code>
           </div> 
           <div class="line number96 index95 alt1">
            &nbsp;
           </div> 
           <div class="line number97 index96 alt2">
            <code class="cpp comments">/*</code>
           </div> 
           <div class="line number98 index97 alt1"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp comments">取得给定link_map指向的SYMTAB、STRTAB、HASH、JMPREL、PLTRELSZ、RELAENT、RELENT信息</code> 
           </div> 
           <div class="line number99 index98 alt2"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp comments">这些地址信息将被保存到全局变量中，以方便使用</code> 
           </div> 
           <div class="line number100 index99 alt1"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp comments">*/</code> 
           </div> 
           <div class="line number101 index100 alt2"> 
            <code class="cpp keyword bold">void</code>&nbsp;
            <code class="cpp plain">get_sym_info(</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">pid,&nbsp;</code>
            <code class="cpp keyword bold">struct</code>&nbsp;
            <code class="cpp plain">link_map *lm)</code> 
           </div> 
           <div class="line number102 index101 alt1">
            <code class="cpp plain">{</code>
           </div> 
           <div class="line number103 index102 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">Elf32_Dyn *dyn = (Elf32_Dyn *)&nbsp;</code>
            <code class="cpp functions bold">malloc</code>
            <code class="cpp plain">(</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Dyn));</code> 
           </div> 
           <div class="line number104 index103 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">unsigned&nbsp;</code>
            <code class="cpp color1 bold">long</code>&nbsp;
            <code class="cpp plain">dyn_addr;</code> 
           </div> 
           <div class="line number105 index104 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("get_sym_info lm = %x\n",lm);</code> 
           </div> 
           <div class="line number106 index105 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("get_sym_info lm-&gt;l_ld's offset = %x\n",&amp;((struct link_map *)0)-&gt;l_ld);</code> 
           </div> 
           <div class="line number107 index106 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("get_sym_info &amp;lm-&gt;l_ld = %x\n",&amp;(lm-&gt;l_ld));</code> 
           </div> 
           <div class="line number108 index107 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//dyn_addr = (unsigned long)&amp;(lm-&gt;l_ld);</code> 
           </div> 
           <div class="line number109 index108 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//进入被跟踪进程获取动态节的地址&nbsp;&nbsp;</code> 
           </div> 
           <div class="line number110 index109 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_read(pid,&amp;(lm-&gt;l_ld) , &amp;dyn_addr,&nbsp;</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(dyn_addr));</code> 
           </div> 
           <div class="line number111 index110 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_read(pid,&amp;(lm-&gt;l_addr) , &amp;link_addr,&nbsp;</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(dyn_addr));</code> 
           </div> 
           <div class="line number112 index111 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_read(pid, dyn_addr, dyn,&nbsp;</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Dyn));</code> 
           </div> 
           <div class="line number113 index112 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//if(link_addr == 0)</code> 
           </div> 
           <div class="line number114 index113 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//&nbsp; getnchains(pid,IMAGE_ADDR);</code> 
           </div> 
           <div class="line number115 index114 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/*else</code> 
           </div> 
           <div class="line number116 index115 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">getnchains(pid,link_addr);*/</code> 
           </div> 
           <div class="line number117 index116 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">while</code>
            <code class="cpp plain">(dyn-&gt;d_tag != DT_NULL){</code> 
           </div> 
           <div class="line number118 index117 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("get_sym_info dyn-&gt;d_tag = %x\n",dyn-&gt;d_tag);</code> 
           </div> 
           <div class="line number119 index118 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("get_sym_info dyn-&gt;d_un.d_ptr = %x\n",dyn-&gt;d_un.d_ptr);</code> 
           </div> 
           <div class="line number120 index119 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">switch</code>
            <code class="cpp plain">(dyn-&gt;d_tag)</code> 
           </div> 
           <div class="line number121 index120 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">{</code> 
           </div> 
           <div class="line number122 index121 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">case</code>&nbsp;
            <code class="cpp plain">DT_SYMTAB:</code> 
           </div> 
           <div class="line number123 index122 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">symtab = dyn-&gt;d_un.d_ptr;</code> 
           </div> 
           <div class="line number124 index123 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number125 index124 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">break</code>
            <code class="cpp plain">;</code> 
           </div> 
           <div class="line number126 index125 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">case</code>&nbsp;
            <code class="cpp plain">DT_STRTAB:</code> 
           </div> 
           <div class="line number127 index126 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">strtab = dyn-&gt;d_un.d_ptr;</code> 
           </div> 
           <div class="line number128 index127 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">break</code>
            <code class="cpp plain">;</code> 
           </div> 
           <div class="line number129 index128 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/*case DT_HASH://可能不存在哈希表，此时nchains是错误的，这个值可以通过符号表得到</code> 
           </div> 
           <div class="line number130 index129 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("get_sym_info hash table's addr = %x\n",dyn-&gt;d_un.d_ptr);</code> 
           </div> 
           <div class="line number131 index130 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("get_sym_info symtbl's entry = %x\n",(dyn-&gt;d_un.d_ptr) + 4);</code> 
           </div> 
           <div class="line number132 index131 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">ptrace_read(pid, (dyn-&gt;d_un.d_ptr) + 4,&amp;nchains, sizeof(nchains));</code> 
           </div> 
           <div class="line number133 index132 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">break;*/</code> 
           </div> 
           <div class="line number134 index133 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">case</code>&nbsp;
            <code class="cpp plain">DT_JMPREL:</code> 
           </div> 
           <div class="line number135 index134 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">jmprel = dyn-&gt;d_un.d_ptr;</code> 
           </div> 
           <div class="line number136 index135 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">break</code>
            <code class="cpp plain">;</code> 
           </div> 
           <div class="line number137 index136 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">case</code>&nbsp;
            <code class="cpp plain">DT_PLTRELSZ:</code> 
           </div> 
           <div class="line number138 index137 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">totalrelsize = dyn-&gt;d_un.d_val;</code> 
           </div> 
           <div class="line number139 index138 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">break</code>
            <code class="cpp plain">;</code> 
           </div> 
           <div class="line number140 index139 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">case</code>&nbsp;
            <code class="cpp plain">DT_RELAENT:</code> 
           </div> 
           <div class="line number141 index140 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">relsize = dyn-&gt;d_un.d_val;</code> 
           </div> 
           <div class="line number142 index141 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">break</code>
            <code class="cpp plain">;</code> 
           </div> 
           <div class="line number143 index142 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">case</code>&nbsp;
            <code class="cpp plain">DT_RELENT:</code> 
           </div> 
           <div class="line number144 index143 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">relsize = dyn-&gt;d_un.d_val;</code> 
           </div> 
           <div class="line number145 index144 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">break</code>
            <code class="cpp plain">;</code> 
           </div> 
           <div class="line number146 index145 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">case</code>&nbsp;
            <code class="cpp plain">DT_REL:</code> 
           </div> 
           <div class="line number147 index146 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">reldyn = dyn-&gt;d_un.d_ptr;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code> 
           </div> 
           <div class="line number148 index147 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">break</code>
            <code class="cpp plain">;</code> 
           </div> 
           <div class="line number149 index148 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">case</code>&nbsp;
            <code class="cpp plain">DT_RELSZ:</code> 
           </div> 
           <div class="line number150 index149 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">reldynsz = dyn-&gt;d_un.d_val;</code> 
           </div> 
           <div class="line number151 index150 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">break</code>
            <code class="cpp plain">;</code> 
           </div> 
           <div class="line number152 index151 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number153 index152 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_read(pid, dyn_addr +=&nbsp;</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Dyn), dyn,&nbsp;</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Dyn));</code> 
           </div> 
           <div class="line number154 index153 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number155 index154 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number156 index155 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("get_sym_info link_addr = %x\n",link_addr);</code> 
           </div> 
           <div class="line number157 index156 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("get_sym_info symtab = %x\n",symtab);</code> 
           </div> 
           <div class="line number158 index157 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("get_sym_info relsize = %x\n",relsize);</code> 
           </div> 
           <div class="line number159 index158 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("get_sym_info reldyn = %x\n",reldyn);</code> 
           </div> 
           <div class="line number160 index159 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("get_sym_info totalrelsize = %x\n",totalrelsize);</code> 
           </div> 
           <div class="line number161 index160 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("get_sym_info jmprel = %x\n",jmprel);</code> 
           </div> 
           <div class="line number162 index161 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("get_sym_info nchains = %x\n",nchains);</code> 
           </div> 
           <div class="line number163 index162 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("get_sym_info strtab = %x\n",strtab);</code> 
           </div> 
           <div class="line number164 index163 alt1">
            &nbsp;
           </div> 
           <div class="line number165 index164 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">nrels = totalrelsize / relsize;</code> 
           </div> 
           <div class="line number166 index165 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">nreldyns = reldynsz/relsize;</code> 
           </div> 
           <div class="line number167 index166 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number168 index167 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("get_sym_info nreldyns = %d\n",nreldyns);</code> 
           </div> 
           <div class="line number169 index168 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("get_sym_info nrels = %d\n",nrels);</code> 
           </div> 
           <div class="line number170 index169 alt1">
            &nbsp;
           </div> 
           <div class="line number171 index170 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">free</code>
            <code class="cpp plain">(dyn);</code> 
           </div> 
           <div class="line number172 index171 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">printf</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"get_sym_info exit\n"</code>
            <code class="cpp plain">);</code> 
           </div> 
           <div class="line number173 index172 alt2">
            <code class="cpp plain">}</code>
           </div> 
           <div class="line number174 index173 alt1">
            <code class="cpp comments">/*</code>
           </div> 
           <div class="line number175 index174 alt2"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp comments">在指定的link_map指向的符号表查找符号，它仅仅是被上面的find_symbol使用</code> 
           </div> 
           <div class="line number176 index175 alt1"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp comments">*/</code> 
           </div> 
           <div class="line number177 index176 alt2"> 
            <code class="cpp plain">unsigned&nbsp;</code>
            <code class="cpp color1 bold">long</code>&nbsp;&nbsp;
            <code class="cpp plain">find_symbol_in_linkmap(</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">pid,&nbsp;</code>
            <code class="cpp keyword bold">struct</code>&nbsp;
            <code class="cpp plain">link_map *lm,&nbsp;</code>
            <code class="cpp color1 bold">char</code>&nbsp;
            <code class="cpp plain">*sym_name)</code> 
           </div> 
           <div class="line number178 index177 alt1">
            <code class="cpp plain">{</code>
           </div> 
           <div class="line number179 index178 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">Elf32_Sym *sym = (Elf32_Sym *)&nbsp;</code>
            <code class="cpp functions bold">malloc</code>
            <code class="cpp plain">(</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Sym));</code> 
           </div> 
           <div class="line number180 index179 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">i = 0;</code> 
           </div> 
           <div class="line number181 index180 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp color1 bold">char</code>&nbsp;
            <code class="cpp plain">*str;</code> 
           </div> 
           <div class="line number182 index181 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">unsigned&nbsp;</code>
            <code class="cpp color1 bold">long</code>&nbsp;
            <code class="cpp plain">ret;</code> 
           </div> 
           <div class="line number183 index182 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">flags = 0;</code> 
           </div> 
           <div class="line number184 index183 alt1">
            &nbsp;
           </div> 
           <div class="line number185 index184 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">get_sym_info(pid, lm);</code> 
           </div> 
           <div class="line number186 index185 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number187 index186 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">do</code>
            <code class="cpp plain">{</code> 
           </div> 
           <div class="line number188 index187 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>
            <code class="cpp plain">(ptrace_read(pid, symtab + i *&nbsp;</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Sym), sym,&nbsp;</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Sym)))</code> 
           </div> 
           <div class="line number189 index188 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">return</code>&nbsp;
            <code class="cpp plain">0;</code> 
           </div> 
           <div class="line number190 index189 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">i++;</code> 
           </div> 
           <div class="line number191 index190 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("find_symbol_in_linkmap sym-&gt;st_name = %x\tsym-&gt;st_size = %x\tsym-&gt;st_value = %x\n",sym-&gt;st_name,sym-&gt;st_size,sym-&gt;st_value);</code> 
           </div> 
           <div class="line number192 index191 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("find_symbol_in_linkmap Elf32_Sym's size = %d\n",sizeof(Elf32_Sym));</code> 
           </div> 
           <div class="line number193 index192 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("\nfind_symbol_in_linkmap sym-&gt;st_name = %x\n",sym-&gt;st_name);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code> 
           </div> 
           <div class="line number194 index193 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>&nbsp;
            <code class="cpp plain">(!sym-&gt;st_name &amp;&amp; !sym-&gt;st_size &amp;&amp; !sym-&gt;st_value)</code>
            <code class="cpp comments">//全为0是符号表的第一项</code> 
           </div> 
           <div class="line number195 index194 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">continue</code>
            <code class="cpp plain">;</code> 
           </div> 
           <div class="line number196 index195 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("\nfind_symbol_in_linkmap strtab = %x\n",strtab);</code> 
           </div> 
           <div class="line number197 index196 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">str = (</code>
            <code class="cpp color1 bold">char</code>&nbsp;
            <code class="cpp plain">*) ptrace_readstr(pid, strtab + sym-&gt;st_name);</code> 
           </div> 
           <div class="line number198 index197 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("\nfind_symbol_in_linkmap str = %s\n",str);</code> 
           </div> 
           <div class="line number199 index198 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("\nfind_symbol_in_linkmap sym-&gt;st_value = %x\n",sym-&gt;st_value);</code> 
           </div> 
           <div class="line number200 index199 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>&nbsp;
            <code class="cpp plain">(</code>
            <code class="cpp functions bold">strcmp</code>
            <code class="cpp plain">(str, sym_name) == 0) {</code> 
           </div> 
           <div class="line number201 index200 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">printf</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"\nfind_symbol_in_linkmap str = %s\n"</code>
            <code class="cpp plain">,str);</code> 
           </div> 
           <div class="line number202 index201 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">printf</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"\nfind_symbol_in_linkmap sym-&gt;st_value = %x\n"</code>
            <code class="cpp plain">,sym-&gt;st_value);</code> 
           </div> 
           <div class="line number203 index202 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">free</code>
            <code class="cpp plain">(str);</code> 
           </div> 
           <div class="line number204 index203 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>
            <code class="cpp plain">(sym-&gt;st_value == 0)</code>
            <code class="cpp comments">//值为0代表这个符号本身就是重定向的内容</code> 
           </div> 
           <div class="line number205 index204 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">continue</code>
            <code class="cpp plain">;</code> 
           </div> 
           <div class="line number206 index205 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">flags = 1;</code> 
           </div> 
           <div class="line number207 index206 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number208 index207 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//str = ptrace_readstr(pid, (unsigned long)lm-&gt;l_name);</code> 
           </div> 
           <div class="line number209 index208 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("find_symbol_in_linkmap lib name [%s]\n", str);</code> 
           </div> 
           <div class="line number210 index209 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//free(str);</code> 
           </div> 
           <div class="line number211 index210 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">break</code>
            <code class="cpp plain">;</code> 
           </div> 
           <div class="line number212 index211 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number213 index212 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number214 index213 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">free</code>
            <code class="cpp plain">(str);</code> 
           </div> 
           <div class="line number215 index214 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code>
            <code class="cpp keyword bold">while</code>
            <code class="cpp plain">(1);</code> 
           </div> 
           <div class="line number216 index215 alt1">
            &nbsp;
           </div> 
           <div class="line number217 index216 alt2">
            &nbsp;
           </div> 
           <div class="line number218 index217 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>&nbsp;
            <code class="cpp plain">(flags != 1)</code> 
           </div> 
           <div class="line number219 index218 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ret = 0;</code> 
           </div> 
           <div class="line number220 index219 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">else</code> 
           </div> 
           <div class="line number221 index220 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ret =&nbsp; link_addr + sym-&gt;st_value;</code> 
           </div> 
           <div class="line number222 index221 alt1">
            &nbsp;
           </div> 
           <div class="line number223 index222 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">free</code>
            <code class="cpp plain">(sym);</code> 
           </div> 
           <div class="line number224 index223 alt1">
            &nbsp;
           </div> 
           <div class="line number225 index224 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">return</code>&nbsp;
            <code class="cpp plain">ret;</code> 
           </div> 
           <div class="line number226 index225 alt1">
            <code class="cpp plain">}</code>
           </div> 
           <div class="line number227 index226 alt2">
            &nbsp;
           </div> 
           <div class="line number228 index227 alt1">
            <code class="cpp comments">/*</code>
           </div> 
           <div class="line number229 index228 alt2"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp comments">解析指定符号</code> 
           </div> 
           <div class="line number230 index229 alt1"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp comments">*/</code> 
           </div> 
           <div class="line number231 index230 alt2"> 
            <code class="cpp plain">unsigned&nbsp;</code>
            <code class="cpp color1 bold">long</code>&nbsp;&nbsp;
            <code class="cpp plain">find_symbol(</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">pid,&nbsp;</code>
            <code class="cpp keyword bold">struct</code>&nbsp;
            <code class="cpp plain">link_map *map,&nbsp;</code>
            <code class="cpp color1 bold">char</code>&nbsp;
            <code class="cpp plain">*sym_name)</code> 
           </div> 
           <div class="line number232 index231 alt1">
            <code class="cpp plain">{</code>
           </div> 
           <div class="line number233 index232 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">struct</code>&nbsp;
            <code class="cpp plain">link_map *lm = map;</code> 
           </div> 
           <div class="line number234 index233 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">unsigned&nbsp;</code>
            <code class="cpp color1 bold">long</code>&nbsp;
            <code class="cpp plain">sym_addr;</code> 
           </div> 
           <div class="line number235 index234 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp color1 bold">char</code>&nbsp;
            <code class="cpp plain">*str;</code> 
           </div> 
           <div class="line number236 index235 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">unsigned&nbsp;</code>
            <code class="cpp color1 bold">long</code>&nbsp;
            <code class="cpp plain">tmp;</code> 
           </div> 
           <div class="line number237 index236 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number238 index237 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//sym_addr = find_symbol_in_linkmap(pid, map, sym_name);</code> 
           </div> 
           <div class="line number239 index238 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//return 0;</code> 
           </div> 
           <div class="line number240 index239 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//if (sym_addr)</code> 
           </div> 
           <div class="line number241 index240 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//&nbsp;&nbsp; return sym_addr;</code> 
           </div> 
           <div class="line number242 index241 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("\nfind_symbol map = %x\n",map);</code> 
           </div> 
           <div class="line number243 index242 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//ptrace_read(pid,(char *)map+12,&amp;tmp,4);</code> 
           </div> 
           <div class="line number244 index243 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//lm = tmp;</code> 
           </div> 
           <div class="line number245 index244 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("find_symbol lm = %x\n",lm);</code> 
           </div> 
           <div class="line number246 index245 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//ptrace_read(pid, (unsigned long)map-&gt;l_next, lm, sizeof(struct link_map));</code> 
           </div> 
           <div class="line number247 index246 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">sym_addr = find_symbol_in_linkmap(pid, lm, sym_name);</code> 
           </div> 
           <div class="line number248 index247 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">while</code>
            <code class="cpp plain">(!sym_addr ) {</code> 
           </div> 
           <div class="line number249 index248 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_read(pid, (</code>
            <code class="cpp color1 bold">char</code>&nbsp;
            <code class="cpp plain">*)lm+12, &amp;tmp, 4);</code>
            <code class="cpp comments">//获取下一个库的link_map地址</code> 
           </div> 
           <div class="line number250 index249 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>
            <code class="cpp plain">(tmp == 0)</code> 
           </div> 
           <div class="line number251 index250 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">return</code>&nbsp;
            <code class="cpp plain">0;</code> 
           </div> 
           <div class="line number252 index251 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">lm = tmp;</code> 
           </div> 
           <div class="line number253 index252 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("find_symbol lm = %x\n",lm);</code> 
           </div> 
           <div class="line number254 index253 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/*str = ptrace_readstr(pid, (unsigned long)lm-&gt;l_name);</code> 
           </div> 
           <div class="line number255 index254 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">if(str[0] == '/0')</code> 
           </div> 
           <div class="line number256 index255 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">continue;</code> 
           </div> 
           <div class="line number257 index256 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">printf("[%s]\n", str);</code> 
           </div> 
           <div class="line number258 index257 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">free(str);*/</code> 
           </div> 
           <div class="line number259 index258 alt2">
            &nbsp;
           </div> 
           <div class="line number260 index259 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>&nbsp;
            <code class="cpp plain">((sym_addr = find_symbol_in_linkmap(pid, lm, sym_name)))</code> 
           </div> 
           <div class="line number261 index260 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">break</code>
            <code class="cpp plain">;</code> 
           </div> 
           <div class="line number262 index261 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number263 index262 alt2">
            &nbsp;
           </div> 
           <div class="line number264 index263 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">return</code>&nbsp;
            <code class="cpp plain">sym_addr;</code> 
           </div> 
           <div class="line number265 index264 alt2">
            <code class="cpp plain">}</code>
           </div> 
           <div class="line number266 index265 alt1">
            &nbsp;
           </div> 
           <div class="line number267 index266 alt2">
            &nbsp;
           </div> 
           <div class="line number268 index267 alt1">
            <code class="cpp comments">/* 查找符号的重定位地址 */</code>
           </div> 
           <div class="line number269 index268 alt2"> 
            <code class="cpp plain">unsigned&nbsp;</code>
            <code class="cpp color1 bold">long</code>&nbsp;&nbsp;
            <code class="cpp plain">find_sym_in_rel(</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">pid,&nbsp;</code>
            <code class="cpp color1 bold">char</code>&nbsp;
            <code class="cpp plain">*sym_name)</code> 
           </div> 
           <div class="line number270 index269 alt1">
            <code class="cpp plain">{</code>
           </div> 
           <div class="line number271 index270 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">Elf32_Rel *rel = (Elf32_Rel *)&nbsp;</code>
            <code class="cpp functions bold">malloc</code>
            <code class="cpp plain">(</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Rel));</code> 
           </div> 
           <div class="line number272 index271 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">Elf32_Sym *sym = (Elf32_Sym *)&nbsp;</code>
            <code class="cpp functions bold">malloc</code>
            <code class="cpp plain">(</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Sym));</code> 
           </div> 
           <div class="line number273 index272 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">i;</code> 
           </div> 
           <div class="line number274 index273 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp color1 bold">char</code>&nbsp;
            <code class="cpp plain">*str;</code> 
           </div> 
           <div class="line number275 index274 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">unsigned&nbsp;</code>
            <code class="cpp color1 bold">long</code>&nbsp;
            <code class="cpp plain">ret;</code> 
           </div> 
           <div class="line number276 index275 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">struct</code>&nbsp;
            <code class="cpp plain">link_map *lm;</code> 
           </div> 
           <div class="line number277 index276 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">lm = map_addr;</code> 
           </div> 
           <div class="line number278 index277 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number279 index278 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//get_dyn_info(pid);</code> 
           </div> 
           <div class="line number280 index279 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">do</code>
            <code class="cpp plain">{</code> 
           </div> 
           <div class="line number281 index280 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">get_sym_info(pid,lm);</code> 
           </div> 
           <div class="line number282 index281 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_read(pid, (</code>
            <code class="cpp color1 bold">char</code>&nbsp;
            <code class="cpp plain">*)lm+12, &amp;lm, 4);</code> 
           </div> 
           <div class="line number283 index282 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//首先查找过程连接的重定位表</code> 
           </div> 
           <div class="line number284 index283 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">for</code>
            <code class="cpp plain">(i = 0; i&lt; nrels ;i++) {</code> 
           </div> 
           <div class="line number285 index284 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_read(pid, (unsigned&nbsp;</code>
            <code class="cpp color1 bold">long</code>
            <code class="cpp plain">)(jmprel + i *&nbsp;</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Rel)),</code> 
           </div> 
           <div class="line number286 index285 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">rel,&nbsp;</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Rel));</code> 
           </div> 
           <div class="line number287 index286 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>
            <code class="cpp plain">(ELF32_R_SYM(rel-&gt;r_info)) {</code> 
           </div> 
           <div class="line number288 index287 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_read(pid, symtab + ELF32_R_SYM(rel-&gt;r_info) *</code> 
           </div> 
           <div class="line number289 index288 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Sym), sym,&nbsp;</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Sym));</code> 
           </div> 
           <div class="line number290 index289 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">str = ptrace_readstr(pid, strtab + sym-&gt;st_name);</code> 
           </div> 
           <div class="line number291 index290 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>&nbsp;
            <code class="cpp plain">(</code>
            <code class="cpp functions bold">strcmp</code>
            <code class="cpp plain">(str, sym_name) == 0) {</code> 
           </div> 
           <div class="line number292 index291 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>
            <code class="cpp plain">(sym-&gt;st_value != 0){</code> 
           </div> 
           <div class="line number293 index292 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">free</code>
            <code class="cpp plain">(str);</code> 
           </div> 
           <div class="line number294 index293 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">continue</code>
            <code class="cpp plain">;</code> 
           </div> 
           <div class="line number295 index294 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number296 index295 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">modifyflag = 1;</code> 
           </div> 
           <div class="line number297 index296 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">free</code>
            <code class="cpp plain">(str);</code> 
           </div> 
           <div class="line number298 index297 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">break</code>
            <code class="cpp plain">;</code> 
           </div> 
           <div class="line number299 index298 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number300 index299 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">free</code>
            <code class="cpp plain">(str);</code> 
           </div> 
           <div class="line number301 index300 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number302 index301 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number303 index302 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number304 index303 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>
            <code class="cpp plain">(modifyflag == 1)</code> 
           </div> 
           <div class="line number305 index304 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">break</code>
            <code class="cpp plain">;</code> 
           </div> 
           <div class="line number306 index305 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//没找到的话，再找在链接时就重定位的重定位表</code> 
           </div> 
           <div class="line number307 index306 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">for</code>
            <code class="cpp plain">(i = 0; i&lt; nreldyns;i++) {</code> 
           </div> 
           <div class="line number308 index307 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_read(pid, (unsigned&nbsp;</code>
            <code class="cpp color1 bold">long</code>
            <code class="cpp plain">)(reldyn+ i *&nbsp;</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Rel)),</code> 
           </div> 
           <div class="line number309 index308 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">rel,&nbsp;</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Rel));</code> 
           </div> 
           <div class="line number310 index309 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>
            <code class="cpp plain">(ELF32_R_SYM(rel-&gt;r_info)) {</code> 
           </div> 
           <div class="line number311 index310 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_read(pid, symtab + ELF32_R_SYM(rel-&gt;r_info) *</code> 
           </div> 
           <div class="line number312 index311 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Sym), sym,&nbsp;</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(Elf32_Sym));</code> 
           </div> 
           <div class="line number313 index312 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">str = ptrace_readstr(pid, strtab + sym-&gt;st_name);</code> 
           </div> 
           <div class="line number314 index313 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>&nbsp;
            <code class="cpp plain">(</code>
            <code class="cpp functions bold">strcmp</code>
            <code class="cpp plain">(str, sym_name) == 0) {</code> 
           </div> 
           <div class="line number315 index314 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>
            <code class="cpp plain">(sym-&gt;st_value != 0){</code> 
           </div> 
           <div class="line number316 index315 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">free</code>
            <code class="cpp plain">(str);</code> 
           </div> 
           <div class="line number317 index316 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">continue</code>
            <code class="cpp plain">;</code> 
           </div> 
           <div class="line number318 index317 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number319 index318 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">modifyflag = 2;</code> 
           </div> 
           <div class="line number320 index319 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">free</code>
            <code class="cpp plain">(str);</code> 
           </div> 
           <div class="line number321 index320 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">break</code>
            <code class="cpp plain">;</code> 
           </div> 
           <div class="line number322 index321 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number323 index322 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">free</code>
            <code class="cpp plain">(str);</code> 
           </div> 
           <div class="line number324 index323 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number325 index324 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number326 index325 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number327 index326 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>
            <code class="cpp plain">(modifyflag == 2)</code> 
           </div> 
           <div class="line number328 index327 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">break</code>
            <code class="cpp plain">;</code> 
           </div> 
           <div class="line number329 index328 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number330 index329 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code>
            <code class="cpp keyword bold">while</code>
            <code class="cpp plain">(lm);</code> 
           </div> 
           <div class="line number331 index330 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("find_sym_in_rel flags = %d\n",flags);</code> 
           </div> 
           <div class="line number332 index331 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>&nbsp;
            <code class="cpp plain">(modifyflag == 0)</code> 
           </div> 
           <div class="line number333 index332 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ret = 0;</code> 
           </div> 
           <div class="line number334 index333 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">else</code> 
           </div> 
           <div class="line number335 index334 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ret =&nbsp; link_addr + rel-&gt;r_offset;</code> 
           </div> 
           <div class="line number336 index335 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("find_sym_in_rel link_addr = %x\t sym-&gt;st_value = %x\n",link_addr , sym-&gt;st_value);</code> 
           </div> 
           <div class="line number337 index336 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">free</code>
            <code class="cpp plain">(rel);</code> 
           </div> 
           <div class="line number338 index337 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">free</code>
            <code class="cpp plain">(sym);</code> 
           </div> 
           <div class="line number339 index338 alt2">
            &nbsp;
           </div> 
           <div class="line number340 index339 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">return</code>&nbsp;
            <code class="cpp plain">ret;</code> 
           </div> 
           <div class="line number341 index340 alt2">
            <code class="cpp plain">}</code>
           </div> 
           <div class="line number342 index341 alt1">
            &nbsp;
           </div> 
           <div class="line number343 index342 alt2">
            <code class="cpp comments">/*</code>
           </div> 
           <div class="line number344 index343 alt1"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp comments">在进程自身的映象中（即不包括动态共享库，无须遍历link_map链表）获得各种动态信息</code> 
           </div> 
           <div class="line number345 index344 alt2"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp comments">*/</code> 
           </div> 
           <div class="line number346 index345 alt1">
            <code class="cpp comments">/*void get_dyn_info(int pid)</code>
           </div> 
           <div class="line number347 index346 alt2">
            <code class="cpp comments">{</code>
           </div> 
           <div class="line number348 index347 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">Elf32_Dyn *dyn = (Elf32_Dyn *) malloc(sizeof(Elf32_Dyn));</code> 
           </div> 
           <div class="line number349 index348 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">int i = 0;</code> 
           </div> 
           <div class="line number350 index349 alt1">
            &nbsp;
           </div> 
           <div class="line number351 index350 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">ptrace_read(pid, dyn_addr + i * sizeof(Elf32_Dyn), dyn, sizeof(Elf32_Dyn));</code> 
           </div> 
           <div class="line number352 index351 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">i++;</code> 
           </div> 
           <div class="line number353 index352 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">while(dyn-&gt;d_tag){</code> 
           </div> 
           <div class="line number354 index353 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">switch(dyn-&gt;d_tag)</code> 
           </div> 
           <div class="line number355 index354 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">{</code> 
           </div> 
           <div class="line number356 index355 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">case DT_SYMTAB:</code> 
           </div> 
           <div class="line number357 index356 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//puts("DT_SYMTAB");</code> 
           </div> 
           <div class="line number358 index357 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">symtab = dyn-&gt;d_un.d_ptr;</code> 
           </div> 
           <div class="line number359 index358 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">break;</code> 
           </div> 
           <div class="line number360 index359 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">case DT_STRTAB:</code> 
           </div> 
           <div class="line number361 index360 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">strtab = dyn-&gt;d_un.d_ptr;</code> 
           </div> 
           <div class="line number362 index361 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//puts("DT_STRTAB");</code> 
           </div> 
           <div class="line number363 index362 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">break;</code> 
           </div> 
           <div class="line number364 index363 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">case DT_JMPREL:</code> 
           </div> 
           <div class="line number365 index364 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">jmprel = dyn-&gt;d_un.d_ptr;</code> 
           </div> 
           <div class="line number366 index365 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//puts("DT_JMPREL");</code> 
           </div> 
           <div class="line number367 index366 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("jmprel\t %p\n", jmprel);</code> 
           </div> 
           <div class="line number368 index367 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">break;</code> 
           </div> 
           <div class="line number369 index368 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">case DT_PLTRELSZ:</code> 
           </div> 
           <div class="line number370 index369 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">totalrelsize = dyn-&gt;d_un.d_val;</code> 
           </div> 
           <div class="line number371 index370 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//puts("DT_PLTRELSZ");</code> 
           </div> 
           <div class="line number372 index371 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">break;</code> 
           </div> 
           <div class="line number373 index372 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">case DT_RELAENT:</code> 
           </div> 
           <div class="line number374 index373 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">relsize = dyn-&gt;d_un.d_val;</code> 
           </div> 
           <div class="line number375 index374 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//puts("DT_RELAENT");</code> 
           </div> 
           <div class="line number376 index375 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">break;</code> 
           </div> 
           <div class="line number377 index376 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">case DT_RELENT:</code> 
           </div> 
           <div class="line number378 index377 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">relsize = dyn-&gt;d_un.d_val;</code> 
           </div> 
           <div class="line number379 index378 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//puts("DT_RELENT");</code> 
           </div> 
           <div class="line number380 index379 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">break;</code> 
           </div> 
           <div class="line number381 index380 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">}</code> 
           </div> 
           <div class="line number382 index381 alt1">
            &nbsp;
           </div> 
           <div class="line number383 index382 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">ptrace_read(pid, dyn_addr + i * sizeof(Elf32_Dyn), dyn, sizeof(Elf32_Dyn));</code> 
           </div> 
           <div class="line number384 index383 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">i++;</code> 
           </div> 
           <div class="line number385 index384 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">}</code> 
           </div> 
           <div class="line number386 index385 alt1">
            &nbsp;
           </div> 
           <div class="line number387 index386 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">nrels = totalrelsize / relsize;</code> 
           </div> 
           <div class="line number388 index387 alt1">
            &nbsp;
           </div> 
           <div class="line number389 index388 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">free(dyn);</code> 
           </div> 
           <div class="line number390 index389 alt1">
            <code class="cpp comments">}*/</code>
           </div> 
           <div class="line number391 index390 alt2">
            &nbsp;
           </div> 
           <div class="line number392 index391 alt1">
            <code class="cpp comments">/*void call_dl_open(int pid, unsigned long addr, char *libname)</code>
           </div> 
           <div class="line number393 index392 alt2">
            <code class="cpp comments">{</code>
           </div> 
           <div class="line number394 index393 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">void *pRLibName;</code> 
           </div> 
           <div class="line number395 index394 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">struct user_regs_struct regs;</code> 
           </div> 
           <div class="line number396 index395 alt1">
            &nbsp;
           </div> 
           <div class="line number397 index396 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/*</code> 
           </div> 
           <div class="line number398 index397 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">先找个空间存放要装载的共享库名，我们可以简单的把它放入堆栈</code> 
           </div> 
           <div class="line number399 index398 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number400 index399 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">pRLibName = ptrace_push(pid, libname, strlen(libname) + 1);</code> 
           </div> 
           <div class="line number401 index400 alt2">
            &nbsp;
           </div> 
           <div class="line number402 index401 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/* 设置参数到寄存器</code> 
           </div> 
           <div class="line number403 index402 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">ptrace_readreg(pid, &amp;regs);</code> 
           </div> 
           <div class="line number404 index403 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">regs.eax = (unsigned long) pRLibName;</code> 
           </div> 
           <div class="line number405 index404 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">regs.ecx = 0x0;</code> 
           </div> 
           <div class="line number406 index405 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">regs.edx = RTLD_LAZY;</code> 
           </div> 
           <div class="line number407 index406 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">ptrace_writereg(pid, &amp;regs);</code> 
           </div> 
           <div class="line number408 index407 alt1">
            &nbsp;
           </div> 
           <div class="line number409 index408 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/* 调用_dl_open</code> 
           </div> 
           <div class="line number410 index409 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">ptrace_call(pid, addr);</code> 
           </div> 
           <div class="line number411 index410 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">puts("call _dl_open ok");</code> 
           </div> 
           <div class="line number412 index411 alt1">
            <code class="cpp comments">}*/</code>
           </div> 
           <div class="line number413 index412 alt2">
            &nbsp;
           </div> 
           <div class="line number414 index413 alt1">
            &nbsp;
           </div> 
           <div class="line number415 index414 alt2">
            &nbsp;
           </div> 
           <div class="line number416 index415 alt1">
            &nbsp;
           </div> 
           <div class="line number417 index416 alt2">
            <code class="cpp comments">/*#define RTLD_LAZY 0x00001</code>
           </div> 
           <div class="line number418 index417 alt1">
            <code class="cpp comments">#define RTLD_NOW&nbsp;&nbsp;&nbsp; 0x00002</code>
           </div> 
           <div class="line number419 index418 alt2">
            <code class="cpp comments">#define RTLD_BINDING_MASK&nbsp;&nbsp; 0x3</code>
           </div> 
           <div class="line number420 index419 alt1">
            <code class="cpp comments">#define RTLD_NOLOAD 0x00004</code>
           </div> 
           <div class="line number421 index420 alt2">
            <code class="cpp comments">#define RTLD_DEEPBIND&nbsp;&nbsp; 0x00008</code>
           </div> 
           <div class="line number422 index421 alt1">
            &nbsp;
           </div> 
           <div class="line number423 index422 alt2">
            <code class="cpp comments">#define RTLD_GLOBAL 0x00100</code>
           </div> 
           <div class="line number424 index423 alt1">
            &nbsp;
           </div> 
           <div class="line number425 index424 alt2">
            <code class="cpp comments">#define RTLD_LOCAL&nbsp; 0</code>
           </div> 
           <div class="line number426 index425 alt1">
            &nbsp;
           </div> 
           <div class="line number427 index426 alt2">
            <code class="cpp comments">#define RTLD_NODELETE&nbsp;&nbsp; 0x01000 */</code>
           </div> 
           <div class="line number428 index427 alt1">
            &nbsp;
           </div> 
           <div class="line number429 index428 alt2"> 
            <code class="cpp keyword bold">void</code>&nbsp;
            <code class="cpp plain">call__libc_dlopen_mode(</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">pid, unsigned&nbsp;</code>
            <code class="cpp color1 bold">long</code>&nbsp;
            <code class="cpp plain">addr,&nbsp;</code>
            <code class="cpp color1 bold">char</code>&nbsp;
            <code class="cpp plain">*libname)</code> 
           </div> 
           <div class="line number430 index429 alt1">
            <code class="cpp plain">{</code>
           </div> 
           <div class="line number431 index430 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">void</code>&nbsp;
            <code class="cpp plain">*plibnameaddr;</code> 
           </div> 
           <div class="line number432 index431 alt1">
            &nbsp;
           </div> 
           <div class="line number433 index432 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("call__libc_dlopen_mode libname = %s\n",libname);</code> 
           </div> 
           <div class="line number434 index433 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("call__libc_dlopen_mode addr = %x\n",addr);</code> 
           </div> 
           <div class="line number435 index434 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//将需要加载的共享库地址压栈</code> 
           </div> 
           <div class="line number436 index435 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">plibnameaddr = ptrace_push(pid, libname,&nbsp;</code>
            <code class="cpp functions bold">strlen</code>
            <code class="cpp plain">(libname) + 1);</code> 
           </div> 
           <div class="line number437 index436 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_push(pid,&amp;mode,</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(</code>
            <code class="cpp color1 bold">int</code>
            <code class="cpp plain">));</code> 
           </div> 
           <div class="line number438 index437 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_push(pid,&amp;plibnameaddr,</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(plibnameaddr));</code> 
           </div> 
           <div class="line number439 index438 alt2">
            &nbsp;
           </div> 
           <div class="line number440 index439 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/* 调用__libc_dlopen_mode */</code> 
           </div> 
           <div class="line number441 index440 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_call(pid, addr);</code> 
           </div> 
           <div class="line number442 index441 alt1">
            <code class="cpp plain">}</code>
           </div> 
           <div class="line number443 index442 alt2"> 
            <code class="cpp keyword bold">void</code>&nbsp;
            <code class="cpp plain">call_printf(</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">pid, unsigned&nbsp;</code>
            <code class="cpp color1 bold">long</code>&nbsp;
            <code class="cpp plain">addr,&nbsp;</code>
            <code class="cpp color1 bold">char</code>&nbsp;
            <code class="cpp plain">*string)</code> 
           </div> 
           <div class="line number444 index443 alt1">
            <code class="cpp plain">{</code>
           </div> 
           <div class="line number445 index444 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">void</code>&nbsp;
            <code class="cpp plain">*paddr;</code> 
           </div> 
           <div class="line number446 index445 alt1">
            &nbsp;
           </div> 
           <div class="line number447 index446 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">paddr = ptrace_push(pid, string,&nbsp;</code>
            <code class="cpp functions bold">strlen</code>
            <code class="cpp plain">(string) + 1);</code> 
           </div> 
           <div class="line number448 index447 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_push(pid,&amp;paddr,</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(paddr));</code> 
           </div> 
           <div class="line number449 index448 alt2">
            &nbsp;
           </div> 
           <div class="line number450 index449 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_call(pid, addr);</code> 
           </div> 
           <div class="line number451 index450 alt2">
            <code class="cpp plain">}</code>
           </div> 
          </div> </td> 
        </tr>
       </tbody>
      </table>
     </div> 
    </div> 
   </div> 
   <p>　　作者所做的修改，读者可以对比文章最后的连接中的代码。</p> 
   <p>　　这边对于程序的具体解释，就不具体展开了。</p> 
   <p>　　需要注意的是，原来是采用_dl_open的方式加载库函数，但是ld库并没有这个符号导出。而libc库中导出了一个可以加载库的__libc_dlopen_mode函数。</p> 
   <ul>
    <li>5.主函数</li> 
   </ul>
   <p>　　先说一下流程，</p> 
   <p>　　a.获取被跟踪进程的link_map地址</p> 
   <p>　　b.根据link_map给出的信息，搜索符号表，遍历每一个link_map中的符号表，直到找到想要找的符号。这里是printf或者__libc_dlopen_mode函数</p> 
   <p>　　c.将库路径包括库名称传递给调用__libc_dlopen_mode的函数，该函数即call__libc_dlopen_mode会把__libc_dlopen_mode函数需要的参数，路径和加载方式压栈，在让被跟踪进</p> 
   <p>　　　程开始运行之前，压入一个非法地址，当__libc_dlopen_mode返回时返回到一个非法地址时，就会发生中断，此时跟踪进程可以waitpid跟踪到。好，设置寄存器，并让被跟踪进程开</p> 
   <p>　　　始运行。打开库之后，被跟踪进程因中断而被跟踪进程再次获得控制权。</p> 
   <p>　　d.再一次根据之前保存的link_map信息，当然完全可以直接用上一次搜索结果结束之后的link_map往后找，因为新库一定在最后，但是本文还是从头开始找，找到新库中的</p> 
   <p>　　　newmyprint地址。</p> 
   <p>　　e.还是根据link_map信息查找printf的重定向地址，在rel.dyn节中，有关这个rel.dyn和rel.plt等节之间的关系，可以看我的其他博文。</p> 
   <p>　　f.将newmyprint的地址填入printf的重定向地址。</p> 
   <p>　　g.将被跟踪进程原先的寄存器设置回去，释放控制。</p> 
   <p>　　h.被跟踪进程开始输出“哈哈哈哈哈”。</p> 
   <p>　　上源码：</p> 
   <p>　　</p> 
   <div class="cnblogs_Highlighter sh-gutter"> 
    <div> 
     <div class="syntaxhighlighter cpp"> 
      <table border="0">
       <tbody>
        <tr>
         <td class="gutter"> 
          <div class="line number1 index0 alt2">
           1
          </div> 
          <div class="line number2 index1 alt1">
           2
          </div> 
          <div class="line number3 index2 alt2">
           3
          </div> 
          <div class="line number4 index3 alt1">
           4
          </div> 
          <div class="line number5 index4 alt2">
           5
          </div> 
          <div class="line number6 index5 alt1">
           6
          </div> 
          <div class="line number7 index6 alt2">
           7
          </div> 
          <div class="line number8 index7 alt1">
           8
          </div> 
          <div class="line number9 index8 alt2">
           9
          </div> 
          <div class="line number10 index9 alt1">
           10
          </div> 
          <div class="line number11 index10 alt2">
           11
          </div> 
          <div class="line number12 index11 alt1">
           12
          </div> 
          <div class="line number13 index12 alt2">
           13
          </div> 
          <div class="line number14 index13 alt1">
           14
          </div> 
          <div class="line number15 index14 alt2">
           15
          </div> 
          <div class="line number16 index15 alt1">
           16
          </div> 
          <div class="line number17 index16 alt2">
           17
          </div> 
          <div class="line number18 index17 alt1">
           18
          </div> 
          <div class="line number19 index18 alt2">
           19
          </div> 
          <div class="line number20 index19 alt1">
           20
          </div> 
          <div class="line number21 index20 alt2">
           21
          </div> 
          <div class="line number22 index21 alt1">
           22
          </div> 
          <div class="line number23 index22 alt2">
           23
          </div> 
          <div class="line number24 index23 alt1">
           24
          </div> 
          <div class="line number25 index24 alt2">
           25
          </div> 
          <div class="line number26 index25 alt1">
           26
          </div> 
          <div class="line number27 index26 alt2">
           27
          </div> 
          <div class="line number28 index27 alt1">
           28
          </div> 
          <div class="line number29 index28 alt2">
           29
          </div> 
          <div class="line number30 index29 alt1">
           30
          </div> 
          <div class="line number31 index30 alt2">
           31
          </div> 
          <div class="line number32 index31 alt1">
           32
          </div> 
          <div class="line number33 index32 alt2">
           33
          </div> 
          <div class="line number34 index33 alt1">
           34
          </div> 
          <div class="line number35 index34 alt2">
           35
          </div> 
          <div class="line number36 index35 alt1">
           36
          </div> 
          <div class="line number37 index36 alt2">
           37
          </div> 
          <div class="line number38 index37 alt1">
           38
          </div> 
          <div class="line number39 index38 alt2">
           39
          </div> 
          <div class="line number40 index39 alt1">
           40
          </div> 
          <div class="line number41 index40 alt2">
           41
          </div> 
          <div class="line number42 index41 alt1">
           42
          </div> 
          <div class="line number43 index42 alt2">
           43
          </div> 
          <div class="line number44 index43 alt1">
           44
          </div> 
          <div class="line number45 index44 alt2">
           45
          </div> 
          <div class="line number46 index45 alt1">
           46
          </div> 
          <div class="line number47 index46 alt2">
           47
          </div> 
          <div class="line number48 index47 alt1">
           48
          </div> 
          <div class="line number49 index48 alt2">
           49
          </div> 
          <div class="line number50 index49 alt1">
           50
          </div> 
          <div class="line number51 index50 alt2">
           51
          </div> 
          <div class="line number52 index51 alt1">
           52
          </div> 
          <div class="line number53 index52 alt2">
           53
          </div> 
          <div class="line number54 index53 alt1">
           54
          </div> 
          <div class="line number55 index54 alt2">
           55
          </div> 
          <div class="line number56 index55 alt1">
           56
          </div> 
          <div class="line number57 index56 alt2">
           57
          </div> 
          <div class="line number58 index57 alt1">
           58
          </div> 
          <div class="line number59 index58 alt2">
           59
          </div> 
          <div class="line number60 index59 alt1">
           60
          </div> 
          <div class="line number61 index60 alt2">
           61
          </div> 
          <div class="line number62 index61 alt1">
           62
          </div> 
          <div class="line number63 index62 alt2">
           63
          </div> 
          <div class="line number64 index63 alt1">
           64
          </div> 
          <div class="line number65 index64 alt2">
           65
          </div> 
          <div class="line number66 index65 alt1">
           66
          </div> 
          <div class="line number67 index66 alt2">
           67
          </div> 
          <div class="line number68 index67 alt1">
           68
          </div> 
          <div class="line number69 index68 alt2">
           69
          </div> 
          <div class="line number70 index69 alt1">
           70
          </div> 
          <div class="line number71 index70 alt2">
           71
          </div> 
          <div class="line number72 index71 alt1">
           72
          </div> 
          <div class="line number73 index72 alt2">
           73
          </div> 
          <div class="line number74 index73 alt1">
           74
          </div> 
          <div class="line number75 index74 alt2">
           75
          </div> 
          <div class="line number76 index75 alt1">
           76
          </div> 
          <div class="line number77 index76 alt2">
           77
          </div> 
          <div class="line number78 index77 alt1">
           78
          </div> 
          <div class="line number79 index78 alt2">
           79
          </div> 
          <div class="line number80 index79 alt1">
           80
          </div> 
          <div class="line number81 index80 alt2">
           81
          </div> 
          <div class="line number82 index81 alt1">
           82
          </div> 
          <div class="line number83 index82 alt2">
           83
          </div> 
          <div class="line number84 index83 alt1">
           84
          </div> 
          <div class="line number85 index84 alt2">
           85
          </div> 
          <div class="line number86 index85 alt1">
           86
          </div> 
          <div class="line number87 index86 alt2">
           87
          </div> 
          <div class="line number88 index87 alt1">
           88
          </div> 
          <div class="line number89 index88 alt2">
           89
          </div> 
          <div class="line number90 index89 alt1">
           90
          </div> 
          <div class="line number91 index90 alt2">
           91
          </div> 
          <div class="line number92 index91 alt1">
           92
          </div> 
          <div class="line number93 index92 alt2">
           93
          </div> 
          <div class="line number94 index93 alt1">
           94
          </div> 
          <div class="line number95 index94 alt2">
           95
          </div> 
          <div class="line number96 index95 alt1">
           96
          </div> 
          <div class="line number97 index96 alt2">
           97
          </div> 
          <div class="line number98 index97 alt1">
           98
          </div> 
          <div class="line number99 index98 alt2">
           99
          </div> 
          <div class="line number100 index99 alt1">
           100
          </div> 
          <div class="line number101 index100 alt2">
           101
          </div> 
          <div class="line number102 index101 alt1">
           102
          </div> 
          <div class="line number103 index102 alt2">
           103
          </div> 
          <div class="line number104 index103 alt1">
           104
          </div> 
          <div class="line number105 index104 alt2">
           105
          </div> 
          <div class="line number106 index105 alt1">
           106
          </div> 
          <div class="line number107 index106 alt2">
           107
          </div> 
          <div class="line number108 index107 alt1">
           108
          </div> 
          <div class="line number109 index108 alt2">
           109
          </div> 
          <div class="line number110 index109 alt1">
           110
          </div> 
          <div class="line number111 index110 alt2">
           111
          </div> 
          <div class="line number112 index111 alt1">
           112
          </div> </td> 
         <td class="code"> 
          <div> 
           <div class="line number1 index0 alt2"> 
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">main(</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">argc,&nbsp;</code>
            <code class="cpp color1 bold">char</code>&nbsp;
            <code class="cpp plain">*argv[])</code> 
           </div> 
           <div class="line number2 index1 alt1">
            <code class="cpp plain">{</code>
           </div> 
           <div class="line number3 index2 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">pid;</code> 
           </div> 
           <div class="line number4 index3 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">struct</code>&nbsp;
            <code class="cpp plain">link_map *map;</code> 
           </div> 
           <div class="line number5 index4 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp color1 bold">char</code>&nbsp;
            <code class="cpp plain">sym_name[256];</code> 
           </div> 
           <div class="line number6 index5 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">unsigned&nbsp;</code>
            <code class="cpp color1 bold">long</code>&nbsp;
            <code class="cpp plain">sym_addr;</code> 
           </div> 
           <div class="line number7 index6 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">unsigned&nbsp;</code>
            <code class="cpp color1 bold">long</code>&nbsp;
            <code class="cpp plain">new_addr,old_addr,rel_addr;</code> 
           </div> 
           <div class="line number8 index7 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">status = 0;</code> 
           </div> 
           <div class="line number9 index8 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp color1 bold">char</code>&nbsp;
            <code class="cpp plain">libpath[1024];</code> 
           </div> 
           <div class="line number10 index9 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp color1 bold">char</code>&nbsp;
            <code class="cpp plain">oldfunname[128];</code> 
           </div> 
           <div class="line number11 index10 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp color1 bold">char</code>&nbsp;
            <code class="cpp plain">newfunname[128];</code> 
           </div> 
           <div class="line number12 index11 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//mode = atoi(argv[2]);</code> 
           </div> 
           <div class="line number13 index12 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>
            <code class="cpp plain">(argc &lt; 5){</code> 
           </div> 
           <div class="line number14 index13 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">printf</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"usage : ./injso pid libpath oldfunname newfunname\n"</code>
            <code class="cpp plain">);</code> 
           </div> 
           <div class="line number15 index14 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">exit</code>
            <code class="cpp plain">(-1);</code> 
           </div> 
           <div class="line number16 index15 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number17 index16 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/* 从命令行取得目标进程PID*/</code> 
           </div> 
           <div class="line number18 index17 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">pid =&nbsp;</code>
            <code class="cpp functions bold">atoi</code>
            <code class="cpp plain">(argv[1]);</code> 
           </div> 
           <div class="line number19 index18 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number20 index19 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/* 从命令行取得新库名称*/</code> 
           </div> 
           <div class="line number21 index20 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">memset</code>
            <code class="cpp plain">(libpath,0,</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(libpath));</code> 
           </div> 
           <div class="line number22 index21 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">memcpy</code>
            <code class="cpp plain">(libpath,argv[2],</code>
            <code class="cpp functions bold">strlen</code>
            <code class="cpp plain">(argv[2]));</code> 
           </div> 
           <div class="line number23 index22 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number24 index23 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/* 从命令行取得旧函数的名称*/</code> 
           </div> 
           <div class="line number25 index24 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">memset</code>
            <code class="cpp plain">(oldfunname,0,</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(oldfunname));</code> 
           </div> 
           <div class="line number26 index25 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">memcpy</code>
            <code class="cpp plain">(oldfunname,argv[3],</code>
            <code class="cpp functions bold">strlen</code>
            <code class="cpp plain">(argv[3]));</code> 
           </div> 
           <div class="line number27 index26 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number28 index27 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/* 从命令行取得新函数的名称*/</code> 
           </div> 
           <div class="line number29 index28 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">memset</code>
            <code class="cpp plain">(newfunname,0,</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(newfunname));</code> 
           </div> 
           <div class="line number30 index29 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">memcpy</code>
            <code class="cpp plain">(newfunname,argv[4],</code>
            <code class="cpp functions bold">strlen</code>
            <code class="cpp plain">(argv[4]));</code> 
           </div> 
           <div class="line number31 index30 alt2">
            &nbsp;
           </div> 
           <div class="line number32 index31 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">printf</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"main pid = %d\n"</code>
            <code class="cpp plain">,pid);</code> 
           </div> 
           <div class="line number33 index32 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">printf</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"main libpath : %s\n"</code>
            <code class="cpp plain">,libpath);</code> 
           </div> 
           <div class="line number34 index33 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">printf</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"main oldfunname : %s\n"</code>
            <code class="cpp plain">,oldfunname);</code> 
           </div> 
           <div class="line number35 index34 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">printf</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"main newfunname : %s\n"</code>
            <code class="cpp plain">,newfunname);</code> 
           </div> 
           <div class="line number36 index35 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/* 关联到目标进程*/</code> 
           </div> 
           <div class="line number37 index36 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_attach(pid);</code> 
           </div> 
           <div class="line number38 index37 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number39 index38 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/* 得到指向link_map链表的指针 */</code> 
           </div> 
           <div class="line number40 index39 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">map = get_linkmap(pid);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/* get_linkmap */</code> 
           </div> 
           <div class="line number41 index40 alt2">
            &nbsp;
           </div> 
           <div class="line number42 index41 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number43 index42 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">sym_addr = find_symbol(pid, map,&nbsp;</code>
            <code class="cpp string">"printf"</code>
            <code class="cpp plain">);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code> 
           </div> 
           <div class="line number44 index43 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">printf</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"found printf at addr %p\n"</code>
            <code class="cpp plain">, sym_addr);&nbsp;</code> 
           </div> 
           <div class="line number45 index44 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>
            <code class="cpp plain">(sym_addr == 0)</code> 
           </div> 
           <div class="line number46 index45 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">goto</code>&nbsp;
            <code class="cpp plain">detach;</code> 
           </div> 
           <div class="line number47 index46 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">call_printf(pid,sym_addr,</code>
            <code class="cpp string">"injso successed\n"</code>
            <code class="cpp plain">);</code> 
           </div> 
           <div class="line number48 index47 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">waitpid(pid,&amp;status,0);</code> 
           </div> 
           <div class="line number49 index48 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">printf</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"status = %x\n"</code>
            <code class="cpp plain">,status);</code> 
           </div> 
           <div class="line number50 index49 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number51 index50 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/*ptrace_writereg(pid, &amp;oldregs);</code> 
           </div> 
           <div class="line number52 index51 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">ptrace_cont(pid);</code> 
           </div> 
           <div class="line number53 index52 alt2">
            &nbsp;
           </div> 
           <div class="line number54 index53 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number55 index54 alt2">
            &nbsp;
           </div> 
           <div class="line number56 index55 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">waitpid(pid,&amp;status,0);</code> 
           </div> 
           <div class="line number57 index56 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("status = %x\n",status);</code> 
           </div> 
           <div class="line number58 index57 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//ptrace_readreg(pid, &amp;oldregs);</code> 
           </div> 
           <div class="line number59 index58 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//oldregs.eip = 0x8048414;</code> 
           </div> 
           <div class="line number60 index59 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//ptrace_writereg(pid, &amp;oldregs);</code> 
           </div> 
           <div class="line number61 index60 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">ptrace_cont(int pid)(pid);</code> 
           </div> 
           <div class="line number62 index61 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number63 index62 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">ptrace_detach(pid);</code> 
           </div> 
           <div class="line number64 index63 alt1">
            &nbsp;
           </div> 
           <div class="line number65 index64 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">exit(0);*/</code> 
           </div> 
           <div class="line number66 index65 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number67 index66 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/* 发现__libc_dlopen_mode，并调用它 */</code> 
           </div> 
           <div class="line number68 index67 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">sym_addr = find_symbol(pid, map,&nbsp;</code>
            <code class="cpp string">"__libc_dlopen_mode"</code>
            <code class="cpp plain">);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/* call _dl_open */</code> 
           </div> 
           <div class="line number69 index68 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">printf</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"found __libc_dlopen_mode at addr %p\n"</code>
            <code class="cpp plain">, sym_addr);&nbsp;</code> 
           </div> 
           <div class="line number70 index69 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>
            <code class="cpp plain">(sym_addr == 0)</code> 
           </div> 
           <div class="line number71 index70 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">goto</code>&nbsp;
            <code class="cpp plain">detach;</code> 
           </div> 
           <div class="line number72 index71 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">call__libc_dlopen_mode(pid, sym_addr,libpath);&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/* 注意装载的库地址 */</code>&nbsp;&nbsp;
           </div> 
           <div class="line number73 index72 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//while(1);</code> 
           </div> 
           <div class="line number74 index73 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">waitpid(pid,&amp;status,0);</code> 
           </div> 
           <div class="line number75 index74 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/* 找到新函数的地址 */</code> 
           </div> 
           <div class="line number76 index75 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">strcpy</code>
            <code class="cpp plain">(sym_name, newfunname);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/* intercept */</code> 
           </div> 
           <div class="line number77 index76 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">sym_addr = find_symbol(pid, map, sym_name);</code> 
           </div> 
           <div class="line number78 index77 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">printf</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"%s addr\t %p\n"</code>
            <code class="cpp plain">, sym_name, sym_addr);</code> 
           </div> 
           <div class="line number79 index78 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>
            <code class="cpp plain">(sym_addr == 0)</code> 
           </div> 
           <div class="line number80 index79 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">goto</code>&nbsp;
            <code class="cpp plain">detach;</code> 
           </div> 
           <div class="line number81 index80 alt2">
            &nbsp;
           </div> 
           <div class="line number82 index81 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/* 找到旧函数在重定向表的地址 */</code> 
           </div> 
           <div class="line number83 index82 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">strcpy</code>
            <code class="cpp plain">(sym_name, oldfunname);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code> 
           </div> 
           <div class="line number84 index83 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">rel_addr = find_sym_in_rel(pid, sym_name);</code> 
           </div> 
           <div class="line number85 index84 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">printf</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"%s rel addr\t %p\n"</code>
            <code class="cpp plain">, sym_name, rel_addr);</code> 
           </div> 
           <div class="line number86 index85 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>
            <code class="cpp plain">(rel_addr == 0)</code> 
           </div> 
           <div class="line number87 index86 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">goto</code>&nbsp;
            <code class="cpp plain">detach;</code> 
           </div> 
           <div class="line number88 index87 alt1">
            &nbsp;
           </div> 
           <div class="line number89 index88 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/* 找到用于保存read地址的指针 */</code> 
           </div> 
           <div class="line number90 index89 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//strcpy(sym_name, "oldread");&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code> 
           </div> 
           <div class="line number91 index90 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//old_addr = find_symbol(pid, map, sym_name);</code> 
           </div> 
           <div class="line number92 index91 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//printf("%s addr\t %p\n", sym_name, old_addr);</code> 
           </div> 
           <div class="line number93 index92 alt2">
            &nbsp;
           </div> 
           <div class="line number94 index93 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/* 函数重定向 */</code> 
           </div> 
           <div class="line number95 index94 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">puts</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"intercept..."</code>
            <code class="cpp plain">);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">/* intercept */</code> 
           </div> 
           <div class="line number96 index95 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//ptrace_read(pid, rel_addr, &amp;new_addr, sizeof(new_addr));</code> 
           </div> 
           <div class="line number97 index96 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//ptrace_write(pid, old_addr, &amp;new_addr, sizeof(new_addr));</code> 
           </div> 
           <div class="line number98 index97 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp comments">//rel_addr = 0x8048497;如果是静态地址，也就是未导出该符号地址，那么只能通过反汇编先找到该函数被调用的地方，将这个地方的跳转地址修改</code> 
           </div> 
           <div class="line number99 index98 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number100 index99 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>
            <code class="cpp plain">(modifyflag == 2)</code> 
           </div> 
           <div class="line number101 index100 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">sym_addr = sym_addr - rel_addr - 4;</code> 
           </div> 
           <div class="line number102 index101 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">printf</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"main modify sym_addr = %x\n"</code>
            <code class="cpp plain">,sym_addr);</code> 
           </div> 
           <div class="line number103 index102 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_write(pid, rel_addr, &amp;sym_addr,&nbsp;</code>
            <code class="cpp keyword bold">sizeof</code>
            <code class="cpp plain">(sym_addr));</code> 
           </div> 
           <div class="line number104 index103 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number105 index104 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">puts</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"injectso ok"</code>
            <code class="cpp plain">);</code> 
           </div> 
           <div class="line number106 index105 alt1">
            <code class="cpp plain">detach:</code>
           </div> 
           <div class="line number107 index106 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">printf</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"prepare to detach\n"</code>
            <code class="cpp plain">);</code> 
           </div> 
           <div class="line number108 index107 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">ptrace_detach(pid);</code> 
           </div> 
           <div class="line number109 index108 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number110 index109 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">return</code>&nbsp;
            <code class="cpp plain">0;</code> 
           </div> 
           <div class="line number111 index110 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;</code>&nbsp;
           </div> 
           <div class="line number112 index111 alt1">
            <code class="cpp plain">}</code>
           </div> 
          </div> </td> 
        </tr>
       </tbody>
      </table>
     </div> 
    </div> 
   </div> 
   <p>　　这里面有一个很重要的地方，如果不先在目标进程中调用printf就不能够调用__lib_dlopen_mode成功，这个原因很奇怪，根据当时的core文件来看崩溃在了下面的这个函数，原因是_dl_open_hook这个全局变量为0，但实际上运行过printf之后，这个_dl_open_hook还是0。这个有待后续检验。</p> 
   <div class="cnblogs_Highlighter sh-gutter"> 
    <div> 
     <div class="syntaxhighlighter cpp"> 
      <table border="0">
       <tbody>
        <tr>
         <td class="gutter"> 
          <div class="line number1 index0 alt2">
           1
          </div> 
          <div class="line number2 index1 alt1">
           2
          </div> 
          <div class="line number3 index2 alt2">
           3
          </div> 
          <div class="line number4 index3 alt1">
           4
          </div> 
          <div class="line number5 index4 alt2">
           5
          </div> 
          <div class="line number6 index5 alt1">
           6
          </div> 
          <div class="line number7 index6 alt2">
           7
          </div> 
          <div class="line number8 index7 alt1">
           8
          </div> 
          <div class="line number9 index8 alt2">
           9
          </div> 
          <div class="line number10 index9 alt1">
           10
          </div> 
          <div class="line number11 index10 alt2">
           11
          </div> 
          <div class="line number12 index11 alt1">
           12
          </div> 
          <div class="line number13 index12 alt2">
           13
          </div> 
          <div class="line number14 index13 alt1">
           14
          </div> </td> 
         <td class="code"> 
          <div> 
           <div class="line number1 index0 alt2"> 
            <code class="cpp keyword bold">void</code>&nbsp;
            <code class="cpp plain">*</code> 
           </div> 
           <div class="line number2 index1 alt1"> 
            <code class="cpp plain">__libc_dlsym (</code>
            <code class="cpp keyword bold">void</code>&nbsp;
            <code class="cpp plain">*map,&nbsp;</code>
            <code class="cpp keyword bold">const</code>&nbsp;
            <code class="cpp color1 bold">char</code>&nbsp;
            <code class="cpp plain">*name)</code> 
           </div> 
           <div class="line number3 index2 alt2">
            <code class="cpp plain">{</code>
           </div> 
           <div class="line number4 index3 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">struct</code>&nbsp;
            <code class="cpp plain">do_dlsym_args args;</code> 
           </div> 
           <div class="line number5 index4 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;</code>
            <code class="cpp plain">args.map = map;</code> 
           </div> 
           <div class="line number6 index5 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;</code>
            <code class="cpp plain">args.name = name;</code> 
           </div> 
           <div class="line number7 index6 alt2">
            &nbsp;
           </div> 
           <div class="line number8 index7 alt1">
            <code class="cpp preprocessor">#ifdef SHARED</code>
           </div> 
           <div class="line number9 index8 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">if</code>&nbsp;
            <code class="cpp plain">(__builtin_expect (_dl_open_hook != NULL, 0))</code> 
           </div> 
           <div class="line number10 index9 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">return</code>&nbsp;
            <code class="cpp plain">_dl_open_hook-&gt;dlsym (map, name);</code> 
           </div> 
           <div class="line number11 index10 alt2">
            <code class="cpp preprocessor">#endif</code>
           </div> 
           <div class="line number12 index11 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">return</code>&nbsp;
            <code class="cpp plain">(dlerror_run (do_dlsym, &amp;args) ? NULL</code> 
           </div> 
           <div class="line number13 index12 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">: (</code>
            <code class="cpp keyword bold">void</code>&nbsp;
            <code class="cpp plain">*) (DL_SYMBOL_ADDRESS (args.loadbase, args.ref)));</code> 
           </div> 
           <div class="line number14 index13 alt1">
            <code class="cpp plain">}</code>
           </div> 
          </div> </td> 
        </tr>
       </tbody>
      </table>
     </div> 
    </div> 
   </div> 
   <p>　　运行结果：</p> 
   <p>root@leo-desktop:injso# ./test<br>1467364356 : original<br>injso successed<br>hahahahahahahahahahahahahaha</p> 
   <ul>
    <li>6.如何替换未导出符号的地址</li> 
   </ul>
   <p>　　被替换函数源码：</p> 
   <div class="cnblogs_Highlighter sh-gutter"> 
    <div> 
     <div class="syntaxhighlighter cpp"> 
      <table border="0">
       <tbody>
        <tr>
         <td class="gutter"> 
          <div class="line number1 index0 alt2">
           1
          </div> 
          <div class="line number2 index1 alt1">
           2
          </div> 
          <div class="line number3 index2 alt2">
           3
          </div> 
          <div class="line number4 index3 alt1">
           4
          </div> 
          <div class="line number5 index4 alt2">
           5
          </div> 
          <div class="line number6 index5 alt1">
           6
          </div> 
          <div class="line number7 index6 alt2">
           7
          </div> 
          <div class="line number8 index7 alt1">
           8
          </div> 
          <div class="line number9 index8 alt2">
           9
          </div> 
          <div class="line number10 index9 alt1">
           10
          </div> 
          <div class="line number11 index10 alt2">
           11
          </div> 
          <div class="line number12 index11 alt1">
           12
          </div> 
          <div class="line number13 index12 alt2">
           13
          </div> 
          <div class="line number14 index13 alt1">
           14
          </div> 
          <div class="line number15 index14 alt2">
           15
          </div> 
          <div class="line number16 index15 alt1">
           16
          </div> 
          <div class="line number17 index16 alt2">
           17
          </div> 
          <div class="line number18 index17 alt1">
           18
          </div> 
          <div class="line number19 index18 alt2">
           19
          </div> 
          <div class="line number20 index19 alt1">
           20
          </div> 
          <div class="line number21 index20 alt2">
           21
          </div> 
          <div class="line number22 index21 alt1">
           22
          </div> </td> 
         <td class="code"> 
          <div> 
           <div class="line number1 index0 alt2">
            <code class="cpp preprocessor">#include &lt;stdio.h&gt;</code>
           </div> 
           <div class="line number2 index1 alt1">
            &nbsp;
           </div> 
           <div class="line number3 index2 alt2">
            &nbsp;
           </div> 
           <div class="line number4 index3 alt1">
            <code class="cpp comments">//int fun2();</code>
           </div> 
           <div class="line number5 index4 alt2">
            &nbsp;
           </div> 
           <div class="line number6 index5 alt1"> 
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">fun1()</code> 
           </div> 
           <div class="line number7 index6 alt2">
            <code class="cpp plain">{</code>
           </div> 
           <div class="line number8 index7 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">printf</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"fun1\n"</code>
            <code class="cpp plain">);</code> 
           </div> 
           <div class="line number9 index8 alt2">
            <code class="cpp comments">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fun2();</code>
           </div> 
           <div class="line number10 index9 alt1">
            <code class="cpp plain">}</code>
           </div> 
           <div class="line number11 index10 alt2">
            &nbsp;
           </div> 
           <div class="line number12 index11 alt1"> 
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">main()</code> 
           </div> 
           <div class="line number13 index12 alt2">
            <code class="cpp plain">{</code>
           </div> 
           <div class="line number14 index13 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp color1 bold">signed</code>&nbsp;
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">i&nbsp; = 0x40011673 ;</code> 
           </div> 
           <div class="line number15 index14 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">i = i - 0x4001172d ;</code> 
           </div> 
           <div class="line number16 index15 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp functions bold">printf</code>
            <code class="cpp plain">(</code>
            <code class="cpp string">"i = %x\n"</code>
            <code class="cpp plain">,i);</code> 
           </div> 
           <div class="line number17 index16 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">while</code>
            <code class="cpp plain">(1){</code> 
           </div> 
           <div class="line number18 index17 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">i = fun1();</code> 
           </div> 
           <div class="line number19 index18 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">sleep(10);</code> 
           </div> 
           <div class="line number20 index19 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">}</code> 
           </div> 
           <div class="line number21 index20 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp keyword bold">return</code>&nbsp;
            <code class="cpp plain">1;</code> 
           </div> 
           <div class="line number22 index21 alt1">
            <code class="cpp plain">}</code>
           </div> 
          </div> </td> 
        </tr>
       </tbody>
      </table>
     </div> 
    </div> 
   </div> 
   <p>　　这个怎么来替换fun1函数的地址呢？</p> 
   <p>　　首先反汇编得到main的机器码，如下，</p> 
   <div class="cnblogs_Highlighter sh-gutter"> 
    <div> 
     <div class="syntaxhighlighter cpp"> 
      <table border="0">
       <tbody>
        <tr>
         <td class="gutter"> 
          <div class="line number1 index0 alt2">
           1
          </div> 
          <div class="line number2 index1 alt1">
           2
          </div> 
          <div class="line number3 index2 alt2">
           3
          </div> 
          <div class="line number4 index3 alt1">
           4
          </div> 
          <div class="line number5 index4 alt2">
           5
          </div> 
          <div class="line number6 index5 alt1">
           6
          </div> 
          <div class="line number7 index6 alt2">
           7
          </div> 
          <div class="line number8 index7 alt1">
           8
          </div> 
          <div class="line number9 index8 alt2">
           9
          </div> 
          <div class="line number10 index9 alt1">
           10
          </div> 
          <div class="line number11 index10 alt2">
           11
          </div> 
          <div class="line number12 index11 alt1">
           12
          </div> 
          <div class="line number13 index12 alt2">
           13
          </div> 
          <div class="line number14 index13 alt1">
           14
          </div> 
          <div class="line number15 index14 alt2">
           15
          </div> 
          <div class="line number16 index15 alt1">
           16
          </div> 
          <div class="line number17 index16 alt2">
           17
          </div> 
          <div class="line number18 index17 alt1">
           18
          </div> 
          <div class="line number19 index18 alt2">
           19
          </div> 
          <div class="line number20 index19 alt1">
           20
          </div> 
          <div class="line number21 index20 alt2">
           21
          </div> 
          <div class="line number22 index21 alt1">
           22
          </div> </td> 
         <td class="code"> 
          <div> 
           <div class="line number1 index0 alt2">
            <code class="cpp plain">08048468 &lt;main&gt;:</code>
           </div> 
           <div class="line number2 index1 alt1"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp plain">8048468:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; push&nbsp;&nbsp; %ebp</code> 
           </div> 
           <div class="line number3 index2 alt2"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp plain">8048469:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 89 e5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp; %esp,%ebp</code> 
           </div> 
           <div class="line number4 index3 alt1"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp plain">804846b:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 83 e4 f0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and&nbsp;&nbsp;&nbsp; $0xfffffff0,%esp</code> 
           </div> 
           <div class="line number5 index4 alt2"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp plain">804846e:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 83 ec 20&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sub&nbsp;&nbsp;&nbsp; $0x20,%esp</code> 
           </div> 
           <div class="line number6 index5 alt1"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp plain">8048471:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c7 44 24 1c 73 16 01&nbsp;&nbsp;&nbsp; movl&nbsp;&nbsp; $0x40011673,0x1c(%esp)</code> 
           </div> 
           <div class="line number7 index6 alt2"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp plain">8048478:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 40</code> 
           </div> 
           <div class="line number8 index7 alt1"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp plain">8048479:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 81 6c 24 1c 2d 17 01&nbsp;&nbsp;&nbsp; subl&nbsp;&nbsp; $0x4001172d,0x1c(%esp)</code> 
           </div> 
           <div class="line number9 index8 alt2"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp plain">8048480:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 40</code> 
           </div> 
           <div class="line number10 index9 alt1"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp plain">8048481:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; b8 75 85 04 08&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp; $0x8048575,%eax</code> 
           </div> 
           <div class="line number11 index10 alt2"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp plain">8048486:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 8b 54 24 1c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp; 0x1c(%esp),%edx</code> 
           </div> 
           <div class="line number12 index11 alt1"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp plain">804848a:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 89 54 24 04&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp; %edx,0x4(%esp)</code> 
           </div> 
           <div class="line number13 index12 alt2"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp plain">804848e:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 89 04 24&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp; %eax,(%esp)</code> 
           </div> 
           <div class="line number14 index13 alt1"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp plain">8048491:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e8 ce fe ff ff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; call&nbsp;&nbsp; 8048364 &lt;</code>
            <code class="cpp functions bold">printf</code>
            <code class="cpp plain">@plt&gt;</code> 
           </div> 
           <div class="line number15 index14 alt2"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp plain">8048496:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e8 b9 ff ff ff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; call&nbsp;&nbsp; 8048454 &lt;fun1&gt;</code> 
           </div> 
           <div class="line number16 index15 alt1"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp plain">804849b:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 89 44 24 1c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp; %eax,0x1c(%esp)</code> 
           </div> 
           <div class="line number17 index16 alt2"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp plain">804849f:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c7 04 24 0a 00 00 00&nbsp;&nbsp;&nbsp; movl&nbsp;&nbsp; $0xa,(%esp)</code> 
           </div> 
           <div class="line number18 index17 alt1"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp plain">80484a6:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e8 c9 fe ff ff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; call&nbsp;&nbsp; 8048374 &lt;sleep@plt&gt;</code> 
           </div> 
           <div class="line number19 index18 alt2"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp plain">80484ab:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; eb e9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; jmp&nbsp;&nbsp;&nbsp; 8048496 &lt;main+0x2e&gt;</code> 
           </div> 
           <div class="line number20 index19 alt1"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp plain">80484ad:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 90&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nop</code> 
           </div> 
           <div class="line number21 index20 alt2"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp plain">80484ae:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 90&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nop</code> 
           </div> 
           <div class="line number22 index21 alt1"> 
            <code class="cpp spaces">&nbsp;</code>
            <code class="cpp plain">80484af:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 90&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nop</code> 
           </div> 
          </div> </td> 
        </tr>
       </tbody>
      </table>
     </div> 
    </div> 
   </div> 
   <p>　　可以看到在地址0x8048496处的机器码是跳转到fun1函数的，那么这个ffffffb9就是call的操作数，操作数地址0x8048497，也就是说把这个地址中的数值改掉就可以了，有关这个call或者jmp的地址计算可以查看我的另外一篇博文。</p> 
   <p>　　有关这个如何跳转的方法，已经在主函数的代码中给出了，但是被我注释掉了，大家感兴趣的话，可以自己试试。</p> 
   <p>　　效果：</p> 
   <p>root@leo-desktop:lib2lib# ./a.out&nbsp;<br>i = ffffff46<br>fun1<br>injso successed<br>hahahahahahaha^C</p> 
   <p>　　这里面的无关代码，大家仔细看，是为了证明call的函数地址计算方式的。</p> 
   <ul>
    <li>7.总结</li> 
   </ul>
   <p>　　那么讲到现在的话，已经实现了不管函数符号是否导出都可以实现运行时替换的代码。</p> 
   <p>　　这里面主要的技术是，elf文件格式，运行时加载的过程，跳转地址的计算，运行时链接的过程，也就是plt表(当然这个也可以从我的另一篇博文中看到)。</p> 
   <p>　　比较遗憾的是有关那个奔溃，有网友如果找到了原因，请回复下，3q。当然我也会自己再研究下。</p> 
   <p>&nbsp;</p> 
   <p>&nbsp;　　最后补上全局变量和头文件：</p> 
   <div class="cnblogs_Highlighter sh-gutter"> 
    <div> 
     <div class="syntaxhighlighter cpp"> 
      <table border="0">
       <tbody>
        <tr>
         <td class="gutter"> 
          <div class="line number1 index0 alt2">
           1
          </div> 
          <div class="line number2 index1 alt1">
           2
          </div> 
          <div class="line number3 index2 alt2">
           3
          </div> 
          <div class="line number4 index3 alt1">
           4
          </div> 
          <div class="line number5 index4 alt2">
           5
          </div> 
          <div class="line number6 index5 alt1">
           6
          </div> 
          <div class="line number7 index6 alt2">
           7
          </div> 
          <div class="line number8 index7 alt1">
           8
          </div> 
          <div class="line number9 index8 alt2">
           9
          </div> 
          <div class="line number10 index9 alt1">
           10
          </div> 
          <div class="line number11 index10 alt2">
           11
          </div> 
          <div class="line number12 index11 alt1">
           12
          </div> 
          <div class="line number13 index12 alt2">
           13
          </div> 
          <div class="line number14 index13 alt1">
           14
          </div> 
          <div class="line number15 index14 alt2">
           15
          </div> 
          <div class="line number16 index15 alt1">
           16
          </div> 
          <div class="line number17 index16 alt2">
           17
          </div> 
          <div class="line number18 index17 alt1">
           18
          </div> 
          <div class="line number19 index18 alt2">
           19
          </div> 
          <div class="line number20 index19 alt1">
           20
          </div> 
          <div class="line number21 index20 alt2">
           21
          </div> 
          <div class="line number22 index21 alt1">
           22
          </div> 
          <div class="line number23 index22 alt2">
           23
          </div> 
          <div class="line number24 index23 alt1">
           24
          </div> 
          <div class="line number25 index24 alt2">
           25
          </div> 
          <div class="line number26 index25 alt1">
           26
          </div> 
          <div class="line number27 index26 alt2">
           27
          </div> 
          <div class="line number28 index27 alt1">
           28
          </div> 
          <div class="line number29 index28 alt2">
           29
          </div> 
          <div class="line number30 index29 alt1">
           30
          </div> 
          <div class="line number31 index30 alt2">
           31
          </div> 
          <div class="line number32 index31 alt1">
           32
          </div> 
          <div class="line number33 index32 alt2">
           33
          </div> 
          <div class="line number34 index33 alt1">
           34
          </div> 
          <div class="line number35 index34 alt2">
           35
          </div> </td> 
         <td class="code"> 
          <div> 
           <div class="line number1 index0 alt2">
            <code class="cpp preprocessor">#include &lt;stdio.h&gt;</code>
           </div> 
           <div class="line number2 index1 alt1">
            <code class="cpp preprocessor">#include &lt;string.h&gt;</code>
           </div> 
           <div class="line number3 index2 alt2">
            <code class="cpp preprocessor">#include &lt;elf.h&gt;</code>
           </div> 
           <div class="line number4 index3 alt1">
            <code class="cpp preprocessor">#include &lt;sys/types.h&gt;</code>
           </div> 
           <div class="line number5 index4 alt2">
            <code class="cpp preprocessor">#include &lt;stdio.h&gt;</code>
           </div> 
           <div class="line number6 index5 alt1">
            <code class="cpp preprocessor">#include &lt;sys/ptrace.h&gt;</code>
           </div> 
           <div class="line number7 index6 alt2">
            <code class="cpp preprocessor">#include &lt;sys/wait.h&gt;</code>
           </div> 
           <div class="line number8 index7 alt1">
            <code class="cpp preprocessor">#include &lt;sys/errno.h&gt;</code>
           </div> 
           <div class="line number9 index8 alt2">
            <code class="cpp preprocessor">#include &lt;sys/user.h&gt;</code>
           </div> 
           <div class="line number10 index9 alt1">
            <code class="cpp preprocessor">#include &lt;link.h&gt;</code>
           </div> 
           <div class="line number11 index10 alt2">
            <code class="cpp preprocessor">#include &lt;sys/stat.h&gt;</code>
           </div> 
           <div class="line number12 index11 alt1">
            <code class="cpp preprocessor">#include &lt;fcntl.h&gt;</code>
           </div> 
           <div class="line number13 index12 alt2">
            <code class="cpp preprocessor">#include &lt;bits/dlfcn.h&gt;</code>
           </div> 
           <div class="line number14 index13 alt1">
            &nbsp;
           </div> 
           <div class="line number15 index14 alt2">
            <code class="cpp preprocessor">#define IMAGE_ADDR 0x08048000</code>
           </div> 
           <div class="line number16 index15 alt1">
            &nbsp;
           </div> 
           <div class="line number17 index16 alt2"> 
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">mode = 2;</code> 
           </div> 
           <div class="line number18 index17 alt1">
            &nbsp;
           </div> 
           <div class="line number19 index18 alt2"> 
            <code class="cpp keyword bold">struct</code>&nbsp;
            <code class="cpp plain">user_regs_struct oldregs;</code> 
           </div> 
           <div class="line number20 index19 alt1">
            <code class="cpp plain">Elf32_Addr phdr_addr;</code>
           </div> 
           <div class="line number21 index20 alt2">
            <code class="cpp plain">Elf32_Addr dyn_addr;</code>
           </div> 
           <div class="line number22 index21 alt1">
            <code class="cpp plain">Elf32_Addr map_addr;</code>
           </div> 
           <div class="line number23 index22 alt2">
            <code class="cpp plain">Elf32_Addr symtab;</code>
           </div> 
           <div class="line number24 index23 alt1">
            <code class="cpp plain">Elf32_Addr strtab;</code>
           </div> 
           <div class="line number25 index24 alt2">
            <code class="cpp plain">Elf32_Addr jmprel;</code>
           </div> 
           <div class="line number26 index25 alt1">
            <code class="cpp plain">Elf32_Addr reldyn;</code>
           </div> 
           <div class="line number27 index26 alt2">
            <code class="cpp plain">Elf32_Word reldynsz;</code>
           </div> 
           <div class="line number28 index27 alt1">
            <code class="cpp plain">Elf32_Word totalrelsize;</code>
           </div> 
           <div class="line number29 index28 alt2">
            <code class="cpp plain">Elf32_Word relsize;</code>
           </div> 
           <div class="line number30 index29 alt1"> 
            <code class="cpp plain">unsigned&nbsp;</code>
            <code class="cpp color1 bold">long</code>&nbsp;
            <code class="cpp plain">link_addr;</code> 
           </div> 
           <div class="line number31 index30 alt2"> 
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">nrels;</code> 
           </div> 
           <div class="line number32 index31 alt1"> 
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">nreldyns;</code> 
           </div> 
           <div class="line number33 index32 alt2">
            <code class="cpp comments">//int nchains;</code>
           </div> 
           <div class="line number34 index33 alt1"> 
            <code class="cpp color1 bold">int</code>&nbsp;
            <code class="cpp plain">modifyflag = 0;</code> 
           </div> 
           <div class="line number35 index34 alt2">
            <code class="cpp comments">/*char libpath[128] = "/mnt/hgfs/svnroot/test/injectsov2/prj_linux/so.so";*/</code>
           </div> 
          </div> </td> 
        </tr>
       </tbody>
      </table>
     </div> 
    </div> 
   </div> 
   <p>　　</p> 
   <p>&nbsp;</p> 
   <ul>
    <li>8.修正</li> 
   </ul>
   <p>　　针对在调用__libc_dlopen_mode函数之前需要调用printf的问题，终于让我在晚上解决了。<br>　　首先，我尝试了调用其他函数而不是printf函数，发现效果一样，包括第一次是调用__libc_dlopen_mode，第二次对该函数的调用都可以成功。<br>　　其次，那么现在问题就集中在了这两个__libc_dlopen_mode调用之间的差别在哪里，程序段肯定是一致的，栈也是一致的，而堆空间未使用，还有一个重要的因素，那就是寄存器。<br>　　最后，发现在调用__libc_dlopen_mode前，有四个寄存器不同，分别是eax，orig_eax,eflags和esp。我一开始认为，通用寄存器eax和orig_eax不会对程序的执行造成影响。但是通过实验，仅调一次__libc_dlopen_mode，部分寄存器赋正确执行时的值，发现对eax和orig_eax被赋于正确执行时的值时，程序可以正常运行，而且不仅仅必须是一种值，比如eax可以是0,1,0xffffffff，很多值都可以，但是被赋予0xfffffdfc和0xfffffdff等值时会失败，试验过并不是因为d这一位决定的，0xfffffdf0或者d00是可以运行成功的。</p> 
   <div class="cnblogs_Highlighter sh-gutter"> 
    <div> 
     <div class="syntaxhighlighter cpp"> 
      <table border="0">
       <tbody>
        <tr>
         <td class="gutter"> 
          <div class="line number1 index0 alt2">
           1
          </div> 
          <div class="line number2 index1 alt1">
           2
          </div> 
          <div class="line number3 index2 alt2">
           3
          </div> 
          <div class="line number4 index3 alt1">
           4
          </div> 
          <div class="line number5 index4 alt2">
           5
          </div> 
          <div class="line number6 index5 alt1">
           6
          </div> 
          <div class="line number7 index6 alt2">
           7
          </div> 
          <div class="line number8 index7 alt1">
           8
          </div> 
          <div class="line number9 index8 alt2">
           9
          </div> 
          <div class="line number10 index9 alt1">
           10
          </div> 
          <div class="line number11 index10 alt2">
           11
          </div> 
          <div class="line number12 index11 alt1">
           12
          </div> 
          <div class="line number13 index12 alt2">
           13
          </div> 
          <div class="line number14 index13 alt1">
           14
          </div> 
          <div class="line number15 index14 alt2">
           15
          </div> </td> 
         <td class="code"> 
          <div> 
           <div class="line number1 index0 alt2">
            <code class="cpp plain">(gdb) disassemble __libc_dlopen_mode</code>
           </div> 
           <div class="line number2 index1 alt1"> 
            <code class="cpp plain">Dump of assembler code&nbsp;</code>
            <code class="cpp keyword bold">for</code>&nbsp;
            <code class="cpp plain">function __libc_dlopen_mode:</code> 
           </div> 
           <div class="line number3 index2 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">0x00232640 &lt;+0&gt;:&nbsp;&nbsp; push&nbsp;&nbsp; %ebp</code> 
           </div> 
           <div class="line number4 index3 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">0x00232641 &lt;+1&gt;:&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp; %esp,%ebp</code> 
           </div> 
           <div class="line number5 index4 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">0x00232643 &lt;+3&gt;:&nbsp;&nbsp; sub&nbsp;&nbsp;&nbsp; $0x1c,%esp</code> 
           </div> 
           <div class="line number6 index5 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">0x00232646 &lt;+6&gt;:&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp; %ebx,-0x8(%ebp)</code> 
           </div> 
           <div class="line number7 index6 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">0x00232649 &lt;+9&gt;:&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp; 0x8(%ebp),%eax</code> 
           </div> 
           <div class="line number8 index7 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">0x0023264c &lt;+12&gt;:&nbsp; call&nbsp;&nbsp; 0x144a0f</code> 
           </div> 
           <div class="line number9 index8 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">0x00232651 &lt;+17&gt;:&nbsp; add&nbsp;&nbsp;&nbsp; $0x519a3,%ebx</code> 
           </div> 
           <div class="line number10 index9 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">0x00232657 &lt;+23&gt;:&nbsp; mov&nbsp;&nbsp;&nbsp; 0xc(%ebp),%edx</code> 
           </div> 
           <div class="line number11 index10 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">0x0023265a &lt;+26&gt;:&nbsp; mov&nbsp;&nbsp;&nbsp; %esi,-0x4(%ebp)</code> 
           </div> 
           <div class="line number12 index11 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">0x0023265d &lt;+29&gt;:&nbsp; mov&nbsp;&nbsp;&nbsp; %eax,-0x14(%ebp)</code> 
           </div> 
           <div class="line number13 index12 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">0x00232660 &lt;+32&gt;:&nbsp; mov&nbsp;&nbsp;&nbsp; %edx,-0x10(%ebp)</code> 
           </div> 
           <div class="line number14 index13 alt1"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">0x00232663 &lt;+35&gt;:&nbsp; mov&nbsp;&nbsp;&nbsp; 0x354c(%ebx),%esi</code> 
           </div> 
           <div class="line number15 index14 alt2"> 
            <code class="cpp spaces">&nbsp;&nbsp;&nbsp;</code>
            <code class="cpp plain">0x00232669 &lt;+41&gt;:&nbsp; test&nbsp;&nbsp; %esi,%esi</code> 
           </div> 
          </div> </td> 
        </tr>
       </tbody>
      </table>
     </div> 
    </div> 
   </div> 
   <p>　　在实验中，还发现对eax赋于不正确的值时，当时忘了记了，还让程序跑飞了。崩了，但是新库已经加载上了。所以这个函数替换还是有一定的风险，或者说libc库本身存在一定的bug。<br>　　所以现在问题找到了，在于eax和orig_eax上，但是对__libc_dlopen_mode反汇编发现，eax在函数开头就被赋予了通过栈传递的参数2的值，所以eax不应该影响程序的运行，但实际上影响了，这一点让我觉得很奇怪，如果有任何网友对这个原因知晓的话，麻烦回复，万分感谢。</p> 
   <p>&nbsp;</p> 
   <p>　　<em>linux共享库注射地址：http://www.docin.com/p-634172083.html</em></p> 
   <p>&nbsp;</p> 
   <p>　　__simple原创</p> 
   <p>　　转载请注明出处</p> 
   <div> 
    <div>
     【作者】
     <a href="http://www.cnblogs.com/sky-heaven/" rel="nofollow">张昺华</a> 
    </div> 
    <div>
     【出处】
     <a href="http://www.cnblogs.com/sky-heaven/" rel="nofollow">http://www.cnblogs.com/sky-heaven/</a> 
    </div> 
    <div>
     【博客园】 
     <a href="http://www.cnblogs.com/sky-heaven/" rel="nofollow">http://www.cnblogs.com/sky-heaven/</a> 
    </div> 
    <div>
     【新浪博客】 
     <a href="http://blog.sina.com.cn/u/2049150530" rel="nofollow">http://blog.sina.com.cn/u/2049150530</a> 
    </div> 
    <div>
     【知乎】 
     <a href="http://www.zhihu.com/people/zhang-bing-hua" rel="nofollow">http://www.zhihu.com/people/zhang-bing-hua</a> 
    </div> 
    <div>
     【我的作品---旋转倒立摆】 
     <a href="http://v.youku.com/v_show/id_XODM5NDAzNjQw.html?spm=a2hzp.8253869.0.0&amp;from=y1.7-2" rel="nofollow">http://v.youku.com/v_show/id_XODM5NDAzNjQw.html?spm=a2hzp.8253869.0.0&amp;from=y1.7-2</a> 
    </div> 
    <div>
     【我的作品---自平衡自动循迹车】 
     <a href="http://v.youku.com/v_show/id_XODM5MzYyNTIw.html?spm=a2hzp.8253869.0.0&amp;from=y1.7-2" rel="nofollow">http://v.youku.com/v_show/id_XODM5MzYyNTIw.html?spm=a2hzp.8253869.0.0&amp;from=y1.7-2</a> 
    </div> 
    <div>
     【新浪微博】 张昺华--sky
    </div> 
    <div>
     【twitter】 @sky2030_
    </div> 
    <div>
     【facebook】 张昺华 zhangbinghua
    </div> 
    <div>
     本文版权归作者和博客园共有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利.
    </div> 
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
