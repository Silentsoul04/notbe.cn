<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Net中的AOP系列之构建一个汽车租赁应用 « NotBeCN</title>
  <meta name="description" content="             本篇目录              开始一个新项目     没有AOP的生活     变更的代价     使用AOP重构          本系列的源码本人已托管于Coding上：点击查看。    本系列的实验环境：VS 2013 Update 5（建议最好使用集成了Nuget的VS版本...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/12/18/weixin_34195364_90130480.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">Net中的AOP系列之构建一个汽车租赁应用</h1>
    <p class="post-meta">Dec 18, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">本篇目录</h2> 
   <ul>
    <li style="list-style:disc;"> </li> 
    <li style="list-style:disc;"><font color="#4183c4"><span style="font-size:15px;line-height:25px;"><b>开始一个新项目</b></span></font></li> 
    <li style="list-style:disc;"><font color="#4183c4"><span style="font-size:15px;line-height:25px;"><b>没有AOP的生活</b></span></font></li> 
    <li style="list-style:disc;"><font color="#4183c4"><span style="font-size:15px;line-height:25px;"><b>变更的代价</b></span></font></li> 
    <li style="list-style:disc;"><font color="#4183c4"><span style="font-size:15px;line-height:25px;"><b>使用AOP重构</b></span></font></li> 
   </ul>
   <hr style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">本系列的源码本人已托管于Coding上：<strong><a href="https://coding.net/u/farb/p/AbpPractice/git/tree/master/AOPPractice/CarRental" rel="nofollow" style="color:rgb(65,131,196);text-decoration:none;">点击查看</a></strong>。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">本系列的实验环境：VS 2013 Update 5（建议最好使用集成了Nuget的VS版本，VS Express版也够用），安装了PostSharp。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">这篇博客覆盖的内容包括：</p> 
   <ul style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">
    <li style="list-style:disc;">为项目创建需求</li> 
    <li style="list-style:disc;">从零编写代码来满足需求</li> 
    <li style="list-style:disc;">不使用AOP重构凌乱的代码</li> 
    <li style="list-style:disc;">使用AOP来重构代码</li> 
   </ul>
   <hr style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">这一节会构建一个汽车租赁系统，先是给定业务需求，然后逐渐地添加代码来满足那些需求。<br> 一开始不使用任何AOP，从零开始敲代码。业务需求是最重要的，因此我们先做需求，一旦满足了业务逻辑，然后再覆盖非功能需求。最后，尽可能地简化并重构代码，不使用AOP来重构横切关注点。<br> 这些都完成之后，就会转向一个应用生命周期的长尾阶段。软件很少是长期不变的：新的功能需求和新发现的bugs。很少有软件的开发阶段会比生产阶段长，这就意味着大多数软件的生命周期是维护阶段。一个维护困难或昂贵的应用会导致高代价或者低品质（或两者都有），最终形成一个大泥球。<br> 然后，会使用PostSharp重构代码，将各自的横切关注点分离到它们自己的类中。一旦重构完成，你就会看到使用AOP的好处，特别是添加更多功能时。</p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);"> <a name="new"></a>开始一个新项目</h2> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">时间：现在<br> 地点：你公司（汽车租赁服务相关）的研发部的办公室<br> 人物：你的技术团队或者只有你自己<br> 背景：启动一个新的项目，高大上一点，叫做客户忠诚度系统，low一点，叫做客户积分程序。目的是为了增加销售，奖励那些经常购买服务的客户。比如，客户今天租赁了一辆车，那么他就会获得积分，积分累积多了之后，以后可以用于抵消一部分租赁费用或其他费用。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">假设有一个基本的三层架构，如下图。我们会从应用到这个积分系统的核心业务逻辑层着手编写代码，持久化层会跟踪客户的忠诚度积分，业务逻辑层供所有的UI层使用：网站，APP和店员使用的桌面端。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/a9e8f5b8-1115-45a9-8341-36c1f8fbd913.png" alt="图片" style="border:0px;"></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">这一篇，我们主要看一下中间一层的业务逻辑层。我们可以假设持久化层已经实现了，还要假设一旦业务逻辑实现了，UI也就实现了。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">业务需求</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">项目经理和利益相关人（比如销售和市场）确定了下图的业务需求，你已经确定了两个主要的需求集：<strong>累积积分</strong>和使用累积的积分<strong>兑换奖励</strong>。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/67ba006a-3904-457e-9252-b660608ade6c.png" alt="图片" style="border:0px;"></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">现在的业务需求就是：客户每租一天普通型车辆，累积一积分，豪华型或者大型车辆，每天两积分。这些积分会在他们支付之后并返还了车以后会增加到他们的账户中。一旦客户累积了10积分，那么就可以使用这些积分兑换奖励了，具体兑换规则见上图。<br> 这就是所有业务规则，但是在实现之前还是得和销售和市场确定好：因为他们将来肯定还会更改或者添加一些东西。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">必要的非功能需求</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">在给项目经理估算时间和花销之前，你有自己必须要解决的技术关注点。<br> 第一，需要记录日志。如果客户的积分累积得不对（累积少了），那么他们会生气的，因此必须确保记录了业务逻辑处理的一切（尤其是起初阶段）。<br> 第二，因为业务逻辑代码会被多个UI应用使用，要确保传入业务层的数据是合法的，你的队友可能会在UI里写入一些集成代码，因此，必须编写防御性代码来检查无意义的边缘情况和参数。<br> 第三，还是因为业务逻辑代码会被多个UI应用使用，这些UI可能会使用不同类型的连接（缓慢的移动手机的连接，国外浏览器访问等等），你需要采用事务和重试逻辑来确保维护数据集成以及给用户提供一个愉快的体验。<br> 最后，总有意外会发生，你可能不知道此时你会使用何种类型的持久化，所以需要某种方法处理异常（很可能是记录日志）。</p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);"> <a name="without"></a>没有AOP的生活</h2> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">将评估提交给项目经理之后，所有的批准和文件也已经签署了，现在就可以开始了。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">新建一个解决方案，名叫<strong>CarRental</strong>，并创建一个类库项目存放业务逻辑，取名<em>CarRental.Core</em></p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">编写业务逻辑</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">创建一个累积积分的接口，代码如下：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">interface</span> <span class="hljs-title" style="color:rgb(163,21,21);">ILoyaltyAccrualService</span>
{
    <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Accrue</span>(<span class="hljs-params">RentalAgreement agreement</span>)</span>;
}

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">RentalAgreement</code>是该积分系统领域公用的一个实体类，因此按理说它应该在一个不同的程序集，但这里为了演示，我创建了一个<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Entities</code>的文件夹，存放所有的实体。</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">
<span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">RentalAgreement</span>
{
    <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> Guid Id { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
    <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> Customer Customer { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
    <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> Vehicle Vehicle { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
    <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> DateTime StartDate { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
    <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> DateTime EndDate { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
}


 <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">Customer</span>
 {
     <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> Guid Id { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
     <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> Name { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
     <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> DriversLicense { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
     <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> DateTime DateOfBirth { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
 }

 <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">Vehicle</span>
 {
     <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> Guid Id { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
     <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> Make { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
     <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> Model { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
     <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> Size Size { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
     <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> Vin { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
 }

 <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">enum</span> Size
 {
     Compact=<span class="hljs-number">0</span>,
     Midsize,
     FullSize,
     Luxury,
     Truck,
     SUV
 }

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">再回头看<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">ILoyaltyAccrualService</code>接口，该接口有一个使用了这些实体的<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Accure</code>方法，用来为客户累积积分。下面是该接口的实现，它会依赖一个持久化数据的服务。<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Accure</code>方法会包含了计算协议中天数和这些天共累积多少积分的业务逻辑，并将这些积分数量存储到数据库中。</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">LoyaltyAccrualService</span>:<span class="hljs-title" style="color:rgb(163,21,21);">ILoyaltyAccrualService</span>
{
    <span class="hljs-keyword" style="color:rgb(0,0,255);">private</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">readonly</span> ILoyaltyDataService _loyaltyDataService;

    <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-title" style="color:rgb(163,21,21);">LoyaltyAccrualService</span>(<span class="hljs-params">ILoyaltyDataService loyaltyDataService</span>) </span>{
        _loyaltyDataService = loyaltyDataService;<span class="hljs-comment" style="color:#008000;">//数据服务必须在该对象初始化时传入该对象</span>
    }
    <span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;summary&gt;</span></span>
    <span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> 该方法包含了积分系统累积客户积分的逻辑和规则</span>
    <span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;/summary&gt;</span></span>
    <span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;param name="agreement"&gt;</span>租赁协议实体<span class="hljs-doctag" style="color:#808080;">&lt;/param&gt;</span></span>
    <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Accrue</span>(<span class="hljs-params">RentalAgreement agreement</span>) </span>{
        <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> rentalTimeSpan = agreement.EndDate.Subtract(agreement.StartDate);
        <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> numberOfDays = (<span class="hljs-keyword" style="color:rgb(0,0,255);">int</span>)rentalTimeSpan.TotalDays;
        <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> pointsPerDay = <span class="hljs-number">1</span>;
        <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (agreement.Vehicle.Size &gt;=Size.Luxury)
        {
            pointsPerDay = <span class="hljs-number">2</span>;
        }
        <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> points = numberOfDays*pointsPerDay;
        <span class="hljs-comment" style="color:#008000;">//调用数据服务存储客户获得的积分</span>
        _loyaltyDataService.AddPoints(agreement.Customer.Id,points);
    }
}

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">ILoyaltyDataService</code>只有两个方法：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"> <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">interface</span> <span class="hljs-title" style="color:rgb(163,21,21);">ILoyaltyDataService</span>
 {
     <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">AddPoints</span>(<span class="hljs-params">Guid customerId,<span class="hljs-keyword" style="color:rgb(0,0,255);">int</span> points</span>)</span>;
     <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">SubstractPoints</span>(<span class="hljs-params">Guid customerId, <span class="hljs-keyword" style="color:rgb(0,0,255);">int</span> points</span>)</span>;
 }

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">ILoyaltyDataService</code>作为数据库接口，会通过DI的方式传入到业务层的构造函数。因为我们现在只集中在业务逻辑层，所以我们在数据服务层只是简单地打印一些东西就好了，<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">FakeLoyaltyDataService</code>实现了<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">ILoyaltyDataService</code>如下：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">FakeLoyalDataService</span>:<span class="hljs-title" style="color:rgb(163,21,21);">ILoyaltyDataService</span>
{
    <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">AddPoints</span>(<span class="hljs-params">Guid customerId, <span class="hljs-keyword" style="color:rgb(0,0,255);">int</span> points</span>) </span>{
        Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"客户{0}增加了{1}积分"</span>,customerId,points);
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">SubstractPoints</span>(<span class="hljs-params">Guid customerId, <span class="hljs-keyword" style="color:rgb(0,0,255);">int</span> points</span>) </span>{
        Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"客户{0}减少了{1}积分"</span>, customerId, points);
    }
}

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">到这里，已经完成了累积积分的业务逻辑！现在回到客户关心的问题上，如何兑换积分？创建一个接口<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">ILoyaltyRedemptionService</code>：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">
 <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">interface</span> <span class="hljs-title" style="color:rgb(163,21,21);">ILoyaltyRedemptionService</span>
 {
     <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Redeem</span>(<span class="hljs-params">Invoice invoice, <span class="hljs-keyword" style="color:rgb(0,0,255);">int</span> numberOfDays</span>)</span>;
 }

 <span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;summary&gt;</span></span>
 <span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> 发票实体</span>
 <span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;/summary&gt;</span></span>
 <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">Invoice</span>
 {
     <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> Guid Id { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
     <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> Customer Customer { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
     <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> Vehicle Vehicle { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
     <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">int</span> CostPerDay { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
     <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">decimal</span> Discount { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
 }

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">兑换积分是基于客户租赁的车型和兑换的天数从客户的账户中减去积分，并填充发票中的折扣金额。代码如下：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"> <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">LoyalRedemptionService</span>:<span class="hljs-title" style="color:rgb(163,21,21);">ILoyaltyRedemptionService</span>
 {
     <span class="hljs-keyword" style="color:rgb(0,0,255);">private</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">readonly</span> ILoyaltyDataService _loyaltyDataService;

     <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-title" style="color:rgb(163,21,21);">LoyalRedemptionService</span>(<span class="hljs-params">ILoyaltyDataService loyaltyDataService</span>) </span>{
         _loyaltyDataService = loyaltyDataService;
     }

     <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Redeem</span>(<span class="hljs-params">Invoice invoice, <span class="hljs-keyword" style="color:rgb(0,0,255);">int</span> numberOfDays</span>) </span>{
         <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> pointsPerDay = <span class="hljs-number">10</span>;
         <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (invoice.Vehicle.Size&gt;=Size.Luxury)
         {
             pointsPerDay = <span class="hljs-number">15</span>;
         }
         <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> totalPoints = pointsPerDay*numberOfDays;
         invoice.Discount = numberOfDays*invoice.CostPerDay;
         _loyaltyDataService.SubstractPoints(invoice.Customer.Id,totalPoints);
     }
 }

</code></pre> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">测试业务逻辑</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">下面创建一个控制台UI模拟业务逻辑的使用：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">Program</span>
 {
     <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">static</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Main</span>(<span class="hljs-params"><span class="hljs-keyword" style="color:rgb(0,0,255);">string</span>[] args</span>) </span>{
         SimulateAddingPoints();<span class="hljs-comment" style="color:#008000;">//模拟累积</span>
         Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"***************"</span>);
         SimulateRemovingPoints();<span class="hljs-comment" style="color:#008000;">//模拟兑换</span>
         Console.Read();
     }

     <span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;summary&gt;</span></span>
     <span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> 模拟累积积分</span>
     <span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;/summary&gt;</span></span>
     <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">static</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">SimulateAddingPoints</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> dataService=<span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> FakeLoyalDataService();<span class="hljs-comment" style="color:#008000;">//这里使用的数据库服务是伪造的</span>
            <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> service=<span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> LoyaltyAccrualService(dataService);
            <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> agreement=<span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> RentalAgreement
            {
                Customer = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> Customer
                {
                    Id = Guid.NewGuid(),
                    Name = <span class="hljs-string" style="color:rgb(163,21,21);">"tkb至简"</span>,
                    DateOfBirth = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> DateTime(<span class="hljs-number">2000</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>),
                    DriversLicense = <span class="hljs-string" style="color:rgb(163,21,21);">"123456"</span>
                },
                Vehicle = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> Vehicle
                {
                    Id = Guid.NewGuid(),
                    Make = <span class="hljs-string" style="color:rgb(163,21,21);">"Ford"</span>,
                    Model = <span class="hljs-string" style="color:rgb(163,21,21);">"金牛座"</span>,
                    Size = Size.Compact,
                    Vin = <span class="hljs-string" style="color:rgb(163,21,21);">"浙-ABC123"</span>
                },
                StartDate = DateTime.Now.AddDays(<span class="hljs-number">-3</span>),
                EndDate = DateTime.Now
            };
            service.Accrue(agreement);
        }

     <span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;summary&gt;</span></span>
     <span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> 模拟兑换积分</span>
     <span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;/summary&gt;</span></span>
     <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">static</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">SimulateRemovingPoints</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> dataService = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> FakeLoyalDataService();
            <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> service = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> LoyalRedemptionService(dataService);
            <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> invoice = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> Invoice
            {
                Customer = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> Customer
                {
                    Id = Guid.NewGuid(),
                    Name = <span class="hljs-string" style="color:rgb(163,21,21);">"Farb"</span>,
                    DateOfBirth = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> DateTime(<span class="hljs-number">1999</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>),
                    DriversLicense = <span class="hljs-string" style="color:rgb(163,21,21);">"abcdef"</span>
                },
                Vehicle = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> Vehicle
                {
                    Id = Guid.NewGuid(),
                    Make = <span class="hljs-string" style="color:rgb(163,21,21);">"奥迪"</span>,
                    Model = <span class="hljs-string" style="color:rgb(163,21,21);">"Q7"</span>,
                    Size = Size.Compact,
                    Vin = <span class="hljs-string" style="color:rgb(163,21,21);">"浙-DEF123"</span>
                },
                 CostPerDay = <span class="hljs-number">100</span>m,
                 Id = Guid.NewGuid()
            };
            service.Redeem(invoice,<span class="hljs-number">3</span>);<span class="hljs-comment" style="color:#008000;">//这里兑换3天</span>
        }
 }

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">运行程序，伪造的数据服务会在控制台上打印一些东西，结果如下：</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/22a2ea4d-2760-4e2e-b4c6-d11913c05437.png" alt="图片" style="border:0px;"></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">现在，业务逻辑完成了，代码很干净，分离地也很好，很容易阅读和维护，但是这代码还不能进入生产环境，因为有各种各样可能会出错的事情发生，因此下面着手新功能的需求开发。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">添加日志</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">虽然审计积分事务还不是一个需求，但是为了安全起见，最好还是记录每个请求，至少是为了QA（质量保证）的目的。在生产环境，可能会限制或减少日志，但是现在我们要放一些简单的日志帮助开发者重现QA找到的bugs。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">现在，当累积积分和兑换积分时，添加日志，其余代码和之前的一样。</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">  <span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;summary&gt;</span></span>
  <span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> 该方法包含了积分系统累积客户积分的逻辑和规则</span>
  <span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;/summary&gt;</span></span>
  <span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;param name="agreement"&gt;</span>租赁协议实体<span class="hljs-doctag" style="color:#808080;">&lt;/param&gt;</span></span>
  <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Accrue</span>(<span class="hljs-params">RentalAgreement agreement</span>) </span>{

      Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Accrue:{0}"</span>,DateTime.Now);
      Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Customer:{0}"</span>,agreement.Customer.Id);
      Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Vehicle:{0}"</span>,agreement.Vehicle.Id);
      <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> rentalTimeSpan = agreement.EndDate.Subtract(agreement.StartDate);
      <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> numberOfDays = (<span class="hljs-keyword" style="color:rgb(0,0,255);">int</span>)rentalTimeSpan.TotalDays;
      <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> pointsPerDay = <span class="hljs-number">1</span>;
      <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (agreement.Vehicle.Size &gt;=Size.Luxury)
      {
          pointsPerDay = <span class="hljs-number">2</span>;
      }
      <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> points = numberOfDays*pointsPerDay;
      <span class="hljs-comment" style="color:#008000;">//调用数据服务存储客户获得的积分</span>
      _loyaltyDataService.AddPoints(agreement.Customer.Id,points);
      Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Accrue Complete：{0}"</span>,DateTime.Now);
  }

<span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Redeem</span>(<span class="hljs-params">Invoice invoice, <span class="hljs-keyword" style="color:rgb(0,0,255);">int</span> numberOfDays</span>) </span>{
    Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Redeem:{0}"</span>,DateTime.Now);
    Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Invoice:{0}"</span>,invoice.Id);
    <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> pointsPerDay = <span class="hljs-number">10</span>;
    <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (invoice.Vehicle.Size&gt;=Size.Luxury)
    {
        pointsPerDay = <span class="hljs-number">15</span>;
    }
    <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> totalPoints = pointsPerDay*numberOfDays;
    invoice.Discount = numberOfDays*invoice.CostPerDay;
    _loyaltyDataService.SubstractPoints(invoice.Customer.Id,totalPoints);
    Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Redeem Complete:{0}"</span>,DateTime.Now);
}

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">现在还不是很糟糕，只不过在每个实现中添加了几行代码而已。咱们继续往下走！</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">防御性编程</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">因为我们的业务逻辑没有对传入的参数进行控制，因此必须要检查一下是否是最坏的情景。比如，如果<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Accrue</code>方法传入一个null会怎样？我们的业务逻辑不能处理这个，所以会抛异常，但我们希望它能调用我们的API处理这个异常，如果处理不了，就提醒UI开发者或QA发生了一些错误的东西。这种哲学就叫<strong>防御性编程</strong>，只是为了减少危险场景的风险。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">下面我们使用防御性编程检查传入参数为null的无效场景：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"> <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Accrue</span>(<span class="hljs-params">RentalAgreement agreement</span>) </span>{
     <span class="hljs-comment" style="color:#008000;">//防御性编程</span>
     <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (agreement==<span class="hljs-keyword" style="color:rgb(0,0,255);">null</span>)
     {
         <span class="hljs-keyword" style="color:rgb(0,0,255);">throw</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> Exception(<span class="hljs-string" style="color:rgb(163,21,21);">"agreement为null！"</span>);
     }
     <span class="hljs-comment" style="color:#008000;">//日志</span>
     Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Accrue:{0}"</span>,DateTime.Now);
     Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Customer:{0}"</span>,agreement.Customer.Id);
     Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Vehicle:{0}"</span>,agreement.Vehicle.Id);
     <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> rentalTimeSpan = agreement.EndDate.Subtract(agreement.StartDate);
     <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> numberOfDays = (<span class="hljs-keyword" style="color:rgb(0,0,255);">int</span>)rentalTimeSpan.TotalDays;
     <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> pointsPerDay = <span class="hljs-number">1</span>;
     <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (agreement.Vehicle.Size &gt;=Size.Luxury)
     {
         pointsPerDay = <span class="hljs-number">2</span>;
     }
     <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> points = numberOfDays*pointsPerDay;
     <span class="hljs-comment" style="color:#008000;">//调用数据服务存储客户获得的积分</span>
     _loyaltyDataService.AddPoints(agreement.Customer.Id,points);
     Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Accrue Complete：{0}"</span>,DateTime.Now);
 }

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">我们也可以检查<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">RentalAgreement</code>的属性，但现在上面的就足够了。<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Redeem</code>的实现也有相同的问题，<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">numberOfDays</code>参数的值不能小于1，<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Invoice</code>参数也不能为null，因此也必须使用防御性编程：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"> <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Redeem</span>(<span class="hljs-params">Invoice invoice, <span class="hljs-keyword" style="color:rgb(0,0,255);">int</span> numberOfDays</span>) </span>{
     <span class="hljs-comment" style="color:#008000;">//防御性编程</span>
     <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (invoice==<span class="hljs-keyword" style="color:rgb(0,0,255);">null</span>)
     {
         <span class="hljs-keyword" style="color:rgb(0,0,255);">throw</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> Exception(<span class="hljs-string" style="color:rgb(163,21,21);">"invoice为null！"</span>);
     }
     <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (numberOfDays&lt;=<span class="hljs-number">0</span>)
     {
         <span class="hljs-keyword" style="color:rgb(0,0,255);">throw</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> Exception(<span class="hljs-string" style="color:rgb(163,21,21);">"numberOfDays不能小于1！"</span>);
     }
     <span class="hljs-comment" style="color:#008000;">//logging</span>
     Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Redeem:{0}"</span>,DateTime.Now);
     Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Invoice:{0}"</span>,invoice.Id);
     <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> pointsPerDay = <span class="hljs-number">10</span>;
     <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (invoice.Vehicle.Size&gt;=Size.Luxury)
     {
         pointsPerDay = <span class="hljs-number">15</span>;
     }
     <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> totalPoints = pointsPerDay*numberOfDays;
     invoice.Discount = numberOfDays*invoice.CostPerDay;
     _loyaltyDataService.SubstractPoints(invoice.Customer.Id,totalPoints);
     Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Redeem Complete:{0}"</span>,DateTime.Now);
 }

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">现在我们的代码开始变得具有防御性了，如果在核心逻辑的控制之外发生了错误，也不会影响到我们了。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">在添加了日志和防御性代码之后，<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Accrue</code>和<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Redeem</code>方法开始变得有点长了，也有点重复，但继续看一下事务和重试逻辑。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">使用事务和重试</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">如果我们使用了不止一个数据层操作，为了使这些操作具有原子性，那么事务是必须的。也就是说，我们想要所有的数据层调用都成功（提交），要么都失败（回滚）。假设，我们可以将事务放到业务逻辑层。<br> 假设底层的数据层会使用和.NET内置的事务类<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">TransactionScope</code>兼容的技术，结合<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">try/catch</code>块，我们可以给<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Accrue</code>方法添加事务代码：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"> <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Accrue</span>(<span class="hljs-params">RentalAgreement agreement</span>) </span>{
     <span class="hljs-comment" style="color:#008000;">//防御性编程</span>
     <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (agreement==<span class="hljs-keyword" style="color:rgb(0,0,255);">null</span>)
     {
         <span class="hljs-keyword" style="color:rgb(0,0,255);">throw</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> Exception(<span class="hljs-string" style="color:rgb(163,21,21);">"agreement为null！"</span>);
     }
     <span class="hljs-comment" style="color:#008000;">//日志</span>
     Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Accrue:{0}"</span>,DateTime.Now);
     Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Customer:{0}"</span>,agreement.Customer.Id);
     Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Vehicle:{0}"</span>,agreement.Vehicle.Id);
     <span class="hljs-keyword" style="color:rgb(0,0,255);">using</span> (<span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> ts=<span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> TransactionScope())<span class="hljs-comment" style="color:#008000;">//开始一个新事务</span>
     {
         <span class="hljs-keyword" style="color:rgb(0,0,255);">try</span>
         {
             <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> rentalTimeSpan = agreement.EndDate.Subtract(agreement.StartDate);
             <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> numberOfDays = (<span class="hljs-keyword" style="color:rgb(0,0,255);">int</span>)rentalTimeSpan.TotalDays;
             <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> pointsPerDay = <span class="hljs-number">1</span>;
             <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (agreement.Vehicle.Size &gt;= Size.Luxury)
             {
                 pointsPerDay = <span class="hljs-number">2</span>;
             }
             <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> points = numberOfDays * pointsPerDay;
             <span class="hljs-comment" style="color:#008000;">//调用数据服务存储客户获得的积分</span>
             _loyaltyDataService.AddPoints(agreement.Customer.Id, points);
             ts.Complete();<span class="hljs-comment" style="color:#008000;">//调用Complete方法表明事务成功提交</span>
         }
         <span class="hljs-keyword" style="color:rgb(0,0,255);">catch</span> (Exception ex)
         {
             <span class="hljs-keyword" style="color:rgb(0,0,255);">throw</span>;<span class="hljs-comment" style="color:#008000;">//没有调用Complete方法，事务会回滚</span>
         }
     }
     Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Accrue Complete：{0}"</span>,DateTime.Now);
 }

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">记住，只有调用了事务的<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Complete</code>方法，事务才会提交，否则就会回滚。如果抛出了异常，这里我们只是重新抛出，相似地，也可以在<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Redeem</code>方法中使用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">TransactionScope</code>,这里不再贴了，请自行看源码。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">上面的代码开始变长、变丑了，原始的业务逻辑代码周围包了很多和横切关注点有关的代码块：logging，防御性编程和事务代码。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">但是我们还没做完，假设底层的数据持久层偶尔会出现高流量，可能就会导致某些请求失败（比如，抛出超时异常）。如果是那种情况，执行几次重试会保持程序平滑运行（尽管在高流量期间有点慢）。通过在事务中放一个循环，每次事务回滚时，我们就增加重试次数，一旦重试次数达到限制值，我们就不管了，如下：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Accrue</span>(<span class="hljs-params">RentalAgreement agreement</span>) </span>{
    <span class="hljs-comment" style="color:#008000;">//防御性编程</span>
    <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (agreement==<span class="hljs-keyword" style="color:rgb(0,0,255);">null</span>)
    {
        <span class="hljs-keyword" style="color:rgb(0,0,255);">throw</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> Exception(<span class="hljs-string" style="color:rgb(163,21,21);">"agreement为null！"</span>);
    }
    <span class="hljs-comment" style="color:#008000;">//日志</span>
    Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Accrue:{0}"</span>,DateTime.Now);
    Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Customer:{0}"</span>,agreement.Customer.Id);
    Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Vehicle:{0}"</span>,agreement.Vehicle.Id);
    <span class="hljs-keyword" style="color:rgb(0,0,255);">using</span> (<span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> ts=<span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> TransactionScope())<span class="hljs-comment" style="color:#008000;">//开始一个新事务</span>
    {
        <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> retries = <span class="hljs-number">3</span>;<span class="hljs-comment" style="color:#008000;">//重试事务3次</span>
        <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> succeeded = <span class="hljs-keyword" style="color:rgb(0,0,255);">false</span>;
        <span class="hljs-keyword" style="color:rgb(0,0,255);">while</span> (!succeeded)<span class="hljs-comment" style="color:#008000;">//一直循环，直到成功</span>
        {
            <span class="hljs-keyword" style="color:rgb(0,0,255);">try</span>
            {
                <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> rentalTimeSpan = agreement.EndDate.Subtract(agreement.StartDate);
                <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> numberOfDays = (<span class="hljs-keyword" style="color:rgb(0,0,255);">int</span>)rentalTimeSpan.TotalDays;
                <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> pointsPerDay = <span class="hljs-number">1</span>;
                <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (agreement.Vehicle.Size &gt;= Size.Luxury)
                {
                    pointsPerDay = <span class="hljs-number">2</span>;
                }
                <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> points = numberOfDays * pointsPerDay;
                <span class="hljs-comment" style="color:#008000;">//调用数据服务存储客户获得的积分</span>
                _loyaltyDataService.AddPoints(agreement.Customer.Id, points);
                ts.Complete();<span class="hljs-comment" style="color:#008000;">//调用Complete方法表明事务成功提交</span>
                succeeded = <span class="hljs-keyword" style="color:rgb(0,0,255);">true</span>;<span class="hljs-comment" style="color:#008000;">//成功后设置为true，确保最后一次循环迭代</span>
                Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Accrue Complete：{0}"</span>, DateTime.Now);<span class="hljs-comment" style="color:#008000;">//这句移入try里</span>
            }
            <span class="hljs-keyword" style="color:rgb(0,0,255);">catch</span> 
            {
                <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (retries&gt;=<span class="hljs-number">0</span>)
                {
                    retries--;<span class="hljs-comment" style="color:#008000;">//直到尝试完次数时才重抛异常</span>
                }
                <span class="hljs-keyword" style="color:rgb(0,0,255);">else</span>
                {
                    <span class="hljs-keyword" style="color:rgb(0,0,255);">throw</span>;<span class="hljs-comment" style="color:#008000;">//没有调用Complete方法，事务会回滚</span>
                }
                
            }
        }
    }
  
}

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">相似地，我们也要在<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Redeem</code>方法中添加，这里不做了，省略。问题越来越明显了，横切关注点基本上占据了这个方法的一半代码。但是我们还没有做完，我们需要讨论一下异常处理。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">处理异常</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">前面不是添加了<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">try/catch</code>了么?难道还不够？也许！比如，服务器离线了，重试次数到达限制了，异常还是会重抛出去，如果是这种情况，我们就需要在程序崩溃前处理这个异常。<br> 因此我们需要在防御性编程后再添加一个<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">try/catch</code>块包裹其他所有的代码，如下：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Accrue</span>(<span class="hljs-params">RentalAgreement agreement</span>) </span>{
    <span class="hljs-comment" style="color:#008000;">//防御性编程</span>
    <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (agreement==<span class="hljs-keyword" style="color:rgb(0,0,255);">null</span>)
    {
        <span class="hljs-keyword" style="color:rgb(0,0,255);">throw</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> Exception(<span class="hljs-string" style="color:rgb(163,21,21);">"agreement为null！"</span>);
    }
    <span class="hljs-comment" style="color:#008000;">//日志</span>
    Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Accrue:{0}"</span>,DateTime.Now);
    Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Customer:{0}"</span>,agreement.Customer.Id);
    Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Vehicle:{0}"</span>,agreement.Vehicle.Id);
    <span class="hljs-keyword" style="color:rgb(0,0,255);">try</span>
    {
        <span class="hljs-keyword" style="color:rgb(0,0,255);">using</span> (<span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> ts = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> TransactionScope())<span class="hljs-comment" style="color:#008000;">//开始一个新事务</span>
        {
            <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> retries = <span class="hljs-number">3</span>;<span class="hljs-comment" style="color:#008000;">//重试事务3次</span>
            <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> succeeded = <span class="hljs-keyword" style="color:rgb(0,0,255);">false</span>;
            <span class="hljs-keyword" style="color:rgb(0,0,255);">while</span> (!succeeded)<span class="hljs-comment" style="color:#008000;">//一直循环，直到成功</span>
            {
                <span class="hljs-keyword" style="color:rgb(0,0,255);">try</span>
                {
                    <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> rentalTimeSpan = agreement.EndDate.Subtract(agreement.StartDate);
                    <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> numberOfDays = (<span class="hljs-keyword" style="color:rgb(0,0,255);">int</span>)rentalTimeSpan.TotalDays;
                    <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> pointsPerDay = <span class="hljs-number">1</span>;
                    <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (agreement.Vehicle.Size &gt;= Size.Luxury)
                    {
                        pointsPerDay = <span class="hljs-number">2</span>;
                    }
                    <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> points = numberOfDays * pointsPerDay;
                    <span class="hljs-comment" style="color:#008000;">//调用数据服务存储客户获得的积分</span>
                    _loyaltyDataService.AddPoints(agreement.Customer.Id, points);
                    ts.Complete();<span class="hljs-comment" style="color:#008000;">//调用Complete方法表明事务成功提交</span>
                    succeeded = <span class="hljs-keyword" style="color:rgb(0,0,255);">true</span>;<span class="hljs-comment" style="color:#008000;">//成功后设置为true，确保最后一次循环迭代</span>
                    Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Accrue Complete：{0}"</span>, DateTime.Now);<span class="hljs-comment" style="color:#008000;">//这句移入try里</span>
                }
                <span class="hljs-keyword" style="color:rgb(0,0,255);">catch</span>
                {
                    <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (retries &gt;= <span class="hljs-number">0</span>)
                    {
                        retries--;<span class="hljs-comment" style="color:#008000;">//直到尝试完次数时才重抛异常</span>
                    }
                    <span class="hljs-keyword" style="color:rgb(0,0,255);">else</span>
                    {
                        <span class="hljs-keyword" style="color:rgb(0,0,255);">throw</span>;<span class="hljs-comment" style="color:#008000;">//没有调用Complete方法，事务会回滚</span>
                    }

                }
            }
        }

    }
    <span class="hljs-keyword" style="color:rgb(0,0,255);">catch</span> (Exception ex)
    {
        <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (!ExceptionHelper.Handle(ex))<span class="hljs-comment" style="color:#008000;">//如果没有处理异常，继续重抛</span>
        {
            <span class="hljs-keyword" style="color:rgb(0,0,255);">throw</span> ex;
        }
    }
  
}

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">ExceptionHelper</code>是自定义的异常处理帮助类，覆盖了个别异常的处理，如果是没有覆盖的异常，我们可能需要记录日志，并告诉客户出现了什么异常。相似地，<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Redeem</code>方法也要做相同的处理，此处省略。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">此时，我们已经实现了所有非功能需求：logging，防御性编程，事务，重试，和异常处理。将这些处理横切关注点的代码添加到原始的<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Accrue</code>和<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Redeem</code>方法中使得它们膨胀成巨大的方法。现在代码可以去生产环境（或更可能去QA/预发布环境），但是这代码太糟糕了！</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">你可能在想这个描述有点过了，并不是所有的横切关注点都是必须的，是的，你可能大多数情况只需要一两个横切关注点，一些关注点可以移到数据层或UI层。<strong>但这里要说明的道理是横切关注点可以使你的代码变杂乱，使得代码更难阅读、维护和调试</strong>。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">不使用AOP重构</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">是时候整理下代码了，因为<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Accrue</code>和<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Redeem</code>方法中有很多重复代码，我们可以把这些代码放到它们自己的类或方法中。一种选择是将所有的非功能关注点重构到静态方法中，这是个馊主意，因为这会将业务逻辑紧耦合到非功能关注点代码中，虽然使方法看上去更短更可读了，但仍然留下了方法做的事情太多的问题。你也可以使用DI策略，将所有的logging，防御性编程和其他服务传给<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">LoyaltyAccrualService</code>和<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">LoyaltyRedemptionService</code>的构造函数：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">LoyalRedemptionServiceRefactored</span>:<span class="hljs-title" style="color:rgb(163,21,21);">ILoyaltyRedemptionService</span>
{
    <span class="hljs-keyword" style="color:rgb(0,0,255);">private</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">readonly</span> ILoyaltyDataService _loyaltyDataService;
    <span class="hljs-keyword" style="color:rgb(0,0,255);">private</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">readonly</span> IExceptionHandler _exceptionHandler;<span class="hljs-comment" style="color:#008000;">//异常处理接口</span>
    <span class="hljs-keyword" style="color:rgb(0,0,255);">private</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">readonly</span> ITransactionManager _transactionManager;<span class="hljs-comment" style="color:#008000;">//事务管理者</span>

    <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-title" style="color:rgb(163,21,21);">LoyalRedemptionServiceRefactored</span>(<span class="hljs-params">ILoyaltyDataService loyaltyDataService, IExceptionHandler exceptionHandler, ITransactionManager transactionManager</span>) </span>{
        _loyaltyDataService = loyaltyDataService;
        _exceptionHandler = exceptionHandler;<span class="hljs-comment" style="color:#008000;">//通过依赖注入传入</span>
        _transactionManager = transactionManager;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Redeem</span>(<span class="hljs-params">Invoice invoice, <span class="hljs-keyword" style="color:rgb(0,0,255);">int</span> numberOfDays</span>) </span>{
        <span class="hljs-comment" style="color:#008000;">//防御性编程</span>
        <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (invoice==<span class="hljs-keyword" style="color:rgb(0,0,255);">null</span>)
        {
            <span class="hljs-keyword" style="color:rgb(0,0,255);">throw</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> Exception(<span class="hljs-string" style="color:rgb(163,21,21);">"Invoice为null了！"</span>);
        }
        <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (numberOfDays&lt;=<span class="hljs-number">0</span>)
        {
            <span class="hljs-keyword" style="color:rgb(0,0,255);">throw</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> Exception(<span class="hljs-string" style="color:rgb(163,21,21);">"numberOfDays不能小于1！"</span>);
        }
        <span class="hljs-comment" style="color:#008000;">//logging</span>
        Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Redeem: {0}"</span>, DateTime.Now);
        Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Invoice: {0}"</span>, invoice.Id);

        _exceptionHandler.Wrapper(() =&gt;
        {
            _transactionManager.Wrapper(() =&gt;
            {
                <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> pointsPerDay = <span class="hljs-number">10</span>;
                <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (invoice.Vehicle.Size&gt;=Size.Luxury)
                {
                    pointsPerDay = <span class="hljs-number">15</span>;
                }
                <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> totalPoints = numberOfDays*pointsPerDay;
                _loyaltyDataService.SubstractPoints(invoice.Customer.Id,totalPoints);
                invoice.Discount = numberOfDays*invoice.CostPerDay;
                <span class="hljs-comment" style="color:#008000;">// logging</span>
                Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Redeem complete: {0}"</span>,DateTime.Now);
            });
        });
    }
}

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">上面是重构过的版本，<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">IExceptionHandler</code>等的代码没有贴出来，请查看源码，这个版本比之前的好多了。我将异常处理代码和事务/重试代码分别放到了<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">IExceptionHandler</code>和<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">ITransactionManager</code>中，这种设计有它的优势，一是它把那些代码段放到了他们自己的类中，以后可以重用；二是通过减少了横切关注点的噪音使得代码阅读更容易。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">当然，<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Accrue</code>方法也可以重构成这样，此处略过。重构之后，代码和最原始的状态差不多了。但是构造函数好像太庞大了,也就是依赖太多了，实际上，这里可以优化一下，往下看。</p> 
   <blockquote style="border:2px solid rgb(239,239,239);line-height:1.6;color:rgb(51,51,51);font-size:15px;font-family:'Microsoft Yahei';clear:both;background:rgb(223,255,163) url(&quot;//files.cnblogs.com/files/farb/o_title.gif&quot;) no-repeat 9px 50%;"> 
    <p>Code Smells【代码异味】<br> 代码异味是一个俚语，本质上它不是bug，但它暗示了可能会存在一个问题。就像冰箱里的难闻气味表明背后有腐烂的肉一样，代码异味可能指示了当前的设计不太好，应该被重构。详细了解代码意味，可以<strong><a href="http://www.nowamagic.net/librarys/veda/detail/2053" rel="nofollow" style="color:rgb(65,131,196);text-decoration:none;">点击阅读</a></strong>。</p> 
   </blockquote> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">我们可以将异常处理和事务管理合并成一个服务，如下：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">interface</span> <span class="hljs-title" style="color:rgb(163,21,21);">ITransactionManager2</span>
{
    <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Wrapper</span>(<span class="hljs-params">Action method</span>)</span>;
}

<span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">TransactionManager2</span> : <span class="hljs-title" style="color:rgb(163,21,21);">ITransactionManager2</span>
{
    <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Wrapper</span>(<span class="hljs-params">Action method</span>) </span>{
        <span class="hljs-keyword" style="color:rgb(0,0,255);">using</span> (<span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> ts=<span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> TransactionScope())
        {
            <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> retires = <span class="hljs-number">3</span>;
            <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> succeeded = <span class="hljs-keyword" style="color:rgb(0,0,255);">false</span>;
            <span class="hljs-keyword" style="color:rgb(0,0,255);">while</span> (!succeeded)
            {
                <span class="hljs-keyword" style="color:rgb(0,0,255);">try</span>
                {
                    method();
                    ts.Complete();
                    succeeded = <span class="hljs-keyword" style="color:rgb(0,0,255);">true</span>;
                }
                <span class="hljs-keyword" style="color:rgb(0,0,255);">catch</span> (Exception ex)
                {
                    <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (retires &gt;= <span class="hljs-number">0</span>)
                        retires--;
                    <span class="hljs-keyword" style="color:rgb(0,0,255);">else</span>
                    {
                        <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (!ExceptionHelper.Handle(ex))
                            <span class="hljs-keyword" style="color:rgb(0,0,255);">throw</span>;
                    }
                }
            }
        }
    }
}

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">处理注入依赖过多的另一种方法是将所有的服务移到一个聚合服务或者门面服务（即，使用门面模式将所有的小服务组合成一个服务来组织这些小服务），我们这个例子中，<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">TransactionManager</code>和<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">ExceptionHandler</code>服务是独立的，但是可以使用第三个门面类来组织它们的使用。</p> 
   <blockquote style="border:2px solid rgb(239,239,239);line-height:1.6;color:rgb(51,51,51);font-size:15px;font-family:'Microsoft Yahei';clear:both;background:rgb(223,255,163) url(&quot;//files.cnblogs.com/files/farb/o_title.gif&quot;) no-repeat 9px 50%;"> 
    <p>门面模式 The Facade Pattern<br> 门面模式为更大的或者更复杂的代码段提供了一个简化接口，比如，一个提供了许多方法和选项的服务类可以放到一个门面接口中，这样就可以通过限制选项或者提供简化方法的子集来降低复杂度。</p> 
   </blockquote> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">interface</span> <span class="hljs-title" style="color:rgb(163,21,21);">ITransactionFacade</span>
{
    <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Wrapper</span>(<span class="hljs-params">Action method</span>)</span>;
}

<span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">TransactionFacade</span> : <span class="hljs-title" style="color:rgb(163,21,21);">ITransactionFacade</span>
{
    <span class="hljs-keyword" style="color:rgb(0,0,255);">private</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">readonly</span> ITransactionManager _transactionManager;
    <span class="hljs-keyword" style="color:rgb(0,0,255);">private</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">readonly</span> IExceptionHandler _exceptionHandler;

    <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-title" style="color:rgb(163,21,21);">TransactionFacade</span>(<span class="hljs-params">ITransactionManager transactionManager, IExceptionHandler exceptionHandler</span>) </span>{
        _transactionManager = transactionManager;
        _exceptionHandler = exceptionHandler;
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Wrapper</span>(<span class="hljs-params">Action method</span>) </span>{
        _exceptionHandler.Wrapper(()=&gt;
            _transactionManager.Wrapper(method)
            );
    }
}

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">这样修改后，<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Accrual</code>和<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Redemption</code>服务方法中的Wrapper样板代码就减少了很多，更干净了。但是还存在防御编程和logging的问题。</p> 
   <blockquote style="border:2px solid rgb(239,239,239);line-height:1.6;color:rgb(51,51,51);font-size:15px;font-family:'Microsoft Yahei';clear:both;background:rgb(223,255,163) url(&quot;//files.cnblogs.com/files/farb/o_title.gif&quot;) no-repeat 9px 50%;"> 
    <p>使用装饰器模式重构<br> 不使用AOP重构代码的另一种方式是使用装饰器模式或代理器模式。剧透一下：装饰器/代理器模式只是AOP的一种简单形式。</p> 
   </blockquote> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">试想，如果有一种方法可以将上面所有的方法合起来成为一种方法，使得代码回到最初始状态（只有业务逻辑），那将是最好的了。那就读起来最简单，有最少的构造函数注入的服务。当业务逻辑变化时，我们也不必担心忘记或忽略了这些横切关注点，从而减少了变更的代价。</p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);"> <a name="change"></a>变更的代价</h2> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">软件工程中不变的东西就是变化，需求变了，业务规则变了，技术变了。业务逻辑或需求的任何变更对处理原始版本的业务逻辑都是挑战性的（在代码重构之前）。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">需求变更</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">因为许多原因，需求会变更。需求一开始可能是很模糊的，但是随着软件开始成型，就会变得更加具体。项目经理等人就会改变想法，对他们来说看似很小的变化，可能在代码中意味着很大的不同。<br> 虽然我们都知道<strong>需求会变</strong>是个真理，并且也已经反复见证了，但仍然在犯一个错，那就是编码时好像什么都不会改变。作为一个好的开发者，不仅要接受需求的变化，还要期待需求变化。<br> 项目的大小确实很重要，如果你是一个人编写一个简单的软件（比如一个具有两三个表单和许多静态内容的网站），那么变更的代价可能很低，因为改动的地方很少。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">方法签名变更</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">给方法添加或移除参数就会导致方法签名变更。如果移除了一个参数，就必须移除该参数的防御性编程，否则，项目编译不通过。如果修改了一个参数的类型，那么防御性编程边界情况也会改变。更危险的是，如果添加了一个参数，就必须添加该参数的防御性编程，不幸的似乎，编译器不会帮你做这个，自己必须要记得做这件事。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">看一下之前的<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Accrue</code>方法，签名改变的地方会立即影响防御编程和日志记录，如下：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Accrue</span>(<span class="hljs-params">RentalAgreement agreement</span>) </span>{
    <span class="hljs-comment" style="color:#008000;">// defensive programming</span>
    <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span>(agreement == <span class="hljs-keyword" style="color:rgb(0,0,255);">null</span>) <span class="hljs-keyword" style="color:rgb(0,0,255);">throw</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> ArgumentNullException(<span class="hljs-string" style="color:rgb(163,21,21);">"agreement"</span>);
    <span class="hljs-comment" style="color:#008000;">// logging</span>
    Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Accrue: {0}"</span>, DateTime.Now);
    Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Customer: {0}"</span>, agreement.Customer.Id);
    Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Vehicle: {0}"</span>, agreement.Vehicle.Id);
    <span class="hljs-comment" style="color:#008000;">// ... snip ...</span>
    <span class="hljs-comment" style="color:#008000;">// logging</span>
    Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Accrue complete: {0}"</span>, DateTime.Now);
}
</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">如果参数名从<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">agreement</code>变成<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">rentalAgreement</code>,那么必须记得更改<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">ArgumentNullException</code>的构造函数的字符串参数。如果方法名本身变了，也必须更改logging中记录的字符串方法名。虽然有很多重构工具可以辅助，如Resharp,但是其他的还要依赖你自己和团队的警惕。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">团队开发</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">一个人开发就算了。假设有个新的需求，<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">ILoyaltyAccureService</code>接口需要添加一个新的方法，也许这个任务会派给其他队友，并且这个队友实现了业务逻辑并完成了任务。不幸地是，这个队友忘记了使用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">TransactionFacade</code>的<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Wrapper</code>方法，他的代码通过了UT，然后交给了QA。如果这是一个敏捷项目，这也许不是大问题：QA会捕捉到这个问题，并立即把这个问题报告给你。在一个瀑布项目中，QA可能在几个月之后才会发现这个bug。几个月后，你可能也不记得造成这个bug的原因了。就好像你是团队中的新员工一样。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">最糟糕的情况：它可能通过了QA，假设的异常或重试条件不是必要的或者没有被注意到，这样，代码就没有经过防御性编程、logging、事务等等进入了生产环境，这样迟早出问题！</p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);"> <a name="refactor"></a>使用AOP重构</h2> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">再次重构代码，这次使用AOP，使用NuGet添加Postsharp到项目<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">CarRental.Core</code>中，关于如何添加，请查看<strong><a href="http://www.cnblogs.com/farb/p/AOPIntroduction.html" rel="nofollow" style="color:rgb(65,131,196);text-decoration:none;">上一篇文章</a></strong>。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">开发简单、独立的logging</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">先来重构一个简单的横切关注点：logging。当方法调用时，会记录方法名和时间戳。创建一个日志切面类，继承自<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">OnMethodBoundaryAspect</code>，它允许我们在方法的边界插入代码：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">[Serializable]
<span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">LoggingAspect</span>:<span class="hljs-title" style="color:rgb(163,21,21);">OnMethodBoundaryAspect</span>
{
    <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">override</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">OnEntry</span>(<span class="hljs-params">MethodExecutionArgs args</span>) </span>{
        Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"{0}:{1}"</span>,args.Method.Name,DateTime.Now);
    }

    <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">override</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">OnSuccess</span>(<span class="hljs-params">MethodExecutionArgs args</span>) </span>{
        Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"{0} complete:{1}"</span>,args.Method.Name,DateTime.Now);
    }
}

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">注意，我们可以通过<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">MethodExecutionArgs</code>参数获得方法名，因此，这个切面可以c重复使用，可给<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Accure</code>和<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Redeem</code>方法使用：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">LoyaltyAccrualService</span>:<span class="hljs-title" style="color:rgb(163,21,21);">ILoyaltyAccrualService</span>
{
    [LoggingAspect]
    <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Accrue</span>(<span class="hljs-params">RentalAgreement agreement</span>) </span>{
        <span class="hljs-comment" style="color:#008000;">//...</span>
    }
}

 <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">LoyalRedemptionService</span>:<span class="hljs-title" style="color:rgb(163,21,21);">ILoyaltyRedemptionService</span>
 {
     [LoggingAspect]
     <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Redeem</span>(<span class="hljs-params">Invoice invoice, <span class="hljs-keyword" style="color:rgb(0,0,255);">int</span> numberOfDays</span>) </span>{
         <span class="hljs-comment" style="color:#008000;">//...</span>
     }
 }

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">现在就可以从这些方法中移除logging代码了。除此之外，我们还没有打印传入参数的Id，比如<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Customer.Id</code>。有了Postsharp,我们可以取到所有的传入参数，但为了取到Id,必须还得做点事情。</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">
<span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">override</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">OnEntry</span>(<span class="hljs-params">MethodExecutionArgs args</span>) </span>{
    Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"{0}:{1}"</span>,args.Method.Name,DateTime.Now);
    <span class="hljs-keyword" style="color:rgb(0,0,255);">foreach</span> (<span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> argument <span class="hljs-keyword" style="color:rgb(0,0,255);">in</span> args.Arguments)<span class="hljs-comment" style="color:#008000;">//遍历方法的参数</span>
    {
        <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (argument.GetType()==<span class="hljs-keyword" style="color:rgb(0,0,255);">typeof</span>(RentalAgreement))
        {
            Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Customer:{0}"</span>, ((RentalAgreement)argument).Customer.Id);
            Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Vehicle:{0}"</span>, ((RentalAgreement)argument).Vehicle.Id);
        }
        <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (argument.GetType()==<span class="hljs-keyword" style="color:rgb(0,0,255);">typeof</span>(Invoice))
        {
            Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Invoice:{0}"</span>,((Invoice)argument).Id);
        }
    }
}

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">就这个例子来说，这样没问题了，但是对于一个大一点的应用，可能会有几十个甚至几百个不同的类型，如果需求是记录实体Id和信息，那么可以在实体上使用一个公共接口（或基类）。比如，如果<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Invoice</code>和<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">RentalAgreement</code>都实现了<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">ILoggable</code>接口，该接口具有一个方法<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">string LogInfo()</code>,代码可以这样写:</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">
 <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">override</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">OnEntry</span>(<span class="hljs-params">MethodExecutionArgs args</span>) </span>{
            Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"{0}:{1}"</span>,args.Method.Name,DateTime.Now);
            <span class="hljs-keyword" style="color:rgb(0,0,255);">foreach</span> (<span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> argument <span class="hljs-keyword" style="color:rgb(0,0,255);">in</span> args.Arguments)<span class="hljs-comment" style="color:#008000;">//遍历方法的参数</span>
            {
                <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (argument!=<span class="hljs-keyword" style="color:rgb(0,0,255);">null</span>)
                {
                    <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (<span class="hljs-keyword" style="color:rgb(0,0,255);">typeof</span>(ILoggable).IsAssignableFrom(argument.GetType()))
                    {
                        Console.WriteLine((ILoggable)argument.LogInfo());
                    }
                }

            }
        }
</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">现在<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Accure</code>和<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Redeem</code>方法开始收缩了，因为我们将logging功能移到了它自己的类日志切面中去了。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">重构防御性编程</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">下面还是使用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">OnMethodBoundaryAspect</code>基类重构防御性编程，确保没有参数为null，以及所有的int参数不为0或负数：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"> [Serializable]
 <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">DefensiveProgramming</span>:<span class="hljs-title" style="color:rgb(163,21,21);">OnMethodBoundaryAspect</span>
 {
     <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">override</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">OnEntry</span>(<span class="hljs-params">MethodExecutionArgs args</span>) </span>{
         <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> parameters = args.Method.GetParameters();<span class="hljs-comment" style="color:#008000;">//获取形参</span>
         <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> arguments = args.Arguments;<span class="hljs-comment" style="color:#008000;">//获取实参</span>
         <span class="hljs-keyword" style="color:rgb(0,0,255);">for</span> (<span class="hljs-keyword" style="color:rgb(0,0,255);">int</span> i = <span class="hljs-number">0</span>; i &lt; arguments.Count; i++)
         {
             <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (arguments[i]==<span class="hljs-keyword" style="color:rgb(0,0,255);">null</span>)
             {
                 <span class="hljs-keyword" style="color:rgb(0,0,255);">throw</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> ArgumentNullException(parameters[i].Name);
             }
             <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (arguments[i] <span class="hljs-keyword" style="color:rgb(0,0,255);">is</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">int</span>&amp;&amp;(<span class="hljs-keyword" style="color:rgb(0,0,255);">int</span>)arguments[i]&lt;=<span class="hljs-number">0</span>)
             {
                 <span class="hljs-keyword" style="color:rgb(0,0,255);">throw</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> ArgumentException(<span class="hljs-string" style="color:rgb(163,21,21);">"参数非法"</span>,parameters[i].Name);
             }
         }
     }
 }

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">首先检查实参是否为null，之后再判断参数是否是整型，并且是否合法。如果不处理这些事情，非法值会使得程序崩溃，但这里处理之后我们可以看到崩溃的确定原因（ArgumentNullException或ArgumentException 的异常信息）。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">同时，这个类没有直接耦合任何参数类型或服务类，这意味着可以重复使用在多个服务中。</p> 
   <pre class="c#"><code class="hljs cpp" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">[LoggingAspect]
[DefensiveProgramming]
<span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Accrue</span><span class="hljs-params">(RentalAgreement agreement)</span> </span>{
    <span class="hljs-comment" style="color:#008000;">//...略</span>
}

[LoggingAspect]
[DefensiveProgramming]
<span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Redeem</span><span class="hljs-params">(Invoice invoice, <span class="hljs-keyword" style="color:rgb(0,0,255);">int</span> numberOfDays)</span> </span>{
    <span class="hljs-comment" style="color:#008000;">//...</span>
}

</code></pre> 
   <blockquote style="border:2px solid rgb(239,239,239);line-height:1.6;color:rgb(51,51,51);font-size:15px;font-family:'Microsoft Yahei';clear:both;background:rgb(223,255,163) url(&quot;//files.cnblogs.com/files/farb/o_title.gif&quot;) no-repeat 9px 50%;"> 
    <p>防御性编程切面<br> 这里写的防御性编程切面可能不是编写通用切面的最佳实践，在C#中，我们可以直接在每个参数上放置特性，因此可以这样替代前面那种方法。实际上，Nuget和github上有专门的类库<strong><a href="https://github.com/Fody/NullGuard" rel="nofollow" style="color:rgb(65,131,196);text-decoration:none;">NullGuard</a></strong>，一个Fody版本的，一个PostSharp版本的，大家可以去学习一下。</p> 
   </blockquote> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">到这里，需要说明一下了，.Net中的特性没有一定的顺序，也就是说，上面的代码里，<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">[LoggingAspect]</code>特性在<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">[DefensiveProgramming]</code>的上面，不是意味着<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">[LoggingAspect]</code>优先应用，两者的影响和顺序无关，怎么放都可以。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">有了防御性编程切面之后，服务代码又简化了，代码可读性又提高了，下一步来重构事务管理代码。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">为事务和重试创建切面</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">要重构事务管理代码，这次不使用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">OnMethodBoundaryAspect</code>,而是使用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">MethodInterceptionAspect</code>，它不是在方法的边界插入代码，而是会拦截任何该方法的调用。拦截切面会在拦截到方法调用时执行切面代码，之后再执行拦截到的方法；而边界切面会在方法执行前后运行切面代码。</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"> [Serializable]
 <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">TransactionManagement</span> : <span class="hljs-title" style="color:rgb(163,21,21);">MethodInterceptionAspect</span>
 {
     <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">override</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">OnInvoke</span>(<span class="hljs-params">MethodInterceptionArgs args</span>) </span>{
         <span class="hljs-keyword" style="color:rgb(0,0,255);">using</span> (<span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> ts = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> TransactionScope())
         {
             <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> retries = <span class="hljs-number">3</span>;<span class="hljs-comment" style="color:#008000;">//重试3次</span>
             <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> succeeded = <span class="hljs-keyword" style="color:rgb(0,0,255);">false</span>;
             <span class="hljs-keyword" style="color:rgb(0,0,255);">while</span> (!succeeded)
             {
                 <span class="hljs-keyword" style="color:rgb(0,0,255);">try</span>
                 {
                     args.Proceed();<span class="hljs-comment" style="color:#008000;">//继续执行拦截的方法</span>
                     ts.Complete();<span class="hljs-comment" style="color:#008000;">//事务完成</span>
                     succeeded = <span class="hljs-keyword" style="color:rgb(0,0,255);">true</span>;
                 }

                 <span class="hljs-keyword" style="color:rgb(0,0,255);">catch</span> (Exception ex)
                 {
                     <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (retries &gt;= <span class="hljs-number">0</span>)
                         retries--;
                     <span class="hljs-keyword" style="color:rgb(0,0,255);">else</span>
                         <span class="hljs-keyword" style="color:rgb(0,0,255);">throw</span> ex;
                 }
             }
         }
     }
 }

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">这个切面例子的代码和业务逻辑中的代码基本一样，除了使用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">args.Proceed()</code>方法替换了业务逻辑代码。<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Proceed()</code>方法意思就是继续执行拦截到的方法。通过上面的代码，我们的代码又简化了，下面记得给服务方法添加特性,并将业务代码从事务中移除：</p> 
   <pre class="c#"><code class="hljs cpp" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">
 [LoggingAspect]
 [DefensiveProgramming]
 [TransactionManagement]
 <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Accrue</span><span class="hljs-params">(RentalAgreement agreement)</span> </span>{
     <span class="hljs-comment" style="color:#008000;">//...略</span>
 }

 [LoggingAspect]
 [DefensiveProgramming]
 [TransactionManagement]
 <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Redeem</span><span class="hljs-params">(Invoice invoice, <span class="hljs-keyword" style="color:rgb(0,0,255);">int</span> numberOfDays)</span> </span>{
     <span class="hljs-comment" style="color:#008000;">//...</span>
 }
</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">为了说明事务切面能正常工作，可以在<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">OnInvoke</code>内部前后添加<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Console.WriteLine("{0}方法开始/结束：{1}", args.Method.Name,DateTime.Now);</code>，打印出来看一下。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">重构异常处理切面</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">异常处理切面需要使用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">OnMethodBoundaryAspect</code>，或者可以使用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">OnExceptionAspect</code>，无论使用哪一种，样子都是差不多的。</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"> [Serializable]
 <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">MyExceptionAspect</span>:<span class="hljs-title" style="color:rgb(163,21,21);">OnExceptionAspect</span>
 {
     <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">override</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">OnException</span>(<span class="hljs-params">MethodExecutionArgs args</span>) </span>{
         <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (ExceptionHelper.Handle(args.Exception))
         {
            args.FlowBehavior=FlowBehavior.Continue;
         }
     }
 }

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">ExceptionHelper</code>是我自己定义的异常处理静态类，这里出现了一个新玩意<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">FlowBehavior</code>,它指定了当切面执行完之后，接下来怎么办！这里设置了<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Continue</code>,也就是说，如果异常处理完了，程序继续执行，否则，默认的<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">FlowBehavior</code>是&nbsp;<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">RethrowException</code>,这样的话，切面就没效果了，异常又再次抛出来了。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">移除异常处理的代码，加上异常处理切面特性，至此，所有的横切关注点就重构完了。下面完整地看一下成品：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"> [LoggingAspect]
 [DefensiveProgramming]
 [TransactionManagement]
 [MyExceptionAspect]
 <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Accrue</span>(<span class="hljs-params">RentalAgreement agreement</span>) </span>{
     <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> rentalTime = agreement.EndDate.Subtract(agreement.StartDate);
     <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> days = (<span class="hljs-keyword" style="color:rgb(0,0,255);">int</span>) Math.Floor(rentalTime.TotalDays);
     <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> pointsPerDay = <span class="hljs-number">1</span>;
     <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (agreement.Vehicle.Size&gt;=Size.Luxury)
     {
         pointsPerDay = <span class="hljs-number">2</span>;
     }
     <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> totalPoints = days*pointsPerDay;
     _loyaltyDataService.AddPoints(agreement.Customer.Id,totalPoints);
 }


 [LoggingAspect]
 [DefensiveProgramming]
 [TransactionManagement]
 [MyExceptionAspect]
 <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Redeem</span>(<span class="hljs-params">Invoice invoice, <span class="hljs-keyword" style="color:rgb(0,0,255);">int</span> numberOfDays</span>) </span>{
     <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> pointsPerday = <span class="hljs-number">10</span>;
     <span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (invoice.Vehicle.Size&gt;=Size.Luxury)
     {
         pointsPerday = <span class="hljs-number">15</span>;
     }
     <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> totalPoints = numberOfDays*pointsPerday;
     _loyaltyDataService.SubstractPoints(invoice.Customer.Id,totalPoints);
     invoice.Discount = numberOfDays*invoice.CostPerDay;
 }

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">可以看到，这样的代码看着很不错吧？又回到了之前最开始的代码，只有业务逻辑的单一职责状态，所有的横切关注点都放到了它们各自的类中去了。代码非常容易阅读。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">再来看看使用AOP的优点：</p> 
   <ol style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">
    <li style="list-style:decimal;">更改方便。如果更改了方法的方法名或参数名，切面会自动处理。切面不会关心业务逻辑是否发生变化（比如每天积分的变化），业务逻辑也不会关心你是否从<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Console</code>切换到了<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">log4Net或NLog</code>，除非你想使用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">TransactionScope</code>之外的东西处理事务或者需要改变重试次数的最大值。</li> 
    <li style="list-style:decimal;">可以将这些切面重复给每个服务的各个方法使用，而不是不使用AOP时，每次都要复制粘贴相似的代码。</li> 
    <li style="list-style:decimal;">可以在整个类、命名空间或程序集使用多广播切面，而不用在每个方法上这样写。</li> 
   </ol>
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">小结</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">这篇的目的一是演示一下横切关注点可以使你得代码<strong>脏乱差</strong>，常规的OOP和使用好设计模式在许多情况下可以帮助重构代码，但是很多情况还是会让你的代码和横切关注点紧耦合。即使你的代码遵守了SPR和DI，代码也会相互纠缠，错乱或重复。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">二来是说明一下变更的代价是和你的代码多么灵活、可读和模块化是相关的。即使已经重构的很好了，仍能在传统的OOP中中发现一些不容易解耦的横切关注点。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">三是演示一下AOP工具（如PostSharp）如何让你对横切关注点进行解耦。使用AOP重构的版本，所有的横切关注点都有它自己的类，服务类减少到只有业务逻辑和执行业务逻辑。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">本篇只是使用AOP的热身，如果这是你初次接触AOP（不太可能），那么你已经走上了构建更好、更灵活、更容易阅读和维护的软件之路。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><br></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><br></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><br></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><br></p> 
   <p><font color="#494949"><span style="font-size:15px;line-height:25px;">本文转自tkbSimplest博客园博客，原文链接：http://www.cnblogs.com/farb/p/AOPBuildACarRentApp.html，如需转载请自行联系原作者</span></font><br></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
