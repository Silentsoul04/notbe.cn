<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>8天掌握EF的Code First开发系列之动手写第一个Code First应用 « NotBeCN</title>
  <meta name="description" content="             本篇目录        创建控制台项目     根据.Net中的类来创建数据库     简单的CRUD操作     数据库模式更改介绍     本章小结     自我测试       上一篇《8天掌握EF的Code First开发之Entity Framework介绍》，只是大概地从整体...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/12/19/weixin_33849942_90135223.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">8天掌握EF的Code First开发系列之动手写第一个Code First应用</h1>
    <p class="post-meta">Dec 19, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">本篇目录</h2> 
   <ul>
    <li style="list-style:disc;"><font color="#4183c4"><span style="font-size:15px;line-height:25px;"><b>创建控制台项目</b></span></font></li> 
    <li style="list-style:disc;"><font color="#4183c4"><span style="font-size:15px;line-height:25px;"><b>根据.Net中的类来创建数据库</b></span></font></li> 
    <li style="list-style:disc;"><font color="#4183c4"><span style="font-size:15px;line-height:25px;"><b>简单的CRUD操作</b></span></font></li> 
    <li style="list-style:disc;"><font color="#4183c4"><span style="font-size:15px;line-height:25px;"><b>数据库模式更改介绍</b></span></font></li> 
    <li style="list-style:disc;"><font color="#4183c4"><span style="font-size:15px;line-height:25px;"><b>本章小结</b></span></font></li> 
    <li style="list-style:disc;"><font color="#4183c4"><span style="font-size:15px;line-height:25px;"><b>自我测试</b></span></font></li> 
   </ul>
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">上一篇<strong><a href="http://www.cnblogs.com/farb/p/IntroductionToEF.html" rel="nofollow" style="color:rgb(65,131,196);text-decoration:none;">《8天掌握EF的Code First开发之Entity Framework介绍》</a></strong>，只是大概地从整体上了解了一下Entity Framework，纯粹理论，没有一点代码，但是推荐数量飙升。博主因此也感觉到了某些园友们的气息里透漏着些许火药味，确实没有啥干货啊，这个博主承认的，博主也请各位谅解，并听我给你解释解释。</p> 
   <ol style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">
    <li style="list-style:decimal;"> <strong>这是博主对于EF技术的试水篇。</strong>博主毕竟要写EF这个系列的文章，先来探探园友们对EF的感冒程度啊。也算是一种需求分析或者市场调研吧！</li> 
    <li style="list-style:decimal;"> <strong>这是博主对“大家是否喜欢自测功能”的试水</strong>。上一篇博客的最后添加了自我测试，是想看看有多少人喜欢这个功能，同时也是希望在自我测试时能不受正确答案的干扰。</li> 
    <li style="list-style:decimal;">从这篇博客起，我会在您点击查看答案前提供明确的提示！我也在此声明，不想点赞的园友千万不要点击查看答案按钮，否则您会失误点了推荐的！：）</li> 
   </ol>
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">下面我们正式开始今天的正题。本篇的源码：<strong><a href="https://coding.net/u/farb/p/AbpPractice/git/tree/master/EFCodeFirstFor8Days/FirstCodeFirstApp/FirstCodeFirstApp" rel="nofollow" style="color:rgb(65,131,196);text-decoration:none;">点击查看</a></strong>，本人的实验环境是VS 2013 Update 5，windows 10,MSSQL Server 2008。</p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);"> <a name="console"></a>创建控制台项目</h2> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">新建控制台应用项目</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/7de52f10-7341-4d47-8375-f9692641e188.png" alt="图片" style="border:0px;"></p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">安装Entity Framework</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">Nuget包管理器控制台 ：<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Install-Package EntityFramework</code>,也可以通过可视化窗口进行安装，如下</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/e659a566-1f63-443a-8ee5-5ad80d50ede1.png" alt="图片" style="border:0px;"></p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);"> <a name="classToDB"></a>根据.Net中的类来创建数据库</h2> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">上面的步骤之后，我们就可以开始写代码了。在写代码之前，你要始终记得，每个类就是相应的数据表中的一行数据，该类的属性对应的是这行数据的列。为了表示赞助者们对我的支持，我决定用他们的数据进行举例。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/f476d549-1a85-4ecf-9abd-e94841c57b72.png" alt="图片" style="border:0px;"></p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">创建EDM实体数据模型</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">我们现在创建一个捐赠者类Donator：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="hljs-keyword" style="color:rgb(0,0,255);">namespace</span> <span class="hljs-title" style="color:rgb(163,21,21);">FirstCodeFirstApp</span>
{
    <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">Donator</span>
    {
        <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">int</span> DonatorId { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
        <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> Name { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
        <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">decimal</span> Amount { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
        <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> DateTime DonateDate { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
    }
}
</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">我们需要定义和期望的数据库类型相匹配的属性。上面的例子中，.Net中的int类型会映射到SQL Server中的int类型，string类型会映射到所有可能的字符类型，decimal和Datetime也和SQL Server中的一样。大多数时候，我们不需要关心这些细节，我们只需要编写能够表示数据的模型类就行了，然后使用标准的.Net类型定义属性，其他的就让EF自己计算出保存数据所需要的RDBMS类型。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">创建数据库上下文</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">接下来我们创建数据库上下文，它是数据库的抽象。目前，我们只有一张表Donator，因而要给该数据库上下文定义一个属性来代表这张表。再者，一张表中一般肯定不止一条数据行，所以我们必须定义一个集合属性，EF使用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">DbSet</code>来实现这个目的。</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="hljs-keyword" style="color:rgb(0,0,255);">namespace</span> <span class="hljs-title" style="color:rgb(163,21,21);">FirstCodeFirstApp</span>
{
    <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">Context</span>:<span class="hljs-title" style="color:rgb(163,21,21);">DbContext</span>
    {
        <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-title" style="color:rgb(163,21,21);">Context</span>(<span class="hljs-params"></span>) : <span class="hljs-title" style="color:rgb(163,21,21);">base</span>(<span class="hljs-params"><span class="hljs-string" style="color:rgb(163,21,21);">"name=FirstCodeFirstApp"</span></span>) </span>{
        }

        <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> DbSet&lt;Donator&gt; Donators { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
    }
}
</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">在这里，DbContext是所有基于EF的上下文基类，通过它可以访问到数据库中的所有表。上面的代码中调用了父类的构造函数，并且传入了一个键值对，键是name,值是FirstCodeFirstApp，这个键值对是定义在应用程序的配置文件中的，取决于你的应用程序类型，可能是app.config或者web.config。在我们的控制台应用程序中就是app.config。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">在app.config文件的<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">configuration</code>的节点下（不要在第一个节点下，否则报错）添加：</p> 
   <pre class="webconfig"><code class="hljs django" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="xml"> <span class="hljs-tag" style="color:rgb(0,0,255);">&lt;<span class="hljs-name">connectionStrings</span>&gt;</span> <span class="hljs-tag" style="color:rgb(0,0,255);">&lt;<span class="hljs-name">add</span> <span class="hljs-attr" style="color:#FF0000;">name</span>=<span class="hljs-string" style="color:rgb(163,21,21);">"FirstCodeFirstApp"</span> <span class="hljs-attr" style="color:#FF0000;">connectionString</span>=<span class="hljs-string" style="color:rgb(163,21,21);">"Server=.;Database=CodeFirstApp;Integrated Security=SSPI"</span> <span class="hljs-attr" style="color:#FF0000;">providerName</span>=<span class="hljs-string" style="color:rgb(163,21,21);">"System.Data.SqlClient"</span>/&gt;</span> <span class="hljs-tag" style="color:rgb(0,0,255);">&lt;/<span class="hljs-name">connectionStrings</span>&gt;</span> </span></code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">接下来就应该是创建数据库了，创建数据库的方式有两种：</p> 
   <ol style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">
    <li style="list-style:decimal;">在后面的博客中我们会通过数据库迁移来实现数据库的创建，原理就是数据库会在第一次查询，更新或插入操作时创建。</li> 
    <li style="list-style:decimal;">通过EF数据库的API来创建。</li> 
   </ol>
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">这里我们先通过第二种方法来创建数据库。首先我们必须确保数据库中没有和我们现在要创建的数据库同名的数据库存在，否则会提示错误。当然，我们也可以通过EF的API访问数据库来创建数据库。</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="hljs-keyword" style="color:rgb(0,0,255);">namespace</span> <span class="hljs-title" style="color:rgb(163,21,21);">FirstCodeFirstApp</span>
{
    <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">Program</span>
    {
        <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">static</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Main</span>(<span class="hljs-params"><span class="hljs-keyword" style="color:rgb(0,0,255);">string</span>[] args</span>) </span>{
            <span class="hljs-keyword" style="color:rgb(0,0,255);">using</span> (<span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> context=<span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> Context())
            {
                context.Database.CreateIfNotExists();<span class="hljs-comment" style="color:#008000;">//如果数据库不存在时则创建</span>
            }
            Console.Write(<span class="hljs-string" style="color:rgb(163,21,21);">"DB has Created!"</span>);<span class="hljs-comment" style="color:#008000;">//提示DB创建成功</span>
            Console.Read();
        }
    }
}

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">最后，我们只需要确保我们的连接字符串没有问题。现在，运行程序，打开SSMS（当然也可以在VS的服务器资源管理器查看）进行确认即可。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/cf7a3df6-9517-436c-89ce-9b9d48c51657.png" alt="图片" style="border:0px;"><br><img src="https://dn-coding-net-production-pp.qbox.me/843a9b21-1e94-4b94-b24d-48b0d314e5a6.png" alt="图片" style="border:0px;"></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">可以很清楚地看到，数据表名是自定义数据库上下文的属性，而表中的列是数据模型的属性。此外，注意一下列的类型。EF默认将<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">DonatorId</code>作为了主键，string类型的Name在数据库中的类型是<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">nvarchar(max)</code>，这些都是在使用EF时必须注意的命名规范（或者约定）。</p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);"> <a name="crud"></a>简单的CRUD操作</h2> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">首先，大脑中时刻要有这张图，这张图也是很重要的概念：</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/5132f836-3413-4d02-8e02-00cf9fbe9bec.png" alt="图片" style="border:0px;"></p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">创建记录——Create</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">你可以这样认为，将对象添加到集合中就相当于将数据行插入到数据库的相应的表中。我们使用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">DbSet</code>的<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Add</code>方法来实现新数据的添加，而<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">DbContext</code>类的<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">SaveChanges</code>方法会将未处理的更改提交到数据库，这是通过检测上下文中所有的对象的状态来完成的。所有的对象都驻留在上下文类的<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">DbSet</code>属性中，比如，我们的例子只有一个Donators属性，那么所有的捐赠人的数据都会存储到这个泛型集合属性中。数据库上下文会跟踪<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">DbSet</code>属性中的所有对象的状态，这些状态有这么几种：<strong>Deleted，Added，Modified和Unchanged</strong>。如果你想在一个表中插入多行数据，那么只需要添加该表对应的类的多个对象的实例即可，然后就使用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">SaveChanges</code>方法将更改提交到数据库，该方法是以单事务执行的。最终，所有的数据库更改都会以单个工作单元持久化。既然是事务的，那么这就允许将批量相关的更改作为单个操作提交，这样就保证了事务一致性和数据完整性。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">修改Main方法如下：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">Program</span>
    {
        <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">static</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Main</span>(<span class="hljs-params"><span class="hljs-keyword" style="color:rgb(0,0,255);">string</span>[] args</span>) </span>{
            <span class="hljs-keyword" style="color:rgb(0,0,255);">using</span> (<span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> context = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> Context())
            {
                context.Database.CreateIfNotExists();<span class="hljs-comment" style="color:#008000;">//如果数据库不存在时则创建</span>
                <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> donators = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> List&lt;Donator&gt;
                {
                    <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> Donator
                    {
                      Name   = <span class="hljs-string" style="color:rgb(163,21,21);">"陈志康"</span>,
                      Amount = <span class="hljs-number">50</span>,
                      DonateDate = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> DateTime(<span class="hljs-number">2016</span>, <span class="hljs-number">4</span>, <span class="hljs-number">7</span>)
                    },
                    <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> Donator
                    {
                        Name = <span class="hljs-string" style="color:rgb(163,21,21);">"海风"</span>,
                        Amount = <span class="hljs-number">5</span>,
                        DonateDate = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> DateTime(<span class="hljs-number">2016</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>)
                    },
                    <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> Donator
                    {
                        Name = <span class="hljs-string" style="color:rgb(163,21,21);">"醉千秋"</span>,
                        Amount = <span class="hljs-number">18.8</span>m,
                        DonateDate = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> DateTime(<span class="hljs-number">2016</span>, <span class="hljs-number">4</span>, <span class="hljs-number">15</span>)
                    }
                };

                context.Donators.AddRange(donators);
                context.SaveChanges();
            }
            <span class="hljs-comment" style="color:#008000;">// Console.Write("DB has Created!");//提示DB创建成功</span>
             Console.Write(<span class="hljs-string" style="color:rgb(163,21,21);">"Creation Finished!"</span>);<span class="hljs-comment" style="color:#008000;">//提示创建完成</span>
            Console.Read();
        }
    }
</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">这里需要注意两点：</p> 
   <ol style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">
    <li style="list-style:decimal;">不需要给DonatorId属性赋值，因为它对应到SQL Server表中的主键列，它的值是自动生成的，当<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">SaveChanges</code>执行之后，打个断点就能看到返回的DonatorId已经有值了。</li> 
    <li style="list-style:decimal;">Context的实例用了using语句包装起来，这是因为DbContext实现了IDisposable接口。Dbcontext还包含了DbConnection的实例，该实例指向了具有特定连接字符串的数据库。在EF中合适地释放数据库连接和ADO.NET中同等重要。</li> 
   </ol>
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">执行结果与在VS中查看数据是否生成：</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/9054aaff-9910-481d-ba2e-07f2b576e1ea.png" alt="图片" style="border:0px;"></p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">查询记录——Retrieve</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">查询时也是直接通过DbSet进行查询的。</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"> <span class="hljs-meta" style="color:rgb(43,145,175);">#<span class="hljs-meta-keyword">region</span> 2.0 查询记录</span>

 <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> donators = context.Donators;
 Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"Id\t\t姓名\t\t金额\t\t赞助日期"</span>);
 <span class="hljs-keyword" style="color:rgb(0,0,255);">foreach</span> (<span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> donator <span class="hljs-keyword" style="color:rgb(0,0,255);">in</span> donators)
 {
     Console.WriteLine(<span class="hljs-string" style="color:rgb(163,21,21);">"{0}\t\t{1}\t\t{2}\t\t{3}"</span>, donator.DonatorId,donator.Name, donator.Amount, donator.DonateDate.ToShortDateString());
 }
 <span class="hljs-meta" style="color:rgb(43,145,175);">#<span class="hljs-meta-keyword">endregion</span></span>

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">如果像下面那样打一个断点，你会看到一个<strong>结果视图</strong>，点击那个类似刷新的图标会看到查询的结果，这个东西道出了EF中很重要的一个概念：&nbsp;<strong>延迟查询</strong>。但是此时还没有真正查询数据库，只有当LINQ的查询结果被访问或者枚举时才会将查询命令发送到数据库。EF是基于Dbset实现的IQueryable接口来处理延迟查询的。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/dacb41a2-ae09-4508-b919-99036c93c73a.png" alt="图片" style="border:0px;"></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">最后，我使用了一个foreach循环将结果枚举出来，这样就执行了SQL，结果如下：</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/5acc5ced-8981-422d-9a8e-f86ec032cc81.png" alt="图片" style="border:0px;"></p> 
   <blockquote style="border:2px solid rgb(239,239,239);line-height:1.6;color:rgb(51,51,51);font-size:15px;font-family:'Microsoft Yahei';clear:both;background:rgb(223,255,163) url(&quot;//files.cnblogs.com/files/farb/o_title.gif&quot;) no-repeat 9px 50%;"> 
    <h4 style="font-size:14px;color:rgb(205,73,0);border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(205,73,0);">物质化：Materialization</h4> 
    <p>从数据库中读取数据，通过<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">DbDataReader</code>转成.Net对象的过程。</p> 
   </blockquote> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">更新记录——Update</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">在SQL中，更新需要使用Update命令。而在EF中，我们要找到DbSet集合中要更新的对象，然后更改其属性，最后调用SaveChanges方法即可。<br> 下面我将赞助者“醉千秋”改为“醉、千秋”（因为他的博客园名字的确是这样的）。</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="hljs-meta" style="color:rgb(43,145,175);">#<span class="hljs-meta-keyword">region</span> 3.0 更新记录</span>

<span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> donators = context.Donators;
<span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (donators.Any())
{
    <span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> toBeUpdatedDonator = donators.First(d =&gt; d.Name == <span class="hljs-string" style="color:rgb(163,21,21);">"醉千秋"</span>);
    toBeUpdatedDonator.Name = <span class="hljs-string" style="color:rgb(163,21,21);">"醉、千秋"</span>;
    context.SaveChanges();
}

<span class="hljs-meta" style="color:rgb(43,145,175);">#<span class="hljs-meta-keyword">endregion</span></span>

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">这里我们使用了<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Any()</code>扩展方法来判断序列中是否有元素，然后使用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">First()</code>扩展方法来找到<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Name == "醉千秋"</code>的元素，最后给目标对象的Name属性赋予新值，之后调用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">SaveChanges</code>方法。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">如果我们打开SQL Server Profiler，我们会看到下面的记录：</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/017f23c0-7dd3-4e61-a33d-a6108aed97f1.png" alt="图片" style="border:0px;"></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/8ad4d5b2-b6d6-454c-a37f-7bf285e48aea.png" alt="图片" style="border:0px;"></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">第一条记录是查询语句，找到对象；第二条是更新语句，更改属性。最后检测数据库操作成功的结果：</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/31c28e4e-efd2-4f1b-8545-4f15e42c64d7.png" alt="图片" style="border:0px;"></p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;">删除记录——Delete</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">接下来要删除记录，我把剩下的打赏者数据全部放到数据库，然后再在最后加入一条测试数据，如下：</p> 
   <div class="sourceCode" style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">
    <pre><code class="language-sql"><code class="sourceCode sql hljs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);background:rgb(255,255,255);"><span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">INSERT</span></span> dbo.Donators <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">VALUES</span></span> ( <span class="hljs-keyword" style="color:rgb(0,0,255);">N</span><span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'雪茄'</span></span>, <span class="dv">10</span>, <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'2016-04-08'</span></span>) <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">INSERT</span></span> dbo.Donators <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">VALUES</span></span> ( <span class="hljs-keyword" style="color:rgb(0,0,255);">N</span><span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'王小乙'</span></span>, <span class="dv">10</span>, <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'2016-04-09'</span></span>) <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">INSERT</span></span> dbo.Donators <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">VALUES</span></span> ( <span class="hljs-keyword" style="color:rgb(0,0,255);">N</span><span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'键盘里的鼠标'</span></span>, <span class="dv">12</span>, <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'2016-04-13'</span></span>) <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">INSERT</span></span> dbo.Donators <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">VALUES</span></span> ( <span class="hljs-keyword" style="color:rgb(0,0,255);">N</span><span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'smallpig'</span></span>, <span class="dv">10</span>, <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'2016-04-13'</span></span>) <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">INSERT</span></span> dbo.Donators <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">VALUES</span></span> ( <span class="hljs-keyword" style="color:rgb(0,0,255);">N</span><span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'Darren'</span></span>, <span class="dv">5</span>, <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'2016-04-15'</span></span>) <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">INSERT</span></span> dbo.Donators <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">VALUES</span></span> ( <span class="hljs-keyword" style="color:rgb(0,0,255);">N</span><span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'jeffrey'</span></span>, <span class="dv">10</span>, <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'2016-04-15'</span></span>) <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">INSERT</span></span> dbo.Donators <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">VALUES</span></span> ( <span class="hljs-keyword" style="color:rgb(0,0,255);">N</span><span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'危杨益'</span></span>, <span class="fl">6.66</span>, <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'2016-04-15'</span></span>) <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">INSERT</span></span> dbo.Donators <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">VALUES</span></span> ( <span class="hljs-keyword" style="color:rgb(0,0,255);">N</span><span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'Mr.Lan'</span></span>, <span class="dv">10</span>, <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'2016-04-15'</span></span>) <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">INSERT</span></span> dbo.Donators <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">VALUES</span></span> ( <span class="hljs-keyword" style="color:rgb(0,0,255);">N</span><span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'周旭龙'</span></span>, <span class="dv">5</span>, <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'2016-04-15'</span></span>) <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">INSERT</span></span> dbo.Donators <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">VALUES</span></span> ( <span class="hljs-keyword" style="color:rgb(0,0,255);">N</span><span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'403'</span></span>, <span class="fl">10.24</span>, <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'2016-04-15'</span></span>) <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">INSERT</span></span> dbo.Donators <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">VALUES</span></span> ( <span class="hljs-keyword" style="color:rgb(0,0,255);">N</span><span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'cuibty'</span></span>, <span class="fl">8.88</span>, <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'2016-04-15'</span></span>) <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">INSERT</span></span> dbo.Donators <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">VALUES</span></span> ( <span class="hljs-keyword" style="color:rgb(0,0,255);">N</span><span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'dennylo'</span></span>, <span class="fl">10.24</span>, <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'2016-04-17'</span></span>) <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">INSERT</span></span> dbo.Donators <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">VALUES</span></span> ( <span class="hljs-keyword" style="color:rgb(0,0,255);">N</span><span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'lee'</span></span>, <span class="dv">5</span>, <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'2016-04-18'</span></span>) <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">INSERT</span></span> dbo.Donators <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">VALUES</span></span> ( <span class="hljs-keyword" style="color:rgb(0,0,255);">N</span><span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'利平'</span></span>, <span class="fl">18.8</span>, <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'2016-04-18'</span></span>) <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">INSERT</span></span> dbo.Donators <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">VALUES</span></span> ( <span class="hljs-keyword" style="color:rgb(0,0,255);">N</span><span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'听海船说'</span></span>, <span class="dv">20</span>, <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'2016-04-19'</span></span>) <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">INSERT</span></span> dbo.Donators <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">VALUES</span></span> ( <span class="hljs-keyword" style="color:rgb(0,0,255);">N</span><span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'喝前摇一摇'</span></span>, <span class="dv">5</span>, <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'2016-04-19'</span></span>) <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">INSERT</span></span> dbo.Donators <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">VALUES</span></span> ( <span class="hljs-keyword" style="color:rgb(0,0,255);">N</span><span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'黄大仙'</span></span>, <span class="dv">50</span>, <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'2016-04-19'</span></span>) <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">INSERT</span></span> dbo.Donators <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">VALUES</span></span> ( <span class="hljs-keyword" style="color:rgb(0,0,255);">N</span><span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'夜未眠'</span></span>, <span class="dv">10</span>, <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'2016-04-19'</span></span>) <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">INSERT</span></span> dbo.Donators <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">VALUES</span></span> ( <span class="hljs-keyword" style="color:rgb(0,0,255);">N</span><span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'A.L'</span></span>, <span class="fl">8.88</span>, <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'2016-04-19'</span></span>) <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">INSERT</span></span> dbo.Donators <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">VALUES</span></span> ( <span class="hljs-keyword" style="color:rgb(0,0,255);">N</span><span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'transient'</span></span>, <span class="dv">5</span>, <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'2016-04-19'</span></span>) <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">INSERT</span></span> dbo.Donators <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">VALUES</span></span> ( <span class="hljs-keyword" style="color:rgb(0,0,255);">N</span><span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'晓东'</span></span>, <span class="fl">6.66</span>, <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'2016-04-20'</span></span>) <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">INSERT</span></span> dbo.Donators <span class="kw"><span class="hljs-keyword" style="color:rgb(0,0,255);">VALUES</span></span> ( <span class="hljs-keyword" style="color:rgb(0,0,255);">N</span><span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'待打赏'</span></span>, <span class="dv">10</span>, <span class="st"><span class="hljs-string" style="color:rgb(163,21,21);">'2016-04-20'</span></span>)</code></code></pre>
   </div> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">要删除一条数据，就先要找到这条数据，删除代码如下：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="hljs-meta" style="color:rgb(43,145,175);">#<span class="hljs-meta-keyword">region</span> 4.0 删除记录</span>

<span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> toBeDeletedDonator = context.Donators.Single(d =&gt; d.Name == <span class="hljs-string" style="color:rgb(163,21,21);">"待打赏"</span>);<span class="hljs-comment" style="color:#008000;">//根据Name找到要删除的测试数据</span>
<span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (toBeDeletedDonator!=<span class="hljs-keyword" style="color:rgb(0,0,255);">null</span>)
{
    context.Donators.Remove(toBeDeletedDonator);<span class="hljs-comment" style="color:#008000;">//如果满足条件，就将该对象使用Remove方法标记为Deleted</span>
    context.SaveChanges();<span class="hljs-comment" style="color:#008000;">//最后持久化到数据库</span>
}

<span class="hljs-meta" style="color:rgb(43,145,175);">#<span class="hljs-meta-keyword">endregion</span></span>

</code></pre> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);"> <a name="schema"></a>数据库模式更改介绍</h2> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">如果你修改了Donator类或者又添加了新的DbSet属性（即添加了新表），在操作的过程中你可能会遇到一些异常。现在，我想再添加一张表PayWays，用来存储打赏者的打赏方式，比如微信，支付宝，QQ红包等。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">先定义两个字段，以后可能会增加字段和Donator表关联：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="hljs-keyword" style="color:rgb(0,0,255);">namespace</span> <span class="hljs-title" style="color:rgb(163,21,21);">FirstCodeFirstApp</span>
{
    <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">PayWay</span>
    {
        <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">int</span> Id { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
        <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> Name { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
    }
}
</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">在<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Context</code>类中添加这句代码<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">public DbSet&lt;PayWay&gt; PayWays { get; set; }</code>。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">我们这里更加明显地可以看到，数据库上下文代表了整个数据库，它包含多个表，每张表都成为了<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Context</code>类的一个属性。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">现在，如果我们运行程序，并循环枚举支付方式会出现什么情况呢？<br> 啊哦！抛异常了：<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">The model backing the 'Context' context has changed since the database was created. Consider using Code First Migrations to update the database (http://go.microsoft.com/fwlink/?LinkId=238269).</code></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">意思是：自从数据库创建以来，模型背后的数据库上下文‘Context’已经发生了变化，也就是当初的数据库和现在的上下文对不上了。呵呵！当然对不上了，数据库上下文被我更改了，而数据库没改啊！</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/45c97755-0ff5-4ae4-98f9-e42f68c74130.png" alt="图片" style="border:0px;"></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">在后面我会介绍<strong>数据库迁移和对已存在的数据库进行迁移</strong>，但是我们想在也要解决这个当前问题。这就引入了<strong>初始化器（Initializer）</strong>的概念。初始化器会在首次实例化过程期间或者EF首次访问数据库时运行。EF中需要关心的初始化器有三种：</p> 
   <ul style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">
    <li style="list-style:disc;"><code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">CreateDatabaseIfNotExists&lt;TContext&gt;</code></li> 
    <li style="list-style:disc;"><code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">DropCreateDatabaseIfModelChanges&lt;TContext&gt;</code></li> 
    <li style="list-style:disc;"><code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">DropCreateDatabaseAlways&lt;TContext&gt;</code></li> 
   </ul>
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">这两种初始化器看其名字都很好理解，<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">CreateDatabaseIfNotExists&lt;TContext&gt;</code>指如果数据库不存在则创建，<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">DropCreateDatabaseIfModelChanges&lt;TContext&gt;</code>指如果模型改变了（包括模型类的更改以及上下文中集合属性的添加和移除）就销毁之前的数据库再创建数据库，<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">DropCreateDatabaseAlways&lt;TContext&gt;</code>总是销毁再重新创建数据库，如果没有指定的话默认使用第一个初始化器。<br> 我们使用第二个来创建初始化器：</p> 
   <pre class="c#"><code class="hljs ruby" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">namespace FirstCodeFirstApp
{
    public <span class="hljs-class"><span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">Initializer</span>:<span class="hljs-title" style="color:rgb(163,21,21);">DropCreateDatabaseIfModelChanges</span>&lt;Context&gt;</span>
    {

    }
}
</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">要使用该初始化器，我们应该在实例化数据库上下文之前就要让EF知道。我们可以使用EF的API中<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Database</code>类的<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">SetInitializer</code>静态方法。在我们的控制台应用中，我们应该将它放在Main方法的第一行：</p> 
   <pre class="c#"><code class="hljs cpp" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">static</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Main</span><span class="hljs-params">(<span class="hljs-built_in" style="color:rgb(0,0,255);">string</span>[] args)</span> </span>{
     Database.SetInitializer(<span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> Initializer());
    <span class="hljs-comment" style="color:#008000;">//more code</span>
}
</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">如果我们现在运行程序，则不会抛异常了，而且数据库结构也发生变化了。</p> 
   <blockquote style="border:2px solid rgb(239,239,239);line-height:1.6;color:rgb(51,51,51);font-size:15px;font-family:'Microsoft Yahei';clear:both;background:rgb(223,255,163) url(&quot;//files.cnblogs.com/files/farb/o_title.gif&quot;) no-repeat 9px 50%;"> 
    <p>如果数据库在其他的应用程序中是打开的，如SQL Server Management Studio,那么会抛出一个不同的异常，会通知你EF无法获得一个独占的锁定以销毁数据库。此时，只要关闭其他的应用程序就可以了。</p> 
   </blockquote> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">未经处理的异常: System.Data.SqlClient.SqlException: 无法删除数据库 "CodeFirstApp"，因为该数据库当前正在使用。</code></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/23798255-a021-4704-85ce-8d74dc7f4a5d.png" alt="图片" style="border:0px;"></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">需要注意的是，因为上面的初始化器会销毁之前的数据库，因此之前累积的所有数据也都丢失了。很显然，这种用法不适合生产环境，但是我们学习EF或者项目早期是很方便的。另外一个有趣的功能是，初始化器允许我们在目标数据库创建之后运行其他代码，可以通过重写<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Seed</code>方法即可。该方法需要一个数据库上下文的实例参数：</p> 
   <pre class="c#"><code class="hljs cpp" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> Initializer:DropCreateDatabaseIfModelChanges&lt;Context&gt;
{
    <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">protected</span> override <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Seed</span><span class="hljs-params">(Context context)</span> </span>{
        context.PayWays.AddRange(<span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> List&lt;PayWay&gt;
        {
            <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> PayWay{Name = <span class="hljs-string" style="color:rgb(163,21,21);">"支付宝"</span>},
            <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> PayWay{Name = <span class="hljs-string" style="color:rgb(163,21,21);">"微信"</span>},
            <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> PayWay{Name = <span class="hljs-string" style="color:rgb(163,21,21);">"QQ红包"</span>}
        });
    }
}

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">可以看到，在<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Seed</code>方法中，我们不需要调用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">SaveChanges</code>方法。此外，要更新生产数据库，我们可以使用EF Migrations。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/c848aa06-8862-4642-a7e1-b4bf46fe5a69.png" alt="图片" style="border:0px;"></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">如上图，Donators表中的数据都销毁了，而Seed方法给PayWays表中添加了数据。</p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);"> <a name="summary"></a>本章小结</h2> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">这篇博客中，我们创建了第一个基于EF Code First的控制台应用程序。我们使用Nuget添加了EF的引用。然后我们确定要将赞助楼主的数据存储在数据库中，然后创建了一个Donator类映射到数据库中的Donators表。然后创建了数据库抽象Context类，它继承自DbContext，并在它的构造函数中指定了想要的连接字符串，同时把该连接字符串添加到应用的配置文件中。然后，我们给数据库上下文添加了一个属性Donators,它是Donator的集合，即DbSet。之后，让程序跑了起来。然后我们发现数据库中产生了和该属性同名的数据表。数据库的创建过程使用了很多约定，包括表名和主键的确定。</p> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);"> <a name="selftest"></a>自我测试</h2> 
   <ol style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">
    <li style="list-style:decimal;">Dbcontext集合属性的内部中的哪个基类可以用来表示数据库中的一张表？ 
     <ol>
      <li style="list-style:decimal;">List《T》</li> 
      <li style="list-style:decimal;">DbSet《T》</li> 
      <li style="list-style:decimal;">ICollection《T》</li> 
     </ol></li> 
    <li style="list-style:decimal;">使用DbContext之后不必调用Dispose方法，对吗？</li> 
    <li style="list-style:decimal;">EF中哪一个方法可以使用主键定位到数据库中的一行？ 
     <ol>
      <li style="list-style:decimal;">Find</li> 
      <li style="list-style:decimal;">Locate</li> 
      <li style="list-style:decimal;">Define</li> 
     </ol></li> 
    <li style="list-style:decimal;">在找到一个记录时，你可以使用DbSet的哪一个方法来删除它？ 
     <ol>
      <li style="list-style:decimal;">Delete</li> 
      <li style="list-style:decimal;">Remove</li> 
      <li style="list-style:decimal;">Erase</li> 
     </ol></li> 
    <li style="list-style:decimal;">在EF中，如何轻松地更新一个人的名字？ 
     <ol>
      <li style="list-style:decimal;">执行SQL命令</li> 
      <li style="list-style:decimal;">获得相应的对象，设置Name属性，调用SaveChanges</li> 
      <li style="list-style:decimal;">其他</li> 
     </ol></li> 
    <li style="list-style:decimal;">你给已经映射到数据库中的模型类添加了属性，如果你将数据库初始化器设置为null，然后运行程序会发生什么？
     <ol>
      <li style="list-style:decimal;">抛异常</li> 
      <li style="list-style:decimal;">数据库会更新到匹配的新模式，但是数据丢失了</li> 
     </ol></li> 
   </ol>
   <div>
    <font color="#494949"><span style="font-size:15px;line-height:25px;"><br></span></font>
   </div> 
   <div>
    <font color="#494949"><span style="font-size:15px;line-height:25px;"><br></span></font>
   </div> 
   <div>
    <font color="#494949"><span style="font-size:15px;line-height:25px;"><br></span></font>
   </div> 
   <div>
    <font color="#494949"><span style="font-size:15px;line-height:25px;"><br></span></font>
   </div> 
   <div>
    <font color="#494949"><span style="font-size:15px;line-height:25px;"><br></span></font>
   </div> 
   <div>
    <font color="#494949"><span style="font-size:15px;line-height:25px;">本文转自tkbSimplest博客园博客，原文链接：http://www.cnblogs.com/farb/p/FirstCodeFirstApp.html，如需转载请自行联系原作者</span></font>
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
