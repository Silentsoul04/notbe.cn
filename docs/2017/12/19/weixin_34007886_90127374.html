<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Code First开发系列之数据库迁移 « NotBeCN</title>
  <meta name="description" content="             本篇目录              开启并运行迁移     使用迁移API     应用迁移     给已存在的数据库添加迁移     EF的其他功能     本章小结     自我测试          本系列的源码本人已托管于Coding上：点击查看，想要注册Coding的可以点击该...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/12/19/weixin_34007886_90127374.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">Code First开发系列之数据库迁移</h1>
    <p class="post-meta">Dec 19, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <h2 style="font-size:21px;line-height:1.5;color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;background:rgb(111,168,51);">本篇目录</h2> 
   <ul>
    <li style="list-style:disc;"> </li> 
    <li style="list-style:disc;"><font color="#4183c4"><span style="font-size:15px;line-height:25px;"><b>开启并运行迁移</b></span></font></li> 
    <li style="list-style:disc;"><font color="#4183c4"><span style="font-size:15px;line-height:25px;"><b>使用迁移API</b></span></font></li> 
    <li style="list-style:disc;"><font color="#4183c4"><span style="font-size:15px;line-height:25px;"><b>应用迁移</b></span></font></li> 
    <li style="list-style:disc;"><font color="#4183c4"><span style="font-size:15px;line-height:25px;"><b>给已存在的数据库添加迁移</b></span></font></li> 
    <li style="list-style:disc;"><font color="#4183c4"><span style="font-size:15px;line-height:25px;"><b>EF的其他功能</b></span></font></li> 
    <li style="list-style:disc;"><font color="#4183c4"><span style="font-size:15px;line-height:25px;"><b>本章小结</b></span></font></li> 
    <li style="list-style:disc;"><font color="#4183c4"><span style="font-size:15px;line-height:25px;"><b>自我测试</b></span></font></li> 
   </ul>
   <hr style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">
   <p><font color="#494949"><span style="font-size:15px;line-height:25px;">本系列的源码本人已托管于Coding上：点击查看，想要注册Coding的可以点击该连接注册。</span></font></p> 
   <p><font color="#494949"><span style="font-size:15px;line-height:25px;">先附上codeplex上EF的源码：entityframework.codeplex.com，此外，本人的实验环境是VS 2013 Update 5，windows 10,MSSQL Server 2008/2012。</span></font></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">这一篇，我们会学习使用EF的迁移API来记录结构型数据库的改变。之前，我们都是使用的数据库初始化器销毁然后重新创建数据库来处理这些改变。现在，我们使用EF的迁移API没有数据损失地完成同样的最终结果。我们也会讨论对一个已存在的数据库集成EF的过程，而不是只允许EF从头开始创建数据库。最后也会介绍一些其他的功能。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">本篇会覆盖以下知识点：</p> 
   <ol style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">
    <li style="list-style:decimal;">在使用了EF的项目上开启数据库迁移</li> 
    <li style="list-style:decimal;">使用自动迁移</li> 
    <li style="list-style:decimal;">创建显式的迁移</li> 
    <li style="list-style:decimal;">添加数据库工件，例如索引</li> 
    <li style="list-style:decimal;">对已存在的数据库添加迁移</li> 
    <li style="list-style:decimal;">使用EF的其他功能（前面的章节没有介绍的）</li> 
   </ol>
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;"> <a name="enable" style="color:rgb(224,130,131);"></a>开启并运行迁移</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">EF是一个ORM工具，因此它使用数据库工作，我们已经看到了目前面临了这么一个挑战，那就是保持RDBMS和EF实体类同步。之前，我们都是使用一个初始化器来销毁并重建数据库以使新的结构匹配上下文和实体。显然，我们不能在生产环境中这样做。因此，我们有两种选择：第一种是我们可以挑选其他工具（如SQL Server的SSDT）来单独维护和升级数据库；第二种选择就是我们这篇要说的，当数据库结构发生改变时，使用EF本身来更新数据库。要使用这项技术，我们必须在项目上启用迁移（migration）。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">先前的例子，我们都是为整个应用程序和EF的实体类使用了单独一个项目。这在真实的解决方案中没有意义，很有可能我们要将EF的对象分离成它们自己的一个项目，这个项目一般是类库类型的。在本篇的例子中，我们就会这么做了。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">现在就开始动手了，按照之前做的例子的步骤创建一个类库项目，取名<strong>“Data”</strong>，然后添加EF的Nuget包的引用，其次写实体类和上下文类。最后，将该类库项目的引用添加到应用程序的主项目中（Console项目）。项目结构如下，代码就不贴了，大家可看源码。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/46653c85-875d-42b4-a128-47b9f4b754eb.png" alt="图片" style="border:0px;"></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">完成上面的步骤之后，下一步就是为<strong>Data</strong>项目开启迁移了。打开Nuget包管理控制台窗口，默认项目选择刚才创建的项目Data，然后在窗口中输入<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Enable-Migrations</code>，最后按下Enter键即可：</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/cb58f0b2-45c5-440b-8009-9519189aa1c6.png" alt="图片" style="border:0px;"></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">如果想要获取PowerShell命令的详细帮助信息，比如<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Enable-Migration</code>，只需要输入<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Get-Help Enable-Migrations</code>，其他命令依次类推。我们会找到参数信息，有些参数会将迁移指向一个特定的项目或连接字符串。在我们的例子中，我们不需要指定任何参数，因为我们在控制台项目的配置文件中添加了目标连接字符串。运行该命令后，我们会看到Data项目中多了一个名叫<strong>Migrations</strong>的文件夹，该文件夹里面有一个类，它指定了迁移配置，通过泛型参数将它连接到我们的数据库上下文类，默认生成的配置类如下所示：</p> 
   <pre class="c#"><code class="hljs cpp" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">internal sealed <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> Configuration : DbMigrationsConfiguration&lt;Data.Context&gt;
    {
        <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-title" style="color:rgb(163,21,21);">Configuration</span><span class="hljs-params">()</span> </span>{
            AutomaticMigrationsEnabled = <span class="hljs-literal" style="color:rgb(163,21,21);">false</span>;
        }

        <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">protected</span> override <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Seed</span><span class="hljs-params">(Data.Context context)</span> </span>{
            <span class="hljs-comment" style="color:#008000;">// This method will be called after migrating to the latest version.</span>

            <span class="hljs-comment" style="color:#008000;">// You can use the DbSet&lt;T&gt;.AddOrUpdate() helper extension method </span>
            <span class="hljs-comment" style="color:#008000;">// to avoid creating duplicate seed data. E.g.</span>
            <span class="hljs-comment" style="color:#008000;">//</span>
            <span class="hljs-comment" style="color:#008000;">// context.People.AddOrUpdate(</span>
            <span class="hljs-comment" style="color:#008000;">// p =&gt; p.FullName,</span>
            <span class="hljs-comment" style="color:#008000;">// new Person { FullName = "Andrew Peters" },</span>
            <span class="hljs-comment" style="color:#008000;">// new Person { FullName = "Brice Lambson" },</span>
            <span class="hljs-comment" style="color:#008000;">// new Person { FullName = "Rowan Miller" }</span>
            <span class="hljs-comment" style="color:#008000;">// );</span>
            <span class="hljs-comment" style="color:#008000;">//</span>
        }
    }
</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">该类也有<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Seed</code>方法，每当迁移应用到数据库时都会调用该方法，这样，开发者就可以执行各种各样的任务，比如插入种子数据。因为该方法会在数据库上运行多次，所以我们需要确保种子数据不重复，因而我们需要在插入数据之前检查一下数据是否已经存在。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">现在我们准备创建数据库了，如果在本地工作，只是创建或者更新本地数据库，那么我们在包管理器控制台中执行<strong>Update-Database</strong>命令，还有，可以使用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Get-Help</code>命令查看可以使用的参数（后面不再啰嗦这个命令）。下面，我们对<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">-script</code>参数感兴趣，该参数很有用，因为它可以生成迁移的SQL脚本，我们可以将该脚本交给DBA或者我们自己运行。当运行<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Update-Database</code>命令时，它会比较实体类、上下文创建的数据库和物理数据库的结构。运行该命令之后：</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/6412ca5d-663f-4bd6-9b37-a85fe6d22f44.png" alt="图片" style="border:0px;"></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">该错误是告诉我们应该启用<strong>自动迁移</strong>生成，就像错误提示的那样，将配置类中的<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">AutomaticMigrationsEnabled = false;</code>设置为true,生成解决方案，再次运行生成脚本的命令。我们会看到生成的脚本会在VS中打开，然后可以通过运行该脚本生成目标数据库。当我们和DBA共事时，他需要复审我们的升级脚本，这个功能就派上用场了。如果我们只是创建本地数据库的话，只需要运行<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Update-Database</code>,无需带任何参数。运行之后，打开数据库，发现已经创建了新的数据库，名为“DatabaseMigrationApp”。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/b4a83bd8-e69f-4266-8812-943314031da2.png" alt="图片" style="border:0px;"></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">生成的脚本如下：</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/c5599495-1dd4-452c-8320-33e2e658fa58.png" alt="图片" style="border:0px;"></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">自动迁移很容易使用，我们只需要更改代码，然后重新运行<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Update-Database</code>将发生的变化传播到SQL Server数据库中。要验证自动迁移没有数据丢失，我们手动在SSMS中添加一条数据，如下图：</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/8c3822c8-f76c-42e8-945d-aae38dfdd762.png" alt="图片" style="border:0px;"></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">现在，我们给Donator添加一个新属性Message（表示打赏者的留言），定义如下：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"> <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">Donator</span>
 {
     <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">int</span> Id { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
     [StringLength(<span class="hljs-number">10</span>)]
     <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> Name { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
     <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">decimal</span> Amount { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
     <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> DateTime DonateDate { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
     <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">int</span> ProvinceId { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
     <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">virtual</span> Province  Province{ <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }

     <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> Message { <span class="hljs-keyword" style="color:rgb(0,0,255);">get</span>; <span class="hljs-keyword" style="color:rgb(0,0,255);">set</span>; }
 }

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">执行<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Update-Database</code>，我们会看到之前手动添加的数据依然保留着，而且<strong>Message</strong>列的值是NULL，这是EF自动处理的默认值，如果数值类型，默认值为0。一般来讲，对于非空列，EF实际上会尝试该类型的默认值。比如，我们要给<strong>Message</strong>属性添加一个限制，即最大长度为50（默认的长度是MAX），然后更新数据库，结果会报错：</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/6e7d4d10-93ed-4e01-8914-8980e18e78f7.png" alt="图片" style="border:0px;"></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">产生这个错误的道理很简单，字符串长度从最大变成50，肯定会造成数据丢失的。如果你知道会造成数据丢失，还要这么做，可以在后面加参数<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">-Force</code>,这个参数会强制更新数据库。或者，我们可以开启数据丢失支持，正如EF暴露的这个设置<strong>Set AutomaticMigrationDataLossAllowed to 'true'</strong>（错误信息中提到的）。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">我们看到，简单的情景推荐使用自动迁移，当迁移变得复杂时，自动迁移就不那么好使了，后面会看到。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;"> <a name="using" style="color:rgb(224,130,131);"></a>使用迁移API</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">假如我还要给Donator实体添加一个非空的创建时间CreationTime属性：<br><code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">public DateTime CreationTime { get; set; }</code><br> 我想要这个新列的默认值为当前插入数据的日期。如果就这样更新数据库的话，会发现该列的值是1900/1/1。很显然，我们并不需要这样的值，因此，这个时候就需要我们切换到<strong>显式迁移</strong>了。一般来说，显式迁移比自动迁移更加灵活，虽然需要写更多的代码，但是对于迁移有了更多控制权，比如迁移名称和回滚过程等等。如果我们混用了自动迁移和显式迁移，就会把自己搞糊涂。比如，必须通过搜索项目来检查列是否通过自动迁移或手动迁移添加了。因此，为了提供一致性和维护目的，我们需要标准化显式迁移，此时，我们应该关闭自动迁移。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">开始显式迁移之前，先要删除刚才SSMS中创建的数据库，然后使用迁移配置类中<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">AutomaticMigrationsEnabled = false;</code>关闭自动迁移。要创建初始化数据库迁移，需要使用新的命令<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Add-Migration</code>，如下所示：</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/3a888f22-508a-4dd1-b323-50b4c73a216a.png" alt="图片" style="border:0px;"></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><em>InitialMigration</em>只是一个迁移名称，可以随便起名字。这条指令会在<strong>Migrations</strong>文件夹中添加一个新类。物理文件会被命名为类似&nbsp;<strong>201606100435228_InitalMigration</strong>的东西，文件名以迁移创建的时间为前缀，便于我们在文件夹中组织迁移。生成的代码如上图所示。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">进一步看一下生成的代码，EF自动使用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">DbMigration</code>基类帮我们实现了自己的迁移，重写了<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Up</code>和<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Down</code>方法。Up方法将数据库结构向前移动，例如，我们这里创建了两张新的表；Down方法帮助我们撤销更改，以防我们发现了软件问题需要回滚到之前的数据库结构。现在使用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Update-Database</code>命令更新数据库，我们会发现数据库中多了两张新表。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">再仔细看的话，会发现多了一张不是我们创建的表<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">__MigrationHistory</code>，如下所示：</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/8fc2990f-4bf7-4c3d-a97d-1cdafddaf3c4.png" alt="图片" style="border:0px;"></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">__MigrationHistory</code>这张表，顾名思义，是记录迁移历史的。可以看到，<em>MigrationId</em>对应于初次迁移的文件名，<em>Model</em>列包含了上下文的哈希值，<em>ContextKey</em>包含了上下文配置类的类名。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">现在回到之前例子，我们要给Donator实体添加<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">CreationTime</code>属性，然后，我们需要给这个新属性添加新的迁移，再次使用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Add-Migration</code>指令，执行指令<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Add-Migration Donator_Add_CreationTime</code>,EF生成的代码行如下：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">partial</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">Donator_Add_CreationTime</span> : <span class="hljs-title" style="color:rgb(163,21,21);">DbMigration</span>
{
    <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">override</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Up</span>(<span class="hljs-params"></span>) </span>{
        AddColumn(<span class="hljs-string" style="color:rgb(163,21,21);">"dbo.Donators"</span>, <span class="hljs-string" style="color:rgb(163,21,21);">"CreationTime"</span>, c =&gt; c.DateTime(nullable: <span class="hljs-keyword" style="color:rgb(0,0,255);">false</span>));
    }
    
    <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">override</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Down</span>(<span class="hljs-params"></span>) </span>{
        DropColumn(<span class="hljs-string" style="color:rgb(163,21,21);">"dbo.Donators"</span>, <span class="hljs-string" style="color:rgb(163,21,21);">"CreationTime"</span>);
    }
}

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">之前我们看到了<em>AddTable</em>方法，现在，又看到了<em>AddColumn</em>方法。该方法需要提供表名和列名以及列类型（由相应的.Net类型指定）。这次我们要添加一个自定义的默认值，迁移支持硬编码默认值和识别为字符串的数据库引擎默认值。要指定硬编码默认值，我们可以使用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">defaultValue</code>参数。下面我们会使用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">defaultValueSql</code>，如下代码：</p> 
   <pre class="c#"><code class="hljs swift" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"> <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">override</span> void <span class="hljs-type" style="color:rgb(163,21,21);">Up</span>()
 {
     <span class="hljs-type" style="color:rgb(163,21,21);">AddColumn</span>(<span class="hljs-string" style="color:rgb(163,21,21);">"dbo.Donators"</span>, <span class="hljs-string" style="color:rgb(163,21,21);">"CreationTime"</span>, <span class="hljs-built_in" style="color:rgb(0,0,255);">c</span> =&gt; <span class="hljs-built_in" style="color:rgb(0,0,255);">c</span>.<span class="hljs-type" style="color:rgb(163,21,21);">DateTime</span>(nullable: <span class="hljs-literal" style="color:rgb(163,21,21);">false</span>,defaultValueSql:<span class="hljs-string" style="color:rgb(163,21,21);">"GetDate()"</span>));
 }
 
</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">上面的代码中，我们使用了SQL Server中的<strong>GetDate</strong>函数使用当前日期填充新加入的列。实际上，我们也可以在<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">EntityTypeConfiguration</code>类中做许多相同的事情。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">DbMigration</code>基类支持许多数据库工件的维护（不仅仅是列和表），我们可以执行下面的东西：</p> 
   <ul style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">
    <li style="list-style:disc;">创建、删除和更改存储过程</li> 
    <li style="list-style:disc;">添加和删除外键</li> 
    <li style="list-style:disc;">移动数据库模式之间的工件，例如表和存储过程</li> 
    <li style="list-style:disc;">重命名对象，如表、存储过程和列</li> 
    <li style="list-style:disc;">维护主键约束</li> 
    <li style="list-style:disc;">创建、重命名和删除索引</li> 
   </ul>
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">最后，当遇到所说的这些方法不起作用时，可以使用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Sql</code>或者<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">SqlFile</code>方法。前者方法需要传入sql字符串，后者需要一个sql文件名作为参数。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">所有迁移默认都以事务的一部分运行，确保所有的迁移操作要么成功，要么什么都不做。这对SQL Server是成立的，但是对于其他RDBMS可能不成立。比如，Oracle不支持DDL（<strong>Data Definition Language</strong>）定义的结构化操作事务。DDL指的是定义数据库结构的sql语句。还有DML（<strong>Data Manipulation Language</strong>），它指的是CRUD操作语句或者其他操作数据的语句。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">要创建迁移，我们不一定非要有未处理的更改。比如，要创建一个索引，不需要未处理的更改。另外，我们可以使用EF 6.1中引入的API，它允许我们通过model builder API创建索引。为了这个例子的需要，我们使用迁移API。我们仍然使用之前的指令<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Add-Migration</code>，这样就给项目添加了一个迁移，但是Up和Down方法都是空的。现在，我们需要添加创建索引的自定义的代码，如下所示：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">partial</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">Donator_Add_Index_Name</span> : <span class="hljs-title" style="color:rgb(163,21,21);">DbMigration</span>
{
    <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">override</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Up</span>(<span class="hljs-params"></span>) </span>{
        CreateIndex(
            <span class="hljs-string" style="color:rgb(163,21,21);">"Donators"</span>,
            <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> []{<span class="hljs-string" style="color:rgb(163,21,21);">"Name"</span>},
            name:<span class="hljs-string" style="color:rgb(163,21,21);">"Index_Donator_Name"</span>
            );
    }
    
    <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">override</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Down</span>(<span class="hljs-params"></span>) </span>{
        DropIndex(<span class="hljs-string" style="color:rgb(163,21,21);">"Donators"</span>, <span class="hljs-string" style="color:rgb(163,21,21);">"Index_Donator_Name"</span>);
    }
}

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">在上面的迁移中，我创建了一个新的索引，命名为“Donator_Add_Index_Name”，该索引是建立在<strong>Donators</strong>表上的，包含了<em>Name</em>列，如果需要多个列，只需要在字符串数组中添加列就可以了，至于是聚集索引还是非聚集索引，大家也可以自行配置。在Down方法中，我撤销了上面的更改，删除了索引。更新数据库，在MMSM中可以看到，生成了自己创建的索引：</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/38569fe4-978a-43f0-85a8-f9ae8fce4ccd.png" alt="图片" style="border:0px;"></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">到现在，我们还没有使用<strong>Down</strong>方法。事实上，EF数据库迁移支持目标迁移，也就是说，开发者可以将数据库结构移动到任何版本，这就是迁移，可以前进，也可以后退，就像版本控制工具一样。迁移实际上是按照文件名的创建时间进行排序的，该文件名被编码到了迁移的设计器文件中，如<em>201606100502209_InitalMigration.Designer.cs</em>。在解决方案资源管理器中，我们可以看到每个迁移都包含了三个文件，第一个文件是实际的迁移代码，第二个包含了单词<strong>Designer</strong>，指定了迁移Id和一些其他属性，第三个文件是资源文件，包含了模式名称和迁移目标哈希值。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">现在，尝试通过指定创建索引迁移之前的目标迁移删除该索引，创建索引之前的迁移名称是<strong>Donator_Add_CreationTime</strong>，要退回上一个迁移，我们可以使用下面的指令：<br><code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Update-Database -TargetMigration Donator_Add_CreationTime</code></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/1952413b-7f5e-4555-910f-1e2c56a87244.png" alt="图片" style="border:0px;"></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">EF会立即通知我们会撤销哪一个迁移，我们的例子中，就是Donator_Add_Index_Name，如果我们在MMSM中查看数据库结构的话，会看到之前的索引已经不存在了。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/cafb798e-4078-49a1-a842-1b68091fc72f.png" alt="图片" style="border:0px;"></p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;"> <a name="apply" style="color:rgb(224,130,131);"></a>应用迁移</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">至今，我们使用VS应用了所有迁移，在VS内部使用这些功能没有问题，但是当提到更新，测试或生产环境时，这种方式就不奏效了。为了更新这些软件安装，提供了以下更多的选择：</p> 
   <ul style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">
    <li style="list-style:disc;">生成更改脚本</li> 
    <li style="list-style:disc;">使用<em>migrate.exe</em> </li> 
    <li style="list-style:disc;">使用迁移初始化器</li> 
   </ul>
   <h4 style="font-size:14px;color:rgb(205,73,0);border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(205,73,0);font-family:'Microsoft Yahei', Simsun, Arial;line-height:25px;">通过脚本应用迁移</h4> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">在<strong>包管理器控制台</strong>窗口中，我们可以通过<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Update-Database -Script</code>生成脚本，该命令一执行完成，生成的脚本就会在VS中打开。这个脚本包含了目标数据库从上次生成到生成脚本这段时间内发生的更改。我们只需要将这个脚本交给DBA，他会使用该脚本维护生产环境的。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">需要注意的是，我们要指定匹配目标环境的数据库的正确连接字符串，因为迁移API会使用上下文比较实时数据库。我们要么在<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Update-Database</code>后面带上连接字符串，要么在配置文件中使用正确的连接字符串。</p> 
   <h4 style="font-size:14px;color:rgb(205,73,0);border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(205,73,0);font-family:'Microsoft Yahei', Simsun, Arial;line-height:25px;">通过migrate.exe应用迁移</h4> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">Migrate.exe是伴随EF发布的工具。使用Nuget安装EF时，也会将该工具放到EF的安装包所在的文件夹下。我们只需要将这个工具发布到应用程序的二进制文件夹下（也就是bin目录），使得该工具可以找到它需要的所有程序集。这个工具需要和<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Update-Database</code>指令相同的参数，例如：</p> 
   <pre class="powershell"><code class="hljs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">migrate.exe <span class="hljs-keyword" style="color:rgb(0,0,255);">Data</span>
/connectionString=<span class="hljs-string" style="color:rgb(163,21,21);">"Data Source=.;Initial Catalog=DatabaseMigrationApp;Integrated Security=SSPI"</span>
/connectionProviderName=<span class="hljs-string" style="color:rgb(163,21,21);">"System.Data.SqlClient"</span>
/startupConfigurationFile=DatabaseMigrationApp.exe.config
</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;"><img src="https://dn-coding-net-production-pp.qbox.me/dcd452b5-4847-4bd7-9f98-9bc072cfc7ce.png" alt="图片" style="border:0px;"></p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">为了清晰明了，我们将命令行分成多行，为了可读性，每个参数自成一行。第一个参数是包含上下文和迁移的程序集。然后，指定了连接字符串、provider和配置文件。之所以需要配置文件，是因为上下文构造函数使用了配置文件中的连接字符串名字。</p> 
   <h4 style="font-size:14px;color:rgb(205,73,0);border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(205,73,0);font-family:'Microsoft Yahei', Simsun, Arial;line-height:25px;">通过初始化器应用迁移</h4> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">当数据库模式发生变化时，我们可以使用初始化器重建数据库。EF自带了可应用未处理迁移的初始化器基类，这个基类是<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">MigrateDatabaseToLatestVersion</code>。下面定义初始化器：</p> 
   <pre class="c#"><code class="hljs fsharp" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="hljs-keyword" style="color:rgb(0,0,255);">internal</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> Initializer:MigrateDatabaseToLatestVersion&lt;Context,Configuration&gt;
{
    <span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">override</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> InitializeDatabase(Context context)
    {
        <span class="hljs-keyword" style="color:rgb(0,0,255);">base</span>.InitializeDatabase(context);
    }
}

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">这是个很简单的类，我们不需要写任何代码。如果你想在应用迁移时运行一些代码，那么可以使用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">InitializeDatabase</code>方法。该方法会获得上下文的一个实例，因此我们可以在该方法内将数据添加到数据库或者执行其他的一些函数。或者，可以使用迁移配置类，它也有<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Seed</code>方法，可以使用一些种子数据填充数据库。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">现在，只需要在程序启动时将这个新的初始化器插入到EF中，然后调用上下文强制应用迁移，如下所示：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Database.SetInitializer(<span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> Initializer());
<span class="hljs-keyword" style="color:rgb(0,0,255);">using</span> (<span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> context = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> Context())
{
context.Database.Initialize(<span class="hljs-keyword" style="color:rgb(0,0,255);">true</span>);
}
</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">使用其他的初始化器时，我们已经看到了相似的代码，这里，我们也调用了数据库的<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Initialize</code>方法强制对已存在的数据库执行模式验证和迁移应用。如果数据库不存在，就会创建数据库。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;"> <a name="add" style="color:rgb(224,130,131);"></a>给已存在的数据库添加迁移</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">有时，我们想为一个已存在的数据库添加EF迁移，为的是将处理模式变化从一种方式移动到迁移API。当然，因为数据库已存在于生产环境，所以我们需要让迁移知道迁移起始的已知状态。使用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Add-Migration -IgnoreChanges</code>指令处理这个是相当简单的，当执行该命令时，EF会创建一个空的迁移，它会假设上下文和实体定义的模型和数据库是兼容的。一旦通过运行这个迁移更新了数据库，数据库模式不会发生变化，但是会在<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">_MigrationHistory</code>表中添加一条新的数据来对应初次迁移。这个完成之后，我们就可以安全地切换到EF的迁移API来维护数据库模式变化了。</p> 
   <blockquote style="border:2px solid rgb(239,239,239);line-height:1.6;color:rgb(51,51,51);font-size:15px;font-family:'Microsoft Yahei';clear:both;background:rgb(223,255,163) url(&quot;//files.cnblogs.com/files/farb/o_title.gif&quot;) no-repeat 9px 50%;"> 
    <p>一些数据库系统不支持表名的首字母为下划线，EF允许开发者自定义该表名。</p> 
   </blockquote> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">另一个想要解决的用例是为已存在的数据库创建实体类，然后不仅要给已存在的数据库添加EF，还要给已存在的软件添加。这个任务可以使用VS的<strong><a href="https://visualstudiogallery.msdn.microsoft.com/72a60b14-1581-4b9b-89f2-846072eff19d/" rel="nofollow" style="color:rgb(65,131,196);text-decoration:none;">Entity Framework Power Tools</a></strong>插件完成。一旦安装了该插件，在项目的右键菜单上会多个选项<strong>Reverse Engineer Code First（工程转换为Code First）</strong>。开发者需要做的是将这个工具指向想要使用EF支持的数据库，然后该工具会将数据库中的所有表转换为实体类、上下文和配置类。我们也可以使用<strong><a href="https://www.microsoft.com/en-us/download/details.aspx?id=40762" rel="nofollow" style="color:rgb(65,131,196);text-decoration:none;">Entity Framework Tools</a></strong>。这个工具集也支持从数据库生成Code First。为了使用这个功能，只需要从<strong>Add New Item</strong>对话框选择<strong>ADO.NET Entity Data Model</strong>，然后按向导步骤进行即可。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;"> <a name="additional" style="color:rgb(224,130,131);"></a>EF的其他功能</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">下面看一下更多至今还没有讨论的功能，这些功能并不经常使用，但是知道这些功能存在很重要。</p> 
   <h4 style="font-size:14px;color:rgb(205,73,0);border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(205,73,0);font-family:'Microsoft Yahei', Simsun, Arial;line-height:25px;">自定义约定</h4> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">有时，我们想做出应用于很多实体类型或者表的全局更改。比如，我们想使得所有的decimal字段默认是确定的大小，除非我们明确指定为其他大小；美国人也可能想要全局设置所有的字符串属性为非Unicode，因为他们的应用只打算为讲英语的人用。我们可以通过使用全局配置API或者自定义约定完成这些任务。比如，下面是如何设置所有的string属性在数据库中存储为非Unicode列：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">protected</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">override</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">OnModelCreating</span>(<span class="hljs-params">DbModelBuilder modelBuilder</span>) </span>{
    modelBuilder.Properties&lt;<span class="hljs-keyword" style="color:rgb(0,0,255);">string</span>&gt;().Configure(config=&gt;config.IsUnicode(<span class="hljs-keyword" style="color:rgb(0,0,255);">false</span>));
}

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">我们也可以写相同的代码作为自定义约定，然后在model builder中加入到约定集合中。要这么做的话，首先创建一个继承自<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Convention</code>的类，重写构造函数，然后使用之前相同的代码，调用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Convention</code>类的<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Properties</code>方法。代码如下：</p> 
   <pre class="c#"><code class="hljs cs" style="vertical-align:middle;color:rgb(0,0,0);line-height:1.5;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">CustomConventions</span>:<span class="hljs-title" style="color:rgb(163,21,21);">Convention</span>
{
    <span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-title" style="color:rgb(163,21,21);">CustomConventions</span>(<span class="hljs-params"></span>) </span>{
        Properties&lt;<span class="hljs-keyword" style="color:rgb(0,0,255);">string</span>&gt;().Configure(config=&gt;config.IsUnicode(<span class="hljs-keyword" style="color:rgb(0,0,255);">false</span>));
    }
}

<span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">protected</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">override</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">OnModelCreating</span>(<span class="hljs-params">DbModelBuilder modelBuilder</span>) </span>{
    <span class="hljs-comment" style="color:#008000;">//modelBuilder.Properties&lt;string&gt;().Configure(config=&gt;config.IsUnicode(false));</span>
    modelBuilder.Conventions.Add&lt;CustomConventions&gt;();
}

</code></pre> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">必须要记住，要将自定义的约定添加到modelBuilder的Conventions的集合中。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">这些类型的约定指的是配置约定。EF中的模型约定API可以创建两种类型约定：存储模型和概念模型约定。这些约定允许我们在模型中的许多地方全局地应用更改，而不是一个个实体或者一个个属性地修改。每种.Net类型也可以写多个约定，因为EF允许我们控制应用的约定的顺序。</p> 
   <h4 style="font-size:14px;color:rgb(205,73,0);border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(205,73,0);font-family:'Microsoft Yahei', Simsun, Arial;line-height:25px;">地理空间数据</h4> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">除了标量类型数据，如string或decimal，EF也通过.Net中的<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">DbGeometry</code>和<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">DbGeography</code>支持地理空间数据。这些类型有支持地理空间查询的内置支持和正确翻译，例如地图上两点之间的距离。这些特定的查询方法对于具有地理空间属性的实体的查询很有用，换言之，当使用空间类型时，我们仍编写.Net代码。</p> 
   <h4 style="font-size:14px;color:rgb(205,73,0);border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(205,73,0);font-family:'Microsoft Yahei', Simsun, Arial;line-height:25px;">依赖注入DI和日志记录</h4> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">EF现在已经实现了服务定位模式，因此开启了依赖注入。DI用于支持配置方法。比如，可以使用我们自定义方式来创建依赖解析器Resolver，然后创建通用的EF对象，例如<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">IDbConnectionFactory</code>。请通过阅读<strong><a href="https://msdn.microsoft.com/en-us/data/jj680697" rel="nofollow" style="color:rgb(65,131,196);text-decoration:none;">EF的文档</a></strong>找出可以注入到正在运行的应用中的类或接口，强制EF使用它们而不是使用默认的实现。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">也可以将一个自定义的logger注入EF，这样就可以记录EF执行的所有actions到自定义的日志源。要创建自定义日志，开发者可以设置Database对象的Log属性。Log属性需要赋予一个带有一个字符串参数的方法，如<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">context.Database.Log = System.Console.Write;</code>，这样日志就会在控制台中输出。如果你不喜欢这种记录日志的方式，也可以创建自定义的方式。</p> 
   <h4 style="font-size:14px;color:rgb(205,73,0);border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(205,73,0);font-family:'Microsoft Yahei', Simsun, Arial;line-height:25px;">启动性能</h4> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">有时，对于大型数据库和上下文启动时间可能相对较长，<strong>Entity Framework Power Tools</strong>允许我们通过暴露一种预生成视图的能力加速这个过程。这里我们说的不是数据库视图，而指的是EF生成的语句可以创建CRUD操作语句。要生成这些预编译的视图，我们要做的是在含有派生自DbContext的类所在的文件上右键（前提是安装了Power Tools），在<strong>Entity Framework</strong>菜单下选择<strong>Generate Views</strong>操作。这个操作会创建需要编译到程序集的所有代码。</p> 
   <h4 style="font-size:14px;color:rgb(205,73,0);border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(205,73,0);font-family:'Microsoft Yahei', Simsun, Arial;line-height:25px;">一个数据库，多个上下文</h4> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">我们不必总是将映射到表的所有实体集合放到一个上下文里。使用多个DbContext类有很多优点。这种方式可能会减少启动时间，因为这个时间一般是和上下文第一次访问的集合的数量成比例的，也会减少每个上下文对开发者暴露的数据面。还有，它会帮助开发者将数据组织到数据模块中。当然，如果我们使用迁移，我们仍然需要一个包含每个集合或表的上下文，因为我们会使用这个上下文用于支持迁移。这是我们需要实际配置的唯一上下文。当我们使用多个上下文并在一个事务中将数据保存到多个上下文时，需要做一些额外的事情。每个<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">SaveChanges</code>调用都是事务的，但我们需要为所有的<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">SaveChanges</code>调用创建一个首要的事务。我们也许会发现，对于涉及多个模块的保存操作，将所有的集合放到单个大型的DbContext中是更简单的。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;"> <a name="summary" style="color:rgb(224,130,131);"></a>本章小结</h3> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">这篇博客，我们学会了如何使用EF维护数据库模式，学习了在Nuget包管理器控制台里运行<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Enable-Migration</code>命令在一个项目上启用迁移。一旦启用了迁移，会生成一个配置类，我们可以开始将数据库模式向前移动了。对于迁移，开发者有两种选择，可以依赖自动迁移或者创建显式迁移。自动迁移有许多限制，例如不可能设置默认值。为了确保迁移一致性，开发者只能选择使用显式迁移。所有的显式迁移继承自<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">DbMigration</code>类，该类包含了允许更新目标数据库模式的方法。该类的方法允许我们创建或删除表，创建、删除和更改列，创建和删除索引等等。最后，如果找不到合适的方法或者只需要对数据改变时，可以使用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Sql</code>方法来运行任意的SQL命令。如果需要在一个已存在的数据库上开启迁移，那么只需要创建一个空的迁移，这样就将数据库对应的上下文标记为最新的。一旦这个空的初始迁移创建之后，我们就可以像平常那样编写迁移了。在VS内部使用<code style="line-height:1.8;vertical-align:middle;font-family:'Courier New', sans-serif;font-size:12px;border:1px solid rgb(204,204,204);">Update-Database</code>命令可以相当容易地更新开发环境中的数据库。当更新生产环境的数据库时，我们可以使用初始化器来迁移数据库，也可以使用<em>migrate.exe</em>或者在VS里生成一个迁移脚本。</p> 
   <p style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">最后，我们还介绍了一些EF中额外的功能，这些功能平时可能不怎么用，但是知道一些总是好的。因此我们快速浏览了一下这些功能。现在EF支持地理空间数据了，也可以使用日志功能捕获EF对数据库创建并执行的一些命令，通过使用多个数据库上下文类或者预生成视图可以加速EF的启动时间。</p> 
   <h3 style="font-size:16px;line-height:1.5;color:rgb(111,168,51);border-left-width:13px;border-left-style:solid;border-left-color:rgb(111,168,51);font-family:'Microsoft Yahei', Simsun, Arial;"> <a name="selftest" style="color:rgb(224,130,131);"></a>自我测试</h3> 
   <ol style="color:rgb(73,73,73);font-family:'Microsoft Yahei', Simsun, Arial;font-size:15px;line-height:25px;">
    <li style="list-style:decimal;">要发挥EF内置的模式更新的优势，你必须在项目上开启迁移，对吗？</li> 
    <li style="list-style:decimal;">自动迁移百分之百的时间都会奏效，所以不需要使用显式迁移，对吗？</li> 
    <li style="list-style:decimal;">要生成最新版本的迁移脚本，不需要访问目标数据库，对吗？</li> 
    <li style="list-style:decimal;">为了在已存在的生产数据库上添加迁移，你需要怎么做？</li> 
    <li style="list-style:decimal;">要更新本地开发环境的数据库，不能使用VS，对吗？</li> 
    <li style="list-style:decimal;">EF迁移不支持存储过程，因此必须使用其他的工具来实现，对吗？</li> 
    <li style="list-style:decimal;">要为所有的实体类和表的所有decimal字段设置一个通用的精度，必须为每个实体的每个字段指定这个精度，对吗？</li> 
    <li style="list-style:decimal;">如果想要通过EF对RDBMS记录已经触发的命令，只可以使用数据库工具，例如SQL Server profiler，对吗？</li> 
    <li style="list-style:decimal;">要确定两个地理坐标（使用SQL Server地理数据类型可以识别坐标存储）的距离，必须使用存储过程，对吗？</li> 
   </ol>
   <div>
    <font color="#494949"><span style="font-size:15px;line-height:25px;"><br></span></font>
   </div> 
   <div>
    <font color="#494949"><span style="font-size:15px;line-height:25px;"><br></span></font>
   </div> 
   <div>
    <font color="#494949"><span style="font-size:15px;line-height:25px;"><br></span></font>
   </div> 
   <div>
    <font color="#494949"><span style="font-size:15px;line-height:25px;"><br></span></font>
   </div> 
   <div>
    <font color="#494949"><span style="font-size:15px;line-height:25px;">本文转自tkbSimplest博客园博客，原文链接：http://www.cnblogs.com/farb/p/DBMigration.html，如需转载请自行联系原作者</span><br></font>
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
