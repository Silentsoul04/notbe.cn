<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Netty 实现HTTP文件服务器 « NotBeCN</title>
  <meta name="description" content="             一，需求    文件服务器使用HTTP协议对外提供服务。用户通过浏览器访问文件服务器，首先对URL进行检查，若失败返回403错误；若通过校验，以链接的方式打开当前目录，每个目录或文件都以超链接的形式展现，可递归访问，并下载文件。    &nbsp;    二，关键实现代码    ①文件服...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/10/19/weixin_33924220_90127876.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">Netty 实现HTTP文件服务器</h1>
    <p class="post-meta">Oct 19, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">一，需求</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">文件服务器使用HTTP协议对外提供服务。用户通过浏览器访问文件服务器，首先对URL进行检查，若失败返回403错误；若通过校验，以链接的方式打开当前目录，每个目录或文件都以超链接的形式展现，可递归访问，并下载文件。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">二，关键实现代码</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">①文件服务器启动类</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">需要添加的通道处理器如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="line-height:1.5;">@Override
                </span><span style="color:rgb(0,0,255);line-height:1.5;">protected</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span> initChannel(SocketChannel ch) <span style="color:rgb(0,0,255);line-height:1.5;">throws</span><span style="line-height:1.5;"> Exception {
                    ch.pipeline().addLast(</span>"http-decoder", <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> HttpRequestDecoder());
                    ch.pipeline().addLast(</span>"http-aggregator", <span style="color:rgb(0,0,255);line-height:1.5;">new</span> HttpObjectAggregator(65536<span style="line-height:1.5;">));
                    ch.pipeline().addLast(</span>"http-encoder", <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> HttpResponseEncoder());
                    ch.pipeline().addLast(</span>"http-chunked", <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> ChunkedWriteHandler());
                    ch.pipeline().addLast(</span>"fileServerHandler", <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> HttpFileServerHandler(url));
                }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">1) HttpRequestDecoder</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;Decodes {@link ByteBuf}s into {@link HttpRequest}s and {@link HttpContent}s.</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">它负责把字节解码成Http请求。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">2) HttpObjectAggregator</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;A {@link ChannelHandler} that aggregates an {@link HttpMessage}&nbsp; and its following {@link HttpContent}s into a single {@link FullHttpRequest} or {@link FullHttpResponse} (depending on if it used to handle requests or responses)</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">它负责把多个HttpMessage组装成一个完整的Http请求或者响应。到底是组装成请求还是响应，则取决于它所处理的内容是请求的内容，还是响应的内容。这其实可以通过Inbound和Outbound来判断，对于Server端而言，在Inbound 端接收请求，在Outbound端返回响应。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">It is useful when you don't want to take care of HTTP messages whose transfer encoding is 'chunked'.</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">如果Server向Client返回的数据指定的传输编码是 chunked。则，Server不需要知道发送给Client的数据总长度是多少，它是通过分块发送的，<a href="https://zh.wikipedia.org/wiki/%E5%88%86%E5%9D%97%E4%BC%A0%E8%BE%93%E7%BC%96%E7%A0%81" rel="nofollow" style="color:#000000;">参考分块传输编码</a></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">Be aware that you need to have the {@link HttpResponseEncoder} or {@link HttpRequestEncoder} before the {@link HttpObjectAggregator} in the {@link ChannelPipeline}.</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">注意，HttpObjectAggregator通道处理器必须放到HttpRequestDecoder或者HttpRequestEncoder后面。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">3)&nbsp;<span>HttpResponseEncoder</span></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">当Server处理完消息后，需要向Client发送响应。那么需要把响应编码成字节，再发送出去。故添加<span>HttpResponseEncoder处理器。</span></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span>4)ChunkedWriteHandler</span></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span>&nbsp;A {@link ChannelHandler} that adds support for writing a large data stream asynchronously neither spending a lot of memory nor getting {@link OutOfMemoryError}.</span></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span>该通道处理器主要是为了处理大文件传输的情形。大文件传输时，需要复杂的状态管理，而<span>ChunkedWriteHandler</span>实现这个功能。</span></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span>5) HttpFileServerHandler</span></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span>自定义的通道处理器，其目的是实现文件服务器的业务逻辑。</span></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><span>通道处理器添加完毕之后，需要启动服务器。代码如下：</span></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>ChannelFuture f = b.bind("localhost"<span style="line-height:1.5;">, port).sync();
f.channel().closeFuture().sync();</span></pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">因为在Netty中所有的事件都是异步的，因此bind操作是一个异步操作，通道的关闭也是一个异步操作。因此使用ChannelFuture来作为一个 palceholder,代表操作执行之后的结果。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">最后关闭事件线程，代码如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre><span style="line-height:1.5;">bossGroup.shutdownGracefully();
workerGroup.shutdownGracefully();</span></pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">②文件处理器类</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">HttpFileServerHandler.java是自定义的通道处理器，用来实现HTTP文件服务器的业务逻辑。从上面添加的Handler可以看出，在HTTP文件服务器的实现过程中，Netty已经为我们解决了很多工作，如：<span>HttpRequestDecoder</span>自动帮我们解析HTTP请求(解析byte)；再比如：HttpObjectAggregator把多个HTTP请求中的数据组装成一个，当服务器发送的response事先不知道响应的长度时就很有用。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">参考：<a href="http://bylijinnan.iteye.com/blog/1996676" rel="nofollow" style="color:#000000;">HttpChunkAggregator分析</a></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">文件处理器通过继承SimpleChannelInboundHandler来实现，代码如下：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span> HttpFileServerHandler <span style="color:rgb(0,0,255);line-height:1.5;">extends</span> SimpleChannelInboundHandler&lt;FullHttpRequest&gt;<span style="line-height:1.5;">{

    </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">final</span><span style="line-height:1.5;"> String url;
    
    </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> HttpFileServerHandler(String url) {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">this</span>.url =<span style="line-height:1.5;"> url;
    }
    
    @Override
    </span><span style="color:rgb(0,0,255);line-height:1.5;">protected</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> messageReceived(ChannelHandlerContext ctx,
            FullHttpRequest request) </span><span style="color:rgb(0,0,255);line-height:1.5;">throws</span><span style="line-height:1.5;"> Exception {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span>(!<span style="line-height:1.5;">request.decoderResult().isSuccess())
        {
            sendError(ctx, HttpResponseStatus.BAD_REQUEST);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;">;
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span>(request.method() !=<span style="line-height:1.5;"> HttpMethod.GET)
        {
            sendError(ctx, HttpResponseStatus.METHOD_NOT_ALLOWED);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;">;
        }</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">当服务器接收到消息时，会自动触发 messageReceived方法。该方法首先对URL进行判断，并只接受GET请求。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">相关的验证通过后，通过RandomAccessFile类打开文件，并构造响应。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>        RandomAccessFile randomAccessFile = <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">;
        </span><span style="color:rgb(0,0,255);line-height:1.5;">try</span><span style="line-height:1.5;">{
            randomAccessFile </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> RandomAccessFile(file, "r"<span style="line-height:1.5;">);
        }</span><span style="color:rgb(0,0,255);line-height:1.5;">catch</span><span style="line-height:1.5;">(FileNotFoundException fnfd){
            sendError(ctx, HttpResponseStatus.NOT_FOUND);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;">;
        }
        
        </span><span style="color:rgb(0,0,255);line-height:1.5;">long</span> fileLength =<span style="line-height:1.5;"> randomAccessFile.length();
        HttpResponse response </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> DefaultHttpResponse(HttpVersion.HTTP_1_1, HttpResponseStatus.OK);</pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">如果请求中带有“KEEP-ALIVE”，则不关闭连接。</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;">(HttpHeaderUtil.isKeepAlive(request)){
            response.headers().set(HttpHeaderNames.CONNECTION, HttpHeaderValues.KEEP_ALIVE);
        }</span></pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">进行数据的发送</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre>sendFileFuture = ctx.write(<span style="color:rgb(0,0,255);line-height:1.5;">new</span> ChunkedFile(randomAccessFile, 0, fileLength, 8192<span style="line-height:1.5;">), ctx.newProgressivePromise());
        sendFileFuture.addListener(</span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> ChannelProgressiveFutureListener() {
            
            @Override
            </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> operationComplete(ChannelProgressiveFuture future)
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">throws</span><span style="line-height:1.5;"> Exception {
                System.out.println(</span>"Transfer complete."<span style="line-height:1.5;">);
                
            }<br>
ctx.write(response);</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">当发送完数据之后，由于采用的是Transfer-Encoding：chunk模式来传输数据，因此需要在发送一个长度为0的chunk用来标记数据传输完成。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">参考：<a href="https://www.byvoid.com/blog/http-keep-alive-header" rel="nofollow" style="color:#000000;">HTTP协议头部与Keep-Alive模式详解</a></p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;">
    <pre>ChannelFuture lastContentFuture =<span style="line-height:1.5;"> ctx.writeAndFlush(LastHttpContent.EMPTY_LAST_CONTENT);
        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span>(!<span style="line-height:1.5;">HttpHeaderUtil.isKeepAlive(request))
            lastContentFuture.addListener(ChannelFutureListener.CLOSE);
        
    }</span></pre>
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">使用Keep-Alive，可以减少HTTP连接建立的次数，在HTTP1.1中该选项是默认开启的。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">Connection: Keep-Alive When the server processes the request and generates a response, it also adds a header to the response: Connection: Keep-Alive When this is done, the socket connection is not closed as before, but kept open after sending the response.<span class="Apple-converted-space">&nbsp;</span><span class="Apple-converted-space">&nbsp;When the client sends another request, it reuses the same connection. The connection will continue to be reused until either the client or the server decides that the conversation is over, and one of them drops the connection.</span><br></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">在使用Keep-Alive的情况下，当Server处理了Client的请求且生成一个response后，在response的头部添加Connection: Keep-Alive选项，把response返回给client，此时Socket连接并不会关闭。</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">【若没有Keep-Alive，一次HTTP请求响应之后，本次Socket连接就关闭了】</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">由于连接还没有关闭，当client再发送另一个请求时，就会重用这个Socket连接，直至其中一方drops the connection.</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">关于Keep-Alive的讨论，<a href="http://stackoverflow.com/questions/20763999/how-does-http-keep-alive-work" rel="nofollow" style="color:#000000;">参考：</a></p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">整个源码参考：</p> 
   <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);font-family:'Courier New';font-size:12px;"> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
    <pre><span style="color:rgb(0,0,255);line-height:1.5;">package</span><span style="line-height:1.5;"> httpFileServer;

</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.bootstrap.ServerBootstrap;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.channel.ChannelFuture;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.channel.ChannelInitializer;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.channel.EventLoopGroup;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.channel.nio.NioEventLoopGroup;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.channel.socket.SocketChannel;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.channel.socket.nio.NioServerSocketChannel;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.handler.codec.http.HttpObjectAggregator;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.handler.codec.http.HttpRequestDecoder;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.handler.codec.http.HttpRequestEncoder;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.handler.codec.http.HttpResponseEncoder;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.handler.stream.ChunkedWriteHandler;

</span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;"> HttpFileServer {
    </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">final</span> String DEFAULT_URL = "/src/"<span style="line-height:1.5;">;
    
    </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span> run(<span style="color:rgb(0,0,255);line-height:1.5;">final</span> <span style="color:rgb(0,0,255);line-height:1.5;">int</span> port, <span style="color:rgb(0,0,255);line-height:1.5;">final</span> String url)<span style="color:rgb(0,0,255);line-height:1.5;">throws</span><span style="line-height:1.5;"> Exception{
        EventLoopGroup bossGroup </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> NioEventLoopGroup();
        EventLoopGroup workerGroup </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> NioEventLoopGroup();
        
        </span><span style="color:rgb(0,0,255);line-height:1.5;">try</span><span style="line-height:1.5;">{
            ServerBootstrap b </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> ServerBootstrap();
            b.group(bossGroup, workerGroup).channel(NioServerSocketChannel.</span><span style="color:rgb(0,0,255);line-height:1.5;">class</span><span style="line-height:1.5;">)
            .childHandler(</span><span style="color:rgb(0,0,255);line-height:1.5;">new</span> ChannelInitializer&lt;SocketChannel&gt;<span style="line-height:1.5;">() {
                @Override
                </span><span style="color:rgb(0,0,255);line-height:1.5;">protected</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span> initChannel(SocketChannel ch) <span style="color:rgb(0,0,255);line-height:1.5;">throws</span><span style="line-height:1.5;"> Exception {
                    ch.pipeline().addLast(</span>"http-decoder", <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> HttpRequestDecoder());
                    ch.pipeline().addLast(</span>"http-aggregator", <span style="color:rgb(0,0,255);line-height:1.5;">new</span> HttpObjectAggregator(65536<span style="line-height:1.5;">));
                    ch.pipeline().addLast(</span>"http-encoder", <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> HttpResponseEncoder());
                    ch.pipeline().addLast(</span>"http-chunked", <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> ChunkedWriteHandler());
                    ch.pipeline().addLast(</span>"fileServerHandler", <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> HttpFileServerHandler(url));
                }
            });
            
            ChannelFuture f </span>= b.bind("localhost"<span style="line-height:1.5;">, port).sync();
            System.out.println(</span>"HTTP 文件服务器启动, 地址是： " + "http://localhost:" + port +<span style="line-height:1.5;"> url);
            f.channel().closeFuture().sync();
            
        }</span><span style="color:rgb(0,0,255);line-height:1.5;">finally</span><span style="line-height:1.5;">{
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }
    
    </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span> main(String[] args)<span style="color:rgb(0,0,255);line-height:1.5;">throws</span><span style="line-height:1.5;"> Exception {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">int</span> port = 8888<span style="line-height:1.5;">;
        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span>(args.length &gt; 0<span style="line-height:1.5;">)
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">try</span><span style="line-height:1.5;">{
                port </span>= Integer.parseInt(args[0<span style="line-height:1.5;">]);
            }</span><span style="color:rgb(0,0,255);line-height:1.5;">catch</span><span style="line-height:1.5;">(NumberFormatException e){
                port </span>= 8080<span style="line-height:1.5;">;
            }
        }
        
        String url </span>=<span style="line-height:1.5;"> DEFAULT_URL;
        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span>(args.length &gt; 1<span style="line-height:1.5;">)
            url </span>= args[1<span style="line-height:1.5;">];
        </span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> HttpFileServer().run(port, url);
    }
}


</span><span style="color:rgb(0,0,255);line-height:1.5;">package</span><span style="line-height:1.5;"> httpFileServer;

</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> java.io.File;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> java.io.FileNotFoundException;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> java.io.RandomAccessFile;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> java.io.UnsupportedEncodingException;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> java.net.URLDecoder;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> java.util.concurrent.ExecutionException;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> java.util.concurrent.TimeUnit;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> java.util.concurrent.TimeoutException;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> java.util.regex.Pattern;

</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> javax.activation.MimetypesFileTypeMap;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> javax.swing.text.html.MinimalHTMLWriter;

</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.buffer.ByteBuf;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.buffer.Unpooled;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.channel.Channel;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.channel.ChannelFuture;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.channel.ChannelFutureListener;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.channel.ChannelHandlerContext;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.channel.ChannelProgressiveFuture;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.channel.ChannelProgressiveFutureListener;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.channel.SimpleChannelInboundHandler;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.handler.codec.http.DefaultFullHttpResponse;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.handler.codec.http.DefaultHttpResponse;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.handler.codec.http.FullHttpRequest;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.handler.codec.http.FullHttpResponse;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.handler.codec.http.HttpHeaderNames;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.handler.codec.http.HttpHeaderUtil;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.handler.codec.http.HttpHeaderValues;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.handler.codec.http.HttpHeaders;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.handler.codec.http.HttpMessage;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.handler.codec.http.HttpMethod;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.handler.codec.http.HttpResponse;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.handler.codec.http.HttpResponseStatus;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.handler.codec.http.HttpVersion;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.handler.codec.http.LastHttpContent;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.handler.codec.http2.Http2Headers;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.handler.stream.ChunkedFile;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.util.CharsetUtil;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.util.concurrent.Future;
</span><span style="color:rgb(0,0,255);line-height:1.5;">import</span><span style="line-height:1.5;"> io.netty.util.concurrent.GenericFutureListener;

</span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">class</span> HttpFileServerHandler <span style="color:rgb(0,0,255);line-height:1.5;">extends</span> SimpleChannelInboundHandler&lt;FullHttpRequest&gt;<span style="line-height:1.5;">{

    </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">final</span><span style="line-height:1.5;"> String url;
    
    </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span><span style="line-height:1.5;"> HttpFileServerHandler(String url) {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">this</span>.url =<span style="line-height:1.5;"> url;
    }
    
    @Override
    </span><span style="color:rgb(0,0,255);line-height:1.5;">protected</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> messageReceived(ChannelHandlerContext ctx,
            FullHttpRequest request) </span><span style="color:rgb(0,0,255);line-height:1.5;">throws</span><span style="line-height:1.5;"> Exception {
        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span>(!<span style="line-height:1.5;">request.decoderResult().isSuccess())
        {
            sendError(ctx, HttpResponseStatus.BAD_REQUEST);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;">;
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span>(request.method() !=<span style="line-height:1.5;"> HttpMethod.GET)
        {
            sendError(ctx, HttpResponseStatus.METHOD_NOT_ALLOWED);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;">;
        }
        
        </span><span style="color:rgb(0,0,255);line-height:1.5;">final</span> String uri =<span style="line-height:1.5;"> request.uri();
        </span><span style="color:rgb(0,0,255);line-height:1.5;">final</span> String path =<span style="line-height:1.5;"> sanitizeUri(uri);
        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span>(path == <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">)
        {
            sendError(ctx, HttpResponseStatus.FORBIDDEN);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;">;
        }
        
        File file </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> File(path);
        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span>(file.isHidden() || !<span style="line-height:1.5;">file.exists())
        {
            sendError(ctx, HttpResponseStatus.NOT_FOUND);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;">;
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;">(file.isDirectory())
        {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span>(uri.endsWith("/"<span style="line-height:1.5;">))
            {
                sendListing(ctx, file);
            }</span><span style="color:rgb(0,0,255);line-height:1.5;">else</span><span style="line-height:1.5;">{
                sendRedirect(ctx, uri </span>+ "/"<span style="line-height:1.5;">);
            }
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;">;
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span>(!<span style="line-height:1.5;">file.isFile())
        {
            sendError(ctx, HttpResponseStatus.FORBIDDEN);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;">;
        }
        
        RandomAccessFile randomAccessFile </span>= <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">;
        </span><span style="color:rgb(0,0,255);line-height:1.5;">try</span><span style="line-height:1.5;">{
            randomAccessFile </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span> RandomAccessFile(file, "r"<span style="line-height:1.5;">);
        }</span><span style="color:rgb(0,0,255);line-height:1.5;">catch</span><span style="line-height:1.5;">(FileNotFoundException fnfd){
            sendError(ctx, HttpResponseStatus.NOT_FOUND);
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span><span style="line-height:1.5;">;
        }
        
        </span><span style="color:rgb(0,0,255);line-height:1.5;">long</span> fileLength =<span style="line-height:1.5;"> randomAccessFile.length();
        HttpResponse response </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> DefaultHttpResponse(HttpVersion.HTTP_1_1, HttpResponseStatus.OK);
        HttpHeaderUtil.setContentLength(response, fileLength);
</span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">        setContentLength(response, fileLength);</span>
<span style="line-height:1.5;">        setContentTypeHeader(response, file);
        
        
        
        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;">(HttpHeaderUtil.isKeepAlive(request)){
            response.headers().set(HttpHeaderNames.CONNECTION, HttpHeaderValues.KEEP_ALIVE);
        }
        
        ctx.write(response);
        ChannelFuture sendFileFuture </span>= <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">;
        sendFileFuture </span>= ctx.write(<span style="color:rgb(0,0,255);line-height:1.5;">new</span> ChunkedFile(randomAccessFile, 0, fileLength, 8192<span style="line-height:1.5;">), ctx.newProgressivePromise());
        sendFileFuture.addListener(</span><span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> ChannelProgressiveFutureListener() {
            
            @Override
            </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> operationComplete(ChannelProgressiveFuture future)
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">throws</span><span style="line-height:1.5;"> Exception {
                System.out.println(</span>"Transfer complete."<span style="line-height:1.5;">);
                
            }
            
            @Override
            </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> operationProgressed(ChannelProgressiveFuture future,
                    </span><span style="color:rgb(0,0,255);line-height:1.5;">long</span> progress, <span style="color:rgb(0,0,255);line-height:1.5;">long</span> total) <span style="color:rgb(0,0,255);line-height:1.5;">throws</span><span style="line-height:1.5;"> Exception {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span>(total &lt; 0<span style="line-height:1.5;">)
                    System.err.println(</span>"Transfer progress: " +<span style="line-height:1.5;"> progress);
                </span><span style="color:rgb(0,0,255);line-height:1.5;">else</span><span style="line-height:1.5;">
                    System.err.println(</span>"Transfer progress: " + progress + "/" +<span style="line-height:1.5;"> total);
            }
        });
        
        ChannelFuture lastContentFuture </span>=<span style="line-height:1.5;"> ctx.writeAndFlush(LastHttpContent.EMPTY_LAST_CONTENT);
        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span>(!<span style="line-height:1.5;">HttpHeaderUtil.isKeepAlive(request))
            lastContentFuture.addListener(ChannelFutureListener.CLOSE);
        
    }
    
    @Override
    </span><span style="color:rgb(0,0,255);line-height:1.5;">public</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> exceptionCaught(ChannelHandlerContext ctx, Throwable cause)
            </span><span style="color:rgb(0,0,255);line-height:1.5;">throws</span><span style="line-height:1.5;"> Exception {
        cause.printStackTrace();
        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span><span style="line-height:1.5;">(ctx.channel().isActive())
            sendError(ctx, HttpResponseStatus.INTERNAL_SERVER_ERROR);
    }
    
    </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">final</span> Pattern INSECURE_URI = Pattern.compile(".*[&lt;&gt;&amp;\"].*"<span style="line-height:1.5;">);
    </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span><span style="line-height:1.5;"> String sanitizeUri(String uri){
        </span><span style="color:rgb(0,0,255);line-height:1.5;">try</span><span style="line-height:1.5;">{
            uri </span>= URLDecoder.decode(uri, "UTF-8"<span style="line-height:1.5;">);
        }</span><span style="color:rgb(0,0,255);line-height:1.5;">catch</span><span style="line-height:1.5;">(UnsupportedEncodingException e){
            </span><span style="color:rgb(0,0,255);line-height:1.5;">try</span><span style="line-height:1.5;">{
                uri </span>= URLDecoder.decode(uri, "ISO-8859-1"<span style="line-height:1.5;">);
            }</span><span style="color:rgb(0,0,255);line-height:1.5;">catch</span><span style="line-height:1.5;">(UnsupportedEncodingException e1){
                </span><span style="color:rgb(0,0,255);line-height:1.5;">throw</span> <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> Error();
            }
        }
        
        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span>(!<span style="line-height:1.5;">uri.startsWith(url))
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">;
        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span>(!uri.startsWith("/"<span style="line-height:1.5;">))
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">;
        
        uri </span>= uri.replace('/'<span style="line-height:1.5;">, File.separatorChar);
        </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span>(uri.contains(File.separator + '.') || uri.contains('.' + File.separator) || uri.startsWith(".") || uri.endsWith("."<span style="line-height:1.5;">) 
                </span>||<span style="line-height:1.5;"> INSECURE_URI.matcher(uri).matches()){
            </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> <span style="color:rgb(0,0,255);line-height:1.5;">null</span><span style="line-height:1.5;">;
        }
        </span><span style="color:rgb(0,0,255);line-height:1.5;">return</span> System.getProperty("user.dir") + File.separator +<span style="line-height:1.5;"> uri;
    }
    
    </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">final</span> Pattern ALLOWED_FILE_NAME = Pattern.compile("[A-Za-z0-9][-_A-Za-z0-9\\.]*"<span style="line-height:1.5;">);
    
    </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> sendListing(ChannelHandlerContext ctx, File dir){
        FullHttpResponse response </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> DefaultFullHttpResponse(HttpVersion.HTTP_1_1, HttpResponseStatus.OK);
</span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">        response.headers().set("CONNECT_TYPE", "text/html;charset=UTF-8");</span>
        response.headers().set(HttpHeaderNames.CONTENT_TYPE, "text/html;charset=UTF-8"<span style="line-height:1.5;">);
        
        String dirPath </span>=<span style="line-height:1.5;"> dir.getPath();
        StringBuilder buf </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> StringBuilder();
        
        buf.append(</span>"&lt;!DOCTYPE html&gt;\r\n"<span style="line-height:1.5;">);
        buf.append(</span>"&lt;html&gt;&lt;head&gt;&lt;title&gt;"<span style="line-height:1.5;">);
        buf.append(dirPath);
        buf.append(</span>"目录:"<span style="line-height:1.5;">);
        buf.append(</span>"&lt;/title&gt;&lt;/head&gt;&lt;body&gt;\r\n"<span style="line-height:1.5;">);
        
        buf.append(</span>"&lt;h3&gt;"<span style="line-height:1.5;">);
        buf.append(dirPath).append(</span>" 目录："<span style="line-height:1.5;">);
        buf.append(</span>"&lt;/h3&gt;\r\n"<span style="line-height:1.5;">);
        buf.append(</span>"&lt;ul&gt;"<span style="line-height:1.5;">);
        buf.append(</span>"&lt;li&gt;链接：&lt;a href=\" ../\")..&lt;/a&gt;&lt;/li&gt;\r\n"<span style="line-height:1.5;">);
        </span><span style="color:rgb(0,0,255);line-height:1.5;">for</span><span style="line-height:1.5;"> (File f : dir.listFiles()) {
            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span>(f.isHidden() || !<span style="line-height:1.5;">f.canRead()) {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">continue</span><span style="line-height:1.5;">;
            }
            String name </span>=<span style="line-height:1.5;"> f.getName();
            </span><span style="color:rgb(0,0,255);line-height:1.5;">if</span> (!<span style="line-height:1.5;">ALLOWED_FILE_NAME.matcher(name).matches()) {
                </span><span style="color:rgb(0,0,255);line-height:1.5;">continue</span><span style="line-height:1.5;">;
            }
            
            buf.append(</span>"&lt;li&gt;链接：&lt;a href=\""<span style="line-height:1.5;">);
            buf.append(name);
            buf.append(</span>"\"&gt;"<span style="line-height:1.5;">);
            buf.append(name);
            buf.append(</span>"&lt;/a&gt;&lt;/li&gt;\r\n"<span style="line-height:1.5;">);
        }
        
        buf.append(</span>"&lt;/ul&gt;&lt;/body&gt;&lt;/html&gt;\r\n"<span style="line-height:1.5;">);
        
        ByteBuf buffer </span>=<span style="line-height:1.5;"> Unpooled.copiedBuffer(buf,CharsetUtil.UTF_8);  
        response.content().writeBytes(buffer);  
        buffer.release();  
        ctx.writeAndFlush(response).addListener(ChannelFutureListener.CLOSE); 
    }
    
    
    </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> sendRedirect(ChannelHandlerContext ctx, String newUri){
        FullHttpResponse response </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> DefaultFullHttpResponse(HttpVersion.HTTP_1_1, HttpResponseStatus.FOUND);
</span><span style="color:rgb(0,128,0);line-height:1.5;">//</span><span style="color:rgb(0,128,0);line-height:1.5;">        response.headers().set("LOCATIN", newUri);</span>
<span style="line-height:1.5;">        response.headers().set(HttpHeaderNames.LOCATION, newUri);
        ctx.writeAndFlush(response).addListener(ChannelFutureListener.CLOSE);
    }
    </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> sendError(ChannelHandlerContext ctx, HttpResponseStatus status){
        FullHttpResponse response </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> DefaultFullHttpResponse(HttpVersion.HTTP_1_1, status, 
                Unpooled.copiedBuffer(</span>"Failure: " + status.toString() + "\r\n"<span style="line-height:1.5;">, CharsetUtil.UTF_8));
        response.headers().set(HttpHeaderNames.CONTENT_TYPE, </span>"text/html;charset=UTF-8"<span style="line-height:1.5;">);
        ctx.writeAndFlush(response).addListener(ChannelFutureListener.CLOSE);
    }
    </span><span style="color:rgb(0,0,255);line-height:1.5;">private</span> <span style="color:rgb(0,0,255);line-height:1.5;">static</span> <span style="color:rgb(0,0,255);line-height:1.5;">void</span><span style="line-height:1.5;"> setContentTypeHeader(HttpResponse response, File file){
        MimetypesFileTypeMap mimetypesFileTypeMap </span>= <span style="color:rgb(0,0,255);line-height:1.5;">new</span><span style="line-height:1.5;"> MimetypesFileTypeMap();
        response.headers().set(HttpHeaderNames.CONTENT_TYPE, mimetypesFileTypeMap.getContentType(file.getPath()));
    }
}</span></pre> 
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy" style="line-height:1.5;"><a title="复制代码" style="text-decoration:underline;border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
    </div> 
   </div> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;">&nbsp;本文转自hapjin博客园博客，原文链接：http://www.cnblogs.com/hapjin/p/5364416.html，如需转载请自行联系原作者</p> 
   <p style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"><br></p> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
