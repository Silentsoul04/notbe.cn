<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>iOS：runtime最全的知识总结 « NotBeCN</title>
  <meta name="description" content="                  runtime 完整总结                 好东西，应该拿出来与大家分享...                 南峰子博客地址：http://southpeak.github.io/blog/categories/ios/                  原文链...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/10/11/weixin_33725270_90117786.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">iOS：runtime最全的知识总结</h1>
    <p class="post-meta">Oct 11, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <div class="blogpost-body" style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:25.2px;"> 
    <h1 style="color:rgb(0,0,0);line-height:1.5;font-size:28px;"><span style="line-height:1.8;font-family:'楷体';">runtime 完整总结</span></h1> 
    <div class="show-content"> 
     <div>
      <span style="line-height:1.8;font-family:'楷体';font-size:16px;">好东西，应该拿出来与大家分享...</span>
     </div> 
     <div>
      <span style="line-height:1.8;font-family:'楷体';font-size:16px;">南峰子博客地址：http://southpeak.github.io/blog/categories/ios/</span>
     </div> 
     <div> 
      <span style="line-height:1.8;font-family:'楷体';font-size:16px;">原文链接：http://www.jianshu.com/p/6b905584f536</span>
      <br>
      <br>
     </div> 
     <div> 
      <ul>
       <li style="list-style:disc;"> <h2 style="color:rgb(0,0,0);line-height:1.5;font-size:21px;"><span style="line-height:1.8;font-family:'楷体';">类和对象</span></h2> </li>
      </ul>
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Objective-C语言是一门动态语言，它将很多静态语言在编译和链接时期做的事放到了运行时来处理。这种动态语言的优势在于：我们写代码时更具灵活性，如我们可以把消息转发给我们想要的对象，或者随意交换一个方法的实现等。</span><span style="line-height:1.8;font-family:'楷体';font-size:16px;">这种特性意味着Objective-C不仅需要一个编译器，还需要一个运行时系统来执行编译的代码。对于Objective-C来说，这个运行时系统就像一个操作系统一样：它让所有的工作可以正常的运行。这个运行时系统即Objc Runtime。Objc Runtime其实是一个Runtime库，它基本上是用C和汇编写的，这个库使得C语言有了面向对象的能力。</span></p> 
      <ul>
       <li style="list-style:disc;"><strong><span style="line-height:1.8;font-family:'楷体';font-size:16px;color:rgb(0,0,0);">Runtime库主要做下面几件事：</span></strong></li>
      </ul>
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">封装：在这个库中，对象可以用C语言中的结构体表示，而方法可以用C函数来实现，另外再加上了一些额外的特性。这些结构体和函数被runtime函数封装后，我们就可以在程序运行时创建，检查，修改类、对象和它们的方法了。</span><br><span style="line-height:1.8;font-family:'楷体';font-size:16px;">找出方法的最终执行代码：当程序执行[object doSomething]时，会向消息接收者(object)发送一条消息(doSomething)，runtime会根据消息接收者是否能响应该消息而做出不同的反应。这将在后面详细介绍。</span><br><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Objective-C runtime目前有两个版本：Modern runtime和Legacy runtime。Modern Runtime 覆盖了64位的Mac OS X Apps，还有 iOS Apps，Legacy Runtime 是早期用来给32位 Mac OS X Apps 用的，也就是可以不用管就是了。</span><span style="line-height:1.8;font-family:'楷体';font-size:16px;">在这一系列文章中，我们将介绍runtime的基本工作原理，以及如何利用它让我们的程序变得更加灵活。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">在本文中，我们先来介绍一下类与对象，这是面向对象的基础，我们看看在Runtime中，类是如何实现的。</span></p> 
      <p>&nbsp;</p> 
      <ul>
       <li style="list-style:disc;"> <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">类与对象基础数据结构</span></h3> </li>
      </ul>
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">Class</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Objective-C类是由Class类型来表示的，它实际上是一个指向objc_class结构体的指针。它的定义如下：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre>typedef <span style="line-height:1.8;color:rgb(0,0,255);">struct</span> objc_class *Class;</pre>
      </div> 
      <p><strong><span style="line-height:1.8;font-family:'楷体';font-size:16px;">查看objc/runtime.h中objc_class结构体的定义如下：</span></strong></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">struct</span><span style="line-height:1.8;"> objc_class {
    Class isa  OBJC_ISA_AVAILABILITY;

</span><span style="line-height:1.8;color:rgb(0,0,255);">#if</span> !__OBJC2__<span style="line-height:1.8;">
    Class super_class                       OBJC2_UNAVAILABLE;  </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 父类</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *name                        OBJC2_UNAVAILABLE;  <span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 类名</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">long</span> version                            OBJC2_UNAVAILABLE;  <span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 类的版本信息，默认为0</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">long</span> info                               OBJC2_UNAVAILABLE;  <span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 类信息，供运行期使用的一些位标识</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">long</span> instance_size                      OBJC2_UNAVAILABLE;  <span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 该类的实例变量大小</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">struct</span> objc_ivar_list *ivars            OBJC2_UNAVAILABLE;  <span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 该类的成员变量链表</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">struct</span> objc_method_list **methodLists   OBJC2_UNAVAILABLE;  <span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 方法定义的链表</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">struct</span> objc_cache *cache                OBJC2_UNAVAILABLE;  <span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 方法缓存</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">struct</span> objc_protocol_list *protocols    OBJC2_UNAVAILABLE;  <span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 协议链表</span>
<span style="line-height:1.8;color:rgb(0,0,255);">#endif</span><span style="line-height:1.8;">

} OBJC2_UNAVAILABLE;</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;"><strong>在这个定义中，下面几个字段是我们感兴趣的</strong></span></p> 
      <ul>
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">isa：需要注意的是在Objective-C中，所有的类自身也是一个对象，这个对象的Class里面也有一个isa指针，它指向metaClass(元类)，我们会在后面介绍它。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">super_class：指向该类的父类，如果该类已经是最顶层的根类(如NSObject或NSProxy)，则super_class为NULL。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">cache：用于缓存最近使用的方法。一个接收者对象接收到一个消息时，它会根据isa指针去查找能够响应这个消息的对象。在实际使用中，这个对象只有一部分方法是常用的，很多方法其实很少用或者根本用不上。这种情况下，如果每次消息来时，我们都是methodLists中遍历一遍，性能势必很差。这时，cache就派上用场了。在我们每次调用过一个方法后，这个方法就会被缓存到cache列表中，下次调用的时候runtime就会优先去cache中查找，如果cache没有，才去methodLists中查找方法。这样，对于那些经常用到的方法的调用，但提高了调用的效率。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">version：我们可以使用这个字段来提供类的版本信息。这对于对象的序列化非常有用，它可是让我们识别出不同类定义版本中实例变量布局的改变。</span></p> </li> 
      </ul>
      <p><strong><span style="line-height:1.8;font-family:'楷体';font-size:16px;">针对cache，我们用下面例子来说明其执行过程：</span></strong></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre>NSArray *array = [[NSArray alloc] init];</pre>
      </div> 
      <p><strong><span style="line-height:1.8;font-family:'楷体';font-size:16px;">其流程是：</span></strong></p> 
      <ul>
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">[NSArray alloc]先被执行。因为NSArray没有+alloc方法，于是去父类NSObject去查找。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">检测NSObject是否响应+alloc方法，发现响应，于是检测NSArray类，并根据其所需的内存空间大小开始分配内存空间，然后把isa指针指向NSArray类。同时，+alloc也被加进cache列表里面。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">接着，执行-init方法，如果NSArray响应该方法，则直接将其加入cache；如果不响应，则去父类查找。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">在后期的操作中，如果再以[[NSArray alloc] init]这种方式来创建数组，则会直接从cache中取出相应的方法，直接调用。</span></p> </li> 
      </ul>
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">objc_object与id</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">objc_object是表示一个类的实例的结构体，它的定义如下(objc/objc.h)</span>：</p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">struct</span><span style="line-height:1.8;"> objc_object {
    Class isa  OBJC_ISA_AVAILABILITY;
};

typedef </span><span style="line-height:1.8;color:rgb(0,0,255);">struct</span> objc_object *id;</pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">可以看到，这个结构体只有一个字体，即指向其类的isa指针。这样，当我们向一个Objective-C对象发送消息时，运行时库会根据实例对象的isa指针找到这个实例对象所属的类。Runtime库会在类的方法列表及父类的方法列表中去寻找与消息对应的selector指向的方法。找到后即运行这个方法。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">当创建一个特定类的实例对象时，分配的内存包含一个objc_object数据结构，然后是类的实例变量的数据。NSObject类的alloc和allocWithZone:方法使用函数class_createInstance来创建objc_object数据结构。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">另外还有我们常见的id，它是一个objc_object结构类型的指针。它的存在可以让我们实现类似于C++中泛型的一些操作。该类型的对象可以转换为任何一种对象，有点类似于C语言中void *指针类型的作用。</span></p> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><strong><span style="line-height:1.8;font-family:'楷体';">objc_cache</span></strong></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">上面提到了objc_class结构体中的cache字段，它用于缓存调用过的方法。这个字段是一个指向objc_cache结构体的指针，其定义如下：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">struct</span><span style="line-height:1.8;"> objc_cache {
    unsigned </span><span style="line-height:1.8;color:rgb(0,0,255);">int</span> mask <span style="line-height:1.8;color:rgb(0,128,0);">/*</span><span style="line-height:1.8;color:rgb(0,128,0);"> total = mask + 1 </span><span style="line-height:1.8;color:rgb(0,128,0);">*/</span><span style="line-height:1.8;">                 OBJC2_UNAVAILABLE;
    unsigned </span><span style="line-height:1.8;color:rgb(0,0,255);">int</span><span style="line-height:1.8;"> occupied                                    OBJC2_UNAVAILABLE;
    Method buckets[</span><span style="line-height:1.8;color:rgb(128,0,128);">1</span><span style="line-height:1.8;">]                                        OBJC2_UNAVAILABLE;
};</span></pre>
      </div> 
      <p><strong><span style="line-height:1.8;font-family:'楷体';font-size:16px;">该结构体的字段描述如下：</span></strong></p> 
      <ul>
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">mask：一个整数，指定分配的缓存bucket的总数。在方法查找过程中，Objective-C runtime使用这个字段来确定开始线性查找数组的索引位置。指向方法selector的指针与该字段做一个AND位操作(index = (mask &amp; selector))。这可以作为一个简单的hash散列算法。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">occupied：一个整数，指定实际占用的缓存bucket的总数。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">buckets：指向Method数据结构指针的数组。这个数组可能包含不超过mask+1个元素。需要注意的是，指针可能是NULL，表示这个缓存bucket没有被占用，另外被占用的bucket可能是不连续的。这个数组可能会随着时间而增长。</span></p> </li> 
      </ul>
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">元类(Meta Class)</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">在上面我们提到，所有的类自身也是一个对象，我们可以向这个对象发送消息(即调用类方法)。如：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre>NSArray *array = [NSArray array];</pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">这个例子中，+array消息发送给了NSArray类，而这个NSArray也是一个对象。既然是对象，那么它也是一个objc_object指针，它包含一个指向其类的一个isa指针。那么这些就有一个问题了，这个isa指针指向什么呢？为了调用+array方法，这个类的isa指针必须指向一个包含这些类方法的一个objc_class结构体。这就引出了meta-class的概念</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre>meta-class是一个类对象的类。</pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">当我们向一个对象发送消息时，runtime会在这个对象所属的这个类的方法列表中查找方法；而向一个类发送消息时，会在这个类的meta-class的方法列表中查找。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">meta-class之所以重要，是因为它存储着一个类的所有类方法。每个类都会有一个单独的meta-class，因为每个类的类方法基本不可能完全相同。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">再深入一下，meta-class也是一个类，也可以向它发送一个消息，那么它的isa又是指向什么呢？为了不让这种结构无限延伸下去，Objective-C的设计者让所有的meta-class的isa指向基类的meta-class，以此作为它们的所属类。即，任何NSObject继承体系下的meta-class都使用NSObject的meta-class作为自己的所属类，而基类的meta-class的isa指针是指向它自己。这样就形成了一个完美的闭环。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">通过上面的描述，再加上对objc_class结构体中super_class指针的分析，我们就可以描绘出类及相应meta-class类的一个继承体系。</span></p> 
      <p><strong><span style="line-height:1.8;font-family:'楷体';font-size:16px;">对于NSObject继承体系来说，其实例方法对体系中的所有实例、类和meta-class都是有效的；而类方法对于体系内的所有类和meta-class都是有效的。</span></strong><strong><span style="line-height:1.8;font-family:'楷体';font-size:16px;">讲了这么多，我们还是来写个例子吧：</span></strong></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">void</span> TestMetaClass(<span style="line-height:1.8;color:rgb(0,0,255);">id</span><span style="line-height:1.8;"> self, SEL _cmd) {

    NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">This objcet is %p</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, self);
    NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">Class is %@, super class is %@</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>, [self <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;">], [self superclass]);

    Class currentClass </span>= [self <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;">];
    </span><span style="line-height:1.8;color:rgb(0,0,255);">for</span> (<span style="line-height:1.8;color:rgb(0,0,255);">int</span> i = <span style="line-height:1.8;color:rgb(128,0,128);">0</span>; i &lt; <span style="line-height:1.8;color:rgb(128,0,128);">4</span>; i++<span style="line-height:1.8;">) {
        NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">Following the isa pointer %d times gives %p</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, i, currentClass);
        currentClass </span>= objc_getClass((__bridge <span style="line-height:1.8;color:rgb(0,0,255);">void</span> *<span style="line-height:1.8;">)currentClass);
    }

    NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">NSObject's class is %p</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>, [NSObject <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;">]);
    NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">NSObject's meta class is %p</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>, objc_getClass((__bridge <span style="line-height:1.8;color:rgb(0,0,255);">void</span> *)[NSObject <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;">]));
}

</span><span style="line-height:1.8;color:rgb(0,0,255);">#pragma</span> mark -

<span style="line-height:1.8;color:rgb(0,0,255);">@implementation</span><span style="line-height:1.8;"> Test

</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">)ex_registerClassPair {

    Class newClass </span>= objc_allocateClassPair([NSError <span style="line-height:1.8;color:rgb(0,0,255);">class</span>], <span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">TestClass</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>, <span style="line-height:1.8;color:rgb(128,0,128);">0</span><span style="line-height:1.8;">);
    class_addMethod(newClass, @selector(testMetaClass), (IMP)TestMetaClass, </span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">v@:</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);
    objc_registerClassPair(newClass);

    </span><span style="line-height:1.8;color:rgb(0,0,255);">id</span> instance = [[newClass alloc] initWithDomain:<span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">some domain</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span> code:<span style="line-height:1.8;color:rgb(128,0,128);">0</span><span style="line-height:1.8;"> userInfo:nil];
    [instance performSelector:@selector(testMetaClass)];
}

</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">这个例子是在运行时创建了一个NSError的子类TestClass，然后为这个子类添加一个方法testMetaClass，这个方法的实现是TestMetaClass函数。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">运行后，打印结果是：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">20</span> <span style="line-height:1.8;color:rgb(128,0,128);">22</span>:<span style="line-height:1.8;color:rgb(128,0,128);">57</span>:<span style="line-height:1.8;color:rgb(128,0,128);">07.352</span> mountain[<span style="line-height:1.8;color:rgb(128,0,128);">1303</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41490</span>] This objcet <span style="line-height:1.8;color:rgb(0,0,255);">is</span> <span style="line-height:1.8;color:rgb(128,0,128);">0x7a6e22b0</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">20</span> <span style="line-height:1.8;color:rgb(128,0,128);">22</span>:<span style="line-height:1.8;color:rgb(128,0,128);">57</span>:<span style="line-height:1.8;color:rgb(128,0,128);">07.353</span> mountain[<span style="line-height:1.8;color:rgb(128,0,128);">1303</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41490</span>] Class <span style="line-height:1.8;color:rgb(0,0,255);">is</span> TestStringClass, super <span style="line-height:1.8;color:rgb(0,0,255);">class</span> <span style="line-height:1.8;color:rgb(0,0,255);">is</span><span style="line-height:1.8;"> NSError
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">20</span> <span style="line-height:1.8;color:rgb(128,0,128);">22</span>:<span style="line-height:1.8;color:rgb(128,0,128);">57</span>:<span style="line-height:1.8;color:rgb(128,0,128);">07.353</span> mountain[<span style="line-height:1.8;color:rgb(128,0,128);">1303</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41490</span>] Following the isa pointer <span style="line-height:1.8;color:rgb(128,0,128);">0</span> times gives <span style="line-height:1.8;color:rgb(128,0,128);">0x7a6e21b0</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">20</span> <span style="line-height:1.8;color:rgb(128,0,128);">22</span>:<span style="line-height:1.8;color:rgb(128,0,128);">57</span>:<span style="line-height:1.8;color:rgb(128,0,128);">07.353</span> mountain[<span style="line-height:1.8;color:rgb(128,0,128);">1303</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41490</span>] Following the isa pointer <span style="line-height:1.8;color:rgb(128,0,128);">1</span> times gives <span style="line-height:1.8;color:rgb(128,0,128);">0x0</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">20</span> <span style="line-height:1.8;color:rgb(128,0,128);">22</span>:<span style="line-height:1.8;color:rgb(128,0,128);">57</span>:<span style="line-height:1.8;color:rgb(128,0,128);">07.353</span> mountain[<span style="line-height:1.8;color:rgb(128,0,128);">1303</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41490</span>] Following the isa pointer <span style="line-height:1.8;color:rgb(128,0,128);">2</span> times gives <span style="line-height:1.8;color:rgb(128,0,128);">0x0</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">20</span> <span style="line-height:1.8;color:rgb(128,0,128);">22</span>:<span style="line-height:1.8;color:rgb(128,0,128);">57</span>:<span style="line-height:1.8;color:rgb(128,0,128);">07.353</span> mountain[<span style="line-height:1.8;color:rgb(128,0,128);">1303</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41490</span>] Following the isa pointer <span style="line-height:1.8;color:rgb(128,0,128);">3</span> times gives <span style="line-height:1.8;color:rgb(128,0,128);">0x0</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">20</span> <span style="line-height:1.8;color:rgb(128,0,128);">22</span>:<span style="line-height:1.8;color:rgb(128,0,128);">57</span>:<span style="line-height:1.8;color:rgb(128,0,128);">07.353</span> mountain[<span style="line-height:1.8;color:rgb(128,0,128);">1303</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41490</span>] NSObject<span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">s class is 0xe10000</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">20</span> <span style="line-height:1.8;color:rgb(128,0,128);">22</span>:<span style="line-height:1.8;color:rgb(128,0,128);">57</span>:<span style="line-height:1.8;color:rgb(128,0,128);">07.354</span> mountain[<span style="line-height:1.8;color:rgb(128,0,128);">1303</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41490</span>] NSObject<span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">s meta class is 0x0</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">我们在for循环中，我们通过objc_getClass来获取对象的isa，并将其打印出来，依此一直回溯到NSObject的meta-class。分析打印结果，可以看到最后指针指向的地址是0x0，即NSObject的meta-class的类地址。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">这里需要注意的是：我们在一个类对象调用class方法是无法获取meta-class，它只是返回类而已。</span></p> 
      <ul>
       <li style="list-style:disc;"> <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';font-size:18px;">类与对象操作函数</span></h3> </li>
      </ul>
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">runtime提供了大量的函数来操作类与对象。类的操作方法大部分是以class为前缀的，而对象的操作方法大部分是以objc或object_为前缀。下面我们将根据这些方法的用途来分类讨论这些方法的使用。</span></p> 
      <ul>
       <li style="list-style:disc;"> <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';font-size:18px;">类相关操作函数</span></h3> </li>
      </ul>
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">我们可以回过头去看看objc_class的定义，runtime提供的操作类的方法主要就是针对这个结构体中的各个字段的。下面我们分别介绍这一些的函数。并在最后以实例来演示这些函数的具体用法。</span></p> 
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">类名(name)</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">类名操作的函数主要有：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取类的类名</span>
<span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> * class_getName ( Class cls );</pre>
      </div> 
      <ul>
       <li style="list-style:disc;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">对于class_getName函数，如果传入的cls为Nil，则返回一个字字符串。</span></li>
      </ul>
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">父类(super_class)和元类(meta-class)</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">父类和元类操作的函数主要有：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取类的父类</span>
<span style="line-height:1.8;">Class class_getSuperclass ( Class cls );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 判断给定的Class是否是一个元类</span>
BOOL class_isMetaClass ( Class cls );</pre>
      </div> 
      <ul>
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">class_getSuperclass函数，当cls为Nil或者cls为根类时，返回Nil。不过通常我们可以使用NSObject类的superclass方法来达到同样的目的。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">class_isMetaClass函数，如果是cls是元类，则返回YES；如果否或者传入的cls为Nil，则返回NO。</span></p> </li> 
      </ul>
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">实例变量大小(instance_size)</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">实例变量大小操作的函数有：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取实例大小</span>
size_t class_getInstanceSize ( Class cls );</pre>
      </div> 
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">成员变量(ivars)及属性</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">在objc_class中，所有的成员变量、属性的信息是放在链表ivars中的。ivars是一个数组，数组中每个元素是指向Ivar(变量信息)的指针。runtime提供了丰富的函数来操作这一字段。大体上可以分为以下几类：</span></p> 
      <p><strong><span style="line-height:1.8;font-family:'楷体';font-size:16px;">1.成员变量操作函数，主要包含以下函数：</span></strong></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取类中指定名称实例成员变量的信息</span>
Ivar class_getInstanceVariable ( Class cls, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;">name );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取类成员变量的信息</span>
Ivar class_getClassVariable ( Class cls, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;">name );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 添加成员变量</span>
BOOL class_addIvar ( Class cls, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *name, size_t size, uint8_t alignment, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;">types );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取整个成员变量列表</span>
Ivar * class_copyIvarList ( Class cls, unsigned <span style="line-height:1.8;color:rgb(0,0,255);">int</span> *outCount );</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <ul>
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">class_getInstanceVariable函数，它返回一个指向包含name指定的成员变量信息的objc_ivar结构体的指针(Ivar)。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">class_getClassVariable函数，目前没有找到关于Objective-C中类变量的信息，一般认为Objective-C不支持类变量。注意，返回的列表不包含父类的成员变量和属性。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Objective-C不支持往已存在的类中添加实例变量，因此不管是系统库提供的提供的类，还是我们自定义的类，都无法动态添加成员变量。但如果我们通过运行时来创建一个类的话，又应该如何给它添加成员变量呢？这时我们就可以使用class_addIvar函数了。不过需要注意的是，这个方法只能在objc_allocateClassPair函数与objc_registerClassPair之间调用。另外，这个类也不能是元类。成员变量的按字节最小对齐量是1&lt;&lt;alignment。这取决于ivar的类型和机器的架构。如果变量的类型是指针类型，则传递log2(sizeof(pointer_type))。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">class_copyIvarList函数，它返回一个指向成员变量信息的数组，数组中每个元素是指向该成员变量信息的objc_ivar结构体的指针。这个数组不包含在父类中声明的变量。outCount指针返回数组的大小。需要注意的是，我们必须使用free()来释放这个数组。</span></p> </li> 
      </ul>
      <p><strong><span style="line-height:1.8;font-family:'楷体';font-size:16px;">2.属性操作函数，主要包含以下函数：</span></strong></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取指定的属性</span>
objc_property_t class_getProperty ( Class cls, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;">name );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取属性列表</span>
objc_property_t * class_copyPropertyList ( Class cls, unsigned <span style="line-height:1.8;color:rgb(0,0,255);">int</span> *<span style="line-height:1.8;">outCount );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 为类添加属性</span>
BOOL class_addProperty ( Class cls, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *name, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> objc_property_attribute_t *attributes, unsigned <span style="line-height:1.8;color:rgb(0,0,255);">int</span><span style="line-height:1.8;"> attributeCount );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 替换类的属性</span>
<span style="line-height:1.8;color:rgb(0,0,255);">void</span> class_replaceProperty ( Class cls, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *name, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> objc_property_attribute_t *attributes, unsigned <span style="line-height:1.8;color:rgb(0,0,255);">int</span> attributeCount );</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <ul>
       <li style="list-style:disc;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">这一种方法也是针对ivars来操作，不过只操作那些是属性的值。我们在后面介绍属性时会再遇到这些函数。</span></li>
      </ul>
      <p><strong><span style="line-height:1.8;font-family:'楷体';font-size:16px;">3.在MAC OS X系统中，我们可以使用垃圾回收器。runtime提供了几个函数来确定一个对象的内存区域是否可以被垃圾回收器扫描，以处理strong/weak引用。这几个函数定义如下：</span></strong></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">const</span> uint8_t *<span style="line-height:1.8;"> class_getIvarLayout ( Class cls );
</span><span style="line-height:1.8;color:rgb(0,0,255);">void</span> class_setIvarLayout ( Class cls, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> uint8_t *<span style="line-height:1.8;">layout );
</span><span style="line-height:1.8;color:rgb(0,0,255);">const</span> uint8_t *<span style="line-height:1.8;"> class_getWeakIvarLayout ( Class cls );
</span><span style="line-height:1.8;color:rgb(0,0,255);">void</span> class_setWeakIvarLayout ( Class cls, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> uint8_t *layout );</pre>
      </div> 
      <ul>
       <li style="list-style:disc;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">但通常情况下，我们不需要去主动调用这些方法；在调用objc_registerClassPair时，会生成合理的布局。在此不详细介绍这些函数。</span></li>
      </ul>
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">方法(methodLists)</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">方法操作主要有以下函数：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 添加方法</span>
BOOL class_addMethod ( Class cls, SEL name, IMP imp, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;">types );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取实例方法</span>
<span style="line-height:1.8;">Method class_getInstanceMethod ( Class cls, SEL name );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取类方法</span>
<span style="line-height:1.8;">Method class_getClassMethod ( Class cls, SEL name );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取所有方法的数组</span>
Method * class_copyMethodList ( Class cls, unsigned <span style="line-height:1.8;color:rgb(0,0,255);">int</span> *<span style="line-height:1.8;">outCount );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 替代方法的实现</span>
IMP class_replaceMethod ( Class cls, SEL name, IMP imp, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;">types );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 返回方法的具体实现</span>
<span style="line-height:1.8;">IMP class_getMethodImplementation ( Class cls, SEL name );
IMP class_getMethodImplementation_stret ( Class cls, SEL name );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 类实例是否响应指定的selector</span>
BOOL class_respondsToSelector ( Class cls, SEL sel );</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <ul>
       <li style="list-style:disc;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">class_addMethod的实现会覆盖父类的方法实现，但不会取代本类中已存在的实现，如果本类中包含一个同名的实现，则函数会返回NO。如果要修改已存在实现，可以使用method_setImplementation。一个Objective-C方法是一个简单的C函数，它至少包含两个参数—self和_cmd。所以，我们的实现函数(IMP参数指向的函数)至少需要两个参数，如下所示：</span></li>
      </ul>
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">void</span> myMethodIMP(<span style="line-height:1.8;color:rgb(0,0,255);">id</span><span style="line-height:1.8;"> self, SEL _cmd)
{
    </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> implementation ....</span>
}</pre>
      </div> 
      <p><strong><span style="line-height:1.8;font-family:'楷体';font-size:16px;">与成员变量不同的是，我们可以为类动态添加方法，不管这个类是否已存在。另外，参数types是一个描述传递给方法的参数类型的字符数组，这就涉及到类型编码，我们将在后面介绍。</span></strong></p> 
      <ul>
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">class_getInstanceMethod、class_getClassMethod函数，与class_copyMethodList不同的是，这两个函数都会去搜索父类的实现。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">class_copyMethodList函数，返回包含所有实例方法的数组，如果需要获取类方法，则可以使用class_copyMethodList(object_getClass(cls), &amp;count)(一个类的实例方法是定义在元类里面)。该列表不包含父类实现的方法。outCount参数返回方法的个数。在获取到列表后，我们需要使用free()方法来释放它。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">class_replaceMethod函数，该函数的行为可以分为两种：如果类中不存在name指定的方法，则类似于class_addMethod函数一样会添加方法；如果类中已存在name指定的方法，则类似于method_setImplementation一样替代原方法的实现。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">class_getMethodImplementation函数，该函数在向类实例发送消息时会被调用，并返回一个指向方法实现函数的指针。这个函数会比method_getImplementation(class_getInstanceMethod(cls, name))更快。返回的函数指针可能是一个指向runtime内部的函数，而不一定是方法的实际实现。例如，如果类实例无法响应selector，则返回的函数指针将是运行时消息转发机制的一部分。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">class_respondsToSelector函数，我们通常使用NSObject类的respondsToSelector:或instancesRespondToSelector:方法来达到相同目的。</span></p> </li> 
      </ul>
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">协议(objc_protocol_list)</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">协议相关的操作包含以下函数：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 添加协议</span>
BOOL class_addProtocol ( Class cls, Protocol *<span style="line-height:1.8;">protocol );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 返回类是否实现指定的协议</span>
BOOL class_conformsToProtocol ( Class cls, Protocol *<span style="line-height:1.8;">protocol );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 返回类实现的协议列表</span>
Protocol * class_copyProtocolList ( Class cls, unsigned <span style="line-height:1.8;color:rgb(0,0,255);">int</span> *outCount );</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <ul>
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">class_conformsToProtocol函数可以使用NSObject类的conformsToProtocol:方法来替代。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">class_copyProtocolList函数返回的是一个数组，在使用后我们需要使用free()手动释放。</span></p> </li> 
      </ul>
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">版本(version)</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">版本相关的操作包含以下函数：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取版本号</span>
<span style="line-height:1.8;color:rgb(0,0,255);">int</span><span style="line-height:1.8;"> class_getVersion ( Class cls );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 设置版本号</span>
<span style="line-height:1.8;color:rgb(0,0,255);">void</span> class_setVersion ( Class cls, <span style="line-height:1.8;color:rgb(0,0,255);">int</span> version );</pre>
      </div> 
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">其它</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">runtime还提供了两个函数来供CoreFoundation的tool-free bridging使用，通常我们不直接使用这两个函数。即：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre>Class objc_getFutureClass ( <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;">name );
</span><span style="line-height:1.8;color:rgb(0,0,255);">void</span> objc_setFutureClass ( Class cls, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *name );</pre>
      </div> 
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">实例(Example)</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">上面列举了大量类操作的函数，下面我们写个实例，来看看这些函数的实例效果：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">-----------------------------------------------------------
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> MyClass.h</span>

<span style="line-height:1.8;color:rgb(0,0,255);">@interface</span> MyClass : NSObject &lt;NSCopying, NSCoding&gt;<span style="line-height:1.8;">

@property (nonatomic, strong) NSArray </span>*<span style="line-height:1.8;">array;

@property (nonatomic, copy) NSString </span>*<span style="line-height:1.8;color:rgb(0,0,255);">string</span><span style="line-height:1.8;">;

</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">)method1;

</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">)method2;

</span>+ (<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">)classMethod1;

</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span>

<span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">-----------------------------------------------------------
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> MyClass.m</span>

<span style="line-height:1.8;color:rgb(0,0,255);">#import</span> <span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">MyClass.h</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>

<span style="line-height:1.8;color:rgb(0,0,255);">@interface</span><span style="line-height:1.8;"> MyClass () {
    NSInteger _instance1;
    NSString </span>*<span style="line-height:1.8;">_instance2;
}
@property (nonatomic, assign) NSUInteger integer;
</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span>)method3WithArg1:(NSInteger)arg1 arg2:(NSString *<span style="line-height:1.8;">)arg2;
</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span>

<span style="line-height:1.8;color:rgb(0,0,255);">@implementation</span><span style="line-height:1.8;"> MyClass

</span>+ (<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">)classMethod1 {

}

</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">)method1 {
    NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">call method method1</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);
}

</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">)method2 {

}

</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span>)method3WithArg1:(NSInteger)arg1 arg2:(NSString *<span style="line-height:1.8;">)arg2 {

    NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">arg1 : %ld, arg2 : %@</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, arg1, arg2);
}

</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span>

<span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">-----------------------------------------------------------
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> main.h</span>

<span style="line-height:1.8;color:rgb(0,0,255);">#import</span> <span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">MyClass.h</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>
<span style="line-height:1.8;color:rgb(0,0,255);">#import</span> <span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">MySubClass.h</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>
<span style="line-height:1.8;color:rgb(0,0,255);">#import</span> &lt;objc/runtime.h&gt;

<span style="line-height:1.8;color:rgb(0,0,255);">int</span> main(<span style="line-height:1.8;color:rgb(0,0,255);">int</span> argc, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;"> argv[]) {
    @autoreleasepool {

        MyClass </span>*myClass =<span style="line-height:1.8;"> [[MyClass alloc] init];
        unsigned </span><span style="line-height:1.8;color:rgb(0,0,255);">int</span> outCount = <span style="line-height:1.8;color:rgb(128,0,128);">0</span><span style="line-height:1.8;">;

        Class cls </span>= myClass.<span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;">;

        </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 类名</span>
        NSLog(<span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">class name: %s</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, class_getName(cls));

        NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">==========================================================</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);

        </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 父类</span>
        NSLog(<span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">super class name: %s</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, class_getName(class_getSuperclass(cls)));
        NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">==========================================================</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);

        </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 是否是元类</span>
        NSLog(<span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">MyClass is %@ a meta-class</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>, (class_isMetaClass(cls) ? <span style="line-height:1.8;color:rgb(128,0,0);">@""</span> : <span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">not</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">));
        NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">==========================================================</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);

        Class meta_class </span>=<span style="line-height:1.8;"> objc_getMetaClass(class_getName(cls));
        NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">%s's meta-class is %s</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, class_getName(cls), class_getName(meta_class));
        NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">==========================================================</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);

        </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 变量实例大小</span>
        NSLog(<span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">instance size: %zu</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, class_getInstanceSize(cls));
        NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">==========================================================</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);

        </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 成员变量</span>
        Ivar *ivars = class_copyIvarList(cls, &amp;<span style="line-height:1.8;">outCount);
        </span><span style="line-height:1.8;color:rgb(0,0,255);">for</span> (<span style="line-height:1.8;color:rgb(0,0,255);">int</span> i = <span style="line-height:1.8;color:rgb(128,0,128);">0</span>; i &lt; outCount; i++<span style="line-height:1.8;">) {
            Ivar ivar </span>=<span style="line-height:1.8;"> ivars[i];
            NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">instance variable's name: %s at index: %d</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, ivar_getName(ivar), i);
        }

        free(ivars);

        Ivar </span><span style="line-height:1.8;color:rgb(0,0,255);">string</span> = class_getInstanceVariable(cls, <span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">_string</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);
        </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (<span style="line-height:1.8;color:rgb(0,0,255);">string</span> !=<span style="line-height:1.8;"> NULL) {
            NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">instace variable %s</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>, ivar_getName(<span style="line-height:1.8;color:rgb(0,0,255);">string</span><span style="line-height:1.8;">));
        }

        NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">==========================================================</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);

        </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 属性操作</span>
        objc_property_t * properties = class_copyPropertyList(cls, &amp;<span style="line-height:1.8;">outCount);
        </span><span style="line-height:1.8;color:rgb(0,0,255);">for</span> (<span style="line-height:1.8;color:rgb(0,0,255);">int</span> i = <span style="line-height:1.8;color:rgb(128,0,128);">0</span>; i &lt; outCount; i++<span style="line-height:1.8;">) {
            objc_property_t property </span>=<span style="line-height:1.8;"> properties[i];
            NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">property's name: %s</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, property_getName(property));
        }

        free(properties);

        objc_property_t array </span>= class_getProperty(cls, <span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">array</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);
        </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (array !=<span style="line-height:1.8;"> NULL) {
            NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">property %s</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, property_getName(array));
        }

        NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">==========================================================</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);

        </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 方法操作</span>
        Method *methods = class_copyMethodList(cls, &amp;<span style="line-height:1.8;">outCount);
        </span><span style="line-height:1.8;color:rgb(0,0,255);">for</span> (<span style="line-height:1.8;color:rgb(0,0,255);">int</span> i = <span style="line-height:1.8;color:rgb(128,0,128);">0</span>; i &lt; outCount; i++<span style="line-height:1.8;">) {
            Method method </span>=<span style="line-height:1.8;"> methods[i];
            NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">method's signature: %s</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, method_getName(method));
        }

        free(methods);

        Method method1 </span>=<span style="line-height:1.8;"> class_getInstanceMethod(cls, @selector(method1));
        </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (method1 !=<span style="line-height:1.8;"> NULL) {
            NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">method %s</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, method_getName(method1));
        }

        Method classMethod </span>=<span style="line-height:1.8;"> class_getClassMethod(cls, @selector(classMethod1));
        </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (classMethod !=<span style="line-height:1.8;"> NULL) {
            NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">class method : %s</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, method_getName(classMethod));
        }

        NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">MyClass is%@ responsd to selector: method3WithArg1:arg2:</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>, class_respondsToSelector(cls, @selector(method3WithArg1:arg2:)) ? <span style="line-height:1.8;color:rgb(128,0,0);">@""</span> : <span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);"> not</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);

        IMP imp </span>=<span style="line-height:1.8;"> class_getMethodImplementation(cls, @selector(method1));
        imp();

        NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">==========================================================</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);

        </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 协议</span>
        Protocol * __unsafe_unretained * protocols = class_copyProtocolList(cls, &amp;<span style="line-height:1.8;">outCount);
        Protocol </span>*<span style="line-height:1.8;"> protocol;
        </span><span style="line-height:1.8;color:rgb(0,0,255);">for</span> (<span style="line-height:1.8;color:rgb(0,0,255);">int</span> i = <span style="line-height:1.8;color:rgb(128,0,128);">0</span>; i &lt; outCount; i++<span style="line-height:1.8;">) {
            protocol </span>=<span style="line-height:1.8;"> protocols[i];
            NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">protocol name: %s</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, protocol_getName(protocol));
        }

        NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">MyClass is%@ responsed to protocol %s</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>, class_conformsToProtocol(cls, protocol) ? <span style="line-height:1.8;color:rgb(128,0,0);">@""</span> : <span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);"> not</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, protocol_getName(protocol));

        NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">==========================================================</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);
    }
    </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span> <span style="line-height:1.8;color:rgb(128,0,128);">0</span><span style="line-height:1.8;">;
}</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p><strong><span style="line-height:1.8;font-family:'楷体';font-size:16px;">这段程序的输出如下：</span></strong></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.452</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;"> name: MyClass
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.453</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] ==========================================================
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.454</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] super <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;"> name: NSObject
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.454</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] ==========================================================
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.454</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] MyClass <span style="line-height:1.8;color:rgb(0,0,255);">is</span> not a meta-<span style="line-height:1.8;color:rgb(0,0,255);">class</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.454</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] ==========================================================
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.454</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] MyClass<span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">s meta-class is MyClass</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.455</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] ==========================================================
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.455</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] instance size: <span style="line-height:1.8;color:rgb(128,0,128);">48</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.455</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] ==========================================================
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.455</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] instance variable<span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">s name: _instance1 at index: 0</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.455</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] instance variable<span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">s name: _instance2 at index: 1</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.455</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] instance variable<span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">s name: _array at index: 2</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.455</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] instance variable<span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">s name: _string at index: 3</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.463</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] instance variable<span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">s name: _integer at index: 4</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.463</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span><span style="line-height:1.8;">] instace variable _string
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.463</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] ==========================================================
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.463</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] property<span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">s name: array</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.463</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] property<span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">s name: string</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.464</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] property<span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">s name: integer</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.464</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span><span style="line-height:1.8;">] property array
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.464</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] ==========================================================
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.464</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] method<span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">s signature: method1</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.464</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] method<span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">s signature: method2</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.464</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] method<span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">s signature: method3WithArg1:arg2:</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.465</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] method<span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">s signature: integer</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.465</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] method<span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">s signature: setInteger:</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.465</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] method<span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">s signature: array</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.465</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] method<span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">s signature: string</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.465</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] method<span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">s signature: setString:</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.465</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] method<span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">s signature: setArray:</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.466</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] method<span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">s signature: .cxx_destruct</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.466</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span><span style="line-height:1.8;">] method method1
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.466</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;"> method : classMethod1
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.466</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] MyClass <span style="line-height:1.8;color:rgb(0,0,255);">is</span><span style="line-height:1.8;"> responsd to selector: method3WithArg1:arg2:
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.467</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span><span style="line-height:1.8;">] call method method1
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.467</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] ==========================================================
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.467</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span><span style="line-height:1.8;">] protocol name: NSCopying
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.467</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span><span style="line-height:1.8;">] protocol name: NSCoding
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.467</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] MyClass <span style="line-height:1.8;color:rgb(0,0,255);">is</span><span style="line-height:1.8;"> responsed to protocol NSCoding
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">22</span> <span style="line-height:1.8;color:rgb(128,0,128);">19</span>:<span style="line-height:1.8;color:rgb(128,0,128);">41</span>:<span style="line-height:1.8;color:rgb(128,0,128);">37.468</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3189</span>:<span style="line-height:1.8;color:rgb(128,0,128);">156810</span>] ==========================================================</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">动态创建类和对象</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">runtime的强大之处在于它能在运行时创建类和对象。</span></p> 
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">1.动态创建类</span></h4> 
      <p><strong><span style="line-height:1.8;font-family:'楷体';font-size:16px;">动态创建类涉及到以下几个函数：</span></strong></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 创建一个新类和元类</span>
Class objc_allocateClassPair ( Class superclass, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;">name, size_t extraBytes );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 销毁一个类及其相关联的类</span>
<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;"> objc_disposeClassPair ( Class cls );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 在应用中注册由objc_allocateClassPair创建的类</span>
<span style="line-height:1.8;color:rgb(0,0,255);">void</span> objc_registerClassPair ( Class cls );</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <ul>
       <li style="list-style:disc;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">objc_allocateClassPair函数：如果我们要创建一个根类，则superclass指定为Nil。extraBytes通常指定为0，该参数是分配给类和元类对象尾部的索引ivars的字节数。</span></li> 
       <li style="list-style:disc;"> <span style="line-height:1.8;font-family:'楷体';font-size:16px;">为了创建一个新类，我们需要调用objc_allocateClassPair。然后使用诸如class_addMethod，class_addIvar等函数来为新创建的类添加方法、实例变量和属性等。完成这些后，我们需要调用objc_registerClassPair函数来注册类，之后这个新类就可以在程序中使用了。</span><span style="line-height:1.8;font-family:'楷体';font-size:16px;">实例方法和实例变量应该添加到类自身上，而类方法应该添加到类的元类上。</span> </li> 
       <li style="list-style:disc;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">objc_disposeClassPair函数用于销毁一个类，不过需要注意的是，如果程序运行中还存在类或其子类的实例，则不能调用针对类调用该方法。</span></li> 
      </ul>
      <p><strong><span style="line-height:1.8;font-family:'楷体';font-size:16px;">在前面介绍元类时，我们已经有接触到这几个函数了，在此我们再举个实例来看看这几个函数的使用。</span></strong></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre>Class cls = objc_allocateClassPair(MyClass.<span style="line-height:1.8;color:rgb(0,0,255);">class</span>, <span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">MySubClass</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>, <span style="line-height:1.8;color:rgb(128,0,128);">0</span><span style="line-height:1.8;">);
class_addMethod(cls, @selector(submethod1), (IMP)imp_submethod1, </span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">v@:</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);
class_replaceMethod(cls, @selector(method1), (IMP)imp_submethod1, </span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">v@:</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);
class_addIvar(cls, </span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">_ivar1</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>, <span style="line-height:1.8;color:rgb(0,0,255);">sizeof</span>(NSString *), log(<span style="line-height:1.8;color:rgb(0,0,255);">sizeof</span>(NSString *)), <span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">i</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);

objc_property_attribute_t type </span>= {<span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">T</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>, <span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">@\"NSString\"</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">};
objc_property_attribute_t ownership </span>= { <span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">C</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>, <span style="line-height:1.8;color:rgb(128,0,0);">""</span><span style="line-height:1.8;"> };
objc_property_attribute_t backingivar </span>= { <span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">V</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>, <span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">_ivar1</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">};
objc_property_attribute_t attrs[] </span>=<span style="line-height:1.8;"> {type, ownership, backingivar};

class_addProperty(cls, </span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">property2</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>, attrs, <span style="line-height:1.8;color:rgb(128,0,128);">3</span><span style="line-height:1.8;">);
objc_registerClassPair(cls);

</span><span style="line-height:1.8;color:rgb(0,0,255);">id</span> instance =<span style="line-height:1.8;"> [[cls alloc] init];
[instance performSelector:@selector(submethod1)];
[instance performSelector:@selector(method1)];</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p><strong><span style="line-height:1.8;font-family:'楷体';font-size:16px;">程序的输出如下：</span></strong></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">23</span> <span style="line-height:1.8;color:rgb(128,0,128);">11</span>:<span style="line-height:1.8;color:rgb(128,0,128);">35</span>:<span style="line-height:1.8;color:rgb(128,0,128);">31.006</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3800</span>:<span style="line-height:1.8;color:rgb(128,0,128);">66152</span>] run sub method <span style="line-height:1.8;color:rgb(128,0,128);">1</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">23</span> <span style="line-height:1.8;color:rgb(128,0,128);">11</span>:<span style="line-height:1.8;color:rgb(128,0,128);">35</span>:<span style="line-height:1.8;color:rgb(128,0,128);">31.006</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">3800</span>:<span style="line-height:1.8;color:rgb(128,0,128);">66152</span>] run sub method <span style="line-height:1.8;color:rgb(128,0,128);">1</span></pre>
      </div> 
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">2.动态创建对象</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">动态创建对象的函数如下：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 创建类实例</span>
<span style="line-height:1.8;color:rgb(0,0,255);">id</span><span style="line-height:1.8;"> class_createInstance ( Class cls, size_t extraBytes );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 在指定位置创建类实例</span>
<span style="line-height:1.8;color:rgb(0,0,255);">id</span> objc_constructInstance ( Class cls, <span style="line-height:1.8;color:rgb(0,0,255);">void</span> *<span style="line-height:1.8;">bytes );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 销毁类实例</span>
<span style="line-height:1.8;color:rgb(0,0,255);">void</span> * objc_destructInstance ( <span style="line-height:1.8;color:rgb(0,0,255);">id</span> obj );</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <ul>
       <li style="list-style:disc;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">class_createInstance函数：创建实例时，会在默认的内存区域为类分配内存。extraBytes参数表示分配的额外字节数。这些额外的字节可用于存储在类定义中所定义的实例变量之外的实例变量。该函数在ARC环境下无法使用。</span></li>
      </ul>
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">调用class_createInstance的效果与+alloc方法类似。不过在使用class_createInstance时，我们需要确切的知道我们要用它来做什么。在下面的例子中，我们用NSString来测试一下该函数的实际效果：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">id</span> theObject = class_createInstance(NSString.<span style="line-height:1.8;color:rgb(0,0,255);">class</span>, <span style="line-height:1.8;color:rgb(0,0,255);">sizeof</span><span style="line-height:1.8;">(unsigned));
</span><span style="line-height:1.8;color:rgb(0,0,255);">id</span> str1 =<span style="line-height:1.8;"> [theObject init];

NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">%@</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>, [str1 <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;">]);

</span><span style="line-height:1.8;color:rgb(0,0,255);">id</span> str2 = [[NSString alloc] initWithString:<span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">test</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">];
NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">%@</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>, [str2 <span style="line-height:1.8;color:rgb(0,0,255);">class</span>]);</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">输出结果是：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">23</span> <span style="line-height:1.8;color:rgb(128,0,128);">12</span>:<span style="line-height:1.8;color:rgb(128,0,128);">46</span>:<span style="line-height:1.8;color:rgb(128,0,128);">50.781</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">4039</span>:<span style="line-height:1.8;color:rgb(128,0,128);">89088</span><span style="line-height:1.8;">] NSString
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">23</span> <span style="line-height:1.8;color:rgb(128,0,128);">12</span>:<span style="line-height:1.8;color:rgb(128,0,128);">46</span>:<span style="line-height:1.8;color:rgb(128,0,128);">50.781</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">4039</span>:<span style="line-height:1.8;color:rgb(128,0,128);">89088</span>] __NSCFConstantString</pre>
      </div> 
      <ul>
       <li style="list-style:disc;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">可以看到，使用class_createInstance函数获取的是NSString实例，而不是类簇中的默认占位符类__NSCFConstantString。</span></li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">objc_constructInstance函数：在指定的位置(bytes)创建类实例。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">objc_destructInstance函数：销毁一个类的实例，但不会释放并移除任何与其相关的引用。</span></p> </li> 
      </ul>
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">实例操作函数</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">实例操作函数主要是针对我们创建的实例对象的一系列操作函数，我们可以使用这组函数来从实例对象中获取我们想要的一些信息，如实例对象中变量的值。这组函数可以分为三小类：</span></p> 
      <p><strong><span style="line-height:1.8;font-family:'楷体';font-size:16px;">1.针对整个对象进行操作的函数，这类函数包含</span></strong></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 返回指定对象的一份拷贝</span>
<span style="line-height:1.8;color:rgb(0,0,255);">id</span> object_copy ( <span style="line-height:1.8;color:rgb(0,0,255);">id</span><span style="line-height:1.8;"> obj, size_t size );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 释放指定对象占用的内存</span>
<span style="line-height:1.8;color:rgb(0,0,255);">id</span> object_dispose ( <span style="line-height:1.8;color:rgb(0,0,255);">id</span> obj );</pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">有这样一种场景，假设我们有类A和类B，且类B是类A的子类。类B通过添加一些额外的属性来扩展类A。现在我们创建了一个A类的实例对象，并希望在运行时将这个对象转换为B类的实例对象，这样可以添加数据到B类的属性中。这种情况下，我们没有办法直接转换，因为B类的实例会比A类的实例更大，没有足够的空间来放置对象。此时，我们就要以使用以上几个函数来处理这种情况，如下代码所示：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre>NSObject *a =<span style="line-height:1.8;"> [[NSObject alloc] init];
</span><span style="line-height:1.8;color:rgb(0,0,255);">id</span> newB = object_copy(a, class_getInstanceSize(MyClass.<span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;">));
object_setClass(newB, MyClass.</span><span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;">);
object_dispose(a);</span></pre>
      </div> 
      <p><strong><span style="line-height:1.8;font-family:'楷体';font-size:16px;">2.针对对象实例变量进行操作的函数，这类函数包含：</span></strong></p> 
      <p>&nbsp;</p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 修改类实例的实例变量的值</span>
Ivar object_setInstanceVariable ( <span style="line-height:1.8;color:rgb(0,0,255);">id</span> obj, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *name, <span style="line-height:1.8;color:rgb(0,0,255);">void</span> *<span style="line-height:1.8;">value );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取对象实例变量的值</span>
Ivar object_getInstanceVariable ( <span style="line-height:1.8;color:rgb(0,0,255);">id</span> obj, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *name, <span style="line-height:1.8;color:rgb(0,0,255);">void</span> **<span style="line-height:1.8;">outValue );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 返回指向给定对象分配的任何额外字节的指针</span>
<span style="line-height:1.8;color:rgb(0,0,255);">void</span> * object_getIndexedIvars ( <span style="line-height:1.8;color:rgb(0,0,255);">id</span><span style="line-height:1.8;"> obj );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 返回对象中实例变量的值</span>
<span style="line-height:1.8;color:rgb(0,0,255);">id</span> object_getIvar ( <span style="line-height:1.8;color:rgb(0,0,255);">id</span><span style="line-height:1.8;"> obj, Ivar ivar );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 设置对象中实例变量的值</span>
<span style="line-height:1.8;color:rgb(0,0,255);">void</span> object_setIvar ( <span style="line-height:1.8;color:rgb(0,0,255);">id</span> obj, Ivar ivar, <span style="line-height:1.8;color:rgb(0,0,255);">id</span> value );</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p>&nbsp;</p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">如果实例变量的Ivar已经知道，那么调用object_getIvar会比object_getInstanceVariable函数快，相同情况下，object_setIvar也比object_setInstanceVariable快。</span></p> 
      <p><strong><span style="line-height:1.8;font-family:'楷体';font-size:16px;">3.针对对象的类进行操作的函数，这类函数包含：</span></strong></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 返回给定对象的类名</span>
<span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> * object_getClassName ( <span style="line-height:1.8;color:rgb(0,0,255);">id</span><span style="line-height:1.8;"> obj );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 返回对象的类</span>
Class object_getClass ( <span style="line-height:1.8;color:rgb(0,0,255);">id</span><span style="line-height:1.8;"> obj );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 设置对象的类</span>
Class object_setClass ( <span style="line-height:1.8;color:rgb(0,0,255);">id</span> obj, Class cls );</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">获取类定义</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Objective-C动态运行库会自动注册我们代码中定义的所有的类。我们也可以在运行时创建类定义并使用objc_addClass函数来注册它们。runtime提供了一系列函数来获取类定义相关的信息，这些函数主要包括：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取已注册的类定义的列表</span>
<span style="line-height:1.8;color:rgb(0,0,255);">int</span> objc_getClassList ( Class *buffer, <span style="line-height:1.8;color:rgb(0,0,255);">int</span><span style="line-height:1.8;"> bufferCount );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 创建并返回一个指向所有已注册类的指针列表</span>
Class * objc_copyClassList ( unsigned <span style="line-height:1.8;color:rgb(0,0,255);">int</span> *<span style="line-height:1.8;">outCount );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 返回指定类的类定义</span>
Class objc_lookUpClass ( <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;">name );
Class objc_getClass ( </span><span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;">name );
Class objc_getRequiredClass ( </span><span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;">name );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 返回指定类的元类</span>
Class objc_getMetaClass ( <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *name );</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <ul>
       <li style="list-style:disc;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">objc_getClassList函数：获取已注册的类定义的列表。我们不能假设从该函数中获取的类对象是继承自NSObject体系的，所以在这些类上调用方法是，都应该先检测一下这个方法是否在这个类中实现。</span></li>
      </ul>
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">下面代码演示了该函数的用法：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">int</span><span style="line-height:1.8;"> numClasses;
Class </span>* classes =<span style="line-height:1.8;"> NULL;

numClasses </span>= objc_getClassList(NULL, <span style="line-height:1.8;color:rgb(128,0,128);">0</span><span style="line-height:1.8;">);
</span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (numClasses &gt; <span style="line-height:1.8;color:rgb(128,0,128);">0</span><span style="line-height:1.8;">) {
    classes </span>= malloc(<span style="line-height:1.8;color:rgb(0,0,255);">sizeof</span>(Class) *<span style="line-height:1.8;"> numClasses);
    numClasses </span>=<span style="line-height:1.8;"> objc_getClassList(classes, numClasses);<br>
NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">number of classes: %d</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, numClasses);

    </span><span style="line-height:1.8;color:rgb(0,0,255);">for</span> (<span style="line-height:1.8;color:rgb(0,0,255);">int</span> i = <span style="line-height:1.8;color:rgb(128,0,128);">0</span>; i &lt; numClasses; i++<span style="line-height:1.8;">) {
        Class cls </span>=<span style="line-height:1.8;"> classes[i];
        NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">class name: %s</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, class_getName(cls));
    }
    free(classes);
}</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">输出结果如下：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">23</span> <span style="line-height:1.8;color:rgb(128,0,128);">16</span>:<span style="line-height:1.8;color:rgb(128,0,128);">20</span>:<span style="line-height:1.8;color:rgb(128,0,128);">52.589</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">8437</span>:<span style="line-height:1.8;color:rgb(128,0,128);">188589</span>] number of classes: <span style="line-height:1.8;color:rgb(128,0,128);">1282</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">23</span> <span style="line-height:1.8;color:rgb(128,0,128);">16</span>:<span style="line-height:1.8;color:rgb(128,0,128);">20</span>:<span style="line-height:1.8;color:rgb(128,0,128);">52.589</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">8437</span>:<span style="line-height:1.8;color:rgb(128,0,128);">188589</span>] <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;"> name: DDTokenRegexp
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">23</span> <span style="line-height:1.8;color:rgb(128,0,128);">16</span>:<span style="line-height:1.8;color:rgb(128,0,128);">20</span>:<span style="line-height:1.8;color:rgb(128,0,128);">52.590</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">8437</span>:<span style="line-height:1.8;color:rgb(128,0,128);">188589</span>] <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;"> name: _NSMostCommonKoreanCharsKeySet
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">23</span> <span style="line-height:1.8;color:rgb(128,0,128);">16</span>:<span style="line-height:1.8;color:rgb(128,0,128);">20</span>:<span style="line-height:1.8;color:rgb(128,0,128);">52.590</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">8437</span>:<span style="line-height:1.8;color:rgb(128,0,128);">188589</span>] <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;"> name: OS_xpc_dictionary
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">23</span> <span style="line-height:1.8;color:rgb(128,0,128);">16</span>:<span style="line-height:1.8;color:rgb(128,0,128);">20</span>:<span style="line-height:1.8;color:rgb(128,0,128);">52.590</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">8437</span>:<span style="line-height:1.8;color:rgb(128,0,128);">188589</span>] <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;"> name: NSFileCoordinator
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">23</span> <span style="line-height:1.8;color:rgb(128,0,128);">16</span>:<span style="line-height:1.8;color:rgb(128,0,128);">20</span>:<span style="line-height:1.8;color:rgb(128,0,128);">52.590</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">8437</span>:<span style="line-height:1.8;color:rgb(128,0,128);">188589</span>] <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;"> name: NSAssertionHandler
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">23</span> <span style="line-height:1.8;color:rgb(128,0,128);">16</span>:<span style="line-height:1.8;color:rgb(128,0,128);">20</span>:<span style="line-height:1.8;color:rgb(128,0,128);">52.590</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">8437</span>:<span style="line-height:1.8;color:rgb(128,0,128);">188589</span>] <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;"> name: PFUbiquityTransactionLogMigrator
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">23</span> <span style="line-height:1.8;color:rgb(128,0,128);">16</span>:<span style="line-height:1.8;color:rgb(128,0,128);">20</span>:<span style="line-height:1.8;color:rgb(128,0,128);">52.591</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">8437</span>:<span style="line-height:1.8;color:rgb(128,0,128);">188589</span>] <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;"> name: NSNotification
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">23</span> <span style="line-height:1.8;color:rgb(128,0,128);">16</span>:<span style="line-height:1.8;color:rgb(128,0,128);">20</span>:<span style="line-height:1.8;color:rgb(128,0,128);">52.591</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">8437</span>:<span style="line-height:1.8;color:rgb(128,0,128);">188589</span>] <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;"> name: NSKeyValueNilSetEnumerator
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">23</span> <span style="line-height:1.8;color:rgb(128,0,128);">16</span>:<span style="line-height:1.8;color:rgb(128,0,128);">20</span>:<span style="line-height:1.8;color:rgb(128,0,128);">52.591</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">8437</span>:<span style="line-height:1.8;color:rgb(128,0,128);">188589</span>] <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;"> name: OS_tcp_connection_tls_session
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">23</span> <span style="line-height:1.8;color:rgb(128,0,128);">16</span>:<span style="line-height:1.8;color:rgb(128,0,128);">20</span>:<span style="line-height:1.8;color:rgb(128,0,128);">52.591</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">8437</span>:<span style="line-height:1.8;color:rgb(128,0,128);">188589</span>] <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;"> name: _PFRoutines
......还有大量输出</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <ul>
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">获取类定义的方法有三个：objc_lookUpClass, objc_getClass和objc_getRequiredClass。如果类在运行时未注册，则objc_lookUpClass会返回nil，而objc_getClass会调用类处理回调，并再次确认类是否注册，如果确认未注册，再返回nil。而objc_getRequiredClass函数的操作与objc_getClass相同，只不过如果没有找到类，则会杀死进程。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">objc_getMetaClass函数：如果指定的类没有注册，则该函数会调用类处理回调，并再次确认类是否注册，如果确认未注册，再返回nil。不过，每个类定义都必须有一个有效的元类定义，所以这个函数总是会返回一个元类定义，不管它是否有效。</span></p> </li> 
      </ul>
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">小结</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">在这一章中我们介绍了Runtime运行时中与类和对象相关的数据结构，通过这些数据函数，我们可以管窥Objective-C底层面向对象实现的一些信息。另外，通过丰富的操作函数，可以灵活地对这些数据进行操作。</span></p> 
      <h2 style="color:rgb(0,0,0);line-height:1.5;font-size:21px;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">成员和成员属性</span></h2> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">在前面一篇文章中，我们介绍了Runtime中与类和对象相关的内容，从这章开始，我们将讨论类实现细节相关的内容，主要包括类中成员变量，属性，方法，协议与分类的实现。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">本章的主要内容将聚集在Runtime对成员变量与属性的处理。在讨论之前，我们先介绍一个重要的概念：类型编码。</span></p> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">类型编码(Type Encoding)</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">作为对Runtime的补充，编译器将每个方法的返回值和参数类型编码为一个字符串，并将其与方法的selector关联在一起。这种编码方案在其它情况下也是非常有用的，因此我们可以使用@encode编译器指令来获取它。当给定一个类型时，@encode返回这个类型的字符串编码。这些类型可以是诸如int、指针这样的基本类型，也可以是结构体、类等类型。事实上，任何可以作为sizeof()操作参数的类型都可以用于@encode()。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">在Objective-C Runtime Programming Guide中的Type Encoding一节中，列出了Objective-C中所有的类型编码。需要注意的是这些类型很多是与我们用于存档和分发的编码类型是相同的。但有一些不能在存档时使用。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">注：Objective-C不支持long double类型。@encode(long double)返回d，与double是一样的。</span></p> 
      <p><strong><span style="line-height:1.8;font-family:'楷体';font-size:16px;">一个数组的类型编码位于方括号中；其中包含数组元素的个数及元素类型。如以下示例：</span></strong></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">float</span> a[] = {<span style="line-height:1.8;color:rgb(128,0,128);">1.0</span>, <span style="line-height:1.8;color:rgb(128,0,128);">2.0</span>, <span style="line-height:1.8;color:rgb(128,0,128);">3.0</span><span style="line-height:1.8;">};
NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">array encoding type: %s</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>, @encode(<span style="line-height:1.8;color:rgb(0,0,255);">typeof</span>(a)));</pre>
      </div> 
      <p><strong><span style="line-height:1.8;font-family:'楷体';font-size:16px;">输出是：</span></strong></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">28</span> <span style="line-height:1.8;color:rgb(128,0,128);">11</span>:<span style="line-height:1.8;color:rgb(128,0,128);">44</span>:<span style="line-height:1.8;color:rgb(128,0,128);">54.731</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">942</span>:<span style="line-height:1.8;color:rgb(128,0,128);">50791</span>] array encoding type: [3f]</pre>
      </div> 
      <ul>
       <li style="list-style:disc;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">其它类型可参考Type Encoding，在此不细说。</span></li> 
       <li style="list-style:disc;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">另外，还有些编码类型，@encode虽然不会直接返回它们，但它们可以作为协议中声明的方法的类型限定符。可以参考Type Encoding。</span></li> 
       <li style="list-style:disc;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">对于属性而言，还会有一些特殊的类型编码，以表明属性是只读、拷贝、retain等等，详情可以参考Property Type String。</span></li> 
      </ul>
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">成员变量、属性</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Runtime中关于成员变量和属性的相关数据结构并不多，只有三个，并且都很简单。不过还有个非常实用但可能经常被忽视的特性，即关联对象，我们将在这小节中详细讨论。</span></p> 
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">基础数据类型</span></h4> 
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Ivar</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Ivar是表示实例变量的类型，其实际是一个指向objc_ivar结构体的指针，其定义如下：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre>typedef <span style="line-height:1.8;color:rgb(0,0,255);">struct</span> objc_ivar *<span style="line-height:1.8;">Ivar;

</span><span style="line-height:1.8;color:rgb(0,0,255);">struct</span><span style="line-height:1.8;"> objc_ivar {
    </span><span style="line-height:1.8;color:rgb(0,0,255);">char</span> *ivar_name                 OBJC2_UNAVAILABLE;  <span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 变量名</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *ivar_type                 OBJC2_UNAVAILABLE;  <span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 变量类型</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">int</span> ivar_offset                 OBJC2_UNAVAILABLE;  <span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 基地址偏移字节</span>
<span style="line-height:1.8;color:rgb(0,0,255);">#ifdef</span><span style="line-height:1.8;"> __LP64__
    </span><span style="line-height:1.8;color:rgb(0,0,255);">int</span><span style="line-height:1.8;"> space                       OBJC2_UNAVAILABLE;
</span><span style="line-height:1.8;color:rgb(0,0,255);">#endif</span><span style="line-height:1.8;">
}</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">objc_property_t</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">objc_property_t是表示Objective-C声明的属性的类型，其实际是指向objc_property结构体的指针，其定义如下：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre>typedef <span style="line-height:1.8;color:rgb(0,0,255);">struct</span> objc_property *objc_property_t;</pre>
      </div> 
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">objc_property_attribute_t</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">objc_property_attribute_t定义了属性的特性(attribute)，它是一个结构体，定义如下：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre>typedef <span style="line-height:1.8;color:rgb(0,0,255);">struct</span><span style="line-height:1.8;"> {
    </span><span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *name;           <span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 特性名</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *value;          <span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 特性值</span>
} objc_property_attribute_t;</pre>
      </div> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">关联对象(Associated Object)</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">关联对象是Runtime中一个非常实用的特性，不过可能很容易被忽视。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">关联对象类似于成员变量，不过是在运行时添加的。我们通常会把成员变量(Ivar)放在类声明的头文件中，或者放在类实现的@implementation后面。但这有一个缺点，我们不能在分类中添加成员变量。如果我们尝试在分类中添加新的成员变量，编译器会报错。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">我们可能希望通过使用(甚至是滥用)全局变量来解决这个问题。但这些都不是Ivar，因为他们不会连接到一个单独的实例。因此，这种方法很少使用。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Objective-C针对这一问题，提供了一个解决方案：即关联对象(Associated Object)。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">我们可以把关联对象想象成一个Objective-C对象(如字典)，这个对象通过给定的key连接到类的一个实例上。不过由于使用的是C接口，所以key是一个void指针(const void *)。我们还需要指定一个内存管理策略，以告诉Runtime如何管理这个对象的内存。这个内存管理的策略可以由以下值指定：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;">OBJC_ASSOCIATION_ASSIGN
OBJC_ASSOCIATION_RETAIN_NONATOMIC
OBJC_ASSOCIATION_COPY_NONATOMIC
OBJC_ASSOCIATION_RETAIN
OBJC_ASSOCIATION_COPY</span></pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">当宿主对象被释放时，会根据指定的内存管理策略来处理关联对象。如果指定的策略是assign，则宿主释放时，关联对象不会被释放；而如果指定的是retain或者是copy，则宿主释放时，关联对象会被释放。我们甚至可以选择是否是自动retain/copy。当我们需要在多个线程中处理访问关联对象的多线程代码时，这就非常有用了。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">我们将一个对象连接到其它对象所需要做的就是下面两行代码：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">static</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span><span style="line-height:1.8;"> myKey;
objc_setAssociatedObject(self, </span>&amp;myKey, anObject, OBJC_ASSOCIATION_RETAIN);</pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">在这种情况下，self对象将获取一个新的关联的对象anObject，且内存管理策略是自动retain关联对象，当self对象释放时，会自动release关联对象。另外，如果我们使用同一个key来关联另外一个对象时，也会自动释放之前关联的对象，这种情况下，先前的关联对象会被妥善地处理掉，并且新的对象会使用它的内存。</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">id</span> anObject = objc_getAssociatedObject(self, &amp;myKey);</pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">我们可以使用objc_removeAssociatedObjects函数来移除一个关联对象，或者使用objc_setAssociatedObject函数将key指定的关联对象设置为nil。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">我们下面来用实例演示一下关联对象的使用方法。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">假定我们想要动态地将一个Tap手势操作连接到任何UIView中，并且根据需要指定点击后的实际操作。这时候我们就可以将一个手势对象及操作的block对象关联到我们的UIView对象中。这项任务分两部分。首先，如果需要，我们要创建一个手势识别对象并将它及block做为关联对象。如下代码所示：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span>)setTapActionWithBlock:(<span style="line-height:1.8;color:rgb(0,0,255);">void</span> (^)(<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">))block
{
    UITapGestureRecognizer </span>*gesture = objc_getAssociatedObject(self, &amp;<span style="line-height:1.8;">kDTActionHandlerTapGestureKey);

    </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (!<span style="line-height:1.8;">gesture)
    {
        gesture </span>=<span style="line-height:1.8;"> [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(__handleActionForTapGesture:)];
        [self addGestureRecognizer:gesture];
        objc_setAssociatedObject(self, </span>&amp;<span style="line-height:1.8;">kDTActionHandlerTapGestureKey, gesture, OBJC_ASSOCIATION_RETAIN);
    }

    objc_setAssociatedObject(self, </span>&amp;<span style="line-height:1.8;">kDTActionHandlerTapBlockKey, block, OBJC_ASSOCIATION_COPY);
}</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">这段代码检测了手势识别的关联对象。如果没有，则创建并建立关联关系。同时，将传入的块对象连接到指定的key上。注意block对象的关联内存管理策略。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">手势识别对象需要一个target和action，所以接下来我们定义处理方法：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span>)__handleActionForTapGesture:(UITapGestureRecognizer *<span style="line-height:1.8;">)gesture
{
    </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (gesture.state ==<span style="line-height:1.8;"> UIGestureRecognizerStateRecognized)
    {
        </span><span style="line-height:1.8;color:rgb(0,0,255);">void</span>(^action)(<span style="line-height:1.8;color:rgb(0,0,255);">void</span>) = objc_getAssociatedObject(self, &amp;<span style="line-height:1.8;">kDTActionHandlerTapBlockKey);

        </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span><span style="line-height:1.8;"> (action)
        {
            action();
        }
    }
}</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">我们需要检测手势识别对象的状态，因为我们只需要在点击手势被识别出来时才执行操作。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">从上面的例子我们可以看到，关联对象使用起来并不复杂。它让我们可以动态地增强类现有的功能。我们可以在实际编码中灵活地运用这一特性。</span></p> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">成员变量、属性的操作方法</span></h3> 
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">成员变量</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">成员变量操作包含以下函数：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取成员变量名</span>
<span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;"> ivar_getName ( Ivar v );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取成员变量类型编码</span>
<span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;"> ivar_getTypeEncoding ( Ivar v );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取成员变量的偏移量</span>
ptrdiff_t ivar_getOffset ( Ivar v );</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <ul>
       <li style="list-style:disc;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">ivar_getOffset函数，对于类型id或其它对象类型的实例变量，可以调用object_getIvar和object_setIvar来直接访问成员变量，而不使用偏移量。</span></li>
      </ul>
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">关联对象</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">关联对象操作函数包括以下：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 设置关联对象</span>
<span style="line-height:1.8;color:rgb(0,0,255);">void</span> objc_setAssociatedObject ( <span style="line-height:1.8;color:rgb(0,0,255);">id</span> <span style="line-height:1.8;color:rgb(0,0,255);">object</span>, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">void</span> *key, <span style="line-height:1.8;color:rgb(0,0,255);">id</span><span style="line-height:1.8;"> value, objc_AssociationPolicy policy );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取关联对象</span>
<span style="line-height:1.8;color:rgb(0,0,255);">id</span> objc_getAssociatedObject ( <span style="line-height:1.8;color:rgb(0,0,255);">id</span> <span style="line-height:1.8;color:rgb(0,0,255);">object</span>, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">void</span> *<span style="line-height:1.8;">key );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 移除关联对象</span>
<span style="line-height:1.8;color:rgb(0,0,255);">void</span> objc_removeAssociatedObjects ( <span style="line-height:1.8;color:rgb(0,0,255);">id</span> <span style="line-height:1.8;color:rgb(0,0,255);">object</span><span style="line-height:1.8;"> );
关联对象及相关实例已经在前面讨论过了，在此不再重复。</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">属性</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">属性操作相关函数包括以下：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取属性名</span>
<span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;"> property_getName ( objc_property_t property );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取属性特性描述字符串</span>
<span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;"> property_getAttributes ( objc_property_t property );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取属性中指定的特性</span>
<span style="line-height:1.8;color:rgb(0,0,255);">char</span> * property_copyAttributeValue ( objc_property_t property, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;">attributeName );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取属性的特性列表</span>
objc_property_attribute_t * property_copyAttributeList ( objc_property_t property, unsigned <span style="line-height:1.8;color:rgb(0,0,255);">int</span> *outCount );</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <ul>
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">property_copyAttributeValue函数，返回的char *在使用完后需要调用free()释放。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">property_copyAttributeList函数，返回值在使用完后需要调用free()释放。</span></p> </li> 
      </ul>
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">实例</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">假定这样一个场景，我们从服务端两个不同的接口获取相同的字典数据，但这两个接口是由两个人写的，相同的信息使用了不同的字段表示。我们在接收到数据时，可将这些数据保存在相同的对象中。对象类如下定义：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">@interface</span><span style="line-height:1.8;"> MyObject: NSObject

@property (nonatomic, copy) NSString    </span>*<span style="line-height:1.8;">   name;                  
@property (nonatomic, copy) NSString    </span>*<span style="line-height:1.8;">   status;                 

</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">接口A、B返回的字典数据如下所示：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre>@{<span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">name1</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>: <span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">张三</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>, <span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">status1</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>: <span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">start</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">}

@{</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">name2</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>: <span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">张三</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>, <span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">status2</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>: <span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">end</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>}</pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">通常的方法是写两个方法分别做转换，不过如果能灵活地运用Runtime的话，可以只实现一个转换方法，为此，我们需要先定义一个映射字典(全局变量)</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">static</span> NSMutableDictionary *map =<span style="line-height:1.8;"> nil;

</span><span style="line-height:1.8;color:rgb(0,0,255);">@implementation</span><span style="line-height:1.8;"> MyObject

</span>+ (<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">)load
{
    map </span>=<span style="line-height:1.8;"> [NSMutableDictionary dictionary];

    map[</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">name1</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>]                = <span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">name</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">;
    map[</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">status1</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>]              = <span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">status</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">;
    map[</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">name2</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>]                = <span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">name</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">;
    map[</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">status2</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>]              = <span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">status</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">;
}
</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">上面的代码将两个字典中不同的字段映射到MyObject中相同的属性上，这样，转换方法可如下处理：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span>)setDataWithDic:(NSDictionary *<span style="line-height:1.8;">)dic
{
    [dic enumerateKeysAndObjectsUsingBlock:</span>^(NSString *key, <span style="line-height:1.8;color:rgb(0,0,255);">id</span> obj, BOOL *<span style="line-height:1.8;">stop) {

        NSString </span>*propertyKey =<span style="line-height:1.8;"> [self propertyForKey:key];

        </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span><span style="line-height:1.8;"> (propertyKey)
        {
            objc_property_t property </span>= class_getProperty([self <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;">], [propertyKey UTF8String]);

            </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> TODO: 针对特殊数据类型做处理</span>
            NSString *attributeString =<span style="line-height:1.8;"> [NSString stringWithCString:property_getAttributes(property) encoding:NSUTF8StringEncoding];

            ...

            [self setValue:obj forKey:propertyKey];
        }
    }];
}</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">当然，一个属性能否通过上面这种方式来处理的前提是其支持KVC。</span></p> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">小结</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">本章中我们讨论了Runtime中与成员变量和属性相关的内容。成员变量与属性是类的数据基础，合理地使用Runtime中的相关操作能让我们更加灵活地来处理与类数据相关的工作。</span></p> 
      <h2 style="color:rgb(0,0,0);line-height:1.5;font-size:21px;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">方法和消息</span></h2> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">SEL又叫选择器，是表示一个方法的selector的指针，其定义如下：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre>typedef <span style="line-height:1.8;color:rgb(0,0,255);">struct</span> objc_selector *SEL;</pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">objc_selector结构体的详细定义没有在头文件中找到。方法的selector用于表示运行时方 法的名字。Objective-C在编译时，会依据每一个方法的名字、参数序列，生成一个唯一的整型标识(Int类型的地址)，这个标识就是SEL。如下 代码所示：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre>SEL sel1 =<span style="line-height:1.8;"> @selector(method1);
NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">sel : %p</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>, sel1);</pre>
      </div> 
      <span style="line-height:1.8;font-family:'楷体';font-size:16px;">上面的输出为：</span>
      <br>
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">10</span>-<span style="line-height:1.8;color:rgb(128,0,128);">30</span> <span style="line-height:1.8;color:rgb(128,0,128);">18</span>:<span style="line-height:1.8;color:rgb(128,0,128);">40</span>:<span style="line-height:1.8;color:rgb(128,0,128);">07.518</span> RuntimeTest[<span style="line-height:1.8;color:rgb(128,0,128);">52734</span>:<span style="line-height:1.8;color:rgb(128,0,128);">466626</span>] sel : <span style="line-height:1.8;color:rgb(128,0,128);">0x100002d72</span></pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">两个类之间，不管它们是父类与子类的关系，还是之间没有这种关系，只要方法名相同，那么方法的SEL就是一样的。每一个方法都对应着一个SEL。所以在 Objective-C同一个类(及类的继承体系)中，不能存在2个同名的方法，即使参数类型不同也不行。相同的方法只能对应一个SEL。这也就导致 Objective-C在处理相同方法名且参数个数相同但类型不同的方法方面的能力很差。如在某个类中定义以下两个方法：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span>)setWidth:(<span style="line-height:1.8;color:rgb(0,0,255);">int</span><span style="line-height:1.8;">)width;
</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span>)setWidth:(<span style="line-height:1.8;color:rgb(0,0,255);">double</span>)width;</pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">当然，不同的类可以拥有相同的selector，这个没有问题。不同类的实例对象执行相同的selector时，会在各自的方法列表中去根据selector去寻找自己对应的IMP。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">工程中的所有的SEL组成一个Set集合，Set的特点就是唯一，因此SEL是唯一的。因此，如果我们想到这个方法集合中查找某个方法时，只需要去 找到这个方法对应的SEL就行了，SEL实际上就是根据方法名hash化了的一个字符串，而对于字符串的比较仅仅需要比较他们的地址就可以了，可以说速度 上无语伦比！！但是，有一个问题，就是数量增多会增大hash冲突而导致的性能下降（或是没有冲突，因为也可能用的是perfect hash）。但是不管使用什么样的方法加速，如果能够将总量减少（多个方法可能对应同一个SEL），那将是最犀利的方法。那么，我们就不难理解，为什么 SEL仅仅是函数名了。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">本质上，SEL只是一个指向方法的指针（准确的说，只是一个根据方法名hash化了的KEY值，能唯一代表一个方法），它的存在只是为了加快方法的查询速度。这个查找过程我们将在下面讨论。</span></p> 
      <p><strong><span style="line-height:1.8;font-family:'楷体';font-size:16px;">我们可以在运行时添加新的selector，也可以在运行时获取已存在的selector，我们可以通过下面三种方法来获取SEL:</span></strong></p> 
      <ol>
       <li style="list-style:decimal;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">sel_registerName函数</span></p> </li> 
       <li style="list-style:decimal;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Objective-C编译器提供的@selector()</span></p> </li> 
       <li style="list-style:decimal;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">NSSelectorFromString()方法</span></p> </li> 
      </ol>
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">IMP</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">IMP实际上是一个函数指针，指向方法实现的首地址。其定义如下：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">id</span> (*IMP)(<span style="line-height:1.8;color:rgb(0,0,255);">id</span>, SEL, ...)</pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">这个函数使用当前CPU架构实现的标准的C调用约定。第一个参数是指向self的指针(如果是实例方法，则是类实例的内存地址；如果是类方法，则是指向元类的指针)，第二个参数是方法选择器(selector)，接下来是方法的实际参数列表。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">前面介绍过的SEL就是为了查找方法的最终实现IMP的。由于每个方法对应唯一的SEL，因此我们可以通过SEL方便快速准确地获得它所对应的 IMP，查找过程将在下面讨论。取得IMP后，我们就获得了执行这个方法代码的入口点，此时，我们就可以像调用普通的C语言函数一样来使用这个函数指针 了。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">通过取得IMP，我们可以跳过Runtime的消息传递机制，直接执行IMP指向的函数实现，这样省去了Runtime消息传递过程中所做的一系列查找操作，会比直接向对象发送消息高效一些。</span></p> 
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Method</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">介绍完SEL和IMP，我们就可以来讲讲Method了。Method用于表示类定义中的方法，则定义如下：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre>typedef <span style="line-height:1.8;color:rgb(0,0,255);">struct</span> objc_method *<span style="line-height:1.8;">Method;

</span><span style="line-height:1.8;color:rgb(0,0,255);">struct</span><span style="line-height:1.8;"> objc_method {
    SEL method_name                 OBJC2_UNAVAILABLE;  </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 方法名</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;">method_types                  OBJC2_UNAVAILABLE;
    IMP method_imp                      OBJC2_UNAVAILABLE;  </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 方法实现</span>
}</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">我们可以看到该结构体中包含一个SEL和IMP，实际上相当于在SEL和IMP之间作了一个映射。有了SEL，我们便可以找到对应的IMP，从而调用方法的实现代码。具体操作流程我们将在下面讨论。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">objc_method_description</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">objc_method_description定义了一个Objective-C方法，其定义如下：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">struct</span> objc_method_description { SEL name; <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *types; };</pre>
      </div> 
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">方法相关操作函数</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Runtime提供了一系列的方法来处理与方法相关的操作。包括方法本身及SEL。本节我们介绍一下这些函数。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">方法操作相关函数包括下以：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 调用指定方法的实现</span>
<span style="line-height:1.8;color:rgb(0,0,255);">id</span> method_invoke ( <span style="line-height:1.8;color:rgb(0,0,255);">id</span><span style="line-height:1.8;"> receiver, Method m, ... );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 调用返回一个数据结构的方法的实现</span>
<span style="line-height:1.8;color:rgb(0,0,255);">void</span> method_invoke_stret ( <span style="line-height:1.8;color:rgb(0,0,255);">id</span><span style="line-height:1.8;"> receiver, Method m, ... );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取方法名</span>
<span style="line-height:1.8;">SEL method_getName ( Method m );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 返回方法的实现</span>
<span style="line-height:1.8;">IMP method_getImplementation ( Method m );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取描述方法参数和返回值类型的字符串</span>
<span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;"> method_getTypeEncoding ( Method m );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取方法的返回值类型的字符串</span>
<span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;"> method_copyReturnType ( Method m );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取方法的指定位置参数的类型字符串</span>
<span style="line-height:1.8;color:rgb(0,0,255);">char</span> * method_copyArgumentType ( Method m, unsigned <span style="line-height:1.8;color:rgb(0,0,255);">int</span><span style="line-height:1.8;"> index );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 通过引用返回方法的返回值类型字符串</span>
<span style="line-height:1.8;color:rgb(0,0,255);">void</span> method_getReturnType ( Method m, <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;">dst, size_t dst_len );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 返回方法的参数的个数</span>
unsigned <span style="line-height:1.8;color:rgb(0,0,255);">int</span><span style="line-height:1.8;"> method_getNumberOfArguments ( Method m );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 通过引用返回方法指定位置参数的类型字符串</span>
<span style="line-height:1.8;color:rgb(0,0,255);">void</span> method_getArgumentType ( Method m, unsigned <span style="line-height:1.8;color:rgb(0,0,255);">int</span> index, <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;">dst, size_t dst_len );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 返回指定方法的方法描述结构体</span>
<span style="line-height:1.8;color:rgb(0,0,255);">struct</span> objc_method_description *<span style="line-height:1.8;"> method_getDescription ( Method m );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 设置方法的实现</span>
<span style="line-height:1.8;">IMP method_setImplementation ( Method m, IMP imp );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 交换两个方法的实现</span>
<span style="line-height:1.8;color:rgb(0,0,255);">void</span> method_exchangeImplementations ( Method m1, Method m2 );</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <ul>
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">method_invoke函数，返回的是实际实现的返回值。参数receiver不能为空。这个方法的效率会比method_getImplementation和method_getName更快。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">method_getName函数，返回的是一个SEL。如果想获取方法名的C字符串，可以使用sel_getName(method_getName(method))。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">method_getReturnType函数，类型字符串会被拷贝到dst中。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">method_setImplementation函数，注意该函数返回值是方法之前的实现。</span></p> </li> 
      </ul>
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">方法选择器</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">选择器相关的操作函数包括：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 返回给定选择器指定的方法的名称</span>
<span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;"> sel_getName ( SEL sel );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 在Objective-C Runtime系统中注册一个方法，将方法名映射到一个选择器，并返回这个选择器</span>
SEL sel_registerName ( <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;">str );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 在Objective-C Runtime系统中注册一个方法</span>
SEL sel_getUid ( <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;">str );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 比较两个选择器</span>
BOOL sel_isEqual ( SEL lhs, SEL rhs );</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <ul>
       <li style="list-style:disc;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">sel_registerName函数：在我们将一个方法添加到类定义时，我们必须在Objective-C Runtime系统中注册一个方法名以获取方法的选择器。</span></li>
      </ul>
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">方法调用流程</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">在Objective-C中，消息直到运行时才绑定到方法实现上。编译器会将消息表达式[receiver message]转化为一个消息函数的调用，即objc_msgSend。这个函数将消息接收者和方法名作为其基础参数，如以下所示：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre>objc_msgSend(receiver, selector)</pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">如果消息中还有其它参数，则该方法的形式如下所示：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre>objc_msgSend(receiver, selector, arg1, arg2, ...)</pre>
      </div> 
      <p><strong><span style="line-height:1.8;font-family:'楷体';font-size:16px;">这个函数完成了动态绑定的所有事情：</span></strong></p> 
      <ol>
       <li style="list-style:decimal;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">首先它找到selector对应的方法实现。因为同一个方法可能在不同的类中有不同的实现，所以我们需要依赖于接收者的类来找到的确切的实现。</span></p> </li> 
       <li style="list-style:decimal;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">它调用方法实现，并将接收者对象及方法的所有参数传给它。</span></p> </li> 
       <li style="list-style:decimal;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">最后，它将实现返回的值作为它自己的返回值。</span></p> </li> 
      </ol>
      <p><strong><span style="line-height:1.8;font-family:'楷体';font-size:16px;">消息的关键在于我们前面章节讨论过的结构体objc_class，这个结构体有两个字段是我们在分发消息的关注的：</span></strong></p> 
      <ol>
       <li style="list-style:decimal;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">指向父类的指针</span></p> </li> 
       <li style="list-style:decimal;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">一个类的方法分发表，即methodLists。</span></p> </li> 
      </ol>
      <p><strong><span style="line-height:1.8;font-family:'楷体';font-size:16px;">当我们创建一个新对象时，先为其分配内存，并初始化其成员变量。其中isa指针也会被初始化，让对象可以访问类及类的继承体系。</span></strong></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">当消息发送给一个对象时，objc_msgSend通过对象的isa指针获取到类的结构体，然后在方法分发表里面查找方法的selector。如果 没有找到selector，则通过objc_msgSend结构体中的指向父类的指针找到其父类，并在父类的分发表里面查找方法的selector。依 此，会一直沿着类的继承体系到达NSObject类。一旦定位到selector，函数会就获取到了实现的入口点，并传入相应的参数来执行方法的具体实 现。如果最后没有定位到selector，则会走消息转发流程，这个我们在后面讨论。</span><span style="line-height:1.8;font-family:'楷体';font-size:16px;">为了加速消息的处理，运行时系统缓存使用过的selector及对应的方法的地址。这点我们在前面讨论过，不再重复。</span></p> 
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">隐藏参数</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">objc_msgSend有两个隐藏参数：</span></p> 
      <ol>
       <li style="list-style:decimal;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">消息接收对象</span></p> </li> 
       <li style="list-style:decimal;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">方法的selector</span></p> </li> 
      </ol>
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">这两个参数为方法的实现提供了调用者的信息。之所以说是隐藏的，是因为它们在定义方法的源代码中没有声明。它们是在编译期被插入实现代码的。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">虽然这些参数没有显示声明，但在代码中仍然可以引用它们。我们可以使用self来引用接收者对象，使用_cmd来引用选择器。如下代码所示：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre>-<span style="line-height:1.8;"> strange
{
    </span><span style="line-height:1.8;color:rgb(0,0,255);">id</span>  target =<span style="line-height:1.8;"> getTheReceiver();
    SEL method </span>=<span style="line-height:1.8;"> getTheMethod();

    </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> ( target == self || method ==<span style="line-height:1.8;"> _cmd )
        </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> nil;
    </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> [target performSelector:method];
}</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">当然，这两个参数我们用得比较多的是self，_cmd在实际中用得比较少。</span></p> 
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">获取方法地址</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Runtime中方法的动态绑定让我们写代码时更具灵活性，如我们可以把消息转发给我们想要的对象，或者随意交换一个方法的实现等。不过灵活性的提 升也带来了性能上的一些损耗。毕竟我们需要去查找方法的实现，而不像函数调用来得那么直接。当然，方法的缓存一定程度上解决了这一问题。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">我们上面提到过，如果想要避开这种动态绑定方式，我们可以获取方法实现的地址，然后像调用函数一样来直接调用它。特别是当我们需要在一个循环内频繁地调用一个特定的方法时，通过这种方式可以提高程序的性能。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">NSObject类提供了methodForSelector:方法，让我们可以获取到方法的指针，然后通过这个指针来调用实现代码。我们需要将methodForSelector:返回的指针转换为合适的函数类型，函数参数和返回值都需要匹配上。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">我们通过以下代码来看看methodForSelector:的使用：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">void</span> (*setter)(<span style="line-height:1.8;color:rgb(0,0,255);">id</span><span style="line-height:1.8;">, SEL, BOOL);
</span><span style="line-height:1.8;color:rgb(0,0,255);">int</span><span style="line-height:1.8;"> i;

setter </span>= (<span style="line-height:1.8;color:rgb(0,0,255);">void</span> (*)(<span style="line-height:1.8;color:rgb(0,0,255);">id</span><span style="line-height:1.8;">, SEL, BOOL))[target
    methodForSelector:@selector(setFilled:)];
</span><span style="line-height:1.8;color:rgb(0,0,255);">for</span> ( i = <span style="line-height:1.8;color:rgb(128,0,128);">0</span> ; i &lt; <span style="line-height:1.8;color:rgb(128,0,128);">1000</span> ; i++<span style="line-height:1.8;"> )
    setter(targetList[i], @selector(setFilled:), YES);</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">这里需要注意的就是函数指针的前两个参数必须是id和SEL。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">当然这种方式只适合于在类似于for循环这种情况下频繁调用同一方法，以提高性能的情况。另外，methodForSelector:是由Cocoa运行时提供的；它不是Objective-C语言的特性。</span></p> 
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">消息转发</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">当一个对象能接收一个消息时，就会走正常的方法调用流程。但如果一个对象无法接收指定消息时，又会发生什么事呢？默认情况下，如果是以 [object message]的方式调用方法，如果object无法响应message消息时，编译器会报错。但如果是以perform…的形式来调用，则需要等到运 行时才能确定object是否能接收message消息。如果不能，则程序崩溃。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">通常，当我们不能确定一个对象是否能接收某个消息时，会先调用respondsToSelector:来判断一下。如下代码所示：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">if</span><span style="line-height:1.8;"> ([self respondsToSelector:@selector(method)]) {
    [self performSelector:@selector(method)];
}</span></pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">不过，我们这边想讨论下不使用respondsToSelector:判断的情况。这才是我们这一节的重点。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">当一个对象无法接收某一消息时，就会启动所谓”消息转发(message forwarding)“机制，通过这一机制，我们可以告诉对象如何处理未知的消息。默认情况下，对象接收到未知的消息，会导致程序崩溃，通过控制台，我们可以看到以下异常信息：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre>-[SUTRuntimeMethod method]: unrecognized selector sent to instance <span style="line-height:1.8;color:rgb(128,0,128);">0x100111940</span>

*** Terminating app due to uncaught exception <span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">NSInvalidArgumentException</span><span style="line-height:1.8;color:rgb(128,0,0);">'</span>, reason: <span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">-[SUTRuntimeMethod method]: unrecognized selector sent to instance 0x100111940</span><span style="line-height:1.8;color:rgb(128,0,0);">'</span></pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">这段异常信息实际上是由NSObject的”doesNotRecognizeSelector”方法抛出的。不过，我们可以采取一些措施，让我们的程序执行特定的逻辑，而避免程序的崩溃。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">消息转发机制基本上分为三个步骤：</span></p> 
      <ol>
       <li style="list-style:decimal;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">动态方法解析</span></p> </li> 
       <li style="list-style:decimal;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">备用接收者</span></p> </li> 
       <li style="list-style:decimal;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">完整转发</span></p> </li> 
      </ol>
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">下面我们详细讨论一下这三个步骤。</span></p> 
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">动态方法解析</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">对象在接收到未知的消息时，首先会调用所属类的类方法+resolveInstanceMethod:(实例方法)或 者+resolveClassMethod:(类方法)。在这个方法中，我们有机会为该未知消息新增一个”处理方法”“。不过使用该方法的前提是我们已经 实现了该”处理方法”，只需要在运行时通过class_addMethod函数动态添加到类里面就可以了。如下代码所示：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">void</span> functionForMethod1(<span style="line-height:1.8;color:rgb(0,0,255);">id</span><span style="line-height:1.8;"> self, SEL _cmd) {
   NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">%@, %p</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, self, _cmd);
}

</span>+<span style="line-height:1.8;"> (BOOL)resolveInstanceMethod:(SEL)sel {

    NSString </span>*selectorString =<span style="line-height:1.8;"> NSStringFromSelector(sel);

    </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> ([selectorString isEqualToString:<span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">method1</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">]) {
        class_addMethod(self.</span><span style="line-height:1.8;color:rgb(0,0,255);">class</span>, @selector(method1), (IMP)functionForMethod1, <span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">@:</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);
    }

    </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> [super resolveInstanceMethod:sel];
}</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <ul>
       <li style="list-style:disc;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">不过这种方案更多的是为了实现@dynamic属性。</span></li>
      </ul>
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">备用接收者</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">如果在上一步无法处理消息，则Runtime会继续调以下方法：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre>- (<span style="line-height:1.8;color:rgb(0,0,255);">id</span>)forwardingTargetForSelector:(SEL)aSelector</pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">如果一个对象实现了这个方法，并返回一个非nil的结果，则这个对象会作为消息的新接收者，且消息会被分发到这个对象。当然这个对象不能是self自身，否则就是出现无限循环。当然，如果我们没有指定相应的对象来处理aSelector，则应该调用父类的实现来返回结果。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">使用这个方法通常是在对象内部，可能还有一系列其它对象能处理该消息，我们便可借这些对象来处理消息并返回，这样在对象外部看来，还是由该对象亲自处理了这一消息。如下代码所示：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">@interface</span><span style="line-height:1.8;"> SUTRuntimeMethodHelper : NSObject

</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">)method2;

</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span>

<span style="line-height:1.8;color:rgb(0,0,255);">@implementation</span><span style="line-height:1.8;"> SUTRuntimeMethodHelper

</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">)method2 {
    NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">%@, %p</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, self, _cmd);
}

</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span>

<span style="line-height:1.8;color:rgb(0,0,255);">#pragma</span> mark -

<span style="line-height:1.8;color:rgb(0,0,255);">@interface</span><span style="line-height:1.8;"> SUTRuntimeMethod () {
    SUTRuntimeMethodHelper </span>*<span style="line-height:1.8;">_helper;
}

</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span>

<span style="line-height:1.8;color:rgb(0,0,255);">@implementation</span><span style="line-height:1.8;"> SUTRuntimeMethod

</span>+ (instancetype)<span style="line-height:1.8;color:rgb(0,0,255);">object</span><span style="line-height:1.8;"> {
    </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> [[self alloc] init];
}

</span>-<span style="line-height:1.8;"> (instancetype)init {
    self </span>=<span style="line-height:1.8;"> [super init];
    </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (self !=<span style="line-height:1.8;"> nil) {
        _helper </span>=<span style="line-height:1.8;"> [[SUTRuntimeMethodHelper alloc] init];
    }

    </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> self;
}

</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">)test {
    [self performSelector:@selector(method2)];
}

</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">id</span><span style="line-height:1.8;">)forwardingTargetForSelector:(SEL)aSelector {

    NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">forwardingTargetForSelector</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);

    NSString </span>*selectorString =<span style="line-height:1.8;"> NSStringFromSelector(aSelector);

    </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 将消息转发给_helper来处理</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">if</span> ([selectorString isEqualToString:<span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">method2</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">]) {
        </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> _helper;
    }

    </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> [super forwardingTargetForSelector:aSelector];
}

</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <ul>
       <li style="list-style:disc;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">这一步合适于我们只想将消息转发到另一个能处理该消息的对象上。但这一步无法对消息进行处理，如操作消息的参数和返回值。</span></li>
      </ul>
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">完整消息转发</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">如果在上一步还不能处理未知消息，则唯一能做的就是启用完整的消息转发机制了。此时会调用以下方法：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span>)forwardInvocation:(NSInvocation *)anInvocation</pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">运行时系统会在这一步给消息接收者最后一次机会将消息转发给其它对象。对象会创建一个表示消息的NSInvocation对象，把与尚未处理的消息 有关的全部细节都封装在anInvocation中，包括selector，目标(target)和参数。我们可以在forwardInvocation 方法中选择将消息转发给其它对象。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">forwardInvocation:方法的实现有两个任务：</span></p> 
      <ol>
       <li style="list-style:decimal;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">定位可以响应封装在anInvocation中的消息的对象。这个对象不需要能处理所有未知消息。</span></p> </li> 
       <li style="list-style:decimal;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">使用anInvocation作为参数，将消息发送到选中的对象。anInvocation将会保留调用结果，运行时系统会提取这一结果并将其发送到消息的原始发送者。</span></p> </li> 
      </ol>
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">不过，在这个方法中我们可以实现一些更复杂的功能，我们可以对消息的内容进行修改，比如追回一个参数等，然后再去触发消息。另外，若发现某个消息不应由本类处理，则应调用父类的同名方法，以便继承体系中的每个类都有机会处理此调用请求。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">还有一个很重要的问题，我们必须重写以下方法：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre>- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector</pre>
      </div> 
      <ul>
       <li style="list-style:disc;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">消息转发机制使用从这个方法中获取的信息来创建NSInvocation对象。因此我们必须重写这个方法，为给定的selector提供一个合适的方法签名。</span></li>
      </ul>
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">完整的示例如下所示：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre>- (NSMethodSignature *<span style="line-height:1.8;">)methodSignatureForSelector:(SEL)aSelector {
    NSMethodSignature </span>*signature =<span style="line-height:1.8;"> [super methodSignatureForSelector:aSelector];

    </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (!<span style="line-height:1.8;">signature) {
        </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span><span style="line-height:1.8;"> ([SUTRuntimeMethodHelper instancesRespondToSelector:aSelector]) {
            signature </span>=<span style="line-height:1.8;"> [SUTRuntimeMethodHelper instanceMethodSignatureForSelector:aSelector];
        }
    }

    </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> signature;
}

</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span>)forwardInvocation:(NSInvocation *<span style="line-height:1.8;">)anInvocation {
    </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span><span style="line-height:1.8;"> ([SUTRuntimeMethodHelper instancesRespondToSelector:anInvocation.selector]) {
        [anInvocation invokeWithTarget:_helper];
    }
}</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <ul>
       <li style="list-style:disc;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">NSObject的forwardInvocation:方法实现只是简单调用了doesNotRecognizeSelector:方法，它不会转发任何消息。这样，如果不在以上所述的三个步骤中处理未知消息，则会引发一个异常。</span></li> 
       <li style="list-style:disc;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">从某种意义上来讲，forwardInvocation:就像一个未知消息的分发中心，将这些未知的消息转发给其它对象。或者也可以像一个运输站一样将所有未知消息都发送给同一个接收对象。这取决于具体的实现。</span></li> 
      </ul>
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">消息转发与多重继承</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">回过头来看第二和第三步，通过这两个方法我们可以允许一个对象与其它对象建立关系，以处理某些未知消息，而表面上看仍然是该对象在处理消息。通过这 种关系，我们可以模拟“多重继承”的某些特性，让对象可以“继承”其它对象的特性来处理一些事情。不过，这两者间有一个重要的区别：多重继承将不同的功能 集成到一个对象中，它会让对象变得过大，涉及的东西过多；而消息转发将功能分解到独立的小的对象中，并通过某种方式将这些对象连接起来，并做相应的消息转 发。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">不过消息转发虽然类似于继承，但NSObject的一些方法还是能区分两者。如respondsToSelector:和isKindOfClass:只能用于继承体系，而不能用于转发链。便如果我们想让这种消息转发看起来像是继承，则可以重写这些方法，如以下代码所示：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre>-<span style="line-height:1.8;"> (BOOL)respondsToSelector:(SEL)aSelector   {
       </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span><span style="line-height:1.8;"> ( [super respondsToSelector:aSelector] )
                </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> YES;     
       </span><span style="line-height:1.8;color:rgb(0,0,255);">else</span><span style="line-height:1.8;"> {
                 </span><span style="line-height:1.8;color:rgb(0,128,0);">/*</span><span style="line-height:1.8;color:rgb(0,128,0);"> Here, test whether the aSelector message can
                  *            
                  * be forwarded to another object and whether that  
                  *            
                  * object can respond to it. Return YES if it can.  
                  </span><span style="line-height:1.8;color:rgb(0,128,0);">*/</span><span style="line-height:1.8;">      
       }
       </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> NO;  
}</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">小结</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">在此，我们已经了解了Runtime中消息发送和转发的基本机制。这也是Runtime的强大之处，通过它，我们可以为程序增加很多动态的行为，虽 然我们在实际开发中很少直接使用这些机制(如直接调用objc_msgSend)，但了解它们有助于我们更多地去了解底层的实现。其实在实际的编码过程中，我们也可以灵活地使用这些机制，去实现一些特殊的功能，如hook操作等。</span></p> 
      <h2 style="color:rgb(0,0,0);line-height:1.5;font-size:21px;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Method Swizzling</span></h2> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">理解Method Swizzling是学习runtime机制的一个很好的机会。在此不多做整理，仅翻译由Mattt Thompson发表于nshipster的Method Swizzling一文。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Method Swizzling是改变一个selector的实际实现的技术。通过这一技术，我们可以在运行时通过修改类的分发表中selector对应的函数，来修改方法的实现。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">例如，我们想跟踪在程序中每一个view controller展示给用户的次数：当然，我们可以在每个view controller的viewDidAppear中添加跟踪代码；但是这太过麻烦，需要在每个view controller中写重复的代码。创建一个子类可能是一种实现方式，但需要同时创建UIViewController, UITableViewController, UINavigationController及其它UIKit中view controller的子类，这同样会产生许多重复的代码。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">这种情况下，我们就可以使用Method Swizzling，如在代码所示：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">#import</span> &lt;objc/runtime.h&gt;

<span style="line-height:1.8;color:rgb(0,0,255);">@implementation</span><span style="line-height:1.8;"> UIViewController (Tracking)

</span>+ (<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">)load {
        </span><span style="line-height:1.8;color:rgb(0,0,255);">static</span><span style="line-height:1.8;"> dispatch_once_t onceToken;
    dispatch_once(</span>&amp;onceToken, ^<span style="line-height:1.8;">{
        Class </span><span style="line-height:1.8;color:rgb(0,0,255);">class</span> = [self <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;">];         
        </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> When swizzling a class method, use the following:
                    </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> Class class = object_getClass((id)self);</span>
<span style="line-height:1.8;">
        SEL originalSelector </span>=<span style="line-height:1.8;"> @selector(viewWillAppear:);
                    SEL swizzledSelector </span>=<span style="line-height:1.8;"> @selector(xxx_viewWillAppear:);

        Method originalMethod </span>= class_getInstanceMethod(<span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;">, originalSelector);
                    Method swizzledMethod </span>= class_getInstanceMethod(<span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;">, swizzledSelector);

        BOOL didAddMethod </span>=<span style="line-height:1.8;">
                        class_addMethod(</span><span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;">,
                originalSelector,
                method_getImplementation(swizzledMethod),
                method_getTypeEncoding(swizzledMethod));

        </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span><span style="line-height:1.8;"> (didAddMethod) {
                        class_replaceMethod(</span><span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;">,
                swizzledSelector,
                method_getImplementation(originalMethod),
                method_getTypeEncoding(originalMethod));
        } </span><span style="line-height:1.8;color:rgb(0,0,255);">else</span><span style="line-height:1.8;"> {
            method_exchangeImplementations(originalMethod, swizzledMethod);
        }
    });
}

</span><span style="line-height:1.8;color:rgb(0,0,255);">#pragma</span> mark - Method Swizzling

- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">)xxx_viewWillAppear:(BOOL)animated {
        [self xxx_viewWillAppear:animated];
    NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">viewWillAppear: %@</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, self);
}

</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">在这里，我们通过method swizzling修改了UIViewController的@selector(viewWillAppear:)对应的函数指针，使其实现指向了我们自定义的xxx_viewWillAppear的实现。这样，当UIViewController及其子类的对象调用viewWillAppear时，都会打印一条日志信息。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">上面的例子很好地展示了使用method swizzling来一个类中注入一些我们新的操作。当然，还有许多场景可以使用method swizzling，在此不多举例。在此我们说说使用method swizzling需要注意的一些问题：</span></p> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">Swizzling应该总是在+load中执行</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">在Objective-C中，运行时会自动调用每个类的两个方法。+load会在类初始加载时调用，+initialize会在第一次调用类的类方法或实例方法之前被调用。这两个方法是可选的，且只有在实现了它们时才会被调用。由于method swizzling会影响到类的全局状态，因此要尽量避免在并发处理中出现竞争的情况。+load能保证在类的初始化过程中被加载，并保证这种改变应用级别的行为的一致性。相比之下，+initialize在其执行时不提供这种保证—事实上，如果在应用中没为给这个类发送消息，则它可能永远不会被调用。</span></p> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">Swizzling应该总是在dispatch_once中执行</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">与上面相同，因为swizzling会改变全局状态，所以我们需要在运行时采取一些预防措施。原子性就是这样一种措施，它确保代码只被执行一次，不管有多少个线程。GCD的dispatch_once可以确保这种行为，我们应该将其作为method swizzling的最佳实践。</span></p> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">选择器、方法与实现</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">在Objective-C中，选择器(selector)、方法(method)和实现(implementation)是运行时中一个特殊点，虽然在一般情况下，这些术语更多的是用在消息发送的过程描述中。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">以下是Objective-C Runtime Reference中的对这几个术语一些描述：</span></p> 
      <ul>
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Selector(typedef struct objc_selector *SEL)：用于在运行时中表示一个方法的名称。一个方法选择器是一个C字符串，它是在Objective-C运行时被注册的。选择器由编译器生成，并且在类被加载时由运行时自动做映射操作。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Method(typedef struct objc_method *Method)：在类定义中表示方法的类型</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Implementation(typedef id (*IMP)(id, SEL, …))：这是一个指针类型，指向方法实现函数的开始位置。这个函数使用为当前CPU架构实现的标准C调用规范。每一个参数是指向对象自身的指针(self)，第二个参数是方法选择器。然后是方法的实际参数。</span></p> </li> 
      </ul>
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">理解这几个术语之间的关系最好的方式是：一个类维护一个运行时可接收的消息分发表；分发表中的每个入口是一个方法(Method)，其中key是一个特定名称，即选择器(SEL)，其对应一个实现(IMP)，即指向底层C函数的指针。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">为了swizzle一个方法，我们可以在分发表中将一个方法的现有的选择器映射到不同的实现，而将该选择器对应的原始实现关联到一个新的选择器中。</span></p> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">调用_cmd</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">我们回过头来看看前面新的方法的实现代码：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">)xxx_viewWillAppear:(BOOL)animated {
    [self xxx_viewWillAppear:animated];
    NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">viewWillAppear: %@</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>, NSStringFromClass([self <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;">]));
}</span></pre>
      </div> 
      <ul>
       <li style="list-style:disc;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">咋看上去是会导致无限循环的。但令人惊奇的是，并没有出现这种情况。在swizzling的过程中，方法中的[self xxx_viewWillAppear:animated]已经被重新指定到UIViewController类的-viewWillAppear:中。在这种情况下，不会产生无限循环。不过如果我们调用的是[self viewWillAppear:animated]，则会产生无限循环，因为这个方法的实现在运行时已经被重新指定为xxx_viewWillAppear:了。</span></li>
      </ul>
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">注意事项</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Swizzling通常被称作是一种黑魔法，容易产生不可预知的行为和无法预见的后果。虽然它不是最安全的，但如果遵从以下几点预防措施的话，还是比较安全的：</span></p> 
      <ul>
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">总是调用方法的原始实现(除非有更好的理由不这么做)：API提供了一个输入与输出约定，但其内部实现是一个黑盒。Swizzle一个方法而不调用原始实现可能会打破私有状态底层操作，从而影响到程序的其它部分。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">避免冲突：给自定义的分类方法加前缀，从而使其与所依赖的代码库不会存在命名冲突。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">明白是怎么回事：简单地拷贝粘贴swizzle代码而不理解它是如何工作的，不仅危险，而且会浪费学习Objective-C运行时的机会。阅读Objective-C Runtime Reference和查看&lt;objc/runtime.h&gt;头文件以了解事件是如何发生的。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">小心操作：无论我们对Foundation, UIKit或其它内建框架执行Swizzle操作抱有多大信心，需要知道在下一版本中许多事可能会不一样。</span></p> </li> 
      </ul>
      <h2 style="color:rgb(0,0,0);line-height:1.5;font-size:21px;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">协议与分类</span></h2> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Objective-C中的分类允许我们通过给一个类添加方法来扩充它（但是通过category不能添加新的实例变量），并且我们不需要访问类中的代码就可以做到。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Objective-C中的协议是普遍存在的接口定义方式，即在一个类中通过@protocol定义接口，在另外类中实现接口，这种接口定义方式也成为“delegation”模式，@protocol声明了可以呗其他任何方法类实现的方法，协议仅仅是定义一个接口，而由其他的类去负责实现。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">在本章中，我们来看看runtime对分类与协议的支持。</span></p> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">基础数据类型</span></h3> 
      <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Category</span></h4> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Category是表示一个指向分类的结构体的指针，其定义如下：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre>typedef <span style="line-height:1.8;color:rgb(0,0,255);">struct</span> objc_category *<span style="line-height:1.8;">Category;

</span><span style="line-height:1.8;color:rgb(0,0,255);">struct</span><span style="line-height:1.8;"> objc_category {
    </span><span style="line-height:1.8;color:rgb(0,0,255);">char</span> *category_name                          OBJC2_UNAVAILABLE; <span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 分类名</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *class_name                             OBJC2_UNAVAILABLE; <span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 分类所属的类名</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">struct</span> objc_method_list *instance_methods    OBJC2_UNAVAILABLE; <span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 实例方法列表</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">struct</span> objc_method_list *class_methods       OBJC2_UNAVAILABLE; <span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 类方法列表</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">struct</span> objc_protocol_list *protocols         OBJC2_UNAVAILABLE; <span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 分类所实现的协议列表</span>
}</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <ul class="_mce_tagged_br">
       <li style="list-style:disc;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">这个结构体主要包含了分类定义的实例方法与类方法，其中instance_methods列表是objc_class中方法列表的一个子集，而class_methods列表是元类方法列表的一个子集。</span></li>
      </ul>
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">Protocol</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Protocol的定义如下：我们可以看到，Protocol其中实就是一个对象结构体。</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre>typedef <span style="line-height:1.8;color:rgb(0,0,255);">struct</span> objc_object Protocol;</pre>
      </div> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">操作函数</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Runtime并没有在&lt;objc/runtime.h&gt;头文件中提供针对分类的操作函数。因为这些分类中的信息都包含在objc_class中，我们可以通过针对objc_class的操作函数来获取分类的信息。如下例所示：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">@interface</span><span style="line-height:1.8;"> RuntimeCategoryClass : NSObject
</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">)method1;
</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span>

<span style="line-height:1.8;color:rgb(0,0,255);">@interface</span><span style="line-height:1.8;"> RuntimeCategoryClass (Category)
</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">)method2;
</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span>

<span style="line-height:1.8;color:rgb(0,0,255);">@implementation</span><span style="line-height:1.8;"> RuntimeCategoryClass

</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">)method1 {

}

</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span>

<span style="line-height:1.8;color:rgb(0,0,255);">@implementation</span><span style="line-height:1.8;"> RuntimeCategoryClass (Category)

</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">)method2 {

}

</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span>

<span style="line-height:1.8;color:rgb(0,0,255);">#pragma</span> mark -<span style="line-height:1.8;">

NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">测试objc_class中的方法列表是否包含分类中的方法</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);
unsigned </span><span style="line-height:1.8;color:rgb(0,0,255);">int</span> outCount = <span style="line-height:1.8;color:rgb(128,0,128);">0</span><span style="line-height:1.8;">;
Method </span>*methodList = class_copyMethodList(RuntimeCategoryClass.<span style="line-height:1.8;color:rgb(0,0,255);">class</span>, &amp;<span style="line-height:1.8;">outCount);

</span><span style="line-height:1.8;color:rgb(0,0,255);">for</span> (<span style="line-height:1.8;color:rgb(0,0,255);">int</span> i = <span style="line-height:1.8;color:rgb(128,0,128);">0</span>; i &lt; outCount; i++<span style="line-height:1.8;">) {
    Method method </span>=<span style="line-height:1.8;"> methodList[i];

    </span><span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *name =<span style="line-height:1.8;"> sel_getName(method_getName(method));

    NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">RuntimeCategoryClass's method: %s</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, name);

    </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span><span style="line-height:1.8;"> (strcmp(name, sel_getName(@selector(method2)))) {
        NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">分类方法method2在objc_class的方法列表中</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);
    }
}</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">其输出是：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">11</span>-<span style="line-height:1.8;color:rgb(128,0,128);">08</span> <span style="line-height:1.8;color:rgb(128,0,128);">10</span>:<span style="line-height:1.8;color:rgb(128,0,128);">36</span>:<span style="line-height:1.8;color:rgb(128,0,128);">39.213</span> [<span style="line-height:1.8;color:rgb(128,0,128);">561</span>:<span style="line-height:1.8;color:rgb(128,0,128);">151847</span><span style="line-height:1.8;">] 测试objc_class中的方法列表是否包含分类中的方法
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">11</span>-<span style="line-height:1.8;color:rgb(128,0,128);">08</span> <span style="line-height:1.8;color:rgb(128,0,128);">10</span>:<span style="line-height:1.8;color:rgb(128,0,128);">36</span>:<span style="line-height:1.8;color:rgb(128,0,128);">39.215</span> [<span style="line-height:1.8;color:rgb(128,0,128);">561</span>:<span style="line-height:1.8;color:rgb(128,0,128);">151847</span>] RuntimeCategoryClass<span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">s method: method2</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">11</span>-<span style="line-height:1.8;color:rgb(128,0,128);">08</span> <span style="line-height:1.8;color:rgb(128,0,128);">10</span>:<span style="line-height:1.8;color:rgb(128,0,128);">36</span>:<span style="line-height:1.8;color:rgb(128,0,128);">39.215</span> [<span style="line-height:1.8;color:rgb(128,0,128);">561</span>:<span style="line-height:1.8;color:rgb(128,0,128);">151847</span>] RuntimeCategoryClass<span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">s method: method1</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">11</span>-<span style="line-height:1.8;color:rgb(128,0,128);">08</span> <span style="line-height:1.8;color:rgb(128,0,128);">10</span>:<span style="line-height:1.8;color:rgb(128,0,128);">36</span>:<span style="line-height:1.8;color:rgb(128,0,128);">39.215</span> [<span style="line-height:1.8;color:rgb(128,0,128);">561</span>:<span style="line-height:1.8;color:rgb(128,0,128);">151847</span>] 分类方法method2在objc_class的方法列表中</pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">而对于Protocol，runtime提供了一系列函数来对其进行操作，这些函数包括：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 返回指定的协议</span>
Protocol * objc_getProtocol ( <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;">name );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取运行时所知道的所有协议的数组</span>
Protocol ** objc_copyProtocolList ( unsigned <span style="line-height:1.8;color:rgb(0,0,255);">int</span> *<span style="line-height:1.8;">outCount );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 创建新的协议实例</span>
Protocol * objc_allocateProtocol ( <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;">name );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 在运行时中注册新创建的协议</span>
<span style="line-height:1.8;color:rgb(0,0,255);">void</span> objc_registerProtocol ( Protocol *<span style="line-height:1.8;">proto );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 为协议添加方法</span>
<span style="line-height:1.8;color:rgb(0,0,255);">void</span> protocol_addMethodDescription ( Protocol *proto, SEL name, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;">types, BOOL isRequiredMethod, BOOL isInstanceMethod );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 添加一个已注册的协议到协议中</span>
<span style="line-height:1.8;color:rgb(0,0,255);">void</span> protocol_addProtocol ( Protocol *proto, Protocol *<span style="line-height:1.8;">addition );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 为协议添加属性</span>
<span style="line-height:1.8;color:rgb(0,0,255);">void</span> protocol_addProperty ( Protocol *proto, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *name, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> objc_property_attribute_t *attributes, unsigned <span style="line-height:1.8;color:rgb(0,0,255);">int</span><span style="line-height:1.8;"> attributeCount, BOOL isRequiredProperty, BOOL isInstanceProperty );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 返回协议名</span>
<span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> * protocol_getName ( Protocol *<span style="line-height:1.8;">p );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 测试两个协议是否相等</span>
BOOL protocol_isEqual ( Protocol *proto, Protocol *<span style="line-height:1.8;">other );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取协议中指定条件的方法的方法描述数组</span>
<span style="line-height:1.8;color:rgb(0,0,255);">struct</span> objc_method_description * protocol_copyMethodDescriptionList ( Protocol *p, BOOL isRequiredMethod, BOOL isInstanceMethod, unsigned <span style="line-height:1.8;color:rgb(0,0,255);">int</span> *<span style="line-height:1.8;">outCount );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取协议中指定方法的方法描述</span>
<span style="line-height:1.8;color:rgb(0,0,255);">struct</span> objc_method_description protocol_getMethodDescription ( Protocol *<span style="line-height:1.8;">p, SEL aSel, BOOL isRequiredMethod, BOOL isInstanceMethod );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取协议中的属性列表</span>
objc_property_t * protocol_copyPropertyList ( Protocol *proto, unsigned <span style="line-height:1.8;color:rgb(0,0,255);">int</span> *<span style="line-height:1.8;">outCount );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取协议的指定属性</span>
objc_property_t protocol_getProperty ( Protocol *proto, <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;">name, BOOL isRequiredProperty, BOOL isInstanceProperty );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取协议采用的协议</span>
Protocol ** protocol_copyProtocolList ( Protocol *proto, unsigned <span style="line-height:1.8;color:rgb(0,0,255);">int</span> *<span style="line-height:1.8;">outCount );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 查看协议是否采用了另一个协议</span>
BOOL protocol_conformsToProtocol ( Protocol *proto, Protocol *other );</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <ul>
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">objc_getProtocol函数，需要注意的是如果仅仅是声明了一个协议，而未在任何类中实现这个协议，则该函数返回的是nil。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">objc_copyProtocolList函数，获取到的数组需要使用free来释放</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">objc_allocateProtocol函数，如果同名的协议已经存在，则返回nil</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">objc_registerProtocol函数，创建一个新的协议后，必须调用该函数以在运行时中注册新的协议。协议注册后便可以使用，但不能再做修改，即注册完后不能再向协议添加方法或协议</span></p> </li> 
      </ul>
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">需要强调的是，协议一旦注册后就不可再修改，即无法再通过调用protocol_addMethodDescription、protocol_addProtocol和protocol_addProperty往协议中添加方法等。</span></p> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">小结</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">Runtime并没有提供过多的函数来处理分类。对于协议，我们可以动态地创建协议，并向其添加方法、属性及继承的协议，并在运行时动态地获取这些信息。</span></p> 
      <h2 style="color:rgb(0,0,0);line-height:1.5;font-size:21px;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">拾遗</span></h2> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">前面几篇基本介绍了runtime中的大部分功能，包括对类与对象、成员变量与属性、方法与消息、分类与协议的处理。runtime大部分的功能都是围绕这几点来实现的。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">本章的内容并不算重点，主要针对前文中对Objective-C Runtime Reference内容遗漏的地方做些补充。当然这并不能包含所有的内容。runtime还有许多内容，需要读者去研究发现。</span></p> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">super</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">在Objective-C中，如果我们需要在类的方法中调用父类的方法时，通常都会用到super，如下所示：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">@interface</span><span style="line-height:1.8;"> MyViewController: UIViewController

</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span>

<span style="line-height:1.8;color:rgb(0,0,255);">@implementation</span><span style="line-height:1.8;"> MyViewController

</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">)viewDidLoad {
    [super viewDidLoad];

    </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> do something</span>
<span style="line-height:1.8;">    ...
}

</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">如何使用super我们都知道。现在的问题是，它是如何工作的呢？</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">首先我们需要知道的是super与self不同。self是类的一个隐藏参数，每个方法的实现的第一个参数即为self。而super并不是隐藏参数，它实际上只是一个”编译器标示符”，它负责告诉编译器，当调用viewDidLoad方法时，去调用父类的方法，而不是本类中的方法。而它实际上与self指向的是相同的消息接收者。为了理解这一点，我们先来看看super的定义：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">struct</span> objc_super { <span style="line-height:1.8;color:rgb(0,0,255);">id</span> receiver; Class superClass; };</pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">这个结构体有两个成员：</span></p> 
      <ul>
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">receiver：即消息的实际接收者</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">superClass：指针当前类的父类</span></p> </li> 
      </ul>
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">当我们使用super来接收消息时，编译器会生成一个objc_super结构体。就上面的例子而言，这个结构体的receiver就是MyViewController对象，与self相同；superClass指向MyViewController的父类UIViewController。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">接下来，发送消息时，不是调用objc_msgSend函数，而是调用objc_msgSendSuper函数，其声明如下：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">id</span> objc_msgSendSuper ( <span style="line-height:1.8;color:rgb(0,0,255);">struct</span> objc_super *super, SEL op, ... );</pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">该函数第一个参数即为前面生成的objc_super结构体，第二个参数是方法的selector。该函数实际的操作是：从objc_super结构体指向的superClass的方法列表开始查找viewDidLoad的selector，找到后以objc-&gt;receiver去调用这个selector，而此时的操作流程就是如下方式了</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre>objc_msgSend(objc_super-&gt;receiver, @selector(viewDidLoad))</pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">由于objc_super-&gt;receiver就是self本身，所以该方法实际与下面这个调用是相同的：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre>objc_msgSend(self, @selector(viewDidLoad))</pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">为了便于理解，我们看以下实例：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">@interface</span><span style="line-height:1.8;"> MyClass : NSObject

</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span>

<span style="line-height:1.8;color:rgb(0,0,255);">@implementation</span><span style="line-height:1.8;"> MyClass

</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">)test {
    NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">self class: %@</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>, self.<span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;">);
    NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">super class: %@</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>, super.<span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;">);
}

</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">调用MyClass的test方法后，其输出是：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">11</span>-<span style="line-height:1.8;color:rgb(128,0,128);">08</span> <span style="line-height:1.8;color:rgb(128,0,128);">15</span>:<span style="line-height:1.8;color:rgb(128,0,128);">55</span>:<span style="line-height:1.8;color:rgb(128,0,128);">03.256</span> [<span style="line-height:1.8;color:rgb(128,0,128);">824</span>:<span style="line-height:1.8;color:rgb(128,0,128);">209297</span>] self <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;">: MyClass
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">11</span>-<span style="line-height:1.8;color:rgb(128,0,128);">08</span> <span style="line-height:1.8;color:rgb(128,0,128);">15</span>:<span style="line-height:1.8;color:rgb(128,0,128);">55</span>:<span style="line-height:1.8;color:rgb(128,0,128);">03.256</span> [<span style="line-height:1.8;color:rgb(128,0,128);">824</span>:<span style="line-height:1.8;color:rgb(128,0,128);">209297</span>] super <span style="line-height:1.8;color:rgb(0,0,255);">class</span>: MyClass</pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">从上例中可以看到，两者的输出都是MyClass。大家可以自行用上面介绍的内容来梳理一下。</span></p> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">库相关操作</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">库相关的操作主要是用于获取由系统提供的库相关的信息，主要包含以下函数：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取所有加载的Objective-C框架和动态库的名称</span>
<span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> ** objc_copyImageNames ( unsigned <span style="line-height:1.8;color:rgb(0,0,255);">int</span> *<span style="line-height:1.8;">outCount );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取指定类所在动态库</span>
<span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;"> class_getImageName ( Class cls );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取指定库或框架中所有类的类名</span>
<span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> ** objc_copyClassNamesForImage ( <span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *image, unsigned <span style="line-height:1.8;color:rgb(0,0,255);">int</span> *outCount );</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">通过这几个函数，我们可以了解到某个类所有的库，以及某个库中包含哪些类。如下代码所示：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre>NSLog(<span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">获取指定类所在动态库</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);

NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">UIView's Framework: %s</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>, class_getImageName(NSClassFromString(<span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">UIView</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">)));

NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">获取指定库或框架中所有类的类名</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);
</span><span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> ** classes = objc_copyClassNamesForImage(class_getImageName(NSClassFromString(<span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">UIView</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>)), &amp;<span style="line-height:1.8;">outCount);
</span><span style="line-height:1.8;color:rgb(0,0,255);">for</span> (<span style="line-height:1.8;color:rgb(0,0,255);">int</span> i = <span style="line-height:1.8;color:rgb(128,0,128);">0</span>; i &lt; outCount; i++<span style="line-height:1.8;">) {
    NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">class name: %s</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, classes[i]);
}</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">其输出结果如下：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">11</span>-<span style="line-height:1.8;color:rgb(128,0,128);">08</span> <span style="line-height:1.8;color:rgb(128,0,128);">12</span>:<span style="line-height:1.8;color:rgb(128,0,128);">57</span>:<span style="line-height:1.8;color:rgb(128,0,128);">32.689</span> [<span style="line-height:1.8;color:rgb(128,0,128);">747</span>:<span style="line-height:1.8;color:rgb(128,0,128);">184013</span><span style="line-height:1.8;">] 获取指定类所在动态库
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">11</span>-<span style="line-height:1.8;color:rgb(128,0,128);">08</span> <span style="line-height:1.8;color:rgb(128,0,128);">12</span>:<span style="line-height:1.8;color:rgb(128,0,128);">57</span>:<span style="line-height:1.8;color:rgb(128,0,128);">32.690</span> [<span style="line-height:1.8;color:rgb(128,0,128);">747</span>:<span style="line-height:1.8;color:rgb(128,0,128);">184013</span>] UIView<span style="line-height:1.8;color:rgb(128,0,0);">'</span><span style="line-height:1.8;color:rgb(128,0,0);">s Framework: /System/Library/Frameworks/UIKit.framework/UIKit</span>
<span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">11</span>-<span style="line-height:1.8;color:rgb(128,0,128);">08</span> <span style="line-height:1.8;color:rgb(128,0,128);">12</span>:<span style="line-height:1.8;color:rgb(128,0,128);">57</span>:<span style="line-height:1.8;color:rgb(128,0,128);">32.690</span> [<span style="line-height:1.8;color:rgb(128,0,128);">747</span>:<span style="line-height:1.8;color:rgb(128,0,128);">184013</span><span style="line-height:1.8;">] 获取指定库或框架中所有类的类名
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">11</span>-<span style="line-height:1.8;color:rgb(128,0,128);">08</span> <span style="line-height:1.8;color:rgb(128,0,128);">12</span>:<span style="line-height:1.8;color:rgb(128,0,128);">57</span>:<span style="line-height:1.8;color:rgb(128,0,128);">32.691</span> [<span style="line-height:1.8;color:rgb(128,0,128);">747</span>:<span style="line-height:1.8;color:rgb(128,0,128);">184013</span>] <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;"> name: UIKeyboardPredictiveSettings
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">11</span>-<span style="line-height:1.8;color:rgb(128,0,128);">08</span> <span style="line-height:1.8;color:rgb(128,0,128);">12</span>:<span style="line-height:1.8;color:rgb(128,0,128);">57</span>:<span style="line-height:1.8;color:rgb(128,0,128);">32.691</span> [<span style="line-height:1.8;color:rgb(128,0,128);">747</span>:<span style="line-height:1.8;color:rgb(128,0,128);">184013</span>] <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;"> name: _UIPickerViewTopFrame
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">11</span>-<span style="line-height:1.8;color:rgb(128,0,128);">08</span> <span style="line-height:1.8;color:rgb(128,0,128);">12</span>:<span style="line-height:1.8;color:rgb(128,0,128);">57</span>:<span style="line-height:1.8;color:rgb(128,0,128);">32.691</span> [<span style="line-height:1.8;color:rgb(128,0,128);">747</span>:<span style="line-height:1.8;color:rgb(128,0,128);">184013</span>] <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;"> name: _UIOnePartImageView
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">11</span>-<span style="line-height:1.8;color:rgb(128,0,128);">08</span> <span style="line-height:1.8;color:rgb(128,0,128);">12</span>:<span style="line-height:1.8;color:rgb(128,0,128);">57</span>:<span style="line-height:1.8;color:rgb(128,0,128);">32.692</span> [<span style="line-height:1.8;color:rgb(128,0,128);">747</span>:<span style="line-height:1.8;color:rgb(128,0,128);">184013</span>] <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;"> name: _UIPickerViewSelectionBar
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">11</span>-<span style="line-height:1.8;color:rgb(128,0,128);">08</span> <span style="line-height:1.8;color:rgb(128,0,128);">12</span>:<span style="line-height:1.8;color:rgb(128,0,128);">57</span>:<span style="line-height:1.8;color:rgb(128,0,128);">32.692</span> [<span style="line-height:1.8;color:rgb(128,0,128);">747</span>:<span style="line-height:1.8;color:rgb(128,0,128);">184013</span>] <span style="line-height:1.8;color:rgb(0,0,255);">class</span><span style="line-height:1.8;"> name: _UIPickerWheelView
</span><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">11</span>-<span style="line-height:1.8;color:rgb(128,0,128);">08</span> <span style="line-height:1.8;color:rgb(128,0,128);">12</span>:<span style="line-height:1.8;color:rgb(128,0,128);">57</span>:<span style="line-height:1.8;color:rgb(128,0,128);">32.692</span> [<span style="line-height:1.8;color:rgb(128,0,128);">747</span>:<span style="line-height:1.8;color:rgb(128,0,128);">184013</span>] <span style="line-height:1.8;color:rgb(0,0,255);">class</span> name: _UIPickerViewTestParameters</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;">块<span style="line-height:1.8;font-family:'楷体';">操作</span> </h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">我们都知道block给我们带到极大的方便，苹果也不断提供一些使用block的新的API。同时，苹果在runtime中也提供了一些函数来支持针对block的操作，这些函数包括：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 创建一个指针函数的指针，该函数调用时会调用特定的block</span>
IMP imp_implementationWithBlock ( <span style="line-height:1.8;color:rgb(0,0,255);">id</span><span style="line-height:1.8;"> block );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 返回与IMP(使用imp_implementationWithBlock创建的)相关的block</span>
<span style="line-height:1.8;color:rgb(0,0,255);">id</span><span style="line-height:1.8;"> imp_getBlock ( IMP anImp );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 解除block与IMP(使用imp_implementationWithBlock创建的)的关联关系，并释放block的拷贝</span>
BOOL imp_removeBlock ( IMP anImp );</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <ul>
       <li style="list-style:disc;"><span style="line-height:1.8;font-family:'楷体';font-size:16px;">imp_implementationWithBlock函数：参数block的签名必须是method_return_type ^(id self, method_args …)形式的。该方法能让我们使用block作为IMP。如下代码所示：</span></li>
      </ul>
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">@interface</span><span style="line-height:1.8;"> MyRuntimeBlock : NSObject

</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span>

<span style="line-height:1.8;color:rgb(0,0,255);">@implementation</span><span style="line-height:1.8;"> MyRuntimeBlock

</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span>

<span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 测试代码</span>
IMP imp = imp_implementationWithBlock(^(<span style="line-height:1.8;color:rgb(0,0,255);">id</span> obj, NSString *<span style="line-height:1.8;">str) {
    NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">%@</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, str);
});

class_addMethod(MyRuntimeBlock.</span><span style="line-height:1.8;color:rgb(0,0,255);">class</span>, @selector(testBlock:), imp, <span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">v@:@</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);

MyRuntimeBlock </span>*runtime =<span style="line-height:1.8;"> [[MyRuntimeBlock alloc] init];
[runtime performSelector:@selector(testBlock:) withObject:</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">hello world!</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>];</pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">输出结果是</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(128,0,128);">2014</span>-<span style="line-height:1.8;color:rgb(128,0,128);">11</span>-<span style="line-height:1.8;color:rgb(128,0,128);">09</span> <span style="line-height:1.8;color:rgb(128,0,128);">14</span>:<span style="line-height:1.8;color:rgb(128,0,128);">03</span>:<span style="line-height:1.8;color:rgb(128,0,128);">19.779</span> [<span style="line-height:1.8;color:rgb(128,0,128);">1172</span>:<span style="line-height:1.8;color:rgb(128,0,128);">395446</span>] hello world!</pre>
      </div> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">弱引用操作</span></h3> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 加载弱引用指针引用的对象并返回</span>
<span style="line-height:1.8;color:rgb(0,0,255);">id</span> objc_loadWeak ( <span style="line-height:1.8;color:rgb(0,0,255);">id</span> *<span style="line-height:1.8;">location );

</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 存储__weak变量的新值</span>
<span style="line-height:1.8;color:rgb(0,0,255);">id</span> objc_storeWeak ( <span style="line-height:1.8;color:rgb(0,0,255);">id</span> *location, <span style="line-height:1.8;color:rgb(0,0,255);">id</span> obj );</pre>
      </div> 
      <ul>
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">objc_loadWeak函数：该函数加载一个弱指针引用的对象，并在对其做retain和autoreleasing操作后返回它。这样，对象就可以在调用者使用它时保持足够长的生命周期。该函数典型的用法是在任何有使用__weak变量的表达式中使用。</span></p> </li> 
       <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">objc_storeWeak函数：该函数的典型用法是用于__weak变量做为赋值对象时。</span></p> </li> 
      </ul>
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">这两个函数的具体实施在此不举例，有兴趣的小伙伴可以参考《Objective-C高级编程：iOS与OS X多线程和内存管理》中对__weak实现的介绍。</span></p> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">宏定义</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">在runtime中，还定义了一些宏定义供我们使用，有些值我们会经常用到，如表示BOOL值的YES/NO；而有些值不常用，如OBJC_ROOT_CLASS。在此我们做一个简单的介绍。</span></p> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">布尔值</span></h3> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">#define</span> YES  (BOOL)1
<span style="line-height:1.8;color:rgb(0,0,255);">#define</span> NO   (BOOL)0</pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">这两个宏定义定义了表示布尔值的常量，需要注意的是YES的值是1，而不是非0值。</span></p> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">空值</span></h3> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">#define</span> nil  __DARWIN_NULL
<span style="line-height:1.8;color:rgb(0,0,255);">#define</span> Nil  __DARWIN_NULL</pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">其中nil用于空的实例对象，而Nil用于空类对象。</span></p> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">分发函数原型</span></h3> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">#define</span> OBJC_OLD_DISPATCH_PROTOTYPES  1</pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">该宏指明分发函数是否必须转换为合适的函数指针类型。当值为0时，必须进行转换</span></p> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">Objective-C根类</span></h3> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">#define</span> OBJC_ROOT_CLASS</pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">如果我们定义了一个Objective-C根类，则编译器会报错，指明我们定义的类没有指定一个基类。这种情况下，我们就可以使用这个宏定义来避过这个编译错误。该宏在iOS 7.0后可用。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">其实在NSObject的声明中，我们就可以看到这个宏的身影，如下所示：</span></p> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;">__OSX_AVAILABLE_STARTING(__MAC_10_0, __IPHONE_2_0)
OBJC_ROOT_CLASS
OBJC_EXPORT
</span><span style="line-height:1.8;color:rgb(0,0,255);">@interface</span> NSObject &lt;NSObject&gt;<span style="line-height:1.8;"> {
    Class isa  OBJC_ISA_AVAILABILITY;
}</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">我们可以参考这种方式来定义我们自己的根类。</span></p> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">局部变量存储时长</span></h3> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;">
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">#define</span> NS_VALID_UNTIL_END_OF_SCOPE</pre>
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">该宏表明存储在某些局部变量中的值在优化时不应该被编译器强制释放。</span></p> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">我们将局部变量标记为id类型或者是指向ObjC对象类型的指针，以便存储在这些局部变量中的值在优化时不会被编译器强制释放。相反，这些值会在变量再次被赋值之前或者局部变量的作用域结束之前都会被保存。</span></p> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">关联对象行为</span></h3> 
      <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
       <pre><span style="line-height:1.8;color:rgb(0,0,255);">enum</span><span style="line-height:1.8;"> {
   OBJC_ASSOCIATION_ASSIGN  </span>= <span style="line-height:1.8;color:rgb(128,0,128);">0</span><span style="line-height:1.8;">,
   OBJC_ASSOCIATION_RETAIN_NONATOMIC  </span>= <span style="line-height:1.8;color:rgb(128,0,128);">1</span><span style="line-height:1.8;">,
   OBJC_ASSOCIATION_COPY_NONATOMIC  </span>= <span style="line-height:1.8;color:rgb(128,0,128);">3</span><span style="line-height:1.8;">,
   OBJC_ASSOCIATION_RETAIN  </span>= <span style="line-height:1.8;color:rgb(128,0,128);">01401</span><span style="line-height:1.8;">,
   OBJC_ASSOCIATION_COPY  </span>= <span style="line-height:1.8;color:rgb(128,0,128);">01403</span><span style="line-height:1.8;">
};</span></pre> 
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
       </div> 
      </div> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">这几个值在前面已介绍过，在此不再重复。</span></p> 
      <h3 style="color:rgb(0,0,0);font-size:16px;line-height:1.5;"><span style="line-height:1.8;font-family:'楷体';">总结</span></h3> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">至此，本系列对runtime的整理已完结。当然这只是对runtime的一些基础知识的归纳，力图起个抛砖引玉的作用。还有许多关于runtime有意思东西还需要读者自己去探索发现</span>。</p> 
      <p>&nbsp;</p> 
      <br>
      <br>
      <p>&nbsp;</p> 
      <pre class="hljs objectivec"><span style="line-height:1.8;font-family:'楷体';"><code class="objectivec"><span class="hljs-keyword" style="color:rgb(0,0,255);line-height:1.8;">&nbsp;</span></code></span></pre> 
      <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">&nbsp;</span></p> 
      <br>
      <p>&nbsp;</p> 
      <p>&nbsp;</p> 
     </div> 
     <div>
      &nbsp;
     </div> 
     <div>
      &nbsp;
     </div> 
     <div>
      &nbsp;
     </div> 
    </div> 
   </div> 
   <div style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:25.2px;">
    程序猿神奇的手，每时每刻，这双手都在改变着世界的交互方式！
   </div> 
   <div class="clear" style="clear:both;color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:25.2px;"></div> 
   <div> 
    <div> 
     <font color="#333333"><span style="font-size:14px;line-height:25.2px;">本文转自当天真遇到现实博客园博客，原文链接：http://www.cnblogs.com/XYQ-208910/p/6006166.html</span></font>
     <span style="font-size:14px;line-height:25.2px;color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;">，如需转载请自行联系原作者</span> 
    </div> 
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
