<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>iOS: FFmpeg的使用一 « NotBeCN</title>
  <meta name="description" content="                  现状：现在视频直播非常的火，所以在视频直播开发中，使用的对视频进行遍解码的框架显得尤为重要了，其实，这种框架蛮多的，这次主要介绍一下FFmpeg视频播放器的集成和使用，FFmpeg是视频编解码的利器。     介绍：视频播放过程     首先简单介绍以下视频文件的相关知识。我们...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://notbe.cn/2017/10/10/weixin_34413802_90133416.html">
  <link rel="alternate" type="application/rss+xml" title="NotBeCN" href="https://notbe.cn/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">NotBeCN</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/" target="_blank">关于</a>
      
        
        <a class="page-link" href="https://uzshare.com" target="_blank">社区</a>
      
        
        <a class="page-link" href="/donate/" target="_blank">Donate</a>
      
        
        <a class="page-link" href="/games/shejiyazi/" target="_blank">射个鸭子</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">iOS: FFmpeg的使用一</h1>
    <p class="post-meta">Oct 10, 2017</p>
  </header>

  <article class="post-content">
    <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="content-detail markdown-body"> 
   <div class="blogpost-body" style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:25.2px;"> 
    <p><span style="line-height:1.8;font-family:'楷体';font-size:18px;">现状：现在视频直播非常的火，所以在视频直播开发中，使用的对视频进行遍解码的框架显得尤为重要了，其实，这种框架蛮多的，这次主要介绍一下<span class="name" style="line-height:1.8;">FFmpeg视频播放器的集成和使用，FFmpeg是视频编解码的利器。</span></span></p> 
    <p><span style="line-height:1.8;font-family:'楷体';font-size:18px;"><span class="name" style="line-height:1.8;">介绍：</span></span><span style="line-height:1.8;font-family:'楷体';font-size:18px;">视频播放过程</span></p> 
    <p><span style="line-height:1.8;font-family:'楷体';font-size:18px;">首先简单介绍以下视频文件的相关知识。我们平时看到的视频文件有许多格式，比如 avi， mkv， rmvb， mov， mp4等等，这些被称为<a href="http://en.wikipedia.org/wiki/Digital_container_format" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom-width:1px;border-bottom-style:dotted;border-bottom-color:rgb(51,51,51);">容器</a>（<a href="http://wiki.multimedia.cx/index.php?title=Category:Container_Formats" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom-width:1px;border-bottom-style:dotted;border-bottom-color:rgb(51,51,51);">Container</a>）， 不同的容器格式规定了其中音视频数据的组织方式（也包括其他数据，比如字幕等）。容器中一般会封装有视频和音频轨，也称为视频流（stream）和音频 流，播放视频文件的第一步就是根据视频文件的格式，解析（demux）出其中封装的视频流、音频流以及字幕（如果有的话），解析的数据读到包 （packet）中，每个包里保存的是视频帧（frame）或音频帧，然后分别对视频帧和音频帧调用相应的解码器（decoder）进行解码，比如使用 H.264编码的视频和MP3编码的音频，会相应的调用H.264解码器和MP3解码器，解码之后得到的就是原始的图像(YUV or RGB)和声音(PCM)数据，然后根据同步好的时间将图像显示到屏幕上，将声音输出到声卡，最终就是我们看到的视频。</span></p> 
    <p><span style="line-height:1.8;font-family:'楷体';font-size:18px;">FFmpeg的API就是根据这个过程设计的，因此使用FFmpeg来处理视频文件的方法非常直观简单。下面就一步一步介绍从视频文件中解码出图片的过程。</span></p> 
    <p><span style="line-height:1.8;font-family:'楷体';font-size:18px;"><span class="name" style="line-height:1.8;">属性：</span></span><span style="line-height:1.8;font-family:'楷体';font-size:18px;">声明变量</span></p> 
    <ul>
     <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:18px;"><a href="http://ffmpeg.org/doxygen/trunk/structAVFormatContext.html" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom-width:1px;border-bottom-style:dotted;border-bottom-color:rgb(51,51,51);">AVFormatContext</a>：保存需要读入的文件的格式信息，比如流的个数以及流数据等</span></p> </li> 
     <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:18px;"><a href="http://ffmpeg.org/doxygen/trunk/structAVCodecContext.html" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom-width:1px;border-bottom-style:dotted;border-bottom-color:rgb(51,51,51);">AVCodecCotext</a>：保存了相应流的详细编码信息，比如视频的宽、高，编码类型等。</span></p> </li> 
     <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:18px;"><a href="http://ffmpeg.org/doxygen/trunk/structAVCodec.html" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom-width:1px;border-bottom-style:dotted;border-bottom-color:rgb(51,51,51);">pCodec</a>：真正的编解码器，其中有编解码需要调用的函数</span></p> </li> 
     <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:18px;"><a href="http://ffmpeg.org/doxygen/trunk/structAVFrame.html" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom-width:1px;border-bottom-style:dotted;border-bottom-color:rgb(51,51,51);">AVFrame</a>：用于保存数据帧的数据结构，这里的两个帧分别是保存颜色转换前后的两帧图像</span></p> </li> 
     <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:18px;"><a href="http://ffmpeg.org/doxygen/trunk/structAVPacket.html" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom-width:1px;border-bottom-style:dotted;border-bottom-color:rgb(51,51,51);">AVPacket</a>：解析文件时会将音/视频帧读入到packet中</span></p> </li> 
    </ul>
    <p>&nbsp;</p> 
    <p>&nbsp;</p> 
    <p><span style="line-height:1.8;font-family:'楷体';font-size:18px;">一 本播放器原理:</span></p> 
    <ul class="list-paddingleft-2">
     <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:18px;">通过<code>ffmpeg</code>对视频进行解码,解码出每一帧图片,然后根据一定时间播放每一帧图</span></p> </li>
    </ul>
    <p><span style="line-height:1.8;font-family:'楷体';font-size:18px;">二 如何集成 ffmpeg</span></p> 
    <ul class="list-paddingleft-2">
     <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:18px;">下载脚本&nbsp;<a href="https://github.com/kewlbear/FFmpeg-iOS-build-script.git" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom-width:1px;border-bottom-style:dotted;border-bottom-color:rgb(51,51,51);">ffmpeg脚本</a></span></p> </li> 
     <li style="list-style:disc;"><span style="line-height:1.8;font-family:'楷体';font-size:18px;">根据上面链接的 README 进行编译</span></li> 
    </ul>
    <p><span style="line-height:1.8;font-family:'楷体';font-size:18px;">大致步骤：</span></p> 
    <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">1. 下载脚本：<a href="https://github.com/kewlbear/FFmpeg-iOS-build-script" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom-width:1px;border-bottom-style:dotted;border-bottom-color:rgb(51,51,51);">https://github.com/kewlbear/FFmpeg-iOS-build-script</a></span></p> 
    <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">2. 解压，找到文件 build-ffmpeg.sh</span></p> 
    <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">3. 进入终端，执行服本文件：./build-ffmpeg.sh, 由于本人没有事先安装Yasm，执行脚本文件会出错，提示Homebrew not found，Trying 头install.....如图：</span></p> 
    <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;"><img src="https://images2015.cnblogs.com/blog/791499/201607/791499-20160711160235451-453915829.png" alt="" style="border:0px;">&nbsp;<img src="https://images2015.cnblogs.com/blog/791499/201607/791499-20160711160404592-655374680.png" alt="" style="border:0px;"></span></p> 
    <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">根据提示,按下enter键进行安装并编译静态库FFmpeg，如下图：</span></p> 
    <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;"><img src="https://images2015.cnblogs.com/blog/791499/201607/791499-20160711161456795-1552858404.png" alt="" style="border:0px;">&nbsp;<img src="https://images2015.cnblogs.com/blog/791499/201607/791499-20160711161543420-1608033397.png" alt="" style="border:0px;"></span></p> 
    <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;"><img src="https://images2015.cnblogs.com/blog/791499/201607/791499-20160711161551529-2125748819.png" alt="" style="border:0px;"></span></p> 
    <p>&nbsp;</p> 
    <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">这是编译后的静态库，截图如下：</span></p> 
    <p><img src="https://images2015.cnblogs.com/blog/791499/201607/791499-20160711162310998-941764484.png" alt="" style="border:0px;"></p> 
    <ul class="list-paddingleft-2">
     <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:18px;">集成到项目,新建工程,将编译好的静态库以及头文件导入工程(demo)</span></p> </li>
    </ul>
    <p><img src="https://images2015.cnblogs.com/blog/791499/201607/791499-20160707182426905-1434712610.png" alt="" style="border:0px;"></p> 
    <ul class="list-paddingleft-2">
     <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:18px;">导入依赖库</span></p> </li>
    </ul>
    <p><img src="https://images2015.cnblogs.com/blog/791499/201607/791499-20160707182026108-1545606509.png" alt="" style="border:0px;"></p> 
    <ul class="list-paddingleft-2">
     <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:18px;">设置头文件路径,路径一定要对,不然胡找不到头文件</span></p> </li>
    </ul>
    <p><img src="https://images2015.cnblogs.com/blog/791499/201607/791499-20160707182108046-1645192806.png" alt="" style="border:0px;"></p> 
    <p>&nbsp;</p> 
    <p><span style="line-height:1.8;font-family:'楷体';font-size:16px;">我设置路径如下图：</span></p> 
    <p><img src="https://images2015.cnblogs.com/blog/791499/201607/791499-20160711170150623-67882242.png" alt="" style="border:0px;"></p> 
    <ul class="list-paddingleft-2">
     <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:18px;">先 command + B 编译一下,确保能编译成功</span></p> </li>
    </ul>
    <h4 style="color:rgb(0,0,0);"><span style="line-height:1.8;font-family:'楷体';font-size:18px;">三 开始编写代码</span></h4> 
    <ul class="list-paddingleft-2">
     <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:18px;">新建一个OC文件</span></p> </li>
    </ul>
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span>
<span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">  SJMoiveObject.h
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">  SJLiveVideo
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span>
<span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">  Created by king on 16/6/16.
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">  Copyright © 2016年 king. All rights reserved.
</span><span style="line-height:1.8;color:rgb(0,128,0);">//
</span> 
<span style="line-height:1.8;color:rgb(0,0,255);">#import</span> <span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">Common.h</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>
<span style="line-height:1.8;color:rgb(0,0,255);">#import</span> &lt;UIKit/UIKit.h&gt;
<span style="line-height:1.8;color:rgb(0,0,255);">#import</span> <span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">NSString+Extions.h</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">
#include </span>&lt;libavcodec/avcodec.h&gt;<span style="line-height:1.8;">
#include </span>&lt;libavformat/avformat.h&gt;<span style="line-height:1.8;">
#include </span>&lt;libswscale<span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">swscale.h&gt;</span>
 
<span style="line-height:1.8;color:rgb(0,0,255);">@interface</span><span style="line-height:1.8;"> SJMoiveObject : NSObject
 
</span><span style="line-height:1.8;color:rgb(0,128,0);">/*</span><span style="line-height:1.8;color:rgb(0,128,0);"> 解码后的UIImage </span><span style="line-height:1.8;color:rgb(0,128,0);">*/</span><span style="line-height:1.8;">
@property (nonatomic, strong, </span><span style="line-height:1.8;color:rgb(0,0,255);">readonly</span>) UIImage *<span style="line-height:1.8;">currentImage;
 
</span><span style="line-height:1.8;color:rgb(0,128,0);">/*</span><span style="line-height:1.8;color:rgb(0,128,0);"> 视频的frame高度 </span><span style="line-height:1.8;color:rgb(0,128,0);">*/</span><span style="line-height:1.8;">
@property (nonatomic, assign, </span><span style="line-height:1.8;color:rgb(0,0,255);">readonly</span>) <span style="line-height:1.8;color:rgb(0,0,255);">int</span><span style="line-height:1.8;"> sourceWidth, sourceHeight;
 
</span><span style="line-height:1.8;color:rgb(0,128,0);">/*</span><span style="line-height:1.8;color:rgb(0,128,0);"> 输出图像大小。默认设置为源大小。 </span><span style="line-height:1.8;color:rgb(0,128,0);">*/</span><span style="line-height:1.8;">
@property (nonatomic,assign) </span><span style="line-height:1.8;color:rgb(0,0,255);">int</span><span style="line-height:1.8;"> outputWidth, outputHeight;
 
</span><span style="line-height:1.8;color:rgb(0,128,0);">/*</span><span style="line-height:1.8;color:rgb(0,128,0);"> 视频的长度，秒为单位 </span><span style="line-height:1.8;color:rgb(0,128,0);">*/</span><span style="line-height:1.8;">
@property (nonatomic, assign, </span><span style="line-height:1.8;color:rgb(0,0,255);">readonly</span>) <span style="line-height:1.8;color:rgb(0,0,255);">double</span><span style="line-height:1.8;"> duration;
 
</span><span style="line-height:1.8;color:rgb(0,128,0);">/*</span><span style="line-height:1.8;color:rgb(0,128,0);"> 视频的当前秒数 </span><span style="line-height:1.8;color:rgb(0,128,0);">*/</span><span style="line-height:1.8;">
@property (nonatomic, assign, </span><span style="line-height:1.8;color:rgb(0,0,255);">readonly</span>) <span style="line-height:1.8;color:rgb(0,0,255);">double</span><span style="line-height:1.8;"> currentTime;
 
</span><span style="line-height:1.8;color:rgb(0,128,0);">/*</span><span style="line-height:1.8;color:rgb(0,128,0);"> 视频的帧率 </span><span style="line-height:1.8;color:rgb(0,128,0);">*/</span><span style="line-height:1.8;">
@property (nonatomic, assign, </span><span style="line-height:1.8;color:rgb(0,0,255);">readonly</span>) <span style="line-height:1.8;color:rgb(0,0,255);">double</span><span style="line-height:1.8;"> fps;
 
</span><span style="line-height:1.8;color:rgb(0,128,0);">/*</span><span style="line-height:1.8;color:rgb(0,128,0);"> 视频路径。 </span><span style="line-height:1.8;color:rgb(0,128,0);">*/</span>
- (instancetype)initWithVideo:(NSString *<span style="line-height:1.8;">)moviePath;
</span><span style="line-height:1.8;color:rgb(0,128,0);">/*</span><span style="line-height:1.8;color:rgb(0,128,0);"> 切换资源 </span><span style="line-height:1.8;color:rgb(0,128,0);">*/</span>
- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span>)replaceTheResources:(NSString *<span style="line-height:1.8;">)moviePath;
</span><span style="line-height:1.8;color:rgb(0,128,0);">/*</span><span style="line-height:1.8;color:rgb(0,128,0);"> 重拨 </span><span style="line-height:1.8;color:rgb(0,128,0);">*/</span>
- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">)redialPaly;
</span><span style="line-height:1.8;color:rgb(0,128,0);">/*</span><span style="line-height:1.8;color:rgb(0,128,0);"> 从视频流中读取下一帧。返回假，如果没有帧读取（视频）。 </span><span style="line-height:1.8;color:rgb(0,128,0);">*/</span>
-<span style="line-height:1.8;"> (BOOL)stepFrame;
 
</span><span style="line-height:1.8;color:rgb(0,128,0);">/*</span><span style="line-height:1.8;color:rgb(0,128,0);"> 寻求最近的关键帧在指定的时间 </span><span style="line-height:1.8;color:rgb(0,128,0);">*/</span>
- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span>)seekTime:(<span style="line-height:1.8;color:rgb(0,0,255);">double</span><span style="line-height:1.8;">)seconds;
 
</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span><span style="line-height:1.8;">

开始实现API
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span>
<span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">  SJMoiveObject.m
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">  SJLiveVideo
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span>
<span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">  Created by king on 16/6/16.
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">  Copyright © 2016年 king. All rights reserved.
</span><span style="line-height:1.8;color:rgb(0,128,0);">//
</span> 
<span style="line-height:1.8;color:rgb(0,0,255);">#import</span> <span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">SJMoiveObject.h</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>
 
<span style="line-height:1.8;color:rgb(0,0,255);">@interface</span><span style="line-height:1.8;"> SJMoiveObject ()
@property (nonatomic, copy) NSString </span>*<span style="line-height:1.8;">cruutenPath;
</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span>
 
<span style="line-height:1.8;color:rgb(0,0,255);">@implementation</span><span style="line-height:1.8;"> SJMoiveObject
{
    AVFormatContext     </span>*<span style="line-height:1.8;">SJFormatCtx;
    AVCodecContext      </span>*<span style="line-height:1.8;">SJCodecCtx;
    AVFrame             </span>*<span style="line-height:1.8;">SJFrame;
    AVStream            </span>*<span style="line-height:1.8;">stream;
    AVPacket            packet;
    AVPicture           picture;
    </span><span style="line-height:1.8;color:rgb(0,0,255);">int</span><span style="line-height:1.8;">                 videoStream;
    </span><span style="line-height:1.8;color:rgb(0,0,255);">double</span><span style="line-height:1.8;">              fps;
    BOOL                isReleaseResources;
}
 
</span><span style="line-height:1.8;color:rgb(0,0,255);">#pragma</span> mark ------------------------------------
<span style="line-height:1.8;color:rgb(0,0,255);">#pragma</span> mark  初始化
- (instancetype)initWithVideo:(NSString *<span style="line-height:1.8;">)moviePath {
     
    </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (!(self=[super init])) <span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> nil;
    </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span><span style="line-height:1.8;"> ([self initializeResources:[moviePath UTF8String]]) {
        self.cruutenPath </span>=<span style="line-height:1.8;"> [moviePath copy];
        </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> self;
    } </span><span style="line-height:1.8;color:rgb(0,0,255);">else</span><span style="line-height:1.8;"> {
        </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> nil;
    }
}
</span>- (BOOL)initializeResources:(<span style="line-height:1.8;color:rgb(0,0,255);">const</span> <span style="line-height:1.8;color:rgb(0,0,255);">char</span> *<span style="line-height:1.8;">)filePath {
     
    isReleaseResources </span>=<span style="line-height:1.8;"> NO;
    AVCodec </span>*<span style="line-height:1.8;">pCodec;
    </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 注册所有解码器</span>
<span style="line-height:1.8;">    avcodec_register_all();
    av_register_all();
    avformat_network_init();
    </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 打开视频文件</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">if</span> (avformat_open_input(&amp;SJFormatCtx, filePath, NULL, NULL) != <span style="line-height:1.8;color:rgb(128,0,128);">0</span><span style="line-height:1.8;">) {
        SJLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">打开文件失败</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);
        </span><span style="line-height:1.8;color:rgb(0,0,255);">goto</span><span style="line-height:1.8;"> initError;
    }
    </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 检查数据流</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">if</span> (avformat_find_stream_info(SJFormatCtx, NULL) &lt; <span style="line-height:1.8;color:rgb(128,0,128);">0</span><span style="line-height:1.8;">) {
        SJLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">检查数据流失败</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);
        </span><span style="line-height:1.8;color:rgb(0,0,255);">goto</span><span style="line-height:1.8;"> initError;
    }
    </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 根据数据流,找到第一个视频流</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">if</span> ((videoStream =  av_find_best_stream(SJFormatCtx, AVMEDIA_TYPE_VIDEO, -<span style="line-height:1.8;color:rgb(128,0,128);">1</span>, -<span style="line-height:1.8;color:rgb(128,0,128);">1</span>, &amp;pCodec, <span style="line-height:1.8;color:rgb(128,0,128);">0</span>)) &lt; <span style="line-height:1.8;color:rgb(128,0,128);">0</span><span style="line-height:1.8;">) {
        SJLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">没有找到第一个视频流</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);
        </span><span style="line-height:1.8;color:rgb(0,0,255);">goto</span><span style="line-height:1.8;"> initError;
    }
    </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 获取视频流的编解码上下文的指针</span>
    stream      = SJFormatCtx-&gt;<span style="line-height:1.8;">streams[videoStream];
    SJCodecCtx  </span>= stream-&gt;<span style="line-height:1.8;">codec;
</span><span style="line-height:1.8;color:rgb(0,0,255);">#if</span> DEBUG
    <span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 打印视频流的详细信息</span>
    av_dump_format(SJFormatCtx, videoStream, filePath, <span style="line-height:1.8;color:rgb(128,0,128);">0</span><span style="line-height:1.8;">);
</span><span style="line-height:1.8;color:rgb(0,0,255);">#endif</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">if</span>(stream-&gt;avg_frame_rate.den &amp;&amp; stream-&gt;<span style="line-height:1.8;">avg_frame_rate.num) {
        fps </span>= av_q2d(stream-&gt;<span style="line-height:1.8;">avg_frame_rate);
    } </span><span style="line-height:1.8;color:rgb(0,0,255);">else</span> { fps = <span style="line-height:1.8;color:rgb(128,0,128);">30</span><span style="line-height:1.8;">; }
    </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 查找解码器</span>
    pCodec = avcodec_find_decoder(SJCodecCtx-&gt;<span style="line-height:1.8;">codec_id);
    </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (pCodec ==<span style="line-height:1.8;"> NULL) {
        SJLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">没有找到解码器</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);
        </span><span style="line-height:1.8;color:rgb(0,0,255);">goto</span><span style="line-height:1.8;"> initError;
    }
    </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 打开解码器</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">if</span>(avcodec_open2(SJCodecCtx, pCodec, NULL) &lt; <span style="line-height:1.8;color:rgb(128,0,128);">0</span><span style="line-height:1.8;">) {
        SJLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">打开解码器失败</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);
        </span><span style="line-height:1.8;color:rgb(0,0,255);">goto</span><span style="line-height:1.8;"> initError;
    }
    </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 分配视频帧</span>
    SJFrame =<span style="line-height:1.8;"> av_frame_alloc();
    _outputWidth </span>= SJCodecCtx-&gt;<span style="line-height:1.8;">width;
    _outputHeight </span>= SJCodecCtx-&gt;<span style="line-height:1.8;">height;
    </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> YES;
initError:
    </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> NO;
}
</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span>)seekTime:(<span style="line-height:1.8;color:rgb(0,0,255);">double</span><span style="line-height:1.8;">)seconds {
    AVRational timeBase </span>= SJFormatCtx-&gt;streams[videoStream]-&gt;<span style="line-height:1.8;">time_base;
    int64_t targetFrame </span>= (int64_t)((<span style="line-height:1.8;color:rgb(0,0,255);">double</span>)timeBase.den / timeBase.num *<span style="line-height:1.8;"> seconds);
    avformat_seek_file(SJFormatCtx,
                       videoStream,
                       </span><span style="line-height:1.8;color:rgb(128,0,128);">0</span><span style="line-height:1.8;">,
                       targetFrame,
                       targetFrame,
                       AVSEEK_FLAG_FRAME);
    avcodec_flush_buffers(SJCodecCtx);
}
</span>-<span style="line-height:1.8;"> (BOOL)stepFrame {
    </span><span style="line-height:1.8;color:rgb(0,0,255);">int</span> frameFinished = <span style="line-height:1.8;color:rgb(128,0,128);">0</span><span style="line-height:1.8;">;
    </span><span style="line-height:1.8;color:rgb(0,0,255);">while</span> (!frameFinished &amp;&amp; av_read_frame(SJFormatCtx, &amp;packet) &gt;= <span style="line-height:1.8;color:rgb(128,0,128);">0</span><span style="line-height:1.8;">) {
        </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (packet.stream_index ==<span style="line-height:1.8;"> videoStream) {
            avcodec_decode_video2(SJCodecCtx,
                                  SJFrame,
                                  </span>&amp;<span style="line-height:1.8;">frameFinished,
                                  </span>&amp;<span style="line-height:1.8;">packet);
        }
    }
    </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (frameFinished == <span style="line-height:1.8;color:rgb(128,0,128);">0</span> &amp;&amp; isReleaseResources ==<span style="line-height:1.8;"> NO) {
        [self releaseResources];
    }
    </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span> frameFinished != <span style="line-height:1.8;color:rgb(128,0,128);">0</span><span style="line-height:1.8;">;
}
 
</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span>)replaceTheResources:(NSString *<span style="line-height:1.8;">)moviePath {
    </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (!<span style="line-height:1.8;">isReleaseResources) {
        [self releaseResources];
    }
    self.cruutenPath </span>=<span style="line-height:1.8;"> [moviePath copy];
    [self initializeResources:[moviePath UTF8String]];
}
</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">)redialPaly {
    [self initializeResources:[self.cruutenPath UTF8String]];
}
</span><span style="line-height:1.8;color:rgb(0,0,255);">#pragma</span> mark ------------------------------------
<span style="line-height:1.8;color:rgb(0,0,255);">#pragma</span> mark  重写属性访问方法
-(<span style="line-height:1.8;color:rgb(0,0,255);">void</span>)setOutputWidth:(<span style="line-height:1.8;color:rgb(0,0,255);">int</span><span style="line-height:1.8;">)newValue {
    </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (_outputWidth == newValue) <span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;">;
    _outputWidth </span>=<span style="line-height:1.8;"> newValue;
}
</span>-(<span style="line-height:1.8;color:rgb(0,0,255);">void</span>)setOutputHeight:(<span style="line-height:1.8;color:rgb(0,0,255);">int</span><span style="line-height:1.8;">)newValue {
    </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (_outputHeight == newValue) <span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;">;
    _outputHeight </span>=<span style="line-height:1.8;"> newValue;
}
</span>-(UIImage *<span style="line-height:1.8;">)currentImage {
    </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (!SJFrame-&gt;data[<span style="line-height:1.8;color:rgb(128,0,128);">0</span>]) <span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> nil;
    </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> [self imageFromAVPicture];
}
</span>-(<span style="line-height:1.8;color:rgb(0,0,255);">double</span><span style="line-height:1.8;">)duration {
    </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span> (<span style="line-height:1.8;color:rgb(0,0,255);">double</span>)SJFormatCtx-&gt;duration /<span style="line-height:1.8;"> AV_TIME_BASE;
}
</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">double</span><span style="line-height:1.8;">)currentTime {
    AVRational timeBase </span>= SJFormatCtx-&gt;streams[videoStream]-&gt;<span style="line-height:1.8;">time_base;
    </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span> packet.pts * (<span style="line-height:1.8;color:rgb(0,0,255);">double</span>)timeBase.num /<span style="line-height:1.8;"> timeBase.den;
}
</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">int</span><span style="line-height:1.8;">)sourceWidth {
    </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span> SJCodecCtx-&gt;<span style="line-height:1.8;">width;
}
</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">int</span><span style="line-height:1.8;">)sourceHeight {
    </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span> SJCodecCtx-&gt;<span style="line-height:1.8;">height;
}
</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">double</span><span style="line-height:1.8;">)fps {
    </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> fps;
}
</span><span style="line-height:1.8;color:rgb(0,0,255);">#pragma</span> mark --------------------------
<span style="line-height:1.8;color:rgb(0,0,255);">#pragma</span> mark - 内部方法
- (UIImage *<span style="line-height:1.8;">)imageFromAVPicture
{
    avpicture_free(</span>&amp;<span style="line-height:1.8;">picture);
    avpicture_alloc(</span>&amp;<span style="line-height:1.8;">picture, AV_PIX_FMT_RGB24, _outputWidth, _outputHeight);
    </span><span style="line-height:1.8;color:rgb(0,0,255);">struct</span> SwsContext * imgConvertCtx = sws_getContext(SJFrame-&gt;<span style="line-height:1.8;">width,
                                                       SJFrame</span>-&gt;<span style="line-height:1.8;">height,
                                                       AV_PIX_FMT_YUV420P,
                                                       _outputWidth,
                                                       _outputHeight,
                                                       AV_PIX_FMT_RGB24,
                                                       SWS_FAST_BILINEAR,
                                                       NULL,
                                                       NULL,
                                                       NULL);
    </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span>(imgConvertCtx == nil) <span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> nil;
    sws_scale(imgConvertCtx,
              SJFrame</span>-&gt;<span style="line-height:1.8;">data,
              SJFrame</span>-&gt;<span style="line-height:1.8;">linesize,
              </span><span style="line-height:1.8;color:rgb(128,0,128);">0</span><span style="line-height:1.8;">,
              SJFrame</span>-&gt;<span style="line-height:1.8;">height,
              picture.data,
              picture.linesize);
    sws_freeContext(imgConvertCtx);
     
    CGBitmapInfo bitmapInfo </span>=<span style="line-height:1.8;"> kCGBitmapByteOrderDefault;
    CFDataRef data </span>=<span style="line-height:1.8;"> CFDataCreate(kCFAllocatorDefault,
                                  picture.data[</span><span style="line-height:1.8;color:rgb(128,0,128);">0</span><span style="line-height:1.8;">],
                                  picture.linesize[</span><span style="line-height:1.8;color:rgb(128,0,128);">0</span>] *<span style="line-height:1.8;"> _outputHeight);
     
    CGDataProviderRef provider </span>=<span style="line-height:1.8;"> CGDataProviderCreateWithCFData(data);
    CGColorSpaceRef colorSpace </span>=<span style="line-height:1.8;"> CGColorSpaceCreateDeviceRGB();
    CGImageRef cgImage </span>=<span style="line-height:1.8;"> CGImageCreate(_outputWidth,
                                       _outputHeight,
                                       </span><span style="line-height:1.8;color:rgb(128,0,128);">8</span><span style="line-height:1.8;">,
                                       </span><span style="line-height:1.8;color:rgb(128,0,128);">24</span><span style="line-height:1.8;">,
                                       picture.linesize[</span><span style="line-height:1.8;color:rgb(128,0,128);">0</span><span style="line-height:1.8;">],
                                       colorSpace,
                                       bitmapInfo,
                                       provider,
                                       NULL,
                                       NO,
                                       kCGRenderingIntentDefault);
    UIImage </span>*image =<span style="line-height:1.8;"> [UIImage imageWithCGImage:cgImage];
    CGImageRelease(cgImage);
    CGColorSpaceRelease(colorSpace);
    CGDataProviderRelease(provider);
    CFRelease(data);
     
    </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;"> image;
}
 
</span><span style="line-height:1.8;color:rgb(0,0,255);">#pragma</span> mark --------------------------
<span style="line-height:1.8;color:rgb(0,0,255);">#pragma</span> mark - 释放资源
- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">)releaseResources {
    SJLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">释放资源</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">);
    SJLogFunc
    isReleaseResources </span>=<span style="line-height:1.8;"> YES;
    </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 释放RGB</span>
    avpicture_free(&amp;<span style="line-height:1.8;">picture);
    </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 释放frame</span>
    av_packet_unref(&amp;<span style="line-height:1.8;">packet);
    </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 释放YUV frame</span>
<span style="line-height:1.8;">    av_free(SJFrame);
    </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 关闭解码器</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">if</span><span style="line-height:1.8;"> (SJCodecCtx) avcodec_close(SJCodecCtx);
    </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> 关闭文件</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">if</span> (SJFormatCtx) avformat_close_input(&amp;<span style="line-height:1.8;">SJFormatCtx);
    avformat_network_deinit();
}
</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span></pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <ul class="list-paddingleft-2">
     <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:18px;">为了方便,在SB 拖一个 UIImageView 控件 和按钮 &nbsp;并连好线</span></p> </li>
    </ul>
    <div class="cnblogs_code" style="border:1px solid rgb(204,204,204);color:rgb(0,0,0);font-family:'Courier New';font-size:12px;"> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
     <pre><span style="line-height:1.8;color:rgb(0,128,0);">//</span>
<span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">  ViewController.m
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">  SJLiveVideo
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span>
<span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">  Created by king on 16/6/14.
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">  Copyright © 2016年 king. All rights reserved.
</span><span style="line-height:1.8;color:rgb(0,128,0);">//
</span> 
<span style="line-height:1.8;color:rgb(0,0,255);">#import</span> <span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">ViewController.h</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>
<span style="line-height:1.8;color:rgb(0,0,255);">#import</span> <span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">SJMoiveObject.h</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>
<span style="line-height:1.8;color:rgb(0,0,255);">#import</span> &lt;AVFoundation/AVFoundation.h&gt;
<span style="line-height:1.8;color:rgb(0,0,255);">#import</span> <span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">SJAudioObject.h</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>
<span style="line-height:1.8;color:rgb(0,0,255);">#import</span> <span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;color:rgb(128,0,0);">SJAudioQueuPlay.h</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span>
<span style="line-height:1.8;color:rgb(0,0,255);">#define</span> LERP(A,B,C) ((A)*(1.0-C)+(B)*C)
 
<span style="line-height:1.8;color:rgb(0,0,255);">@interface</span><span style="line-height:1.8;"> ViewController ()
@property (weak, nonatomic) IBOutlet UIImageView </span>*<span style="line-height:1.8;">ImageView;
@property (weak, nonatomic) IBOutlet UILabel </span>*<span style="line-height:1.8;">fps;
@property (weak, nonatomic) IBOutlet UIButton </span>*<span style="line-height:1.8;">playBtn;
@property (weak, nonatomic) IBOutlet UIButton </span>*<span style="line-height:1.8;">TimerBtn;
@property (weak, nonatomic) IBOutlet UILabel </span>*<span style="line-height:1.8;">TimerLabel;
@property (nonatomic, strong) SJMoiveObject </span>*<span style="line-height:1.8;">video;
@property (nonatomic, strong) SJAudioObject </span>*<span style="line-height:1.8;">audio;
@property (nonatomic, strong) SJAudioQueuPlay </span>*<span style="line-height:1.8;">audioPlay;
@property (nonatomic, assign) </span><span style="line-height:1.8;color:rgb(0,0,255);">float</span><span style="line-height:1.8;"> lastFrameTime;
</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span>
 
<span style="line-height:1.8;color:rgb(0,0,255);">@implementation</span><span style="line-height:1.8;"> ViewController
 
</span><span style="line-height:1.8;color:rgb(0,0,255);">@synthesize</span><span style="line-height:1.8;"> ImageView, fps, playBtn, video;
 
</span>- (<span style="line-height:1.8;color:rgb(0,0,255);">void</span><span style="line-height:1.8;">)viewDidLoad {
    [super viewDidLoad];
     
    self.video </span>= [[SJMoiveObject alloc] initWithVideo:[NSString bundlePath:<span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">Dalshabet.mp4</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">]];
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">    self.video = [[SJMoiveObject alloc] initWithVideo:@"/Users/king/Desktop/Stellar.mp4"];
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">    self.video = [[SJMoiveObject alloc] initWithVideo:@"/Users/king/Downloads/Worth it - Fifth Harmony ft.Kid Ink - May J Lee Choreography.mp4"];
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">    self.video = [[SJMoiveObject alloc] initWithVideo:@"/Users/king/Downloads/4K.mp4"];
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">    self.video = [[SJMoiveObject alloc] initWithVideo:@"</span><span style="line-height:1.8;color:rgb(0,128,0);text-decoration:underline;">http://wvideo.spriteapp.cn/video/2016/0328/56f8ec01d9bfe_wpd.mp4</span><span style="line-height:1.8;color:rgb(0,128,0);">"];
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">    video.outputWidth = 800;
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">    video.outputHeight = 600;</span>
   self.audio = [[SJAudioObject alloc] initWithVideo:<span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">/Users/king/Desktop/Stellar.mp4</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">];
    NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">视频总时长&gt;&gt;&gt;video duration: %f</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">,video.duration);
    NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">源尺寸&gt;&gt;&gt;video size: %d x %d</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, video.sourceWidth, video.sourceHeight);
    NSLog(</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">输出尺寸&gt;&gt;&gt;video size: %d x %d</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">, video.outputWidth, video.outputHeight);
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span>
<span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">    [self.audio seekTime:0.0];
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">    SJLog(@"%f", [self.audio duration])
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">    AVPacket *packet = [self.audio readPacket];
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">    SJLog(@"%ld", [self.audio decode])</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">int</span><span style="line-height:1.8;"> tns, thh, tmm, tss;
    tns </span>=<span style="line-height:1.8;"> video.duration;
    thh </span>= tns / <span style="line-height:1.8;color:rgb(128,0,128);">3600</span><span style="line-height:1.8;">;
    tmm </span>= (tns % <span style="line-height:1.8;color:rgb(128,0,128);">3600</span>) / <span style="line-height:1.8;color:rgb(128,0,128);">60</span><span style="line-height:1.8;">;
    tss </span>= tns % <span style="line-height:1.8;color:rgb(128,0,128);">60</span><span style="line-height:1.8;">;
     
     
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">    NSLog(@"fps --&gt; %.2f", video.fps);</span>
<span style="line-height:1.8;color:rgb(128,128,128);">///</span><span style="line-height:1.8;color:rgb(0,128,0);">/        [ImageView setTransform:CGAffineTransformMakeRotation(M_PI)];</span>
<span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">    NSLog(@"%02d:%02d:%02d",thh,tmm,tss);</span>
<span style="line-height:1.8;">}
 
</span>- (IBAction)PlayClick:(UIButton *<span style="line-height:1.8;">)sender {
     
    [playBtn setEnabled:NO];
    _lastFrameTime </span>= -<span style="line-height:1.8;color:rgb(128,0,128);">1</span><span style="line-height:1.8;">;
     
    </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> seek to 0.0 seconds</span>
    [video seekTime:<span style="line-height:1.8;color:rgb(128,0,128);">0.0</span><span style="line-height:1.8;">];
     
     
    [NSTimer scheduledTimerWithTimeInterval: </span><span style="line-height:1.8;color:rgb(128,0,128);">1</span> /<span style="line-height:1.8;"> video.fps
                                     target:self
                                   selector:@selector(displayNextFrame:)
                                   userInfo:nil
                                    repeats:YES];
}
 
</span>- (IBAction)TimerCilick:(<span style="line-height:1.8;color:rgb(0,0,255);">id</span><span style="line-height:1.8;">)sender {
     
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">    NSLog(@"current time: %f s",video.currentTime);
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">    [video seekTime:150.0];
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">    [video replaceTheResources:@"/Users/king/Desktop/Stellar.mp4"];</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">if</span><span style="line-height:1.8;"> (playBtn.enabled) {
        [video redialPaly];
        [self PlayClick:playBtn];
    }
     
}
 
</span>-(<span style="line-height:1.8;color:rgb(0,0,255);">void</span>)displayNextFrame:(NSTimer *<span style="line-height:1.8;">)timer {
    NSTimeInterval startTime </span>=<span style="line-height:1.8;"> [NSDate timeIntervalSinceReferenceDate];
</span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);">    self.TimerLabel.text = [NSString stringWithFormat:@"%f s",video.currentTime];</span>
    self.TimerLabel.text  =<span style="line-height:1.8;"> [self dealTime:video.currentTime];
    </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (!<span style="line-height:1.8;">[video stepFrame]) {
        [timer invalidate];
        [playBtn setEnabled:YES];
        </span><span style="line-height:1.8;color:rgb(0,0,255);">return</span><span style="line-height:1.8;">;
    }
    ImageView.image </span>=<span style="line-height:1.8;"> video.currentImage;
    </span><span style="line-height:1.8;color:rgb(0,0,255);">float</span> frameTime = <span style="line-height:1.8;color:rgb(128,0,128);">1.0</span> / ([NSDate timeIntervalSinceReferenceDate] -<span style="line-height:1.8;"> startTime);
    </span><span style="line-height:1.8;color:rgb(0,0,255);">if</span> (_lastFrameTime &lt; <span style="line-height:1.8;color:rgb(128,0,128);">0</span><span style="line-height:1.8;">) {
        _lastFrameTime </span>=<span style="line-height:1.8;"> frameTime;
    } </span><span style="line-height:1.8;color:rgb(0,0,255);">else</span><span style="line-height:1.8;"> {
        _lastFrameTime </span>= LERP(frameTime, _lastFrameTime, <span style="line-height:1.8;color:rgb(128,0,128);">0.8</span><span style="line-height:1.8;">);
    }
    [fps setText:[NSString stringWithFormat:</span><span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">fps %.0f</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">,_lastFrameTime]];
}
 
</span>- (NSString *)dealTime:(<span style="line-height:1.8;color:rgb(0,0,255);">double</span><span style="line-height:1.8;">)time {
     
    </span><span style="line-height:1.8;color:rgb(0,0,255);">int</span><span style="line-height:1.8;"> tns, thh, tmm, tss;
    tns </span>=<span style="line-height:1.8;"> time;
    thh </span>= tns / <span style="line-height:1.8;color:rgb(128,0,128);">3600</span><span style="line-height:1.8;">;
    tmm </span>= (tns % <span style="line-height:1.8;color:rgb(128,0,128);">3600</span>) / <span style="line-height:1.8;color:rgb(128,0,128);">60</span><span style="line-height:1.8;">;
    tss </span>= tns % <span style="line-height:1.8;color:rgb(128,0,128);">60</span><span style="line-height:1.8;">;
     
     
    </span><span style="line-height:1.8;color:rgb(0,128,0);">//</span><span style="line-height:1.8;color:rgb(0,128,0);"> [ImageView setTransform:CGAffineTransformMakeRotation(M_PI)];</span>
    <span style="line-height:1.8;color:rgb(0,0,255);">return</span> [NSString stringWithFormat:<span style="line-height:1.8;color:rgb(128,0,0);">@"</span><span style="line-height:1.8;color:rgb(128,0,0);">%02d:%02d:%02d</span><span style="line-height:1.8;color:rgb(128,0,0);">"</span><span style="line-height:1.8;">,thh,tmm,tss];
}
</span><span style="line-height:1.8;color:rgb(0,0,255);">@end</span></pre> 
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy" style="line-height:1.8;"><a title="复制代码" style="border:none;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="border:none;"></a></span>
     </div> 
    </div> 
    <ul class="list-paddingleft-2">
     <li style="list-style:disc;"> <p><span style="line-height:1.8;font-family:'楷体';font-size:18px;">运程序 ,点击播放</span></p> </li>
    </ul>
    <p><img src="https://images2015.cnblogs.com/blog/791499/201607/791499-20160707182315655-1383040125.png" alt="" style="border:0px;"></p> 
    <p>&nbsp;</p> 
    <p><span style="line-height:1.8;font-family:'楷体';font-size:18px;">我的测试结果如下：</span></p> 
    <p><span style="line-height:1.8;font-family:'楷体';font-size:18px;"><img src="https://images2015.cnblogs.com/blog/791499/201607/791499-20160711173506076-1786879102.png" alt="" style="border:0px;"></span></p> 
    <p><strong><span style="line-height:1.8;font-family:'楷体';font-size:18px;"><strong>原文地址：</strong><a href="http://bbs.520it.com/forum.php?mod=viewthread&amp;tid=707&amp;page=1&amp;extra=#pid3821" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom-width:1px;border-bottom-style:dotted;border-bottom-color:rgb(51,51,51);">http://bbs.520it.com/forum.php?mod=viewthread&amp;tid=707&amp;page=1&amp;extra=#pid3821</a></span></strong></p> 
    <p><strong><span style="line-height:1.8;font-family:'楷体';font-size:18px;">我集成后的demo：github源码下载：<a href="https://github.com/xiayuanquan/FFmpegDemo" rel="nofollow" style="text-decoration:none;color:rgb(0,0,0);border-bottom-width:1px;border-bottom-style:dotted;border-bottom-color:rgb(51,51,51);">https://github.com/xiayuanquan/FFmpegDemo</a></span></strong></p> 
   </div> 
   <div style="color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:25.2px;">
    程序猿神奇的手，每时每刻，这双手都在改变着世界的交互方式！
   </div> 
   <div class="clear" style="clear:both;color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;font-size:14px;line-height:25.2px;"></div> 
   <div> 
    <div> 
     <font color="#333333"><span style="font-size:14px;line-height:25.2px;">本文转自当天真遇到现实博客园博客，原文链接：http://www.cnblogs.com/XYQ-208910/p/5651166.html</span></font>
     <span style="font-size:14px;line-height:25.2px;color:rgb(51,51,51);font-family:verdana, Arial, Helvetica, sans-serif;">，如需转载请自行联系原作者</span> 
    </div> 
   </div> 
  </div> 
 </div> 
</div>
  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://uzstatic-360cdn.belost.xyz/theme/default/images/logo.png" alt="柚子社区">
  <div class="col-box-title name">NotBeCN</div>
  <!-- <p>最新资讯</p> -->
  <p class="contact">
    
    <a href="mailto:fandyvon@163.com" target="_blank">邮箱</a>
    
    <a href="https://uzshare.com" target="_blank">柚子社区</a>
    
    <a href="https://uzzz.org" target="_blank">找组织</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">最新</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/2019/05/14/zxh1220_90138586.html">[原创软件] [软件发布] 定时备份文件发送邮箱，不再怕数据丢失了</a></li>
    
      <li><a class="post-link" href="/2019/05/14/weixin_45037290_90140056.html">Get智能写作满月记 ——产品篇</a></li>
    
      <li><a class="post-link" href="/2019/05/14/nulio__90138386.html">《深度探索C++对象模型》..............</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_41248707_90140031.html">mysql 多表联查之连接查询</a></li>
    
      <li><a class="post-link" href="/2019/05/13/qq_21122683_90125902.html">golang基础(二)</a></li>
    
      <li><a class="post-link" href="/2019/05/13/1557726108256.html">今日份的PTA刷题</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90137366.html">Android之折线图</a></li>
    
      <li><a class="post-link" href="/2019/05/12/zzzfffei_90136638.html">Android之实现选中时改变样式</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">目录</div>
</div>

<div class="col-box">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- right_sidebar -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-8889449066804352"
       data-ad-slot="2081363239"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>


        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123344652-5');
</script>


<script data-ad-client="ca-pub-8889449066804352" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.async = true;
  hm.src = "https://hm.baidu.com/hm.js?9b378145d7399199b371d067f4c8be96";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  </body>

</html>
